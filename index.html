<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Agora Vat Pre-Check</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">

<style>
:root{
  --brand:#a7ab01; --ink:#0f1b2d; --muted:#6b7790; --bg:#f6f8fb;
  --card:#fff; --navy:#002b5c; --accent:#ff851b; --radius:14px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.wrap{max-width:1100px;margin:22px auto;padding:0 14px}
.brand{display:flex;gap:16px;align-items:center}
.brand img{height:56px;width:auto}
h1.title{font-weight:800;font-size:36px;line-height:1.05;margin:0}
.sub{color:var(--muted)}
.navpill .btn{border-radius:12px;padding:10px 18px;font-weight:600}
.navpill .btn.active{background:var(--brand);border-color:var(--brand);color:#fff}
.panel{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 24px rgba(15,27,45,.06);padding:18px}
.kv{display:grid;grid-template-columns:160px 1fr;gap:6px 10px}
.badge-soft{background:#eef2f6;color:#3b4a66;border-radius:10px;padding:2px 8px;font-weight:600}
.summary-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px}
.sumcard{background:#fff;border:1px solid #e8edf5;border-radius:14px;padding:16px;cursor:pointer;transition:box-shadow .15s}
.sumcard:hover{box-shadow:0 8px 18px rgba(16,28,45,.08)}
.sumcard .n{font-size:32px;font-weight:800}
.sumcard .t{color:var(--muted);font-weight:600}
.farm-card{border:1px solid #e8edf5;background:#fff;border-radius:14px;padding:16px;margin-bottom:12px}
.farm-card h5{font-weight:800;margin:0}
.farm-meta{color:#203046}
.muted{color:var(--muted)}
.grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
.photo img{width:100%;border-radius:8px;border:1px solid #e8edf5}
.photo small{display:block;margin-top:4px;color:#334}
.btn-brand{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-navy{background:var(--navy);border-color:var(--navy);color:#fff}
.form-card{background:#fff;border:1px solid #e8edf5;border-radius:12px;padding:14px;margin-bottom:12px}
.preview{display:none;max-width:100%;border-radius:10px;border:1px solid #e8edf5;margin-top:6px}
.sticky-save{position:sticky;bottom:0;padding-top:10px;background:linear-gradient(180deg,rgba(246,248,251,0),var(--bg) 40%)}
.loader{display:inline-block;width:18px;height:18px;border:3px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .9s linear infinite;margin-left:8px}
@keyframes spin{to{transform:rotate(360deg)}}
.print-logo{height:28px}
</style>
</head>
<body>
<div class="wrap">
  <!-- Brand -->
  <div class="brand mb-2">
    <img id="agoraLogo" alt="Agora">
    <div>
      <h1 class="title">Agora Vat<br>Pre-Check</h1>
      <div class="sub">Fast field capture • Smart summary • Customer-ready output</div>
    </div>
  </div>

  <!-- Nav -->
  <div class="navpill mb-3">
    <div class="btn-group">
      <button class="btn btn-outline-secondary active" id="tabForm">Form</button>
      <button class="btn btn-outline-secondary" id="tabSummary">Summary</button>
      <button class="btn btn-outline-secondary" id="tabAdmin">Admin</button>
    </div>
  </div>

  <!-- ============== FORM ================= -->
  <section id="pageForm" class="panel">
    <h5 class="mb-3">Create / Update Pre-Check</h5>

    <div class="form-card">
      <label class="form-label">Dairy Number</label>
      <input class="form-control" id="dairyNumber" placeholder="e.g. 7016">
      <div class="form-text">Leave the field to auto-fill if a record exists (photos included).</div>
    </div>

    <!-- Vat 1 -->
    <div class="form-card">
      <h6 class="fw-bold">Vat 1</h6>
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">Capacity (L)</label>
          <input class="form-control" id="v1_cap" inputmode="numeric">
        </div>
        <div class="col-6">
          <label class="form-label">Serial #</label>
          <input class="form-control" id="v1_sn">
        </div>
        <div class="col-6">
          <label class="form-label">Cap</label>
          <select id="v1_capAvail" class="form-select">
            <option value="available">Available ✓</option>
            <option value="unavailable">Unavailable ✗</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label">Condition</label>
          <select id="v1_cond" class="form-select">
            <option value="ok">OK</option>
            <option value="attention">Attention Required</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Comments</label>
          <input class="form-control" id="v1_notes" placeholder="interior width, notes…">
        </div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col-4">
          <label class="form-label">Agitator location</label>
          <input class="form-control" id="v1_agitLoc" placeholder="e.g. rear left">
          <input type="file" class="form-control mt-2" id="v1_agitPhoto" accept="image/*">
          <img id="v1_agitPrev" class="preview">
        </div>
        <div class="col-4">
          <label class="form-label">Cap photo (if unavailable)</label>
          <input type="file" class="form-control" id="v1_capPhoto" accept="image/*">
          <img id="v1_capPrev" class="preview">
        </div>
        <div class="col-4">
          <label class="form-label">Condition photo</label>
          <input type="file" class="form-control" id="v1_condPhoto" accept="image/*">
          <img id="v1_condPrev" class="preview">
        </div>
      </div>
    </div>

    <!-- Vat 2 -->
    <div class="form-card">
      <h6 class="fw-bold">Vat 2</h6>
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">Capacity (L)</label>
          <input class="form-control" id="v2_cap" inputmode="numeric" placeholder="Enter to reveal all Vat 2 fields">
        </div>
        <div class="col-6">
          <label class="form-label">Serial #</label>
          <input class="form-control" id="v2_sn">
        </div>
        <div class="col-6">
          <label class="form-label">Cap</label>
          <select id="v2_capAvail" class="form-select">
            <option value="na">N/A</option>
            <option value="available">Available ✓</option>
            <option value="unavailable">Unavailable ✗</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label">Condition</label>
          <select id="v2_cond" class="form-select">
            <option value="ok">OK</option>
            <option value="attention">Attention Required</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Comments</label>
          <input class="form-control" id="v2_notes">
        </div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col-4">
          <label class="form-label">Agitator location</label>
          <input class="form-control" id="v2_agitLoc" placeholder="e.g. front centre">
          <input type="file" class="form-control mt-2" id="v2_agitPhoto" accept="image/*">
          <img id="v2_agitPrev" class="preview">
        </div>
        <div class="col-4">
          <label class="form-label">Cap photo (if unavailable)</label>
          <input type="file" class="form-control" id="v2_capPhoto" accept="image/*">
          <img id="v2_capPrev" class="preview">
        </div>
        <div class="col-4">
          <label class="form-label">Condition photo</label>
          <input type="file" class="form-control" id="v2_condPhoto" accept="image/*">
          <img id="v2_condPrev" class="preview">
        </div>
      </div>
    </div>

    <div class="row g-2">
      <div class="col-md-6">
        <div class="form-card">
          <h6 class="fw-bold">Gateway</h6>
          <label class="form-label">Location</label>
          <input class="form-control" id="gw_loc" placeholder="e.g. by chiller switchboard">
          <label class="form-label mt-2">Comments</label>
          <input class="form-control" id="gw_notes">
          <input type="file" class="form-control mt-2" id="gw_photo" accept="image/*">
          <img id="gw_prev" class="preview">
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-card">
          <h6 class="fw-bold">Signal</h6>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Spark bars</label>
              <select id="sig_spark" class="form-select">
                <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">One NZ bars</label>
              <select id="sig_one" class="form-select">
                <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              </select>
            </div>
          </div>
          <label class="form-label mt-2">Preferred</label>
          <select id="sig_pref" class="form-select">
            <option value="">—</option><option value="spark">Spark</option><option value="one">One NZ</option>
          </select>
        </div>
      </div>
    </div>

    <div class="row g-2">
      <div class="col-md-6">
        <div class="form-card">
          <h6 class="fw-bold">Other telemetry</h6>
          <label class="form-label">Brand</label>
          <input id="tel_brand" class="form-control" placeholder="Halo, Levno, DTS, NDA…">
          <label class="form-label mt-2">Type</label>
          <input id="tel_type" class="form-control" placeholder="vat, water, fuel…">
          <label class="form-label mt-2">Comments</label>
          <input id="tel_notes" class="form-control">
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-card">
          <h6 class="fw-bold">Rubberware</h6>
          <label class="form-label">Vat Door Seal</label>
          <select id="rub_door" class="form-select">
            <option value="notdelivered">Not delivered</option>
            <option value="delivered">Delivered</option>
          </select>
          <div class="row g-2 mt-2">
            <div class="col-6">
              <label class="form-label">Door Seal Size</label>
              <select id="rub_door_size" class="form-select">
                <option value="">Unspecified</option><option value="small">Small</option><option value="large">Large</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">Count</label>
              <input id="rub_door_count" class="form-control" inputmode="numeric" placeholder="auto=vat count">
            </div>
          </div>
          <input type="file" id="rub_door_photo" class="form-control mt-2" accept="image/*">
          <img id="rub_door_prev" class="preview">
          <hr>
          <label class="form-label">RJT Step Seal</label>
          <select id="rub_rjt" class="form-select">
            <option value="notdelivered">Not delivered</option>
            <option value="delivered">Delivered</option>
          </select>
          <label class="form-label mt-2">RJT Size</label>
          <select id="rub_rjt_size" class="form-select">
            <option value="">Unspecified</option><option value="small">Small</option><option value="large">Large</option>
          </select>
          <input type="file" id="rub_rjt_photo" class="form-control mt-2" accept="image/*">
          <img id="rub_rjt_prev" class="preview">
        </div>
      </div>
    </div>

    <div class="sticky-save d-flex align-items-center gap-2">
      <button id="btnSave" class="btn btn-brand">Save <span id="saveSpin" class="loader" style="display:none"></span></button>
      <button id="btnPrint" class="btn btn-outline-secondary">Print Brochure</button>
      <span class="ms-auto badge-soft">Loaded from cloud: <span id="cloudCount">0</span></span>
    </div>
  </section>

  <!-- ============== SUMMARY ================= -->
  <section id="pageSummary" class="panel" style="display:none">
    <div class="d-flex align-items-end gap-2 mb-2">
      <input id="qSearch" class="form-control" placeholder="Search Dairy # / text…" style="max-width:260px">
      <span class="ms-auto sub">Cloud: <span id="sumCloud">0</span> • Farms listed: <span id="sumShown">0</span></span>
    </div>
    <div id="overview" class="summary-cards mb-3"></div>
    <div id="filterNote" class="mb-2" style="display:none"></div>
    <div id="farmList"></div>
  </section>

  <!-- ============== ADMIN ================= -->
  <section id="pageAdmin" class="panel" style="display:none">
    <h5 class="mb-2">Admin</h5>
    <div class="kv mb-2">
      <div class="muted">Data folder</div><div>Pre Check/*.json</div>
      <div class="muted">Brand logo</div><div>Agora Logo/2F6-1YdaEP.jpeg</div>
    </div>
    <button id="btnReload" class="btn btn-navy">Reload now</button>
  </section>
</div>

<!-- libs -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ------------ Firebase ------------ */
const firebaseConfig = {
  apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain: "dairy-farm-record-system.firebaseapp.com",
  projectId: "dairy-farm-record-system",
  storageBucket: "dairy-farm-record-system.appspot.com",
  messagingSenderId: "422124188212",
  appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

/* ------------ DOM helpers ------------ */
const $=id=>document.getElementById(id);
function show(id,on=true){$(id).style.display=on?'block':'none';}
function setActive(tab){
  ['Form','Summary','Admin'].forEach(t=>{
    $('page'+t).style.display = (t===tab)?'block':'none';
    $('tab'+t).classList.toggle('active',t===tab);
  });
  if(tab==='Summary') { renderOverview(); }
}

/* ------------ Logo ------------ */
(async function(){
  try{ const u=await storage.ref("Agora Logo/2F6-1YdaEP.jpeg").getDownloadURL(); $('agoraLogo').src=u; }catch(e){}
})();

/* ------------ State ------------ */
let ALL = [];          // all farm objects
let SHOWN = [];        // currently listed (after search/filter)
let LOGO_BASE64 = "";

/* ------------ Normaliser (slang -> features) ------------ */
function analyse(rec){
  const join = (...xs)=>xs.filter(Boolean).join(" | ").toLowerCase();
  const t = join(rec['v1_notes'], rec['v2_notes'], rec['gw_notes'], rec['tel_notes']);

  const dts = /\bdts\b|vent\s*cap|grey\s*halo|gray\s*halo|halo\s*sensor|nda\s*cap/.test(t) ||
              /\bdts\b|vent/i.test(rec['tel_brand']||'');

  const needsPower = /(power\s*point|powerpoint|pp\b|splitter\s*plug|double\s*adapter|power\s*outlet)/.test(t);

  const sparkBars = Number(rec['sig_spark']||0);
  const oneBars   = Number(rec['sig_one']||0);
  let pref = rec['sig_pref']||'';
  if(!pref){ if(sparkBars>oneBars) pref='spark'; else if(oneBars>sparkBars) pref='one'; }

  return { dts, needsPower, pref, sparkBars, oneBars };
}

/* ------------ Fetch all from cloud (progressive) ------------ */
async function reloadFromCloud(){
  ALL.length = 0; SHOWN.length = 0;
  $('sumCloud').textContent = '0';
  $('sumShown').textContent = '0';
  $('farmList').innerHTML = '';
  renderOverview(); // empty state quickly

  const list = await storage.ref('Pre Check').listAll();
  $('sumCloud').textContent = list.items.length;

  // Progressive: render as each file arrives (no waiting)
  let i=0;
  for(const item of list.items){
    try{
      const url = await item.getDownloadURL();
      const rec = await fetch(url).then(r=>r.json());
      // rename keys to the ones this template uses (support older files)
      const normalised = mapIncoming(rec, item.name.replace('.json',''));
      ALL.push(normalised);
      i++;
      // update on the fly
      pushFarmCard(normalised);
      $('sumShown').textContent = i;
      if(i===1) renderOverview(); else updateOverviewCounts();
    }catch(e){ console.warn('bad file', item.name, e); }
  }
}

/* map older keys to our current IDs */
function mapIncoming(r, fallbackId){
  const out = {
    dairyNumber: r.dairyNumber || fallbackId,
    // Vat1
    v1_cap: r['vat1-capacity'] || r['vat1Cap'] || r['Vat 1 Capacity'] || '',
    v1_sn:  r['vat1-serial'] || r['Vat 1 SN'] || '',
    v1_capAvail: r['vat1-cap'] || r['Vat 1 Cap'] || 'available',
    v1_cond: r['vat1-condition'] || r['Vat 1 Condition'] || 'ok',
    v1_notes: r['vat1-comments'] || r['Vat 1 Notes'] || '',
    v1_agitLoc: r['agitator1-location'] || r['Agit1 Loc'] || '',
    v1_agitPhoto: r.agitator1Photo || r['Agit1 Photo'] || '',
    v1_capPhoto: r.vat1CapPhoto || '',
    v1_condPhoto: r.vat1CondPhoto || '',
    // Vat2
    v2_cap: r['vat2-capacity'] || r['vat2Cap'] || '',
    v2_sn:  r['vat2-serial'] || '',
    v2_capAvail: r['vat2-cap'] || 'na',
    v2_cond: r['vat2-condition'] || 'ok',
    v2_notes: r['vat2-comments'] || '',
    v2_agitLoc: r['agitator2-location'] || '',
    v2_agitPhoto: r.agitator2Photo || '',
    v2_capPhoto: r.vat2CapPhoto || '',
    v2_condPhoto: r.vat2CondPhoto || '',
    // gateway / signal
    gw_loc: r['gateway-location'] || '',
    gw_notes: r['gateway-comments'] || '',
    gw_photo: r.gatewayPhoto || '',
    sig_spark: r['spark-bars'] || '0',
    sig_one: r['one-bars'] || '0',
    sig_pref: r['signal-preferred'] || '',
    // telemetry
    tel_brand: r['telemetry-brand'] || '',
    tel_type:  r['telemetry-type'] || '',
    tel_notes: r['telemetry-comments'] || '',
    // rubber
    rub_door: r['vat-door-seal'] || 'notdelivered',
    rub_door_size: r['door-seal-size'] || '',
    rub_door_count: r['door-seal-count'] || '',
    rub_door_photo: r.doorSealPhoto || '',
    rub_rjt: r['rjt-seal'] || 'notdelivered',
    rub_rjt_size: r['rjt-size'] || '',
    rub_rjt_photo: r.rjtPhoto || '',
    timestamp: r.timestamp || Date.now()
  };
  return out;
}

/* ------------ Overview cards ------------ */
function buildOverviewCounts(rows){
  let dts=0, power=0, spark=0, one=0, rubber=0;
  const sizes=new Set();
  for(const f of rows){
    const A = analyse(f);
    if(A.dts) dts++;
    if(A.needsPower) power++;
    if(A.pref==='spark') spark++;
    if(A.pref==='one') one++;
    if(f.rub_door==='delivered') rubber += Number(f.rub_door_count||1);
    if(f.v1_cap) sizes.add(f.v1_cap);
    if(f.v2_cap) sizes.add(f.v2_cap);
  }
  return {dts,power,spark,one,rubber,sizes: sizes.size};
}
function overviewTemplate(cnt){
  const items=[
    {id:'f_dts',   n:cnt.dts,    t:'DTS Vent Caps'},
    {id:'f_power', n:cnt.power,  t:'Farms needing power point'},
    {id:'f_spark', n:cnt.spark,  t:'Spark preferred'},
    {id:'f_one',   n:cnt.one,    t:'One NZ preferred'},
    {id:'f_rub',   n:cnt.rubber, t:'Rubberware deliveries'},
    {id:'f_sizes', n:cnt.sizes,  t:'Distinct vat sizes'}
  ];
  return items.map(c=>`<div class="sumcard" data-filter="${c.id}"><div class="n">${c.n}</div><div class="t">${c.t}</div></div>`).join('');
}
function renderOverview(){
  const cnt = buildOverviewCounts(ALL);
  $('overview').innerHTML = overviewTemplate(cnt);
  Array.from($('overview').querySelectorAll('.sumcard')).forEach(el=>{
    el.onclick=()=>applyFilter(el.dataset.filter);
  });
}
function updateOverviewCounts(){ renderOverview(); }

/* ------------ List + Cards ------------ */
function linesFor(rec){
  const v1 = `Vat 1: ${rec.v1_cap||'—'} L • Cap ${rec.v1_capAvail||'—'} • Cond ${rec.v1_cond||'—'} • SN ${rec.v1_sn||'—'}`;
  const v2 = (rec.v2_cap && rec.v2_capAvail!=='na')
            ? `Vat 2: ${rec.v2_cap} L • Cap ${rec.v2_capAvail||'—'} • Cond ${rec.v2_cond||'—'} • SN ${rec.v2_sn||'—'}`
            : '';
  const sig = `Signal: Spark ${rec.sig_spark||0} bars • One NZ ${rec.sig_one||0} bars • Pref ${rec.sig_pref||'—'}`;
  const rub = `Rubberware: Door seal ${rec.rub_door||'—'} (${rec.rub_door_size||'unspecified'}, x${rec.rub_door_count||'1'}) • RJT ${rec.rub_rjt||'—'} ${rec.rub_rjt_size? '('+rec.rub_rjt_size+')':''}`;
  return {v1,v2,sig,rub};
}
function cardHTML(rec){
  const L = linesFor(rec);
  return `
  <div class="farm-card" id="farm-${rec.dairyNumber}">
    <div class="d-flex align-items-center justify-content-between mb-1">
      <h5>#${rec.dairyNumber}</h5>
      <div>
        <button class="btn btn-sm btn-outline-secondary me-1" data-print="${rec.dairyNumber}">Print</button>
        <button class="btn btn-sm btn-brand" data-details="${rec.dairyNumber}">Details</button>
      </div>
    </div>
    <div class="farm-meta">${L.v1}</div>
    ${L.v2? `<div class="farm-meta mt-1">${L.v2}</div>`:''}
    <div class="farm-meta mt-1">${L.sig}</div>
    <div class="farm-meta mt-1">${L.rub}</div>
    <div class="details mt-2" style="display:none"></div>
  </div>`;
}
function pushFarmCard(rec){
  const wrap=$('farmList');
  wrap.insertAdjacentHTML('beforeend', cardHTML(rec));
  bindCard(rec.dairyNumber);
}
function bindCard(id){
  const el = document.querySelector(`#farm-${CSS.escape(id)}`);
  el.querySelector('[data-details]').onclick=()=>toggleDetails(id);
  el.querySelector('[data-print]').onclick=()=>printFarm(id);
}
function renderList(rows){
  $('farmList').innerHTML = '';
  rows.forEach(pushFarmCard);
}
function applyFilter(fid){
  const rows = ALL.filter(r=>{
    const A = analyse(r);
    if(fid==='f_dts') return A.dts;
    if(fid==='f_power') return A.needsPower;
    if(fid==='f_spark') return A.pref==='spark';
    if(fid==='f_one') return A.pref==='one';
    if(fid==='f_rub') return r.rub_door==='delivered';
    if(fid==='f_sizes') return true;
    return true;
  });
  $('filterNote').style.display='block';
  $('filterNote').innerHTML = `<span class="badge-soft">Showing ${rows.length} farms</span>`;
  renderList(rows);
}

/* ------------ Details (expand photos) ------------ */
function labelPhotos(rec){
  const items = [
    ['Gateway', rec.gw_photo],
    ['Vat 1 cap', rec.v1_capPhoto], ['Vat 1 condition', rec.v1_condPhoto], ['Agitator 1', rec.v1_agitPhoto],
    ['Vat 2 cap', rec.v2_capPhoto], ['Vat 2 condition', rec.v2_condPhoto], ['Agitator 2', rec.v2_agitPhoto],
    ['Door seal', rec.rub_door_photo], ['RJT', rec.rub_rjt_photo]
  ].filter(x=>!!x[1]);
  return items;
}
function toggleDetails(id){
  const rec = ALL.find(x=>x.dairyNumber==id);
  if(!rec) return;
  const host = document.querySelector(`#farm-${CSS.escape(id)} .details`);
  if(host.style.display==='none'){
    const photos = labelPhotos(rec);
    const grid = photos.length ? `<div class="grid-3 mt-2">${photos.map(p=>`<div class="photo"><img src="${p[1]}"><small>${p[0]}</small></div>`).join('')}</div>` : `<div class="muted">No photos.</div>`;
    const other = `
      <div class="mt-2"><span class="muted">Gateway</span>: ${rec.gw_loc||'—'} ${rec.gw_notes? '• '+rec.gw_notes:''}</div>
      <div class="mt-1"><span class="muted">Other telemetry</span>: ${rec.tel_brand||'—'} • ${rec.tel_type||'—'} ${rec.tel_notes? '• '+rec.tel_notes:''}</div>`;
    host.innerHTML = grid + other;
    host.style.display='block';
  }else{
    host.style.display='none';
  }
}

/* ------------ Search ------------ */
$('qSearch').addEventListener('input',()=>{
  const q = $('qSearch').value.trim().toLowerCase();
  const rows = ALL.filter(f=>{
    return !q || String(f.dairyNumber).toLowerCase().includes(q) ||
           (f.v1_notes||'').toLowerCase().includes(q) || (f.v2_notes||'').toLowerCase().includes(q);
  });
  renderList(rows);
});

/* ------------ Print Brochure ------------ */
async function printFarm(id){
  const rec = ALL.find(x=>x.dairyNumber==id);
  if(!rec) return;
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({orientation:'portrait',unit:'pt',format:'a4'});
  const W = pdf.internal.pageSize.getWidth();

  // brand
  try{
    if(!LOGO_BASE64){
      const url = $('agoraLogo').src;
      if(url){ const b = await (await fetch(url)).blob(); LOGO_BASE64 = await blobToDataURL(b); }
    }
    if(LOGO_BASE64) pdf.addImage(LOGO_BASE64,'JPEG',40,24,110,48);
  }catch(e){}
  pdf.setFont('helvetica','bold'); pdf.setFontSize(18);
  pdf.text('Vat Pre-Check', 160, 48);
  pdf.setFont('helvetica','normal'); pdf.setFontSize(11);
  pdf.text(`#${rec.dairyNumber}`, W-150, 40);
  pdf.text(new Date(rec.timestamp||Date.now()).toISOString().slice(0,10), W-150, 58);

  // key facts box
  const L = linesFor(rec);
  const facts = [
    ['Vat 1', L.v1],
    ...(L.v2? [['Vat 2', L.v2]]: []),
    ['Gateway', `${rec.gw_loc||'—'} ${rec.gw_notes? '• '+rec.gw_notes:''}`],
    ['Signal', L.sig.replace('Signal: ','')],
    ['Telemetry', `${rec.tel_brand||'—'} • ${rec.tel_type||'—'} ${rec.tel_notes? '• '+rec.tel_notes:''}`],
    ['Rubberware', L.rub.replace('Rubberware: ','')]
  ];
  let y=100;
  pdf.setDrawColor(230); pdf.setFillColor(246,248,251);
  pdf.roundedRect(40,y, W-80, 86+18*(facts.length-4), 8,8,'F');
  pdf.setFont('helvetica','bold'); pdf.text('Key Facts', 52, y+20);
  pdf.setFont('helvetica','normal');
  let yy = y+40;
  facts.forEach(([k,v])=>{ pdf.text(`${k}: ${v}`, 52, yy); yy+=18; });

  // photos grid
  const photos = labelPhotos(rec).slice(0,9);
  const cw=(W-80-20)/3, ch=cw*0.62; let px=40, py=yy+12, c=0;
  for(const [lab,src] of photos){
    if(py+ch>780){ pdf.addPage(); px=40; py=60; }
    try{ pdf.addImage(src,'JPEG',px,py,cw,ch); }catch(e){}
    pdf.setFont('helvetica','normal'); pdf.text(lab,px,py+ch+14);
    c++; px+=cw+10; if(c%3===0){px=40; py+=ch+40;}
  }
  pdf.save(`PreCheck_${rec.dairyNumber}.pdf`);
}
function blobToDataURL(b){ return new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(b); }); }

/* ------------ Form: load + save ------------ */
function attachPreview(inputId, imgId){
  $(inputId).addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=ev=>{ const img=$(imgId); img.src=ev.target.result; img.style.display='block'; img.dataset.b64=ev.target.result; };
    r.readAsDataURL(f);
  });
}
['v1_agit','v1_cap','v1_cond','v2_agit','v2_cap','v2_cond','gw','rub_door','rub_rjt']
.forEach(k=>attachPreview(`${k}_Photo`, `${k.includes('rub')?k.replace('_','_')+'_prev':k+'_prev'}`));
// explicit bindings:
attachPreview('gw_photo','gw_prev'); attachPreview('rub_door_photo','rub_door_prev'); attachPreview('rub_rjt_photo','rub_rjt_prev');

$('dairyNumber').addEventListener('blur', async e=>{
  const num = e.target.value.trim(); if(!num) return;
  try{
    const url = await storage.ref(`Pre Check/${num}.json`).getDownloadURL();
    const raw = await fetch(url).then(r=>r.json());
    const rec = mapIncoming(raw,num);
    // populate
    const set=(id,val)=>{ if($(id)!=null) $(id).value = val??''; };
    set('v1_cap',rec.v1_cap); set('v1_sn',rec.v1_sn); set('v1_capAvail',rec.v1_capAvail); set('v1_cond',rec.v1_cond); set('v1_notes',rec.v1_notes); set('v1_agitLoc',rec.v1_agitLoc);
    set('v2_cap',rec.v2_cap); set('v2_sn',rec.v2_sn); set('v2_capAvail',rec.v2_capAvail); set('v2_cond',rec.v2_cond); set('v2_notes',rec.v2_notes); set('v2_agitLoc',rec.v2_agitLoc);
    set('gw_loc',rec.gw_loc); set('gw_notes',rec.gw_notes); set('sig_spark',rec.sig_spark); set('sig_one',rec.sig_one); set('sig_pref',rec.sig_pref);
    set('tel_brand',rec.tel_brand); set('tel_type',rec.tel_type); set('tel_notes',rec.tel_notes);
    set('rub_door',rec.rub_door); set('rub_door_size',rec.rub_door_size); set('rub_door_count',rec.rub_door_count); set('rub_rjt',rec.rub_rjt); set('rub_rjt_size',rec.rub_rjt_size);
    // hydrate image previews
    const hyd=(b64,id)=>{ if(b64){ const img=$(id); img.src=b64; img.style.display='block'; img.dataset.b64=b64; } };
    hyd(rec.v1_agitPhoto,'v1_agitPrev'); hyd(rec.v1_capPhoto,'v1_capPrev'); hyd(rec.v1_condPhoto,'v1_condPrev');
    hyd(rec.v2_agitPhoto,'v2_agitPrev'); hyd(rec.v2_capPhoto,'v2_capPrev'); hyd(rec.v2_condPhoto,'v2_condPrev');
    hyd(rec.gw_photo,'gw_prev'); hyd(rec.rub_door_photo,'rub_door_prev'); hyd(rec.rub_rjt_photo,'rub_rjt_prev');
  }catch(e){ /* not found – leave blank */ }
});

$('btnSave').addEventListener('click', async ()=>{
  const num = $('dairyNumber').value.trim();
  if(!num){ alert('Enter dairy number'); return; }
  show('saveSpin',true);
  // collect
  const rec = {
    dairyNumber:num, timestamp:Date.now(),
    v1_cap:$('v1_cap').value, v1_sn:$('v1_sn').value, v1_capAvail:$('v1_capAvail').value, v1_cond:$('v1_cond').value, v1_notes:$('v1_notes').value, v1_agitLoc:$('v1_agitLoc').value,
    v2_cap:$('v2_cap').value, v2_sn:$('v2_sn').value, v2_capAvail:$('v2_capAvail').value, v2_cond:$('v2_cond').value, v2_notes:$('v2_notes').value, v2_agitLoc:$('v2_agitLoc').value,
    gw_loc:$('gw_loc').value, gw_notes:$('gw_notes').value, sig_spark:$('sig_spark').value, sig_one:$('sig_one').value, sig_pref:$('sig_pref').value,
    tel_brand:$('tel_brand').value, tel_type:$('tel_type').value, tel_notes:$('tel_notes').value,
    rub_door:$('rub_door').value, rub_door_size:$('rub_door_size').value, rub_door_count:$('rub_door_count').value,
    rub_rjt:$('rub_rjt').value, rub_rjt_size:$('rub_rjt_size').value
  };
  const imgToData = id=>($(id).dataset && $(id).dataset.b64) ? $(id).dataset.b64 : ($(id).src||'');
  rec.v1_agitPhoto=imgToData('v1_agitPrev'); rec.v1_capPhoto=imgToData('v1_capPrev'); rec.v1_condPhoto=imgToData('v1_condPrev');
  rec.v2_agitPhoto=imgToData('v2_agitPrev'); rec.v2_capPhoto=imgToData('v2_capPrev'); rec.v2_condPhoto=imgToData('v2_condPrev');
  rec.gw_photo=imgToData('gw_prev'); rec.rub_door_photo=imgToData('rub_door_prev'); rec.rub_rjt_photo=imgToData('rub_rjt_prev');

  // default door-seal count
  if(!rec.rub_door_count){ let n=0; if(rec.v1_cap) n++; if(rec.v2_cap) n++; rec.rub_door_count=String(n||1); }

  const blob = new Blob([JSON.stringify(rec)], {type:'application/json'});
  await storage.ref(`Pre Check/${num}.json`).put(blob);
  show('saveSpin',false);
  alert('Saved ✔');
});

$('btnPrint').addEventListener('click', ()=>{
  const id = $('dairyNumber').value.trim();
  if(!id){ alert('Enter dairy number first'); return; }
  printFarm(id);
});

/* ------------ Routing ------------ */
$('tabForm').onclick=()=>setActive('Form');
$('tabSummary').onclick=()=>setActive('Summary');
$('tabAdmin').onclick=()=>setActive('Admin');
$('btnReload').onclick=()=>reloadFromCloud();

/* ------------ Boot ------------ */
document.addEventListener('DOMContentLoaded', async ()=>{
  // brand image for PDF header
  try{
    const url = await storage.ref("Agora Logo/2F6-1YdaEP.jpeg").getDownloadURL();
    const b = await (await fetch(url)).blob(); LOGO_BASE64 = await blobToDataURL(b);
  }catch(e){}
  // load everything immediately
  reloadFromCloud();
  setActive('Summary');
});
</script>
</body>
</html>