<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agora Vat Pre-Check</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">

<style>
:root{
  --brand:#001F3F; --accent:#FF851B; --muted:#6b7280; --bg:#f7f8fb; --ok:#2ecc71; --warn:#ffb020; --danger:#ff4136;
}
html,body{background:var(--bg);color:#0f172a;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
.app{max-width:1100px;margin:28px auto;padding:0 16px}
.brand-header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
.brand-logo{width:160px;height:auto;display:none}
.brand-title{flex:1}
.brand-title h1{margin:0;font-weight:800;color:var(--brand);letter-spacing:.2px}
.brand-sub{color:var(--muted);font-size:.95rem;margin-top:2px}
.top-tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 18px}
.tab-btn{border:1px solid #e5e7eb;background:#fff;color:#111827;border-radius:10px;padding:10px 14px;font-weight:700}
.tab-btn.active{border-color:var(--accent);box-shadow:0 0 0 3px #ff851b2b}
.pill{background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-weight:700}
.progress{height:10px}
.bar{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin:10px 0}
.section-title{font-size:1.1rem;font-weight:800;color:#111827;margin:6px 0 10px}
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media (max-width:900px){.kpi-grid{grid-template-columns:1fr}}
.kpi{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:16px;cursor:pointer}
.kpi .num{font-size:1.6rem;font-weight:800}
.kpi .label{color:#6b7280;font-size:1rem}
.card-list{display:grid;grid-template-columns:1fr;gap:10px}
.farm-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center}
.farm-left{display:flex;align-items:center;gap:8px}
.farm-id{font-weight:800}
.btn-brand{background:var(--accent);border:none;color:#fff;font-weight:700}
.btn-brand:hover{background:#ff6d00}
.btn-outline-brand{border:1px solid var(--accent);color:var(--accent);background:#fff;font-weight:700}
.btn-outline-brand:hover{background:var(--accent);color:#fff}
.small-note{color:#6b7280}
.footer{color:#6b7280;text-align:center;margin:22px 0 10px}
.hidden{display:none!important}

/* BROCHURE (1 page) */
.print-sheet{max-width:900px;margin:0 auto;color:#0f172a}
.print-head{display:flex;align-items:center;gap:16px;border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:10px}
.print-head img{height:44px}
.print-title{font-weight:800;font-size:1.2rem}
.print-sub{color:#6b7280}
.print-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.print-card{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.print-label{font-weight:700;margin-bottom:6px}
.print-photos{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.print-photos img{width:100%;max-height:180px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb}

/* DETAILS MODAL */
#details-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:9999}
#details-modal .panel{max-width:980px;margin:40px auto;background:#fff;border-radius:12px;padding:16px}
#details-close{float:right}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="brand-header">
    <img id="logo" class="brand-logo" alt="Agora Logo">
    <div class="brand-title">
      <h1>Agora Vat Pre-Check</h1>
      <div class="brand-sub">Fast field capture • Smart summary • Customer-ready output</div>
    </div>
  </div>

  <!-- TABS -->
  <div class="top-tabs">
    <button id="tab-summary" class="tab-btn active">Summary</button>
    <button id="tab-form" class="tab-btn">Form</button>
    <button id="tab-admin" class="tab-btn">Admin</button>

    <div class="ms-auto d-flex align-items-center gap-2 flex-wrap">
      <span class="pill">Cloud: <span id="cloud-count">–</span></span>
      <span class="pill">Loaded: <span id="loaded-count">0</span></span>
      <div class="progress" style="width:200px"><div id="load-bar" class="progress-bar" role="progressbar" style="width:0%"></div></div>
      <span id="load-pct" class="small-note">0%</span>
    </div>
  </div>

  <!-- SUMMARY -->
  <div id="view-summary">
    <div class="kpi-grid">
      <div id="kpi-dts" class="kpi"><div class="num">0</div><div class="label">DTS Vent Caps</div></div>
      <div id="kpi-power" class="kpi"><div class="num">0</div><div class="label">Farms needing power point</div></div>
      <div id="kpi-rubber" class="kpi"><div class="num">0</div><div class="label">Rubberware deliveries</div></div>
    </div>

    <div class="bar">
      <div class="section-title">Vat Size Breakdown (live from cloud)</div>
      <div id="size-table"></div>
      <button id="btn-export-sizes" class="btn btn-outline-brand mt-2">Export Sizes CSV</button>
    </div>

    <div class="bar">
      <div class="section-title d-flex align-items-center gap-2">
        Results
        <input id="search" class="form-control" placeholder="Search dairy # or text…" style="max-width:320px">
        <button id="btn-clear" class="btn btn-outline-secondary btn-sm">Clear</button>
      </div>
      <div id="result-cards" class="card-list"></div>
    </div>
  </div>

  <!-- FORM -->
  <div id="view-form" class="hidden">
    <div class="bar">
      <div class="section-title">Capture / Edit</div>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Dairy Number</label>
          <input class="form-control" id="dairyNumber" placeholder="e.g. 7031">
          <div class="small-note">Blur to auto-fill from cloud (and cache for offline).</div>
        </div>
        <div class="col-md-5">
          <label class="form-label">Gateway Location</label>
          <input class="form-control" id="gateway-location">
        </div>
        <div class="col-md-4">
          <label class="form-label">Gateway Comments</label>
          <input class="form-control" id="gateway-comments">
        </div>
      </div>
    </div>

    <div class="bar">
      <div class="row g-3">
        <div class="col-md-3"><label class="form-label">Vat 1 Capacity (L)</label><input class="form-control" id="vat1-capacity"></div>
        <div class="col-md-3"><label class="form-label">Vat 1 Serial</label><input class="form-control" id="vat1-serial"></div>
        <div class="col-md-3"><label class="form-label">Vat 1 Cap</label>
          <select id="vat1-cap" class="form-select"><option value="available">AVAILABLE</option><option value="unavailable">UNAVAILABLE</option></select>
        </div>
        <div class="col-md-3"><label class="form-label">Vat 1 Condition</label>
          <select id="vat1-condition" class="form-select"><option value="ok">ok</option><option value="attention">attention</option></select>
        </div>
        <div class="col-md-6"><label class="form-label">Vat 1 Notes</label><input class="form-control" id="vat1-comments"></div>
        <div class="col-md-6"><label class="form-label">Vat 1 Cap Comments</label><input class="form-control" id="vat1-cap-comments"></div>
      </div>
    </div>

    <div class="bar">
      <div class="row g-3">
        <div class="col-md-3"><label class="form-label">Vat 2 Capacity (L)</label><input class="form-control" id="vat2-capacity" placeholder="(blank if N/A)"></div>
        <div class="col-md-3"><label class="form-label">Vat 2 Serial</label><input class="form-control" id="vat2-serial"></div>
        <div class="col-md-3"><label class="form-label">Vat 2 Cap</label>
          <select id="vat2-cap" class="form-select"><option value="na">N/A</option><option value="available">AVAILABLE</option><option value="unavailable">UNAVAILABLE</option></select>
        </div>
        <div class="col-md-3"><label class="form-label">Vat 2 Condition</label>
          <select id="vat2-condition" class="form-select"><option value="ok">ok</option><option value="attention">attention</option></select>
        </div>
        <div class="col-md-6"><label class="form-label">Vat 2 Notes</label><input class="form-control" id="vat2-comments"></div>
        <div class="col-md-6"><label class="form-label">Vat 2 Cap Comments</label><input class="form-control" id="vat2-cap-comments"></div>
      </div>
    </div>

    <div class="bar">
      <div class="row g-3">
        <div class="col-md-3"><label class="form-label">Spark (bars)</label><input class="form-control" id="spark-bars"></div>
        <div class="col-md-3"><label class="form-label">One NZ (bars)</label><input class="form-control" id="one-bars"></div>
        <div class="col-md-3"><label class="form-label">Other Brand</label><input class="form-control" id="other-brand" placeholder="Halo, Levno, DTS, NDA"></div>
        <div class="col-md-3"><label class="form-label">Other Type</label>
          <select class="form-select" id="other-type"><option value="">Select…</option><option value="vat">Vat</option><option value="water">Water</option><option value="fuel">Fuel</option><option value="other">Other</option></select>
        </div>
        <div class="col-12"><label class="form-label">Other Notes</label><input class="form-control" id="other-notes"></div>
      </div>
    </div>

    <div class="bar">
      <div class="row g-3">
        <div class="col-md-3"><label class="form-label">Door Seal Delivered?</label>
          <select class="form-select" id="door-delivered"><option value="no">No</option><option value="yes">Yes</option></select>
        </div>
        <div class="col-md-3"><label class="form-label">Door Seal Size</label>
          <select class="form-select" id="door-size"><option value="">(unspecified)</option><option>Small</option><option>Large</option></select>
        </div>
        <div class="col-md-3"><label class="form-label">RJT Delivered?</label>
          <select class="form-select" id="rjt-delivered"><option value="no">No</option><option value="yes">Yes</option></select>
        </div>
        <div class="col-md-3"><label class="form-label">RJT Size</label>
          <select class="form-select" id="rjt-size"><option value="">(unspecified)</option><option>Small</option><option>Large</option></select>
        </div>
      </div>
    </div>

    <div id="form-photos" class="bar hidden">
      <div class="section-title">Existing Photos (read-only)</div>
      <div id="form-photo-grid" class="print-photos"></div>
    </div>

    <div class="d-flex gap-2">
      <button id="btn-save" class="btn btn-brand">Save / Update</button>
      <button id="btn-print-current" class="btn btn-outline-brand">Print Brochure</button>
    </div>
    <div id="save-msg" class="small-note mt-2"></div>
  </div>

  <!-- ADMIN -->
  <div id="view-admin" class="hidden">
    <div class="bar">
      <div class="section-title">Cloud & Reports</div>
      <div class="d-flex flex-wrap gap-2">
        <button id="btn-reload" class="btn btn-brand">Reload Cloud List</button>
        <button id="btn-print-all" class="btn btn-outline-brand">Print All Brochures</button>
        <button id="btn-zip-all" class="btn btn-outline-brand">Download All Brochures (ZIP)</button>
        <button id="btn-owner-report" class="btn btn-outline-brand">Owner Report (Print)</button>
      </div>
      <div class="small-note mt-2">“Reload Cloud List” shows dairy numbers instantly (no heavy JSON). Details/Photos pull only when you open a farm.</div>
    </div>
  </div>

  <div class="footer">Agora • Vat Pre-Check • v4.6</div>
</div>

<!-- DETAILS MODAL -->
<div id="details-modal">
  <div class="panel">
    <button id="details-close" class="btn btn-sm btn-outline-secondary">Close</button>
    <div id="details-body"></div>
  </div>
</div>

<!-- Hidden brochure root for single render -->
<div id="print-root" class="hidden"></div>

<!-- Firebase & libs -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
/* ================== Firebase ================== */
const firebaseConfig = {
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const FOLDER = 'Pre Check';

/* ================== SW register ================== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}

/* ================== DOM helpers ================== */
const $ = id => document.getElementById(id);
function show(id){ $(id).classList.remove('hidden') }
function hide(id){ $(id).classList.add('hidden') }
function pct(n,d){ return d? Math.max(0,Math.min(100,Math.round(n*100/d))):0 }
function setProgress(done,total){
  $('load-bar').style.width = pct(done,total)+'%';
  $('load-pct').textContent = pct(done,total)+'%';
}

/* ================== Logo ================== */
(async()=>{ try{
  const url = await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL();
  $('logo').src = url; $('logo').style.display = 'block';
}catch(e){} })();

/* ================== Tabs ================== */
const VIEWS = { 'tab-summary':'view-summary', 'tab-form':'view-form', 'tab-admin':'view-admin' };
for (const t in VIEWS){
  $(t).onclick = ()=> {
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    $(t).classList.add('active');
    Object.values(VIEWS).forEach(id=>hide(id));
    show(VIEWS[t]);
  };
}

/* ================== Cloud list (fast) ================== */
let CLOUD_KEYS = [];
let STREAMED = 0;
let SIZE_COUNTS = {};
let KPI = { dts:0, power:0, rubber:0 };
let INDEX = new Map();
let STREAM_RUNNING = false;

async function listCloud(){
  const folder = storage.ref(FOLDER);
  const res = await folder.listAll();
  CLOUD_KEYS = res.items
    .filter(it=>/\.json$/i.test(it.name))
    .map(it=>it.name)
    .sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}));
  $('cloud-count').textContent = CLOUD_KEYS.length;
  renderSimpleList(CLOUD_KEYS.map(k => k.replace('.json','')));
}
$('btn-reload').onclick = async ()=>{
  await listCloud();
  // restart stream
  streamForKpisAndSizes(true);
};

/* ================== Detail fetch (on demand) ================== */
async function fetchRec(dn){
  try{
    const url = await storage.ref(`${FOLDER}/${dn}.json`).getDownloadURL();
    const rec = await fetch(url).then(r=>r.json());
    return normalize(rec, dn);
  }catch(e){ return null }
}

/* ================== Normalization & Mapping ================== */
function pick(rec, ...keys){
  for (const k of keys){
    if (rec==null) continue;
    if (rec[k]!=null && rec[k]!=='' ) return rec[k];
    const key = Object.keys(rec).find(x => x.toLowerCase()===k.toLowerCase());
    if (key && rec[key]!=null && rec[key]!=='') return rec[key];
  }
  return '';
}
function nstr(x){ return (x==null?'':String(x)).trim() }

/* Signal extraction — now handles “2-3 bars either carrier”, “full bars both carriers”, etc */
function splitSignalFromGateway(rec){
  const raw = [pick(rec,'gateway-comments','GatewayComments'), pick(rec,'gateway-location','GatewayLocation')].filter(Boolean).join(' ');
  const txt = raw.toLowerCase()
    .replace(/\bvodafone\b/g,'one nz')
    .replace(/\bone\s*n\.?\s*z\b/g,'one nz')
    .replace(/\bone\b(?!\s*nz)/g,'one nz');

  // ranges like "2-3 bars"
  const rng = txt.match(/(\d)\s*[-–]\s*(\d)\s*bars?/);
  let rngVal = '';
  if (rng){ rngVal = String(Math.max(+rng[1], +rng[2])); }

  const grab = (re)=>{ const m = txt.match(re); return m? m[1] : '' };
  let spark = grab(/spark[^0-9]{0,12}(\d)\s*bar/) || grab(/(\d)\s*bar[^a-z]{0,6}spark/) || rngVal ||
              (/(spark[^a-z]*full|max)/.test(txt)? '5':'');
  let one   = grab(/one nz[^0-9]{0,12}(\d)\s*bar/) || grab(/(\d)\s*bar[^a-z]{0,6}one nz/) || rngVal ||
              (/(one nz[^a-z]*full|max)/.test(txt)? '5':'');

  if (/both\s*carriers.*(full|max)/.test(txt)){ spark='5'; one='5'; }
  if (/either\s*carrier/.test(txt) && rngVal){ spark=rngVal; one=rngVal; }
  if (/no\s*signal/.test(txt)){ spark = spark||'0'; one=one||'0'; }

  // Explicit numeric fields override
  spark = nstr(pick(rec,'spark-bars','SparkBars')) || spark;
  one   = nstr(pick(rec,'one-bars','OneNZBars'))   || one;

  const cleaned = raw
    .replace(/(spark|one\s*nz|vodafone)[^,;]*\d\s*bar[s]?/ig,'')
    .replace(/(both|either)\s*carriers[^,;]*/ig,'')
    .replace(/(no|poor|ok|full|max)\s*signal/ig,'')
    .replace(/\s{2,}/g,' ').trim();
  return { spark, one, gatewayOther: cleaned };
}

// Power-point detector (broadened)
function detectPowerPoint(rec){
  const blob = [
    pick(rec,'gateway-location','GatewayLocation'),
    pick(rec,'gateway-comments','GatewayComments'),
    pick(rec,'vat1-comments','Notes'),
    pick(rec,'vat2-comments'),
    pick(rec,'other-notes','OtherNotes')
  ].join(' ').toLowerCase();

  const POS = [
    'new powerpoint recommended','need power point','needs power point',
    'use desk power point','desk power point','no plugs available','no plug','no power point','no powerpoint',
    'power point to be installed','pp to be installed','install power point',
    'splitter plug required','no spare plug','no spare outlet','extension lead needed',
    'single plug','needs new plug','switchboard (no socket)','needs power'
  ];
  const NEG = [
    'power point available','has power point','spare power point','spare outlet',
    'power point ok','pp ok','good power point','multiple points' // treat as OK
  ];
  if (NEG.some(p=>blob.includes(p))) return false;
  return POS.some(p=>blob.includes(p));
}

// DTS vent cap — strict variants only (per your rules)
function detectDtsCap(rec){
  const src = [
    pick(rec,'vat1-cap-comments','CapComments'),
    pick(rec,'vat2-cap-comments'),
    pick(rec,'vat1-comments','Notes'),
    pick(rec,'vat2-comments')
  ].join(' ').toLowerCase();

  const ok = [
    /(halo\s*(grey|gray)\s*cap)/,
    /\b(grey|gray)\s*sensor\b/,
    /\bdts\s*reduc(er|ing)\b/,
    /reducing\s*grey\s*sensor\s*cap/
  ];
  return ok.some(re=>re.test(src));
}

/* Photo extract — looks for base64 keys or path-like keys; resolves paths to URLs */
async function resolvePhotoMaybe(path){
  if(!path) return '';
  if (/^data:image\//i.test(path)) return path;
  if (/^https?:\/\//i.test(path)) return path;
  try{
    const url = await storage.ref(path).getDownloadURL();
    return url;
  }catch(e){ return '' }
}
async function extractPhotos(rec){
  // prefer explicit base64 if present; otherwise try string paths
  const base64 = (k)=> nstr(pick(rec,k, k.replace(/-/g,''), k.replace(/-/g,'_')));
  const candidates = {
    gateway:  base64('gateway-photo-base64')  || base64('gateway-photo'),
    vat1cap:  base64('vat1-cap-photo-base64') || base64('vat1-cap-photo'),
    agit1:    base64('agitator1-photo-base64')|| base64('agitator-photo-base64')|| base64('agitator1-photo'),
    vat2cap:  base64('vat2-cap-photo-base64') || base64('vat2-cap-photo'),
    door:     base64('vat-door-seal-photo-base64') || base64('door-photo-base64') || base64('door-photo'),
    rjt:      base64('rjt-seal-photo-base64') || base64('rjt-photo-base64') || base64('rjt-photo')
  };
  // If not base64, they may be storage paths
  for (const k of Object.keys(candidates)){
    if (candidates[k] && !/^data:image\//i.test(candidates[k]) && !/^https?:\/\//i.test(candidates[k])){
      candidates[k] = await resolvePhotoMaybe(candidates[k]);
    }
  }
  return candidates;
}

function normalize(rec, forcedDn=''){
  const dn = nstr(rec.dairyNumber || rec.Dairy || forcedDn);

  // Vat 1
  const v1Size = nstr(pick(rec,'vat1-capacity','Size','Vat1Size'));
  const v1Serial = nstr(pick(rec,'vat1-serial','Serial','Vat1Serial'));
  const v1Cap = (nstr(pick(rec,'vat1-cap','Cap','Vat1Cap'))||'').toUpperCase() || 'AVAILABLE';
  const v1Cond = nstr(pick(rec,'vat1-condition','Condition','Vat1Condition')).toLowerCase()||'ok';
  const v1Notes = nstr(pick(rec,'vat1-comments','Notes','Vat1Notes'));
  const v1CapComments = nstr(pick(rec,'vat1-cap-comments','CapComments','Vat1CapComments'));

  // Vat 2
  const v2Size = nstr(pick(rec,'vat2-capacity','Vat2Size'));
  const v2Serial = nstr(pick(rec,'vat2-serial','Vat2Serial'));
  const v2Cap = (nstr(pick(rec,'vat2-cap','Vat2Cap'))||'na').toUpperCase();
  const v2Cond = nstr(pick(rec,'vat2-condition','Vat2Condition')).toLowerCase()||'ok';
  const v2Notes = nstr(pick(rec,'vat2-comments','Vat2Notes'));
  const v2CapComments = nstr(pick(rec,'vat2-cap-comments','Vat2CapComments'));

  const {spark, one} = splitSignalFromGateway(rec);
  const manu = nstr(pick(rec,'other-brand','Manufacturer','OtherBrand'));
  const otype = nstr(pick(rec,'other-type','OtherType'));
  const onotes = nstr(pick(rec,'other-notes','OtherNotes'));

  const doorDelivered = (nstr(pick(rec,'door-delivered','DoorDelivered')).toLowerCase()==='yes');
  const rjtDelivered  = (nstr(pick(rec,'rjt-delivered','RJTDelivered')).toLowerCase()==='yes');
  const doorSize = nstr(pick(rec,'door-size','DoorSize'));
  const rjtSize  = nstr(pick(rec,'rjt-size','RJTSize'));
  const doorCount = doorDelivered ? (v2Size ? 2 : 1) : 0;

  return {
    dairyNumber: dn,
    'vat1-capacity': v1Size, 'vat1-serial': v1Serial, 'vat1-cap': v1Cap, 'vat1-condition': v1Cond, 'vat1-comments': v1Notes, 'vat1-cap-comments': v1CapComments,
    'vat2-capacity': v2Size, 'vat2-serial': v2Serial, 'vat2-cap': v2Cap, 'vat2-condition': v2Cond, 'vat2-comments': v2Notes, 'vat2-cap-comments': v2CapComments,
    'gateway-location': nstr(pick(rec,'gateway-location','GatewayLocation')),
    'gateway-comments': nstr(pick(rec,'gateway-comments','GatewayComments')),
    'spark-bars': spark, 'one-bars': one,
    'other-brand': manu, 'other-type': otype, 'other-notes': onotes,
    'door-delivered': doorDelivered?'yes':'no', 'door-size': doorSize,
    'rjt-delivered': rjtDelivered?'yes':'no', 'rjt-size': rjtSize,
    doorDeliveredCount: doorCount,
    __flags:{
      dtsCap: detectDtsCap({ ...rec, 'vat1-cap-comments': v1CapComments, 'vat2-cap-comments': v2CapComments, 'vat1-comments': v1Notes, 'vat2-comments': v2Notes }),
      power: detectPowerPoint(rec)
    }
  };
}

/* ================== Progressive KPIs & sizes ================== */
async function streamForKpisAndSizes(restart=false){
  if (STREAM_RUNNING && !restart) return;
  STREAM_RUNNING = true;
  if (restart){ SIZE_COUNTS={}; KPI={dts:0,power:0,rubber:0}; INDEX.clear(); STREAMED=0; $('loaded-count').textContent=0; setProgress(0, CLOUD_KEYS.length||1); }

  for (const key of CLOUD_KEYS){
    const dn = key.replace('.json','');
    if (INDEX.has(dn) && !restart){ STREAMED++; setProgress(STREAMED, CLOUD_KEYS.length||1); continue; }
    try{
      const url = await storage.ref(`${FOLDER}/${key}`).getDownloadURL();
      const raw = await fetch(url).then(r=>r.json());
      const rec = normalize(raw, dn);

      INDEX.set(dn, { dn,
        v1: rec['vat1-capacity'], v2: rec['vat2-capacity'],
        door: rec['door-delivered']==='yes', rjt: rec['rjt-delivered']==='yes',
        dts: !!rec.__flags.dtsCap, power: !!rec.__flags.power
      });

      const s1 = rec['vat1-capacity']; if (s1) SIZE_COUNTS[s1]=(SIZE_COUNTS[s1]||0)+1;
      const s2 = rec['vat2-capacity']; if (s2) SIZE_COUNTS[s2]=(SIZE_COUNTS[s2]||0)+1;

      if (rec.__flags.dtsCap) KPI.dts++;
      if (rec.__flags.power) KPI.power++;
      if (rec['door-delivered']==='yes' || rec['rjt-delivered']==='yes') KPI.rubber++;

      STREAMED++; $('loaded-count').textContent = STREAMED; setProgress(STREAMED, CLOUD_KEYS.length||1);
      if (STREAMED%12===0) { drawKpis(); drawSizesTable(); }
    }catch(e){
      STREAMED++; setProgress(STREAMED, CLOUD_KEYS.length||1);
    }
  }
  drawKpis(); drawSizesTable();
  STREAM_RUNNING = false;
}

/* ================== UI: list, kpis, sizes ================== */
function renderSimpleList(dairyList){
  const q = $('search').value.toLowerCase().trim();
  const filtered = q ? dairyList.filter(d=>d.toLowerCase().includes(q)) : dairyList;
  $('result-cards').innerHTML = filtered.map(dn => `
    <div class="farm-card">
      <div class="farm-left">
        <span class="farm-id">#${dn}</span>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-brand btn-sm" onclick="openDetails('${dn}')">Details</button>
        <button class="btn btn-brand btn-sm" onclick="openPrint('${dn}')">Print</button>
      </div>
    </div>
  `).join('');
}
$('search').addEventListener('input', ()=> renderSimpleList(CLOUD_KEYS.map(k=>k.replace('.json',''))));
$('btn-clear').onclick = ()=>{ $('search').value=''; renderSimpleList(CLOUD_KEYS.map(k=>k.replace('.json',''))); };

function drawKpis(){
  $('kpi-dts').querySelector('.num').textContent = KPI.dts;
  $('kpi-power').querySelector('.num').textContent = KPI.power;
  $('kpi-rubber').querySelector('.num').textContent = KPI.rubber;

  $('kpi-dts').onclick = ()=> {
    const rows = [...INDEX.values()].filter(r=>r.dts).map(r=>r.dn);
    renderSimpleList(rows);
  };
  $('kpi-power').onclick = ()=> {
    const rows = [...INDEX.values()].filter(r=>r.power).map(r=>r.dn);
    renderSimpleList(rows);
  };
  $('kpi-rubber').onclick = ()=> {
    const rows = [...INDEX.values()].filter(r=>r.door||r.rjt).map(r=>r.dn);
    renderSimpleList(rows);
  };
}
function drawSizesTable(){
  const rows = Object.entries(SIZE_COUNTS).sort((a,b)=>parseInt(a[0])-parseInt(b[0]));
  let html = '<table class="table table-sm table-bordered"><thead><tr><th>Vat Size (L)</th><th>Count</th></tr></thead><tbody>';
  rows.forEach(([sz,c])=> html+=`<tr><td>${sz}</td><td>${c}</td></tr>`);
  html += '</tbody></table>';
  $('size-table').innerHTML = html;
}
$('btn-export-sizes').onclick = ()=>{
  const ws = XLSX.utils.json_to_sheet(Object.entries(SIZE_COUNTS).map(([Size,Count])=>({Size,Count})));
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Vat Sizes');
  XLSX.writeFile(wb, 'vat_sizes_export.csv');
};

/* ================== Details & Print ================== */
function photoDiv(label,src){ return src? `<div><img src="${src}" alt="${label}"></div>`:''; }

async function brochureHTML(rec){
  const logoUrl = await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL().catch(()=>'');

  const pics = await extractPhotos(rec);
  // pick up to 4 photos prioritised
  const chosen = [pics.gateway, pics.vat1cap, pics.agit1, pics.vat2cap, pics.door, pics.rjt].filter(Boolean).slice(0,4);

  return `
  <div class="print-sheet">
    <div class="print-head">
      ${logoUrl? `<img src="${logoUrl}" alt="logo">`:''}
      <div>
        <div class="print-title">Vat Pre-Check – #${rec.dairyNumber}</div>
        <div class="print-sub">Brand: ${rec['other-brand']||'-'} · Spark: ${rec['spark-bars']||'-'} · One NZ: ${rec['one-bars']||'-'}</div>
      </div>
    </div>

    <div class="print-grid">
      <div class="print-card">
        <div class="print-label">Vat 1</div>
        <div>Capacity: <b>${rec['vat1-capacity']||'-'}</b></div>
        <div>Cap: <b>${rec['vat1-cap']||'-'}</b></div>
        <div>Serial: <b>${rec['vat1-serial']||'-'}</b></div>
        <div>Condition: <b>${rec['vat1-condition']||'-'}</b></div>
        <div>Notes: ${rec['vat1-comments']||'-'}</div>
        <div>Cap notes: ${rec['vat1-cap-comments']||'-'}</div>
      </div>
      <div class="print-card">
        <div class="print-label">Vat 2</div>
        <div>Capacity: <b>${rec['vat2-capacity']||'-'}</b></div>
        <div>Cap: <b>${rec['vat2-cap']||'-'}</b></div>
        <div>Serial: <b>${rec['vat2-serial']||'-'}</b></div>
        <div>Condition: <b>${rec['vat2-condition']||'-'}</b></div>
        <div>Notes: ${rec['vat2-comments']||'-'}</div>
        <div>Cap notes: ${rec['vat2-cap-comments']||'-'}</div>
      </div>

      <div class="print-card">
        <div class="print-label">Gateway</div>
        <div>Location: <b>${rec['gateway-location']||'-'}</b></div>
        <div>Comments: ${rec['gateway-comments']||'-'}</div>
      </div>
      <div class="print-card">
        <div class="print-label">Mobile Signal</div>
        <div>Spark: <b>${rec['spark-bars']||'-'}</b></div>
        <div>One NZ: <b>${rec['one-bars']||'-'}</b></div>
      </div>

      <div class="print-card">
        <div class="print-label">Other Telemetry</div>
        <div>Brand: <b>${rec['other-brand']||'-'}</b> · Type: <b>${rec['other-type']||'-'}</b></div>
        <div>Notes: ${rec['other-notes']||'-'}</div>
      </div>
      <div class="print-card">
        <div class="print-label">Rubberware</div>
        <div>Door Seal: <b>${rec['door-delivered']==='yes'?'Delivered':'No'}</b> ${rec.doorDeliveredCount?`(x${rec.doorDeliveredCount})`:''} ${rec['door-size']? '• '+rec['door-size']:''}</div>
        <div>RJT: <b>${rec['rjt-delivered']==='yes'?'Delivered':'No'}</b> ${rec['rjt-size']? '• '+rec['rjt-size']:''}</div>
      </div>
    </div>

    <div class="print-card" style="margin-top:10px">
      <div class="print-label">Photos</div>
      <div class="print-photos">
        ${chosen.map((src,i)=>photoDiv('Photo'+(i+1), src)).join('')}
      </div>
    </div>
  </div>`;
}

window.openDetails = async (dn)=>{
  const rec = await fetchRec(dn);
  if(!rec){ alert('Unable to load record'); return; }
  const html = await brochureHTML(rec);
  $('details-body').innerHTML = html;
  document.getElementById('details-modal').style.display='block';

  // also show existing photos in the form area when you switch to Form and enter same DN
  lastPhotosShown = await extractPhotos(rec);
};
document.getElementById('details-close').onclick = ()=>{ document.getElementById('details-modal').style.display='none'; };

window.openPrint = async (dn)=>{
  const rec = await fetchRec(dn);
  if(!rec){ alert('Unable to load record'); return; }
  const html = await brochureHTML(rec);
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>Print</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"><style>${document.querySelector('style').innerHTML}</style></head><body>${html}</body></html>`);
  w.document.close(); setTimeout(()=>w.print(), 250);
};

/* ================== Admin: Print all / Zip all / Owner Report ================== */
$('btn-print-all').onclick = async ()=>{
  if (!CLOUD_KEYS.length){ alert('Load the cloud list first.'); return; }
  const list = CLOUD_KEYS.slice(0);
  const w = window.open('', '_blank');
  const css = document.querySelector('style').innerHTML;
  w.document.write(`<html><head><title>All Brochures</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"><style>${css}</style></head><body>`);
  for (const key of list){
    const dn = key.replace('.json','');
    const rec = await fetchRec(dn); if(!rec) continue;
    const html = await brochureHTML(rec);
    w.document.body.insertAdjacentHTML('beforeend', html + '<hr style="page-break-after:always;border:none;margin:20px 0;">');
  }
  w.document.close(); setTimeout(()=>w.print(), 600);
};

$('btn-zip-all').onclick = async ()=>{
  if (!CLOUD_KEYS.length){ alert('Load the cloud list first.'); return; }
  const zip = new JSZip();
  for (const key of CLOUD_KEYS){
    const dn = key.replace('.json','');
    const rec = await fetchRec(dn); if(!rec) continue;
    const html = await brochureHTML(rec);
    zip.file(`brochure_${dn}.html`, `<!doctype html><meta charset="utf-8"><title>Vat #${dn}</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"><style>${document.querySelector('style').innerHTML}</style>${html}`);
  }
  const blob = await zip.generateAsync({type:"blob"});
  saveAs(blob, 'all_brochures.zip');
};

$('btn-owner-report').onclick = async ()=>{
  if (!CLOUD_KEYS.length){ alert('Load the cloud list first.'); return; }
  const rows = [];
  for (const key of CLOUD_KEYS){
    const dn = key.replace('.json','');
    const rec = await fetchRec(dn); if(!rec) continue;
    rows.push(
      {Dairy:dn,Vat:'1',Size:rec['vat1-capacity']||'',Serial:rec['vat1-serial']||'',Cap:rec['vat1-cap']||'',Condition:rec['vat1-condition']||'',Door:(rec['door-delivered']==='yes')? (rec['door-size']||'unspecified') : '',RJTD:(rec['rjt-delivered']==='yes')?(rec['rjt-size']||'unspecified'):''},
      ...(rec['vat2-capacity']? [{Dairy:dn,Vat:'2',Size:rec['vat2-capacity']||'',Serial:rec['vat2-serial']||'',Cap:rec['vat2-cap']||'',Condition:rec['vat2-condition']||'',Door:(rec['door-delivered']==='yes')? (rec['door-size']||'unspecified') : '',RJTD:(rec['rjt-delivered']==='yes')?(rec['rjt-size']||'unspecified'):''}] : [])
    );
  }
  const w = window.open('', '_blank');
  const table = `
    <div class="print-sheet">
      <div class="print-head"><div class="print-title">Owner Report – All Farms</div></div>
      <table class="table table-sm table-bordered">
        <thead><tr><th>Dairy</th><th>Vat</th><th>Size</th><th>Serial</th><th>Cap</th><th>Cond</th><th>Door Seal</th><th>RJT</th></tr></thead>
        <tbody>
          ${rows.map(r=>`<tr><td>${r.Dairy}</td><td>${r.Vat}</td><td>${r.Size}</td><td>${r.Serial}</td><td>${r.Cap}</td><td>${r.Condition}</td><td>${r.Door}</td><td>${r.RJTD}</td></tr>`).join('')}
        </tbody>
      </table>
    </div>`;
  w.document.write(`<html><head><title>Owner Report</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"><style>${document.querySelector('style').innerHTML}</style></head><body>${table}</body></html>`);
  w.document.close(); setTimeout(()=>w.print(), 300);
};

/* ================== Form: auto-fill + save; show photos in form (read-only) ================== */
let lastPhotosShown = null;

$('dairyNumber').addEventListener('blur', async ()=>{
  const dn = nstr($('dairyNumber').value);
  if(!dn) return;
  const rec = await fetchRec(dn);
  if(!rec){ alert('Not found in cloud.'); return; }
  fillForm(rec);
  lastPhotosShown = await extractPhotos(rec);
  const imgs = Object.values(lastPhotosShown).filter(Boolean);
  if (imgs.length){
    $('form-photo-grid').innerHTML = imgs.slice(0,4).map((src,i)=>`<div><img src="${src}" style="width:100%;border-radius:10px;border:1px solid #e5e7eb;max-height:180px;object-fit:cover"></div>`).join('');
    show('form-photos');
  } else {
    $('form-photo-grid').innerHTML = '';
    hide('form-photos');
  }
});

function fillForm(rec){
  const set=(id,v)=>{$(id).value = v||''}
  set('gateway-location',rec['gateway-location']);
  set('gateway-comments',rec['gateway-comments']);
  set('vat1-capacity',rec['vat1-capacity']);
  set('vat1-serial',rec['vat1-serial']);
  set('vat1-cap', (rec['vat1-cap']||'AVAILABLE').toLowerCase());
  set('vat1-condition', (rec['vat1-condition']||'ok').toLowerCase());
  set('vat1-comments',rec['vat1-comments']);
  set('vat1-cap-comments',rec['vat1-cap-comments']);
  set('vat2-capacity',rec['vat2-capacity']);
  set('vat2-serial',rec['vat2-serial']);
  set('vat2-cap', (rec['vat2-cap']||'na').toLowerCase());
  set('vat2-condition',(rec['vat2-condition']||'ok').toLowerCase());
  set('vat2-comments',rec['vat2-comments']);
  set('vat2-cap-comments',rec['vat2-cap-comments']);
  set('spark-bars',rec['spark-bars']);
  set('one-bars',rec['one-bars']);
  set('other-brand',rec['other-brand']);
  set('other-type',rec['other-type']);
  set('other-notes',rec['other-notes']);
  set('door-delivered',rec['door-delivered']==='yes'?'yes':'no');
  set('door-size',rec['door-size']);
  set('rjt-delivered',rec['rjt-delivered']==='yes'?'yes':'no');
  set('rjt-size',rec['rjt-size']);
}

$('btn-save').onclick = async ()=>{
  const dn = nstr($('dairyNumber').value); if(!dn){ alert('Enter a dairy number'); return; }
  const data = {
    dairyNumber: dn,
    'gateway-location': $('gateway-location').value,
    'gateway-comments': $('gateway-comments').value,
    'vat1-capacity': $('vat1-capacity').value,
    'vat1-serial': $('vat1-serial').value,
    'vat1-cap': $('vat1-cap').value,
    'vat1-condition': $('vat1-condition').value,
    'vat1-comments': $('vat1-comments').value,
    'vat1-cap-comments': $('vat1-cap-comments').value,
    'vat2-capacity': $('vat2-capacity').value,
    'vat2-serial': $('vat2-serial').value,
    'vat2-cap': $('vat2-cap').value,
    'vat2-condition': $('vat2-condition').value,
    'vat2-comments': $('vat2-comments').value,
    'vat2-cap-comments': $('vat2-cap-comments').value,
    'spark-bars': $('spark-bars').value,
    'one-bars': $('one-bars').value,
    'other-brand': $('other-brand').value,
    'other-type': $('other-type').value,
    'other-notes': $('other-notes').value,
    'door-delivered': $('door-delivered').value,
    'door-size': $('door-size').value,
    'rjt-delivered': $('rjt-delivered').value,
    'rjt-size': $('rjt-size').value,
    timestamp: Date.now()
  };
  $('save-msg').textContent = 'Saving…';
  try{
    const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
    await storage.ref(`${FOLDER}/${dn}.json`).put(blob);
    $('save-msg').textContent = 'Saved to cloud.';
  }catch(e){ $('save-msg').textContent = 'Save failed (offline?). Will retry when online.' }
};
$('btn-print-current').onclick = async ()=>{
  const dn = nstr($('dairyNumber').value);
  if(!dn){ alert('Enter a dairy number'); return; }
  const rec = await fetchRec(dn);
  if(!rec){ alert('Save or ensure the farm exists.'); return; }
  const html = await brochureHTML(rec);
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>Print</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"><style>${document.querySelector('style').innerHTML}</style></head><body>${html}</body></html>`);
  w.document.close(); setTimeout(()=>w.print(), 250);
};

/* ================== Boot ================== */
window.addEventListener('DOMContentLoaded', async ()=>{
  await listCloud();
  streamForKpisAndSizes(true);
});
</script>
</body>
</html>