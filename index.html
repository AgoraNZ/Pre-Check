<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agora Vat Pre Check — AI Sample Export</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root{ --accent:#FF851B; --primary:#001F3F; }
  body{ background:#f8faff; font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif; color:#001F3F; }
  .wrap{ max-width:860px; margin:32px auto; background:#fff; border-radius:16px; padding:22px; box-shadow:0 2px 32px #001F3F11; }
  h1{ font-size:1.6rem; color:var(--accent); margin-bottom:4px; text-align:center; }
  .lead{ text-align:center; color:#6b7280; margin-bottom:18px; }
  .btn-agora{ background:var(--accent); color:#fff; border:none; border-radius:10px; padding:.65rem 1rem; font-weight:600; }
  .btn-agora:hover{ background:#ff6d00; }
  .btn-alt{ background:#fff; color:var(--primary); border:1px solid var(--accent); border-radius:10px; padding:.55rem .9rem; font-weight:600; }
  .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
  .card{ border:1px solid #eee; border-radius:12px; padding:14px; background:#fff; }
  .status{ min-height:22px; color:#6b7280; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.92rem; }
  .small{ font-size:.9rem; color:#6b7280; }
  .badge-ok{ background:#e8f5e9; color:#1b5e20; border-radius:8px; padding:.2rem .5rem; font-weight:700; }
  .badge-warn{ background:#ffebee; color:#b71c1c; border-radius:8px; padding:.2rem .5rem; font-weight:700; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Agora Vat Pre Check — AI Sample Export</h1>
  <div class="lead">Exports real records (without photos) from <span class="mono">Pre Check/</span> for AI rule tuning.</div>

  <div class="grid">
    <!-- Firebase Config (pre-filled to match your app) -->
    <div class="card">
      <div class="fw-bold mb-1">Firebase config</div>
      <div class="small mb-2">These are copied from your app so you shouldn’t need to change anything.</div>
      <div class="row g-2">
        <div class="col-md-6"><label class="form-label small">apiKey</label><input id="apiKey" class="form-control" value="AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI"></div>
        <div class="col-md-6"><label class="form-label small">authDomain</label><input id="authDomain" class="form-control" value="dairy-farm-record-system.firebaseapp.com"></div>
        <div class="col-md-6"><label class="form-label small">projectId</label><input id="projectId" class="form-control" value="dairy-farm-record-system"></div>
        <div class="col-md-6"><label class="form-label small">storageBucket</label><input id="storageBucket" class="form-control" value="dairy-farm-record-system.appspot.com"></div>
        <div class="col-md-6"><label class="form-label small">messagingSenderId</label><input id="messagingSenderId" class="form-control" value="422124188212"></div>
        <div class="col-md-6"><label class="form-label small">appId</label><input id="appId" class="form-control" value="1:422124188212:web:1bd31bee8d6e91e301d061"></div>
      </div>
      <div class="small mt-2">Path: <span class="mono">Pre Check/</span></div>
    </div>

    <!-- Quick export -->
    <div class="card">
      <div class="fw-bold mb-1">Option A — Quick sample</div>
      <div class="small mb-2">Pulls the first N JSON files from <span class="mono">Pre Check/</span>, removes any <span class="mono">*-photo-base64</span> fields, and downloads a single JSON.</div>
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label small">Max records</label>
          <input id="maxCount" type="number" class="form-control" value="60" min="1" max="500">
        </div>
        <div class="col-md-9">
          <button id="btnExport" class="btn-agora w-100">Export sample for AI</button>
        </div>
      </div>
      <div id="statusA" class="status mt-2"></div>
    </div>

    <!-- Targeted export -->
    <div class="card">
      <div class="fw-bold mb-1">Option B — Specific Dairy Numbers</div>
      <div class="small mb-2">Paste one Dairy Number per line to export exactly those records.</div>
      <textarea id="dairyList" rows="5" class="form-control mono" placeholder="e.g.\n12345\n67890"></textarea>
      <div class="d-flex gap-2 mt-2">
        <button id="btnExportList" class="btn-alt">Export selected Dairy Numbers</button>
        <button id="btnClearList" class="btn-alt">Clear</button>
      </div>
      <div id="statusB" class="status mt-2"></div>
    </div>

    <!-- Notes -->
    <div class="card">
      <div class="fw-bold mb-1">What’s included</div>
      <ul class="small mb-0">
        <li><span class="badge-ok">Yes</span> All key fields (caps, conditions, comments, serials, etc.)</li>
        <li><span class="badge-warn">No</span> Image data: any <span class="mono">*-photo-base64</span> fields are removed to keep files small</li>
        <li>We also add <span class="mono">__file</span> (original JSON name) and small boolean hints like <span class="mono">__hints.hasChillerAttention</span> to help me tune rules faster.</li>
      </ul>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

<script>
const byId = id => document.getElementById(id);
let appInit = false, storage = null;

function getConfigFromInputs(){
  return {
    apiKey: byId('apiKey').value.trim(),
    authDomain: byId('authDomain').value.trim(),
    projectId: byId('projectId').value.trim(),
    storageBucket: byId('storageBucket').value.trim(),
    messagingSenderId: byId('messagingSenderId').value.trim(),
    appId: byId('appId').value.trim()
  };
}
function ensureFirebase(){
  if(appInit) return;
  const cfg = getConfigFromInputs();
  firebase.initializeApp(cfg);
  storage = firebase.storage();
  appInit = true;
}

function scrubRecord(rec){
  const clean = {...rec};
  // drop any base64 photo fields
  Object.keys(clean).forEach(k=>{ if(k.endsWith('photo-base64')) delete clean[k]; });
  // add simple derived flags
  clean.__hints = {
    hasVat1CapUnavailable: (clean['vat1-cap']||'').toLowerCase()==='unavailable',
    hasVat2CapUnavailable: (clean['vat2-cap']||'').toLowerCase()==='unavailable',
    hasChillerAttention: (clean['chiller-condition']||'')==='attention',
    hasVatAttention: (clean['vat1-condition']==='attention'||clean['vat2-condition']==='attention')
  };
  return clean;
}

async function listAllInFolder(folderPath){
  // NOTE: Firebase Storage listAll() may return at most 1000 items per call; good for our use.
  const folderRef = storage.ref(folderPath);
  const res = await folderRef.listAll();
  return res.items || [];
}

async function downloadJSONFile(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ a.remove(); URL.revokeObjectURL(url); }, 400);
}

/* ========== Option A ========== */
byId('btnExport').addEventListener('click', async ()=>{
  ensureFirebase();
  const status = byId('statusA');
  const maxCount = Math.max(1, Math.min(500, Number(byId('maxCount').value||60)));
  const folder = 'Pre Check';

  byId('btnExport').disabled = true;
  status.textContent = 'Listing files…';

  try{
    const items = await listAllInFolder(folder);
    if(!items.length){ status.textContent = 'No files found in "Pre Check/".'; byId('btnExport').disabled=false; return; }

    const slice = items.slice(0, maxCount);
    const out = [];
    let n = 0;
    for(const ref of slice){
      try{
        status.textContent = `Fetching ${++n}/${slice.length}: ${ref.name}`;
        const url = await ref.getDownloadURL();
        const rec = await fetch(url).then(r=>r.json());
        const cleaned = scrubRecord(rec);
        cleaned.__file = ref.name;
        out.push(cleaned);
      }catch(e){
        // continue on individual fetch errors
      }
    }
    const bundle = { created: new Date().toISOString(), count: out.length, sourceFolder: folder, rows: out };
    await downloadJSONFile('vat_precheck_ai_sample.json', bundle);
    status.textContent = `Done. Exported ${out.length} record(s).`;
  }catch(err){
    console.error(err);
    status.textContent = 'Error: could not list or read from Firebase Storage. Check rules/permissions.';
  }finally{
    byId('btnExport').disabled = false;
  }
});

/* ========== Option B ========== */
byId('btnExportList').addEventListener('click', async ()=>{
  ensureFirebase();
  const status = byId('statusB');
  const listRaw = byId('dairyList').value.trim();
  if(!listRaw){ status.textContent='Paste one Dairy Number per line first.'; return; }
  const dairies = [...new Set(listRaw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean))];
  const folder = 'Pre Check';

  status.textContent = `Fetching ${dairies.length} record(s)…`;
  byId('btnExportList').disabled = true;

  const out = [];
  let done = 0;
  for(const dn of dairies){
    try{
      const ref = storage.ref(`${folder}/${dn}.json`);
      const url = await ref.getDownloadURL();
      const rec = await fetch(url).then(r=>r.json());
      const cleaned = scrubRecord(rec);
      cleaned.__file = `${dn}.json`;
      out.push(cleaned);
      status.textContent = `Fetched ${++done}/${dairies.length} (${dn})`;
    }catch(e){
      status.textContent = `Missed: ${dn} (not found or access denied). Continuing…`;
    }
  }
  const bundle = { created: new Date().toISOString(), count: out.length, requested: dairies, sourceFolder: folder, rows: out };
  await downloadJSONFile('vat_precheck_ai_selected.json', bundle);
  status.textContent = `Done. Exported ${out.length}/${dairies.length} requested record(s).`;
  byId('btnExportList').disabled = false;
});

byId('btnClearList').addEventListener('click', ()=>{ byId('dairyList').value=''; byId('statusB').textContent=''; });
</script>
</body>
</html>