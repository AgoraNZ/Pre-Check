<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Agora Vat Pre-Check v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.3/dexie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<style>
  :root{
    --bg:#f8faff; --ink:#001F3F; --accent:#FF851B; --muted:#6b7a90;
    --ok:#2ECC40; --warn:#FF4136; --info:#1E88E5; --card:#ffffff; --ring:#edf1f7;
    --maxw:1100px; --radius:14px; --shadow:0 2px 28px rgba(0,0,0,.06);
  }
  body{background:var(--bg); color:var(--ink); font-family:system-ui, Segoe UI, Arial, sans-serif;}
  .shell{max-width:var(--maxw); margin:28px auto 60px; background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px;}
  .brand{display:block; margin:0 auto 6px; max-width:200px}
  h1{font-size:1.8rem; color:var(--accent); text-align:center; margin:6px 0 14px}
  h2.section{font-size:1.2rem; color:var(--ink); margin:18px 0 6px}
  .sub{font-size:.92rem; color:var(--muted)}
  .btn-ag{background:var(--accent); color:#fff; border:none; font-weight:600; border-radius:8px}
  .btn-ag:hover{opacity:.9}
  .btn-outline{background:#fff;border:1px solid var(--accent);color:var(--ink);border-radius:8px}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
  .cardy{border:1px solid var(--ring); border-radius:12px; padding:12px; background:#fff}
  .chips{display:flex; gap:6px; flex-wrap:wrap}
  .chip{border:1px solid var(--ring); border-radius:999px; padding:2px 8px; font-size:.86rem}
  .chip.ok{background:#e8f7ee; border-color:#c7edd4}
  .chip.bad{background:#ffeaea; border-color:#ffd0d0}
  .chip.info{background:#eaf2ff; border-color:#cfe0ff}
  .img-thumb{width:86px; height:86px; object-fit:cover; border-radius:8px; border:1px solid #eee}
  .kv{display:grid; grid-template-columns:130px 1fr; gap:8px; align-items:center}
  .table-wrap{overflow-x:auto}
  .kpi{border:1px solid var(--ring); border-radius:12px; padding:10px; text-align:center}
  .kpi .n{font-weight:800; font-size:1.3rem}
  .kpi .l{font-size:.9rem; color:var(--muted)}
  .badge-status{border-radius:8px; padding:2px 8px; font-weight:700}
  .b-ok{background:#e8f7ee; color:#117a2a}
  .b-warn{background:#ffeaea; color:#a11}
  .b-sla{background:#fff7e6; color:#a45a00}
  .admin-only{display:none}
  .sticky-filters{position:sticky; top:10px; z-index:20; background:#fff; padding:10px; border:1px solid var(--ring); border-radius:12px}
  .photo-inline{display:flex; gap:8px; flex-wrap:wrap}
  .small{font-size:.92rem}
  footer{text-align:center; color:#96a2b7; font-size:.85rem; margin-top:16px}
  @media (max-width:900px){ .grid-2,.grid-3{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="shell" id="app">
  <img id="logo" class="brand" style="display:none">
  <h1>Agora Vat Pre-Check</h1>

  <!-- ROLE SWITCH (set to 'admin' to reveal admin screen) -->
  <script>window.AGORA_ROLE = 'service'; /* 'service' | 'admin' */</script>

  <!-- NAV -->
  <div class="d-flex gap-2 justify-content-center mb-2">
    <button class="btn btn-outline" id="btn-form">Form</button>
    <button class="btn btn-outline" id="btn-summary">Summary</button>
    <button class="btn btn-outline admin-only" id="btn-admin">Admin</button>
  </div>

  <!-- ========== FORM ========== -->
  <div id="page-form">
    <div class="cardy">
      <div class="grid-3">
        <div>
          <label class="form-label">Dairy Number</label>
          <input class="form-control" id="dairyNumber" name="dairyNumber" required>
        </div>
        <div>
          <label class="form-label">Current Telemetry (brand)</label>
          <input class="form-control" id="current-telemetry" name="current-telemetry" placeholder="Levno / Halo / None">
        </div>
        <div>
          <label class="form-label">Telemetry Comments</label>
          <input class="form-control" id="telemetry-comments" name="telemetry-comments">
        </div>
      </div>
    </div>

    <!-- VATS FIRST -->
    <h2 class="section">Vat 1</h2>
    <div class="cardy grid-3">
      <div><label class="form-label">Cap</label>
        <select class="form-select" id="vat1-cap" name="vat1-cap">
          <option value="available">Available ✓</option>
          <option value="unavailable">Unavailable ✗</option>
        </select>
        <input class="form-control mt-1" id="vat1-cap-comments" name="vat1-cap-comments" placeholder="Comments"/>
        <input type="file" id="vat1-cap-photo" accept="image/*" class="form-control mt-1">
      </div>
      <div><label class="form-label">Capacity (L)</label>
        <input class="form-control" id="vat1-capacity" name="vat1-capacity">
        <input class="form-control mt-1" id="vat1-comments" name="vat1-comments" placeholder="Interior width etc."/>
      </div>
      <div>
        <label class="form-label">Condition</label>
        <select class="form-select" id="vat1-condition" name="vat1-condition">
          <option value="ok">OK</option>
          <option value="attention">Attention Required</option>
        </select>
        <input class="form-control mt-1" id="vat1-condition-comments" name="vat1-condition-comments" placeholder="Condition notes"/>
        <input type="file" id="vat1-condition-photo" accept="image/*" class="form-control mt-1">
      </div>
      <div>
        <label class="form-label">Serial</label>
        <input class="form-control" id="vat1-serial" name="vat1-serial">
      </div>
    </div>

    <h2 class="section">Vat 2</h2>
    <div class="sub">NA options added for *level* and *condition*.</div>
    <div class="cardy grid-3">
      <div><label class="form-label">Cap</label>
        <select class="form-select" id="vat2-cap" name="vat2-cap">
          <option value="na">N/A</option>
          <option value="available">Available ✓</option>
          <option value="unavailable">Unavailable ✗</option>
        </select>
        <input class="form-control mt-1" id="vat2-cap-comments" name="vat2-cap-comments" placeholder="Comments"/>
        <input type="file" id="vat2-cap-photo" accept="image/*" class="form-control mt-1">
      </div>
      <div><label class="form-label">Capacity (L)</label>
        <input class="form-control" id="vat2-capacity" name="vat2-capacity" placeholder="or NA">
        <input class="form-control mt-1" id="vat2-comments" name="vat2-comments" placeholder="Interior width etc."/>
      </div>
      <div>
        <label class="form-label">Condition</label>
        <select class="form-select" id="vat2-condition" name="vat2-condition">
          <option value="na">N/A</option>
          <option value="ok">OK</option>
          <option value="attention">Attention Required</option>
        </select>
        <input class="form-control mt-1" id="vat2-condition-comments" name="vat2-condition-comments" placeholder="Condition notes"/>
        <input type="file" id="vat2-condition-photo" accept="image/*" class="form-control mt-1">
      </div>
      <div>
        <label class="form-label">Serial</label>
        <input class="form-control" id="vat2-serial" name="vat2-serial">
      </div>
    </div>

    <!-- AGITATOR → GATEWAY → OTHER -->
    <h2 class="section">Agitator</h2>
    <div class="cardy grid-3">
      <div>
        <label class="form-label">Sensor Location</label>
        <input class="form-control" id="agitator-location" name="agitator-location">
      </div>
      <div>
        <label class="form-label">Comments</label>
        <input class="form-control" id="agitator-comments" name="agitator-comments">
      </div>
      <div>
        <label class="form-label">Photo</label>
        <input type="file" id="agitator-photo" accept="image/*" class="form-control">
      </div>
    </div>

    <h2 class="section">Gateway (Power/Signal)</h2>
    <div class="cardy grid-3">
      <div>
        <label class="form-label">Location</label>
        <input class="form-control" id="gateway-location" name="gateway-location">
      </div>
      <div>
        <label class="form-label">Comments</label>
        <input class="form-control" id="gateway-comments" name="gateway-comments" placeholder="Bars/Carrier/Power point needs">
      </div>
      <div>
        <label class="form-label">Photo</label>
        <input type="file" id="gateway-photo" accept="image/*" class="form-control">
      </div>
    </div>

    <h2 class="section">Rubberware</h2>
    <div class="sub">Door seals & RJT step seals. Door-seal size captured. Delivered count auto-multiplies by number of vats.</div>
    <div class="cardy grid-3">
      <div>
        <label class="form-label">Vat Door Seal</label>
        <select class="form-select" id="vat-door-seal" name="vat-door-seal">
          <option value="notdelivered">Not Delivered</option>
          <option value="delivered">Delivered</option>
        </select>
        <select class="form-select mt-1" id="vat-door-seal-size" name="vat-door-seal-size">
          <option value="">Size (if delivered)</option>
          <option value="Small">Small</option>
          <option value="Large">Large</option>
        </select>
        <input class="form-control mt-1" id="vat-door-seal-comments" name="vat-door-seal-comments" placeholder="Notes">
        <input type="file" id="vat-door-seal-photo" accept="image/*" class="form-control mt-1">
      </div>
      <div>
        <label class="form-label">RJT Step Seal</label>
        <select class="form-select" id="rjt-seal" name="rjt-seal">
          <option value="notdelivered">Not Delivered</option>
          <option value="delivered">Delivered</option>
        </select>
        <select class="form-select mt-1" id="rjt-seal-size" name="rjt-seal-size">
          <option value="">Select Size</option>
          <option value="Small">Small</option>
          <option value="Large">Large</option>
        </select>
        <input class="form-control mt-1" id="rjt-seal-comments" name="rjt-seal-comments" placeholder="Notes">
        <input type="file" id="rjt-seal-photo" accept="image/*" class="form-control mt-1">
      </div>
      <div>
        <label class="form-label">Chiller Condition</label>
        <select class="form-select" id="chiller-condition" name="chiller-condition">
          <option value="ok">OK</option>
          <option value="attention">Attention Required</option>
        </select>
        <input class="form-control mt-1" id="chiller-condition-comments" name="chiller-condition-comments" placeholder="Notes">
        <input type="file" id="chiller-condition-photo" accept="image/*" class="form-control mt-1">
      </div>
    </div>

    <!-- ACTIONS -->
    <div class="d-flex gap-2 mt-3">
      <button class="btn btn-ag" id="btn-save">Save</button>
      <button class="btn btn-outline" id="btn-view">View Summary</button>
    </div>
  </div>

  <!-- ========== SUMMARY (Cards + KPIs) ========== -->
  <div id="page-summary" style="display:none">
    <div class="grid-3 mb-2">
      <div class="kpi"><div class="n" id="kpi-total">0</div><div class="l">Total Farms</div></div>
      <div class="kpi"><div class="n" id="kpi-ready">0</div><div class="l">Install-Ready</div></div>
      <div class="kpi"><div class="n" id="kpi-cap-missing">0</div><div class="l">Cap Unavailable</div></div>
    </div>

    <div class="grid-2">
      <div class="sticky-filters">
        <div class="fw-bold mb-2">Filters</div>
        <input class="form-control mb-2" id="filter-search" placeholder="Search Dairy # / Serial / Telemetry">
        <select class="form-select mb-2" id="filter-ready">
          <option value="">Any readiness</option>
          <option value="ready">Install-ready</option>
          <option value="notready">Needs work</option>
        </select>
        <select class="form-select mb-2" id="filter-cap">
          <option value="">Any cap</option>
          <option value="unavailable">Cap unavailable</option>
          <option value="available">Cap available</option>
        </select>
        <select class="form-select mb-2" id="filter-tele">
          <option value="">Any telemetry</option>
          <option value="Levno">Levno</option>
          <option value="Halo">Halo</option>
          <option value="None">None</option>
        </select>
        <button class="btn btn-ag w-100" id="btn-apply">Apply</button>
      </div>

      <div>
        <div id="cards"></div>
      </div>
    </div>

    <div class="grid-2 mt-3">
      <div class="cardy">
        <div class="fw-bold">By Telemetry</div>
        <canvas id="chartTele" height="160"></canvas>
      </div>
      <div class="cardy">
        <div class="fw-bold">Caps Availability</div>
        <canvas id="chartCap" height="160"></canvas>
      </div>
    </div>
  </div>

  <!-- ========== ADMIN (exports only) ========== -->
  <div id="page-admin" style="display:none">
    <div class="cardy">
      <div class="fw-bold mb-2">Exports</div>
      <div class="small mb-2">Admin-only screen, as requested. Photos are excluded; door-seal counts include “2 delivered” when two vats are present.</div>
      <button class="btn btn-ag me-2" id="btn-csv">Export CSV</button>
      <button class="btn btn-outline" id="btn-xlsx">Export XLSX</button>
    </div>
  </div>

  <footer class="mt-3">Agora Vat Pre-Check v2 • UI + AI normaliser refresh (Aug 2025)</footer>
</div>

<script>
/* ============= CONFIG ============= */
const FB = {
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(FB);
const storage = firebase.storage();
const FOLDER = "Pre Check";
const db = new Dexie("VatPreCheckV2");
db.version(1).stores({ forms: "++id,dairyNumber" });

/* ============= LIGHT “AI” NORMALISER ============= */
const NORM = {
  // simple exact/smart replacements (lowercased match)
  replace:[
    [/tru[\s\-]?test/g,"Tru-Test"],
    [/\bd\.?t\.?s\b/gi,"DTS"],
    [/\bdts\b/gi,"DTS"],
    [/\bhalo\b/gi,"Halo"],
    [/\blevno\b/gi,"Levno"],
    [/\bgrey\b/gi,"gray"], // unify spelling
    [/\b4\s*g\b/gi,"4G"],
    [/\b5\s*g\b/gi,"5G"],
    [/power[\s\-]?point|powerpoint|plug(?!ged)/gi,"power outlet"],
  ],
  teleMap(v){ v=(v||"").toLowerCase();
    if(v.includes("levno")) return "Levno";
    if(v.includes("halo")) return "Halo";
    if(v.includes("none")||v.trim()==="") return "None";
    return v ? v.replace(/^\w/,c=>c.toUpperCase()) : "";
  },
  capStatus(v){ v=(v||"").toLowerCase(); if(v.includes("unavail")) return "unavailable"; if(v.includes("avail")) return "available"; if(v.includes("na")) return "na"; return v||""; },
  condition(v){ v=(v||"").toLowerCase(); if(v.includes("att")) return "attention"; if(v.includes("ok")) return "ok"; if(v.includes("na")) return "na"; return v||""; },
  clean(s){ let t=String(s||""); NORM.replace.forEach(([re,to])=>t=t.replace(re,to)); return t.trim(); }
};
function