<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Agora Vat Pre-Check</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">

<style>
:root{--brand:#001F3F;--accent:#FF851B;--muted:#6b7280;--bg:#f7f8fb;--ink:#0f172a}
html,body{background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
.app{max-width:1180px;margin:28px auto;padding:0 16px}

.brand-header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
.brand-logo{width:160px;height:auto;display:none}
.brand-title h1{margin:0;font-weight:800;color:var(--brand)}
.brand-sub{color:var(--muted)}

.top-tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 18px}
.tab-btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:10px 14px;font-weight:700}
.tab-btn.active{border-color:var(--accent);box-shadow:0 0 0 3px #ff851b2b}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff}
.progress{height:10px}

.bar{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin:10px 0}
.section-title{font-weight:800;margin:6px 0 10px}
.small{color:#6b7280}

.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px;cursor:pointer}
.kpi .num{font-size:1.4rem;font-weight:800}
.kpi .label{color:#6b7280}

.list{display:grid;grid-template-columns:1fr;gap:10px}
.row-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px}
.row-flex{display:flex;gap:10px;justify-content:space-between;align-items:center}
.badge-soft{border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:.8rem}

.form-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin-bottom:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:900px){.grid-3{grid-template-columns:1fr}}
label.form-label{font-weight:600}
.photo-thumb{width:110px;height:86px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;margin-top:6px}
.sticky-actions{position:sticky;bottom:8px;display:flex;gap:8px;flex-wrap:wrap}
.btn-brand{background:var(--accent);border:none;color:#fff;font-weight:800}
.btn-brand:hover{background:#ff6d00}
.btn-outline-brand{border:1px solid var(--accent);color:var(--accent);background:#fff}
.btn-outline-brand:hover{background:var(--accent);color:#fff}
.hidden{display:none!important}
.footer{color:#6b7280;text-align:center;margin:22px 0 10px}

/* brochure */
.print-sheet{max-width:900px;margin:0 auto;color:#0f172a}
.print-head{display:flex;align-items:center;gap:16px;border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:10px}
.print-head img{height:44px}
.print-title{font-weight:800;font-size:1.2rem}
.print-sub{color:#6b7280}
.print-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.print-card{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.print-label{font-weight:700;margin-bottom:6px}
.print-photos img{width:100%;max-height:180px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;margin-bottom:8px}
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="brand-header">
    <img id="logo" class="brand-logo" alt="Agora Logo">
    <div class="brand-title">
      <h1>Agora Vat Pre-Check</h1>
      <div class="brand-sub">Fast field capture • Smart summary • Customer-ready output</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="top-tabs">
    <button id="tab-summary" class="tab-btn active">Summary</button>
    <button id="tab-form" class="tab-btn">Form</button>
    <button id="tab-admin" class="tab-btn">Admin</button>

    <div class="ms-auto controls">
      <span class="pill"><span class="small">Cloud</span><b id="cloud-count">–</b></span>
      <span class="pill"><span class="small">Loaded</span><b id="loaded-count">0</b></span>
      <div class="progress" style="width:180px"><div id="load-bar" class="progress-bar" style="width:0%"></div></div>
      <span id="load-pct" class="small">0%</span>
    </div>
  </div>

  <!-- SUMMARY -->
  <div id="view-summary">
    <div class="bar">
      <div class="section-title">Overview</div>
      <div class="kpi-grid">
        <div class="kpi" data-kpi="dts"><div class="num" id="kpi-dts">0</div><div class="label">DTS Vent Caps</div></div>
        <div class="kpi" data-kpi="power"><div class="num" id="kpi-power">0</div><div class="label">Farms needing power point</div></div>
        <div class="kpi" data-kpi="rubber"><div class="num" id="kpi-rubber">0</div><div class="label">Rubberware deliveries</div></div>
      </div>
    </div>

    <div class="bar">
      <div class="section-title mb-2">Results</div>
      <div class="d-flex gap-2 flex-wrap mb-2">
        <input id="search" class="form-control" style="max-width:360px" placeholder="Search dairy #…">
        <button id="btn-clear" class="btn btn-outline-secondary">Clear</button>
        <div class="ms-auto d-flex gap-2">
          <button id="btn-print-all" class="btn btn-brand">Print All Brochures</button>
          <button id="btn-zip-all" class="btn btn-outline-brand">Download All Brochures (ZIP)</button>
        </div>
      </div>
      <div id="result-list" class="list"></div>
    </div>

    <div class="bar">
      <div class="section-title">Vat Size Breakdown (live from cloud)</div>
      <div id="size-table" class="small">Starting…</div>
      <button id="btn-export-sizes" class="btn btn-outline-brand mt-2">Export Sizes CSV</button>
    </div>
  </div>

  <!-- FORM -->
  <div id="view-form" class="hidden">
    <div class="form-card">
      <div class="grid-3">
        <div>
          <label class="form-label">Dairy Number</label>
          <input class="form-control" id="dairyNumber" placeholder="e.g. 7031">
          <div class="small">Blur to auto-load from cloud (photos too, if embedded).</div>
        </div>
        <div>
          <label class="form-label">Gateway Location</label>
          <input class="form-control" id="gateway-location">
        </div>
        <div>
          <label class="form-label">Gateway Photo</label>
          <input id="gateway-photo" type="file" accept="image/*" class="form-control">
          <img id="gateway-preview" class="photo-thumb d-none" alt="">
        </div>
      </div>
    </div>

    <div class="form-card">
      <h6 class="mb-2">Vat 1</h6>
      <div class="grid-3">
        <div><label class="form-label">Capacity (L)</label><input class="form-control" id="vat1-capacity"></div>
        <div>
          <label class="form-label">Cap</label>
          <select class="form-select" id="vat1-cap">
            <option value="available">Available ✓</option>
            <option value="unavailable">Unavailable ✗</option>
          </select>
        </div>
        <div>
          <label class="form-label">Cap Photo</label>
          <input id="vat1-cap-photo" type="file" accept="image/*" class="form-control">
          <img id="vat1-cap-preview" class="photo-thumb d-none" alt="">
        </div>

        <div><label class="form-label">Serial</label><input class="form-control" id="vat1-serial"></div>
        <div><label class="form-label">Condition</label><select class="form-select" id="vat1-condition"><option value="ok">OK</option><option value="attention">Attention</option></select></div>
        <div><label class="form-label">Condition Comments</label><input class="form-control" id="vat1-condition-comments"></div>

        <div class="col-12"><label class="form-label">Comments</label><input class="form-control" id="vat1-comments"></div>
        <div><label class="form-label">Agitator Location</label><input class="form-control" id="agitator1-location"></div>
        <div>
          <label class="form-label">Agitator Photo</label>
          <input id="agitator1-photo" type="file" accept="image/*" class="form-control">
          <img id="agitator1-preview" class="photo-thumb d-none" alt="">
        </div>
      </div>
    </div>

    <div class="form-card">
      <h6 class="mb-2">Vat 2 – Capacity</h6>
      <div class="grid-3">
        <div><label class="form-label">Capacity (L)</label><input class="form-control" id="vat2-capacity" placeholder="leave blank if N/A"><div class="small">Entering a value reveals Vat-2 details</div></div>
      </div>
    </div>

    <div class="form-card hidden" id="vat2-extra">
      <h6 class="mb-2">Vat 2</h6>
      <div class="grid-3">
        <div><label class="form-label">Cap</label><select class="form-select" id="vat2-cap"><option value="na" selected>N/A</option><option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option></select></div>
        <div>
          <label class="form-label">Cap Photo</label>
          <input id="vat2-cap-photo" type="file" accept="image/*" class="form-control">
          <img id="vat2-cap-preview" class="photo-thumb d-none" alt="">
        </div>
        <div><label class="form-label">Serial</label><input class="form-control" id="vat2-serial"></div>

        <div><label class="form-label">Condition</label><select class="form-select" id="vat2-condition"><option value="ok">OK</option><option value="attention">Attention</option></select></div>
        <div><label class="form-label">Condition Comments</label><input class="form-control" id="vat2-condition-comments"></div>

        <div class="col-12"><label class="form-label">Comments</label><input class="form-control" id="vat2-comments"></div>
        <div><label class="form-label">Agitator Location</label><input class="form-control" id="agitator2-location"></div>
        <div>
          <label class="form-label">Agitator Photo</label>
          <input id="agitator2-photo" type="file" accept="image/*" class="form-control">
          <img id="agitator2-preview" class="photo-thumb d-none" alt="">
        </div>
      </div>
    </div>

    <div class="form-card">
      <h6 class="mb-2">Mobile Signal</h6>
      <div class="grid-3">
        <div><label class="form-label">Spark (bars)</label><input class="form-control" id="spark-bars"></div>
        <div><label class="form-label">Spark Note</label><input class="form-control" id="spark-note"></div>
        <div><label class="form-label">One NZ (bars)</label><input class="form-control" id="one-bars"></div>
        <div><label class="form-label">One NZ Note</label><input class="form-control" id="one-note"></div>
      </div>
    </div>

    <div class="form-card">
      <h6 class="mb-2">Other Telemetry</h6>
      <div class="grid-3">
        <div><label class="form-label">Brand</label><input class="form-control" id="other-brand"></div>
        <div><label class="form-label">Type</label><select id="other-type" class="form-select"><option value="">Select…</option><option value="vat">Vat</option><option value="water">Water</option><option value="fuel">Fuel</option><option value="other">Other</option></select></div>
        <div><label class="form-label">Notes</label><input class="form-control" id="other-notes"></div>
      </div>
      <div class="grid-3 mt-2">
        <div><label class="form-label">Current Telemetry (legacy)</label><input class="form-control" id="current-telemetry"></div>
        <div class="col-12"><label class="form-label">Telemetry Comments</label><input class="form-control" id="telemetry-comments"></div>
      </div>
    </div>

    <div class="form-card">
      <h6 class="mb-2">Rubberware</h6>
      <div class="grid-3">
        <div><label class="form-label">Door Seal Delivered?</label><select class="form-select" id="door-delivered"><option value="no">No</option><option value="yes">Yes</option><option value="delivered">Delivered</option></select></div>
        <div><label class="form-label">Door Seal Size</label><select class="form-select" id="door-size"><option value="">Select…</option><option value="small">Small</option><option value="large">Large</option></select></div>
        <div><label class="form-label">Door Seal Photo</label><input id="door-photo" type="file" accept="image/*" class="form-control"><img id="door-preview" class="photo-thumb d-none" alt=""></div>

        <div><label class="form-label">RJT Delivered?</label><select class="form-select" id="rjt-delivered"><option value="no">No</option><option value="yes">Yes</option><option value="delivered">Delivered</option></select></div>
        <div><label class="form-label">RJT Size</label><select class="form-select" id="rjt-size"><option value="">Select…</option><option value="small">Small</option><option value="large">Large</option></select></div>
        <div><label class="form-label">RJT Photo</label><input id="rjt-photo" type="file" accept="image/*" class="form-control"><img id="rjt-preview" class="photo-thumb d-none" alt=""></div>
      </div>
    </div>

    <div class="sticky-actions">
      <button id="btn-save" class="btn btn-brand">Save / Update</button>
      <button id="btn-print-one" class="btn btn-outline-brand">Print This Farm</button>
      <button id="btn-to-summary" class="btn btn-outline-secondary">Back to Summary</button>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="view-admin" class="hidden">
    <div class="bar">
      <div class="section-title">Admin</div>
      <div class="d-flex gap-2 flex-wrap">
        <button id="btn-reload" class="btn btn-brand">Reload Summary</button>
        <button id="btn-clear-sw" class="btn btn-outline-brand">Reset SW Cache</button>
        <button id="btn-build-brochures" class="btn btn-outline-brand">Build All Brochures to Cloud</button>
      </div>
      <div class="small mt-2">Cloud brochures path: <code>Pre Check Brochures/</code>. Bulk actions use these first (fast), then fall back to generating.</div>
    </div>
  </div>

  <div class="footer">Agora • Vat Pre-Check • v4.6</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* ========== Firebase ========== */
firebase.initializeApp({
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
});
const storage=firebase.storage();
const FOLDER='Pre Check';
const BROCHURE_FOLDER='Pre Check Brochures';

/* ========== helpers / state ========== */
const $=id=>document.getElementById(id);
const N=v=>v==null?'':String(v);
const low=s=>N(s).toLowerCase();
let LOGO_URL='';

let MANIFEST=[];                  // array of '7008.json'
const RECORDS=new Map();          // dn -> parsed json (on-demand)
const sizeCounts=new Map();       // '12000' -> count
const SETS={dts:new Set(),power:new Set(),rubber:new Set()}; // for KPI filters
let currentFilter='';             // '', 'dts', 'power', 'rubber'

function setPct(done,total){const p=total?Math.floor(done/total*100):0;$('load-bar').style.width=p+'%';$('load-pct').textContent=p+'%';$('loaded-count').textContent=done;}

/* ---- Robust key mapping (legacy + new) ---- */
function keyIndex(rec){
  const idx=new Map();
  Object.keys(rec||{}).forEach(k=>{ idx.set(k.toLowerCase().replace(/[^a-z0-9]/g,''), k); });
  return idx;
}
function getAny(rec, variants){
  const idx=keyIndex(rec);
  for(const v of variants){
    const k = idx.get(v.toLowerCase().replace(/[^a-z0-9]/g,'')); if(k!=null) return rec[k];
  }
  return '';
}
function pick(rec,...variants){ return getAny(rec, variants) }

/* Normalizers */
function normCap(v){const t=low(v); if(/unavailable|no|✗/i.test(t))return'unavailable'; if(/available|yes|✓/i.test(t))return'available'; if(/na|n\/a/i.test(t))return'na'; return v||''}
function numSize(s){const m=N(s).match(/(\d{3,6})/); return m?m[1]:''}
function manufacturer(rec){
  const blob=low([pick(rec,'vat1-comments','vat 1 comments'), pick(rec,'vat2-comments','vat 2 comments'), pick(rec,'other-brand'), pick(rec,'current-telemetry')].join(' '));
  if(/\bdts\b/.test(blob)) return 'DTS';
  if(/\bnda\b/.test(blob)) return 'NDA';
  if(/\bhalo\b/.test(blob)) return 'Halo';
  if(/\blevno\b/.test(blob)) return 'Levno';
  return pick(rec,'other-brand')||'';
}
function hasDts(rec){
  const b=low(JSON.stringify(rec));
  return /\bdts\b/.test(b) || /(grey|gray)\s+halo/.test(b) || /vent\s*cap/.test(b) || /\bcap\s*available\b/.test(b);
}
function needsPower(rec){ return /(power\s*point|splitter\s*plug|double\s*adapter)/i.test(JSON.stringify(rec)) }
function doorDelivered(rec){ return /yes|delivered/i.test(N(pick(rec,'door-delivered','vat-door-seal','doorseal'))) }
function rjtDelivered(rec){ return /yes|delivered/i.test(N(pick(rec,'rjt-delivered','rjt-seal','rjt'))) }

/* Photos across versions */
function photoOf(rec,which){
  const map={
    gateway:['gateway-photo-base64','gatewayphoto'],
    v1cap:['vat1-cap-photo-base64','vat1capphoto'],
    v1agit:['agitator1-photo-base64','agitator-photo-base64','agitatorphoto'],
    v2cap:['vat2-cap-photo-base64','vat2capphoto'],
    v2agit:['agitator2-photo-base64'],
    door:['door-photo-base64','vat-door-seal-photo-base64'],
    rjt:['rjt-photo-base64','rjt-seal-photo-base64']
  };
  for(const k of (map[which]||[])){ if(rec[k]) return rec[k] }
  return '';
}

/* ========== logo ========== */
(async()=>{ try{ LOGO_URL=await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL(); $('logo').src=LOGO_URL; $('logo').style.display='block'; }catch(e){} })();

/* ========== cloud list -> numbers only ========== */
async function listCloud(){
  const res=await storage.ref(FOLDER).listAll();
  const keys=res.items.filter(i=>/\.json$/i.test(i.name)).map(i=>i.name);
  $('cloud-count').textContent=keys.length;
  return keys;
}
function renderNumberList(keys){
  const html = keys.sort().map(k=>{
    const dn=k.replace('.json','');
    return `<div class="row-card" id="row-${dn}">
      <div class="row-flex">
        <div><strong>#${dn}</strong> <span class="badge-soft small">tap to open</span></div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-brand" onclick="openDetails('${dn}')">Details</button>
          <button class="btn btn-sm btn-brand" onclick="openPrint('${dn}')">Print</button>
        </div>
      </div>
    </div>`;
  }).join('');
  $('result-list').innerHTML=html;
}
function applySearch(){
  const t=low($('search').value);
  document.querySelectorAll('#result-list .row-card').forEach(el=>{
    const matchText=low(el.textContent).includes(t);
    const dn=el.id.replace('row-','');
    const passFilter = !currentFilter ||
      (currentFilter==='dts' && SETS.dts.has(dn)) ||
      (currentFilter==='power' && SETS.power.has(dn)) ||
      (currentFilter==='rubber' && SETS.rubber.has(dn));
    el.style.display = (matchText && passFilter) ? '' : 'none';
  });
}
$('search').addEventListener('input',applySearch);
$('btn-clear').onclick=()=>{$('search').value='';applySearch()};

/* ========== size + KPI (cloud streaming, background) ========== */
async function buildSizesAndKPI(){
  sizeCounts.clear(); SETS.dts.clear(); SETS.power.clear(); SETS.rubber.clear();

  const keys=[...MANIFEST];
  const batch=8; let done=0;

  async function fetchOne(key){
    try{
      const url=await storage.ref(`${FOLDER}/${key}`).getDownloadURL();
      const rec=await fetch(url).then(r=>r.json());
      const dn=(rec.dairyNumber||key.replace('.json',''));
      // sizes
      const s1=numSize(pick(rec,'vat1-capacity','vat 1 capacity','vat1')); if(s1) sizeCounts.set(s1,(sizeCounts.get(s1)||0)+1);
      const s2=numSize(pick(rec,'vat2-capacity','vat 2 capacity','vat2')); if(s2) sizeCounts.set(s2,(sizeCounts.get(s2)||0)+1);
      // KPI sets
      if(hasDts(rec)) SETS.dts.add(dn);
      if(needsPower(rec)) SETS.power.add(dn);
      if(doorDelivered(rec) || rjtDelivered(rec)) SETS.rubber.add(dn);
    }catch(e){}
  }

  while(done<keys.length){
    await Promise.all(keys.slice(done,done+batch).map(fetchOne));
    done+=batch; setPct(done, keys.length);

    // live update: size table & KPI
    renderSizesTable();
    $('kpi-dts').textContent=SETS.dts.size;
    $('kpi-power').textContent=SETS.power.size;
    $('kpi-rubber').textContent=SETS.rubber.size;
  }
}
function renderSizesTable(){
  let html='<table class="table table-sm table-bordered mb-0"><thead><tr><th>Vat Size (L)</th><th>Count</th></tr></thead><tbody>';
  [...sizeCounts.entries()].sort((a,b)=>parseInt(a[0])-parseInt(b[0])).forEach(([sz,c])=>{ html+=`<tr><td>${sz}</td><td>${c}</td></tr>`; });
  $('size-table').innerHTML = html+'</tbody></table>';
}
document.querySelectorAll('.kpi').forEach(k=>{
  k.addEventListener('click', ()=>{
    currentFilter = k.getAttribute('data-kpi')===currentFilter ? '' : k.getAttribute('data-kpi');
    applySearch();
  });
});
$('btn-export-sizes').onclick=()=>{
  const rows=[...sizeCounts.entries()].map(([Size,Count])=>({Size,Count}));
  const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Vat Sizes'); XLSX.writeFile(wb,'vat_sizes.csv');
};

/* ========== record fetch (on demand) ========== */
async function fetchRecord(dn){
  if(RECORDS.has(dn)) return RECORDS.get(dn);
  const url=await storage.ref(`${FOLDER}/${dn}.json`).getDownloadURL();
  const rec=await fetch(url).then(r=>r.json());
  rec.dairyNumber = rec.dairyNumber || dn;
  // try to derive serials if only noted in comments e.g. "SN Vat 1 ABC123"
  if(!pick(rec,'vat1-serial') && pick(rec,'vat1-comments')){
    const m=pick(rec,'vat1-comments').match(/vat\s*1\s*([A-Za-z0-9\-]+)/i); if(m) rec['vat1-serial']=m[1];
  }
  if(!pick(rec,'vat2-serial') && pick(rec,'vat2-comments')){
    const m=pick(rec,'vat2-comments').match(/vat\s*2\s*([A-Za-z0-9\-]+)/i); if(m) rec['vat2-serial']=m[1];
  }
  RECORDS.set(dn,rec); return rec;
}

/* ========== brochure HTML (keeps your layout) ========== */
function p(label,src){return src?`<div class="print-card"><div class="print-label">${label}</div><div class="print-photos"><img src="${src}"></div></div>`:''}
function brochureHTML(rec){
  const doorCount = doorDelivered(rec) ? ( pick(rec,'vat2-capacity') ? 2 : 1 ) : 0;
  return `
  <div class="print-sheet">
    <div class="print-head"><img src="${LOGO_URL||''}" alt="logo">
      <div><div class="print-title">Vat Pre-Check – #${rec.dairyNumber||''}</div>
      <div class="print-sub">Brand: ${manufacturer(rec)||'-'} • Spark: ${pick(rec,'spark-bars')||'-'} • One NZ: ${pick(rec,'one-bars')||'-'}</div></div>
    </div>

    <div class="print-grid">
      <div class="print-card"><div class="print-label">Vat 1</div>
        <div>Capacity: <b>${pick(rec,'vat1-capacity','vat 1 capacity')||'-'}</b></div>
        <div>Cap: <b>${(normCap(pick(rec,'vat1-cap'))||'-').toUpperCase()}</b></div>
        <div>Serial: <b>${pick(rec,'vat1-serial')||'-'}</b></div>
        <div>Condition: <b>${pick(rec,'vat1-condition')||'-'}</b> ${pick(rec,'vat1-condition-comments')? '• '+pick(rec,'vat1-condition-comments'):''}</div>
        <div>Agitator: ${pick(rec,'agitator1-location','agitator-location')||'-'}</div>
        <div>Notes: ${pick(rec,'vat1-comments')||'-'}</div>
      </div>

      <div class="print-card"><div class="print-label">Vat 2</div>
        <div>Capacity: <b>${pick(rec,'vat2-capacity','vat 2 capacity')||'-'}</b></div>
        <div>Cap: <b>${(normCap(pick(rec,'vat2-cap'))||'-').toUpperCase()}</b></div>
        <div>Serial: <b>${pick(rec,'vat2-serial')||'-'}</b></div>
        <div>Condition: <b>${pick(rec,'vat2-condition')||'-'}</b> ${pick(rec,'vat2-condition-comments')? '• '+pick(rec,'vat2-condition-comments'):''}</div>
        <div>Agitator: ${pick(rec,'agitator2-location')||'-'}</div>
        <div>Notes: ${pick(rec,'vat2-comments')||'-'}</div>
      </div>

      <div class="print-card"><div class="print-label">Gateway</div>
        <div>Location: <b>${pick(rec,'gateway-location')||'-'}</b></div>
      </div>
      <div class="print-card"><div class="print-label">Mobile Signal</div>
        <div>Spark: <b>${pick(rec,'spark-bars')||'-'}</b> ${pick(rec,'spark-note')? '• '+pick(rec,'spark-note'):''}</div>
        <div>One NZ: <b>${pick(rec,'one-bars')||'-'}</b> ${pick(rec,'one-note')? '• '+pick(rec,'one-note'):''}</div>
      </div>

      <div class="print-card"><div class="print-label">Other Telemetry</div>
        <div>Brand: <b>${pick(rec,'other-brand')||'-'}</b> • Type: <b>${pick(rec,'other-type')||'-'}</b></div>
        <div>Notes: ${pick(rec,'other-notes')||pick(rec,'current-telemetry')||'-'}</div>
      </div>
      <div class="print-card"><div class="print-label">Rubberware</div>
        <div>Door Seal: <b>${doorDelivered(rec)?'Delivered':'No'}</b> ${pick(rec,'door-size','vat-door-seal-size')? '• '+pick(rec,'door-size','vat-door-seal-size'):''} ${doorCount? '(x'+doorCount+')':''}</div>
        <div>RJT: <b>${rjtDelivered(rec)?'Delivered':'No'}</b> ${pick(rec,'rjt-size','rjt-seal-size')? '• '+pick(rec,'rjt-size','rjt-seal-size'):''}</div>
      </div>
    </div>

    <div class="print-grid" style="margin-top:10px">
      ${p('Gateway',  photoOf(rec,'gateway'))}
      ${p('Vat 1 Cap', photoOf(rec,'v1cap'))}
      ${p('Agitator (Vat 1)', photoOf(rec,'v1agit'))}
      ${p('Vat 2 Cap', photoOf(rec,'v2cap'))}
      ${p('Agitator (Vat 2)', photoOf(rec,'v2agit'))}
      ${p('Door Seal', photoOf(rec,'door'))}
      ${p('RJT',       photoOf(rec,'rjt'))}
    </div>
  </div>`;
}

/* ========== details/print per farm ========== */
window.openDetails = async (dn)=>{
  const row=$('row-'+dn); if(!row) return;
  const ex=row.querySelector('.details'); if(ex){ ex.remove(); return; }
  const rec=await fetchRecord(dn);
  const wrap=document.createElement('div'); wrap.className='details mt-2'; wrap.innerHTML=brochureHTML(rec);
  row.appendChild(wrap);
};
window.openPrint = async (dn)=>{
  const rec=await fetchRecord(dn);
  const css=document.querySelector('style').innerHTML;
  const w=window.open('','_blank');
  w.document.write(`<html><head><title>#${dn}</title><style>body{font-family:Inter,Arial,sans-serif;padding:16px}${css}</style></head><body>${brochureHTML(rec)}</body></html>`);
  w.document.close(); w.focus(); setTimeout(()=>w.print(),250);
};

/* ========== bulk: print all / zip all (uses cloud brochures first) ========== */
function brochureDoc(dn,rec){ const css=document.querySelector('style').innerHTML; return `<!doctype html><meta charset="utf-8"><title>${dn}</title><style>body{font-family:Inter,Arial,sans-serif;padding:16px}${css}</style>${brochureHTML(rec)}` }
async function eachRecord(fn){
  const keys=[...MANIFEST]; const batch=10; let i=0;
  while(i<keys.length){
    const group=keys.slice(i,i+batch);
    const parts=await Promise.all(group.map(async k=>{
      const dn=k.replace('.json','');
      try{
        // try cloud brochure
        const html = await storage.ref(`${BROCHURE_FOLDER}/brochure_${dn}.html`)
          .getDownloadURL().then(u=>fetch(u).then(r=>r.text())).catch(()=>null);
        if(html) return {dn, html};
        const rec=await fetchRecord(dn);
        return {dn, html: brochureDoc(dn,rec)};
      }catch(e){ return null }
    }));
    for(const p of parts){ if(p) await fn(p.dn, p.html) }
    i+=batch;
  }
}
$('btn-print-all').onclick=async ()=>{
  if(!MANIFEST.length){ alert('No records'); return; }
  const w=window.open('','_blank'); const css=document.querySelector('style').innerHTML;
  w.document.write(`<html><head><title>All Brochures</title><style>body{font-family:Inter,Arial,sans-serif;padding:16px}${css}</style></head><body></body></html>`); w.document.close();
  await eachRecord(async (_dn, html)=>{ const d=w.document.createElement('div'); d.innerHTML=html+'<div style="page-break-after:always"></div>'; w.document.body.appendChild(d); });
  setTimeout(()=>w.print(),400);
};
$('btn-zip-all').onclick=async ()=>{
  if(!MANIFEST.length){ alert('No records'); return; }
  const zip=new JSZip();
  await eachRecord(async (dn, html)=> zip.file(`brochure_${dn}.html`, html));
  const blob=await zip.generateAsync({type:'blob'}); saveAs(blob,'agora_precheck_brochures.zip');
};

/* ========== FORM: reveal vat2 + autofill + offline queue ========== */
function toggleVat2Extra(){ $('vat2-extra').classList.toggle('hidden', !N($('vat2-capacity').value).trim()) }
$('vat2-capacity').addEventListener('input',toggleVat2Extra); $('vat2-capacity').addEventListener('blur',toggleVat2Extra);
function setVal(id,v){ const el=$(id); if(el) el.value=v??'' }
function setPrev(id,b64){ const el=$(id); if(!el)return; if(b64){el.src=b64; el.classList.remove('d-none')} else el.classList.add('d-none') }

async function autofill(dn){
  try{
    const rec=await fetchRecord(dn);
    setVal('dairyNumber', rec.dairyNumber);
    setVal('gateway-location', pick(rec,'gateway-location'));
    setPrev('gateway-preview', photoOf(rec,'gateway'));

    setVal('vat1-capacity', pick(rec,'vat1-capacity','vat 1 capacity'));
    setVal('vat1-cap', normCap(pick(rec,'vat1-cap'))||'available');
    setVal('vat1-serial', pick(rec,'vat1-serial'));
    setVal('vat1-condition', pick(rec,'vat1-condition')||'ok');
    setVal('vat1-condition-comments', pick(rec,'vat1-condition-comments'));
    setVal('vat1-comments', pick(rec,'vat1-comments'));
    setVal('agitator1-location', pick(rec,'agitator1-location','agitator-location'));
    setPrev('vat1-cap-preview', photoOf(rec,'v1cap'));
    setPrev('agitator1-preview', photoOf(rec,'v1agit'));

    setVal('vat2-capacity', pick(rec,'vat2-capacity','vat 2 capacity')); toggleVat2Extra();
    setVal('vat2-cap', normCap(pick(rec,'vat2-cap')) || (pick(rec,'vat2-capacity')?'available':'na'));
    setVal('vat2-serial', pick(rec,'vat2-serial'));
    setVal('vat2-condition', pick(rec,'vat2-condition')||'ok');
    setVal('vat2-condition-comments', pick(rec,'vat2-condition-comments'));
    setVal('vat2-comments', pick(rec,'vat2-comments'));
    setVal('agitator2-location', pick(rec,'agitator2-location'));
    setPrev('vat2-cap-preview', photoOf(rec,'v2cap'));
    setPrev('agitator2-preview', photoOf(rec,'v2agit'));

    setVal('spark-bars', pick(rec,'spark-bars')); setVal('spark-note', pick(rec,'spark-note'));
    setVal('one-bars', pick(rec,'one-bars')); setVal('one-note', pick(rec,'one-note'));

    setVal('other-brand', pick(rec,'other-brand')); setVal('other-type', pick(rec,'other-type')); setVal('other-notes', pick(rec,'other-notes'));
    setVal('current-telemetry', pick(rec,'current-telemetry')); setVal('telemetry-comments', pick(rec,'telemetry-comments'));

    setVal('door-delivered', pick(rec,'door-delivered','vat-door-seal')||'no'); setVal('door-size', pick(rec,'door-size','vat-door-seal-size'));
    setVal('rjt-delivered',  pick(rec,'rjt-delivered','rjt-seal')||'no');      setVal('rjt-size', pick(rec,'rjt-size','rjt-seal-size'));
    setPrev('door-preview', photoOf(rec,'door')); setPrev('rjt-preview', photoOf(rec,'rjt'));
  }catch(e){ alert('Could not load #'+dn); }
}
$('dairyNumber').addEventListener('blur', ()=>{ const dn=N($('dairyNumber').value).trim(); if(dn) autofill(dn) });

async function toB64(fileInput){ const f=fileInput.files&&fileInput.files[0]; if(!f) return ''; return await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); }); }
async function collectForm(){
  const dn=N($('dairyNumber').value).trim(); if(!dn) throw new Error('Dairy # required');
  return {
    dairyNumber: dn,
    'gateway-location': $('gateway-location').value,
    'vat1-capacity': $('vat1-capacity').value,
    'vat1-cap': $('vat1-cap').value,
    'vat1-serial': $('vat1-serial').value,
    'vat1-condition': $('vat1-condition').value,
    'vat1-condition-comments': $('vat1-condition-comments').value,
    'vat1-comments': $('vat1-comments').value,
    'agitator1-location': $('agitator1-location').value,
    'vat2-capacity': $('vat2-capacity').value,
    'vat2-cap': $('vat2-cap').value,
    'vat2-serial': $('vat2-serial').value,
    'vat2-condition': $('vat2-condition').value,
    'vat2-condition-comments': $('vat2-condition-comments').value,
    'vat2-comments': $('vat2-comments').value,
    'agitator2-location': $('agitator2-location').value,
    'spark-bars': $('spark-bars').value, 'spark-note': $('spark-note').value,
    'one-bars': $('one-bars').value, 'one-note': $('one-note').value,
    'other-brand': $('other-brand').value, 'other-type': $('other-type').value, 'other-notes': $('other-notes').value,
    'current-telemetry': $('current-telemetry').value, 'telemetry-comments': $('telemetry-comments').value,
    'door-delivered': $('door-delivered').value, 'door-size': $('door-size').value,
    'rjt-delivered': $('rjt-delivered').value, 'rjt-size': $('rjt-size').value,
    'gateway-photo-base64': await toB64($('gateway-photo')),
    'vat1-cap-photo-base64': await toB64($('vat1-cap-photo')),
    'agitator1-photo-base64': await toB64($('agitator1-photo')),
    'vat2-cap-photo-base64': await toB64($('vat2-cap-photo')),
    'agitator2-photo-base64': await toB64($('agitator2-photo')),
    'door-photo-base64': await toB64($('door-photo')),
    'rjt-photo-base64': await toB64($('rjt-photo')),
    timestamp: Date.now()
  };
}
async function uploadJson(path,obj){ const blob=new Blob([JSON.stringify(obj)],{type:'application/json'}); await storage.ref(path).put(blob); }

/* offline queue (iOS-safe) */
const queueKey='agora_precheck_pending_forms';
function qRead(){ try{return JSON.parse(localStorage.getItem(queueKey)||'[]')}catch{return[]}}
function qWrite(arr){ localStorage.setItem(queueKey, JSON.stringify(arr)) }
async function flushQueue(){ const q=qRead(); if(!q.length) return; const left=[]; for(const data of q){ try{ await uploadJson(`${FOLDER}/${data.dairyNumber}.json`, data); }catch(e){ left.push(data) } } qWrite(left); if(!left.length) alert('Offline forms synced.'); }
window.addEventListener('online', flushQueue);

$('btn-save').onclick = async ()=>{
  try{
    const data=await collectForm();
    try{ await uploadJson(`${FOLDER}/${data.dairyNumber}.json`, data); alert('Saved.'); }
    catch(e){ const q=qRead(); q.push(data); qWrite(q); alert('No signal. Saved locally and will auto-upload when online.'); }
  }catch(err){ alert(err.message) }
};
$('btn-print-one').onclick=async ()=>{ const dn=N($('dairyNumber').value).trim(); if(!dn){ alert('Enter Dairy #'); return; } await openPrint(dn); };
$('btn-to-summary').onclick=()=>$('tab-summary').click();

/* ========== Tabs & Admin ========== */
function activate(btnId, viewId){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); $(btnId).classList.add('active');
  ['view-summary','view-form','view-admin'].forEach(id=>document.getElementById(id).classList.add('hidden')); $(viewId).classList.remove('hidden');
}
$('tab-summary').onclick=()=>{activate('tab-summary','view-summary')};
$('tab-form').onclick=()=>{activate('tab-form','view-form')};
$('tab-admin').onclick=()=>{activate('tab-admin','view-admin')};
$('btn-reload').onclick=()=>{MANIFEST=[];RECORDS.clear();sizeCounts.clear();SETS.dts.clear();SETS.power.clear();SETS.rubber.clear();$('result-list').innerHTML='';$('size-table').textContent='Starting…';setPct(0,1);startSummary()};
$('btn-clear-sw').onclick=async()=>{const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); caches.keys().then(ns=>ns.forEach(n=>caches.delete(n))); alert('SW cache cleared. Reload.');};
$('btn-build-brochures').onclick=async ()=>{
  if(!confirm('Generate & upload brochures to cloud?')) return;
  const put=(path,html)=>storage.ref(path).putString(html,'raw',{contentType:'text/html'});
  await eachRecord(async (dn,html)=>{ try{ await put(`${BROCHURE_FOLDER}/brochure_${dn}.html`, html); }catch(e){} });
  alert('Brochures uploaded.');
};

/* ========== boot ========== */
async function startSummary(){
  try{ LOGO_URL=await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL(); $('logo').src=LOGO_URL; $('logo').style.display='block'; }catch(e){}
  MANIFEST = await listCloud();
  renderNumberList(MANIFEST);       // instant
  setPct(0, MANIFEST.length);
  buildSizesAndKPI();               // stream in background
}
(async function init(){
  await startSummary();
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js').catch(()=>{}); }
  flushQueue();
})();
</script>
</body>
</html>