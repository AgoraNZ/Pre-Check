<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Agora Vat Pre-Check</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">

<style>
:root{
  --brand:#a7ab01; --ink:#0d1b2a; --muted:#6b7280; --card:#ffffff; --soft:#f5f7fb;
  --accent:#ff851b; --accent-2:#002b5c; --ok:#16a34a; --warn:#ef4444; --chip:#eef2ff;
}
html,body{background:#f7f9fc;color:var(--ink);}
.container-narrow{max-width:980px}
.brand-title{font-weight:800;font-size:clamp(26px,4.2vw,40px);line-height:1.05;color:#0f2742}
.brand-sub{color:#5b6573}
.logo{height:64px;object-fit:contain}
.nav-pill{border:2px solid #e5e7eb;border-radius:14px; padding:.6rem 1.1rem; background:#fff; font-weight:700; color:#0f2742}
.nav-pill.active{border-color:var(--brand); box-shadow:inset 0 0 0 2px var(--brand); background:#f8fad1}
.kpi{background:var(--card);border-radius:18px;padding:18px 18px;box-shadow:0 1px 2px rgba(16,24,40,0.04)}
.kpi h3{font-size:36px;margin:0 0 6px}
.kpi .label{color:var(--muted);font-weight:600}
.kpi.clickable{cursor:pointer;transition:transform .06s ease}
.kpi.clickable:hover{transform:translateY(-1px)}
.section-card{background:var(--card);border-radius:20px;padding:18px;box-shadow:0 2px 8px rgba(16,24,40,.06)}
.field-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin-bottom:14px}
.field-card h6{font-weight:800;margin:0 0 10px;color:#0f2742}
.badge-pill{border-radius:999px;background:var(--chip);padding:.25rem .6rem;font-weight:700}
.smallmuted{color:#9aa3af;font-size:.9rem}
.divider{height:1px;background:#eef2f7;margin:10px 0 14px}
.photo-thumb{width:92px;height:92px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb}
.farm-card{background:#fff;border-radius:18px;padding:14px 14px;box-shadow:0 1px 8px rgba(0,0,0,0.06);margin-bottom:12px}
.farm-card h5{margin:2px 0 12px}
.farm-meta{color:#475569}
.link-btn{color:#0ea5e9;cursor:pointer;font-weight:700}
.progress-wrap{display:flex;align-items:center;gap:12px}
.progress{height:10px}
.print-head{display:flex;align-items:center;gap:12px;border-bottom:2px solid #eef2f7;padding-bottom:10px;margin-bottom:8px}
.print-row{display:flex;gap:14px;margin:.2rem 0}
.print-k{width:120px;color:#6b7280}
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.photo-grid img{width:100%;height:170px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb}
.hidden{display:none!important}
</style>
</head>
<body>
<div class="container container-narrow py-3">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex align-items-center gap-3">
      <img id="agoraLogo" class="logo" src="" alt="Agora">
      <div>
        <div class="brand-title">Agora Vat<br>Pre-Check</div>
        <div class="brand-sub">Fast field capture • Smart summary • Customer-ready output</div>
      </div>
    </div>
    <div class="d-flex gap-2">
      <button id="tabForm" class="nav-pill active" onclick="showTab('form')">Form</button>
      <button id="tabSummary" class="nav-pill" onclick="showTab('summary')">Summary</button>
      <button id="tabAdmin" class="nav-pill" onclick="showTab('admin')">Admin</button>
    </div>
  </div>

  <!-- Sync status -->
  <div id="syncStatus" class="progress-wrap mb-3">
    <span class="smallmuted">Cloud: <b id="cloudCount">0</b>&nbsp;&nbsp; Cached: <b id="cachedCount">0</b>&nbsp;&nbsp; New: <b id="newCount">0</b></span>
    <div class="progress flex-grow-1">
      <div id="syncBar" class="progress-bar bg-warning" role="progressbar" style="width:0%"></div>
    </div>
  </div>

  <!-- FORM TAB -->
  <div id="panelForm">
    <div class="section-card">
      <h4 class="mb-3">Create / Update Pre-Check</h4>

      <div class="field-card">
        <h6>Dairy</h6>
        <div class="row g-2">
          <div class="col-7">
            <input id="f_dairy" class="form-control" placeholder="e.g. 7016">
          </div>
          <div class="col-5 d-flex gap-2">
            <button class="btn btn-primary flex-grow-1" onclick="autoFill()">Auto-fill</button>
            <button class="btn btn-outline-secondary" onclick="clearForm()">Clear</button>
          </div>
        </div>
      </div>

      <!-- Vat 1 -->
      <div class="field-card">
        <h6>Vat 1</h6>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label smallmuted">Capacity (L)</label>
            <input id="f_v1_capL" class="form-control" inputmode="numeric">
          </div>
          <div class="col-6">
            <label class="form-label smallmuted">Serial #</label>
            <input id="f_v1_sn" class="form-control">
          </div>
          <div class="col-6">
            <label class="form-label smallmuted">Cap</label>
            <select id="f_v1_cap" class="form-select">
              <option value="available">Available ✓</option>
              <option value="unavailable">Unavailable ✗</option>
              <option value="na">N/A</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label smallmuted">Condition</label>
            <select id="f_v1_cond" class="form-select">
              <option value="ok">OK</option><option value="attention">Attention</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label smallmuted">Agitator location</label>
            <input id="f_v1_agit_loc" class="form-control" placeholder="e.g. rear left">
          </div>
          <div class="col-12">
            <label class="form-label smallmuted">Comments</label>
            <input id="f_v1_cmt" class="form-control">
          </div>
          <div class="col-8">
            <input id="f_v1_cap_photo" type="file" accept="image/*" class="form-control" onchange="previewImg(this,'img_v1_cap')">
          </div>
          <div class="col-4"><img id="img_v1_cap" class="photo-thumb hidden"></div>
        </div>
      </div>

      <!-- Vat 2 (revealed on capacity) -->
      <div id="cardVat2" class="field-card">
        <h6>Vat 2</h6>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label smallmuted">Capacity (L)</label>
            <input id="f_v2_capL" class="form-control" inputmode="numeric" oninput="toggleVat2()">
          </div>
          <div class="col-6">
            <label class="form-label smallmuted">Serial #</label>
            <input id="f_v2_sn" class="form-control">
          </div>
          <div class="col-6">
            <label class="form-label smallmuted">Cap</label>
            <select id="f_v2_cap" class="form-select">
              <option value="na" selected>N/A</option>
              <option value="available">Available ✓</option>
              <option value="unavailable">Unavailable ✗</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label smallmuted">Condition</label>
            <select id="f_v2_cond" class="form-select">
              <option value="ok">OK</option><option value="attention">Attention</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label smallmuted">Agitator location</label>
            <input id="f_v2_agit_loc" class="form-control" placeholder="e.g. front right">
          </div>
          <div class="col-12">
            <label class="form-label smallmuted">Comments</label>
            <input id="f_v2_cmt" class="form-control">
          </div>
          <div class="col-8">
            <input id="f_v2_cap_photo" type="file" accept="image/*" class="form-control" onchange="previewImg(this,'img_v2_cap')">
          </div>
          <div class="col-4"><img id="img_v2_cap" class="photo-thumb hidden"></div>
        </div>
      </div>

      <!-- Gateway -->
      <div class="field-card">
        <h6>Gateway</h6>
        <div class="row g-2">
          <div class="col-12"><input id="f_gw_loc" class="form-control" placeholder="e.g. by chiller"></div>
          <div class="col-12"><input id="f_gw_cmt" class="form-control" placeholder="comments"></div>
          <div class="col-8">
            <input id="f_gw_photo" type="file" accept="image/*" class="form-control" onchange="previewImg(this,'img_gw')">
          </div>
          <div class="col-4"><img id="img_gw" class="photo-thumb hidden"></div>
        </div>
      </div>

      <!-- Signal -->
      <div class="field-card">
        <h6>Signal</h6>
        <div class="row g-2">
          <div class="col-4">
            <label class="form-label smallmuted">Spark bars</label>
            <select id="f_sig_spark" class="form-select">
              <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            </select>
          </div>
          <div class="col-4">
            <label class="form-label smallmuted">One NZ bars</label>
            <select id="f_sig_onenz" class="form-select">
              <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            </select>
          </div>
          <div class="col-4">
            <label class="form-label smallmuted">Preferred</label>
            <select id="f_sig_pref" class="form-select">
              <option value="">—</option>
              <option value="spark">Spark</option>
              <option value="one nz">One NZ</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Other telemetry -->
      <div class="field-card">
        <h6>Other telemetry</h6>
        <div class="row g-2">
          <div class="col-6"><input id="f_tel_brand" class="form-control" placeholder="Halo, Levno, NDA..."></div>
          <div class="col-6"><input id="f_tel_type" class="form-control" placeholder="vat, water, fuel..."></div>
          <div class="col-12"><input id="f_tel_cmt" class="form-control" placeholder="comments"></div>
        </div>
      </div>

      <!-- Rubberware -->
      <div class="field-card">
        <h6>Rubberware</h6>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label smallmuted">Vat Door Seal</label>
            <select id="f_rw_door" class="form-select" onchange="doorDeliveredToggle()">
              <option value="notdelivered">Not delivered</option>
              <option value="delivered">Delivered</option>
            </select>
          </div>
          <div class="col-3">
            <label class="form-label smallmuted">Door Seal Size</label>
            <select id="f_rw_door_size" class="form-select">
              <option value="">auto</option>
              <option>small</option>
              <option>large</option>
            </select>
          </div>
          <div class="col-3">
            <label class="form-label smallmuted">Count</label>
            <input id="f_rw_door_count" class="form-control" inputmode="numeric" value="1">
          </div>
          <div class="col-8">
            <input id="f_rw_door_photo" type="file" accept="image/*" class="form-control" onchange="previewImg(this,'img_door')">
          </div>
          <div class="col-4"><img id="img_door" class="photo-thumb hidden"></div>

          <div class="col-6">
            <label class="form-label smallmuted">RJT Step Seal</label>
            <select id="f_rw_rjt" class="form-select">
              <option value="notdelivered">Not delivered</option>
              <option value="delivered">Delivered</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label smallmuted">RJT Size</label>
            <select id="f_rw_rjt_size" class="form-select">
              <option value="">—</option><option>small</option><option>large</option>
            </select>
          </div>
          <div class="col-8">
            <input id="f_rw_rjt_photo" type="file" accept="image/*" class="form-control" onchange="previewImg(this,'img_rjt')">
          </div>
          <div class="col-4"><img id="img_rjt" class="photo-thumb hidden"></div>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-success" onclick="saveForm()">Save</button>
        <button class="btn btn-outline-primary" onclick="printFarm()">Print</button>
      </div>
    </div>
  </div>

  <!-- SUMMARY TAB -->
  <div id="panelSummary" class="hidden">
    <div class="section-card mb-3">
      <div class="row g-2">
        <div class="col-12 col-md-5">
          <input id="q" class="form-control" placeholder="Search dairy # or text…">
        </div>
        <div class="col-6 col-md-2"><button class="btn btn-primary w-100" onclick="applyFilters()">Apply</button></div>
        <div class="col-6 col-md-2"><button class="btn btn-outline-secondary w-100" onclick="clearFilters()">Clear</button></div>
        <div class="col-12 col-md-3"><button class="btn btn-outline-dark w-100" onclick="exportVatCsv()">Export Vat Sizes CSV</button></div>
      </div>
    </div>

    <!-- KPI cards -->
    <div class="row g-2 mb-3">
      <div class="col-6 col-md-3"><div class="kpi clickable" onclick="focusFilter('dts')"><h3 id="k_dts">0</h3><div class="label">DTS / Vent Caps</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi clickable" onclick="focusFilter('pp')"><h3 id="k_pp">0</h3><div class="label">Power Points Needed</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi clickable" onclick="focusFilter('spark')"><h3 id="k_spark">0</h3><div class="label">Spark preferred</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi clickable" onclick="focusFilter('onenz')"><h3 id="k_onenz">0</h3><div class="label">One NZ preferred</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi clickable" onclick="focusFilter('door')"><h3 id="k_door">0</h3><div class="label">Door seals delivered</div></div></div>
      <div class="col-6 col-md-3"><div class="kpi"><h3 id="k_sizes">0</h3><div class="label">Distinct vat sizes</div></div></div>
    </div>

    <!-- Farms list -->
    <div id="farmsList" class="mb-5"></div>
  </div>

  <!-- ADMIN TAB -->
  <div id="panelAdmin" class="hidden">
    <div class="section-card">
      <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-primary" onclick="syncFromCloud(true)">Force Re-Sync</button>
        <button class="btn btn-outline-danger" onclick="clearCache()">Clear Cache</button>
        <button class="btn btn-outline-secondary" onclick="exportAll()">Export backup JSON</button>
      </div>
    </div>
  </div>

</div>

<!-- Firebase + libs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>

<script>
/* ======= Firebase ======= */
const firebaseConfig = {
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const PRECHECK_FOLDER = "Pre Check";          // JSON files: <dairy>.json
const LOGO_PATH = "Agora Logo/2F6-1YdaEP.jpeg";

/* ======= DB (cache) ======= */
const db = new Dexie('precheck_cache');
db.version(1).stores({
  forms: 'dairy, updated, json',       // dairy: string key, updated: iso string, json: raw json string
});
const state = { cache: new Map(), farms: [], filter: null, syncing:false };

/* ======= Brand / logo ======= */
(async()=>{
  try{
    const url = await storage.ref(LOGO_PATH).getDownloadURL();
    document.getElementById('agoraLogo').src = url;
  }catch{}
})();

/* ======= Helpers ======= */
const sleep = ms=>new Promise(r=>setTimeout(r,ms));
const chunk = (arr,n)=>arr.reduce((a,_,i)=>i%n? a: [...a, arr.slice(i,i+n)],[]);
const nowISO = ()=>new Date().toISOString();

function showTab(which){
  for(const id of ['Form','Summary','Admin']){
    document.getElementById('panel'+id).classList.toggle('hidden', id.toLowerCase()!==which);
    document.getElementById('tab'+id).classList.toggle('active', id.toLowerCase()===which);
  }
  if(which==='summary') { renderSummary(); }
}

function previewImg(input, imgId){
  const img = document.getElementById(imgId);
  const file = input.files?.[0];
  if(!file){ img.classList.add('hidden'); return; }
  img.src = URL.createObjectURL(file);
  img.onload = ()=> URL.revokeObjectURL(img.src);
  img.classList.remove('hidden');
}

function toggleVat2(){
  const show = !!(document.getElementById('f_v2_capL').value || '').trim();
  document.getElementById('f_v2_cap').disabled = !show;
  document.getElementById('f_v2_cond').disabled = !show;
  document.getElementById('f_v2_agit_loc').disabled = !show;
}
function doorDeliveredToggle(){
  const on = document.getElementById('f_rw_door').value==='delivered';
  document.getElementById('f_rw_door_count').disabled = !on;
}

function setSyncUI(done,total){
  const bar = document.getElementById('syncBar');
  const pct = total? Math.round(done/total*100) : 0;
  bar.style.width = pct+"%";
  document.getElementById('newCount').textContent = total-done;
}

/* ======= AI-ish Normalizer (rule engine) ======= */
const N = {
  hasDtsCap(text){
    text = (text||'').toLowerCase();
    return /dts|vent cap|ventcap|halo (?:sensor)?|grey halo|gray halo|grey sensor|gray sensor/.test(text);
  },
  needsPowerPoint(text){
    text = (text||'').toLowerCase();
    return /(power ?point|pp) (?:needed|recommended|required)|splitter plug/i.test(text) || /power.*(point|pp)/.test(text);
  },
  signalPref(rec){
    // explicit preferred wins; otherwise higher bar count wins
    if(rec.sig_pref){ return rec.sig_pref; }
    const s = Number(rec.s_spark||0), o = Number(rec.s_onenz||0);
    if(s>o) return 'spark';
    if(o>s) return 'one nz';
    return '';
  },
  makerGuess(snOrCmt){
    const t = (snOrCmt||'').toLowerCase();
    if(/dts|de laval|delaval|halo/.test(t)) return 'DTS';
    if(/nda|national dairy/.test(t)) return 'NDA';
    if(/packo/.test(t)) return 'Packo';
    return '';
  }
};

/* ======= Mapping between cache JSON and form fields ======= */
function toRecordFromForm(){
  const dairy = v('f_dairy').trim();
  const rec = {
    dairy,
    v1_capL: v('f_v1_capL'), v1_sn: v('f_v1_sn'),
    v1_cap: v('f_v1_cap'), v1_cond: v('f_v1_cond'),
    v1_agit_loc: v('f_v1_agit_loc'), v1_cmt: v('f_v1_cmt'),

    v2_capL: v('f_v2_capL'), v2_sn: v('f_v2_sn'),
    v2_cap: v('f_v2_cap'), v2_cond: v('f_v2_cond'),
    v2_agit_loc: v('f_v2_agit_loc'), v2_cmt: v('f_v2_cmt'),

    gw_loc: v('f_gw_loc'), gw_cmt: v('f_gw_cmt'),

    s_spark: v('f_sig_spark'), s_onenz: v('f_sig_onenz'),
    sig_pref: v('f_sig_pref'),

    tel_brand: v('f_tel_brand'), tel_type: v('f_tel_type'), tel_cmt: v('f_tel_cmt'),

    rw_door: v('f_rw_door'), rw_door_size: v('f_rw_door_size'), rw_door_count: v('f_rw_door_count'),
    rw_rjt: v('f_rw_rjt'), rw_rjt_size: v('f_rw_rjt_size'),

    photos: { // base64 placeholders (only set if selected)
      v1_cap: img64('img_v1_cap'),
      v2_cap: img64('img_v2_cap'),
      gateway: img64('img_gw'),
      door: img64('img_door'),
      rjt: img64('img_rjt')
    },
    updated: nowISO()
  };
  return rec;

  function v(id){ return document.getElementById(id).value || ''; }
  function img64(imgId){
    const img = document.getElementById(imgId);
    if(img && !img.classList.contains('hidden') && img.src.startsWith('blob:')){ // from file picker
      // convert to base64
      // We cannot access blob raw here easily; leave empty; during save we will read from file input.
      return '';
    }
    return ''; // retain previous if not updated (handled in save)
  }
}

function fillFormFromRecord(r){
  const set = (id,val)=> document.getElementById(id).value = val||'';
  const showImg = (id, dataUrl)=>{
    const img = document.getElementById(id);
    if(dataUrl){ img.src = dataUrl; img.classList.remove('hidden'); }
    else img.classList.add('hidden');
  };
  set('f_v1_capL',r.v1_capL); set('f_v1_sn',r.v1_sn);
  set('f_v1_cap',r.v1_cap||'available'); set('f_v1_cond',r.v1_cond||'ok');
  set('f_v1_agit_loc',r.v1_agit_loc); set('f_v1_cmt',r.v1_cmt);

  set('f_v2_capL',r.v2_capL); set('f_v2_sn',r.v2_sn);
  set('f_v2_cap',r.v2_cap||'na'); set('f_v2_cond',r.v2_cond||'ok');
  set('f_v2_agit_loc',r.v2_agit_loc); set('f_v2_cmt',r.v2_cmt);

  set('f_gw_loc',r.gw_loc); set('f_gw_cmt',r.gw_cmt);

  set('f_sig_spark',r.s_spark||'0'); set('f_sig_onenz',r.s_onenz||'0'); set('f_sig_pref',r.sig_pref||'');

  set('f_tel_brand',r.tel_brand); set('f_tel_type',r.tel_type); set('f_tel_cmt',r.tel_cmt);

  set('f_rw_door',r.rw_door||'notdelivered'); set('f_rw_door_size',r.rw_door_size||''); set('f_rw_door_count',r.rw_door_count||'1');
  set('f_rw_rjt',r.rw_rjt||'notdelivered'); set('f_rw_rjt_size',r.rw_rjt_size||'');

  toggleVat2(); doorDeliveredToggle();

  // photos (data URL fields in r.photos_*)
  showImg('img_v1_cap', r.photos_v1_cap);
  showImg('img_v2_cap', r.photos_v2_cap);
  showImg('img_gw',     r.photos_gateway);
  showImg('img_door',   r.photos_door);
  showImg('img_rjt',    r.photos_rjt);
}

/* ======= Cache <-> Cloud Sync ======= */
async function listCloud() {
  const listRef = storage.ref(PRECHECK_FOLDER);
  const res = await listRef.listAll();
  // count only .json files
  return res.items.filter(x=>x.name.toLowerCase().endsWith('.json'));
}
async function fetchCloudJson(fileRef){
  const url = await fileRef.getDownloadURL();
  const meta = await fileRef.getMetadata();
  const json = await fetch(url).then(r=>r.json());
  // flatten photo fields into separate keys for faster UI
  const r = {...json};
  ['v1_cap','v2_cap','gateway','door','rjt'].forEach(k=>{
    if(json[`${k}-photo-base64`]) r[`photos_${k}`] = json[`${k}-photo-base64`];
  });
  return { dairy: r.dairyNumber || fileRef.name.replace('.json',''), updated: meta.updated, rec: r };
}
async function syncFromCloud(force=false){
  if(state.syncing) return;
  state.syncing = true; setSyncUI(0,0);

  try{
    const items = await listCloud();
    document.getElementById('cloudCount').textContent = items.length;

    const map = new Map(); // dairy -> updated
    (await db.forms.toArray()).forEach(x=>map.set(x.dairy,x.updated));
    document.getElementById('cachedCount').textContent = map.size;

    const toGet = [];
    for(const ref of items){
      const meta = await ref.getMetadata();
      const dairy = ref.name.replace('.json','');
      const cachedUpdated = map.get(dairy)||'';
      if(force || cachedUpdated !== meta.updated) toGet.push(ref);
    }
    document.getElementById('newCount').textContent = toGet.length;

    let done=0; setSyncUI(done,toGet.length);
    for(const batch of chunk(toGet, 6)){ // parallel chunks to be mobile friendly
      await Promise.all(batch.map(async ref=>{
        const {dairy,updated,rec} = await fetchCloudJson(ref);
        await db.forms.put({dairy,updated,json:JSON.stringify(rec)});
      }));
      done += batch.length; setSyncUI(done,toGet.length);
      await sleep(50);
    }
  }catch(e){ console.error(e); }
  finally{
    state.syncing=false;
    await reloadCache();
    if(document.getElementById('panelSummary').classList.contains('hidden')===false) renderSummary();
  }
}
async function reloadCache(){
  const rows = await db.forms.orderBy('dairy').toArray();
  state.cache.clear(); state.farms.length = 0;
  for(const r of rows){
    const obj = JSON.parse(r.json);
    const dairy = obj.dairyNumber || r.dairy;
    state.cache.set(dairy, {...obj});
  }
  state.farms = Array.from(state.cache.values());
}

/* ======= Auto start sync (delta) ======= */
document.addEventListener('DOMContentLoaded', async ()=>{
  await reloadCache();
  renderSummary();
  syncFromCloud(false); // delta
});

/* ======= Form actions ======= */
async function autoFill(){
  const dairy = document.getElementById('f_dairy').value.trim();
  if(!dairy) return;
  const cached = state.cache.get(dairy);
  if(cached){ fillFormFromRecord(cached); return; }
  // fallback direct cloud fetch by file name
  try{
    const ref = storage.ref(`${PRECHECK_FOLDER}/${dairy}.json`);
    const url = await ref.getDownloadURL();
    const json = await fetch(url).then(r=>r.json());
    await db.forms.put({dairy,updated:nowISO(),json:JSON.stringify(json)});
    await reloadCache();
    fillFormFromRecord(state.cache.get(dairy)||{});
  }catch(e){ console.warn('No cloud record for', dairy); }
}
function clearForm(){
  document.querySelectorAll('#panelForm input, #panelForm select').forEach(el=>{
    if(el.type==='file') el.value='';
    else el.value='';
  });
  ['img_v1_cap','img_v2_cap','img_gw','img_door','img_rjt'].forEach(id=>{
    document.getElementById(id).classList.add('hidden');
  });
  toggleVat2();
}
async function saveForm(){
  const rec = toRecordFromForm();
  if(!rec.dairy){ alert('Enter Dairy Number'); return; }

  // merge with existing (keep previous photos if not updated via input)
  const old = state.cache.get(rec.dairy) || {};
  const merged = {...old, ...rec};

  // attach photos base64 if newly selected
  const photoInputs = [
    ['f_v1_cap_photo','photos_v1_cap'],
    ['f_v2_cap_photo','photos_v2_cap'],
    ['f_gw_photo','photos_gateway'],
    ['f_rw_door_photo','photos_door'],
    ['f_rw_rjt_photo','photos_rjt'],
  ];
  for(const [inputId,key] of photoInputs){
    const f = document.getElementById(inputId).files?.[0];
    if(f){
      merged[key] = await fileToDataUrl(f);
    }
  }
  // build cloud json format compatible with older records
  const cloudJson = {
    dairyNumber: merged.dairy,
    'vat1-capacity': merged.v1_capL, 'vat1-serial': merged.v1_sn, 'vat1-cap': merged.v1_cap, 'vat1-condition': merged.v1_cond,
    'vat1-comments': merged.v1_cmt, 'agitator-location': merged.v1_agit_loc,

    'vat2-capacity': merged.v2_capL, 'vat2-serial': merged.v2_sn, 'vat2-cap': merged.v2_cap, 'vat2-condition': merged.v2_cond,
    'vat2-comments': merged.v2_cmt, 'agitator2-location': merged.v2_agit_loc,

    'gateway-location': merged.gw_loc, 'gateway-comments': merged.gw_cmt,

    'spark-bars': merged.s_spark, 'one-nz-bars': merged.s_onenz, 'signal-preferred': merged.sig_pref,

    'telemetry-brand': merged.tel_brand, 'telemetry-type': merged.tel_type, 'telemetry-comments': merged.tel_cmt,

    'vat-door-seal': merged.rw_door, 'door-seal-size': merged.rw_door_size, 'door-seal-count': merged.rw_door_count,
    'rjt-seal': merged.rw_rjt, 'rjt-seal-size': merged.rw_rjt_size,

    'vat1-cap-photo-base64': merged.photos_v1_cap || old.photos_v1_cap || '',
    'vat2-cap-photo-base64': merged.photos_v2_cap || old.photos_v2_cap || '',
    'gateway-photo-base64': merged.photos_gateway || old.photos_gateway || '',
    'vat-door-seal-photo-base64': merged.photos_door || old.photos_door || '',
    'rjt-seal-photo-base64': merged.photos_rjt || old.photos_rjt || '',
    updated: nowISO()
  };

  // save cache first for instant UI
  await db.forms.put({dairy: rec.dairy, updated: cloudJson.updated, json: JSON.stringify(cloudJson)});
  await reloadCache();
  renderSummary();

  // push to cloud
  const blob = new Blob([JSON.stringify(cloudJson)], {type:'application/json'});
  await storage.ref(`${PRECHECK_FOLDER}/${rec.dairy}.json`).put(blob);

  alert('Saved.');
}
function fileToDataUrl(file){ return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);}); }

/* ======= Summary rendering ======= */
function applyFilters(){ renderSummary(); }
function clearFilters(){ document.getElementById('q').value=''; state.filter=null; renderSummary(); }
function focusFilter(which){ state.filter = which; renderSummary(); }

function aiFeaturesFrom(rec){
  const blobs = [
    rec['vat1-comments'], rec['vat2-comments'], rec['gateway-comments'],
    rec['telemetry-comments'], rec['signal-comments'],
    rec.v1_cmt, rec.v2_cmt, rec.gw_cmt, rec.tel_cmt
  ].filter(Boolean).join(' • ');

  // classify
  const dts = N.hasDtsCap(blobs) || /available.+cap/i.test((rec['vat1-cap']||'')) || /available.+cap/i.test((rec['vat2-cap']||''));
  const pp  = N.needsPowerPoint(blobs) || /power ?point.*(recommended|needed|required)/i.test(blobs);
  const pref = (rec['signal-preferred']||'').toLowerCase() || N.signalPref({
    s_spark: rec['spark-bars']||rec.s_spark, s_onenz: rec['one-nz-bars']||rec.s_onenz, sig_pref: rec.sig_pref
  });
  const doorDelivered = (rec['vat-door-seal']||rec.rw_door)==='delivered';
  const doorSize = (rec['door-seal-size']||rec.rw_door_size||'').toLowerCase();
  const doorCount = Number(rec['door-seal-count']||rec.rw_door_count|| (rec['vat2-capacity']?2:1) );

  return {dts, pp, pref, doorDelivered, doorSize, doorCount};
}

function farmCardHTML(rec){
  const dairy = rec.dairyNumber || rec.dairy;
  const sig = `Spark ${rec['spark-bars']||rec.s_spark||0} bars • One NZ ${rec['one-nz-bars']||rec.s_onenz||0} bars • Pref ${(rec['signal-preferred']||rec.sig_pref||'—')}`;
  const v1 = `${rec['vat1-capacity']||rec.v1_capL||'—'} L • Cap ${rec['vat1-cap']||rec.v1_cap||'na'} • Cond ${rec['vat1-condition']||rec.v1_cond||'ok'} • SN ${rec['vat1-serial']||rec.v1_sn||'—'}`;
  const v2cap = rec['vat2-capacity']||rec.v2_capL;
  const v2 = `${v2cap? v2cap : '—'} L • Cap ${(rec['vat2-cap']||rec.v2_cap||'na')} • Cond ${(rec['vat2-condition']||rec.v2_cond||'ok')} • SN ${(rec['vat2-serial']||rec.v2_sn||'—')}`;
  const doorSeal = (rec['vat-door-seal']||rec.rw_door||'notdelivered');
  const doorSize  = (rec['door-seal-size']||rec.rw_door_size||'unspecified');
  const doorCount = (rec['door-seal-count']||rec.rw_door_count||'x1');

  const p1 = rec['vat1-cap-photo-base64']||rec.photos_v1_cap;
  const p2 = rec['gateway-photo-base64']||rec.photos_gateway;
  const p3 = rec['vat2-cap-photo-base64']||rec.photos_v2_cap;
  const p4 = rec['vat-door-seal-photo-base64']||rec.photos_door;

  return `
  <div class="farm-card">
    <div class="d-flex justify-content-between align-items-start">
      <h5 class="m-0">#${dairy}</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" onclick="printOne('${dairy}')">Print</button>
        <button class="btn btn-sm btn-primary" onclick="refreshOne('${dairy}')">Refresh</button>
      </div>
    </div>
    <div>Vat 1: ${v1}</div>
    <div>Vat 2: ${v2}</div>
    <div>Signal: ${sig}</div>
    <div>Rubberware: Door seal ${doorSeal} (${doorSize}, ${doorCount}) • RJT ${(rec['rjt-seal']||rec.rw_rjt||'notdelivered')}</div>
    <div class="mt-2 photo-grid">
      ${p1? `<div><div class="smallmuted">Vat 1</div><img src="${p1}"/></div>`:''}
      ${p3? `<div><div class="smallmuted">Vat 2</div><img src="${p3}"/></div>`:''}
      ${p2? `<div><div class="smallmuted">Gateway</div><img src="${p2}"/></div>`:''}
      ${p4? `<div><div class="smallmuted">Door seal</div><img src="${p4}"/></div>`:''}
    </div>
  </div>`;
}

function renderSummary(){
  const farms = state.farms;
  if(!farms.length){ document.getElementById('farmsList').innerHTML = '<div class="smallmuted">No cached farms yet. Syncing…</div>'; return; }

  // KPI compute
  let dts=0, pp=0, spk=0, onz=0, door=0;
  const sizes = new Set();
  farms.forEach(f=>{
    const F = aiFeaturesFrom(f);
    if(F.dts) dts++;
    if(F.pp) pp++;
    if(F.pref==='spark') spk++;
    if(F.pref==='one nz') onz++;
    if(F.doorDelivered) door += Number(F.doorCount||1);
    const v1 = Number(f['vat1-capacity']||f.v1_capL||0); if(v1) sizes.add(v1);
    const v2 = Number(f['vat2-capacity']||f.v2_capL||0); if(v2) sizes.add(v2);
  });
  document.getElementById('k_dts').textContent = dts;
  document.getElementById('k_pp').textContent = pp;
  document.getElementById('k_spark').textContent = spk;
  document.getElementById('k_onenz').textContent = onz;
  document.getElementById('k_door').textContent = door;
  document.getElementById('k_sizes').textContent = sizes.size;

  // Filtering
  const q = (document.getElementById('q').value||'').toLowerCase();
  const which = state.filter;
  let list = farms.filter(f=>{
    const dairy = (f.dairyNumber||f.dairy||'').toString();
    const text = JSON.stringify(f).toLowerCase();
    const passQ = !q || dairy.includes(q) || text.includes(q);
    if(!passQ) return false;
    if(!which) return true;
    const F = aiFeaturesFrom(f);
    if(which==='dts') return F.dts;
    if(which==='pp') return F.pp;
    if(which==='spark') return F.pref==='spark';
    if(which==='onenz') return F.pref==='one nz';
    if(which==='door') return F.doorDelivered;
    return true;
  });

  // Render farm cards (incrementally to avoid iOS crash)
  const el = document.getElementById('farmsList');
  el.innerHTML = `<div class="smallmuted mb-2">Showing ${list.length} farms</div>`;
  (async()=>{
    for(const group of chunk(list, 10)){
      const html = group.map(farmCardHTML).join('');
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      el.appendChild(wrapper);
      await sleep(10);
    }
  })();
}

/* ======= CSV export ======= */
function exportVatCsv(){
  const rows = [['Dairy','Vat','Size(L)','Serial','Maker Guess','Cap']];
  state.farms.forEach(f=>{
    const maker1 = N.makerGuess((f['vat1-comments']||f.v1_cmt||'') + ' ' + (f['vat1-serial']||f.v1_sn||''));
    if(f['vat1-capacity']||f.v1_capL){
      rows.push([f.dairyNumber||f.dairy,'1',f['vat1-capacity']||f.v1_capL, f['vat1-serial']||f.v1_sn, maker1, f['vat1-cap']||f.v1_cap||'']);
    }
    const maker2 = N.makerGuess((f['vat2-comments']||f.v2_cmt||'') + ' ' + (f['vat2-serial']||f.v2_sn||''));
    if(f['vat2-capacity']||f.v2_capL){
      rows.push([f.dairyNumber||f.dairy,'2',f['vat2-capacity']||f.v2_capL, f['vat2-serial']||f.v2_sn, maker2, f['vat2-cap']||f.v2_cap||'']);
    }
  });
  const csv = rows.map(r=>r.map(x=>`"${(x??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = 'vat_sizes.csv'; a.click();
}

/* ======= Print (brochure) ======= */
async function printOne(dairy){
  const rec = state.farms.find(f=>(f.dairyNumber||f.dairy)==dairy);
  if(!rec) return;
  openPrint(rec);
}
function printFarm(){
  const dairy = document.getElementById('f_dairy').value.trim();
  if(!dairy) return;
  const rec = state.farms.find(f=>(f.dairyNumber||f.dairy)==dairy);
  if(rec) openPrint(rec);
}
async function openPrint(rec){
  const logo = document.getElementById('agoraLogo').src || '';
  const win = window.open('','_blank');
  const p1 = rec['vat1-cap-photo-base64']||rec.photos_v1_cap||'';
  const p2 = rec['vat2-cap-photo-base64']||rec.photos_v2_cap||'';
  const p3 = rec['gateway-photo-base64']||rec.photos_gateway||'';
  const p4 = rec['vat-door-seal-photo-base64']||rec.photos_door||'';
  const vd = (rec['vat-door-seal']||'notdelivered') + ' • ' + (rec['door-seal-size']||'unspecified') + ' • ' + (rec['door-seal-count']||'x1');
  const sig = `Spark ${(rec['spark-bars']||0)} bars • One NZ ${(rec['one-nz-bars']||0)} bars • Pref ${(rec['signal-preferred']||'—')}`;

  win.document.write(`
  <html><head><meta charset="utf-8"><title>Pre-Check #${rec.dairyNumber||rec.dairy}</title>
  <style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:24px}
  .hd{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #e5e7eb;margin-bottom:14px}
  .hd img{height:40px}
  h2{margin:10px 0}
  .kv{display:flex;gap:10px;margin:4px 0}
  .k{width:120px;color:#6b7280}
  .photos{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .photos img{width:100%;height:180px;object-fit:cover;border:1px solid #e5e7eb;border-radius:6px}
  @media print {.no-print{display:none}}
  </style></head><body>
    <div class="hd"><div><img src="${logo}"></div><div>#${rec.dairyNumber||rec.dairy}</div></div>
    <h2>Key Facts</h2>
    <div class="kv"><div class="k">Vat 1</div><div>${rec['vat1-capacity']||'—'} L • Cap ${rec['vat1-cap']||'na'} • Cond ${rec['vat1-condition']||'ok'} • SN ${rec['vat1-serial']||'—'}</div></div>
    <div class="kv"><div class="k">Vat 2</div><div>${rec['vat2-capacity']||'—'} L • Cap ${rec['vat2-cap']||'na'} • Cond ${rec['vat2-condition']||'ok'} • SN ${rec['vat2-serial']||'—'}</div></div>
    <div class="kv"><div class="k">Gateway</div><div>${rec['gateway-location']||'—'}</div></div>
    <div class="kv"><div class="k">Signal</div><div>${sig}</div></div>
    <div class="kv"><div class="k">Telemetry</div><div>${rec['telemetry-brand']||'—'} • ${rec['telemetry-type']||'—'}</div></div>
    <div class="kv"><div class="k">Rubberware</div><div>${vd} • RJT ${(rec['rjt-seal']||'notdelivered')} ${(rec['rjt-seal-size']||'')}</div></div>

    <div class="photos">
      ${p1? `<div><div class="small">Vat 1</div><img src="${p1}"></div>`:''}
      ${p2? `<div><div class="small">Vat 2</div><img src="${p2}"></div>`:''}
      ${p3? `<div><div class="small">Gateway</div><img src="${p3}"></div>`:''}
      ${p4? `<div><div class="small">Door Seal</div><img src="${p4}"></div>`:''}
    </div>

    <div class="no-print" style="margin-top:14px"><button onclick="window.print()">Print</button></div>
  </body></html>`);
  win.document.close();
}

/* ======= Admin helpers ======= */
async function clearCache(){
  await db.forms.clear();
  await reloadCache();
  renderSummary();
}
async function exportAll(){
  const all = await db.forms.toArray();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(all,null,2)],{type:'application/json'}));
  a.download = 'precheck_cache.json'; a.click();
}
async function refreshOne(dairy){
  try{
    const ref = storage.ref(`${PRECHECK_FOLDER}/${dairy}.json`);
    const meta = await ref.getMetadata();
    const {rec} = await fetchCloudJson(ref);
    await db.forms.put({dairy,updated:meta.updated,json:JSON.stringify(rec)});
    await reloadCache();
    renderSummary();
  }catch(e){ console.error('refreshOne',e); }
}

/* ======= Small utilities for test ======= */
window.syncFromCloud = syncFromCloud;
</script>
</body>
</html>