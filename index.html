<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Agora Vat Pre-Check</title>

<!-- Fonts & CSS -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">

<style>
/* =========================================================================================
   DESIGN SYSTEM
   =======================================================================================*/
:root{
  --brand:#001F3F;
  --accent:#FF851B;
  --muted:#6b7280;
  --bg:#f7f8fb;
  --ink:#0f172a;
  --ok:#22c55e;
  --warn:#ffb020;
  --bad:#ff4136;
}
html,body{background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
.app{max-width:1180px;margin:28px auto;padding:0 16px}

/* Header */
.brand-header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
.brand-logo{width:160px;height:auto;display:none}
.brand-title h1{margin:0;font-weight:800;color:var(--brand);letter-spacing:.1px}
.brand-sub{color:var(--muted);font-size:.95rem;margin-top:2px}

/* Tabs */
.top-tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 18px}
.tab-btn{border:1px solid #e5e7eb;background:#fff;color:#111827;border-radius:10px;padding:10px 14px;font-weight:700}
.tab-btn.active{border-color:var(--accent);box-shadow:0 0 0 3px #ff851b2b}

/* Utility bars & cards */
.bar{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin:10px 0}
.section-title{font-weight:800;margin:6px 0 10px}
.small{color:var(--muted)}
.badge-soft{border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:.8rem}

/* Sticky progress */
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.progress{height:10px}
.pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff}

/* KPI cards */
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px;cursor:pointer}
.kpi .num{font-size:1.5rem;font-weight:800}
.kpi .label{color:#6b7280;font-size:.9rem}
.kpi:active{transform:scale(.996)}

/* Farm list cards */
.list{display:grid;grid-template-columns:1fr;gap:10px}
.row-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px}
.row-flex{display:flex;gap:10px;justify-content:space-between;align-items:center}
.row-actions .btn{min-width:84px}

/* Photo thumbnails (summary cards) */
.media-line{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.thumb{width:86px;height:70px;border:1px solid #e5e7eb;border-radius:8px;object-fit:cover}

/* FORM (kept lean but complete) */
.form-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin-bottom:12px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}
label.form-label{font-weight:600}
.photo-thumb{width:110px;height:86px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;margin-top:6px}
.sticky-actions{position:sticky;bottom:8px;display:flex;gap:8px;flex-wrap:wrap}

/* Buttons */
.btn-brand{background:var(--accent);border:none;color:#fff;font-weight:800}
.btn-brand:hover{background:#ff6d00}
.btn-outline-brand{border:1px solid var(--accent);color:var(--accent);background:#fff}
.btn-outline-brand:hover{background:var(--accent);color:#fff}

/* Brochure print layout (customer-ready) */
.print-sheet{max-width:900px;margin:0 auto;color:#0f172a}
.print-head{display:flex;align-items:center;gap:16px;border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:10px}
.print-head img{height:44px}
.print-title{font-weight:800;font-size:1.2rem}
.print-sub{color:#6b7280}
.print-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.print-card{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.print-label{font-weight:700;margin-bottom:6px}
.print-photos img{width:100%;max-height:180px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;margin-bottom:8px}

/* Helpers */
.hidden{display:none!important}
.footer{color:#6b7280;text-align:center;margin:22px 0 10px}
hr.sep{border:0;border-top:1px solid #e5e7eb;margin:12px 0}
</style>
</head>
<body>
<div class="app">
  <!-- =====================================================================================
       HEADER
       ===================================================================================-->
  <div class="brand-header">
    <img id="logo" class="brand-logo" alt="Agora Logo">
    <div class="brand-title">
      <h1>Agora Vat Pre-Check</h1>
      <div class="brand-sub">Fast field capture • Smart summary • Customer-ready output</div>
    </div>
  </div>

  <!-- =====================================================================================
       TABS + PROGRESS
       ===================================================================================-->
  <div class="top-tabs">
    <button id="tab-form" class="tab-btn">Form</button>
    <button id="tab-summary" class="tab-btn active">Summary</button>
    <button id="tab-admin" class="tab-btn">Admin</button>
    <div class="ms-auto controls">
      <span class="pill"><span class="small">Cloud</span><b id="cloud-count">–</b></span>
      <span class="pill"><span class="small">Loaded</span><b id="loaded-count">0</b></span>
      <div class="progress" style="width:180px"><div id="load-bar" class="progress-bar" style="width:0%"></div></div>
      <span id="load-pct" class="small">0%</span>
    </div>
  </div>

  <!-- =====================================================================================
       SUMMARY VIEW
       ===================================================================================-->
  <div id="view-summary">
    <!-- Filters + KPI -->
    <div class="bar">
      <div class="section-title mb-3">Overview</div>
      <div class="controls mb-3">
        <input id="search" class="form-control" placeholder="Search dairy # or text…" style="max-width:360px">
        <button id="btn-clear" class="btn btn-outline-secondary">Clear</button>
      </div>
      <div class="kpi-grid">
        <div class="kpi" data-filter="dts"><div class="num" id="kpi-dts">0</div><div class="label">DTS / vent caps</div></div>
        <div class="kpi" data-filter="power"><div class="num" id="kpi-power">0</div><div class="label">Farms needing power point</div></div>
        <div class="kpi" data-filter="rubber"><div class="num" id="kpi-rubber">0</div><div class="label">Rubberware delivered</div></div>
      </div>
    </div>

    <!-- Live vat size table -->
    <div class="bar">
      <div class="section-title">Vat Size Breakdown (live from cloud)</div>
      <div id="size-table" class="small">Starting…</div>
      <button id="btn-export-sizes" class="btn btn-outline-brand mt-2">Export Sizes CSV</button>
    </div>

    <!-- Results list + bulk actions -->
    <div class="bar">
      <div class="section-title">Results</div>
      <div class="d-flex flex-wrap gap-2 mb-2">
        <button id="btn-print-all" class="btn btn-brand">Print All Brochures</button>
        <button id="btn-zip-all" class="btn btn-outline-brand">Download All Brochures (ZIP)</button>
      </div>
      <div id="result-list" class="list"></div>
    </div>
  </div>

  <!-- =====================================================================================
       FORM VIEW (Autofill from cloud + print single)
       ===================================================================================-->
  <div id="view-form" class="hidden">
    <div class="form-card">
      <div class="grid-3">
        <div>
          <label class="form-label">Dairy Number</label>
          <input class="form-control" id="dairyNumber" placeholder="e.g. 7031">
          <div class="small">Blur to auto-load from cloud (includes photos if embedded).</div>
        </div>
        <div>
          <label class="form-label">Gateway Location</label>
          <input class="form-control" id="gateway-location">
        </div>
        <div>
          <label class="form-label">Gateway Photo</label>
          <input id="gateway-photo" type="file" accept="image/*" class="form-control">
          <img id="gateway-preview" class="photo-thumb d-none" alt="">
        </div>
      </div>
    </div>

    <!-- Vat 1 -->
    <div class="form-card">
      <h6 class="mb-2">Vat 1</h6>
      <div class="grid-3">
        <div><label class="form-label">Capacity (L)</label><input class="form-control" id="vat1-capacity"></div>
        <div>
          <label class="form-label">Cap</label>
          <select class="form-select" id="vat1-cap">
            <option value="available">Available ✓</option>
            <option value="unavailable">Unavailable ✗</option>
          </select>
        </div>
        <div>
          <label class="form-label">Cap Photo</label>
          <input id="vat1-cap-photo" type="file" accept="image/*" class="form-control">
          <img id="vat1-cap-preview" class="photo-thumb d-none" alt="">
        </div>

        <div><label class="form-label">Serial</label><input class="form-control" id="vat1-serial"></div>
        <div>
          <label class="form-label">Condition</label>
          <select class="form-select" id="vat1-condition">
            <option value="ok">OK</option>
            <option value="attention">Attention</option>
          </select>
        </div>
        <div><label class="form-label">Condition Comments</label><input class="form-control" id="vat1-condition-comments"></div>

        <div class="col-12"><label class="form-label">Comments</label><input class="form-control" id="vat1-comments"></div>
        <div><label class="form-label">Agitator Location</label><input class="form-control" id="agitator1-location"></div>
        <div>
          <label class="form-label">Agitator Photo</label>
          <input id="agitator1-photo" type="file" accept="image/*" class="form-control">
          <img id="agitator1-preview" class="photo-thumb d-none" alt="">
        </div>
      </div>
    </div>

    <!-- Vat 2 capacity -->
    <div class="form-card">
      <h6 class="mb-2">Vat 2 – Capacity</h6>
      <div class="grid-3">
        <div>
          <label class="form-label">Capacity (L)</label>
          <input class="form-control" id="vat2-capacity" placeholder="leave blank if N/A">
          <div class="small">Entering a value reveals Vat 2 details</div>
        </div>
      </div>
    </div>

    <!-- Vat 2 details -->
    <div class="form-card hidden" id="vat2-extra">
      <h6 class="mb-2">Vat 2</h6>
      <div class="grid-3">
        <div>
          <label class="form-label">Cap</label>
          <select class="form-select" id="vat2-cap">
            <option value="na" selected>N/A</option>
            <option value="available">Available ✓</option>
            <option value="unavailable">Unavailable ✗</option>
          </select>
        </div>
        <div>
          <label class="form-label">Cap Photo</label>
          <input id="vat2-cap-photo" type="file" accept="image/*" class="form-control">
          <img id="vat2-cap-preview" class="photo-thumb d-none" alt="">
        </div>
        <div><label class="form-label">Serial</label><input class="form-control" id="vat2-serial"></div>

        <div>
          <label class="form-label">Condition</label>
          <select class="form-select" id="vat2-condition">
            <option value="ok">OK</option>
            <option value="attention">Attention</option>
          </select>
        </div>
        <div><label class="form-label">Condition Comments</label><input class="form-control" id="vat2-condition-comments"></div>

        <div class="col-12"><label class="form-label">Comments</label><input class="form-control" id="vat2-comments"></div>
        <div><label class="form-label">Agitator Location</label><input class="form-control" id="agitator2-location"></div>
        <div>
          <label class="form-label">Agitator Photo</label>
          <input id="agitator2-photo" type="file" accept="image/*" class="form-control">
          <img id="agitator2-preview" class="photo-thumb d-none" alt="">
        </div>
      </div>
    </div>

    <!-- Mobile signal -->
    <div class="form-card">
      <h6 class="mb-2">Mobile Signal</h6>
      <div class="grid-3">
        <div><label class="form-label">Spark (bars)</label><input class="form-control" id="spark-bars"></div>
        <div><label class="form-label">Spark Note</label><input class="form-control" id="spark-note"></div>
        <div><label class="form-label">One NZ (bars)</label><input class="form-control" id="one-bars"></div>
        <div><label class="form-label">One NZ Note</label><input class="form-control" id="one-note"></div>
      </div>
    </div>

    <!-- Other telemetry -->
    <div class="form-card">
      <h6 class="mb-2">Other Telemetry</h6>
      <div class="grid-3">
        <div><label class="form-label">Brand</label><input class="form-control" id="other-brand" placeholder="Halo • Levno • DTS • NDA"></div>
        <div>
          <label class="form-label">Type</label>
          <select id="other-type" class="form-select">
            <option value="">Select…</option>
            <option value="vat">Vat</option>
            <option value="water">Water</option>
            <option value="fuel">Fuel</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div><label class="form-label">Notes</label><input class="form-control" id="other-notes"></div>
      </div>
      <div class="grid-3 mt-2">
        <div><label class="form-label">Current Telemetry (legacy)</label><input class="form-control" id="current-telemetry"></div>
        <div class="col-12"><label class="form-label">Telemetry Comments</label><input class="form-control" id="telemetry-comments"></div>
      </div>
    </div>

    <!-- Rubberware -->
    <div class="form-card">
      <h6 class="mb-2">Rubberware</h6>
      <div class="grid-3">
        <div>
          <label class="form-label">Door Seal Delivered?</label>
          <select class="form-select" id="door-delivered">
            <option value="no">No</option>
            <option value="yes">Yes</option>
            <option value="delivered">Delivered</option>
          </select>
        </div>
        <div>
          <label class="form-label">Door Seal Size</label>
          <select class="form-select" id="door-size">
            <option value="">Select…</option>
            <option value="small">Small</option>
            <option value="large">Large</option>
          </select>
        </div>
        <div>
          <label class="form-label">Door Seal Photo</label>
          <input id="door-photo" type="file" accept="image/*" class="form-control">
          <img id="door-preview" class="photo-thumb d-none" alt="">
        </div>

        <div>
          <label class="form-label">RJT Delivered?</label>
          <select class="form-select" id="rjt-delivered">
            <option value="no">No</option>
            <option value="yes">Yes</option>
            <option value="delivered">Delivered</option>
          </select>
        </div>
        <div>
          <label class="form-label">RJT Size</label>
          <select class="form-select" id="rjt-size">
            <option value="">Select…</option>
            <option value="small">Small</option>
            <option value="large">Large</option>
          </select>
        </div>
        <div>
          <label class="form-label">RJT Photo</label>
          <input id="rjt-photo" type="file" accept="image/*" class="form-control">
          <img id="rjt-preview" class="photo-thumb d-none" alt="">
        </div>
      </div>
    </div>

    <div class="sticky-actions">
      <button id="btn-print-one" class="btn btn-outline-brand">Print This Farm</button>
      <button id="btn-to-summary" class="btn btn-outline-secondary">Back to Summary</button>
    </div>
  </div>

  <!-- =====================================================================================
       ADMIN VIEW
       ===================================================================================-->
  <div id="view-admin" class="hidden">
    <div class="bar">
      <div class="section-title">Admin</div>
      <div class="small">Streaming from cloud; Service Worker caches the shell for offline display.</div>
      <div class="mt-2 d-flex gap-2">
        <button id="btn-reload" class="btn btn-brand">Reload Summary</button>
        <button id="btn-clear-sw" class="btn btn-outline-brand">Reset SW Cache</button>
      </div>
      <hr class="sep">
      <div class="small"><b>Tip:</b> To test offline brochure viewing, open a farm, then go offline and open its details again. Brochures are simple HTML—safe to save from ZIP and share.</div>
    </div>
  </div>

  <div class="footer">Agora • Vat Pre-Check • v4.3</div>
</div>

<!-- Libraries -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
/* =========================================================================================
   FIREBASE INIT
   =======================================================================================*/
firebase.initializeApp({
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
});
const storage = firebase.storage();
const FOLDER  = 'Pre Check';

/* =========================================================================================
   DOM HELPERS & STATE
   =======================================================================================*/
const $ = id => document.getElementById(id);
const N = v => v==null ? '' : String(v);
const low = s => N(s).toLowerCase();
let LOGO_URL = '';
let MANIFEST = [];
const RECORDS = new Map();        // dn -> record json
const sizeCounts = new Map();     // numeric size -> count
const KPIs = { dts:0, power:0, rubber:0 };

function setPct(done,total){ const p = total? Math.floor(done/total*100):0; $('load-bar').style.width=p+'%'; $('load-pct').textContent=p+'%'; $('loaded-count').textContent=done; }
function bump(m,k){ m.set(k,(m.get(k)||0)+1) }
function clearNode(n){ while(n.firstChild) n.removeChild(n.firstChild) }

/* =========================================================================================
   BRAND LOGO
   =======================================================================================*/
(async()=>{ try{ LOGO_URL = await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL(); $('logo').src = LOGO_URL; $('logo').style.display='block'; }catch(e){} })();

/* =========================================================================================
   FIELD MAPPING (legacy + new)
   =======================================================================================*/
function pick(obj, ...keys){ for(const k of keys){ if(obj && obj[k]!=null && obj[k]!=='' ) return obj[k] } return '' }
function normCap(v){ const t=low(v); if(/unavailable|no|✗/.test(t)) return 'unavailable'; if(/available|yes|✓/.test(t)) return 'available'; if(/na|n\/a/.test(t)) return 'na'; return v||'' }
function doorDelivered(rec){ return /yes|delivered/i.test(N(pick(rec,'door-delivered','vat-door-seal'))) }
function rjtDelivered(rec){  return /yes|delivered/i.test(N(pick(rec,'rjt-delivered','rjt-seal'))) }
function doorSize(rec){ return pick(rec,'door-size','vat-door-seal-size') }
function rjtSize(rec){  return pick(rec,'rjt-size','rjt-seal-size') }
function normSizeNumeric(s){ const m=N(s).match(/(\d{3,6})/); return m? m[1] : '' }
function photoOf(rec, which){
  const map={
    gateway:['gateway-photo-base64'],
    v1cap:['vat1-cap-photo-base64'],
    v1agit:['agitator1-photo-base64','agitator-photo-base64'],
    v2cap:['vat2-cap-photo-base64'],
    v2agit:['agitator2-photo-base64'],
    door:['door-photo-base64','vat-door-seal-photo-base64'],
    rjt:['rjt-photo-base64','rjt-seal-photo-base64']
  };
  for(const k of (map[which]||[])){ if(rec[k]) return rec[k] }
  return '';
}
function manufacturerGuess(rec){
  const blob = low([rec['vat1-comments'],rec['vat2-comments'],rec['other-brand'],rec['current-telemetry']].join(' '));
  if(/\bdts\b/.test(blob)) return 'DTS';
  if(/\bnda\b/.test(blob)) return 'NDA';
  if(/\bhalo\b/.test(blob)) return 'Halo';
  if(/\blevno\b/.test(blob)) return 'Levno';
  return pick(rec,'other-brand') || '';
}
function needsPower(rec){ return /(power\s*point|splitter\s*plug|double\s*adapter)/i.test(JSON.stringify(rec)) }
function hasDts(rec){
  const b=low(JSON.stringify(rec));
  return /\bdts\b/.test(b) || /(grey|gray)\s+halo/.test(b) || /vent\s*cap|cap\s*available/.test(b);
}

/* =========================================================================================
   SUMMARY LOAD (streamed with concurrency + immediate skeleton)
   =======================================================================================*/
async function listCloud(){
  const res = await storage.ref(FOLDER).listAll();
  const keys = res.items.filter(i=>/\.json$/i.test(i.name)).map(i=>i.name);
  $('cloud-count').textContent = keys.length;
  return keys;
}
function skeleton(keys){
  const html = keys.sort().map(k=>{
    const dn=k.replace('.json','');
    return `
      <div class="row-card" id="row-${dn}">
        <div class="row-flex">
          <div>
            <strong>#${dn}</strong> <span class="badge-soft small">loading…</span>
          </div>
          <div class="row-actions">
            <button class="btn btn-sm btn-outline-secondary" disabled>Details</button>
            <button class="btn btn-sm btn-outline-secondary" disabled>Print</button>
          </div>
        </div>
      </div>`;
  }).join('');
  $('result-list').innerHTML = html;
}
function updateSizesTable(){
  let html = '<table class="table table-sm table-bordered mb-0"><thead><tr><th>Vat Size (L)</th><th>Count</th></tr></thead><tbody>';
  [...sizeCounts.entries()].sort((a,b)=>parseInt(a[0])-parseInt(b[0])).forEach(([sz,c])=>{
    html += `<tr><td>${sz}</td><td>${c}</td></tr>`;
  });
  $('size-table').innerHTML = html + '</tbody></table>';
}
function refreshKPI(){
  $('kpi-dts').textContent = KPIs.dts;
  $('kpi-power').textContent = KPIs.power;
  $('kpi-rubber').textContent = KPIs.rubber;
}
function cardHTML(rec){
  const dn=rec.dairyNumber;
  const v1=N(pick(rec,'vat1-capacity'))||'—';
  const v2=N(pick(rec,'vat2-capacity'))||'';
  const cap1=normCap(pick(rec,'vat1-cap'));
  const cap2=normCap(pick(rec,'vat2-cap'));
  const seals=`${doorDelivered(rec)?'Door ✔':'Door —'} • ${rjtDelivered(rec)?'RJT ✔':'RJT —'}`;

  // small media strip (up to 3 photos)
  const media=[photoOf(rec,'gateway'),photoOf(rec,'v1cap'),photoOf(rec,'v1agit'),photoOf(rec,'v2cap'),photoOf(rec,'v2agit'),photoOf(rec,'door'),photoOf(rec,'rjt')]
    .filter(Boolean).slice(0,3).map(src=>`<img src="${src}" class="thumb" alt="">`).join('');

  return `
    <div class="row-flex">
      <div style="flex:1">
        <div><strong>#${dn}</strong> <span class="badge-soft small">${v1}${v2? ' • '+v2:''}</span></div>
        <div class="small">Caps: V1 ${cap1||'—'}${v2? ' · V2 '+(cap2||'—'):''}</div>
        <div class="small">Seals: ${seals}</div>
        ${media? `<div class="media-line">${media}</div>`:''}
      </div>
      <div class="row-actions">
        <button class="btn btn-sm btn-outline-brand" onclick="openDetails('${dn}')">Details</button>
        <button class="btn btn-sm btn-brand" onclick="openPrint('${dn}')">Print</button>
      </div>
    </div>`;
}
async function hydrate(keys){
  const total=keys.length; let done=0;
  // 8 concurrent fetchers
  const q=keys.slice();
  const workers=8;

  async function worker(){
    while(q.length){
      const key=q.shift(); const dn=key.replace('.json','');
      try{
        const url=await storage.ref(`${FOLDER}/${key}`).getDownloadURL();
        const rec=await fetch(url).then(r=>r.json());
        rec.dairyNumber = rec.dairyNumber || dn;
        RECORDS.set(dn, rec);

        // sizes
        const s1=normSizeNumeric(pick(rec,'vat1-capacity')); if(s1) bump(sizeCounts,s1);
        const s2=normSizeNumeric(pick(rec,'vat2-capacity')); if(s2) bump(sizeCounts,s2);
        updateSizesTable();

        // KPIs
        if(hasDts(rec)) KPIs.dts++;
        if(needsPower(rec)) KPIs.power++;
        if(doorDelivered(rec)||rjtDelivered(rec)) KPIs.rubber++;
        refreshKPI();

        // replace skeleton row
        const row=$('row-'+dn);
        if(row) row.innerHTML = cardHTML(rec);
      }catch(e){
        const row=$('row-'+dn);
        if(row) row.innerHTML = `<div class="small text-danger">#${dn} failed to load.</div>`;
      }finally{
        done++; setPct(done,total);
      }
    }
  }
  await Promise.all(new Array(workers).fill(0).map(worker));
}

async function startSummary(){
  if(MANIFEST.length){ applySearch(); return; }
  try{
    MANIFEST = await listCloud();
    skeleton(MANIFEST);         // show dairy numbers immediately
    await hydrate(MANIFEST);    // progressively fills
  }catch(e){
    $('result-list').innerHTML = '<div class="small text-danger">Failed to load. Check connectivity.</div>';
  }
}

/* =========================================================================================
   SEARCH & KPI FILTER
   =======================================================================================*/
function applySearch(){
  const term=low($('search').value);
  document.querySelectorAll('#result-list .row-card').forEach(card=>{
    card.style.display = (!term || low(card.textContent).includes(term)) ? '' : 'none';
  });
}
$('search').addEventListener('input',applySearch);
$('btn-clear').onclick=()=>{$('search').value='';applySearch()};

document.addEventListener('click',e=>{
  const k = e.target.closest('.kpi'); if(!k) return;
  const type = k.dataset.filter;
  let pred = ()=>true;
  if(type==='dts')    pred=(r)=>hasDts(r);
  if(type==='power')  pred=(r)=>needsPower(r);
  if(type==='rubber') pred=(r)=>doorDelivered(r)||rjtDelivered(r);
  for(const [dn,rec] of RECORDS){ $('row-'+dn).style.display = pred(rec)? '' : 'none' }
});

/* =========================================================================================
   BROCHURE (customer-ready, keeps your layout, includes ALL comments + photos)
   =======================================================================================*/
function p(label,src){ return src?`<div class="print-card"><div class="print-label">${label}</div><div class="print-photos"><img src="${src}" alt=""></div></div>`:'' }
function brochureHTML(rec){
  const doorCount = doorDelivered(rec) ? (pick(rec,'vat2-capacity')?2:1) : 0;
  return `
  <div class="print-sheet">
    <div class="print-head">
      <img src="${LOGO_URL||''}" alt="logo">
      <div>
        <div class="print-title">Vat Pre-Check – #${rec.dairyNumber||''}</div>
        <div class="print-sub">Brand: ${manufacturerGuess(rec)||'-'} • Spark: ${pick(rec,'spark-bars')||'-'} • One NZ: ${pick(rec,'one-bars')||'-'}</div>
      </div>
    </div>

    <div class="print-grid">
      <div class="print-card">
        <div class="print-label">Vat 1</div>
        <div>Capacity: <b>${pick(rec,'vat1-capacity')||'-'}</b></div>
        <div>Cap: <b>${(normCap(pick(rec,'vat1-cap'))||'-').toUpperCase()}</b></div>
        <div>Serial: <b>${pick(rec,'vat1-serial')||'-'}</b></div>
        <div>Condition: <b>${pick(rec,'vat1-condition')||'-'}</b> ${pick(rec,'vat1-condition-comments')? '• '+pick(rec,'vat1-condition-comments'):''}</div>
        <div>Agitator: ${pick(rec,'agitator1-location','agitator-location')||'-'}</div>
        <div>Notes: ${pick(rec,'vat1-comments')||'-'}</div>
      </div>

      <div class="print-card">
        <div class="print-label">Vat 2</div>
        <div>Capacity: <b>${pick(rec,'vat2-capacity')||'-'}</b></div>
        <div>Cap: <b>${(normCap(pick(rec,'vat2-cap'))||'-').toUpperCase()}</b></div>
        <div>Serial: <b>${pick(rec,'vat2-serial')||'-'}</b></div>
        <div>Condition: <b>${pick(rec,'vat2-condition')||'-'}</b> ${pick(rec,'vat2-condition-comments')? '• '+pick(rec,'vat2-condition-comments'):''}</div>
        <div>Agitator: ${pick(rec,'agitator2-location')||'-'}</div>
        <div>Notes: ${pick(rec,'vat2-comments')||'-'}</div>
      </div>

      <div class="print-card">
        <div class="print-label">Gateway</div>
        <div>Location: <b>${pick(rec,'gateway-location')||'-'}</b>${pick(rec,'gateway-comments')? ' • '+pick(rec,'gateway-comments'):''}</div>
      </div>

      <div class="print-card">
        <div class="print-label">Other Telemetry</div>
        <div>Brand: <b>${pick(rec,'other-brand')||'-'}</b> • Type: <b>${pick(rec,'other-type')||'-'}</b></div>
        <div>Notes: ${pick(rec,'other-notes')||pick(rec,'current-telemetry')||'-'}</div>
        ${pick(rec,'telemetry-comments')?('<div>Comments: '+pick(rec,'telemetry-comments')+'</div>'):''}
      </div>

      <div class="print-card">
        <div class="print-label">Mobile Signal</div>
        <div>Spark: <b>${pick(rec,'spark-bars')||'-'}</b> ${pick(rec,'spark-note')? '• '+pick(rec,'spark-note'):''}</div>
        <div>One NZ: <b>${pick(rec,'one-bars')||'-'}</b> ${pick(rec,'one-note')? '• '+pick(rec,'one-note'):''}</div>
      </div>

      <div class="print-card">
        <div class="print-label">Rubberware</div>
        <div>Door Seal: <b>${doorDelivered(rec)?'Delivered':'No'}</b> ${doorSize(rec)? '• '+doorSize(rec):''} ${doorCount? '(x'+doorCount+')':''}</div>
        <div>RJT: <b>${rjtDelivered(rec)?'Delivered':'No'}</b> ${rjtSize(rec)? '• '+rjtSize(rec):''}</div>
      </div>
    </div>

    <div class="print-grid" style="margin-top:10px">
      ${p('Gateway',            photoOf(rec,'gateway'))}
      ${p('Vat 1 Cap',          photoOf(rec,'v1cap'))}
      ${p('Agitator (Vat 1)',   photoOf(rec,'v1agit'))}
      ${p('Vat 2 Cap',          photoOf(rec,'v2cap'))}
      ${p('Agitator (Vat 2)',   photoOf(rec,'v2agit'))}
      ${p('Door Seal',          photoOf(rec,'door'))}
      ${p('RJT',                photoOf(rec,'rjt'))}
    </div>
  </div>`;
}

window.openDetails = dn => {
  const rec = RECORDS.get(dn); if(!rec) return;
  const host = $('row-'+dn);
  const id = 'details-'+dn;
  const prev = document.getElementById(id);
  if(prev){ prev.remove(); return; }
  const div = document.createElement('div');
  div.id = id; div.className = 'mt-2';
  div.innerHTML = brochureHTML(rec);
  host.appendChild(div);
};
window.openPrint = dn => {
  const rec = RECORDS.get(dn); if(!rec) return;
  const w = window.open('', '_blank');
  const sheet = brochureHTML(rec);
  const css = document.querySelector('style').innerHTML;
  w.document.write(`<html><head><title>#${dn}</title><style>body{font-family:Inter,Arial,sans-serif;padding:16px}${css}</style></head><body>${sheet}</body></html>`);
  w.document.close(); w.focus(); setTimeout(()=>w.print(), 250);
};

/* =========================================================================================
   PRINT / ZIP ALL (batched – safe for iOS Safari)
   =======================================================================================*/
function ensureLoaded(){ if(RECORDS.size===0){ alert('Records are still loading…'); return false } return true }
$('btn-print-all').onclick = async () => {
  if(!ensureLoaded()) return;
  const css = document.querySelector('style').innerHTML;
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>All Brochures</title><style>body{font-family:Inter,Arial,sans-serif;padding:16px}${css}</style></head><body></body></html>`);
  w.document.close();
  const batch = 10; const entries = [...RECORDS.values()];
  let i = 0;
  function step(){ try{
      for(let k=0;k<batch && i<entries.length;k++,i++){
        const sheet = brochureHTML(entries[i]);
        const div = w.document.createElement('div');
        div.innerHTML = sheet + (i<entries.length?'<div style="page-break-after:always"></div>':'');
        w.document.body.appendChild(div);
      }
      if(i<entries.length) setTimeout(step, 60);
      else setTimeout(()=>w.print(), 300);
    }catch(e){ alert('Printing stopped (memory). Prepared '+i+' farms.'); }
  }
  step();
};

$('btn-zip-all').onclick = async () => {
  if(!ensureLoaded()) return;
  const css = document.querySelector('style').innerHTML;
  const zip = new JSZip();
  const entries = [...RECORDS.entries()];
  const batch = 12; let i=0;
  async function chunk(){ try{
      for(let k=0;k<batch && i<entries.length;k++,i++){
        const [dn,rec] = entries[i];
        const html = `<!doctype html><meta charset="utf-8"><title>${dn}</title><style>body{font-family:Inter,Arial,sans-serif;padding:16px}${css}</style>${brochureHTML(rec)}`;
        zip.file(`brochure_${dn}.html`, html);
      }
      if(i<entries.length) setTimeout(chunk, 0);
      else { const blob = await zip.generateAsync({type:'blob'}); saveAs(blob, 'agora_precheck_brochures.zip'); }
    }catch(e){ alert('ZIP build stopped (memory). Try fewer at a time.'); }
  }
  chunk();
};

/* =========================================================================================
   SIZES CSV
   =======================================================================================*/
$('btn-export-sizes').onclick = () => {
  const rows = [...sizeCounts.entries()].map(([Size,Count])=>({Size,Count}));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Vat Sizes');
  XLSX.writeFile(wb, 'vat_sizes.csv');
};

/* =========================================================================================
   FORM GLUE (autofill cloud, print one)
   =======================================================================================*/
function toggleVat2Extra(){ $('vat2-extra').classList.toggle('hidden', !N($('vat2-capacity').value).trim()) }
$('vat2-capacity').addEventListener('input',toggleVat2Extra); $('vat2-capacity').addEventListener('blur',toggleVat2Extra);

function setVal(id,v){ const el=$(id); if(el) el.value = v ?? '' }
function setPrev(id,b64){ const el=$(id); if(!el) return; if(b64){ el.src=b64; el.classList.remove('d-none'); } else { el.classList.add('d-none'); } }

async function autofill(dn){
  try{
    const url=await storage.ref(`${FOLDER}/${dn}.json`).getDownloadURL();
    const rec=await fetch(url).then(r=>r.json());
    rec.dairyNumber = rec.dairyNumber || dn;

    // map -> form
    setVal('dairyNumber', rec.dairyNumber);
    setVal('gateway-location', pick(rec,'gateway-location'));
    setVal('vat1-capacity', pick(rec,'vat1-capacity'));
    setVal('vat1-cap', normCap(pick(rec,'vat1-cap'))||'available');
    setVal('vat1-serial', pick(rec,'vat1-serial'));
    setVal('vat1-condition', pick(rec,'vat1-condition')||'ok');
    setVal('vat1-condition-comments', pick(rec,'vat1-condition-comments'));
    setVal('vat1-comments', pick(rec,'vat1-comments'));
    setVal('agitator1-location', pick(rec,'agitator1-location','agitator-location'));
    setPrev('gateway-preview', photoOf(rec,'gateway'));
    setPrev('vat1-cap-preview', photoOf(rec,'v1cap'));
    setPrev('agitator1-preview', photoOf(rec,'v1agit'));

    setVal('vat2-capacity', pick(rec,'vat2-capacity')); toggleVat2Extra();
    setVal('vat2-cap', normCap(pick(rec,'vat2-cap')) || (pick(rec,'vat2-capacity')?'available':'na'));
    setVal('vat2-serial', pick(rec,'vat2-serial'));
    setVal('vat2-condition', pick(rec,'vat2-condition')||'ok');
    setVal('vat2-condition-comments', pick(rec,'vat2-condition-comments'));
    setVal('vat2-comments', pick(rec,'vat2-comments'));
    setVal('agitator2-location', pick(rec,'agitator2-location'));
    setPrev('vat2-cap-preview', photoOf(rec,'v2cap'));
    setPrev('agitator2-preview', photoOf(rec,'v2agit'));

    setVal('spark-bars', pick(rec,'spark-bars'));
    setVal('spark-note', pick(rec,'spark-note'));
    setVal('one-bars', pick(rec,'one-bars'));
    setVal('one-note', pick(rec,'one-note'));

    setVal('other-brand', pick(rec,'other-brand'));
    setVal('other-type', pick(rec,'other-type'));
    setVal('other-notes', pick(rec,'other-notes'));
    setVal('current-telemetry', pick(rec,'current-telemetry'));
    setVal('telemetry-comments', pick(rec,'telemetry-comments'));

    setVal('door-delivered', pick(rec,'door-delivered','vat-door-seal')||'no');
    setVal('door-size', doorSize(rec));
    setVal('rjt-delivered', pick(rec,'rjt-delivered','rjt-seal')||'no');
    setVal('rjt-size', rjtSize(rec));
    setPrev('door-preview', photoOf(rec,'door'));
    setPrev('rjt-preview', photoOf(rec,'rjt'));

    // also drop into RECORDS for print-one
    RECORDS.set(rec.dairyNumber, rec);
  }catch(e){
    alert('Could not load from cloud for #'+dn);
  }
}
$('dairyNumber').addEventListener('blur', ()=>{ const dn=N($('dairyNumber').value).trim(); if(dn) autofill(dn) });

$('btn-print-one').onclick = ()=>{ const dn=N($('dairyNumber').value).trim(); if(!dn){ alert('Enter a Dairy # first'); return } if(!RECORDS.has(dn)){ alert('Load the farm first (blur dairy #).'); return } openPrint(dn) };
$('btn-to-summary').onclick = () => $('tab-summary').click();

/* =========================================================================================
   TAB NAVIGATION
   =======================================================================================*/
function activate(tab, viewId){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  tab.classList.add('active');
  ['view-summary','view-form','view-admin'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  $(viewId).classList.remove('hidden');
}
$('tab-summary').onclick = ()=>{ activate($('tab-summary'),'view-summary'); startSummary() };
$('tab-form').onclick    = ()=>{ activate($('tab-form'),   'view-form')    };
$('tab-admin').onclick   = ()=>{ activate($('tab-admin'),  'view-admin')   };
$('btn-reload').onclick  = ()=>{ MANIFEST=[]; RECORDS.clear(); sizeCounts.clear(); $('kpi-dts').textContent='0';$('kpi-power').textContent='0';$('kpi-rubber').textContent='0'; $('result-list').innerHTML=''; $('size-table').textContent='Starting…'; setPct(0,1); startSummary() };
$('btn-clear-sw').onclick= async ()=>{ if(!('serviceWorker' in navigator)) return alert('No SW'); const regs=await navigator.serviceWorker.getRegistrations(); for(const r of regs) await r.unregister(); caches.keys().then(ns=>ns.forEach(n=>caches.delete(n))); alert('Service Worker cache cleared. Reload the page.'); };

/* =========================================================================================
   SERVICE WORKER REGISTER
   =======================================================================================*/
window.addEventListener('DOMContentLoaded', ()=>{
  startSummary();
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
  }
});
</script>
</body>
</html>