<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Agora Vat Pre-Check (Final)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<style>
  :root{--bg:#f8faff;--primary:#001F3F;--accent:#FF851B;--muted:#6b7280;--card:#fff;--border:#e5e7eb;--max:980px;--chip:#eef2ff}
  html,body{background:var(--bg);color:var(--primary);font-family:'Inter',system-ui,Arial,sans-serif}
  .wrap{max-width:var(--max);margin:28px auto;padding:18px}
  .logo{max-width:210px;display:block;margin:0 auto 8px}
  .hdr{display:flex;align-items:center;justify-content:space-between;gap:8px}
  h1{margin:0;color:var(--accent);font-weight:800;font-size:1.7rem}
  .sub{color:var(--muted)}
  .cardx{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 28px #001F3F10}
  .pad{padding:16px}
  .btn-ag{background:var(--accent);border:none;color:#fff;border-radius:9px;font-weight:700}
  .btn-ag:hover{background:#ff6d00}
  .btn-quiet{background:#fff;border:1px solid var(--border);color:var(--primary);border-radius:9px}
  .btn-out{background:#fff;border:1px solid var(--accent);color:var(--primary);border-radius:9px}
  .btn-out:hover{background:var(--accent);color:#fff}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:900px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}}
  .section{font-weight:800;margin:10px 0 6px;color:#173559}
  label{font-weight:600}
  .form-control,.form-select{border-radius:10px}
  .thumb{width:88px;height:88px;object-fit:cover;border:1px solid var(--border);border-radius:8px;display:none}
  .big-photo{max-width:760px;max-height:560px;margin:10px auto;display:block;border:1px solid var(--border);border-radius:10px}
  .chip{display:inline-block;background:var(--chip);border:1px solid #dbeafe;border-radius:14px;padding:3px 8px;margin:3px 6px 0 0;font-size:.85rem}
  .tile{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
  .tile-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .tile-photos{display:flex;gap:6px;flex-wrap:wrap}
  .tile-photos img{width:70px;height:70px;border:1px solid var(--border);border-radius:8px;object-fit:cover}
  .kpi{border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center;background:#fff}
  .kpi .num{font-size:1.4rem;font-weight:800}
  .kpi .label{font-size:.9rem;color:var(--muted)}
  .hidden{display:none!important}
  .overlay{position:fixed;inset:0;background:#ffffffde;display:none;align-items:center;justify-content:center;z-index:9999}
  .loader{width:88px;height:88px;border-radius:50%;border:8px solid #eee;border-top-color:var(--accent);animation:spin 1s linear infinite;margin-bottom:10px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="wrap">
  <img id="logo" class="logo" style="display:none" />
  <div class="hdr">
    <h1>Agora Vat Pre-Check</h1>
    <div class="d-flex gap-2">
      <button class="btn-quiet" onclick="showSummary()">Summary</button>
      <button class="btn-quiet" onclick="showAdmin()">Admin</button>
    </div>
  </div>
  <div class="sub mb-2">Final customer-facing form with instant summaries & tag normalization (grey/gray, reducing cap, halo, sensor, DTS…).</div>

  <!-- FORM -->
  <div id="form-card" class="cardx pad">
    <div class="section">Farm</div>
    <div class="grid-3">
      <div><label>Dairy Number</label><input id="dairyNumber" class="form-control" required /></div>
      <div><label>Current Telemetry</label><input id="current-telemetry" class="form-control" /></div>
      <div><label>Telemetry Comments</label><input id="telemetry-comments" class="form-control" /></div>
    </div>

    <div class="section mt-2">Vat 1</div>
    <div class="grid-3">
      <div><label>Capacity (L)</label><input id="vat1-capacity" class="form-control" /></div>
      <div><label>Serial</label><input id="vat1-serial" class="form-control" /></div>
      <div>
        <label>Cap Availability</label>
        <select id="vat1-cap" class="form-select" onchange="togglePhoto('vat1-cap')">
          <option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option>
        </select>
      </div>
    </div>
    <div class="grid-3">
      <div><label>Cap Comments</label><input id="vat1-cap-comments" class="form-control" /></div>
      <div id="vat1-cap-photo-wrap" class="hidden"><input type="file" id="vat1-cap-photo" accept="image/*" class="form-control" onchange="previewFile(event,'vat1-cap-preview')" /></div>
      <div><img id="vat1-cap-preview" class="thumb" /></div>
    </div>
    <div class="grid-3">
      <div>
        <label>Condition</label>
        <select id="vat1-condition" class="form-select" onchange="toggleExtra('vat1-condition')">
          <option value="ok">OK</option><option value="attention">Attention Required</option>
        </select>
      </div>
      <div id="vat1-condition-extra" class="hidden"><label>Condition Comments</label><input id="vat1-condition-comments" class="form-control" /></div>
      <div id="vat1-condition-photo-wrap" class="hidden"><input type="file" id="vat1-condition-photo" accept="image/*" class="form-control" onchange="previewFile(event,'vat1-condition-preview')" /></div>
    </div>
    <img id="vat1-condition-preview" class="thumb" />

    <div class="section mt-2">Vat 2</div>
    <div class="grid-3">
      <div><label>Capacity (L)</label><input id="vat2-capacity" class="form-control" oninput="toggleVat2Serial()" /></div>
      <div id="vat2-serial-wrap"><label>Serial</label><input id="vat2-serial" class="form-control" /></div>
      <div>
        <label>Cap Availability</label>
        <select id="vat2-cap" class="form-select" onchange="togglePhoto('vat2-cap')">
          <option value="na">N/A</option><option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option>
        </select>
      </div>
    </div>
    <div class="grid-3">
      <div><label>Cap Comments</label><input id="vat2-cap-comments" class="form-control" /></div>
      <div id="vat2-cap-photo-wrap" class="hidden"><input type="file" id="vat2-cap-photo" accept="image/*" class="form-control" onchange="previewFile(event,'vat2-cap-preview')" /></div>
      <div><img id="vat2-cap-preview" class="thumb" /></div>
    </div>
    <div class="grid-3">
      <div>
        <label>Condition</label>
        <select id="vat2-condition" class="form-select" onchange="toggleExtra('vat2-condition')">
          <option value="ok">OK</option><option value="attention">Attention Required</option>
        </select>
      </div>
      <div id="vat2-condition-extra" class="hidden"><label>Condition Comments</label><input id="vat2-condition-comments" class="form-control" /></div>
      <div id="vat2-condition-photo-wrap" class="hidden"><input type="file" id="vat2-condition-photo" accept="image/*" class="form-control" onchange="previewFile(event,'vat2-condition-preview')" /></div>
    </div>
    <img id="vat2-condition-preview" class="thumb" />

    <div class="section mt-2">Agitator</div>
    <div class="grid-3">
      <div><label>Sensor Location</label><input id="agitator-location" class="form-control" /></div>
      <div><label>Comments</label><input id="agitator-comments" class="form-control" /></div>
      <div><label>Photo</label><input type="file" id="agitator-photo" accept="image/*" class="form-control" onchange="previewFile(event,'agitator-preview')" /></div>
    </div>
    <img id="agitator-preview" class="thumb" />

    <div class="section mt-2">Gateway</div>
    <div class="grid-3">
      <div><label>Location</label><input id="gateway-location" class="form-control" /></div>
      <div><label>Comments</label><input id="gateway-comments" class="form-control" /></div>
      <div><label>Photo</label><input type="file" id="gateway-photo" accept="image/*" class="form-control" onchange="previewFile(event,'gateway-preview')" /></div>
    </div>
    <img id="gateway-preview" class="thumb" />

    <div class="section mt-2">Rubberware</div>
    <div class="grid-3">
      <div>
        <label>Vat Door Seal</label>
        <select id="vat-door-seal" class="form-select" onchange="toggleDoorSeal()">
          <option value="notdelivered">Not Delivered</option><option value="delivered">Delivered</option>
        </select>
      </div>
      <div id="door-size-wrap" class="hidden">
        <label>Door Seal Size</label>
        <select id="vat-door-seal-size" class="form-select"><option value="">Select Size</option><option>Small</option><option>Large</option></select>
      </div>
      <div><label>Photo</label><input type="file" id="vat-door-seal-photo" accept="image/*" class="form-control" onchange="previewFile(event,'vat-door-seal-preview')" /></div>
    </div>
    <img id="vat-door-seal-preview" class="thumb" />
    <div class="grid-3 mt-1">
      <div>
        <label>RJT Step Seal</label>
        <select id="rjt-seal" class="form-select" onchange="toggleRJT()">
          <option value="notdelivered">Not Delivered</option><option value="delivered">Delivered</option>
        </select>
      </div>
      <div id="rjt-size-wrap" class="hidden">
        <label>RJT Size</label>
        <select id="rjt-seal-size" class="form-select"><option value="">Select Size</option><option>Small</option><option>Large</option></select>
      </div>
      <div><label>Photo</label><input type="file" id="rjt-seal-photo" accept="image/*" class="form-control" onchange="previewFile(event,'rjt-seal-preview')" /></div>
    </div>
    <img id="rjt-seal-preview" class="thumb" />

    <div class="section mt-2">Chiller</div>
    <div class="grid-3">
      <div>
        <label>Condition</label>
        <select id="chiller-condition" class="form-select" onchange="toggleExtra('chiller-condition')">
          <option value="ok">OK</option><option value="attention">Attention Required</option>
        </select>
      </div>
      <div id="chiller-condition-extra" class="hidden"><label>Comments</label><input id="chiller-condition-comments" class="form-control" /></div>
      <div id="chiller-condition-photo-wrap" class="hidden"><input type="file" id="chiller-condition-photo" accept="image/*" class="form-control" onchange="previewFile(event,'chiller-condition-preview')" /></div>
    </div>
    <img id="chiller-condition-preview" class="thumb" />

    <div class="d-flex gap-2 mt-3">
      <button class="btn-ag" onclick="saveForm()">Save</button>
      <button class="btn-out" onclick="generatePDF()">Generate PDF</button>
      <div id="save-msg" class="ms-auto text-muted small"></div>
    </div>
  </div>

  <!-- SUMMARY -->
  <div id="summary-card" class="cardx pad hidden">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div class="section">Summary & Records</div>
        <div class="text-muted small">Uses simple listAll→getDownloadURL (like Ticketing). If listing is blocked, Admin can publish _index.json.</div>
      </div>
      <button class="btn-quiet" onclick="backToForm()">Back</button>
    </div>

    <div class="grid-4 mb-2" id="kpis"></div>

    <div class="d-flex flex-wrap gap-2 mb-2">
      <input id="summary-search" class="form-control" placeholder="Search Dairy # (e.g. 12345)" style="max-width:220px" />
      <select id="filter-cap" class="form-select" style="max-width:180px">
        <option value="all">All Farms</option><option value="no-cap">No Available Vat Cap</option>
      </select>
      <select id="filter-vat-cond" class="form-select" style="max-width:180px">
        <option value="all">Vat Condition: All</option><option value="attention">Attention Required</option>
      </select>
      <select id="filter-chiller" class="form-select" style="max-width:160px">
        <option value="all">Chiller: All</option><option value="attention">Attention</option>
      </select>
      <select id="filter-door" class="form-select" style="max-width:170px">
        <option value="all">Door Seal: All</option><option value="delivered">Delivered</option><option value="notdelivered">Not Delivered</option>
      </select>
      <select id="filter-rjt" class="form-select" style="max-width:150px">
        <option value="all">RJT: All</option><option value="delivered">Delivered</option><option value="notdelivered">Not Delivered</option>
      </select>
      <button class="btn-ag" onclick="loadVatSummary()">Apply</button>
    </div>

    <div class="grid-2">
      <div><div id="card-grid" class="grid-2"></div></div>
      <div>
        <div id="summary-table-div" class="mb-2"></div>
        <div id="summary-extras"></div>
        <div id="single-form-view" class="mt-3"></div>
      </div>
    </div>
  </div>

  <!-- ADMIN (Downloads only) -->
  <div id="admin-card" class="cardx pad hidden">
    <div class="d-flex justify-content-between align-items-center">
      <div><div class="section">Admin — Downloads & Publishing</div><div class="text-muted small">Use this if listAll is blocked.</div></div>
      <button class="btn-quiet" onclick="backToForm()">Back</button>
    </div>
    <div class="grid-3 my-2">
      <div class="kpi"><div class="num" id="rec-count">0</div><div class="label">Records</div></div>
      <div class="kpi"><div class="num" id="photo-count">0</div><div class="label">Photos</div></div>
      <div class="kpi"><div class="num" id="door-deliv">0</div><div class="label">Door Seals (calc.)</div></div>
    </div>
    <div class="d-flex gap-2 mt-2">
      <button class="btn-ag" onclick="exportCSV()">Download CSV</button>
      <button class="btn-out" onclick="exportXLSX()">Download XLSX</button>
      <button class="btn-quiet" onclick="publishIndex()">Publish _index.json</button>
      <div id="admin-msg" class="ms-auto text-muted small"></div>
    </div>
  </div>
</div>

<!-- Overlay -->
<div id="overlay" class="overlay"><div class="text-center"><div class="loader"></div><div id="ovt">Loading…</div></div></div>

<!-- Libs -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* ===== INIT ===== */
const firebaseConfig = {
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

const db = new Dexie('VatPreCheckFinal'); db.version(1).stores({forms:'++id,dairyNumber'});
const byId=(id)=>document.getElementById(id);
const show=(el)=>el.classList.remove('hidden');
const hide=(el)=>el.classList.add('hidden');
const ov=(t)=>{byId('ovt').textContent=t||'Loading…';byId('overlay').style.display='flex'};
const ovOff=()=>byId('overlay').style.display='none';

(async()=>{try{const r=storage.ref("Agora Logo/2F6-1YdaEP.jpeg");const u=await r.getDownloadURL();byId('logo').src=u;byId('logo').style.display='block';}catch{}})();

/* ===== UI helpers ===== */
function previewFile(e,id){const f=e.target.files[0];if(!f)return;const img=byId(id);img.src=URL.createObjectURL(f);img.style.display='inline-block';const r=new FileReader();r.onload=v=>img.dataset.base64=v.target.result;r.readAsDataURL(f)}
function togglePhoto(p){const sel=byId(p);const wrap=byId(p+'-photo-wrap');const prev=byId(p+'-preview');if(sel.value==='unavailable'){wrap?.classList.remove('hidden')}else{wrap?.classList.add('hidden');prev&&(prev.style.display='none')}}
function toggleExtra(p){const sel=byId(p),ex=byId(p+'-extra'),pw=byId(p+'-photo-wrap'),prev=byId(p+'-preview');if(sel.value==='attention'){ex?.classList.remove('hidden');pw?.classList.remove('hidden')}else{ex?.classList.add('hidden');pw?.classList.add('hidden');prev&&(prev.style.display='none')}}
function toggleVat2Serial(){byId('vat2-serial-wrap').style.opacity=(byId('vat2-capacity').value.trim()? '1':'0.5')}
function toggleDoorSeal(){byId('door-size-wrap').classList.toggle('hidden', (byId('vat-door-seal').value!=='delivered'))}
function toggleRJT(){byId('rjt-size-wrap').classList.toggle('hidden', (byId('rjt-seal').value!=='delivered'))}

/* ===== Save / PDF ===== */
function collectForm(){
  const g=id=>byId(id)?.value?.trim()||'';
  return{
    dairyNumber:g('dairyNumber'),
    'current-telemetry':g('current-telemetry'),'telemetry-comments':g('telemetry-comments'),
    'vat1-capacity':g('vat1-capacity'),'vat1-serial':g('vat1-serial'),'vat1-cap':g('vat1-cap'),'vat1-cap-comments':g('vat1-cap-comments'),
    'vat1-condition':g('vat1-condition'),'vat1-condition-comments':g('vat1-condition-comments'),
    'vat2-capacity':g('vat2-capacity'),'vat2-serial':g('vat2-serial'),'vat2-cap':g('vat2-cap'),'vat2-cap-comments':g('vat2-cap-comments'),
    'vat2-condition':g('vat2-condition'),'vat2-condition-comments':g('vat2-condition-comments'),
    'agitator-location':g('agitator-location'),'agitator-comments':g('agitator-comments'),
    'gateway-location':g('gateway-location'),'gateway-comments':g('gateway-comments'),
    'vat-door-seal':g('vat-door-seal'),'vat-door-seal-size':g('vat-door-seal-size'),
    'rjt-seal':g('rjt-seal'),'rjt-seal-size':g('rjt-seal-size'),
    'chiller-condition':g('chiller-condition'),'chiller-condition-comments':g('chiller-condition-comments')
  };
}
async function saveForm(){
  ov('Saving…'); const d=collectForm();
  ['vat1-cap','vat2-cap','vat1-condition','vat2-condition','agitator','gateway','vat-door-seal','rjt-seal','chiller-condition'].forEach(k=>{
    const img=byId(k+'-preview'); if(img?.dataset.base64) d[k+'-photo-base64']=img.dataset.base64;
  });
  d.timestamp=Date.now();
  await db.forms.put({dairyNumber:d.dairyNumber,...d});
  await storage.ref(`Pre Check/${d.dairyNumber}.json`).put(new Blob([JSON.stringify(d)],{type:'application/json'}));
  ovOff(); byId('save-msg').textContent='Saved ✔'; setTimeout(()=>byId('save-msg').textContent='',1800);
}
async function generatePDF(){
  await saveForm();
  const data=collectForm(); const {jsPDF}=window.jspdf; const pdf=new jsPDF('l','pt','a4'); let Y=40;
  pdf.setFontSize(18); pdf.setTextColor(0,31,63); pdf.text('Agora Vat Pre-Check',40,Y); Y+=22;
  pdf.setFontSize(12); pdf.setTextColor(60); pdf.text('Dairy #: '+(data.dairyNumber||'-'),40,Y); Y+=6;
  const body=Object.entries(data).filter(([k])=>!k.endsWith('base64')&&k!=='timestamp').map(([k,v])=>[k.replace(/-/g,' ').toUpperCase(),String(v||'')]);
  pdf.autoTable({startY:Y+8,head:[['FIELD','VALUE']],body,styles:{fontSize:9,cellPadding:4},headStyles:{fillColor:[0,31,63]}});
  let y=pdf.lastAutoTable.finalY+10;
  const photos=['vat1-cap','vat2-cap','vat1-condition','vat2-condition','gateway','agitator','vat-door-seal','rjt-seal','chiller-condition'];
  for(const k of photos){const img=byId(k+'-preview');if(img?.dataset.base64){if(y+160>560){pdf.addPage();y=60}pdf.setFontSize(12);pdf.text(k.replace(/-/g,' ').toUpperCase(),40,y);pdf.addImage(img.dataset.base64,'JPEG',40,y+8,420,140);y+=158}}
  pdf.save('VatPreCheck_'+(data.dairyNumber||'form')+'.pdf');
}

/* ===== AI-ish tags (deterministic heuristics) ===== */
function aiTags(r){
  const txt=[
    r['telemetry-comments'],r['vat1-cap-comments'],r['vat2-cap-comments'],
    r['vat1-condition-comments'],r['vat2-condition-comments'],
    r['agitator-comments'],r['gateway-comments'],r['chiller-condition-comments']
  ].filter(Boolean).join(' | ').toLowerCase();
  const tags=new Set(), has=arr=>arr.some(w=>txt.includes(w));
  if(has(['reducing cap','reduction cap','reducer cap','rcap'])) tags.add('Reducing cap required');
  if(has(['grey halo','gray halo','halo'])) tags.add('Halo mentioned');
  if(has(['grey sensor','gray sensor'])) tags.add('Grey/Gray sensor');
  if(has(['sensor','probe'])) tags.add('Sensor reference');
  if(has(['dts','digital temp','temp system'])) tags.add('DTS/Temperature system');
  if(has(['power point','powerpoint','pp near vat'])) tags.add('Power point near vat');
  if(has(['leak','drip'])) tags.add('Leak/Drip risk');
  if(has(['corrode','rust'])) tags.add('Corrosion observed');
  if(r['vat1-cap']==='unavailable'||r['vat2-cap']==='unavailable') tags.add('Vat cap missing');
  if(r['vat1-condition']==='attention'||r['vat2-condition']==='attention') tags.add('Vat attention');
  if(r['chiller-condition']==='attention') tags.add('Chiller attention');
  if((r['vat-door-seal']||'').toLowerCase()==='delivered'){
    const n=(r['vat1-capacity']?1:0)+(r['vat2-capacity']?1:0)||1;
    tags.add(`Door seals delivered ×${n}${r['vat-door-seal-size']?' ('+r['vat-door-seal-size']+')':''}`);
  }
  if((r['rjt-seal']||'').toLowerCase()==='delivered') tags.add(`RJT delivered${r['rjt-seal-size']?' ('+r['rjt-seal-size']+')':''}`);
  const v1=r['vat1-capacity']||'-',v2=r['vat2-capacity']||''; tags.add(`Vats: ${v1}${v2?(' + '+v2):''}`);
  return Array.from(tags);
}

/* ===== SUMMARY (mirrors ticketing: listAll→download→parse) ===== */
let _records=[];
async function folderRefCandidates(){
  // Try both “Pre Check” (space) and “Pre-Check” (dash), then “PreCheck”
  return [
    storage.ref('Pre Check'),
    storage.ref('Pre-Check'),
    storage.ref('PreCheck')
  ];
}
async function listFilesLikeTicketing(){
  const cands=await folderRefCandidates();
  // Try each folder until one lists successfully with at least one json
  for(const ref of cands){
    try{
      const res=await ref.listAll(); // identical to ticketing
      const jsons=res.items.filter(x=>x.name.endsWith('.json') && x.name!=='_index.json');
      if(jsons.length) return jsons;
      // if empty but _index.json exists, still return manifest approach
      const maybeIdx = res.items.find(x=>x.name==='_index.json');
      if(maybeIdx){ return {manifestRef: maybeIdx, parent: ref}; }
    }catch(e){ /* try next */ }
  }
  // Listing blocked → try reading a manifest directly in “Pre Check”
  try{
    const ref=storage.ref('Pre Check/_index.json'); const url=await ref.getDownloadURL();
    return {manifestRef: ref, parent: storage.ref('Pre Check')};
  }catch(e){}
  throw new Error('Cannot list or find _index.json in any Pre-Check folder.');
}
async function loadFromItems(items){
  const out=[];
  for(const it of items){
    try{ const url=await it.getDownloadURL(); const data=await fetch(url,{cache:'no-store'}).then(r=>r.json()); data.dairyNumber=data.dairyNumber||it.name.replace(/\.json$/,''); out.push(data); }
    catch(e){/* skip bad item */}
  }
  return out;
}
async function loadFromManifest(manifestRef,parentRef){
  try{
    const url=await manifestRef.getDownloadURL();
    const m=await fetch(url,{cache:'no-store'}).then(r=>r.json());
    const files=(m.files||[]).filter(n=>n.endsWith('.json')&&n!=='_index.json');
    const items=files.map(n=>parentRef.child(n));
    return await loadFromItems(items);
  }catch(e){ throw new Error('Manifest fetch failed'); }
}
function kpi(label,val){return `<div class="kpi"><div class="num">${val}</div><div class="label">${label}</div></div>`}
function buildTile(rec){
  const pics=[]; ['vat1-cap','vat2-cap','vat1-condition','vat2-condition','gateway','agitator','vat-door-seal','rjt-seal','chiller-condition'].forEach(k=>{if(rec[k+'-photo-base64']) pics.push(rec[k+'-photo-base64'])});
  const tags=aiTags(rec);
  return `<div class="tile">
    <div class="tile-h"><div class="fw-bold">Dairy #${rec.dairyNumber||'-'}</div><span class="chip">${(rec['current-telemetry']||'').slice(0,24)||'No telemetry'}</span></div>
    <div class="mb-1">${tags.map(t=>`<span class="chip">${t}</span>`).join(' ')||'<span class="text-muted small">No notes</span>'}</div>
    ${pics.length?`<div class="tile-photos">${pics.slice(0,4).map(p=>`<img src="${p}">`).join('')}</div>`:''}
    <div class="mt-2"><button class="btn-quiet btn-sm" onclick="viewSingleForm('${rec.dairyNumber||''}')">Open details</button></div>
  </div>`;
}
function applyFilters(recs){
  const s=(byId('summary-search').value||'').trim().toLowerCase();
  const fCap=byId('filter-cap').value, fVat=byId('filter-vat-cond').value, fCh=byId('filter-chiller').value, fDoor=byId('filter-door').value, fRjt=byId('filter-rjt').value;
  let r=[...recs];
  if(s) r=r.filter(x=>(x.dairyNumber||'').toLowerCase().includes(s));
  if(fCap==='no-cap') r=r.filter(x => (x['vat1-cap'] && x['vat1-cap']!=='available') || (x['vat2-cap'] && x['vat2-cap']!=='available'));
  if(fVat==='attention') r=r.filter(x => x['vat1-condition']==='attention' || x['vat2-condition']==='attention');
  if(fCh==='attention') r=r.filter(x => x['chiller-condition']==='attention');
  if(fDoor!=='all') r=r.filter(x => (x['vat-door-seal']||'').toLowerCase()===fDoor);
  if(fRjt!=='all') r=r.filter(x => (x['rjt-seal']||'').toLowerCase()===fRjt);
  return r;
}
async function loadVatSummary(){
  ov('Loading records…');
  let itemsOrManifest;
  try{ itemsOrManifest = await listFilesLikeTicketing(); }
  catch(e){
    ovOff();
    byId('kpis').innerHTML='';
    byId('card-grid').innerHTML='';
    byId('summary-table-div').innerHTML = `<div class="alert alert-warning">Summary cannot list your Storage folder. Use <b>Admin → Publish _index.json</b> (or allow list in rules).<br><small>${e.message||e}</small></div>`;
    return;
  }
  let recs=[];
  if(Array.isArray(itemsOrManifest)){ recs = await loadFromItems(itemsOrManifest); }
  else if(itemsOrManifest && itemsOrManifest.manifestRef){ recs = await loadFromManifest(itemsOrManifest.manifestRef, itemsOrManifest.parent); }
  _records=recs;

  const filtered = applyFilters(recs);

  // KPIs
  const doorDelivered = filtered.reduce((a,r)=>((r['vat-door-seal']||'').toLowerCase()==='delivered'? a + ((r['vat1-capacity']?1:0)+(r['vat2-capacity']?1:0)||1):a),0);
  const vatsAttention = filtered.filter(r=>r['vat1-condition']==='attention'||r['vat2-condition']==='attention').length;
  const chAttention = filtered.filter(r=>r['chiller-condition']==='attention').length;
  byId('kpis').innerHTML = kpi('Farms', filtered.length)+kpi('Door seals delivered (calc.)', doorDelivered)+kpi('Vat attention', vatsAttention)+kpi('Chiller attention', chAttention);

  // Table
  const rows = filtered.map(r=>`
    <tr>
      <td><a href="#" onclick="viewSingleForm('${r.dairyNumber}');return false;">${r.dairyNumber||''}</a></td>
      <td>${r['vat1-cap']||''}</td><td>${r['vat1-capacity']||''}</td><td>${r['vat1-condition']||''}</td><td>${r['vat1-serial']||''}</td>
      <td>${r['vat2-cap']||''}</td><td>${r['vat2-capacity']||''}</td><td>${r['vat2-condition']||''}</td><td>${r['vat2-serial']||''}</td>
      <td>${r['chiller-condition']||''}</td>
      <td>${r['vat-door-seal']||''}</td><td>${r['vat-door-seal-size']||''}</td>
      <td>${r['rjt-seal']||''}</td><td>${r['rjt-seal-size']||''}</td>
    </tr>`).join('');
  byId('summary-table-div').innerHTML = `
    <table class="table table-sm table-bordered">
      <thead><tr>
        <th>Dairy #</th><th>Vat1 Cap</th><th>Vat1 Size</th><th>Vat1 Cond</th><th>Vat1 Serial</th>
        <th>Vat2 Cap</th><th>Vat2 Size</th><th>Vat2 Cond</th><th>Vat2 Serial</th>
        <th>Chiller</th><th>Door Seal</th><th>Door Size</th><th>RJT</th><th>RJT Size</th>
      </tr></thead><tbody>${rows}</tbody>
    </table>`;

  // Cards (top 50 to keep snappy)
  byId('card-grid').innerHTML = filtered.slice(0,50).map(buildTile).join('');

  // Extras
  const rjtCount = filtered.filter(r=>(r['rjt-seal']||'').toLowerCase()==='delivered').length;
  const sealDeliveredFarms = filtered.filter(r=>(r['vat-door-seal']||'').toLowerCase()==='delivered').length;
  byId('summary-extras').innerHTML = `<div class="text-muted small">RJTs delivered: <b>${rjtCount}</b> • Farms with door seals delivered: <b>${sealDeliveredFarms}</b></div>`;

  ovOff();
}

/* Drilldown */
async function viewSingleForm(dn){
  ov('Loading form…');
  let rec=_records.find(r=>String(r.dairyNumber)===String(dn));
  if(!rec){
    try{const ref=storage.ref(`Pre Check/${dn}.json`);const url=await ref.getDownloadURL();rec=await fetch(url,{cache:'no-store'}).then(r=>r.json());}catch{}
  }
  ovOff();
  const div=byId('single-form-view');
  if(!rec){div.innerHTML=`<div class="alert alert-secondary">No form for #${dn}</div>`;return;}
  let html=`<div class="section">Vat Pre-Check for #${dn}</div><table class="table table-sm table-bordered"><tbody>`;
  Object.entries(rec).forEach(([k,v])=>{if(k.endsWith('base64')||k==='timestamp'||k==='id'||k==='dairyNumber')return;html+=`<tr><th>${k.replace(/-/g,' ').toUpperCase()}</th><td>${String(v||'')}</td></tr>`});
  html+='</tbody></table>';
  const ph=[];['vat1-cap','vat2-cap','vat1-condition','vat2-condition','gateway','agitator','vat-door-seal','rjt-seal','chiller-condition'].forEach(k=>{if(rec[k+'-photo-base64'])ph.push([k,rec[k+'-photo-base64']])});
  if(ph.length){html+=`<div class="section mt-2">Photos</div>`;ph.forEach(([k,src])=>{html+=`<div class="mb-2"><b>${k.replace(/-/g,' ').toUpperCase()}</b><br><img class="big-photo" src="${src}"></div>`})}
  div.innerHTML=html; div.scrollIntoView({behavior:'smooth'});
}

/* ===== Admin ===== */
function showSummary(){ hide(byId('form-card')); hide(byId('admin-card')); show(byId('summary-card'));
  setTimeout(()=>{ ['summary-search','filter-cap','filter-vat-cond','filter-chiller','filter-door','filter-rjt'].forEach(id=>byId(id).onchange=loadVatSummary); byId('summary-search').oninput=loadVatSummary; loadVatSummary(); },0);
}
function backToForm(){ hide(byId('summary-card')); hide(byId('admin-card')); show(byId('form-card')); }
function showAdmin(){ const ok=sessionStorage.getItem('admin-ok')==='1'||prompt('Admin passphrase?')==='agora-admin'; if(!ok)return; sessionStorage.setItem('admin-ok','1'); hide(byId('form-card')); hide(byId('summary-card')); show(byId('admin-card')); refreshAdminStats(); }

async function refreshAdminStats(){ ov('Counting…'); try{await loadVatSummary(); const recs=_records||[]; const photos=recs.reduce((a,r)=>a+['vat1-cap','vat2-cap','vat1-condition','vat2-condition','gateway','agitator','vat-door-seal','rjt-seal','chiller-condition'].reduce((n,k)=>n+(r[k+'-photo-base64']?1:0),0),0); const doors=recs.reduce((a,r)=>((r['vat-door-seal']||'').toLowerCase()==='delivered'?a+((r['vat1-capacity']?1:0)+(r['vat2-capacity']?1:0)||1):a),0); byId('rec-count').textContent=recs.length; byId('photo-count').textContent=photos; byId('door-deliv').textContent=doors; }catch(e){byId('admin-msg').textContent='Stats error: '+(e.message||e)} ovOff(); }

function flatten(r){return{
  DairyNumber:r.dairyNumber||'',
  Vat1Capacity:r['vat1-capacity']||'',Vat1Serial:r['vat1-serial']||'',Vat1Cap:r['vat1-cap']||'',Vat1CapComments:r['vat1-cap-comments']||'',Vat1Condition:r['vat1-condition']||'',Vat1ConditionComments:r['vat1-condition-comments']||'',
  Vat2Capacity:r['vat2-capacity']||'',Vat2Serial:r['vat2-serial']||'',Vat2Cap:r['vat2-cap']||'',Vat2CapComments:r['vat2-cap-comments']||'',Vat2Condition:r['vat2-condition']||'',Vat2ConditionComments:r['vat2-condition-comments']||'',
  AgitatorLocation:r['agitator-location']||'',AgitatorComments:r['agitator-comments']||'',
  GatewayLocation:r['gateway-location']||'',GatewayComments:r['gateway-comments']||'',
  DoorSeal:r['vat-door-seal']||'',DoorSealSize:r['vat-door-seal-size']||'',
  RJTSeal:r['rjt-seal']||'',RJTSealSize:r['rjt-seal-size']||'',
  ChillerCondition:r['chiller-condition']||'',ChillerComments:r['chiller-condition-comments']||'',
  Telemetry:r['current-telemetry']||'',TelemetryComments:r['telemetry-comments']||'',
  Tags:(aiTags(r)||[]).join(' | ')
}}
function exportCSV(){const recs=_records||[];if(!recs.length){byId('admin-msg').textContent='No data.';return;}const flat=recs.map(flatten);const H=Object.keys(flat[0]);const q=v=>'"'+String(v??'').replace(/"/g,'""')+'"';const csv="\uFEFF"+[H.join(',')].concat(flat.map(r=>H.map(h=>q(r[h])).join(','))).join("\r\n");const blob=new Blob([csv],{type:"text/csv;charset=UTF-8"});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='vat_precheck_export.csv';a.click();setTimeout(()=>URL.revokeObjectURL(a.href),400)}
function exportXLSX(){const recs=_records||[];if(!recs.length){byId('admin-msg').textContent='No data.';return;}const flat=recs.map(flatten);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(flat),'Forms');const photos=recs.map(r=>({DairyNumber:r.dairyNumber,PhotoCount:['vat1-cap','vat2-cap','vat1-condition','vat2-condition','gateway','agitator','vat-door-seal','rjt-seal','chiller-condition'].reduce((n,k)=>n+(r[k+'-photo-base64']?1:0),0)}));XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(photos),'Photos');XLSX.writeFile(wb,'vat_precheck_export.xlsx')}
async function publishIndex(){ov('Publishing index…');try{let refOk=null;for(const ref of await folderRefCandidates()){try{await ref.listAll();refOk=ref;break}catch{}}if(!refOk)refOk=storage.ref('Pre Check');const res=await refOk.listAll();const files=res.items.filter(i=>i.name.endsWith('.json')&&i.name!=='_index.json').map(i=>i.name);await refOk.child('_index.json').put(new Blob([JSON.stringify({files,publishedAt:new Date().toISOString()},null,2)],{type:'application/json'}));byId('admin-msg').textContent=`Published _index.json (${files.length} items)`}catch(e){byId('admin-msg').textContent='Publish failed: '+(e.message||e)}ovOff()}

/* ===== Prefill on Dairy blur ===== */
byId('dairyNumber').addEventListener('blur', async function(){
  const num=(this.value||'').trim(); if(!num) return;
  let rec=await db.forms.where('dairyNumber').equals(num).first();
  if(!rec){try{const ref=storage.ref(`Pre Check/${num}.json`);const url=await ref.getDownloadURL();rec=await fetch(url).then(r=>r.json())}catch{}}
  if(rec){Object.entries(rec).forEach(([k,v])=>{const el=byId(k);if(el)el.value=v});['vat1-cap','vat2-cap','vat1-condition','vat2-condition','chiller-condition'].forEach(toggleExtra);toggleDoorSeal();toggleRJT();toggleVat2Serial()}
});
</script>
</body>
</html>