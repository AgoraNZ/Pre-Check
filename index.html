<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agora Vat Pre-Check</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root{
    --brand:#a7ab01; --ink:#222; --muted:#6b7280; --card:#fff; --chip:#f6f7f9;
    --accent:#002B5C; --cta:#FF851B; --cta2:#FF4136;
  }
  body{ background:#f7f7fb; color:var(--ink); }
  .wrap{ max-width:1100px; margin:auto; padding:20px 14px 60px; }
  h1{ color:var(--brand); font-weight:800; letter-spacing:.3px; }
  .nav-pills .nav-link{ border-radius:12px; font-weight:700; }
  .nav-pills .nav-link.active{ background:var(--brand); }
  .tab-box{ background:#fff; border:1px solid #eee; border-radius:16px; padding:18px; box-shadow:0 6px 22px #0000000d; }
  .section-title{ color:var(--brand); font-size:18px; margin:20px 0 8px; font-weight:700; }
  .image-preview{ display:none; max-width:240px; margin-top:6px; border:2px solid #ddd; }
  .grid-cards{ display:grid; grid-template-columns:repeat(auto-fill,minmax(230px,1fr)); gap:14px; }
  .kpi{ background:#fff; border:1px solid #eee; border-radius:14px; padding:16px 16px 14px; }
  .kpi .n{ font-size:28px; font-weight:800; }
  .kpi .t{ color:var(--muted); font-weight:600; }
  .kpi.click{ cursor:pointer; transition:.15s; }
  .kpi.click:hover{ transform:translateY(-2px); box-shadow:0 8px 20px #00000010; }
  .progress{ height:10px; }
  .badge-chip{ background:var(--chip); color:#374151; border:1px solid #e5e7eb; }
  .farm-card{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; }
  .farm-card:hover{ box-shadow:0 8px 20px #00000010; }
  .thumb{ width:100%; max-height:200px; object-fit:cover; border-radius:10px; border:1px solid #eee; }
  .btn-cta{ background:var(--cta); color:#fff; border:0; }
  .btn-cta:hover{ background:var(--cta2); color:#fff; }
  .linkish{ cursor:pointer; color:#2563eb; text-decoration:underline; }
  .sticky-tools{ position:sticky; top:8px; z-index:5; background:#fff; border:1px solid #eee; border-radius:12px; padding:12px; }
  .small{ font-size:12px; color:var(--muted); }
  .subtle{ color:var(--muted); }
</style>
</head>
<body>
<div class="wrap">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="m-0">Agora Vat Pre-Check</h1>
    <ul class="nav nav-pills gap-2">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#tab-form">üìù Form</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-summary">üßæ Summary</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-admin">‚¨áÔ∏è Admin</a></li>
    </ul>
  </div>

  <div class="tab-content">

    <!-- ======================= FORM ======================= -->
    <div class="tab-pane fade show active" id="tab-form">
      <div class="tab-box">
        <form id="form" class="row g-3">

          <!-- Dairy number -->
          <div class="col-12 col-md-6">
            <label class="form-label">Dairy Number</label>
            <input class="form-control" name="dairyNumber" id="dairyNumber" required>
          </div>

          <!-- ---------- VAT section (ordered first) ---------- -->
          <div class="col-12"><div class="section-title">Vat Details</div></div>

          <!-- VAT 1 -->
          <div class="col-md-3">
            <label class="form-label">Vat 1 Capacity (L)</label>
            <input class="form-control" name="vat1-capacity" id="vat1-capacity" inputmode="numeric">
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 1 Cap</label>
            <select class="form-select" name="vat1-cap" id="vat1-cap">
              <option value="available">Available ‚úì</option>
              <option value="unavailable">Unavailable ‚úó</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Vat 1 Comments (width, brand, notes)</label>
            <input class="form-control" name="vat1-comments" id="vat1-comments">
          </div>
          <div class="col-md-6">
            <label class="form-label">Vat 1 Condition</label>
            <select class="form-select" name="vat1-condition" id="vat1-condition">
              <option value="ok">OK</option>
              <option value="attention">Attention Required</option>
            </select>
          </div>
          <div class="col-md-6" id="v1c-extra" style="display:none">
            <label class="form-label">Condition Notes / Photo</label>
            <input class="form-control mb-2" name="vat1-condition-comments" id="vat1-condition-comments">
            <input type="file" accept="image/*" class="form-control" id="vat1-condition-photo">
            <img id="vat1-condition-preview" class="image-preview">
          </div>
          <div class="col-md-6">
            <label class="form-label">Vat 1 Serial</label>
            <input class="form-control" name="vat1-serial" id="vat1-serial">
          </div>

          <!-- VAT 2 (defaults to N/A) -->
          <div class="col-md-3">
            <label class="form-label">Vat 2 Capacity (L)</label>
            <input class="form-control" name="vat2-capacity" id="vat2-capacity" placeholder="N/A">
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 2 Cap</label>
            <select class="form-select" name="vat2-cap" id="vat2-cap">
              <option value="na" selected>N/A</option>
              <option value="available">Available ‚úì</option>
              <option value="unavailable">Unavailable ‚úó</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Vat 2 Comments</label>
            <input class="form-control" name="vat2-comments" id="vat2-comments" placeholder="N/A">
          </div>
          <div class="col-md-6">
            <label class="form-label">Vat 2 Condition</label>
            <select class="form-select" name="vat2-condition" id="vat2-condition">
              <option value="na" selected>N/A</option>
              <option value="ok">OK</option>
              <option value="attention">Attention Required</option>
            </select>
          </div>
          <div class="col-md-6" id="v2c-extra" style="display:none">
            <label class="form-label">Condition Notes / Photo</label>
            <input class="form-control mb-2" name="vat2-condition-comments" id="vat2-condition-comments">
            <input type="file" accept="image/*" class="form-control" id="vat2-condition-photo">
            <img id="vat2-condition-preview" class="image-preview">
          </div>
          <div class="col-md-6">
            <label class="form-label">Vat 2 Serial</label>
            <input class="form-control" name="vat2-serial" id="vat2-serial" placeholder="N/A">
          </div>

          <!-- ---------- Agitator then Gateway then Telemetry ---------- -->
          <div class="col-12"><div class="section-title">Agitator</div></div>
          <div class="col-md-6">
            <label class="form-label">Agitator Location</label>
            <input class="form-control" name="agitator-location" id="agitator-location">
          </div>
          <div class="col-md-6">
            <label class="form-label">Comments / Photo</label>
            <input class="form-control mb-2" name="agitator-comments" id="agitator-comments">
            <input type="file" accept="image/*" class="form-control" id="agitator-photo">
            <img id="agitator-preview" class="image-preview">
          </div>

          <div class="col-12"><div class="section-title">Gateway</div></div>
          <div class="col-md-6">
            <label class="form-label">Gateway Location</label>
            <input class="form-control" name="gateway-location" id="gateway-location">
          </div>
          <div class="col-md-6">
            <label class="form-label">Comments / Photo</label>
            <input class="form-control mb-2" name="gateway-comments" id="gateway-comments">
            <input type="file" accept="image/*" class="form-control" id="gateway-photo">
            <img id="gateway-preview" class="image-preview">
          </div>

          <div class="col-12"><div class="section-title">Other Telemetry</div></div>
          <div class="col-md-6">
            <label class="form-label">Current Telemetry</label>
            <input class="form-control" name="current-telemetry" id="current-telemetry" placeholder="e.g. Spark good / One NZ poor">
          </div>
          <div class="col-md-6">
            <label class="form-label">Telemetry Comments</label>
            <input class="form-control" name="telemetry-comments" id="telemetry-comments" placeholder="power point recommended / splitter ok ...">
          </div>

          <!-- ---------- Rubberware ---------- -->
          <div class="col-12"><div class="section-title">Rubberware</div></div>
          <div class="col-md-6">
            <label class="form-label">Vat Door Seal</label>
            <select class="form-select" name="vat-door-seal" id="vat-door-seal">
              <option value="notdelivered">Not Delivered</option>
              <option value="delivered">Delivered</option>
            </select>
            <div id="door-extra" style="display:none">
              <div class="mt-2">
                <label class="form-label">Door Seal Size</label>
                <select class="form-select" name="door-seal-size" id="door-seal-size">
                  <option value="">Select size</option><option value="small">Small</option><option value="large">Large</option>
                </select>
              </div>
              <input class="form-control mt-2" name="vat-door-seal-comments" id="vat-door-seal-comments" placeholder="notes">
              <input type="file" accept="image/*" class="form-control mt-2" id="vat-door-seal-photo">
              <img id="vat-door-seal-preview" class="image-preview">
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">RJT Step Seal</label>
            <select class="form-select" name="rjt-seal" id="rjt-seal">
              <option value="notdelivered">Not Delivered</option>
              <option value="delivered">Delivered</option>
            </select>
            <div id="rjt-extra" style="display:none">
              <div class="mt-2">
                <label class="form-label">Step Seal Size</label>
                <select class="form-select" name="rjt-seal-size" id="rjt-seal-size">
                  <option value="">Select size</option><option value="small">Small</option><option value="large">Large</option>
                </select>
              </div>
              <input class="form-control mt-2" name="rjt-seal-comments" id="rjt-seal-comments" placeholder="notes">
              <input type="file" accept="image/*" class="form-control mt-2" id="rjt-seal-photo">
              <img id="rjt-seal-preview" class="image-preview">
            </div>
          </div>

          <!-- Buttons -->
          <div class="col-12 d-flex gap-2 mt-2">
            <button type="button" id="btnSave" class="btn btn-cta">Save + PDF</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ======================= SUMMARY ======================= -->
    <div class="tab-pane fade" id="tab-summary">
      <div class="row g-3">
        <div class="col-12 col-lg-4">
          <div class="sticky-tools">
            <div class="d-flex align-items-center gap-2 mb-2">
              <span class="badge rounded-pill badge-chip">Cache <span id="cache-count">0</span></span>
              <span class="badge rounded-pill badge-chip">Cloud <span id="cloud-total">0</span></span>
              <span class="badge rounded-pill badge-chip">New <span id="new-count">0</span></span>
            </div>
            <div class="progress mb-2"><div id="dl-bar" class="progress-bar" style="width:0%"></div></div>
            <div class="small mb-2"><b><span id="dl-count">0</span></b> downloaded ‚Ä¢ <b><span id="remain-count">0</span></b> remaining</div>
            <div class="d-grid gap-2">
              <button id="btnSync" class="btn btn-outline-secondary">Download / Refresh From Cloud</button>
              <input id="q" class="form-control" placeholder="Search Dairy # / text‚Ä¶">
              <div class="d-flex gap-2">
                <button id="btnApply" class="btn btn-outline-dark flex-grow-1">Apply</button>
                <button id="btnClear" class="btn btn-outline-secondary">Clear</button>
              </div>
              <button id="btnCSV" class="btn btn-outline-primary">Export Vat Sizes CSV</button>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-8">
          <!-- KPI cards -->
          <div class="grid-cards mb-3">
            <div class="kpi click" id="kpi-total"    data-filter="all"><div class="n" id="n-total">0</div><div class="t">Total Farms</div></div>
            <div class="kpi click" id="kpi-attn"     data-filter="attn"><div class="n" id="n-attn">0</div><div class="t">Any Attention</div></div>
            <div class="kpi click" id="kpi-nocap"    data-filter="nocap"><div class="n" id="n-nocap">0</div><div class="t">No Available Cap</div></div>
            <div class="kpi click" id="kpi-door"     data-filter="door"><div class="n" id="n-door">0</div><div class="t">Door Seals Delivered</div></div>
            <div class="kpi click" id="kpi-dts"      data-filter="dtscap"><div class="n" id="n-dts">0</div><div class="t">DTS / Vent Caps</div></div>
            <div class="kpi click" id="kpi-pp"       data-filter="pp"><div class="n" id="n-pp">0</div><div class="t">Power Points Needed</div></div>
            <div class="kpi click" id="kpi-splitter" data-filter="split"><div class="n" id="n-split">0</div><div class="t">Splitter OK</div></div>
            <div class="kpi click" id="kpi-spark"    data-filter="spark"><div class="n" id="n-spark">0</div><div class="t">Spark Preferred</div></div>
            <div class="kpi click" id="kpi-one"      data-filter="one"><div class="n" id="n-one">0</div><div class="t">One NZ Preferred</div></div>
          </div>

          <!-- Results -->
          <div id="list" class="row g-3"></div>
          <div id="empty" class="text-center subtle">Loading‚Ä¶</div>
        </div>
      </div>
    </div>

    <!-- ======================= ADMIN ======================= -->
    <div class="tab-pane fade" id="tab-admin">
      <div class="tab-box">
        <div class="mb-2">Admin only shows **download** features (no edits).</div>
        <button id="btnSync2" class="btn btn-outline-secondary">Download / Refresh From Cloud</button>
      </div>
    </div>

  </div>
</div>

<!-- libs -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

<script>
/* =================== CONFIG =================== */
const CLOUD_FOLDER = 'Pre Check'; // exact folder name in Storage
const firebaseConfig = {
  apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain: "dairy-farm-record-system.firebaseapp.com",
  projectId: "dairy-farm-record-system",
  storageBucket: "dairy-farm-record-system.appspot.com",
  messagingSenderId: "422124188212",
  appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

/* =================== UTIL =================== */
const $ = (id) => document.getElementById(id);
function banner(msg, kind='info'){
  let el = $('__banner');
  if(!el){
    el = document.createElement('div');
    el.id='__banner';
    el.style.cssText='position:fixed;left:12px;right:12px;bottom:12px;z-index:9999;padding:10px 12px;border-radius:10px;background:#fff;border:1px solid #eee;box-shadow:0 4px 18px #0000001a;font-size:14px';
    document.body.appendChild(el);
  }
  el.style.borderColor = (kind==='error') ? '#ffb2b2' : '#e5e7eb';
  el.style.background   = (kind==='error') ? '#fff4f4'  : '#fff';
  el.textContent = msg;
  setTimeout(()=>{ if(el) el.remove(); }, 6000);
}
function fileInputPreview(fileInputId, imgId){
  const inp = $(fileInputId), img = $(imgId);
  if(!inp || !img) return;
  inp.addEventListener('change', e=>{
    const f = inp.files[0]; if(!f) return;
    const url = URL.createObjectURL(f);
    img.src = url; img.style.display='block';
    // also keep base64 for PDF
    const r = new FileReader(); r.onload = ev => img.setAttribute('data-base64', ev.target.result); r.readAsDataURL(f);
  });
}

/* =================== FORM UI VISIBILITY =================== */
$('vat1-condition').addEventListener('change',()=>{ $('v1c-extra').style.display = ($('vat1-condition').value==='attention')?'block':'none'; });
$('vat2-condition').addEventListener('change',()=>{ const v=$('vat2-condition').value; $('v2c-extra').style.display=(v==='attention')?'block':'none'; });
$('vat-door-seal').addEventListener('change',()=>{ $('door-extra').style.display = ($('vat-door-seal').value==='delivered')?'block':'none'; });
$('rjt-seal').addEventListener('change',()=>{ $('rjt-extra').style.display = ($('rjt-seal').value==='delivered')?'block':'none'; });

['vat1-condition-photo','vat2-condition-photo','agitator-photo','gateway-photo','vat-door-seal-photo','rjt-seal-photo']
.forEach(id=>{
  const imgId = id.replace('-photo','-preview');
  fileInputPreview(id, imgId);
});

/* =================== CACHE (Dexie) =================== */
const db = new Dexie('VatPreCheckCache');
db.version(1).stores({ forms: 'dairyNumber' });
let idbOK = true;
db.open().catch(e => { console.warn('Dexie open failed', e); idbOK=false; banner('Local cache unavailable. Using memory only.', 'error'); });

/* in-memory */
let cache = [];
let recMap = new Map();

/* =================== ‚ÄúAI‚Äù NORMALISERS =================== */
function norm(t){ return (t||'').toString().toLowerCase(); }
function anyText(r){ // collect all comment-y text
  return [
    r['vat1-comments'], r['vat2-comments'], r['gateway-comments'], r['agitator-comments'],
    r['telemetry-comments'], r['current-telemetry'], r['vat1-cap-comments'], r['vat2-cap-comments'],
    r['vat1-condition-comments'], r['vat2-condition-comments'], r['vat-door-seal-comments'], r['rjt-seal-comments']
  ].filter(Boolean).map(norm).join(' | ');
}
function hasDtsCap(r){
  const t = norm(r['vat1-cap'])+' '+norm(r['vat2-cap'])+' '+anyText(r);
  const kw = ['dts','vent cap','reducing cap','grey cap','gray cap','grey halo','gray halo','halo sensor','rjt reducing'];
  return kw.some(k=>t.includes(k));
}
function needsPowerPoint(r){
  const t = anyText(r);
  const pos = ['power point needed','powerpoint needed','power point recommend','powerpoint recommend','needs power point','requires power'];
  const neg = ['splitter ok','splitter plug can be used','double adapter ok','can use splitter'];
  if(neg.some(k=>t.includes(k))) return false;
  return pos.some(k=>t.includes(k)) || /pp\s*(req|needed)/.test(t);
}
function splitterOK(r){
  const t = anyText(r);
  return ['splitter ok','splitter plug can be used','double adapter ok','can use splitter','pp not required'].some(k=>t.includes(k));
}
function networkPref(r){ // 'spark', 'one', or ''
  const t = anyText(r);
  const spark = ['spark good','spark better','spark best','spark strong','vodafone poor','one nz poor'];
  const one   = ['one nz good','one good','one nz better','vodafone better','one best','one strong'];
  if(spark.some(k=>t.includes(k))) return 'spark';
  if(one.some(k=>t.includes(k))) return 'one';
  return '';
}
function manufacturerFrom(r){ // naive inference from comments
  const t = anyText(r);
  if(/(^|[\s])dts([\s]|$)/.test(t)) return 'DTS';
  if(/\bnda\b|\bnz dairy\b|\bnational dairy\b/.test(t)) return 'NDA';
  if(/\bpacko\b/.test(t)) return 'Packo';
  if(/\bdelaval\b/.test(t)) return 'DeLaval';
  return '';
}
function aiFlags(r){
  return {
    dtsCap: hasDtsCap(r),
    ppReq: needsPowerPoint(r),
    splitOK: splitterOK(r),
    net: networkPref(r),
    manuf: manufacturerFrom(r)
  };
}

/* =================== CLOUD LIST (PAGINATED) =================== */
async function listCloud(){
  const items = [];
  try{
    let pageToken = undefined;
    const root = storage.ref(CLOUD_FOLDER);
    do{
      const page = await root.list({ maxResults: 200, pageToken });
      (page.items||[]).forEach(i => { if(i.name.endsWith('.json')) items.push(i); });
      pageToken = page.nextPageToken;
      await new Promise(r => setTimeout(r, 0)); // yield
    }while(pageToken);
  }catch(e){
    console.error('listCloud error', e);
    banner('Cloud listing failed. Check Storage rules/network.', 'error');
  }
  return items;
}

/* =================== SYNC FROM CLOUD (with progress + safety) =================== */
async function syncFromCloud(){
  banner('Syncing from cloud‚Ä¶');
  let items = [];
  try { items = await listCloud(); } catch(e){}
  $('cloud-total').textContent = items.length;

  // compute new vs have
  const have = new Set(cache.map(r=>String(r.dairyNumber)));
  const toFetch = items.filter(it => !have.has(it.name.replace(/\.json$/,'')));
  $('new-count').textContent = toFetch.length;
  $('remain-count').textContent = toFetch.length;
  $('dl-count').textContent = 0; $('dl-bar').style.width='0%';

  let done = 0, skipped = 0;
  for(const it of toFetch){
    try{
      const url = await it.getDownloadURL();
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();     // guard parse
      const j = JSON.parse(text);
      const rec = lightRecord(j, it.name.replace('.json',''));
      if(idbOK){ try{ await db.forms.put(rec); }catch(e){} }
      cache.push(rec); recMap.set(String(rec.dairyNumber), rec);
    }catch(err){
      console.warn('Skip', it.name, err);
      skipped++;
    }
    done++;
    $('dl-count').textContent = done;
    $('remain-count').textContent = (toFetch.length - done);
    $('dl-bar').style.width = (Math.round(done/toFetch.length*100)||0)+'%';
    if(done % 25 === 0) renderSummary(true); // incremental
  }

  $('cache-count').textContent = cache.length;
  renderSummary();

  if(skipped) banner(`Synced: ${done - skipped}, skipped: ${skipped} bad file(s).`, 'error');
  else        banner(`Synced ${done} record(s).`);
}

/* =================== LOAD CACHE INIT =================== */
async function initSummary(){
  let arr = [];
  if(idbOK){
    try { arr = await db.forms.toArray(); }
    catch(e){ banner('Could not read local cache.', 'error'); }
  }
  cache = arr.length ? arr : cache;
  recMap = new Map(cache.map(r=>[String(r.dairyNumber),r]));
  $('cache-count').textContent = cache.length;
  renderSummary();
  // do not auto sync here; let user press Download for control
}

/* =================== LIGHT RECORD (for fast list/AI) =================== */
function lightRecord(j, fallbackKey){
  const dno = j.dairyNumber || fallbackKey;
  return {
    dairyNumber: dno,
    createdAt: j.timestamp || j.createdAt || Date.now(),
    // keep minimal fields used for summary/AI
    'vat1-capacity': j['vat1-capacity']||'',
    'vat2-capacity': j['vat2-capacity']||'',
    'vat1-cap': j['vat1-cap']||'',
    'vat2-cap': j['vat2-cap']||'na',
    'vat1-condition': j['vat1-condition']||'ok',
    'vat2-condition': j['vat2-condition']||'na',
    'vat1-serial': j['vat1-serial']||'',
    'vat2-serial': j['vat2-serial']||'',
    'vat1-comments': j['vat1-comments']||'',
    'vat2-comments': j['vat2-comments']||'',
    'gateway-comments': j['gateway-comments']||'',
    'agitator-comments': j['agitator-comments']||'',
    'current-telemetry': j['current-telemetry']||'',
    'telemetry-comments': j['telemetry-comments']||'',
    'vat1-cap-comments': j['vat1-cap-comments']||'',
    'vat2-cap-comments': j['vat2-cap-comments']||'',
    'vat1-condition-comments': j['vat1-condition-comments']||'',
    'vat2-condition-comments': j['vat2-condition-comments']||'',
    'vat-door-seal': j['vat-door-seal']||'notdelivered',
    'door-seal-size': j['door-seal-size']||'',
    'rjt-seal': j['rjt-seal']||'notdelivered',
    'rjt-seal-size': j['rjt-seal-size']||'',
    // thumbnail-ish photo flags (we‚Äôll fetch full on demand for card)
    '_hasPhotos': !!(j['vat1-condition-photo-base64']||j['vat2-condition-photo-base64']||j['gateway-photo-base64']||j['agitator-photo-base64']||j['vat-door-seal-photo-base64']||j['rjt-seal-photo-base64'])
  };
}

/* =================== SUMMARY RENDER =================== */
function renderSummary(partial=false){
  const q = norm($('q').value);
  let rows = cache.slice();

  if(q){
    rows = rows.filter(r=>{
      const s = JSON.stringify(r).toLowerCase();
      return s.includes(q);
    });
  }

  // KPIs
  const totals = {
    total: rows.length,
    attn: rows.filter(r=>r['vat1-condition']==='attention' || r['vat2-condition']==='attention').length,
    nocap: rows.filter(r=>{
      const c1 = r['vat1-cap'] && r['vat1-cap'].toLowerCase()!=='available';
      const c2 = r['vat2-cap'] && !['available','na'].includes(r['vat2-cap'].toLowerCase());
      return c1 || c2;
    }).length,
    door: rows.filter(r=>r['vat-door-seal']==='delivered').length,
    dts: rows.filter(r=>aiFlags(r).dtsCap).length,
    pp: rows.filter(r=>aiFlags(r).ppReq).length,
    split: rows.filter(r=>aiFlags(r).splitOK).length,
    spark: rows.filter(r=>aiFlags(r).net==='spark').length,
    one: rows.filter(r=>aiFlags(r).net==='one').length
  };
  $('n-total').textContent = totals.total;
  $('n-attn').textContent = totals.attn;
  $('n-nocap').textContent = totals.nocap;
  $('n-door').textContent = totals.door;
  $('n-dts').textContent = totals.dts;
  $('n-pp').textContent = totals.pp;
  $('n-split').textContent = totals.split;
  $('n-spark').textContent = totals.spark;
  $('n-one').textContent = totals.one;

  // list
  const box = $('list'); box.innerHTML = '';
  if(!rows.length){ $('empty').style.display='block'; return; } else { $('empty').style.display='none'; }

  // show first 100 (mobile)
  rows.slice(0, 100).forEach(r=>{
    const flags = aiFlags(r);
    const created = r.createdAt ? new Date(r.createdAt) : new Date();
    const createdStr = isNaN(created.getTime()) ? '' : created.toLocaleString();
    const chips = [];
    if(flags.dtsCap) chips.push('DTS/Vent Cap');
    if(flags.ppReq) chips.push('PP needed');
    if(flags.splitOK) chips.push('Splitter OK');
    if(flags.net==='spark') chips.push('Spark');
    if(flags.net==='one') chips.push('One NZ');
    if(r['vat-door-seal']==='delivered') chips.push('Door seal ‚úì'+(r['door-seal-size']?` (${r['door-seal-size']})`:'')); 
    if(r['rjt-seal']==='delivered') chips.push('RJT ‚úì'+(r['rjt-seal-size']?` (${r['rjt-seal-size']})`:'')); 

    const div = document.createElement('div');
    div.className='col-12';
    div.innerHTML = `
      <div class="farm-card">
        <div class="d-flex justify-content-between align-items-center">
          <div><b>Dairy #${r.dairyNumber}</b> <span class="small">‚Ä¢ ${createdStr}</span></div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" data-action="view" data-id="${r.dairyNumber}">View</button>
            <button class="btn btn-sm btn-outline-primary" data-action="print" data-id="${r.dairyNumber}">Print</button>
          </div>
        </div>
        <div class="mt-2 d-flex flex-wrap gap-1">
          ${chips.map(c=>`<span class="badge rounded-pill badge-chip">${c}</span>`).join('')}
        </div>
        <div class="small mt-2 subtle">Vat1: ${r['vat1-capacity']||'-'} L (${r['vat1-cap']||'-'}) ‚Ä¢ Vat2: ${r['vat2-capacity']||'N/A'} L (${r['vat2-cap']||'N/A'})</div>
      </div>`;
    box.appendChild(div);
  });
}

/* KPI filter click -> narrow to that category */
document.querySelectorAll('.kpi.click').forEach(el=>{
  el.addEventListener('click', ()=>{
    const f = el.getAttribute('data-filter');
    $('q').value = f; // simple cue; we‚Äôll interpret below
    applyFilter(f);
  });
});
function applyFilter(flag){
  let rows = cache.slice();
  switch(flag){
    case 'attn': rows = rows.filter(r=>r['vat1-condition']==='attention' || r['vat2-condition']==='attention'); break;
    case 'nocap': rows = rows.filter(r=>{
      const c1 = r['vat1-cap'] && r['vat1-cap'].toLowerCase()!=='available';
      const c2 = r['vat2-cap'] && !['available','na'].includes(r['vat2-cap'].toLowerCase());
      return c1 || c2;
    }); break;
    case 'door': rows = rows.filter(r=>r['vat-door-seal']==='delivered'); break;
    case 'dtscap': rows = rows.filter(r=>aiFlags(r).dtsCap); break;
    case 'pp': rows = rows.filter(r=>aiFlags(r).ppReq); break;
    case 'split': rows = rows.filter(r=>aiFlags(r).splitOK); break;
    case 'spark': rows = rows.filter(r=>aiFlags(r).net==='spark'); break;
    case 'one': rows = rows.filter(r=>aiFlags(r).net==='one'); break;
    default: return renderSummary();
  }
  const box = $('list'); box.innerHTML=''; $('empty').style.display = rows.length? 'none':'block';
  rows.slice(0,100).forEach(r=>{
    const div = document.createElement('div'); div.className='col-12';
    div.innerHTML = `<div class="farm-card">
      <div class="d-flex justify-content-between align-items-center">
        <div><b>Dairy #${r.dairyNumber}</b></div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary" data-action="view" data-id="${r.dairyNumber}">View</button>
          <button class="btn btn-sm btn-outline-primary" data-action="print" data-id="${r.dairyNumber}">Print</button>
        </div>
      </div>
    </div>`;
    box.appendChild(div);
  });
}

/* =================== VIEW / PRINT HANDLERS =================== */
$('list').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.getAttribute('data-id'); 
  if(btn.getAttribute('data-action')==='view'){ viewFarm(id); }
  if(btn.getAttribute('data-action')==='print'){ printFarm(id); }
});

async function fetchFull(dno){
  // prefer cache; try fetch from cloud for latest
  const cached = recMap.get(String(dno));
  try{
    const ref = storage.ref(`${CLOUD_FOLDER}/${dno}.json`);
    const url = await ref.getDownloadURL();
    const data = await fetch(url, { cache:'no-store' }).then(r=>r.json());
    // merge into cache lightly
    const rec = Object.assign({}, cached||{}, data);
    recMap.set(String(dno), rec);
    return rec;
  }catch(e){
    return cached || null;
  }
}

async function viewFarm(dno){
  const r = await fetchFull(dno);
  if(!r){ banner(`No form found for #${dno}`, 'error'); return; }

  // modal
  const id = 'farmModal'; let m=$('farmModal');
  if(!m){
    m = document.createElement('div');
    m.id='farmModal';
    m.className='modal fade';
    m.innerHTML = `
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Farm</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body" id="farmBody"></div>
      </div>
    </div>`;
    document.body.appendChild(m);
  }
  const body = $('farmBody');
  const flags = aiFlags(r);
  const chips = [];
  if(flags.dtsCap) chips.push('DTS/Vent Cap');
  if(flags.ppReq) chips.push('PP needed');
  if(flags.splitOK) chips.push('Splitter OK');
  if(flags.net==='spark') chips.push('Spark');
  if(flags.net==='one') chips.push('One NZ');

  // build photo section
  const photos = [];
  ['vat1-condition','vat2-condition','gateway','agitator','vat-door-seal','rjt-seal'].forEach(k=>{
    const b = r[`${k}-photo-base64`]; if(b) photos.push({k, b});
  });

  body.innerHTML = `
  <div class="mb-2"><b>Dairy #${r.dairyNumber}</b></div>
  <div class="d-flex flex-wrap gap-1 mb-3">${chips.map(c=>`<span class="badge rounded-pill badge-chip">${c}</span>`).join('')}</div>
  <div class="row g-3">
    <div class="col-md-6">
      <div class="p-3 border rounded-3">
        <div class="fw-bold mb-2">Vat</div>
        <div class="small">Vat 1: ${r['vat1-capacity']||'-'} L ‚Ä¢ Cap: ${r['vat1-cap']||'-'} ‚Ä¢ Cond: ${r['vat1-condition']||'-'} ‚Ä¢ Serial: ${r['vat1-serial']||'-'}</div>
        <div class="small">Vat 2: ${r['vat2-capacity']||'N/A'} L ‚Ä¢ Cap: ${r['vat2-cap']||'N/A'} ‚Ä¢ Cond: ${r['vat2-condition']||'N/A'} ‚Ä¢ Serial: ${r['vat2-serial']||'N/A'}</div>
        <div class="mt-2 small">${r['vat1-comments']||''} ${r['vat2-comments']?(' / '+r['vat2-comments']):''}</div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="p-3 border rounded-3">
        <div class="fw-bold mb-2">Telemetry & Power</div>
        <div class="small">${r['current-telemetry']||''}</div>
        <div class="small">${r['telemetry-comments']||''}</div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="p-3 border rounded-3">
        <div class="fw-bold mb-2">Rubberware</div>
        <div class="small">Door Seal: ${r['vat-door-seal']||'-'} ${r['door-seal-size']?('('+r['door-seal-size']+')'):''}</div>
        <div class="small">RJT: ${r['rjt-seal']||'-'} ${r['rjt-seal-size']?('('+r['rjt-seal-size']+')'):''}</div>
      </div>
    </div>
    <div class="col-12">
      <div class="row g-2">
        ${photos.map(p=>`<div class="col-md-4"><img class="thumb" src="${p.b}" alt="${p.k}"></div>`).join('')}
      </div>
    </div>
  </div>
  `;
  new bootstrap.Modal(m).show();
}

async function printFarm(dno){
  const r = await fetchFull(dno);
  if(!r){ banner(`No form found for #${dno}`, 'error'); return; }
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','pt','a4');
  const margin = 40;
  pdf.setFontSize(16); pdf.setTextColor(0,0,0);
  pdf.text(`Agora Vat Pre-Check ‚Äî Dairy #${r.dairyNumber}`, margin, 40);
  const body = [
    ['Vat 1', `${r['vat1-capacity']||'-'} L ‚Ä¢ Cap ${r['vat1-cap']||'-'} ‚Ä¢ ${r['vat1-condition']||'-'} ‚Ä¢ SN ${r['vat1-serial']||'-'}`],
    ['Vat 2', `${r['vat2-capacity']||'N/A'} L ‚Ä¢ Cap ${r['vat2-cap']||'N/A'} ‚Ä¢ ${r['vat2-condition']||'N/A'} ‚Ä¢ SN ${r['vat2-serial']||'N/A'}`],
    ['Agitator', r['agitator-comments']||''],
    ['Gateway', r['gateway-comments']||''],
    ['Telemetry', (r['current-telemetry']||'')+' '+(r['telemetry-comments']||'')],
    ['Rubberware', `Door Seal: ${r['vat-door-seal']||'-'} ${r['door-seal-size']||''} ‚Ä¢ RJT: ${r['rjt-seal']||'-'} ${r['rjt-seal-size']||''}`]
  ];
  pdf.autoTable({ startY: 60, head:[['Field','Details']], body, styles:{ fontSize:10 }, headStyles:{ fillColor:[0,43,92] } });

  // Photos
  let y = pdf.lastAutoTable.finalY + 16;
  const photoKeys = ['vat1-condition','vat2-condition','gateway','agitator','vat-door-seal','rjt-seal'];
  for(const k of photoKeys){
    const b = r[`${k}-photo-base64`];
    if(!b) continue;
    if(y+170>780){ pdf.addPage(); y=40; }
    pdf.setFontSize(12); pdf.text(k.replace(/-/g,' ').toUpperCase(), margin, y);
    pdf.addImage(b, 'JPEG', margin, y+6, 500, 150);
    y += 170;
  }
  pdf.save(`PreCheck_${r.dairyNumber}.pdf`);
}

/* =================== CSV (Vat sizes / serial / manuf / cap) =================== */
function downloadCSV(){
  const rows = cache.map(r=>{
    const flags = aiFlags(r);
    return {
      dairyNumber: r.dairyNumber,
      vat1Size: r['vat1-capacity']||'',
      vat1Serial: r['vat1-serial']||'',
      vat1Cap: (r['vat1-cap']||'').toUpperCase(),
      vat2Size: r['vat2-capacity']||'N/A',
      vat2Serial: r['vat2-serial']||'',
      vat2Cap: (r['vat2-cap']||'NA').toUpperCase(),
      manufacturer: flags.manuf || '',
    };
  });
  const headers = Object.keys(rows[0]||{dairyNumber:'',vat1Size:'',vat1Serial:'',vat1Cap:'',vat2Size:'',vat2Serial:'',vat2Cap:'',manufacturer:''});
  const data = [headers.join(','), ...rows.map(o=>headers.map(h=>String(o[h]).replace(/,/g,' ')).join(','))].join('\n');
  const blob = new Blob([data], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='vat_sizes.csv'; a.click();
}

/* =================== SUMMARY CONTROLS =================== */
$('btnSync').addEventListener('click', syncFromCloud);
$('btnSync2').addEventListener('click', syncFromCloud);
$('btnCSV').addEventListener('click', downloadCSV);
$('btnApply').addEventListener('click', (e)=>{ e.preventDefault(); renderSummary(); });
$('btnClear').addEventListener('click', (e)=>{ e.preventDefault(); $('q').value=''; renderSummary(); });

/* =================== SAVE + PDF FROM FORM =================== */
function collectFormData(){
  const f = new FormData($('form'));
  const data = Object.fromEntries(f.entries());
  // attach inline photos (base64) when chosen
  ['vat1-condition','vat2-condition','gateway','agitator','vat-door-seal','rjt-seal'].forEach(k=>{
    const img = $(k+'-preview'); if(img && img.getAttribute('data-base64')) data[`${k}-photo-base64`] = img.getAttribute('data-base64');
  });
  data.timestamp = Date.now();
  // defaults for vat2
  if(!data['vat2-cap']) data['vat2-cap']='na';
  if(!data['vat2-condition']) data['vat2-condition']='na';
  return data;
}
async function saveToCloud(data){
  try{
    const ref = storage.ref(`${CLOUD_FOLDER}/${data.dairyNumber}.json`);
    await ref.put(new Blob([JSON.stringify(data)], {type:'application/json'}));
    banner('Saved to cloud.');
  }catch(e){ banner('Cloud save failed.', 'error'); }
}
$('btnSave').addEventListener('click', async ()=>{
  const data = collectFormData();
  if(!data.dairyNumber){ banner('Enter Dairy Number', 'error'); return; }
  // save locally (if available) + memory
  if(idbOK){ try{ await db.forms.put(lightRecord(data, data.dairyNumber)); }catch(e){} }
  const rec = lightRecord(data, data.dairyNumber);
  recMap.set(String(rec.dairyNumber), rec);
  const idx = cache.findIndex(x=>String(x.dairyNumber)===String(rec.dairyNumber));
  if(idx>=0) cache[idx]=rec; else cache.push(rec);
  $('cache-count').textContent = cache.length;
  renderSummary();

  // cloud + PDF
  await saveToCloud(data);
  await printFarm(data.dairyNumber);
});

/* =================== INIT =================== */
initSummary();
</script>
</body>
</html>