<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Agora Vat Pre-Check</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
<style>
:root{--ag-olive:#a7ab01;--ag-navy:#002B5C;--bg:#f6f8fb;--shadow:0 6px 18px rgba(0,0,0,.06)}
html,body{background:var(--bg)}
.container-narrow{max-width:980px}
.ag-header{background:#fff;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:10}
.brand{color:var(--ag-olive);font-weight:800}
.nav-pill{border-radius:16px;padding:.55rem 1rem;font-weight:700}
.nav-pill.active{background:var(--ag-olive);color:#fff}
.nav-pill:not(.active){background:#eef0d3;color:#243c5a}
.ag-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:var(--shadow)}
.ag-title{color:var(--ag-navy);font-weight:700}
.stat-card{padding:1rem 1.2rem;border-radius:14px;background:#fff;border:1px solid #e5e7eb;box-shadow:var(--shadow)}
.stat-num{font-size:2.1rem;font-weight:800}
.chip{display:inline-block;background:#eef2ff;padding:.15rem .55rem;border-radius:999px;font-size:.8rem;margin-right:.35rem}
.pointer{cursor:pointer}
.photo-thumb{max-width:100%;border:1px solid #e5e7eb;border-radius:12px}
.logo-small{height:26px}
.print-sheet{width:210mm;background:#fff;color:#111;padding:14mm;border:1px solid #e5e7eb;border-radius:8px}
.print-photo{width:96mm;max-height:58mm;object-fit:cover;border:1px solid #e5e7eb;border-radius:6px;margin:3mm 3mm 0 0}
</style>
</head>
<body>
<header class="ag-header py-2">
  <div class="container container-narrow d-flex align-items-center gap-3">
    <img id="logoHeader" class="logo-small d-none" alt="Agora">
    <div>
      <div class="h2 brand mb-0">Agora Vat Pre-Check</div>
      <div class="text-muted small">Customer-ready pre-checks, photos & summaries</div>
    </div>
    <div class="ms-auto d-flex gap-2">
      <button class="nav-pill btn btn-sm active" id="tabFormBtn"><i class="bi bi-journal-text me-1"></i>Form</button>
      <button class="nav-pill btn btn-sm" id="tabSummaryBtn"><i class="bi bi-grid-3x3-gap-fill me-1"></i>Summary</button>
      <button class="nav-pill btn btn-sm" id="tabAdminBtn"><i class="bi bi-cloud-arrow-down-fill me-1"></i>Admin</button>
    </div>
  </div>
</header>

<main class="container container-narrow my-3">

  <!-- ========== FORM ========== -->
  <section id="tab-form" class="ag-card p-3 p-md-4">
    <h5 class="ag-title mb-3"><i class="bi bi-pencil-square me-2"></i>Create / Update Pre-Check</h5>

    <div class="mb-3">
      <label class="form-label fw-semibold">Dairy Number</label>
      <input id="dairyNumber" class="form-control form-control-lg" placeholder="e.g. 7016">
      <div class="form-text">Enter an existing dairy number to load it.</div>
    </div>

    <!-- Vat 1 -->
    <div class="ag-card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="ag-title mb-0">Vat 1</h6><span class="chip">Primary</span>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-md-4">
          <label class="form-label">Capacity (L)</label>
          <input id="vat1-capacity" class="form-control" inputmode="numeric" placeholder="e.g. 18000">
        </div>
        <div class="col-md-4">
          <label class="form-label">Cap</label>
          <select id="vat1-cap" class="form-select">
            <option value="available">Available ✓</option>
            <option value="unavailable">Unavailable ✗</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Cap Photo</label>
          <input id="vat1-cap-photo" type="file" class="form-control" accept="image/*">
          <img id="vat1-cap-preview" class="photo-thumb mt-2 d-none">
        </div>
        <div class="col-md-4">
          <label class="form-label">Condition</label>
          <select id="vat1-condition" class="form-select">
            <option value="ok">OK</option>
            <option value="attention">Attention Required</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Condition Photo</label>
          <input id="vat1-condition-photo" type="file" class="form-control" accept="image/*">
          <img id="vat1-condition-preview" class="photo-thumb mt-2 d-none">
        </div>
        <div class="col-md-4">
          <label class="form-label">Serial Number</label>
          <input id="vat1-serial" class="form-control" placeholder="Plate / SN">
        </div>
        <div class="col-md-6">
          <label class="form-label">Agitator Sensor Location (Vat 1)</label>
          <input id="agitator1-location" class="form-control" placeholder="e.g. top manhole, rear left">
        </div>
        <div class="col-md-6">
          <label class="form-label">Agitator Photo</label>
          <input id="agitator1-photo" type="file" class="form-control" accept="image/*">
          <img id="agitator1-preview" class="photo-thumb mt-2 d-none">
        </div>
      </div>
    </div>

    <!-- Vat 2 (conditional) -->
    <div id="vat2-card" class="ag-card p-3 mb-3 d-none">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="ag-title mb-0">Vat 2</h6><span class="chip">Secondary</span>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-md-4">
          <label class="form-label">Capacity (L)</label>
          <input id="vat2-capacity" class="form-control" inputmode="numeric" placeholder="Leave empty if no Vat 2">
        </div>
        <div class="col-md-4">
          <label class="form-label">Cap</label>
          <select id="vat2-cap" class="form-select">
            <option value="na">N/A</option>
            <option value="available">Available ✓</option>
            <option value="unavailable">Unavailable ✗</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Cap Photo</label>
          <input id="vat2-cap-photo" type="file" class="form-control" accept="image/*">
          <img id="vat2-cap-preview" class="photo-thumb mt-2 d-none">
        </div>
        <div class="col-md-4">
          <label class="form-label">Condition</label>
          <select id="vat2-condition" class="form-select">
            <option value="na">N/A</option>
            <option value="ok">OK</option>
            <option value="attention">Attention Required</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Condition Photo</label>
          <input id="vat2-condition-photo" type="file" class="form-control" accept="image/*">
          <img id="vat2-condition-preview" class="photo-thumb mt-2 d-none">
        </div>
        <div class="col-md-4">
          <label class="form-label">Serial Number</label>
          <input id="vat2-serial" class="form-control" placeholder="Plate / SN">
        </div>
        <div class="col-md-6">
          <label class="form-label">Agitator Sensor Location (Vat 2)</label>
          <input id="agitator2-location" class="form-control" placeholder="e.g. top manhole, rear left">
        </div>
        <div class="col-md-6">
          <label class="form-label">Agitator Photo</label>
          <input id="agitator2-photo" type="file" class="form-control" accept="image/*">
          <img id="agitator2-preview" class="photo-thumb mt-2 d-none">
        </div>
      </div>
    </div>

    <!-- Gateway -->
    <div class="ag-card p-3 mb-3">
      <h6 class="ag-title mb-2">Gateway</h6>
      <div class="row g-3">
        <div class="col-md-8">
          <label class="form-label">Location</label>
          <input id="gateway-location" class="form-control" placeholder="e.g. plant room, office wall">
        </div>
        <div class="col-md-4">
          <label class="form-label">Photo</label>
          <input id="gateway-photo" type="file" class="form-control" accept="image/*">
          <img id="gateway-preview" class="photo-thumb mt-2 d-none">
        </div>
      </div>
    </div>

    <!-- Signals -->
    <div class="ag-card p-3 mb-3">
      <h6 class="ag-title mb-2">Mobile Signal</h6>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Spark (bars)</label>
          <input id="signal-spark" class="form-control" inputmode="numeric" placeholder="0–5 bars">
        </div>
        <div class="col-md-6">
          <label class="form-label">One NZ (bars)</label>
          <input id="signal-one" class="form-control" inputmode="numeric" placeholder="0–5 bars">
        </div>
      </div>
    </div>

    <!-- Other telemetry -->
    <div class="ag-card p-3 mb-3">
      <h6 class="ag-title mb-2">Other Telemetry</h6>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Brand</label>
          <input id="tele-brand" class="form-control" placeholder="Halo, Levno, NDA, DTS…">
        </div>
        <div class="col-md-4">
          <label class="form-label">Type</label>
          <input id="tele-type" class="form-control" placeholder="vat, water, fuel…">
        </div>
        <div class="col-md-4">
          <label class="form-label">Serial / Notes</label>
          <input id="tele-serial" class="form-control" placeholder="SN or reference">
        </div>
      </div>
    </div>

    <!-- Rubberware -->
    <div class="ag-card p-3 mb-2">
      <h6 class="ag-title mb-2">Rubberware</h6>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Vat Door Seal</label>
          <select id="vat-door-seal" class="form-select">
            <option value="notdelivered">Not Delivered</option>
            <option value="delivered">Delivered</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Door Seal Size</label>
          <select id="door-seal-size" class="form-select">
            <option value="">Size unspecified</option>
            <option value="small">Small</option>
            <option value="large">Large</option>
          </select>
          <div class="form-text">If two vats, delivered qty = 2.</div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Delivery Evidence Photo</label>
          <input id="vat-door-seal-photo" type="file" class="form-control" accept="image/*">
          <img id="vat-door-seal-preview" class="photo-thumb mt-2 d-none">
        </div>

        <div class="col-md-4">
          <label class="form-label">RJT Step Seal</label>
          <select id="rjt-seal" class="form-select">
            <option value="notdelivered">Not Delivered</option>
            <option value="delivered">Delivered</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">RJT Size</label>
          <select id="rjt-seal-size" class="form-select">
            <option value="">Size unspecified</option>
            <option value="small">Small</option>
            <option value="large">Large</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">RJT Photo</label>
          <input id="rjt-seal-photo" type="file" class="form-control" accept="image/*">
          <img id="rjt-seal-preview" class="photo-thumb mt-2 d-none">
        </div>

        <div class="col-md-4">
          <label class="form-label">Chiller Condition</label>
          <select id="chiller-condition" class="form-select">
            <option value="ok">OK</option>
            <option value="attention">Attention Required</option>
          </select>
        </div>
        <div class="col-md-8">
          <label class="form-label">Chiller Photo</label>
          <input id="chiller-condition-photo" type="file" class="form-control" accept="image/*">
          <img id="chiller-condition-preview" class="photo-thumb mt-2 d-none">
        </div>
      </div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button id="btnSave" class="btn btn-primary flex-fill"><i class="bi bi-save me-1"></i>Save</button>
      <button id="btnPDF" class="btn btn-outline-secondary"><i class="bi bi-printer me-1"></i>Print/PDF</button>
    </div>
  </section>

  <!-- ========== SUMMARY ========== -->
  <section id="tab-summary" class="d-none">
    <div class="ag-card p-3 p-md-4">
      <div class="d-flex gap-2 align-items-center flex-wrap">
        <div class="input-group" style="max-width:460px">
          <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
          <input id="searchBox" class="form-control" placeholder="Search Dairy # / text…">
          <button id="searchApply" class="btn btn-outline-secondary">Apply</button>
          <button id="searchClear" class="btn btn-outline-secondary">Clear</button>
        </div>
        <button id="btnExportCSV" class="btn btn-outline-primary ms-auto"><i class="bi bi-filetype-csv me-1"></i>Export Vat Sizes CSV</button>
      </div>
      <div class="row row-cols-1 row-cols-md-2 g-3 mt-2">
        <div class="col"><div class="stat-card pointer" data-card="farms"><div class="stat-num" id="statTotal">0</div><div class="text-muted">Total Farms</div></div></div>
        <div class="col"><div class="stat-card pointer" data-card="attention"><div class="stat-num" id="statAttn">0</div><div class="text-muted">Any Attention</div></div></div>
        <div class="col"><div class="stat-card pointer" data-card="nocap"><div class="stat-num" id="statNoCap">0</div><div class="text-muted">No Available Cap</div></div></div>
        <div class="col"><div class="stat-card pointer" data-card="door"><div class="stat-num" id="statDoor">0</div><div class="text-muted">Door Seals Delivered</div></div></div>
        <div class="col"><div class="stat-card pointer" data-card="dts"><div class="stat-num" id="statDTS">0</div><div class="text-muted">DTS / Vent Caps</div></div></div>
        <div class="col"><div class="stat-card pointer" data-card="pp"><div class="stat-num" id="statPP">0</div><div class="text-muted">Power Points Needed</div></div></div>
        <div class="col"><div class="stat-card pointer" data-card="pref"><div class="stat-num" id="statPref">0</div><div class="text-muted">Spark vs One NZ (preferred)</div></div></div>
      </div>
    </div>

    <!-- Farm cards list -->
    <div id="farmCards" class="mt-3"></div>
  </section>

  <!-- ========== ADMIN (download/cache) ========== -->
  <section id="tab-admin" class="d-none">
    <div class="ag-card p-3 p-md-4">
      <h6 class="ag-title mb-2">Cloud Sync</h6>
      <div class="row g-3">
        <div class="col-md-4"><div class="stat-card"><div class="text-muted small">Cloud Records</div><div class="h3 mb-0" id="statCloud">–</div></div></div>
        <div class="col-md-4"><div class="stat-card"><div class="text-muted small">Downloaded (cached)</div><div class="h3 mb-0" id="statCached">0</div></div></div>
        <div class="col-md-4"><div class="stat-card"><div class="text-muted small">New to Download</div><div class="h3 mb-0" id="statToGet">–</div></div></div>
      </div>
      <div class="mt-3">
        <div class="progress"><div id="dlProgress" class="progress-bar" style="width:0%">0%</div></div>
        <div class="d-flex gap-2 mt-2">
          <button id="btnSync" class="btn btn-success"><i class="bi bi-cloud-arrow-down me-1"></i>Download All</button>
          <span id="syncStatus" class="align-self-center text-muted small">Waiting…</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal for photos -->
  <div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h6 class="modal-title" id="photoModalTitle">Photos</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body" id="photoModalBody"></div>
      </div>
    </div>
  </div>

  <div id="printHost" class="d-none"></div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ===== Firebase ===== */
const firebaseConfig={
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage=firebase.storage();

/* ===== Local DB ===== */
const db=new Dexie('vat_precheck_ai');
db.version(2).stores({forms:'dairyNumber',cache:'dairyNumber,timestamp'});

/* ===== Helpers ===== */
const $=s=>document.querySelector(s);const $$=s=>Array.from(document.querySelectorAll(s));
const toB64=f=>new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f)});
function bindPreview(fileId,imgId){
  const input=$( '#'+fileId ), img=$( '#'+imgId );
  input.addEventListener('change',async e=>{
    const f=e.target.files?.[0]; if(!f){img.classList.add('d-none');img.src='';return;}
    img.src=URL.createObjectURL(f); img.classList.remove('d-none'); img.dataset.base64=await toB64(f);
  });
}
['vat1-cap','vat1-condition','vat2-cap','vat2-condition','gateway','agitator1','agitator2','vat-door-seal','rjt-seal','chiller-condition']
.forEach(k=>{ if($('#'+k+'-photo')) bindPreview(k+'-photo',k+'-preview'); });

/* logo for header + pdf */
let logoB64=''; (async()=>{try{
  const ref=storage.ref("Agora Logo/2F6-1YdaEP.jpeg");
  const url=await ref.getDownloadURL(); const blob=await (await fetch(url)).blob();
  logoB64=await toB64(blob); const img=$('#logoHeader'); img.src=url; img.classList.remove('d-none');
}catch(e){}})();

/* ===== Normalisers ("AI") ===== */
const isDTSVent=t=>!!String(t||'').toLowerCase().match(/dts\b|vent\s*cap|grey\s*halo|gray\s*halo|grey\s*sensor|gray\s*sensor|grey\s*cap|gray\s*cap/);
const needsPowerPoint=t=>!!String(t||'').toLowerCase().match(/power ?point|pp\s*(req|needed|recommended)|splitter plug|double adaptor/);
const carrierPref=(s,o,n='')=>{s=parseInt(s||0)||0;o=parseInt(o||0)||0; if(s>o)return'Spark'; if(o>s)return'One NZ';
  const t=(n||'').toLowerCase(); if(/spark\s*(better|ok|good)/.test(t))return'Spark'; if(/one\s*nz\s*(better|ok|good)/.test(t))return'One NZ'; return'Undecided'}

/* ===== Tabs ===== */
function showTab(id){['tab-form','tab-summary','tab-admin'].forEach(x=>$('#'+x).classList.add('d-none')); $('#'+id).classList.remove('d-none');
  $$('#tabFormBtn,#tabSummaryBtn,#tabAdminBtn').forEach(b=>b.classList.remove('active'));
  if(id==='tab-form')$('#tabFormBtn').classList.add('active'); if(id==='tab-summary')$('#tabSummaryBtn').classList.add('active'); if(id==='tab-admin')$('#tabAdminBtn').classList.add('active');
}
$('#tabFormBtn').onclick=()=>showTab('tab-form'); $('#tabSummaryBtn').onclick=()=>{showTab('tab-summary');renderSummary();}; $('#tabAdminBtn').onclick=()=>{showTab('tab-admin');refreshAdminCounts();};
showTab('tab-form');

/* ===== Vat 2 visibility ===== */
function toggleVat2(){
  const has=!!$('#vat2-capacity').value.trim();
  $('#vat2-card').classList.toggle('d-none',!has);
  if(!has){ $('#vat2-cap').value='na'; $('#vat2-condition').value='na'; $('#agitator2-location').value=''; $('#vat2-serial').value=''; }
}
$('#vat2-capacity').addEventListener('input',toggleVat2);

/* ===== Load existing on blur ===== */
$('#dairyNumber').addEventListener('blur', async ()=>{
  const n=$('#dairyNumber').value.trim(); if(!n) return;
  let rec=await db.forms.get(n);
  if(!rec){ try{const url=await storage.ref(`Pre Check/${n}.json`).getDownloadURL(); rec=await (await fetch(url)).json();}catch{} }
  if(rec) fillForm(rec);
});
function fillForm(d){
  const set=(id,v)=>{const el=$('#'+id); if(el) el.value=v??''}
  set('vat1-capacity',d['vat1-capacity']); set('vat1-cap',d['vat1-cap']||'available'); set('vat1-condition',d['vat1-condition']||'ok'); set('vat1-serial',d['vat1-serial']); set('agitator1-location',d['agitator1-location']);
  set('vat2-capacity',d['vat2-capacity']); set('vat2-cap',d['vat2-cap']||'na'); set('vat2-condition',d['vat2-condition']||'na'); set('vat2-serial',d['vat2-serial']); set('agitator2-location',d['agitator2-location']);
  set('gateway-location',d['gateway-location']); set('signal-spark',d['signal-spark']); set('signal-one',d['signal-one']);
  set('tele-brand',d['tele-brand']); set('tele-type',d['tele-type']); set('tele-serial',d['tele-serial']);
  set('vat-door-seal',d['vat-door-seal']||'notdelivered'); set('door-seal-size',d['door-seal-size']||''); set('rjt-seal',d['rjt-seal']||'notdelivered'); set('rjt-seal-size',d['rjt-seal-size']||''); set('chiller-condition',d['chiller-condition']||'ok');
  // previews
  ['vat1-cap','vat1-condition','vat2-cap','vat2-condition','gateway','agitator1','agitator2','vat-door-seal','rjt-seal','chiller-condition'].forEach(k=>{
    const b=d[`${k}-photo-base64`]; const prev=$('#'+k+'-preview'); if(prev&&b){prev.src=b;prev.classList.remove('d-none');prev.dataset.base64=b;}
  });
  toggleVat2();
}

/* ===== Save & Print ===== */
function collectForm(){
  const d=$('#dairyNumber').value.trim(); const v2=$('#vat2-capacity').value.trim();
  const out={dairyNumber:d,timestamp:Date.now(),
    'vat1-capacity':$('#vat1-capacity').value.trim(),'vat1-cap':$('#vat1-cap').value,'vat1-condition':$('#vat1-condition').value,'vat1-serial':$('#vat1-serial').value.trim(),'agitator1-location':$('#agitator1-location').value.trim(),
    'vat2-capacity':v2||'','vat2-cap':v2?$('#vat2-cap').value:'na','vat2-condition':v2?$('#vat2-condition').value:'na','vat2-serial':v2?$('#vat2-serial').value.trim():'','agitator2-location':v2?$('#agitator2-location').value.trim():'',
    'gateway-location':$('#gateway-location').value.trim(),'signal-spark':$('#signal-spark').value.trim(),'signal-one':$('#signal-one').value.trim(),
    'tele-brand':$('#tele-brand').value.trim(),'tele-type':$('#tele-type').value.trim(),'tele-serial':$('#tele-serial').value.trim(),
    'vat-door-seal':$('#vat-door-seal').value,'door-seal-size':$('#door-seal-size').value,'rjt-seal':$('#rjt-seal').value,'rjt-seal-size':$('#rjt-seal-size').value,'chiller-condition':$('#chiller-condition').value
  };
  ['vat1-cap','vat1-condition','vat2-cap','vat2-condition','gateway','agitator1','agitator2','vat-door-seal','rjt-seal','chiller-condition'].forEach(k=>{
    const p=$('#'+k+'-preview'); if(p&&p.dataset.base64) out[`${k}-photo-base64`]=p.dataset.base64;
  });
  return out;
}
$('#btnSave').onclick=async()=>{
  const d=$('#dairyNumber').value.trim(); if(!d){alert('Enter dairy number');return;}
  const rec=collectForm(); await db.forms.put(rec);
  await storage.ref(`Pre Check/${d}.json`).put(new Blob([JSON.stringify(rec)],{type:'application/json'}));
  alert('Saved.');
};

$('#btnPDF').onclick=async()=>{ await renderPrint(collectForm()); };

async function renderPrint(rec){
  const host=$('#printHost'); host.innerHTML='';
  const page=document.createElement('div'); page.className='print-sheet';
  const pref=carrierPref(rec['signal-spark'],rec['signal-one']);
  page.innerHTML=`
    <div class="d-flex justify-content-between align-items-center" style="border-bottom:2px solid #e5e7eb;padding-bottom:8px;margin-bottom:12px">
      <div class="d-flex align-items-center gap-2">
        ${logoB64?`<img src="${logoB64}" class="logo-small">`:''}
        <div><div style="font-size:18pt;font-weight:800;color:#2563eb">Vat Pre-Check</div><div class="text-muted">Dairy #${rec.dairyNumber||'—'}</div></div>
      </div>
      <div class="text-muted">${new Date().toISOString().slice(0,10)}</div>
    </div>
    <table style="width:100%;font-size:10.5pt;border-collapse:separate;border-spacing:0 4px">
      <tr><td style="width:80px;font-weight:700">Vat 1:</td><td>${rec['vat1-capacity']||'—'} L • Cap ${rec['vat1-cap']||'-'} • Cond ${rec['vat1-condition']||'-'} • SN ${rec['vat1-serial']||'-'} • Agit ${rec['agitator1-location']||'-'}</td></tr>
      <tr><td style="font-weight:700">Vat 2:</td><td>${(rec['vat2-capacity']||'—')} L • Cap ${rec['vat2-cap']||'na'} • Cond ${rec['vat2-condition']||'na'} • SN ${rec['vat2-serial']||'-'} • Agit ${rec['agitator2-location']||'-'}</td></tr>
      <tr><td style="font-weight:700">Gateway:</td><td>${rec['gateway-location']||'—'}</td></tr>
      <tr><td style="font-weight:700">Signal:</td><td>Spark ${rec['signal-spark']||0} • One NZ ${rec['signal-one']||0} • Pref ${pref}</td></tr>
      <tr><td style="font-weight:700">Telemetry:</td><td>${rec['tele-brand']||'-'} (${rec['tele-type']||'-'}) SN: ${rec['tele-serial']||'-'}</td></tr>
      <tr><td style="font-weight:700">Rubberware:</td><td>Door: ${rec['vat-door-seal']||'notdelivered'} • Size ${rec['door-seal-size']||'unspecified'} | RJT: ${rec['rjt-seal']||'notdelivered'} • Size ${rec['rjt-seal-size']||'unspecified'} | Chiller: ${rec['chiller-condition']||'ok'}</td></tr>
    </table>
    <div class="mt-2 fw-bold">Photos</div>
    <div id="ph"></div>`;
  host.appendChild(page);
  const labels={'vat1-cap':'Vat 1 Cap','vat1-condition':'Vat 1 Condition','agitator1':'Vat 1 Agitator','vat2-cap':'Vat 2 Cap','vat2-condition':'Vat 2 Condition','agitator2':'Vat 2 Agitator','gateway':'Gateway','vat-door-seal':'Door Seal','rjt-seal':'RJT','chiller-condition':'Chiller'};
  const ph=page.querySelector('#ph');
  Object.keys(labels).forEach(k=>{const b=rec[`${k}-photo-base64`]; if(b){const im=document.createElement('img'); im.src=b; im.className='print-photo'; im.alt=labels[k]; ph.appendChild(im);}});
  const {jsPDF}=window.jspdf; const pdf=new jsPDF({unit:'pt',format:'a4',orientation:'portrait'});
  await pdf.html(page,{html2canvas:{scale:2},x:28,y:20}); pdf.save(`PreCheck_${rec.dairyNumber||'farm'}.pdf`);
}

/* ===== Cloud sync (auto-start) ===== */
async function listCloud(){ const folder=storage.ref('Pre Check'); const out=[]; let page=await folder.list({maxResults:1000}); out.push(...page.items);
  while(page.nextPageToken){ page=await folder.list({maxResults:1000,pageToken:page.nextPageToken}); out.push(...page.items);} return out; }
async function refreshAdminCounts(){ try{const cloud=await listCloud(); $('#statCloud').textContent=cloud.length; const cached=await db.cache.count(); $('#statCached').textContent=cached; $('#statToGet').textContent=Math.max(0,cloud.length-cached);}catch{} }
async function downloadAll(){
  $('#syncStatus').textContent='Listing…'; const files=await listCloud(); let done=0;
  for(const f of files){ const url=await f.getDownloadURL(); const d=await (await fetch(url)).json(); await db.cache.put({dairyNumber:d.dairyNumber||f.name.replace('.json',''),...d}); done++;
    const pct=Math.round(done*100/files.length); $('#dlProgress').style.width=pct+'%'; $('#dlProgress').textContent=pct+'%'; $('#syncStatus').textContent=`Downloaded ${done}/${files.length}`; }
  $('#syncStatus').textContent='Complete.'; await renderSummary(); await refreshAdminCounts();
}
$('#btnSync').onclick=downloadAll;
window.addEventListener('load', async()=>{ try{await refreshAdminCounts(); await downloadAll();}catch{} });

/* ===== Summary & Cards (with EVENT DELEGATION) ===== */
let filterText='';
$('#searchApply').onclick=()=>{filterText=$('#searchBox').value.trim().toLowerCase(); renderSummary();};
$('#searchClear').onclick=()=>{filterText=''; $('#searchBox').value=''; renderSummary();};

async function getRecords(){ const cached=await db.cache.toArray(); if(cached.length) return cached;
  const files=await listCloud(); const arr=[]; for(const f of files.slice(0,200)){ const url=await f.getDownloadURL(); arr.push(await (await fetch(url)).json()); } return arr; }

function farmCard(rec){
  const hasV2=!!rec['vat2-capacity']; const pref=carrierPref(rec['signal-spark'],rec['signal-one']);
  const dts=isDTSVent([rec['tele-brand'],rec['tele-type'],rec['vat1-cap'],rec['vat2-cap']].join(' '));
  const pp=needsPowerPoint([rec['gateway-location'],rec['tele-serial'],rec['tele-type']].join(' '));
  const attn=(rec['vat1-condition']==='attention'||rec['vat2-condition']==='attention'||rec['chiller-condition']==='attention');
  return `<div class="ag-card p-3 mb-3 pointer farm-card" data-id="${rec.dairyNumber}">
    <div class="d-flex justify-content-between align-items-center">
      <div class="h6 mb-0">#${rec.dairyNumber}</div>
      <div>${attn?'<span class="badge text-bg-danger me-1">Attention</span>':''}<span class="badge text-bg-light">Updated ${new Date(rec.timestamp||Date.now()).toLocaleDateString()}</span></div>
    </div>
    <div class="small mt-1">
      <span class="chip">Vat 1: ${rec['vat1-capacity']||'—'}L • ${rec['vat1-cap']||'-'} • ${rec['vat1-condition']||'-'} • SN ${rec['vat1-serial']||'-'}</span>
      ${hasV2?`<span class="chip">Vat 2: ${rec['vat2-capacity']}L • ${rec['vat2-cap']||'-'} • ${rec['vat2-condition']||'-'} • SN ${rec['vat2-serial']||'-'}</span>`:''}
      <span class="chip">Gateway: ${rec['gateway-location']||'-'}</span>
      <span class="chip">Signal: Spark ${rec['signal-spark']||0} • OneNZ ${rec['signal-one']||0} • Pref ${pref}</span>
      <span class="chip">Telemetry: ${rec['tele-brand']||'-'} (${rec['tele-type']||'-'})</span>
    </div>
    <div class="mt-2">
      ${dts?'<span class="badge text-bg-primary me-1">DTS/Vent Cap</span>':''}
      ${pp?'<span class="badge text-bg-warning me-1 text-dark">Power Point</span>':''}
      <button class="btn btn-outline-secondary btn-sm" data-act="photos" data-id="${rec.dairyNumber}"><i class="bi bi-images me-1"></i>Photos</button>
      <button class="btn btn-primary btn-sm" data-act="print" data-id="${rec.dairyNumber}"><i class="bi bi-printer me-1"></i>Print</button>
    </div>
  </div>`;
}

async function renderSummary(){
  const all=await getRecords();
  const list=all.filter(r=>!filterText || JSON.stringify(r).toLowerCase().includes(filterText));
  // stats
  $('#statTotal').textContent=list.length;
  $('#statAttn').textContent=list.filter(r=>r['vat1-condition']==='attention'||r['vat2-condition']==='attention'||r['chiller-condition']==='attention').length;
  $('#statNoCap').textContent=list.filter(r=> (r['vat1-cap'] && r['vat1-cap']!=='available') || (r['vat2-cap'] && r['vat2-cap']!=='available' && r['vat2-cap']!=='na')).length;
  $('#statDoor').textContent=list.reduce((a,r)=>a+(r['vat-door-seal']==='delivered'?(r['vat2-capacity']?2:1):0),0);
  $('#statDTS').textContent=list.filter(r=>isDTSVent([r['tele-brand'],r['tele-type'],r['vat1-cap'],r['vat2-cap'],r['gateway-location']].join(' '))).length;
  $('#statPP').textContent=list.filter(r=>needsPowerPoint([r['gateway-location'],r['tele-serial'],r['tele-type']].join(' '))).length;
  $('#statPref').textContent=list.filter(r=>carrierPref(r['signal-spark'],r['signal-one'])!=='Undecided').length;

  // cards
  const host=$('#farmCards'); host.innerHTML=''; list.sort((a,b)=>String(a.dairyNumber).localeCompare(String(b.dairyNumber)));
  host.innerHTML=list.map(farmCard).join('');
  host.dataset.count=list.length; // used by click handler
  host._records=list;            // stash list for quick lookup
}

/* ===== CARD CLICK HANDLING (event delegation) ===== */
const cardsHost = document.getElementById('farmCards');
cardsHost.addEventListener('click', async (e)=>{
  const btn=e.target.closest('button[data-act]'); // photos/print buttons
  if(btn){
    const id=btn.dataset.id; const rec=(cardsHost._records||[]).find(x=>String(x.dairyNumber)===String(id)); if(!rec) return;
    if(btn.dataset.act==='photos'){
      showPhotos(rec);
    }else if(btn.dataset.act==='print'){
      await renderPrint(rec);
    }
    e.stopPropagation(); return;
  }
  // click anywhere on the card → open details (like ticket)
  const card=e.target.closest('.farm-card'); if(!card) return;
  const id=card.dataset.id; const rec=(cardsHost._records||[]).find(x=>String(x.dairyNumber)===String(id)); if(!rec) return;
  showDetailsCard(rec);
});

function labeledPhotoList(rec){
  const labels={'vat1-cap':'Vat 1 Cap','vat1-condition':'Vat 1 Condition','agitator1':'Vat 1 Agitator','vat2-cap':'Vat 2 Cap','vat2-condition':'Vat 2 Condition','agitator2':'Vat 2 Agitator','gateway':'Gateway','vat-door-seal':'Door Seal','rjt-seal':'RJT','chiller-condition':'Chiller'};
  const parts=[];
  Object.keys(labels).forEach(k=>{
    const b=rec[`${k}-photo-base64`]; if(b){parts.push(`<div class="mb-3"><div class="small text-muted mb-1">${labels[k]}</div><img src="${b}" class="photo-thumb w-100"></div>`);}
  });
  return parts.join('')||'<em>No photos</em>';
}
function showPhotos(rec){
  $('#photoModalTitle').textContent=`Photos • #${rec.dairyNumber}`;
  $('#photoModalBody').innerHTML=labeledPhotoList(rec);
  new bootstrap.Modal('#photoModal').show();
}
function showDetailsCard(rec){
  // mimic ticket details layout but with pre-check data
  const pref=carrierPref(rec['signal-spark'],rec['signal-one']);
  const html=`
    <div class="ag-card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <div class="h5 mb-0">#${rec.dairyNumber}</div>
        <div>
          ${(rec['vat1-condition']==='attention'||rec['vat2-condition']==='attention'||rec['chiller-condition']==='attention')?'<span class="badge text-bg-danger me-2">Attention</span>':''}
          <button class="btn btn-outline-secondary btn-sm me-1" data-act="photos" data-id="${rec.dairyNumber}"><i class="bi bi-images me-1"></i>Photos</button>
          <button class="btn btn-primary btn-sm" data-act="print" data-id="${rec.dairyNumber}"><i class="bi bi-printer me-1"></i>Print</button>
        </div>
      </div>
      <div class="mt-2">
        <div><strong>Vat 1:</strong> ${rec['vat1-capacity']||'—'}L • Cap ${rec['vat1-cap']||'-'} • Cond ${rec['vat1-condition']||'-'} • SN ${rec['vat1-serial']||'-'} • Agit ${rec['agitator1-location']||'-'}</div>
        ${rec['vat2-capacity']?`<div><strong>Vat 2:</strong> ${rec['vat2-capacity']}L • Cap ${rec['vat2-cap']||'-'} • Cond ${rec['vat2-condition']||'-'} • SN ${rec['vat2-serial']||'-'} • Agit ${rec['agitator2-location']||'-'}</div>`:''}
        <div><strong>Gateway:</strong> ${rec['gateway-location']||'-'}</div>
        <div><strong>Signal:</strong> Spark ${rec['signal-spark']||0} • One NZ ${rec['signal-one']||0} • Preferred: ${pref}</div>
        <div><strong>Other Telemetry:</strong> ${rec['tele-brand']||'-'} (${rec['tele-type']||'-'}) SN: ${rec['tele-serial']||'-'}</div>
        <div><strong>Rubberware:</strong> Door ${rec['vat-door-seal']||'-'} ${rec['door-seal-size']||''} | RJT ${rec['rjt-seal']||'-'} ${rec['rjt-seal-size']||''} | Chiller ${rec['chiller-condition']||'-'}</div>
      </div>
    </div>`;
  // replace list with one card at top (keeps context)
  const host=$('#farmCards'); host.insertAdjacentHTML('afterbegin', html);
}

/* ===== CSV (vat sizes) ===== */
function exportCSV(rows,name){const csv=rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download=name;a.click();}
$('#btnExportCSV').onclick=async()=>{
  const list=await getRecords(); const rows=[['Vat Size (L)','Vat #','Manufacturer/Brand','Dairy #','Cap Available']];
  list.forEach(r=>{const maker=r['tele-brand']||''; if(r['vat1-capacity']) rows.push([r['vat1-capacity'],'Vat 1',maker,r.dairyNumber,r['vat1-cap']||'']); if(r['vat2-capacity']) rows.push([r['vat2-capacity'],'Vat 2',maker,r.dairyNumber,r['vat2-cap']||'']);});
  exportCSV(rows,'vat_sizes.csv');
};
</script>
</body>
</html>