<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agora Vat Pre-Check</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root{--brand:#a7ab01;--ink:#111827;--muted:#6b7280;--accent:#FF851B;--ok:#2E7D32;--warn:#b53b00;--bad:#b71c1c}
  body{background:#f7f8fb;color:var(--ink)}
  .container-main{max-width:1100px;margin:18px auto;padding:12px}
  h1{color:var(--brand);font-weight:800;text-align:center}
  .tabs{display:flex;gap:10px;justify-content:center;margin:12px 0 14px;flex-wrap:wrap}
  .tab-btn{border:1px solid #e5e7eb;border-radius:10px;padding:9px 14px;background:#fff;color:#111;font-weight:700}
  .tab-btn.active{background:var(--brand);color:#fff}
  .section{background:#fff;border-radius:14px;box-shadow:0 2px 22px #0000000d;padding:14px;margin-bottom:16px}
  .image-preview{display:none;max-width:210px;margin-top:6px;border:2px solid #e5e7eb;border-radius:8px}
  .kpi{border:1px solid #eee;border-radius:12px;padding:12px;background:#fff}
  .kpi .num{font-size:1.5rem;font-weight:800}
  .kpi .label{font-size:.95rem;color:var(--muted)}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  @media(max-width:992px){.grid-4{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:700px){.grid-4,.grid-3,.grid-2{grid-template-columns:1fr}}
  .tcard{border:1px solid #eee;border-radius:12px;background:#fff;padding:12px}
  .t-head{display:flex;justify-content:space-between;gap:10px;align-items:start}
  .b{border:1px solid #e5e7eb;border-radius:10px;padding:2px 8px;font-size:.85rem;margin:2px}
  .b.ok{color:var(--ok);border-color:#cde9d5;background:#f3fbf5}
  .b.attn{color:var(--warn);border-color:#ffd2a6;background:#fff6ec}
  .b.bad{color:var(--bad);border-color:#ffb2b2;background:#fff0f0}
  .thumb{width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #eee}
  .chip{display:inline-block;padding:4px 10px;border:1px solid #ddd;border-radius:16px;margin-right:6px;cursor:pointer}
  .chip.active{border-color:var(--accent);color:var(--accent);font-weight:700}
  .btn-brand{background:var(--accent);color:#fff;border:none}
  .btn-brand:hover{background:#ff6d00}
  .small-note{color:var(--muted);font-size:.9rem}
  .progress{height:10px}
  /* Print brochure */
  @media print{
    body{background:#fff}
    .no-print{display:none !important}
    .print-brochure{display:block}
  }
  .print-brochure{display:none}
</style>
</head>
<body>
<div class="container-main">
  <h1>Agora Vat Pre-Check</h1>
  <div class="tabs no-print">
    <button class="tab-btn" id="tab-form" onclick="showTab('form')">üßæ Form</button>
    <button class="tab-btn" id="tab-summary" onclick="showTab('summary')">üü© Summary</button>
    <button class="tab-btn" id="tab-admin" onclick="showTab('admin')">‚¨áÔ∏è Admin</button>
  </div>

  <!-- ============ FORM (same as before, VAT first; vat lvl fields removed) ============ -->
  <div id="form-section" class="section">
    <div class="mb-2">
      <label class="form-label">Dairy Number</label>
      <input id="dairyNumber" class="form-control" placeholder="e.g. 12345" required>
    </div>

    <div class="grid grid-2">
      <div>
        <label class="form-label">Vat 1 Cap</label>
        <select id="vat1-cap" class="form-select" onchange="togglePhoto('vat1-cap')">
          <option value="available" selected>Available ‚úì</option>
          <option value="unavailable">Unavailable ‚úó</option>
        </select>
        <input id="vat1-cap-comments" class="form-control mt-1" placeholder="Comments">
        <input id="vat1-cap-photo" type="file" accept="image/*" class="form-control mt-1" style="display:none" onchange="previewImage(event,'vat1-cap-preview')">
        <img id="vat1-cap-preview" class="image-preview">
      </div>

      <div>
        <label class="form-label">Vat 2 Cap</label>
        <select id="vat2-cap" class="form-select" onchange="togglePhoto('vat2-cap')">
          <option value="na" selected>N/A</option>
          <option value="available">Available ‚úì</option>
          <option value="unavailable">Unavailable ‚úó</option>
        </select>
        <input id="vat2-cap-comments" class="form-control mt-1" placeholder="Comments">
        <input id="vat2-cap-photo" type="file" accept="image/*" class="form-control mt-1" style="display:none" onchange="previewImage(event,'vat2-cap-preview')">
        <img id="vat2-cap-preview" class="image-preview">
      </div>

      <div>
        <label class="form-label">Vat 1 Condition</label>
        <select id="vat1-condition" class="form-select" onchange="toggleExtra('vat1')">
          <option value="ok" selected>OK</option>
          <option value="attention">Attention Required</option>
        </select>
        <div id="vat1-extra" style="display:none">
          <input id="vat1-condition-comments" class="form-control mt-1" placeholder="Describe issue">
          <input id="vat1-condition-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'vat1-condition-preview')">
          <img id="vat1-condition-preview" class="image-preview">
        </div>
      </div>

      <div>
        <label class="form-label">Vat 2 Condition</label>
        <select id="vat2-condition" class="form-select" onchange="toggleExtra('vat2')">
          <option value="na" selected>N/A</option>
          <option value="ok">OK</option>
          <option value="attention">Attention Required</option>
        </select>
        <div id="vat2-extra" style="display:none">
          <input id="vat2-condition-comments" class="form-control mt-1" placeholder="Describe issue">
          <input id="vat2-condition-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'vat2-condition-preview')">
          <img id="vat2-condition-preview" class="image-preview">
        </div>
      </div>

      <div>
        <label class="form-label">Vat 1 Serial #</label>
        <input id="vat1-serial" class="form-control" placeholder="e.g. ABC123">
      </div>
      <div>
        <label class="form-label">Vat 2 Serial #</label>
        <input id="vat2-serial" class="form-control" placeholder="(optional)">
      </div>
    </div>

    <div class="mt-3">
      <label class="form-label">Agitator Sensor Location</label>
      <input id="agitator-location" class="form-control" placeholder="e.g. baffle / LHS">
      <input id="agitator-comments" class="form-control mt-1" placeholder="Comments">
      <input id="agitator-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'agitator-preview')">
      <img id="agitator-preview" class="image-preview">
    </div>

    <div class="mt-3">
      <label class="form-label">Gateway Location</label>
      <input id="gateway-location" class="form-control" placeholder="e.g. plant room / office">
      <input id="gateway-comments" class="form-control mt-1" placeholder="Comments">
      <input id="gateway-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'gateway-preview')">
      <img id="gateway-preview" class="image-preview">
    </div>

    <div class="mt-3">
      <label class="form-label">Current Telemetry</label>
      <input id="current-telemetry" class="form-control" placeholder="Brand/model or N/A">
      <input id="telemetry-comments" class="form-control mt-1" placeholder="Comments">
    </div>

    <div class="mt-3">
      <div class="fw-bold mb-1" style="color:var(--brand)">Rubberware</div>
      <div class="grid grid-2">
        <div>
          <label class="form-label">Vat Door Seal</label>
          <select id="vat-door-seal" class="form-select" onchange="toggleDoorSeal()">
            <option value="notdelivered" selected>Not Delivered</option>
            <option value="delivered">Delivered</option>
          </select>
          <div id="door-extra" style="display:none">
            <select id="door-seal-size" class="form-select mt-1">
              <option value="">Select Size</option>
              <option value="small">Small</option>
              <option value="large">Large</option>
            </select>
            <input id="vat-door-seal-comments" class="form-control mt-1" placeholder="Notes">
            <input id="vat-door-seal-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'vat-door-seal-preview')">
            <img id="vat-door-seal-preview" class="image-preview">
          </div>
        </div>
        <div>
          <label class="form-label">RJT Step Seal</label>
          <select id="rjt-seal" class="form-select" onchange="toggleRJT()">
            <option value="notdelivered" selected>Not Delivered</option>
            <option value="delivered">Delivered</option>
          </select>
          <div id="rjt-extra" style="display:none">
            <select id="rjt-seal-size" class="form-select mt-1">
              <option value="">Select Size</option>
              <option value="small">Small</option>
              <option value="large">Large</option>
            </select>
            <input id="rjt-seal-comments" class="form-control mt-1" placeholder="Notes">
            <input id="rjt-seal-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'rjt-seal-preview')">
            <img id="rjt-seal-preview" class="image-preview">
          </div>
        </div>
        <div>
          <label class="form-label">Chiller Condition</label>
          <select id="chiller-condition" class="form-select" onchange="toggleChiller()">
            <option value="ok" selected>OK</option>
            <option value="attention">Attention Required</option>
          </select>
          <div id="chiller-extra" style="display:none">
            <input id="chiller-condition-comments" class="form-control mt-1" placeholder="Describe issue">
            <input id="chiller-condition-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'chiller-condition-preview')">
            <img id="chiller-condition-preview" class="image-preview">
          </div>
        </div>
      </div>
    </div>

    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-brand" onclick="saveForm();return false;">Save</button>
      <button class="btn btn-outline-secondary" onclick="window.location.reload()">Reset</button>
      <span class="small-note" id="save-msg"></span>
    </div>
  </div>

  <!-- ============ SUMMARY (cache-first, live sync with progress) ============ -->
  <div id="summary-section" class="section" style="display:none">
    <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
      <input id="summary-search" class="form-control" placeholder="Search dairy # / text‚Ä¶" style="max-width:260px">
      <button class="btn btn-outline-secondary" onclick="renderSummary()">Apply</button>
      <div class="ms-auto small-note">Cache: <span id="cache-count">0</span> farms</div>
    </div>

    <div class="mb-3 p-2 border rounded">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-brand" onclick="syncFromCloud()">Sync Now</button>
        <div class="small-note">
          Cloud: <b id="cloud-total">0</b> ¬∑ Downloaded: <b id="dl-count">0</b> ¬∑ New: <b id="new-count">0</b> ¬∑ Remaining: <b id="remain-count">0</b>
        </div>
      </div>
      <div class="progress mt-2">
        <div id="dl-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width:0%"></div>
      </div>
    </div>

    <div class="grid grid-4 mb-2">
      <div class="kpi"><div id="kpi-total" class="num">0</div><div class="label">Total Farms</div></div>
      <div class="kpi"><div id="kpi-attn" class="num">0</div><div class="label">Any Attention</div></div>
      <div class="kpi"><div id="kpi-nocap" class="num">0</div><div class="label">No Available Cap</div></div>
      <div class="kpi"><div id="kpi-doors" class="num">0</div><div class="label">Door Seals Delivered</div></div>
    </div>

    <div class="grid grid-3 mb-3">
      <div class="kpi">
        <div id="kpi-dts" class="num">0</div>
        <div class="label">DTS Vent Caps (grey halo / reducing cap)</div>
        <button class="btn btn-sm btn-outline-secondary mt-1" onclick="filterClick('dts')">View</button>
      </div>
      <div class="kpi">
        <div id="kpi-power" class="num">0</div>
        <div class="label">Needs Power Point</div>
        <button class="btn btn-sm btn-outline-secondary mt-1" onclick="filterClick('power')">View</button>
      </div>
      <div class="kpi">
        <div class="d-flex justify-content-between">
          <div><div id="kpi-spark" class="num">0</div><div class="label">Spark better</div></div>
          <div><div id="kpi-one" class="num">0</div><div class="label">One NZ better</div></div>
        </div>
        <div class="mt-1 d-flex gap-1">
          <button class="btn btn-sm btn-outline-secondary" onclick="filterClick('spark')">Spark</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="filterClick('one')">One NZ</button>
        </div>
      </div>
    </div>

    <div class="kpi mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="label">Rubberware Delivered by Size / Type</div>
        <div class="small-note">(click a pill to view farms)</div>
      </div>
      <div id="rubber-pills" class="d-flex flex-wrap gap-2"></div>
    </div>

    <div class="kpi mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="label">VAT Sizes Summary</div>
        <div>
          <button class="btn btn-sm btn-outline-secondary" onclick="exportSizesCSV()">Export per-size CSV</button>
        </div>
      </div>
      <div id="vat-size-badges" class="d-flex flex-wrap gap-2"></div>
    </div>

    <div id="summary-cards" class="grid grid-2"></div>
    <div id="summary-empty" class="small-note mt-2">No records.</div>
  </div>

  <!-- ============ ADMIN (download only) ============ -->
  <div id="admin-section" class="section" style="display:none">
    <div class="fw-bold mb-2">Export all (flat)</div>
    <div class="d-flex gap-2">
      <button class="btn btn-brand" onclick="exportCSV()">Export CSV</button>
      <button class="btn btn-brand" onclick="exportXLSX()">Export XLSX</button>
      <button class="btn btn-outline-secondary" onclick="clearCache()">Clear Local Cache</button>
    </div>
  </div>
</div>

<!-- Print brochure template -->
<div id="print-root" class="print-brochure"></div>

<script>
/* ---------------- Firebase ---------------- */
const firebaseConfig = {
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const CLOUD_FOLDER = "Pre Check";

/* ---------------- Dexie (cache for summary only) ---------------- */
const db = new Dexie('PrecheckCache');
db.version(1).stores({ forms: 'dairyNumber, updatedAt' });

/* ---------------- UI helpers ---------------- */
function showTab(which){
  document.getElementById('form-section').style.display = which==='form'?'block':'none';
  document.getElementById('summary-section').style.display = which==='summary'?'block':'none';
  document.getElementById('admin-section').style.display = which==='admin'?'block':'none';
  document.getElementById('tab-form').classList.toggle('active', which==='form');
  document.getElementById('tab-summary').classList.toggle('active', which==='summary');
  document.getElementById('tab-admin').classList.toggle('active', which==='admin');
  if(which==='summary'){ initSummary(); }
}
showTab('summary'); // start on Summary

function byId(id){return document.getElementById(id)}
function previewImage(e,id){ const img=byId(id); const f=e.target.files?.[0]; if(!f){img.style.display='none';return} img.src=URL.createObjectURL(f); img.style.display='block'; }
function togglePhoto(prefix){ const s=byId(prefix).value==='unavailable'; byId(prefix+'-photo').style.display=s?'block':'none'; if(!s){byId(prefix+'-preview').style.display='none';} }
function toggleExtra(v){ const show = byId(v+'-condition').value==='attention'; byId(v+'-extra').style.display=show?'block':'none'; }
function toggleDoorSeal(){ const on=byId('vat-door-seal').value==='delivered'; byId('door-extra').style.display=on?'block':'none'; }
function toggleRJT(){ const on=byId('rjt-seal').value==='delivered'; byId('rjt-extra').style.display=on?'block':'none'; }
function toggleChiller(){ const on=byId('chiller-condition').value==='attention'; byId('chiller-extra').style.display=on?'block':'none'; }

/* ---------------- Save form (unchanged save-to-cloud) ---------------- */
async function fileToDataURL(inputId){
  const inp = byId(inputId);
  if(!inp || !inp.files || !inp.files[0]) return '';
  const f = inp.files[0];
  return new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(f); });
}
async function saveForm(){
  const msg = byId('save-msg'); msg.textContent='Saving‚Ä¶';
  const dairy = (byId('dairyNumber').value||'').trim();
  if(!dairy){ msg.textContent='Enter dairy number.'; return; }
  const data = {
    dairyNumber:dairy, createdAt:new Date().toISOString(), updatedAt:Date.now(),
    // VAT
    "vat1-cap": byId('vat1-cap').value, "vat1-cap-comments": byId('vat1-cap-comments').value, "vat1-cap-photo-base64": await fileToDataURL('vat1-cap-photo'),
    "vat2-cap": byId('vat2-cap').value || 'na', "vat2-cap-comments": byId('vat2-cap-comments').value, "vat2-cap-photo-base64": await fileToDataURL('vat2-cap-photo'),
    "vat1-condition": byId('vat1-condition').value, "vat1-condition-comments": byId('vat1-condition-comments')?.value||'', "vat1-condition-photo-base64": await fileToDataURL('vat1-condition-photo'),
    "vat2-condition": byId('vat2-condition').value || 'na', "vat2-condition-comments": byId('vat2-condition-comments')?.value||'', "vat2-condition-photo-base64": await fileToDataURL('vat2-condition-photo'),
    "vat1-serial": byId('vat1-serial').value, "vat2-serial": byId('vat2-serial').value || '',
    // Agitator
    "agitator-location": byId('agitator-location').value, "agitator-comments": byId('agitator-comments').value, "agitator-photo-base64": await fileToDataURL('agitator-photo'),
    // Gateway
    "gateway-location": byId('gateway-location').value, "gateway-comments": byId('gateway-comments').value, "gateway-photo-base64": await fileToDataURL('gateway-photo'),
    // Telemetry
    "current-telemetry": byId('current-telemetry').value, "telemetry-comments": byId('telemetry-comments').value,
    // Rubberware
    "vat-door-seal": byId('vat-door-seal').value, "door-seal-size": byId('door-seal-size').value || '', "vat-door-seal-comments": byId('vat-door-seal-comments')?.value||'', "vat-door-seal-photo-base64": await fileToDataURL('vat-door-seal-photo'),
    "rjt-seal": byId('rjt-seal').value, "rjt-seal-size": byId('rjt-seal-size').value || '', "rjt-seal-comments": byId('rjt-seal-comments')?.value||'', "rjt-seal-photo-base64": await fileToDataURL('rjt-seal-photo'),
    "chiller-condition": byId('chiller-condition').value, "chiller-condition-comments": byId('chiller-condition-comments')?.value||'', "chiller-condition-photo-base64": await fileToDataURL('chiller-condition-photo')
  };
  try{
    await storage.ref(`${CLOUD_FOLDER}/${dairy}.json`).put(new Blob([JSON.stringify(data)],{type:'application/json'}));
    msg.textContent='Saved ‚úî';
  }catch(e){ console.error(e); msg.textContent='Save failed.'; }
}

/* ---------------- AI-ish normalizers ---------------- */
function tagWords(s){
  const t=(s||'').toLowerCase(); const tags=[];
  // DTS vent cap signs
  if(/\bgrey|gray\b/.test(t) && /(halo|ring)/.test(t)) tags.push('dts');
  if(/reducing cap|reduce.?cap|cap.*(worn|split|loose)|sensor.*grey|gray/.test(t)) tags.push('dts');
  // Power point ask
  if(/power ?point|powerpoint|gpo|socket|outlet|double adaptor|splitter plug|multi plug/.test(t)) tags.push('power');
  // Network preference
  if(/\bspark\b/.test(t)) tags.push('net:spark');
  if(/\b(vodafone|one ?nz|one-nz)\b/.test(t)) tags.push('net:one');
  // Manufacturers (for CSV)
  if(/\bdts\b/.test(t)) tags.push('mfg:dts');
  if(/\bnda\b/.test(t)) tags.push('mfg:nda');
  if(/\bpacko\b/.test(t)) tags.push('mfg:packo');
  if(/\bfrigotherm|frigomilk|mueller|de.?lav(al)?\b/.test(t)) tags.push('mfg:other');
  // Other cues
  if(/leak|drip/.test(t)) tags.push('issue:leak');
  if(/corrosion|rust/.test(t)) tags.push('issue:corrosion');
  return [...new Set(tags)];
}
function gatherText(rec){
  return [
    rec['vat1-cap-comments'],rec['vat2-cap-comments'],
    rec['vat1-condition-comments'],rec['vat2-condition-comments'],
    rec['telemetry-comments'],rec['gateway-comments'],rec['agitator-comments'],
    rec['vat-door-seal-comments'],rec['rjt-seal-comments'],rec['chiller-condition-comments']
  ].filter(Boolean).join(' ; ');
}
function rubberDeliveredCount(rec){
  let c=0;
  if(rec['vat-door-seal']==='delivered'){
    const two = (rec['vat2-cap'] && rec['vat2-cap']!=='na') || (rec['vat2-condition'] && rec['vat2-condition']!=='na') || (rec['vat2-serial']||'').trim();
    c += two?2:1;
  }
  return c;
}
function manufacturerFrom(rec){
  const t = gatherText(rec).toLowerCase();
  if(/\bdts\b/.test(t)) return 'DTS';
  if(/\bnda\b/.test(t)) return 'NDA';
  if(/\bpacko\b/.test(t)) return 'Packo';
  if(/\b(mueller|frigotherm|frigomilk|delaval|de laval)\b/.test(t)) return 'Other';
  // fallback: infer from serial prefixes if any (very rough)
  const s=(rec['vat1-serial']||rec['vat2-serial']||'').toUpperCase();
  if(/^DTS/.test(s)) return 'DTS';
  if(/^NDA/.test(s)) return 'NDA';
  return '';
}

/* ---------------- Summary cache + sync ---------------- */
let cache = [];         // loaded from Dexie
let filteredView = [];  // current filter results
let filterMode = null;  // 'dts' | 'power' | 'spark' | 'one' | rubber key | size key

async function initSummary(){
  cache = await db.forms.toArray();
  byId('cache-count').textContent = cache.length;
  renderSummary();        // render from cache immediately
  // start a silent sync if cache is empty
  if(!cache.length){ syncFromCloud(); }
}

async function listCloud(){
  const ref = storage.ref(CLOUD_FOLDER);
  const listing = await ref.listAll();
  return listing.items.filter(x=>x.name.endsWith('.json'));
}

async function syncFromCloud(){
  const search = (await listCloud()) || [];
  const cloudTotal = search.length;
  byId('cloud-total').textContent = cloudTotal;

  // What do we already have?
  const cachedKeys = new Set(cache.map(r=>String(r.dairyNumber)));
  const toFetch = [];
  for(const item of search){
    const name = item.name.replace(/\.json$/i,'');
    if(!cachedKeys.has(name)) toFetch.push(item);
  }
  byId('new-count').textContent = toFetch.length;
  byId('remain-count').textContent = toFetch.length;
  byId('dl-count').textContent = 0;
  byId('dl-bar').style.width = '0%';

  let done=0;
  for(const it of toFetch){
    try{
      const url = await it.getDownloadURL();
      const res = await fetch(url, {cache:'no-store'});
      const j = await res.json();
      // stamp and store
      const rec = {...j, dairyNumber: j.dairyNumber || it.name.replace('.json',''), updatedAt: Date.now()};
      await db.forms.put(rec);
      cache.push(rec);
    }catch(e){ console.warn('Fetch failed for', it.name); }
    done++;
    const remain = toFetch.length - done;
    byId('dl-count').textContent = done;
    byId('remain-count').textContent = remain;
    const percent = Math.round((done/toFetch.length)*100) || 0;
    byId('dl-bar').style.width = percent+'%';
  }
  byId('cache-count').textContent = cache.length;
  renderSummary();
}

/* ---------------- Summary rendering & filters ---------------- */
function kpiSet(id,val){ byId(id).textContent=String(val); }

function firstImage(rec){
  const keys=['vat1-cap-photo-base64','vat2-cap-photo-base64','gateway-photo-base64','agitator-photo-base64','vat1-condition-photo-base64','vat2-condition-photo-base64','vat-door-seal-photo-base64','rjt-seal-photo-base64','chiller-condition-photo-base64'];
  for(const k of keys){ if(rec[k]) return rec[k]; }
  return '';
}

function renderSummary(){
  const q=(byId('summary-search').value||'').toLowerCase();
  let data = cache.slice();
  if(q){ data = data.filter(r=>JSON.stringify(r).toLowerCase().includes(q)); }

  // derive AI-ish tags per record once
  data.forEach(r => { r.__tags = tagWords(gatherText(r)); });

  // KPIs
  kpiSet('kpi-total', data.length);
  kpiSet('kpi-attn', data.filter(r=>r['vat1-condition']==='attention' || r['vat2-condition']==='attention' || r['chiller-condition']==='attention').length);
  kpiSet('kpi-nocap', data.filter(r=>r['vat1-cap']==='unavailable' || r['vat2-cap']==='unavailable').length);
  kpiSet('kpi-doors', data.reduce((a,r)=>a+rubberDeliveredCount(r),0));
  kpiSet('kpi-dts', data.filter(r=>r.__tags.includes('dts')).length);
  kpiSet('kpi-power', data.filter(r=>r.__tags.includes('power')).length);
  kpiSet('kpi-spark', data.filter(r=>r.__tags.includes('net:spark')).length);
  kpiSet('kpi-one', data.filter(r=>r.__tags.includes('net:one')).length);

  // Rubberware pills
  const rubberBuckets = {}; // key -> [records]
  data.forEach(r=>{
    if(r['vat-door-seal']==='delivered'){
      const size=(r['door-seal-size']||'unknown').toLowerCase();
      const k='door:'+size; (rubberBuckets[k]=rubberBuckets[k]||[]).push(r);
    }
    if(r['rjt-seal']==='delivered'){
      const size=(r['rjt-seal-size']||'unknown').toLowerCase();
      const k='rjt:'+size; (rubberBuckets[k]=rubberBuckets[k]||[]).push(r);
    }
  });
  const rp = byId('rubber-pills'); rp.innerHTML='';
  Object.keys(rubberBuckets).sort().forEach(k=>{
    const [type,size]=k.split(':');
    const btn=document.createElement('button');
    btn.className='btn btn-sm btn-outline-secondary';
    btn.textContent=`${type.toUpperCase()} ‚Ä¢ ${size} (${rubberBuckets[k].length})`;
    btn.onclick=()=>filterClick(k);
    rp.appendChild(btn);
  });

  // VAT sizes badges
  const sizes={};
  data.forEach(r=>{
    const s1=(r['vat1-capacity']||'').toString().trim();
    const s2=(r['vat2-capacity']||'').toString().trim();
    if(s1) sizes[s1]=(sizes[s1]||0)+1;
    if(s2) sizes[s2]=(sizes[s2]||0)+1;
  });
  const vs=byId('vat-size-badges'); vs.innerHTML='';
  Object.keys(sizes).sort((a,b)=>Number(a)-Number(b)).forEach(sz=>{
    const pill=document.createElement('span');
    pill.className='chip'; pill.textContent=`${sz}L (${sizes[sz]})`;
    pill.onclick=()=>filterClick('size:'+sz);
    vs.appendChild(pill);
  });

  // Apply active filter (from card clicks)
  if(filterMode){
    if(filterMode==='dts') data=data.filter(r=>r.__tags.includes('dts'));
    else if(filterMode==='power') data=data.filter(r=>r.__tags.includes('power'));
    else if(filterMode==='spark') data=data.filter(r=>r.__tags.includes('net:spark'));
    else if(filterMode==='one') data=data.filter(r=>r.__tags.includes('net:one'));
    else if(filterMode.startsWith('rjt:')||filterMode.startsWith('door:')){
      data = data.filter(r=>{
        const [type,size]=filterMode.split(':');
        if(type==='door') return r['vat-door-seal']==='delivered' && (r['door-seal-size']||'unknown').toLowerCase()===size;
        if(type==='rjt') return r['rjt-seal']==='delivered' && (r['rjt-seal-size']||'unknown').toLowerCase()===size;
      });
    }else if(filterMode.startsWith('size:')){
      const sz=filterMode.split(':')[1];
      data = data.filter(r=>String(r['vat1-capacity']||'')===sz || String(r['vat2-capacity']||'')===sz);
    }
  }

  // Cards
  const wrap=byId('summary-cards'); wrap.innerHTML='';
  byId('summary-empty').style.display = data.length? 'none':'block';
  data.sort((a,b)=>String(a.dairyNumber).localeCompare(String(b.dairyNumber)));
  data.forEach(r=>{
    const badges=[];
    badges.push(`<span class="b ${r['vat1-condition']==='attention'?'attn':'ok'}">Vat1 ${r['vat1-condition']||'ok'}</span>`);
    const v2=r['vat2-condition']||'na'; if(v2!=='na') badges.push(`<span class="b ${v2==='attention'?'attn':'ok'}">Vat2 ${v2}</span>`);
    if(r['chiller-condition']==='attention') badges.push(`<span class="b bad">Chiller</span>`);
    if(r['vat1-cap']==='unavailable' || r['vat2-cap']==='unavailable') badges.push(`<span class="b bad">No cap</span>`);
    if(r.__tags.includes('dts')) badges.push(`<span class="b attn">DTS cap</span>`);
    if(r.__tags.includes('power')) badges.push(`<span class="b attn">Needs PPT</span>`);
    if(r.__tags.includes('net:spark')) badges.push(`<span class="b ok">Spark</span>`);
    if(r.__tags.includes('net:one')) badges.push(`<span class="b ok">One NZ</span>`);

    const img=firstImage(r);
    const el=document.createElement('div');
    el.className='tcard';
    el.innerHTML = `
      <div class="t-head">
        <div>
          <div class="fw-bold">Dairy #${r.dairyNumber||''}</div>
          <div class="text-muted small">${new Date(r.createdAt||Date.now()).toLocaleString()}</div>
          <div class="small mt-1"><b>Gateway:</b> ${r['gateway-location']||'-'} &nbsp; <b>Agitator:</b> ${r['agitator-location']||'-'}</div>
        </div>
        <div class="text-end">
          <div>${badges.join(' ')}</div>
          <div class="mt-2 d-flex gap-2 justify-content-end">
            <button class="btn btn-sm btn-outline-secondary" onclick='showDetails(${JSON.stringify(r).replace(/'/g,"&#39;")})'>Open</button>
            <button class="btn btn-sm btn-brand" onclick='printBrochure(${JSON.stringify(r).replace(/'/g,"&#39;")})'>Print</button>
          </div>
        </div>
      </div>
      <div class="mt-2 d-flex align-items-center gap-2">
        ${img?`<img class="thumb" src="${img}" alt="photo">`:''}
        <div class="small-note">${summarizeTags(r)}</div>
      </div>`;
    wrap.appendChild(el);
  });
}

function filterClick(mode){ filterMode = mode; renderSummary(); }

/* Small text summary under card title */
function summarizeTags(r){
  const arr=[];
  if(r.__tags.includes('dts')) arr.push('DTS vent cap/grey halo');
  if(r.__tags.includes('power')) arr.push('Power point recommended');
  if(r.__tags.includes('net:spark')) arr.push('Spark signal preferred');
  if(r.__tags.includes('net:one')) arr.push('One NZ signal preferred');
  return arr.length?arr.join(' ¬∑ '):'‚Äî';
}

/* ---------------- Details modal (simple, no dependency) ---------------- */
function showDetails(rec){
  const photos=['vat1-cap','vat2-cap','gateway','agitator','vat1-condition','vat2-condition','vat-door-seal','rjt-seal','chiller-condition']
    .map(k=>({label:k.replace(/-/g,' ').toUpperCase(),src:rec[k+'-photo-base64']}))
    .filter(x=>x.src);

  const w=window.open('','_blank','width=980,height=800');
  w.document.write(`
    <html><head><title>Dairy #${rec.dairyNumber}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>.ph{max-width:100%;max-height:340px;border:1px solid #eee;border-radius:8px}</style>
    </head><body class="p-3">
    <h3>Dairy #${rec.dairyNumber}</h3>
    <div class="small text-muted mb-2">${new Date(rec.createdAt||Date.now()).toLocaleString()}</div>
    <table class="table table-sm">
      ${Object.entries(rec).filter(([k])=>!/base64|updatedAt|createdAt|__tags/.test(k)).map(([k,v])=>`<tr><th>${k.replace(/-/g,' ').toUpperCase()}</th><td>${String(v||'')}</td></tr>`).join('')}
    </table>
    ${photos.length?'<h5>Photos</h5>':''}
    <div class="row g-3">
      ${photos.map(p=>`<div class="col-md-6"><div class="fw-bold small mb-1">${p.label}</div><img class="ph" src="${p.src}"></div>`).join('')}
    </div>
    </body></html>
  `);
  w.document.close();
}

/* ---------------- Print brochure (clean layout) ---------------- */
function printBrochure(rec){
  const tags = summarizeTags({...rec,__tags:tagWords(gatherText(rec))});
  const photo = firstImage(rec);
  const root = byId('print-root');
  root.innerHTML = `
    <div class="p-4">
      <h2 style="color:#a7ab01;font-weight:800">Agora Vat Pre-Check</h2>
      <div class="mb-3"><b>Dairy #${rec.dairyNumber||''}</b> ¬∑ ${new Date(rec.createdAt||Date.now()).toLocaleDateString()}</div>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="card border-0" style="background:#f7fbe9">
            <div class="card-body">
              <h5 class="card-title">Key Points</h5>
              <ul class="mb-0">
                <li>Vat 1: ${rec['vat1-cap']||'-'} ¬∑ ${rec['vat1-condition']||'-'} ¬∑ Serial ${rec['vat1-serial']||'-'}</li>
                ${rec['vat2-cap']!=='na'||rec['vat2-condition']!=='na'||rec['vat2-serial']?`<li>Vat 2: ${rec['vat2-cap']||'na'} ¬∑ ${rec['vat2-condition']||'na'} ¬∑ Serial ${rec['vat2-serial']||'-'}</li>`:''}
                <li>Gateway: ${rec['gateway-location']||'-'} ¬∑ Agitator: ${rec['agitator-location']||'-'}</li>
                <li>Rubberware: Door ${rec['vat-door-seal']||'-'} ${rec['door-seal-size']||''} ¬∑ RJT ${rec['rjt-seal']||'-'} ${rec['rjt-seal-size']||''}</li>
                ${tags?`<li>AI notes: ${tags}</li>`:''}
              </ul>
            </div>
          </div>
        </div>
        <div class="col-md-6">${photo?`<img src="${photo}" style="max-width:100%;border-radius:12px;border:1px solid #eee">`:''}</div>
      </div>
      <hr/>
      <h5>Technician Comments (selected)</h5>
      <ul>
        ${['vat1-cap-comments','vat2-cap-comments','vat1-condition-comments','vat2-condition-comments','telemetry-comments','gateway-comments','agitator-comments','vat-door-seal-comments','rjt-seal-comments','chiller-condition-comments']
            .map(k=>rec[k]).filter(Boolean).map(t=>`<li>${t}</li>`).join('')}
      </ul>
    </div>`;
  window.print();
}

/* ---------------- Exports ---------------- */
function flatten(rec){
  return {
    DairyNumber: rec.dairyNumber||'',
    CreatedAt: rec.createdAt||'',
    Vat1Capacity: rec['vat1-capacity']||'',
    Vat2Capacity: rec['vat2-capacity']||'',
    Vat1Cap: rec['vat1-cap']||'',
    Vat2Cap: rec['vat2-cap']||'',
    Vat1Condition: rec['vat1-condition']||'',
    Vat2Condition: rec['vat2-condition']||'',
    Vat1Serial: rec['vat1-serial']||'',
    Vat2Serial: rec['vat2-serial']||'',
    GatewayLocation: rec['gateway-location']||'',
    AgitatorLocation: rec['agitator-location']||'',
    DoorSeal: rec['vat-door-seal']||'',
    DoorSealSize: rec['door-seal-size']||'',
    RJTSeal: rec['rjt-seal']||'',
    RJTSealSize: rec['rjt-seal-size']||'',
    ChillerCondition: rec['chiller-condition']||'',
    DoorSealsDelivered: rubberDeliveredCount(rec),
    Tags: tagWords(gatherText(rec)).join('; ')
  };
}
async function exportCSV(){
  const arr = await db.forms.toArray(); const flat = arr.map(flatten);
  if(!flat.length){alert('No data.');return}
  const headers=Object.keys(flat[0]);
  const rows=[headers.join(',')].concat(flat.map(o=>headers.map(h=>('"'+String(o[h]??'').replace(/"/g,'""')+'"')).join(',')));
  const blob=new Blob(["\uFEFF"+rows.join("\r\n")],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='vat_precheck_export.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
}
async function exportXLSX(){
  const arr = await db.forms.toArray(); const flat = arr.map(flatten);
  if(!flat.length){alert('No data.');return}
  const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(flat);
  XLSX.utils.book_append_sheet(wb,ws,'PreCheck'); XLSX.writeFile(wb,'vat_precheck_export.xlsx');
}

/* Per-size CSV (size, serial, manufacturer, dairy, vat cap available) */
async function exportSizesCSV(){
  const arr = await db.forms.toArray();
  const out=[];
  arr.forEach(r=>{
    const mfg = manufacturerFrom(r);
    [['vat1-capacity','vat1-serial','vat1-cap'],['vat2-capacity','vat2-serial','vat2-cap']].forEach(([capKey,serKey,capAvail])=>{
      const size=r[capKey]; if(!size) return;
      out.push({
        SizeL: size,
        Serial: r[serKey]||'',
        Manufacturer: mfg,
        DairyNumber: r.dairyNumber||'',
        CapAvailable: r[capAvail]||''
      });
    });
  });
  if(!out.length){alert('No sizes found.');return}
  const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(out);
  XLSX.utils.book_append_sheet(wb,ws,'Vat Sizes'); XLSX.writeFile(wb,'vat_sizes_breakdown.xlsx');
}

/* ---------------- Cache management ---------------- */
async function clearCache(){
  await db.forms.clear();
  cache=[]; byId('cache-count').textContent=0;
  renderSummary();
}
</script>
</body>
</html>