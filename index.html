<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agora Vat Pre-Check — Flash</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<style>
  :root{--bg:#f7fbff;--ink:#0f172a;--brand:#a7ab01;--edge:#e5e7eb;--card:#fff;--accent:#FF851B;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444}
  body{background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:22px auto;padding:0 14px}
  h1{color:var(--brand);font-weight:800;margin:0 0 8px}
  .logo{max-width:220px;display:block;margin:0 auto 6px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
  .tab{border:1px solid var(--edge);background:#fff;border-radius:10px;padding:8px 12px;font-weight:700}
  .tab.active{background:var(--brand);color:#fff;border:none}
  .shell{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:14px;box-shadow:0 2px 22px #0f172a0d}
  .hidden{display:none!important}
  .fg{border:1px solid var(--edge);border-radius:12px;padding:12px;margin-bottom:12px;background:#fff}
  .fg h5{font-weight:800;color:#0b3a5c;margin-bottom:6px}
  .image-preview{display:none;max-width:200px;border:1px solid var(--edge);border-radius:10px;margin-top:6px}
  .thumb{width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid var(--edge);margin-right:6px}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi{border:1px solid var(--edge);border-radius:12px;background:#fff;padding:10px}
  .kpi .n{font-size:1.3rem;font-weight:800}
  .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (max-width:900px){.cards{grid-template-columns:1fr}.kpis{grid-template-columns:repeat(2,1fr)}}
  .card-farm{border:1px solid var(--edge);border-radius:14px;background:#fff;padding:12px}
  .cf-head{display:flex;justify-content:space-between;gap:10px}
  .cf-title{font-weight:800}
  .badge-soft{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--edge);font-size:.78rem;margin-left:6px}
  .b-ok{background:#eafff3;border-color:#bbf7d0}
  .b-warn{background:#fff7e6;border-color:#fde68a}
  .b-bad{background:#ffeff0;border-color:#fecdd3}
  .alertline{background:#fff9c2;border:1px solid #fde68a;border-radius:10px;padding:8px;margin-bottom:8px}
  .filterline{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .chip{padding:4px 8px;border:1px solid var(--edge);border-radius:999px;background:#fff;cursor:pointer}
  .chip.active{border-color:var(--accent);color:var(--accent);font-weight:800}
  .overlay{position:fixed;inset:0;background:#ffffffee;display:none;align-items:center;justify-content:center;z-index:9999}
  .overlay .box{max-width:980px;width:96%;max-height:90vh;overflow:auto;border:1px solid var(--edge);border-radius:14px;background:#fff;padding:12px}
  .album{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
  .album img{width:100%;height:120px;object-fit:cover;border-radius:10px;border:1px solid var(--edge)}
  .btn-brand{background:var(--brand);color:#fff;border:none}
</style>
</head>
<body>
<div class="wrap">
  <img id="logo" class="logo" src="" alt="Agora" style="display:none">
  <h1 class="text-center">Agora Vat Pre-Check</h1>

  <div class="tabs">
    <button id="t-form" class="tab active" onclick="showTab('form')"><i class="bi bi-clipboard2-check"></i> Form</button>
    <button id="t-sum"  class="tab" onclick="showTab('summary')"><i class="bi bi-grid"></i> Summary</button>
    <button id="t-admin" class="tab" onclick="showTab('admin')"><i class="bi bi-download"></i> Admin</button>
  </div>

  <!-- =================== FORM =================== -->
  <div id="pane-form" class="shell">
    <form id="vat-form">
      <!-- VATS -->
      <div class="fg">
        <h5>Vat Details</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Dairy Number</label>
            <input class="form-control" id="dairyNumber" name="dairyNumber" required placeholder="e.g. 12345">
            <div class="form-text">Existing record auto-loads on blur.</div>
          </div>
        </div>

        <!-- Vat 1 -->
        <div class="row g-2 mt-1">
          <div class="col-md-3">
            <label class="form-label">Vat 1 Capacity (L)</label>
            <input class="form-control" id="vat1-capacity" name="vat1-capacity" inputmode="numeric">
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 1 Cap</label>
            <select class="form-select" id="vat1-cap" name="vat1-cap">
              <option value="">Select…</option>
              <option value="available" selected>Available ✓</option>
              <option value="unavailable">Unavailable ✗</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Vat 1 Notes</label>
            <input class="form-control" id="vat1-comments" name="vat1-comments" placeholder="interior width / access / obstructions">
          </div>

          <div class="col-md-3">
            <label class="form-label">Vat 1 Level</label>
            <select class="form-select" id="vat1-level" name="vat1-level">
              <option value="">Select…</option><option>Low</option><option>Medium</option><option>High</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 1 Condition</label>
            <select id="vat1-condition" name="vat1-condition" class="form-select" onchange="toggleVatCondition('vat1-condition')">
              <option value="">Select…</option>
              <option value="ok" selected>OK</option>
              <option value="attention">Attention Required</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 1 Serial</label>
            <input class="form-control" id="vat1-serial" name="vat1-serial">
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 1 Cap Photo</label>
            <input type="file" id="vat1-cap-photo" class="form-control" accept="image/*" onchange="previewImage(event,'vat1-cap-preview')">
            <img id="vat1-cap-preview" class="image-preview">
          </div>
        </div>
        <div id="vat1-condition-extra" class="row g-2 mt-1" style="display:none">
          <div class="col-md-9"><input class="form-control" id="vat1-condition-comments" name="vat1-condition-comments" placeholder="Condition notes"></div>
          <div class="col-md-3">
            <label class="form-label">Condition Photo</label>
            <input type="file" id="vat1-condition-photo" class="form-control" accept="image/*" onchange="previewImage(event,'vat1-condition-preview')">
            <img id="vat1-condition-preview" class="image-preview">
          </div>
        </div>

        <hr>

        <!-- Vat 2 (defaults to N/A) -->
        <div class="row g-2 mt-1">
          <div class="col-md-3">
            <label class="form-label">Vat 2 Capacity (L)</label>
            <input class="form-control" id="vat2-capacity" name="vat2-capacity" inputmode="numeric" oninput="showVat2Serial()">
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 2 Cap</label>
            <select class="form-select" id="vat2-cap" name="vat2-cap">
              <option value="na" selected>N/A</option>
              <option value="available">Available ✓</option>
              <option value="unavailable">Unavailable ✗</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Vat 2 Notes</label>
            <input class="form-control" id="vat2-comments" name="vat2-comments">
          </div>

          <div class="col-md-3">
            <label class="form-label">Vat 2 Level</label>
            <select class="form-select" id="vat2-level" name="vat2-level">
              <option value="na" selected>N/A</option><option>Low</option><option>Medium</option><option>High</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 2 Condition</label>
            <select id="vat2-condition" name="vat2-condition" class="form-select" onchange="toggleVatCondition('vat2-condition')">
              <option value="na" selected>N/A</option>
              <option value="ok">OK</option>
              <option value="attention">Attention Required</option>
            </select>
          </div>
          <div class="col-md-3" id="vat2-serial-wrap" style="display:none">
            <label class="form-label">Vat 2 Serial</label>
            <input class="form-control" id="vat2-serial" name="vat2-serial">
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 2 Cap Photo</label>
            <input type="file" id="vat2-cap-photo" class="form-control" accept="image/*" onchange="previewImage(event,'vat2-cap-preview')">
            <img id="vat2-cap-preview" class="image-preview">
          </div>
        </div>
        <div id="vat2-condition-extra" class="row g-2 mt-1" style="display:none">
          <div class="col-md-9"><input class="form-control" id="vat2-condition-comments" name="vat2-condition-comments"></div>
          <div class="col-md-3">
            <label class="form-label">Condition Photo</label>
            <input type="file" id="vat2-condition-photo" class="form-control" accept="image/*" onchange="previewImage(event,'vat2-condition-preview')">
            <img id="vat2-condition-preview" class="image-preview">
          </div>
        </div>

        <!-- Extra (multi) photos -->
        <div class="row g-2 mt-1">
          <div class="col-12">
            <label class="form-label">Additional Photos (any)</label>
            <input type="file" id="extra-photos" class="form-control" accept="image/*" multiple>
            <div id="extra-previews" class="mt-2 d-flex flex-wrap gap-2"></div>
          </div>
        </div>
      </div>

      <!-- AGITATOR -->
      <div class="fg">
        <h5>Agitator</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Sensor Location</label>
            <input class="form-control" id="agitator-location" name="agitator-location" placeholder="e.g. grey halo / external">
          </div>
          <div class="col-md-6">
            <label class="form-label">Notes</label>
            <input class="form-control" id="agitator-comments" name="agitator-comments">
          </div>
          <div class="col-md-2">
            <label class="form-label">Photo</label>
            <input type="file" id="agitator-photo" class="form-control" accept="image/*" onchange="previewImage(event,'agitator-preview')">
            <img id="agitator-preview" class="image-preview">
          </div>
        </div>
      </div>

      <!-- GATEWAY -->
      <div class="fg">
        <h5>Gateway</h5>
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Gateway Location</label>
            <input class="form-control" id="gateway-location" name="gateway-location" placeholder="plant room / office">
          </div>
          <div class="col-md-4">
            <label class="form-label">Notes</label>
            <input class="form-control" id="gateway-comments" name="gateway-comments" placeholder="powerpoint / antenna / coverage">
          </div>
          <div class="col-md-2">
            <label class="form-label">Photo</label>
            <input type="file" id="gateway-photo" class="form-control" accept="image/*" onchange="previewImage(event,'gateway-preview')">
            <img id="gateway-preview" class="image-preview">
          </div>
        </div>
      </div>

      <!-- OTHER TELEMETRY -->
      <div class="fg">
        <h5>Other Telemetry</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Current Telemetry</label>
            <input class="form-control" id="current-telemetry" name="current-telemetry">
          </div>
          <div class="col-md-8">
            <label class="form-label">Notes</label>
            <input class="form-control" id="telemetry-comments" name="telemetry-comments">
          </div>
        </div>
      </div>

      <!-- RUBBERWARE -->
      <div class="fg">
        <h5>Rubberware</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Vat Door Seal</label>
            <select id="vat-door-seal" name="vat-door-seal" class="form-select" onchange="toggleVatDoorSeal()">
              <option value="notdelivered" selected>Not Delivered</option>
              <option value="delivered">Delivered</option>
            </select>
          </div>
          <div class="col-md-4 vat-door-size-wrap" style="display:none">
            <label class="form-label">Vat 1 Door Seal Size</label>
            <select id="vat1-door-seal-size" name="vat1-door-seal-size" class="form-select">
              <option value="">Select size…</option><option value="small">Small</option><option value="large">Large</option>
            </select>
          </div>
          <div class="col-md-4 vat-door-size-wrap" style="display:none">
            <label class="form-label">Vat 2 Door Seal Size</label>
            <select id="vat2-door-seal-size" name="vat2-door-seal-size" class="form-select">
              <option value="na" selected>N/A</option><option value="small">Small</option><option value="large">Large</option>
            </select>
          </div>
        </div>
        <div class="row g-2 mt-1" id="vat-door-add" style="display:none">
          <div class="col-md-8"><input class="form-control" id="vat-door-seal-comments" name="vat-door-seal-comments" placeholder="Delivery / fit notes"></div>
          <div class="col-md-4">
            <label class="form-label">Photo</label>
            <input type="file" id="vat-door-seal-photo" class="form-control" accept="image/*" onchange="previewImage(event,'vat-door-seal-preview')">
            <img id="vat-door-seal-preview" class="image-preview">
          </div>
        </div>

        <div class="row g-2 mt-1">
          <div class="col-md-4">
            <label class="form-label">RJT Step Seal</label>
            <select id="rjt-seal" name="rjt-seal" class="form-select" onchange="toggleRjtSeal()">
              <option value="notdelivered" selected>Not Delivered</option>
              <option value="delivered">Delivered</option>
            </select>
          </div>
          <div class="col-md-4" id="rjt-size-wrap" style="display:none">
            <label class="form-label">RJT Size</label>
            <select id="rjt-seal-size" name="rjt-seal-size" class="form-select">
              <option value="">Select size…</option><option value="small">Small</option><option value="large">Large</option>
            </select>
          </div>
          <div class="col-md-4" id="rjt-photo-wrap" style="display:none">
            <label class="form-label">Photo</label>
            <input type="file" id="rjt-seal-photo" class="form-control" accept="image/*" onchange="previewImage(event,'rjt-seal-preview')">
            <img id="rjt-seal-preview" class="image-preview">
          </div>
        </div>

        <div class="row g-2 mt-1">
          <div class="col-md-4">
            <label class="form-label">Chiller Condition</label>
            <select id="chiller-condition" name="chiller-condition" class="form-select" onchange="toggleChillerCondition()">
              <option value="ok">OK</option><option value="attention">Attention Required</option>
            </select>
          </div>
          <div class="col-md-8" id="chiller-extra" style="display:none">
            <input class="form-control" id="chiller-condition-comments" name="chiller-condition-comments" placeholder="Notes">
            <div class="mt-1">
              <input type="file" id="chiller-condition-photo" class="form-control" accept="image/*" onchange="previewImage(event,'chiller-condition-preview')">
              <img id="chiller-condition-preview" class="image-preview">
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-brand" onclick="saveForm()">Save</button>
        <button type="button" class="btn btn-secondary" onclick="generatePDF()">Generate PDF</button>
      </div>
    </form>
  </div>

  <!-- =================== SUMMARY =================== -->
  <div id="pane-summary" class="shell hidden">
    <div id="sum-alert" class="alertline hidden"></div>
    <div class="filterline">
      <span id="f-all" class="chip active" onclick="setAge(0)">All</span>
      <span id="f-30" class="chip" onclick="setAge(30)">30d</span>
      <span id="f-90" class="chip" onclick="setAge(90)">90d</span>
      <input id="q" class="form-control" placeholder="Search Dairy # / text…" style="max-width:340px">
      <button class="btn btn-outline-secondary" onclick="loadSummary()">Apply</button>
    </div>
    <div class="kpis mb-2">
      <div class="kpi"><div class="n" id="k-total">0</div><div>Total Farms</div></div>
      <div class="kpi"><div class="n" id="k-attn">0</div><div>Any Attention</div></div>
      <div class="kpi"><div class="n" id="k-no-cap">0</div><div>No Available Cap</div></div>
      <div class="kpi"><div class="n" id="k-door">0</div><div>Door Seals Delivered</div></div>
    </div>
    <div id="cards" class="cards"></div>
  </div>

  <!-- =================== ADMIN (DOWNLOAD ONLY) =================== -->
  <div id="pane-admin" class="shell hidden">
    <div class="mb-2">Download JSON or generate PDF for any farm. (Read-only.)</div>
    <div id="admin-list" class="list-group"></div>
  </div>
</div>

<!-- Album overlay -->
<div id="ovl" class="overlay" onclick="hideOverlay(event)">
  <div class="box">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <strong id="ovl-title">Photos</strong>
      <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('ovl').style.display='none'">Close</button>
    </div>
    <div id="ovl-album" class="album"></div>
  </div>
</div>

<!-- Firebase + jsPDF -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
  // ---------- Firebase (same project you shared)
  const firebaseConfig = {
    apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
    authDomain:"dairy-farm-record-system.firebaseapp.com",
    projectId:"dairy-farm-record-system",
    storageBucket:"dairy-farm-record-system.appspot.com",
    messagingSenderId:"422124188212",
    appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
  };
  firebase.initializeApp(firebaseConfig);
  const storage = firebase.storage();

  // ---------- UI helpers
  function showTab(name){
    document.getElementById('pane-form').classList.toggle('hidden', name!=='form');
    document.getElementById('pane-summary').classList.toggle('hidden', name!=='summary');
    document.getElementById('pane-admin').classList.toggle('hidden', name!=='admin');
    document.getElementById('t-form').classList.toggle('active', name==='form');
    document.getElementById('t-sum').classList.toggle('active', name==='summary');
    document.getElementById('t-admin').classList.toggle('active', name==='admin');
    if(name==='summary') loadSummary();
    if(name==='admin')   loadAdmin();
  }

  function previewImage(e, id){
    const img = document.getElementById(id);
    const file = e.target.files[0];
    if(!file) return;
    img.src = URL.createObjectURL(file);
    img.style.display = 'block';
    const fr = new FileReader();
    fr.onload = ev => img.setAttribute('data-base64', ev.target.result);
    fr.readAsDataURL(file);
  }
  document.getElementById('extra-photos').addEventListener('change', (e)=>{
    const wrap = document.getElementById('extra-previews'); wrap.innerHTML='';
    [...e.target.files].slice(0,12).forEach(f=>{
      const i = document.createElement('img'); i.className='thumb'; i.title=f.name;
      i.src = URL.createObjectURL(f); wrap.appendChild(i);
    });
  });

  function toggleVatCondition(which){
    const extra = document.getElementById(which+'-extra');
    const sel = document.getElementById(which);
    extra.style.display = (sel.value==='attention') ? 'flex' : 'none';
  }
  function showVat2Serial(){
    const v = (document.getElementById('vat2-capacity').value||'').trim();
    document.getElementById('vat2-serial-wrap').style.display = v ? 'block' : 'none';
  }
  function toggleVatDoorSeal(){
    const show = document.getElementById('vat-door-seal').value==='delivered';
    document.querySelectorAll('.vat-door-size-wrap').forEach(n=>n.style.display= show?'block':'none');
    document.getElementById('vat-door-add').style.display = show?'flex':'none';
  }
  function toggleRjtSeal(){
    const show = document.getElementById('rjt-seal').value==='delivered';
    document.getElementById('rjt-size-wrap').style.display = show?'block':'none';
    document.getElementById('rjt-photo-wrap').style.display = show?'block':'none';
  }
  function toggleChillerCondition(){
    const show = document.getElementById('chiller-condition').value==='attention';
    document.getElementById('chiller-extra').style.display = show?'block':'none';
  }

  // ---------- Load logo for header/PDF
  (async function(){
    try{
      const ref = storage.ref("Agora Logo/2F6-1YdaEP.jpeg");
      const url = await ref.getDownloadURL();
      const im = document.getElementById('logo'); im.src=url; im.style.display='block';
    }catch(e){}
  })();

  // ---------- Auto-load on dairy blur
  document.getElementById('dairyNumber').addEventListener('blur', async function(){
    const num = this.value.trim(); if(!num) return;
    try{
      const ref = storage.ref(`Pre Check/${num}.json`);
      const url = await ref.getDownloadURL();
      const rec = await fetch(url).then(r=>r.json());
      fillForm(rec);
      showVat2Serial(); toggleVatDoorSeal(); toggleRjtSeal(); toggleChillerCondition();
    }catch(e){ /* ignore if not found */ }
  });

  function fillForm(rec){
    Object.entries(rec).forEach(([k,v])=>{
      if(document.getElementsByName(k)[0]){
        document.getElementsByName(k)[0].value = v;
      }
    });
  }

  // ---------- Save (JSON in Storage, photos embedded as base64 in JSON)
  async function saveForm(){
    const form = document.getElementById('vat-form');
    const fd = new FormData(form);
    const data = Object.fromEntries(fd.entries());

    // Ensure Vat-2 defaults (N/A)
    if(!data['vat2-cap']) data['vat2-cap']='na';
    if(!data['vat2-level']) data['vat2-level']='na';
    if(!data['vat2-condition']) data['vat2-condition']='na';

    // Photos (single)
    ['vat1-cap','vat2-cap','agitator','gateway','vat1-condition','vat2-condition','vat-door-seal','rjt-seal','chiller-condition']
      .forEach(p=>{
        const img = document.getElementById(p+'-preview');
        if(img && img.getAttribute('data-base64')){
          data[p+'-photo-base64'] = img.getAttribute('data-base64');
        }
      });

    // Extra photos (multi) — store as array base64
    const extras = document.getElementById('extra-photos').files;
    if(extras && extras.length){
      data.extraPhotos = await Promise.all([...extras].slice(0,20).map(f=>fileToBase64(f)));
    }

    data.timestamp = Date.now();

    if(!data.dairyNumber || !data.dairyNumber.trim()){
      alert('Dairy Number is required'); return;
    }
    await storage.ref(`Pre Check/${data.dairyNumber}.json`)
      .put(new Blob([JSON.stringify(data)],{type:'application/json'}));
    alert('Saved to cloud.');
  }

  function fileToBase64(f){return new Promise(res=>{
    const fr = new FileReader(); fr.onload=e=>res(e.target.result); fr.readAsDataURL(f);
  });}

  // ---------- PDF (from current form)
  async function generatePDF(){
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('l','pt','a4');
    pdf.setFontSize(18); pdf.text('Agora Vat Pre-Check', 40, 44);
    const fd = new FormData(document.getElementById('vat-form'));
    const rows=[]; for(const [k,v] of fd.entries()){ rows.push([k,v]); }
    pdf.autoTable({startY:60, head:[['Field','Value']], body:rows, styles:{fontSize:9, cellPadding:3}});
    pdf.save('VatPreCheck_'+(fd.get('dairyNumber')||'')+'.pdf');
  }

  // ---------- SUMMARY
  let AGE_DAYS = 0;
  function setAge(d){ AGE_DAYS=d;
    document.getElementById('f-all').classList.toggle('active',d===0);
    document.getElementById('f-30').classList.toggle('active',d===30);
    document.getElementById('f-90').classList.toggle('active',d===90);
  }

  async function listPrecheckFiles(){
    // returns array of {name,url}
    const out = [];
    const folder = storage.ref('Pre Check');
    const res = await folder.listAll(); // may require List permission
    for(const item of res.items){
      const url = await item.getDownloadURL();
      out.push({name:item.name,url});
    }
    return out;
  }

  function normalizeFlags(rec){
    // "AI" normaliser for mixed lingo -> flags
    const hay = [
      rec['vat1-comments'], rec['vat2-comments'],
      rec['agitator-comments'], rec['gateway-comments'],
      rec['telemetry-comments']
    ].filter(Boolean).join(' ').toLowerCase();

    const flags = [];
    const needsPower = /(power\s?point|powerpoint|socket|outlet)/.test(hay);
    if(needsPower) flags.push({t:'Needs Powerpoint', c:'b-warn'});

    const reducing = /(reducing\s*cap|grey\s*cap|gray\s*cap|grey\s*halo|gray\s*halo)/.test(hay);
    if(reducing || /unavailable/.test((rec['vat1-cap']||'')) || /unavailable/.test((rec['vat2-cap']||''))){
      flags.push({t:'Reducing Cap', c: reducing?'b-bad':'b-warn'});
    }

    const sensor = /(sensor|agitator)/.test(hay) || !!rec['agitator-location'];
    if(sensor) flags.push({t:'Sensor', c:'b-ok'});

    if((rec['chiller-condition']||'').toLowerCase()==='attention'){
      flags.push({t:'Chiller Attention', c:'b-bad'});
    }

    const v1attn = (rec['vat1-condition']||'')==='attention';
    const v2attn = (rec['vat2-condition']||'')==='attention';
    if(v1attn || v2attn) flags.push({t:'Vat Attention', c:'b-bad'});

    // Rubberware delivered count (1 vat -> 1, two vats -> 2)
    let doorDelivered = 0;
    if((rec['vat-door-seal']||'')==='delivered'){
      const hasV2 = (rec['vat2-cap']||'na')!=='na' || (rec['vat2-capacity']||'').trim();
      doorDelivered = hasV2 ? 2 : 1;
    }
    return {flags, doorDelivered};
  }

  function cardPhotos(rec){
    const arr=[];
    ['vat1-cap','vat2-cap','agitator','gateway','vat1-condition','vat2-condition','vat-door-seal','rjt-seal','chiller-condition']
      .forEach(k=>{ const b=rec[k+'-photo-base64']; if(b) arr.push(b); });
    if(rec.extraPhotos && Array.isArray(rec.extraPhotos)) arr.push(...rec.extraPhotos);
    return arr;
  }

  function photoStripHTML(photos, dairy){
    if(!photos.length) return '';
    const first = photos.slice(0,4).map(p=>`<img class="thumb" src="${p}">`).join('');
    const extra = photos.length>4 ? `<a href="#" onclick="openAlbum('${encodeURIComponent(dairy)}');return false;"> +${photos.length-4} more</a>`:'';
    window.__albums = window.__albums || {};
    window.__albums[dairy]=photos;
    return `<div class="mt-1">${first}${extra}</div>`;
  }

  function openAlbum(dairyEnc){
    const dairy = decodeURIComponent(dairyEnc);
    const photos = (window.__albums||{})[dairy]||[];
    document.getElementById('ovl-title').innerText = `Photos — Dairy ${dairy}`;
    const grid = document.getElementById('ovl-album'); grid.innerHTML='';
    photos.forEach(p=>{ const i=new Image(); i.src=p; grid.appendChild(i); });
    document.getElementById('ovl').style.display='flex';
  }
  function hideOverlay(e){ if(e.target.id==='ovl') e.target.style.display='none'; }

  async function loadSummary(){
    const q = (document.getElementById('q').value||'').toLowerCase();
    const alert = document.getElementById('sum-alert'); alert.classList.add('hidden'); alert.innerText='';
    const cards = document.getElementById('cards'); cards.innerHTML='Loading…';

    let files=[];
    try{
      files = await listPrecheckFiles();
    }catch(err){
      alert.innerText = 'Cloud list error: '+(err&&err.message?err.message:err);
      alert.classList.remove('hidden');
      cards.innerHTML = '<em>No cloud list returned. Check Storage list permission or folder name "Pre Check".</em>';
      return;
    }

    const ageCut = AGE_DAYS ? Date.now() - AGE_DAYS*86400000 : 0;
    const recs = (await Promise.all(files.map(async f=>{
      try{ const r = await fetch(f.url).then(r=>r.json()); return r; }catch(e){ return null; }
    }))).filter(Boolean).filter(r=>!ageCut || (r.timestamp||0)>=ageCut);

    // search filter
    const recsF = q ? recs.filter(r=>JSON.stringify(r).toLowerCase().includes(q)) : recs;

    // KPIs
    document.getElementById('k-total').innerText = recsF.length;
    document.getElementById('k-attn').innerText = recsF.filter(r=>r['vat1-condition']==='attention'||r['vat2-condition']==='attention'||r['chiller-condition']==='attention').length;
    document.getElementById('k-no-cap').innerText = recsF.filter(r=>(r['vat1-cap']||'')!=='available' || ((r['vat2-cap']||'na')!=='na' && (r['vat2-cap']||'')!=='available')).length;
    document.getElementById('k-door').innerText = recsF.reduce((n,r)=>n+normalizeFlags(r).doorDelivered,0);

    // CARDS
    cards.innerHTML = '';
    recsF.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
    recsF.forEach(r=>{
      const dairy = r.dairyNumber || '—';
      const {flags,doorDelivered} = normalizeFlags(r);
      const photos = cardPhotos(r);
      const chips = flags.map(f=>`<span class="badge-soft ${f.c}">${f.t}</span>`).join('');
      const v2Cap = (r['vat2-cap']||'na').toUpperCase();
      const doorSizes = (r['vat-door-seal']==='delivered')
        ? `Door seals: ${doorDelivered} (V1:${r['vat1-door-seal-size']||'—'}${(r['vat2-cap']||'na')!=='na'?', V2:'+ (r['vat2-door-seal-size']||'—'):''})`
        : 'Door seals: 0';
      const html = `
        <div class="card-farm">
          <div class="cf-head">
            <div class="cf-title">Dairy #${dairy}</div>
            <div>${chips}</div>
          </div>
          <div class="cf-body">
            <div><strong>Vats</strong> — V1: ${r['vat1-capacity']||'—'}L, ${r['vat1-cap']||'—'}, Cond: ${(r['vat1-condition']||'').toUpperCase()||'—'}; 
              V2: ${r['vat2-capacity']||'—'}L, ${(v2Cap==='NA'?'N/A':v2Cap)}, Cond: ${(r['vat2-condition']||'na').toUpperCase()}</div>
            <div><strong>Agitator</strong>: ${r['agitator-location']||'—'} | ${r['agitator-comments']||''}</div>
            <div><strong>Gateway</strong>: ${r['gateway-location']||'—'} | ${r['gateway-comments']||''}</div>
            <div><strong>Telemetry</strong>: ${r['current-telemetry']||'—'} | ${r['telemetry-comments']||''}</div>
            <div><strong>Rubberware</strong>: RJT ${r['rjt-seal']||'notdelivered'} ${r['rjt-seal']==='delivered' ? '('+(r['rjt-seal-size']||'size?')+')' : ''} | ${doorSizes}</div>
            ${photoStripHTML(photos, dairy)}
          </div>
        </div>`;
      cards.insertAdjacentHTML('beforeend', html);
    });
    if(!recsF.length) cards.innerHTML='<em>No records found.</em>';
  }

  // ---------- ADMIN (download only)
  async function loadAdmin(){
    const list = document.getElementById('admin-list'); list.innerHTML='Loading…';
    let files=[];
    try{ files = await listPrecheckFiles(); }catch(e){
      list.innerHTML = '<div class="text-danger">Cannot list cloud files. Check Firebase Storage permissions.</div>'; return;
    }
    if(!files.length){ list.innerHTML='<em>No records in cloud.</em>'; return; }
    list.innerHTML='';
    files.sort((a,b)=>a.name.localeCompare(b.name));
    for(const f of files){
      const name = f.name.replace('.json','');
      const item = document.createElement('a');
      item.className='list-group-item list-group-item-action d-flex justify-content-between align-items-center';
      item.href=f.url; item.target='_blank';
      item.innerHTML = `<span><strong>${name}</strong></span>
                        <span class="d-flex gap-2">
                          <button class="btn btn-sm btn-outline-secondary" onclick="event.preventDefault(); window.open('${f.url}','_blank')">JSON</button>
                          <button class="btn btn-sm btn-brand" onclick="event.preventDefault(); adminPDF('${name}','${f.url}')">PDF</button>
                        </span>`;
      list.appendChild(item);
    }
  }

  async function adminPDF(dairy, url){
    try{
      const rec = await fetch(url).then(r=>r.json());
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('l','pt','a4');
      pdf.setFontSize(18); pdf.text('Agora Vat Pre-Check', 40, 44);
      const rows = [];
      Object.entries(rec).forEach(([k,v])=>{
        if(typeof v==='string' || typeof v==='number') rows.push([k,v]);
      });
      pdf.autoTable({startY:60, head:[['Field','Value']], body:rows, styles:{fontSize:9, cellPadding:3}});
      pdf.save('VatPreCheck_'+dairy+'.pdf');
    }catch(e){ alert('PDF error: '+e.message); }
  }

  // ---------- Summary filters
  document.getElementById('q').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); loadSummary(); } });

  // ---------- Defaults for Vat-2 right away
  document.getElementById('vat2-cap').value='na';
  document.getElementById('vat2-level').value='na';
  document.getElementById('vat2-condition').value='na';
</script>
</body>
</html>