<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Agora Vat Pre-Check — Flash</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --bg:#f8faff; --primary:#001F3F; --accent:#FF851B; --danger:#FF4136; --success:#2ECC40; --muted:#6c757d;
    --card:#fff; --border:#e9ecef; --font:'Segoe UI', Arial, sans-serif;
  }
  body{background:var(--bg);color:var(--primary);font-family:var(--font)}
  .container-main{max-width:1040px;margin:28px auto;padding:16px}
  .brand-head{display:flex;gap:10px;align-items:center;justify-content:center;margin-bottom:10px}
  .logo{max-width:190px;display:none}
  h1{font-size:1.8rem;color:var(--accent);text-align:center;margin:6px 0 14px}
  .btn-agora{background:var(--accent);color:#fff;border:none;border-radius:8px;font-weight:600}
  .btn-agora:hover{background:#ff6d00}
  .btn-outline{background:#fff;color:var(--primary);border:1px solid var(--accent);border-radius:8px}
  .btn-outline:hover{background:var(--accent);color:#fff}
  .btn-darky{background:var(--primary);color:#fff;border-radius:8px;border:none}
  .btn-darky:hover{background:#173559}
  .card-shell{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 24px #001F3F10;padding:14px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:900px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}}
  .tcard{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;box-shadow:0 1px 10px #0000000a}
  .tcard-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .t-id{font-weight:800}
  .t-badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge-chip{border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:.8rem}
  .badge-attn{background:#fff3cd;border-color:#ffe49c}
  .badge-ok{background:#e6ffed;border-color:#b3f0c2}
  .thumbs{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
  .thumbs img{width:78px;height:78px;object-fit:cover;border-radius:8px;border:1px solid #eee}
  .ai-box{background:#fff;border:1px dashed #ffd6b2;border-radius:12px;padding:10px}
  .ai-bullet{display:flex;gap:8px;align-items:flex-start;margin:4px 0}
  .ai-bullet i{color:var(--accent)}
  .hidden{display:none!important}
  .form-label{font-weight:600}
  .image-preview{display:none;max-width:240px;border:2px solid #eee;border-radius:8px;margin-top:6px}
  .section-title{font-weight:800;margin-top:8px;margin-bottom:6px}
  .divider{height:1px;background:var(--border);margin:10px 0}
  .nav-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:6px 0 14px}
  .role-note{font-size:.9rem;color:var(--muted);text-align:center;margin-top:2px}
  .overlay{position:fixed;inset:0;background:#ffffffd9;display:none;align-items:center;justify-content:center;z-index:9999}
  .loader{width:84px;height:84px;border-radius:50%;border:8px solid #eee;border-top-color:var(--accent);animation:spin 1s linear infinite;margin-bottom:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .matrix-wrap{overflow-x:auto}
  .matrix{display:grid;grid-template-columns:2fr repeat(4,1fr);min-width:540px}
  .matrix .hdr,.matrix .cell{padding:10px 8px;border-bottom:1px solid #eee}
  .matrix .hdr{font-weight:700}
  .admin-only{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff}
  .tiny{font-size:.85rem;color:var(--muted)}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi{background:#fff;border:1px solid var(--border);border-radius:12px;text-align:center;padding:10px}
  .kpi .num{font-size:1.4rem;font-weight:800}
  .kpi .lab{color:#777}
</style>
</head>
<body>
<div class="container-main">

  <!-- Header -->
  <div class="brand-head">
    <img id="logo" class="logo" alt="Agora Logo">
  </div>
  <h1>Agora Vat Pre-Check</h1>

  <!-- Auth / Nav -->
  <div class="nav-row">
    <input id="login-email" class="form-control" placeholder="Email (admin@... for admin)" style="max-width:260px">
    <input id="login-pass" class="form-control" placeholder="Password" type="password" style="max-width:200px">
    <button class="btn btn-agora" id="btn-login">Login</button>
    <button class="btn btn-outline hidden" id="btn-logout">Logout</button>
    <button class="btn btn-darky hidden" id="btn-admin">Admin</button>
    <button class="btn btn-darky hidden" id="btn-summary">Summary</button>
    <button class="btn btn-outline hidden" id="btn-form">New Entry</button>
  </div>
  <div id="whoami" class="role-note"></div>

  <!-- AI Summary (global, permission-safe) -->
  <div id="ai-summary" class="ai-box hidden">
    <div class="section-title">AI Summary</div>
    <div id="ai-bullets"></div>
  </div>

  <!-- KPIs -->
  <div id="kpi-row" class="kpis hidden" style="margin:10px 0 12px"></div>

  <!-- FORM (Flash demo) -->
  <div id="form-shell" class="card-shell">
    <div class="grid-2">
      <div>
        <label class="form-label">Dairy Number</label>
        <input id="dairyNumber" class="form-control" required>
      </div>
      <div>
        <label class="form-label">Current Telemetry (system)</label>
        <input id="current-telemetry" class="form-control" placeholder="e.g., DTS, Halo, None">
      </div>
    </div>

    <div class="divider"></div>
    <div class="section-title">Vat 1</div>
    <div class="grid-2">
      <div>
        <label class="form-label">Capacity (L)</label>
        <input id="vat1-capacity" class="form-control">
      </div>
      <div>
        <label class="form-label">Serial Number</label>
        <input id="vat1-serial" class="form-control">
      </div>
    </div>
    <div class="grid-3">
      <div>
        <label class="form-label">Cap</label>
        <select id="vat1-cap" class="form-select">
          <option value="available">Available ✓</option>
          <option value="unavailable">Unavailable ✗</option>
        </select>
        <input id="vat1-cap-comments" class="form-control mt-1" placeholder="Cap notes / sizing">
        <input type="file" id="vat1-cap-photo" class="form-control mt-1" accept="image/*">
        <img id="vat1-cap-preview" class="image-preview">
      </div>
      <div>
        <label class="form-label">Level Sensor</label>
        <select id="vat1-level" class="form-select">
          <option value="na">N/A</option>
          <option value="present">Present</option>
          <option value="notpresent">Not Present</option>
          <option value="needswork">Needs Work</option>
        </select>
        <input id="vat1-level-comments" class="form-control mt-1" placeholder="Level notes">
        <input type="file" id="vat1-level-photo" class="form-control mt-1" accept="image/*">
        <img id="vat1-level-preview" class="image-preview">
      </div>
      <div>
        <label class="form-label">Condition</label>
        <select id="vat1-condition" class="form-select">
          <option value="ok">OK</option>
          <option value="attention">Attention Required</option>
        </select>
        <input id="vat1-condition-comments" class="form-control mt-1" placeholder="Condition notes">
        <input type="file" id="vat1-condition-photo" class="form-control mt-1" accept="image/*">
        <img id="vat1-condition-preview" class="image-preview">
      </div>
    </div>

    <div class="divider"></div>
    <div class="section-title">Vat 2</div>
    <div class="grid-2">
      <div>
        <label class="form-label">Capacity (L)</label>
        <input id="vat2-capacity" class="form-control" placeholder="Leave blank if single vat">
      </div>
      <div>
        <label class="form-label">Serial Number</label>
        <input id="vat2-serial" class="form-control">
      </div>
    </div>
    <div class="grid-3">
      <div>
        <label class="form-label">Cap</label>
        <select id="vat2-cap" class="form-select">
          <option value="na">N/A</option>
          <option value="available">Available ✓</option>
          <option value="unavailable">Unavailable ✗</option>
        </select>
        <input id="vat2-cap-comments" class="form-control mt-1" placeholder="Cap notes / sizing">
        <input type="file" id="vat2-cap-photo" class="form-control mt-1" accept="image/*">
        <img id="vat2-cap-preview" class="image-preview">
      </div>
      <div>
        <label class="form-label">Level Sensor</label>
        <select id="vat2-level" class="form-select">
          <option value="na">N/A</option>
          <option value="present">Present</option>
          <option value="notpresent">Not Present</option>
          <option value="needswork">Needs Work</option>
        </select>
        <input id="vat2-level-comments" class="form-control mt-1" placeholder="Level notes">
        <input type="file" id="vat2-level-photo" class="form-control mt-1" accept="image/*">
        <img id="vat2-level-preview" class="image-preview">
      </div>
      <div>
        <label class="form-label">Condition</label>
        <select id="vat2-condition" class="form-select">
          <option value="ok">OK</option>
          <option value="attention">Attention Required</option>
        </select>
        <input id="vat2-condition-comments" class="form-control mt-1" placeholder="Condition notes">
        <input type="file" id="vat2-condition-photo" class="form-control mt-1" accept="image/*">
        <img id="vat2-condition-preview" class="image-preview">
      </div>
    </div>

    <div class="divider"></div>
    <div class="section-title">Agitator</div>
    <div class="grid-2">
      <div>
        <label class="form-label">Sensor Location</label>
        <input id="agitator-location" class="form-control" placeholder="e.g., top hatch">
      </div>
      <div>
        <label class="form-label">Comments</label>
        <input id="agitator-comments" class="form-control" placeholder="Notes, measurements">
        <input type="file" id="agitator-photo" class="form-control mt-1" accept="image/*">
        <img id="agitator-preview" class="image-preview">
      </div>
    </div>

    <div class="divider"></div>
    <div class="section-title">Gateway</div>
    <div class="grid-2">
      <div>
        <label class="form-label">Location</label>
        <input id="gateway-location" class="form-control" placeholder="e.g., office wall / control room">
      </div>
      <div>
        <label class="form-label">Comments</label>
        <input id="gateway-comments" class="form-control" placeholder="Power point, mounting, protection">
        <input type="file" id="gateway-photo" class="form-control mt-1" accept="image/*">
        <img id="gateway-preview" class="image-preview">
      </div>
    </div>

    <div class="divider"></div>
    <div class="section-title">Other Telemetry</div>
    <div class="grid-2">
      <div>
        <label class="form-label">Notes</label>
        <input id="telemetry-comments" class="form-control" placeholder="Halo, DTS, grey/gray sensor notes, card numbers…">
      </div>
      <div class="tiny">AI will normalize common lingo into clean tags (Reducing Cap, Grey/Grey Sensor, Halo, DTS, Power Point, Card Numbers).</div>
    </div>

    <div class="divider"></div>
    <div class="section-title">Rubberware</div>
    <div class="grid-3">
      <div>
        <label class="form-label">Vat Door Seal</label>
        <select id="vat-door-seal" class="form-select">
          <option value="notdelivered">Not Delivered</option>
          <option value="delivered">Delivered</option>
        </select>
        <select id="vat-door-seal-size" class="form-select mt-1">
          <option value="">Size (select if delivered)</option>
          <option value="small">Small</option>
          <option value="large">Large</option>
        </select>
        <input id="vat-door-seal-comments" class="form-control mt-1" placeholder="Door seal notes">
        <input type="file" id="vat-door-seal-photo" class="form-control mt-1" accept="image/*">
        <img id="vat-door-seal-preview" class="image-preview">
      </div>
      <div>
        <label class="form-label">RJT Step Seal</label>
        <select id="rjt-seal" class="form-select">
          <option value="notdelivered">Not Delivered</option>
          <option value="delivered">Delivered</option>
        </select>
        <select id="rjt-seal-size" class="form-select mt-1">
          <option value="">Size (select if delivered)</option>
          <option value="small">Small</option>
          <option value="large">Large</option>
        </select>
        <input id="rjt-seal-comments" class="form-control mt-1" placeholder="RJT notes">
        <input type="file" id="rjt-seal-photo" class="form-control mt-1" accept="image/*">
        <img id="rjt-seal-preview" class="image-preview">
      </div>
      <div>
        <label class="form-label">Chiller Condition</label>
        <select id="chiller-condition" class="form-select">
          <option value="ok">OK</option>
          <option value="attention">Attention Required</option>
        </select>
        <input id="chiller-condition-comments" class="form-control mt-1" placeholder="Chiller notes">
        <input type="file" id="chiller-condition-photo" class="form-control mt-1" accept="image/*">
        <img id="chiller-condition-preview" class="image-preview">
      </div>
    </div>

    <div class="divider"></div>
    <div class="d-flex gap-2">
      <button class="btn btn-agora" id="btn-save">Save</button>
      <button class="btn btn-outline" id="btn-view-summary">View Summary</button>
      <!-- NO downloads here (Flash demo). Downloads live in Admin only. -->
    </div>
  </div>

  <!-- SUMMARY (customer-facing, no downloads) -->
  <div id="summary-shell" class="card-shell hidden">
    <div class="section-title">Farms Summary</div>
    <div class="grid-4" id="summary-kpis"></div>
    <div class="divider"></div>
    <div class="grid-2">
      <input id="filter-search" class="form-control" placeholder="Search Dairy #" />
      <select id="filter-attn" class="form-select">
        <option value="">All</option>
        <option value="attention">Attention Only</option>
        <option value="nocap">No Available Cap</option>
        <option value="two-vats">Two Vats</option>
        <option value="needs-level">Level Needs Work / Missing</option>
      </select>
    </div>
    <div class="tiny mt-1">Cards reflect AI-normalized tags from comments (e.g., “grey/gray sensor”, “halo”, “DTS”, “reducing cap”, “power point”, “card numbers”).</div>
    <div class="divider"></div>
    <div id="cards-wrap" class="grid-2"></div>
    <div class="divider"></div>
    <button class="btn btn-outline" id="btn-back-to-form">Back</button>
  </div>

  <!-- ADMIN (downloads only) -->
  <div id="admin-shell" class="hidden">
    <div class="admin-only">
      <div class="section-title">Admin — Exports</div>
      <div class="tiny mb-2">Only admins see this screen. Use it to export CSV/XLSX or generate a PDF pack.</div>
      <div class="d-flex gap-2 mb-2">
        <button class="btn btn-darky" id="btn-export-csv"><i class="bi bi-file-earmark-spreadsheet"></i> Export CSV</button>
        <button class="btn btn-darky" id="btn-export-xlsx"><i class="bi bi-file-earmark-excel"></i> Export XLSX</button>
        <button class="btn btn-darky" id="btn-export-pdf"><i class="bi bi-file-earmark-pdf"></i> Export PDF Pack</button>
        <button class="btn btn-outline" id="btn-back-main">Back</button>
      </div>
      <div class="divider"></div>
      <div class="grid-2">
        <input id="admin-search" class="form-control" placeholder="Search Dairy #" />
        <select id="admin-filter" class="form-select">
          <option value="">All</option>
          <option value="attention">Attention Only</option>
          <option value="nocap">No Cap Available</option>
        </select>
      </div>
      <div class="divider"></div>
      <div id="admin-table"></div>
    </div>
  </div>

</div>

<!-- Overlay -->
<div id="overlay" class="overlay"><div><div class="loader"></div><div id="overlay-text" class="text-center">Loading…</div></div></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

<script>
/* ================== CONFIG ================== */
const firebaseConfig = {
  apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain: "dairy-farm-record-system.firebaseapp.com",
  projectId: "dairy-farm-record-system",
  storageBucket: "dairy-farm-record-system.appspot.com",
  messagingSenderId: "422124188212",
  appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const PRECHECK_FOLDER = "Pre Check";

const initialUsers = [
  { email:"regan.beaver@agora.co.nz", name:"Regan Beaver", password:"Moometrics24", role:"admin" },
  { email:"ahren.lomas@agora.co.nz", name:"Ahren Lomas", password:"Moometrics24", role:"admin" },
  { email:"caroline@agora.co.nz", name:"Caroline Wallace", password:"dairy123", role:"admin" },
  { email:"kip@agora.co.nz", name:"Kip Bodle", password:"dairy123", role:"admin" },
  { email:"josh.bull@agora.co.nz", name:"Josh Bull", password:"dairy123", role:"admin" },
  { email:"tech@agora.co.nz", name:"Service Tech", password:"dairy123", role:"member" }
];
if(!localStorage.getItem("ag_users")) localStorage.setItem("ag_users", JSON.stringify(initialUsers));
let curUser = null;

/* ================== UTIL ================== */
const $ = (id)=>document.getElementById(id);
function show(el){el.classList.remove('hidden')}
function hide(el){el.classList.add('hidden')}
function on(id,ev,fn){$(id).addEventListener(ev,fn)}
function showOverlay(t){$('overlay-text').textContent=t||'Loading…'; $('overlay').style.display='flex'}
function hideOverlay(){$('overlay').style.display='none'}
function isTwoVats(rec){ return !!(rec['vat2-capacity'] || (rec['vat2-cap'] && rec['vat2-cap']!=='na')) }
function asThumbList(rec){
  const keys = [
    'vat1-cap','vat2-cap','vat1-level','vat2-level','vat1-condition','vat2-condition',
    'gateway','agitator','vat-door-seal','rjt-seal','chiller-condition'
  ];
  const imgs = [];
  keys.forEach(k=>{
    const b64 = rec[`${k}-photo-base64`]; if(b64) imgs.push(b64);
  });
  return imgs.slice(0,3);
}

/* ============== LOGO ============== */
(async function(){
  try{
    const ref = storage.ref("Agora Logo/2F6-1YdaEP.jpeg");
    const url = await ref.getDownloadURL();
    const img = $('logo');
    img.src = url; img.style.display='block';
  }catch{}
})();

/* ============== AUTH ============== */
function getUsers(){return JSON.parse(localStorage.getItem("ag_users")||"[]")}
function login(email, pass){
  const u = getUsers().find(x=>x.email.toLowerCase()===email.toLowerCase() && x.password===pass);
  return u || null;
}
function updateNav(){
  $('whoami').textContent = curUser ? `${curUser.name} • ${curUser.role}` : 'Not logged in';
  if(curUser){
    show($('btn-logout')); show($('btn-summary')); show($('btn-form'));
    if(curUser.role==='admin') show($('btn-admin')); else hide($('btn-admin'));
  }else{
    hide($('btn-logout')); hide($('btn-summary')); hide($('btn-form')); hide($('btn-admin'));
  }
}
on('btn-login','click',()=>{
  const u=login($('login-email').value, $('login-pass').value);
  if(!u){ alert('Login failed'); return; }
  curUser = u; updateNav(); renderAISummary(); renderKPIs();
});
on('btn-logout','click',()=>{ curUser=null; updateNav(); });

/* ============== IMAGE PREVIEW ============== */
[
  'vat1-cap','vat2-cap','vat1-level','vat2-level','vat1-condition','vat2-condition',
  'gateway','agitator','vat-door-seal','rjt-seal','chiller-condition'
].forEach(prefix=>{
  const fileEl = $(prefix+'-photo');
  if(fileEl){
    fileEl.addEventListener('change', e=>{
      const img = $(prefix+'-preview');
      const f = e.target.files[0]; if(!f){ img.style.display='none'; return; }
      const url = URL.createObjectURL(f);
      img.src=url; img.style.display='block';
      // save base64
      const rdr = new FileReader();
      rdr.onload = ev => { img.setAttribute('data-base64', ev.target.result); };
      rdr.readAsDataURL(f);
    });
  }
});

/* ============== SAVE / LOAD ============== */
function collectForm(){
  const data = {
    dairyNumber: $('dairyNumber').value.trim(),
    'current-telemetry': $('current-telemetry').value.trim(),

    'vat1-capacity': $('vat1-capacity').value.trim(),
    'vat1-serial': $('vat1-serial').value.trim(),
    'vat1-cap': $('vat1-cap').value, 'vat1-cap-comments': $('vat1-cap-comments').value.trim(),
    'vat1-level': $('vat1-level').value, 'vat1-level-comments': $('vat1-level-comments').value.trim(),
    'vat1-condition': $('vat1-condition').value, 'vat1-condition-comments': $('vat1-condition-comments').value.trim(),

    'vat2-capacity': $('vat2-capacity').value.trim(),
    'vat2-serial': $('vat2-serial').value.trim(),
    'vat2-cap': $('vat2-cap').value, 'vat2-cap-comments': $('vat2-cap-comments').value.trim(),
    'vat2-level': $('vat2-level').value, 'vat2-level-comments': $('vat2-level-comments').value.trim(),
    'vat2-condition': $('vat2-condition').value, 'vat2-condition-comments': $('vat2-condition-comments').value.trim(),

    'agitator-location': $('agitator-location').value.trim(),
    'agitator-comments': $('agitator-comments').value.trim(),

    'gateway-location': $('gateway-location').value.trim(),
    'gateway-comments': $('gateway-comments').value.trim(),

    'telemetry-comments': $('telemetry-comments').value.trim(),

    'vat-door-seal': $('vat-door-seal').value,
    'vat-door-seal-size': $('vat-door-seal-size').value,
    'vat-door-seal-comments': $('vat-door-seal-comments').value.trim(),

    'rjt-seal': $('rjt-seal').value,
    'rjt-seal-size': $('rjt-seal-size').value,
    'rjt-seal-comments': $('rjt-seal-comments').value.trim(),

    'chiller-condition': $('chiller-condition').value,
    'chiller-condition-comments': $('chiller-condition-comments').value.trim(),

    timestamp: new Date().toISOString()
  };
  // photos (base64 from previews)
  [
    'vat1-cap','vat2-cap','vat1-level','vat2-level','vat1-condition','vat2-condition',
    'gateway','agitator','vat-door-seal','rjt-seal','chiller-condition'
  ].forEach(prefix=>{
    const img = $(prefix+'-preview');
    const b64 = img?.getAttribute('data-base64');
    if(b64) data[prefix+'-photo-base64'] = b64;
  });
  return data;
}
async function saveToStorage(rec){
  const path = `${PRECHECK_FOLDER}/${rec.dairyNumber}.json`;
  const blob = new Blob([JSON.stringify(rec)],{type:'application/json'});
  await storage.ref(path).put(blob);
}
async function loadAllRecords(){
  try{
    const folderRef = storage.ref(PRECHECK_FOLDER);
    const res = await folderRef.listAll();
    const arr=[];
    for(const fileRef of res.items){
      if(!fileRef.name.endsWith('.json')) continue;
      const url = await fileRef.getDownloadURL();
      const data = await fetch(url).then(r=>r.json()).catch(()=>null);
      if(data) arr.push(data);
    }
    return arr;
  }catch{return []}
}

/* ============== AI-ISH NORMALIZATION ============== */
/* Maps flexible lingo to canonical tags for cards/summary. */
const TAGS = {
  reducingCap: [/reducing[\s-]?cap\b/i, /\breducer\b/i, /cap\s*reducer/i],
  greySensor: [/\bgrey\b.*sensor/i, /\bgray\b.*sensor/i, /grey.*halo/i, /gray.*halo/i],
  halo: /\bhalo\b/i,
  dts: /\bDTS\b/i,
  powerPoint: /\bpower[\s-]?point\b/i, /\bpower\s*plug\b/i, /\bGPO\b/i, /\bpower\s*outlet\b/i,
  cardNumbers: /\bcard\s*number/i
};
function normalizeTags(rec){
  const texts = [
    rec['telemetry-comments'], rec['gateway-comments'], rec['agitator-comments'],
    rec['vat1-cap-comments'], rec['vat2-cap-comments'],
    rec['vat1-level-comments'], rec['vat2-level-comments'],
    rec['vat1-condition-comments'], rec['vat2-condition-comments'],
    rec['chiller-condition-comments'], rec['vat-door-seal-comments'], rec['rjt-seal-comments'],
    rec['current-telemetry']
  ].filter(Boolean).join(' | ');

  const found = {};
  for(const [key, rx] of Object.entries(TAGS)){
    if(Array.isArray(rx)) found[key] = rx.some(r=>r.test(texts));
    else found[key] = rx.test(texts);
  }
  // Derived needs:
  // - Need Reducing Cap if any vat cap is unavailable or comments hint reducer
  const needReducing = (rec['vat1-cap']==='unavailable' || rec['vat2-cap']==='unavailable' || found.reducingCap);
  // - Level issues
  const levelIssue = ['vat1-level','vat2-level'].some(k=>['notpresent','needswork'].includes(rec[k]));
  // - Attention flags (any attention)
  const attention = ['vat1-condition','vat2-condition','chiller-condition'].some(k=>rec[k]==='attention');

  return {
    needReducingCap: needReducing,
    levelIssue,
    attention,
    hasGreySensor: found.greySensor,
    hasHalo: found.halo,
    hasDTS: found.dts,
    mentionsPowerPoint: found.powerPoint,
    mentionsCardNumbers: found.cardNumbers
  };
}

/* ============== FORM ACTIONS ============== */
on('btn-save','click', async ()=>{
  const rec = collectForm();
  if(!rec.dairyNumber){ alert('Dairy Number required'); return; }
  showOverlay('Saving…');
  try{
    await saveToStorage(rec);
    alert('Saved.');
  }catch{ alert('Save failed.'); }
  hideOverlay();
});
on('btn-view-summary','click', async ()=>{
  showOverlay('Building summary…');
  hide($('form-shell')); hide($('admin-shell')); show($('summary-shell'));
  await renderSummary();
  hideOverlay();
});
on('btn-back-to-form','click', ()=>{
  hide($('summary-shell')); hide($('admin-shell')); show($('form-shell'));
});

/* ============== SUMMARY (CARDS + KPIs) ============== */
function kpiBox(num,label){ return `<div class="kpi"><div class="num">${num}</div><div class="lab">${label}</div></div>` }
async function renderSummary(){
  const all = await loadAllRecords();
  const cardsWrap = $('cards-wrap');
  const kpis = $('summary-kpis'); kpis.innerHTML='';

  // Aggregates
  const total = all.length;
  const twoVats = all.filter(isTwoVats).length;
  const attention = all.filter(r=>normalizeTags(r).attention).length;
  const noCap = all.filter(r=> r['vat1-cap']==='unavailable' || r['vat2-cap']==='unavailable').length;

  // Rubberware delivered counting
  let doorDeliveredUnits = 0;
  let rjtDeliveredUnits = 0;
  all.forEach(r=>{
    const hasTwo=isTwoVats(r);
    if(r['vat-door-seal']==='delivered'){
      doorDeliveredUnits += hasTwo ? 2 : 1;
    }
    if(r['rjt-seal']==='delivered'){
      rjtDeliveredUnits += hasTwo ? 2 : 1;
    }
  });

  kpis.innerHTML = [
    kpiBox(total,'Farms'),
    kpiBox(twoVats,'Two-Vat Sites'),
    kpiBox(attention,'Attention Required'),
    kpiBox(noCap,'Caps Unavailable')
  ].join('');

  // Filters
  const q = $('filter-search').value.trim().toLowerCase();
  const f = $('filter-attn').value;
  let view = all;
  if(q) view = view.filter(r=>(r.dairyNumber||'').toLowerCase().includes(q));
  if(f==='attention') view = view.filter(r=>normalizeTags(r).attention);
  if(f==='nocap') view = view.filter(r=> r['vat1-cap']==='unavailable' || r['vat2-cap']==='unavailable');
  if(f==='two-vats') view = view.filter(isTwoVats);
  if(f==='needs-level') view = view.filter(r=>normalizeTags(r).levelIssue);

  // Cards
  cardsWrap.innerHTML='';
  view.sort((a,b)=>(a.dairyNumber||'').localeCompare(b.dairyNumber||''));
  view.forEach(rec=>{
    const tags = normalizeTags(rec);
    const thumbs = asThumbList(rec);
    const hasTwo = isTwoVats(rec);
    const sealSize = rec['vat-door-seal-size'] || '-';
    const rjtSize  = rec['rjt-seal-size'] || '-';
    const deliveredDoor = rec['vat-door-seal']==='delivered' ? (hasTwo ? '2 delivered' : '1 delivered') : '0 delivered';
    const deliveredRjt  = rec['rjt-seal']==='delivered' ? (hasTwo ? '2 delivered' : '1 delivered') : '0 delivered';

    const chips = [];
    // Vat status
    chips.push(`<span class="badge-chip ${rec['vat1-cap']==='available'?'badge-ok':'badge-attn'}">Vat1 Cap: ${rec['vat1-cap']}</span>`);
    if(rec['vat2-cap'] && rec['vat2-cap']!=='na') chips.push(`<span class="badge-chip ${rec['vat2-cap']==='available'?'badge-ok':'badge-attn'}">Vat2 Cap: ${rec['vat2-cap']}</span>`);
    // Level
    const lvl1 = rec['vat1-level']; const lvl2 = rec['vat2-level'];
    if(lvl1) chips.push(`<span class="badge-chip ${['present','na'].includes(lvl1)?'badge-ok':'badge-attn'}">Vat1 Level: ${lvl1}</span>`);
    if(lvl2 && lvl2!=='na') chips.push(`<span class="badge-chip ${['present','na'].includes(lvl2)?'badge-ok':'badge-attn'}">Vat2 Level: ${lvl2}</span>`);
    // Condition
    chips.push(`<span class="badge-chip ${rec['vat1-condition']==='ok'?'badge-ok':'badge-attn'}">Vat1 Cond: ${rec['vat1-condition']}</span>`);
    if(rec['vat2-capacity']) chips.push(`<span class="badge-chip ${rec['vat2-condition']==='ok'?'badge-ok':'badge-attn'}">Vat2 Cond: ${rec['vat2-condition']}</span>`);
    // Chiller
    chips.push(`<span class="badge-chip ${rec['chiller-condition']==='ok'?'badge-ok':'badge-attn'}">Chiller: ${rec['chiller-condition']}</span>`);
    // Rubberware delivered
    chips.push(`<span class="badge-chip ${rec['vat-door-seal']==='delivered'?'badge-ok':'badge-attn'}">Door Seal: ${deliveredDoor} (${sealSize})</span>`);
    chips.push(`<span class="badge-chip ${rec['rjt-seal']==='delivered'?'badge-ok':'badge-attn'}">RJT: ${deliveredRjt} (${rjtSize})</span>`);
    // AI tags
    if(tags.needReducingCap) chips.push(`<span class="badge-chip badge-attn">Needs Reducing Cap</span>`);
    if(tags.hasGreySensor) chips.push(`<span class="badge-chip">Grey/Grey Sensor</span>`);
    if(tags.hasHalo) chips.push(`<span class="badge-chip">Halo</span>`);
    if(tags.hasDTS) chips.push(`<span class="badge-chip">DTS</span>`);
    if(tags.mentionsPowerPoint) chips.push(`<span class="badge-chip">Power Point</span>`);
    if(tags.mentionsCardNumbers) chips.push(`<span class="badge-chip">Card Numbers</span>`);

    const card = document.createElement('div');
    card.className='tcard';
    card.innerHTML=`
      <div class="tcard-head">
        <div class="t-id">Dairy #${rec.dairyNumber||'-'}</div>
        <div class="t-badges">${chips.join('')}</div>
      </div>
      <div class="thumbs">${thumbs.map(b64=>`<img src="${b64}">`).join('')}</div>
      <div class="mt-2 tiny">
        <b>Vat1:</b> ${rec['vat1-capacity']||'-'}L • S/N ${rec['vat1-serial']||'-'} &nbsp; | &nbsp;
        <b>Vat2:</b> ${rec['vat2-capacity']||'-'}L • S/N ${rec['vat2-serial']||'-'} &nbsp; | &nbsp;
        <b>Gateway:</b> ${rec['gateway-location']||'-'} &nbsp; | &nbsp;
        <b>Agitator:</b> ${rec['agitator-location']||'-'}
      </div>
    `;
    cardsWrap.appendChild(card);
  });

  // Top of summary (global rubberware units)
  const addTop = document.createElement('div');
  addTop.className='tiny';
  addTop.innerHTML = `<b>Rubberware delivered (units):</b> Door Seals = ${doorDeliveredUnits} • RJT = ${rjtDeliveredUnits}`;
  kpis.appendChild(addTop);
}
// filter listeners
['filter-search','filter-attn'].forEach(id=>on(id,'input',()=>renderSummary()));

/* ============== AI SUMMARY (GLOBAL) ============== */
async function renderAISummary(){
  if(!curUser){ hide($('ai-summary')); return; }
  show($('ai-summary'));
  const all = await loadAllRecords();
  const bullets = [];
  const attn = all.filter(r=>normalizeTags(r).attention).length;
  const noCap = all.filter(r=> r['vat1-cap']==='unavailable' || r['vat2-cap']==='unavailable').length;
  const needReducer = all.filter(r=>normalizeTags(r).needReducingCap).length;
  const levelIssues = all.filter(r=>normalizeTags(r).levelIssue).length;
  const greyMentions = all.filter(r=>normalizeTags(r).hasGreySensor).length;
  const haloSites = all.filter(r=>normalizeTags(r).hasHalo).length;
  const dtsSites = all.filter(r=>normalizeTags(r).hasDTS).length;

  bullets.push(`You have ${all.length} farms recorded; ${attn} require attention (vat or chiller).`);
  if(noCap) bullets.push(`${noCap} farm(s) have unavailable vat cap(s).`);
  if(needReducer) bullets.push(`${needReducer} mention a reducing cap need (check cap sizing).`);
  if(levelIssues) bullets.push(`${levelIssues} farm(s) have level sensor missing/needs work.`);
  if(greyMentions) bullets.push(`${greyMentions} mention grey/gray sensor or halo wording—confirm sensor kit.`);
  if(haloSites) bullets.push(`${haloSites} site(s) mention Halo; align gateway/telemetry plan.`);
  if(dtsSites) bullets.push(`${dtsSites} site(s) mention DTS; confirm compatibility.`);

  $('ai-bullets').innerHTML = bullets.map(b=>`<div class="ai-bullet"><i class="bi bi-lightning-charge-fill"></i><div>${b}</div></div>`).join('');
}
async function renderKPIs(){
  if(!curUser){ hide($('kpi-row')); return; }
  const all = await loadAllRecords();
  const twoVats = all.filter(isTwoVats).length;
  const attention = all.filter(r=>normalizeTags(r).attention).length;
  const noCap = all.filter(r=> r['vat1-cap']==='unavailable' || r['vat2-cap']==='unavailable').length;
  const k = $('kpi-row'); k.innerHTML='';
  show(k);
  k.innerHTML = [
    kpiBox(all.length,'Farms'),
    kpiBox(twoVats,'Two-Vat Sites'),
    kpiBox(attention,'Attention'),
    kpiBox(noCap,'Caps Unavailable')
  ].join('');
}

/* ============== ADMIN (EXPORTS ONLY) ============== */
on('btn-admin','click', async ()=>{
  if(!curUser || curUser.role!=='admin'){ alert('Admins only'); return; }
  showOverlay('Loading admin…');
  hide($('form-shell')); hide($('summary-shell')); show($('admin-shell'));
  await renderAdminTable();
  hideOverlay();
});
on('btn-back-main','click', ()=>{
  hide($('admin-shell')); show($('form-shell'));
});
on('btn-summary','click', async ()=>{
  showOverlay('Building summary…');
  hide($('form-shell')); hide($('admin-shell')); show($('summary-shell'));
  await renderSummary();
  hideOverlay();
});
on('btn-form','click', ()=>{
  hide($('summary-shell')); hide($('admin-shell')); show($('form-shell'));
});

async function renderAdminTable(){
  const all = await loadAllRecords();
  const q = $('admin-search').value.trim().toLowerCase();
  const f = $('admin-filter').value;
  let view = all;
  if(q) view = view.filter(r=>(r.dairyNumber||'').toLowerCase().includes(q));
  if(f==='attention') view = view.filter(r=>normalizeTags(r).attention);
  if(f==='nocap') view = view.filter(r=> r['vat1-cap']==='unavailable' || r['vat2-cap']==='unavailable');

  const rows = view.map(r=>({
    Dairy: r.dairyNumber||'',
    Vat1Cap: r['vat1-cap']||'',
    Vat1L: r['vat1-capacity']||'',
    Vat1Level: r['vat1-level']||'',
    Vat1Cond: r['vat1-condition']||'',
    Vat2Cap: r['vat2-cap']||'',
    Vat2L: r['vat2-capacity']||'',
    Vat2Level: r['vat2-level']||'',
    Vat2Cond: r['vat2-condition']||'',
    Chiller: r['chiller-condition']||'',
    DoorSeal: r['vat-door-seal']||'',
    DoorSize: r['vat-door-seal-size']||'',
    RJT: r['rjt-seal']||'',
    RJTSize: r['rjt-seal-size']||'',
    Telemetry: r['current-telemetry']||'',
    Updated: r.timestamp||''
  }));
  const html = `
    <div class="matrix-wrap">
      <div class="matrix" style="grid-template-columns:repeat(10,1fr);min-width:980px">
        <div class="hdr">Dairy</div><div class="hdr">V1 Cap</div><div class="hdr">V1 L</div><div class="hdr">V1 Level</div><div class="hdr">V1 Cond</div>
        <div class="hdr">V2 Cap</div><div class="hdr">V2 L</div><div class="hdr">V2 Level</div><div class="hdr">V2 Cond</div><div class="hdr">Chiller</div>
        ${rows.map(r=>`
          <div class="cell">${r.Dairy}</div><div class="cell">${r.Vat1Cap}</div><div class="cell">${r.Vat1L}</div><div class="cell">${r.Vat1Level}</div><div class="cell">${r.Vat1Cond}</div>
          <div class="cell">${r.Vat2Cap}</div><div class="cell">${r.Vat2L}</div><div class="cell">${r.Vat2Level}</div><div class="cell">${r.Vat2Cond}</div><div class="cell">${r.Chiller}</div>
        `).join('')}
      </div>
    </div>`;
  $('admin-table').innerHTML = html;
}
on('admin-search','input',renderAdminTable);
on('admin-filter','change',renderAdminTable);

function flatRow(rec){
  const tags = normalizeTags(rec);
  const hasTwo = isTwoVats(rec);
  const doorUnits = rec['vat-door-seal']==='delivered' ? (hasTwo?2:1) : 0;
  const rjtUnits  = rec['rjt-seal']==='delivered' ? (hasTwo?2:1) : 0;
  return {
    DairyNumber: rec.dairyNumber||'',
    Vat1_Capacity_L: rec['vat1-capacity']||'',
    Vat1_Serial: rec['vat1-serial']||'',
    Vat1_Cap: rec['vat1-cap']||'',
    Vat1_Level: rec['vat1-level']||'',
    Vat1_Condition: rec['vat1-condition']||'',
    Vat2_Capacity_L: rec['vat2-capacity']||'',
    Vat2_Serial: rec['vat2-serial']||'',
    Vat2_Cap: rec['vat2-cap']||'',
    Vat2_Level: rec['vat2-level']||'',
    Vat2_Condition: rec['vat2-condition']||'',
    Agitator_Location: rec['agitator-location']||'',
    Gateway_Location: rec['gateway-location']||'',
    Telemetry_System: rec['current-telemetry']||'',
    Chiller_Condition: rec['chiller-condition']||'',
    Door_Seal_Status: rec['vat-door-seal']||'',
    Door_Seal_Size: rec['vat-door-seal-size']||'',
    Door_Seal_UnitsDelivered: doorUnits,
    RJT_Status: rec['rjt-seal']||'',
    RJT_Size: rec['rjt-seal-size']||'',
    RJT_UnitsDelivered: rjtUnits,
    Need_ReducingCap: tags.needReducingCap?'Yes':'',
    Level_Issue: tags.levelIssue?'Yes':'',
    Attention: tags.attention?'Yes':'',
    Grey_Sensor: tags.hasGreySensor?'Yes':'',
    Halo: tags.hasHalo?'Yes':'',
    DTS: tags.hasDTS?'Yes':'',
    PowerPoint_Mention: tags.mentionsPowerPoint?'Yes':'',
    CardNumbers_Mention: tags.mentionsCardNumbers?'Yes':'',
    UpdatedAt: rec.timestamp||''
  };
}
on('btn-export-csv','click', async ()=>{
  const all = await loadAllRecords();
  const rows = all.map(flatRow);
  if(!rows.length) return alert('No data');
  const headers = Object.keys(rows[0]);
  const csv = "\uFEFF" + [headers.join(',')].concat(rows.map(r=>headers.map(h=>`"${String(r[h]??'').replace(/"/g,'""')}"`).join(','))).join("\r\n");
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='vat_precheck.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),800);
});
on('btn-export-xlsx','click', async ()=>{
  const all = await loadAllRecords();
  const rows = all.map(flatRow);
  if(!rows.length) return alert('No data');
  const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "PreCheck");
  XLSX.writeFile(wb, "vat_precheck.xlsx");
});
on('btn-export-pdf','click', async ()=>{
  const { jsPDF } = window.jspdf;
  const all = await loadAllRecords();
  if(!all.length) return alert('No data');
  const pdf = new jsPDF('l','pt','a4');
  pdf.setFontSize(16); pdf.text('Agora Vat Pre-Check — Pack', 38, 40);
  let y=60;
  all.sort((a,b)=>(a.dairyNumber||'').localeCompare(b.dairyNumber||''));
  for(const rec of all){
    pdf.setFontSize(13); pdf.text(`Dairy #${rec.dairyNumber||'-'}`, 38, y); y+=14;
    const tbl = [];
    const push = (k,v)=>tbl.push([k,v||'-']);
    push('Vat1 Cap',rec['vat1-cap']); push('Vat1 L',rec['vat1-capacity']); push('Vat1 Level',rec['vat1-level']); push('Vat1 Cond',rec['vat1-condition']);
    push('Vat2 Cap',rec['vat2-cap']); push('Vat2 L',rec['vat2-capacity']); push('Vat2 Level',rec['vat2-level']); push('Vat2 Cond',rec['vat2-condition']);
    push('Chiller',rec['chiller-condition']); push('Door Seal', rec['vat-door-seal'] + (rec['vat-door-seal-size']?` (${rec['vat-door-seal-size']})`:'')); push('RJT', rec['rjt-seal'] + (rec['rjt-seal-size']?` (${rec['rjt-seal-size']})`:'')); 
    push('Gateway', rec['gateway-location']); push('Agitator', rec['agitator-location']); push('Telemetry', rec['current-telemetry']);
    pdf.autoTable({ startY:y, head:[['Field','Value']], body:tbl, styles:{fontSize:9, cellPadding:3}, headStyles:{fillColor:[0,31,63], textColor:255} });
    y = pdf.lastAutoTable.finalY + 8;
    // photos (up to 3)
    const pics = asThumbList(rec);
    for(const b64 of pics){
      if(y+130>560){ pdf.addPage(); y=40; }
      pdf.addImage(b64,'JPEG',38,y,220,120); y+=130;
    }
    if(y+60>560){ pdf.addPage(); y=40; } else { y+=10; }
  }
  pdf.save('vat_precheck_pack.pdf');
});

/* ============== AI + KPIs ON LOGIN ============== */
on('btn-login','click',()=>{ /* render called in updateNav via render funcs */ });

/* ============== INIT NAV DEFAULT ============== */
updateNav();
</script>
</body>
</html>