<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Agora Vat Pre-Check — Flash</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<style>
  :root{
    --bg:#f8faff; --ink:#0d1b2a; --brand:#a7ab01; --accent:#FF851B; --muted:#6c757d;
    --ok:#2ECC40; --warn:#f5a623; --bad:#e74c3c; --card:#ffffff; --edge:#e9ecef;
    --w:1080px;
  }
  body{background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .container-main{max-width:var(--w);margin:24px auto;padding:0 14px}
  .shell{background:var(--card);border:1px solid var(--edge);border-radius:16px;box-shadow:0 2px 28px #0d1b2a10;padding:18px}
  h1{color:var(--brand);font-size:1.8rem;margin:8px 0 12px}
  .navline{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 14px}
  .btn-tab{border-radius:8px;border:1px solid var(--edge);background:#fff;color:var(--ink);font-weight:600}
  .btn-tab:hover{border-color:#cfd6dd}
  .btn-brand{background:var(--brand);border:none;color:#fff}
  .btn-plain{background:#fff;color:var(--ink)}
  .logo-header{max-width:220px;display:block;margin:0 auto 6px}
  .hidden{display:none!important}
  .form-section-title{font-weight:800;color:#1c3d5a;margin:14px 0 6px}
  .image-preview{display:none;max-width:200px;border:2px solid #ddd;border-radius:8px;margin-top:6px}
  .big-photo{max-width:760px;max-height:520px;display:block;margin:16px auto;border:1px solid #eee;border-radius:8px}
  .note{color:var(--muted);font-size:.92em}

  /* KPIs */
  .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi{border:1px solid var(--edge);border-radius:12px;padding:12px;background:#fff}
  .kpi .num{font-size:1.4rem;font-weight:800}
  .kpi .lab{color:#6b7280;font-size:.9rem}
  @media (max-width:900px){.kpi-grid{grid-template-columns:repeat(2,1fr)}}

  /* Cards list (flash summary) */
  .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (max-width:900px){.cards{grid-template-columns:1fr}}
  .card-farm{border:1px solid var(--edge);border-radius:14px;background:#fff;padding:12px}
  .cf-head{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
  .cf-title{font-weight:800}
  .badge-soft{display:inline-block;padding:2px 8px;border:1px solid var(--edge);border-radius:999px;font-size:.78rem;margin-left:6px}
  .bad-ok{background:#eafff2;border-color:#b7f3cc}
  .bad-warn{background:#fff7e6;border-color:#ffe0a6}
  .bad-bad{background:#ffecee;border-color:#ffc8cf}
  .cf-body{margin-top:8px;font-size:.95rem}
  .cf-photos img{width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid #eee;margin-right:6px}
  .chip{display:inline-block;padding:4px 8px;border:1px solid var(--edge);border-radius:999px;margin-right:6px;cursor:pointer}
  .chip.active{border-color:var(--accent);color:var(--accent);font-weight:700}
  .filterline{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}

  /* Album overlay */
  .overlay{position:fixed;inset:0;background:#ffffffee;display:none;align-items:center;justify-content:center;z-index:9999}
  .overlay .box{max-width:980px;width:96%;max-height:90vh;overflow:auto}
  .album-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
  .album-grid img{width:100%;height:120px;object-fit:cover;border-radius:10px;border:1px solid #eee}

  /* Admin */
  .admin-only .sum-card{border:1px solid var(--edge);border-radius:12px;padding:12px;background:#fff}

  /* Field group borders */
  .fg{border:1px solid var(--edge);border-radius:12px;padding:12px;margin-bottom:12px;background:#fff}
  .fg h5{font-weight:800;font-size:1.02rem;margin-bottom:8px;color:#1c3d5a}

</style>
</head>
<body>
<div class="container-main">
  <img id="agora-logo-header" class="logo-header" src="" alt="Agora Logo" style="display:none;">
  <h1 class="text-center">Agora Vat Pre-Check</h1>

  <div class="navline">
    <button id="btn-form"  class="btn btn-tab btn-brand"  onclick="showTab('form')"><i class="bi bi-clipboard2-check"></i> Form</button>
    <button id="btn-flash" class="btn btn-tab btn-plain"  onclick="showTab('flash')"><i class="bi bi-grid"></i> Summary</button>
    <button id="btn-admin" class="btn btn-tab btn-plain"  onclick="showTab('admin')"><i class="bi bi-download"></i> Admin</button>
  </div>

  <!-- ====================== FORM ====================== -->
  <div id="pane-form" class="shell">
    <form id="vat-form" autocomplete="off">
      <!-- VATS (all first, as requested) -->
      <div class="fg">
        <h5>Vat Details</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Dairy Number</label>
            <input class="form-control" id="dairyNumber" name="dairyNumber" placeholder="e.g. 12345" required>
            <div class="note mt-1">Auto-loads existing record if found.</div>
          </div>
        </div>

        <!-- Vat 1 -->
        <div class="row g-2 mt-1">
          <div class="col-md-3">
            <label class="form-label">Vat 1 Capacity (L)</label>
            <input class="form-control" id="vat1-capacity" name="vat1-capacity" inputmode="numeric" placeholder="e.g. 18000">
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 1 Cap</label>
            <select class="form-select" id="vat1-cap" name="vat1-cap" onchange="togglePhotos('vat1-cap')">
              <option value="">Select…</option>
              <option value="available" selected>Available ✓</option>
              <option value="unavailable">Unavailable ✗</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Vat 1 Notes</label>
            <input class="form-control" id="vat1-comments" name="vat1-comments" placeholder="interior width, access, obstructions…">
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 1 Level</label>
            <select class="form-select" id="vat1-level" name="vat1-level">
              <option value="">Select…</option><option>Low</option><option>Medium</option><option>High</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 1 Condition</label>
            <select id="vat1-condition" name="vat1-condition" class="form-select" onchange="toggleVatCondition('vat1-condition')">
              <option value="">Select…</option>
              <option value="ok" selected>OK</option>
              <option value="attention">Attention Required</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 1 Serial</label>
            <input class="form-control" id="vat1-serial" name="vat1-serial" placeholder="serial number">
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 1 Cap Photo</label>
            <input type="file" id="vat1-cap-photo" class="form-control" accept="image/*" style="display:none" onchange="previewImage(event,'vat1-cap-preview')">
            <img id="vat1-cap-preview" class="image-preview">
          </div>
        </div>
        <div id="vat1-condition-extra" class="row g-2 mt-1" style="display:none">
          <div class="col-md-9"><input class="form-control" id="vat1-condition-comments" name="vat1-condition-comments" placeholder="Condition notes, corrosion, leaks, dents…"></div>
          <div class="col-md-3">
            <label class="form-label">Condition Photo</label>
            <input type="file" id="vat1-condition-photo" class="form-control" accept="image/*" onchange="previewImage(event,'vat1-condition-preview')">
            <img id="vat1-condition-preview" class="image-preview">
          </div>
        </div>

        <hr>

        <!-- Vat 2 (defaults to N/A everywhere) -->
        <div class="row g-2 mt-1">
          <div class="col-md-3">
            <label class="form-label">Vat 2 Capacity (L)</label>
            <input class="form-control" id="vat2-capacity" name="vat2-capacity" inputmode="numeric" placeholder="N/A if none" oninput="showVat2Serial()">
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 2 Cap</label>
            <select class="form-select" id="vat2-cap" name="vat2-cap" onchange="togglePhotos('vat2-cap')">
              <option value="">Select…</option>
              <option value="na" selected>N/A</option>
              <option value="available">Available ✓</option>
              <option value="unavailable">Unavailable ✗</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Vat 2 Notes</label>
            <input class="form-control" id="vat2-comments" name="vat2-comments" placeholder="interior width, access, obstructions…">
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 2 Level</label>
            <select class="form-select" id="vat2-level" name="vat2-level">
              <option value="">Select…</option>
              <option value="na" selected>N/A</option>
              <option>Low</option><option>Medium</option><option>High</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 2 Condition</label>
            <select id="vat2-condition" name="vat2-condition" class="form-select" onchange="toggleVatCondition('vat2-condition')">
              <option value="">Select…</option>
              <option value="na" selected>N/A</option>
              <option value="ok">OK</option>
              <option value="attention">Attention Required</option>
            </select>
          </div>
          <div class="col-md-3" id="vat2-serial-section" style="display:none">
            <label class="form-label">Vat 2 Serial</label>
            <input class="form-control" id="vat2-serial" name="vat2-serial" placeholder="serial number">
          </div>
          <div class="col-md-3">
            <label class="form-label">Vat 2 Cap Photo</label>
            <input type="file" id="vat2-cap-photo" class="form-control" accept="image/*" style="display:none" onchange="previewImage(event,'vat2-cap-preview')">
            <img id="vat2-cap-preview" class="image-preview">
          </div>
        </div>
        <div id="vat2-condition-extra" class="row g-2 mt-1" style="display:none">
          <div class="col-md-9"><input class="form-control" id="vat2-condition-comments" name="vat2-condition-comments" placeholder="Condition notes"></div>
          <div class="col-md-3">
            <label class="form-label">Condition Photo</label>
            <input type="file" id="vat2-condition-photo" class="form-control" accept="image/*" onchange="previewImage(event,'vat2-condition-preview')">
            <img id="vat2-condition-preview" class="image-preview">
          </div>
        </div>
      </div>

      <!-- AGITATOR -->
      <div class="fg">
        <h5>Agitator</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Sensor Location</label>
            <input class="form-control" id="agitator-location" name="agitator-location" placeholder="e.g. top left, external, grey halo…">
          </div>
          <div class="col-md-6">
            <label class="form-label">Notes</label>
            <input class="form-control" id="agitator-comments" name="agitator-comments" placeholder="mounting, cable path, obstructions…">
          </div>
          <div class="col-md-2">
            <label class="form-label">Photo</label>
            <input type="file" id="agitator-photo" class="form-control" accept="image/*" onchange="previewImage(event,'agitator-preview')">
            <img id="agitator-preview" class="image-preview">
          </div>
        </div>
      </div>

      <!-- GATEWAY -->
      <div class="fg">
        <h5>Gateway</h5>
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Gateway Location</label>
            <input class="form-control" id="gateway-location" name="gateway-location" placeholder="e.g. plant room, office, cabinet…">
          </div>
          <div class="col-md-4">
            <label class="form-label">Notes</label>
            <input class="form-control" id="gateway-comments" name="gateway-comments" placeholder="power, cellular RSSI, antenna position…">
          </div>
          <div class="col-md-2">
            <label class="form-label">Photo</label>
            <input type="file" id="gateway-photo" class="form-control" accept="image/*" onchange="previewImage(event,'gateway-preview')">
            <img id="gateway-preview" class="image-preview">
          </div>
        </div>
      </div>

      <!-- OTHER TELEMETRY -->
      <div class="fg">
        <h5>Other Telemetry</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Current Telemetry</label>
            <input class="form-control" id="current-telemetry" name="current-telemetry" placeholder="brand/system">
          </div>
          <div class="col-md-8">
            <label class="form-label">Notes</label>
            <input class="form-control" id="telemetry-comments" name="telemetry-comments" placeholder="integration, data access, retrofit constraints…">
          </div>
        </div>
      </div>

      <!-- RUBBERWARE -->
      <div class="fg">
        <h5>Rubberware</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Vat Door Seal</label>
            <select id="vat-door-seal" name="vat-door-seal" class="form-select" onchange="toggleVatDoorSeal()">
              <option value="notdelivered" selected>Not Delivered</option>
              <option value="delivered">Delivered</option>
            </select>
          </div>
          <div class="col-md-4 vat-door-sizes" style="display:none">
            <label class="form-label">Vat 1 Door Seal Size</label>
            <select id="vat1-door-seal-size" name="vat1-door-seal-size" class="form-select">
              <option value="">Select size…</option>
              <option value="small">Small</option><option value="large">Large</option>
            </select>
          </div>
          <div class="col-md-4 vat-door-sizes" style="display:none">
            <label class="form-label">Vat 2 Door Seal Size</label>
            <select id="vat2-door-seal-size" name="vat2-door-seal-size" class="form-select">
              <option value="">Select size…</option>
              <option value="small">Small</option><option value="large">Large</option>
            </select>
          </div>
          <div class="col-md-8" id="vat-door-seal-extra" style="display:none">
            <input class="form-control mt-1" id="vat-door-seal-comments" name="vat-door-seal-comments" placeholder="Notes (delivery, fit, spares…)">
          </div>
          <div class="col-md-4" id="vat-door-photo-wrap" style="display:none">
            <label class="form-label">Door Seal Photo</label>
            <input type="file" id="vat-door-seal-photo" class="form-control" accept="image/*" onchange="previewImage(event,'vat-door-seal-preview')">
            <img id="vat-door-seal-preview" class="image-preview">
          </div>
        </div>

        <div class="row g-2 mt-1">
          <div class="col-md-4">
            <label class="form-label">RJT Step Seal</label>
            <select id="rjt-seal" name="rjt-seal" class="form-select" onchange="toggleRjtSeal()">
              <option value="notdelivered" selected>Not Delivered</option>
              <option value="delivered">Delivered</option>
            </select>
          </div>
          <div class="col-md-4" id="rjt-size-wrap" style="display:none">
            <label class="form-label">RJT Size</label>
            <select id="rjt-seal-size" name="rjt-seal-size" class="form-select">
              <option value="">Select size…</option>
              <option value="small">Small</option><option value="large">Large</option>
            </select>
          </div>
          <div class="col-md-4" id="rjt-photo-wrap" style="display:none">
            <label class="form-label">RJT Photo</label>
            <input type="file" id="rjt-seal-photo" class="form-control" accept="image/*" onchange="previewImage(event,'rjt-seal-preview')">
            <img id="rjt-seal-preview" class="image-preview">
          </div>
        </div>

        <div class="row g-2 mt-1">
          <div class="col-md-4">
            <label class="form-label">Chiller Condition</label>
            <select id="chiller-condition" name="chiller-condition" class="form-select" onchange="toggleChillerCondition()">
              <option value="ok" selected>OK</option>
              <option value="attention">Attention Required</option>
            </select>
          </div>
          <div class="col-md-6" id="chiller-condition-extra" style="display:none">
            <input class="form-control mt-1" id="chiller-condition-comments" name="chiller-condition-comments" placeholder="Notes (heat-exchange, leaks, noisy, trips…)">
          </div>
          <div class="col-md-2" id="chiller-photo-wrap" style="display:none">
            <label class="form-label">Chiller Photo</label>
            <input type="file" id="chiller-condition-photo" class="form-control" accept="image/*" onchange="previewImage(event,'chiller-condition-preview')">
            <img id="chiller-condition-preview" class="image-preview">
          </div>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-success" onclick="saveForm()">Save</button>
        <button type="button" class="btn btn-secondary" onclick="generatePDF()">Generate PDF</button>
        <button type="button" class="btn btn-warning" onclick="showTab('flash')">View Summary</button>
      </div>
      <div id="form-msg" class="mt-2 text-danger" style="min-height:22px"></div>
    </form>
  </div>

  <!-- ====================== FLASH SUMMARY ====================== -->
  <div id="pane-flash" class="shell hidden">
    <div id="flash-summary"></div>
    <div class="filterline">
      <span class="chip active" data-range="all" onclick="setRange(this)">All</span>
      <span class="chip" data-range="30" onclick="setRange(this)">30d</span>
      <span class="chip" data-range="90" onclick="setRange(this)">90d</span>
      <input class="form-control" id="search-box" placeholder="Search Dairy # / text…" style="max-width:260px">
      <button class="btn btn-sm btn-outline-secondary" onclick="refreshFlash()">Apply</button>
    </div>
    <div class="kpi-grid mb-2" id="kpi-box"></div>
    <div id="banner" class="mb-2"></div>
    <div class="cards" id="cards"></div>
  </div>

  <!-- ====================== ADMIN (download only) ====================== -->
  <div id="pane-admin" class="shell hidden admin-only">
    <div class="sum-card mb-3">
      <div class="d-flex align-items-center justify-content-between">
        <div><b>Downloads</b> <span class="note">Export current cloud/cache set</span></div>
        <div>
          <button class="btn btn-sm btn-primary" onclick="exportCSV()">CSV</button>
          <button class="btn btn-sm btn-primary" onclick="exportXLSX()">XLSX</button>
        </div>
      </div>
    </div>
    <div class="sum-card">
      <div class="note">Admin page only contains downloads, per your requirement.</div>
    </div>
  </div>
</div>

<!-- Album overlay -->
<div class="overlay" id="overlay">
  <div class="box shell">
    <div class="d-flex justify-content-between align-items-center">
      <div id="album-title" class="fw-bold"></div>
      <button class="btn btn-sm btn-outline-secondary" onclick="hideOverlay()">Close</button>
    </div>
    <div class="album-grid mt-2" id="album-grid"></div>
  </div>
</div>

<!-- Libs -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* ================== CONFIG ================== */
const STORAGE_FOLDER = 'Pre Check';
const firebaseConfig = {
  apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain: "dairy-farm-record-system.firebaseapp.com",
  projectId: "dairy-farm-record-system",
  storageBucket: "dairy-farm-record-system.appspot.com",
  messagingSenderId: "422124188212",
  appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

// Dexie cache
const db = new Dexie('VatPreCheck');
db.version(1).stores({ forms: '++id,dairyNumber,timestamp' });

/* ================== LOGO ================== */
let logoBase64 = "", logoAspect=1;
(async function loadLogo() {
  try{
    const logoRef = storage.ref("Agora Logo/2F6-1YdaEP.jpeg");
    const url = await logoRef.getDownloadURL();
    const img = document.getElementById("agora-logo-header");
    img.src = url; img.style.display = 'block';
    const res = await fetch(url); const blob = await res.blob();
    const reader = new FileReader();
    reader.onload = (e)=>{
      logoBase64 = e.target.result;
      const tmp = new Image();
      tmp.onload = ()=>{logoAspect = tmp.width/tmp.height};
      tmp.src = logoBase64;
    };
    reader.readAsDataURL(blob);
  }catch{}
})();

/* ================== UTILS ================== */
const byId = id => document.getElementById(id);
function previewImage(e, id){
  const img = byId(id);
  const file = e.target.files[0];
  if(!file) return;
  img.src = URL.createObjectURL(file);
  img.style.display = 'block';
  img.setAttribute('data-base64','');
  const reader = new FileReader();
  reader.onload = ev => img.setAttribute('data-base64', ev.target.result);
  reader.readAsDataURL(file);
}
function showVat2Serial(){
  const has2 = (byId('vat2-capacity').value||'').trim().length>0;
  byId('vat2-serial-section').style.display = has2 ? '' : 'none';
}
function togglePhotos(id){
  const v = byId(id).value;
  const input = byId(id+'-photo');
  const prev  = byId(id+'-preview');
  if(!input || !prev) return;
  const show = (v==='unavailable');
  input.style.display = show? 'block':'none';
  if(!show){ prev.style.display='none'; prev.removeAttribute('data-base64'); input.value=''; }
}
function toggleVatCondition(which){
  const sel = byId(which);
  const extra = byId(which+'-extra');
  extra.style.display = (sel.value==='attention') ? 'flex' : 'none';
}
function toggleChillerCondition(){
  const sel = byId('chiller-condition');
  const extra = byId('chiller-condition-extra');
  const photo = byId('chiller-photo-wrap');
  const on = (sel.value==='attention');
  extra.style.display = on? '' : 'none';
  photo.style.display = on? '' : 'none';
}
function toggleVatDoorSeal(){
  const sel = byId('vat-door-seal').value;
  const xs = document.querySelectorAll('.vat-door-sizes');
  xs.forEach(x=>x.style.display = (sel==='delivered')? '' : 'none');
  byId('vat-door-seal-extra').style.display = (sel==='delivered')? '' : 'none';
  byId('vat-door-photo-wrap').style.display = (sel==='delivered')? '' : 'none';
}
function toggleRjtSeal(){
  const sel = byId('rjt-seal').value;
  byId('rjt-size-wrap').style.display = (sel==='delivered')? '' : 'none';
  byId('rjt-photo-wrap').style.display = (sel==='delivered')? '' : 'none';
}
function ensureVat2Defaults(){
  const v2Cap  = byId('vat2-cap');
  const v2Cond = byId('vat2-condition');
  const v2Lvl  = byId('vat2-level');
  if(!v2Cap.value)  v2Cap.value='na';
  if(!v2Cond.value) v2Cond.value='na';
  if(!v2Lvl.value)  v2Lvl.value='na';
}
function showTab(which){
  ['pane-form','pane-flash','pane-admin'].forEach(id=>byId(id).classList.add('hidden'));
  ['btn-form','btn-flash','btn-admin'].forEach(id=>{byId(id).classList.remove('btn-brand'); byId(id).classList.add('btn-plain')});
  if(which==='form'){ byId('pane-form').classList.remove('hidden'); byId('btn-form').classList.add('btn-brand'); byId('btn-form').classList.remove('btn-plain'); }
  if(which==='flash'){ byId('pane-flash').classList.remove('hidden'); byId('btn-flash').classList.add('btn-brand'); byId('btn-flash').classList.remove('btn-plain'); refreshFlash(); }
  if(which==='admin'){ byId('pane-admin').classList.remove('hidden'); byId('btn-admin').classList.add('btn-brand'); byId('btn-admin').classList.remove('btn-plain'); }
}

/* ================== STORAGE HELPERS ================== */
async function cloudGet(dairy){
  try{
    const ref = storage.ref(`${STORAGE_FOLDER}/${dairy}.json`);
    const url = await ref.getDownloadURL();
    return await (await fetch(url)).json();
  }catch{return null}
}
async function cloudPut(rec){
  const ref = storage.ref(`${STORAGE_FOLDER}/${rec.dairyNumber}.json`);
  await ref.put(new Blob([JSON.stringify(rec)], {type:'application/json'}));
}
async function cloudListAll(){
  const warn = (msg)=>{
    const el = byId('flash-summary');
    if(el) el.innerHTML = `<div class="alert alert-warning py-2 my-2">${msg}</div>` + (el.innerHTML||'');
  };
  let fromCloud=[];
  try{
    const ref = storage.ref(STORAGE_FOLDER);
    const res = await ref.listAll();
    for(const it of res.items){
      if(!it.name.endsWith('.json')) continue;
      try{
        const url = await it.getDownloadURL();
        const j = await (await fetch(url)).json();
        if(j?.dairyNumber){
          fromCloud.push(j);
          await db.forms.put({dairyNumber:j.dairyNumber, ...j});
        }
      }catch{}
    }
  }catch{ warn('Could not list cloud records — showing cached/offline data instead.'); }
  if(!fromCloud.length){
    return await db.forms.toArray();
  }
  // de-dupe by newest timestamp
  const map={};
  fromCloud.forEach(r=>{
    const k=r.dairyNumber; if(!k) return;
    if(!map[k] || (r.timestamp||0)>(map[k].timestamp||0)) map[k]=r;
  });
  return Object.values(map);
}

/* ================== FORM SAVE / LOAD ================== */
function collectForm(){
  const names = [
    'dairyNumber',
    'vat1-capacity','vat2-capacity',
    'vat1-cap','vat2-cap',
    'vat1-comments','vat2-comments',
    'vat1-level','vat2-level',
    'vat1-condition','vat2-condition',
    'vat1-condition-comments','vat2-condition-comments',
    'vat1-serial','vat2-serial',
    'agitator-location','agitator-comments',
    'gateway-location','gateway-comments',
    'current-telemetry','telemetry-comments',
    'vat-door-seal','vat1-door-seal-size','vat2-door-seal-size',
    'rjt-seal','rjt-seal-size',
    'chiller-condition','chiller-condition-comments'
  ];
  const rec={}; names.forEach(n=>{ const el=document.querySelector(`[name="${n}"]`)||byId(n); rec[n]=el?el.value:'' });
  // default Vat 2 triplets to N/A
  if(!rec['vat2-cap']) rec['vat2-cap']='na';
  if(!rec['vat2-condition']) rec['vat2-condition']='na';
  if(!rec['vat2-level']) rec['vat2-level']='na';
  // photos
  ['vat1-cap','vat2-cap','vat1-condition','vat2-condition','agitator','gateway','vat-door-seal','rjt-seal','chiller-condition'].forEach(p=>{
    const img=byId(`${p}-preview`);
    if(img?.getAttribute('data-base64')) rec[`${p}-photo-base64`]=img.getAttribute('data-base64');
  });
  rec.timestamp=Date.now();
  return rec;
}
async function saveForm(){
  const dn=(byId('dairyNumber').value||'').trim();
  if(!dn){ byId('form-msg').textContent='Dairy Number required.'; return; }
  const rec=collectForm();
  await db.forms.put({dairyNumber:dn, ...rec});
  try{ await cloudPut(rec); byId('form-msg').textContent='Saved ✓'; }
  catch{ byId('form-msg').textContent='Saved to device cache. Cloud upload failed (will not block usage).'; }
}
async function loadIntoForm(dn){
  let rec = await db.forms.where('dairyNumber').equals(dn).first();
  if(!rec) rec = await cloudGet(dn);
  if(!rec) return false;
  Object.keys(rec).forEach(k=>{
    const el = document.querySelector(`[name="${k}"]`) || byId(k);
    if(el) el.value = rec[k];
  });
  showVat2Serial();
  ensureVat2Defaults();
  // show conditional sections based on loaded values
  toggleVatCondition('vat1-condition');
  toggleVatCondition('vat2-condition');
  toggleVatDoorSeal();
  toggleRjtSeal();
  toggleChillerCondition();
  return true;
}
byId('dairyNumber').addEventListener('blur', async function(){
  const ok = await loadIntoForm(this.value.trim());
  if(!ok) { ensureVat2Defaults(); }
});

/* ================== AI-ish NORMALISER ================== */
/* Maps messy field text into clean features/badges for summary cards */
function normaliseLingo(s){
  const txt=(s||'').toLowerCase();

  const flags={
    needsPowerPoint: /power ?point|ppt|powerpoint/.test(txt),
    hasReducingCap: /(reducing cap|reducer|reduction cap)/.test(txt),
    capUnavailable: /(cap.*unavail|no cap|missing cap)/.test(txt),
    greySensor: /(grey|gray)\s*(sensor|halo|ring|cap)/.test(txt),
    dtsMention: /\bdts\b|digital temp|data temp/.test(txt),
    accessTight: /(tight|narrow|limited) (access|space)|cramped|hard to reach/.test(txt),
    cablePathOk: /(cable|conduit|run).*(ok|good|clear)/.test(txt),
    gatewaySignalPoor: /(rssi|signal|coverage).*(poor|weak|bad|1\/5|2\/5)/.test(txt),
    chillerIssue: /(chiller|glycol|cool).*(leak|noise|trip|fault|slow|warm)/.test(txt)
  };
  const notes=[];
  if(flags.needsPowerPoint) notes.push('Needs PowerPoint');
  if(flags.hasReducingCap)  notes.push('Reducing cap present');
  if(flags.capUnavailable)  notes.push('Cap unavailable');
  if(flags.greySensor)      notes.push('Grey/Gray sensor/halo');
  if(flags.dtsMention)      notes.push('DTS mentioned');
  if(flags.accessTight)     notes.push('Tight access');
  if(flags.cablePathOk)     notes.push('Cable path OK');
  if(flags.gatewaySignalPoor) notes.push('Gateway signal poor');
  if(flags.chillerIssue)      notes.push('Chiller issue');

  return {flags, notes};
}

/* Derive per-farm metrics & badges from a record */
function deriveMetrics(rec){
  const t = [
    rec['vat1-comments'], rec['vat2-comments'], rec['agitator-comments'],
    rec['gateway-comments'], rec['telemetry-comments']
  ].filter(Boolean).join(' • ');

  const {flags, notes} = normaliseLingo(t);

  const vatCount = (rec['vat2-capacity'] && rec['vat2-capacity'].trim()) ? 2 : 1;
  const doorDelivered = (rec['vat-door-seal']==='delivered');
  const doorDeliveredCount = doorDelivered ? vatCount : 0; // 2 for two vats, 1 for single
  const doorSizes = [rec['vat1-door-seal-size']||'', rec['vat2-door-seal-size']||''].filter(Boolean);

  const a = {
    dairy: rec.dairyNumber,
    vat1Cap: rec['vat1-cap'],
    vat2Cap: rec['vat2-cap'],
    capAttention: (rec['vat1-cap']==='unavailable') || (rec['vat2-cap']==='unavailable'),
    vat1Cond: rec['vat1-condition'] || 'ok',
    vat2Cond: rec['vat2-condition'] || 'na',
    condAttention: (rec['vat1-condition']==='attention') || (rec['vat2-condition']==='attention'),
    chillerAttention: (rec['chiller-condition']==='attention'),
    doorDeliveredCount,
    doorSizes,
    rjtDelivered: (rec['rjt-seal']==='delivered'),
    rjtSize: rec['rjt-seal-size']||'',
    needsPowerPoint: flags.needsPowerPoint,
    hasReducingCap: flags.hasReducingCap,
    greySensor: flags.greySensor,
    dtsMention: flags.dtsMention,
    gatewaySignalPoor: flags.gatewaySignalPoor,
    notes
  };
  return a;
}

/* ================== FLASH SUMMARY ================== */
let rangeSel='all';
function setRange(el){
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active'); rangeSel=el.dataset.range||'all';
}
function inRange(ts){
  if(rangeSel==='all') return true;
  const days=+rangeSel; const now=Date.now();
  return (now - (ts||now)) <= days*86400000;
}

async function refreshFlash(){
  byId('flash-summary').innerHTML = '';
  const search=(byId('search-box').value||'').trim().toLowerCase();

  const recs = await cloudListAll();
  const records = recs.filter(r=>inRange(r.timestamp||Date.now()))
    .filter(r=>{
      if(!search) return true;
      const blob = JSON.stringify(r).toLowerCase();
      return blob.includes(search);
    })
    .sort((a,b)=>String(a.dairyNumber).localeCompare(String(b.dairyNumber)));

  if(!records.length){
    byId('kpi-box').innerHTML='';
    byId('cards').innerHTML = `
      <div class="card-farm"><div class="cf-body">No records found. Save a form first, or verify your Firebase folder name (“${STORAGE_FOLDER}”).</div></div>`;
    return;
  }

  // KPIs
  let k_total = records.length;
  let k_capsUnavailable = records.filter(r=> (r['vat1-cap']==='unavailable') || (r['vat2-cap']==='unavailable')).length;
  let k_condAttention = records.filter(r=> (r['vat1-condition']==='attention') || (r['vat2-condition']==='attention')).length;
  let k_chillerAttention = records.filter(r=> (r['chiller-condition']==='attention')).length;
  let k_doorDelivered = records.reduce((n,r)=> n + ( (r['vat-door-seal']==='delivered') ? ((r['vat2-capacity']||'').trim()?2:1) : 0 ), 0);
  let k_rjtDelivered = records.filter(r=>r['rjt-seal']==='delivered').length;

  byId('kpi-box').innerHTML = `
    <div class="kpi"><div class="num">${k_total}</div><div class="lab">Farms</div></div>
    <div class="kpi"><div class="num">${k_capsUnavailable}</div><div class="lab">Cap Unavailable</div></div>
    <div class="kpi"><div class="num">${k_condAttention}</div><div class="lab">Vat Attention</div></div>
    <div class="kpi"><div class="num">${k_chillerAttention}</div><div class="lab">Chiller Attention</div></div>
    <div class="kpi"><div class="num">${k_doorDelivered}</div><div class="lab">Door Seals Delivered</div></div>
    <div class="kpi"><div class="num">${k_rjtDelivered}</div><div class="lab">RJT Delivered</div></div>
  `;

  // Cards
  const wrap = byId('cards'); wrap.innerHTML='';
  const albums = {}; // per dairy photos
  records.forEach(r=>{
    const m = deriveMetrics(r);
    // Pull some photo thumbs
    const pics = [];
    ['vat1-cap','vat2-cap','vat1-condition','vat2-condition','agitator','gateway','vat-door-seal','rjt-seal','chiller-condition'].forEach(k=>{
      const b64 = r[`${k}-photo-base64`]; if(b64) pics.push(b64);
    });
    if(pics.length){ albums[r.dairyNumber]=pics.slice(); }

    const badges = [];
    if(m.capAttention) badges.push(`<span class="badge-soft bad-bad">Cap Attention</span>`);
    if(m.condAttention) badges.push(`<span class="badge-soft bad-warn">Vat Attention</span>`);
    if(m.chillerAttention) badges.push(`<span class="badge-soft bad-warn">Chiller</span>`);
    if(m.needsPowerPoint) badges.push(`<span class="badge-soft">PowerPoint</span>`);
    if(m.hasReducingCap) badges.push(`<span class="badge-soft">Reducing Cap</span>`);
    if(m.greySensor) badges.push(`<span class="badge-soft">Grey Sensor/Halo</span>`);
    if(m.dtsMention) badges.push(`<span class="badge-soft">DTS</span>`);
    if(m.gatewaySignalPoor) badges.push(`<span class="badge-soft bad-bad">Weak Signal</span>`);

    const quick = [
      r['vat1-capacity']?`Vat1 ${r['vat1-capacity']}L`:'Vat1',
      r['vat2-capacity']?`Vat2 ${r['vat2-capacity']}L`:'Vat2 N/A',
      `Cap1: ${r['vat1-cap']||'-'}`, `Cap2: ${r['vat2-cap']||'na'}`,
      `Cond1: ${r['vat1-condition']||'ok'}`, `Cond2: ${r['vat2-condition']||'na'}`
    ].join(' • ');

    const photoHTML = pics.slice(0,4).map(p=>`<img src="${p}">`).join('');
    const doorSizes = m.doorSizes.length ? `Door sizes: ${m.doorSizes.join(', ')}` : '';

    const card = document.createElement('div');
    card.className='card-farm';
    card.innerHTML = `
      <div class="cf-head">
        <div>
          <div class="cf-title">#${m.dairy}</div>
          <div class="note">${quick}</div>
        </div>
        <div>${badges.join(' ')}</div>
      </div>
      <div class="cf-body mt-1">
        ${doorSizes?`<div class="mb-1"><i class="bi bi-bag"></i> ${doorSizes} (${m.doorDeliveredCount} delivered)</div>`:''}
        ${m.notes.length? `<div class="mb-1"><i class="bi bi-info-circle"></i> ${m.notes.join(' • ')}</div>`:''}
        ${pics.length? `<div class="cf-photos mt-2">${photoHTML} ${pics.length>4? `<a href="#" onclick="openAlbum('${m.dairy}');return false;">+${pics.length-4}</a>`:''}</div>`:''}
        <div class="mt-2">
          <button class="btn btn-sm btn-outline-secondary" onclick="openForm('${m.dairy}')">Open</button>
          ${pics.length? `<button class="btn btn-sm btn-outline-secondary" onclick="openAlbum('${m.dairy}')">Album</button>`:''}
          <button class="btn btn-sm btn-outline-secondary" onclick="singlePDF('${m.dairy}')">PDF</button>
        </div>
      </div>`;
    wrap.appendChild(card);
  });
  window._albums = albums;
}

function openForm(dairy){
  showTab('form');
  byId('dairyNumber').value = dairy;
  loadIntoForm(dairy);
}

function openAlbum(dairy){
  const imgs = (window._albums||{})[dairy]||[];
  byId('album-title').textContent = `Dairy #${dairy} — ${imgs.length} photos`;
  const grid = byId('album-grid');
  grid.innerHTML = imgs.map(b=>`<a href="${b}" target="_blank"><img src="${b}"></a>`).join('');
  byId('overlay').style.display='flex';
}
function hideOverlay(){ byId('overlay').style.display='none'; }

/* ================== PDF ================== */
async function singlePDF(dairy){
  const rec = await db.forms.where('dairyNumber').equals(dairy).first() || await cloudGet(dairy);
  if(!rec) return alert('No record found.');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l','pt','a4');
  let curY = 40;
  if(logoBase64){
    const w = pdf.internal.pageSize.getWidth();
    const H = 80, W = logoAspect*H;
    pdf.addImage(logoBase64,'JPEG',(w-W)/2,20,W,H); curY=110;
  }
  pdf.setFontSize(16); pdf.text(`Vat Pre-Check — Dairy #${dairy}`, 40, curY); curY+=14;

  const entries = Object.entries(rec).filter(([k])=>!k.endsWith('base64') && !['timestamp','id'].includes(k));
  const table = entries.map(([k,v])=>[k,v]);
  pdf.autoTable({startY:curY+10, head:[['Field','Value']], body:table, styles:{fontSize:9,cellPadding:4}, headStyles:{fillColor:[167,171,1],textColor:255}});
  let y = pdf.lastAutoTable.finalY + 10;
  const photos = Object.keys(rec).filter(k=>k.endsWith('photo-base64'));
  for(const key of photos){
    const lbl = key.replace('-photo-base64','').replace(/-/g,' ').toUpperCase();
    if(y+170>580){ pdf.addPage(); y=60; }
    pdf.setFontSize(12); pdf.text(lbl, 40, y+20);
    pdf.addImage(rec[key],'JPEG',40,y+28,420,140);
    y+=170;
  }
  pdf.save(`VatPreCheck_${dairy}.pdf`);
}
async function generatePDF(){ // from current form
  await saveForm();
  await singlePDF(byId('dairyNumber').value||'');
}

/* ================== EXPORTS (Admin) ================== */
function flatten(rec){
  return {
    DairyNumber: rec.dairyNumber||'',
    Vat1Capacity: rec['vat1-capacity']||'',
    Vat1Cap: rec['vat1-cap']||'',
    Vat1Level: rec['vat1-level']||'',
    Vat1Condition: rec['vat1-condition']||'',
    Vat1Serial: rec['vat1-serial']||'',
    Vat1Notes: rec['vat1-comments']||'',
    Vat2Capacity: rec['vat2-capacity']||'',
    Vat2Cap: rec['vat2-cap']||'na',
    Vat2Level: rec['vat2-level']||'na',
    Vat2Condition: rec['vat2-condition']||'na',
    Vat2Serial: rec['vat2-serial']||'',
    Vat2Notes: rec['vat2-comments']||'',
    AgitatorLocation: rec['agitator-location']||'',
    AgitatorNotes: rec['agitator-comments']||'',
    GatewayLocation: rec['gateway-location']||'',
    GatewayNotes: rec['gateway-comments']||'',
    CurrentTelemetry: rec['current-telemetry']||'',
    TelemetryNotes: rec['telemetry-comments']||'',
    VatDoorSeal: rec['vat-door-seal']||'notdelivered',
    Vat1DoorSealSize: rec['vat1-door-seal-size']||'',
    Vat2DoorSealSize: rec['vat2-door-seal-size']||'',
    RJTSeal: rec['rjt-seal']||'notdelivered',
    RJTSealSize: rec['rjt-seal-size']||'',
    ChillerCondition: rec['chiller-condition']||'ok',
    ChillerNotes: rec['chiller-condition-comments']||'',
    Timestamp: rec.timestamp||''
  };
}
async function getAllFlat(){
  const recs = await cloudListAll();
  // Prefer latest per dairy
  const map={};
  recs.forEach(r=>{
    const k=r.dairyNumber;
    if(!map[k] || (r.timestamp||0)>(map[k].timestamp||0)) map[k]=r;
  });
  return Object.values(map).map(flatten).sort((a,b)=>String(a.DairyNumber).localeCompare(String(b.DairyNumber)));
}
async function exportCSV(){
  const rows = await getAllFlat();
  if(!rows.length) return alert('No data to export.');
  const headers = Object.keys(rows[0]);
  const quote=v => `"${String(v??'').replace(/"/g,'""')}"`;
  const csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>quote(r[h])).join(','))).join('\r\n');
  const blob = new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='vat_precheck_export.csv';
  document.body.appendChild(a); a.click();
  setTimeout(()=>{a.remove(); URL.revokeObjectURL(url);}, 500);
}
async function exportXLSX(){
  const rows = await getAllFlat();
  if(!rows.length) return alert('No data to export.');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "VatPreCheck");
  XLSX.writeFile(wb, 'vat_precheck_export.xlsx');
}

/* ================== INIT ================== */
document.addEventListener('DOMContentLoaded', ()=>{
  ensureVat2Defaults();
  showTab('form');
  // show/hide Admin button via query (?admin=1)
  const url = new URL(window.location.href);
  const isAdmin = url.searchParams.get('admin')==='1';
  document.getElementById('btn-admin').style.display = isAdmin? '' : 'none';
});
</script>
</body>
</html>