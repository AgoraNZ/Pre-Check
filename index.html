<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Agora Vat Pre-Check</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">

<style>
:root{
  --brand:#001F3F; --accent:#FF851B; --muted:#6b7280; --bg:#f7f8fb; --ink:#0f172a; --radius:14px;
}
html,body{background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
.app{max-width:1100px;margin:28px auto;padding:0 16px}
.brand-header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
.brand-logo{width:160px;height:auto;display:none}
.brand-title{flex:1}
.brand-title h1{margin:0;font-weight:800;color:var(--brand);letter-spacing:.2px}
.brand-sub{color:var(--muted);font-size:.95rem;margin-top:2px}
.top-tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 18px}
.tab-btn{border:1px solid #e5e7eb;background:#fff;color:#111827;border-radius:10px;padding:10px 14px;font-weight:600}
.tab-btn.active{border-color:var(--accent);box-shadow:0 0 0 3px #ff851b2b}
.bar{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin:10px 0}
.section-title{font-size:1.05rem;font-weight:800;color:#111827;margin-bottom:8px}
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px}
.kpi .num{font-size:1.4rem;font-weight:800}
.kpi .label{color:#6b7280;font-size:.9rem}
.list{display:grid;grid-template-columns:1fr;gap:10px}
.row-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px}
.row-flex{display:flex;gap:10px;justify-content:space-between;align-items:center}
.small{color:#6b7280}
.actions .btn{margin-left:6px}
.badge-soft{border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:.8rem}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.progress{height:10px}
.hidden{display:none!important}

/* Brochure sheet */
.print-sheet{max-width:900px;margin:0 auto;color:#0f172a}
.print-head{display:flex;align-items:center;gap:16px;border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:10px}
.print-head img{height:44px}
.print-title{font-weight:800;font-size:1.2rem}
.print-sub{color:#6b7280}
.print-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.print-card{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.print-label{font-weight:700;margin-bottom:6px}
.print-photos img{width:100%;max-height:180px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;margin-bottom:8px}

/* Form */
.form-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin-bottom:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:900px){ .grid-3{grid-template-columns:1fr} }
.photo-thumb{width:110px;height:86px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;margin-top:6px}
.sticky-actions{position:sticky;bottom:8px;display:flex;gap:8px;flex-wrap:wrap}
.btn-brand{background:var(--accent);border:none;color:#fff;font-weight:700}
.btn-brand:hover{background:#ff6d00}
.btn-outline-brand{border:1px solid var(--accent);color:var(--accent);background:#fff}
.btn-outline-brand:hover{background:var(--accent);color:#fff}
.footer{color:#6b7280;text-align:center;margin:22px 0 10px}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="brand-header">
    <img id="logo" class="brand-logo" alt="Agora Logo">
    <div class="brand-title">
      <h1>Agora Vat Pre-Check</h1>
      <div class="brand-sub">Fast field capture • Smart summary • Customer-ready output</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="top-tabs">
    <button id="tab-form" class="tab-btn">Form</button>
    <button id="tab-summary" class="tab-btn active">Summary</button>
    <button id="tab-admin" class="tab-btn">Admin</button>
    <div class="ms-auto controls">
      <span class="small">Cloud:</span> <span id="cloud-count">–</span>
      <span class="small">Loaded:</span> <span id="loaded-count">0</span>
      <div class="progress" style="width:160px"><div id="load-bar" class="progress-bar" role="progressbar" style="width:0%"></div></div>
      <span id="load-pct" class="small">0%</span>
    </div>
  </div>

  <!-- SUMMARY -->
  <div id="view-summary">
    <div class="bar">
      <div class="controls mb-2">
        <input id="search" class="form-control" placeholder="Search dairy # or text…" style="max-width:360px">
        <button id="btn-clear" class="btn btn-outline-secondary btn-sm">Clear</button>
      </div>
      <div class="section-title">Overview</div>
      <div class="kpi-grid">
        <div class="kpi"><div class="num" id="kpi-dts">0</div><div class="label">DTS Vent Caps</div></div>
        <div class="kpi"><div class="num" id="kpi-power">0</div><div class="label">Farms needing power point</div></div>
        <div class="kpi"><div class="num" id="kpi-rubber">0</div><div class="label">Rubberware deliveries</div></div>
      </div>
    </div>

    <div class="bar">
      <div class="section-title">Vat Size Breakdown (live from cloud)</div>
      <div id="size-table" class="small">Starting…</div>
      <button id="btn-export-sizes" class="btn btn-outline-brand mt-2">Export Sizes CSV</button>
    </div>

    <div class="bar">
      <div class="section-title">Results</div>
      <div class="mb-2">
        <button id="btn-print-all" class="btn btn-brand">Print All Brochures</button>
        <button id="btn-zip-all" class="btn btn-outline-brand">Download All Brochures (ZIP)</button>
      </div>
      <div id="result-list" class="list"></div>
    </div>
  </div>

  <!-- FORM -->
  <div id="view-form" class="hidden">
    <div class="form-card">
      <div class="grid-3">
        <div>
          <label class="form-label">Dairy Number</label>
          <input class="form-control" id="dairyNumber" placeholder="e.g. 7016">
          <div class="small">Blur to auto-fill from cloud if available.</div>
        </div>
        <div>
          <label class="form-label">Gateway Location</label>
          <input class="form-control" id="gateway-location">
        </div>
        <div>
          <label class="form-label">Gateway Photo</label>
          <input type="file" accept="image/*" id="gateway-photo" class="form-control">
          <img id="gateway-preview" class="photo-thumb d-none" alt="">
        </div>
      </div>
    </div>

    <div class="form-card">
      <h6>Vat 1</h6>
      <div class="grid-3">
        <div><label class="form-label">Capacity (L)</label><input id="vat1-capacity" class="form-control"></div>
        <div><label class="form-label">Cap</label><select id="vat1-cap" class="form-select"><option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option></select></div>
        <div><label class="form-label">Cap Photo</label><input id="vat1-cap-photo" type="file" accept="image/*" class="form-control"><img id="vat1-cap-preview" class="photo-thumb d-none" alt=""></div>
        <div><label class="form-label">Serial</label><input id="vat1-serial" class="form-control"></div>
        <div><label class="form-label">Condition</label><select id="vat1-condition" class="form-select"><option value="ok">OK</option><option value="attention">Attention required</option></select></div>
        <div><label class="form-label">Condition note</label><input id="vat1-condition-comments" class="form-control"></div>
        <div><label class="form-label">Notes</label><input id="vat1-comments" class="form-control"></div>
        <div><label class="form-label">Agitator Location</label><input id="agitator1-location" class="form-control"></div>
        <div><label class="form-label">Agitator Photo</label><input id="agitator1-photo" type="file" accept="image/*" class="form-control"><img id="agitator1-preview" class="photo-thumb d-none" alt=""></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Vat 2 (enter capacity to enable)</h6>
      <div class="grid-3">
        <div><label class="form-label">Capacity (L)</label><input id="vat2-capacity" class="form-control"></div>
        <div><label class="form-label">Cap</label><select id="vat2-cap" class="form-select"><option value="na">N/A</option><option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option></select></div>
        <div><label class="form-label">Cap Photo</label><input id="vat2-cap-photo" type="file" accept="image/*" class="form-control"><img id="vat2-cap-preview" class="photo-thumb d-none" alt=""></div>
        <div><label class="form-label">Serial</label><input id="vat2-serial" class="form-control"></div>
        <div><label class="form-label">Condition</label><select id="vat2-condition" class="form-select"><option value="ok">OK</option><option value="attention">Attention required</option></select></div>
        <div><label class="form-label">Condition note</label><input id="vat2-condition-comments" class="form-control"></div>
        <div><label class="form-label">Notes</label><input id="vat2-comments" class="form-control"></div>
        <div><label class="form-label">Agitator Location</label><input id="agitator2-location" class="form-control"></div>
        <div><label class="form-label">Agitator Photo</label><input id="agitator2-photo" type="file" accept="image/*" class="form-control"><img id="agitator2-preview" class="photo-thumb d-none" alt=""></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Mobile Signal</h6>
      <div class="grid-3">
        <div><label class="form-label">Spark (bars)</label><input id="spark-bars" class="form-control"></div>
        <div><label class="form-label">Spark note</label><input id="spark-note" class="form-control"></div>
        <div><label class="form-label">One NZ (bars)</label><input id="one-bars" class="form-control"></div>
        <div><label class="form-label">One NZ note</label><input id="one-note" class="form-control"></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Other Telemetry</h6>
      <div class="grid-3">
        <div><label class="form-label">Brand</label><input id="other-brand" class="form-control"></div>
        <div><label class="form-label">Type</label><input id="other-type" class="form-control" placeholder="vat, water, fuel…"></div>
        <div><label class="form-label">Notes</label><input id="other-notes" class="form-control"></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Rubberware</h6>
      <div class="grid-3">
        <div><label class="form-label">Door Seal delivered?</label><select id="door-delivered" class="form-select"><option value="no">No</option><option value="yes">Yes</option></select></div>
        <div><label class="form-label">Door Seal size</label><select id="door-size" class="form-select"><option value="">Unspecified</option><option value="small">Small</option><option value="large">Large</option></select></div>
        <div><label class="form-label">Door Seal photo</label><input id="door-photo" type="file" accept="image/*" class="form-control"><img id="door-preview" class="photo-thumb d-none" alt=""></div>
        <div><label class="form-label">RJT delivered?</label><select id="rjt-delivered" class="form-select"><option value="no">No</option><option value="yes">Yes</option></select></div>
        <div><label class="form-label">RJT size</label><select id="rjt-size" class="form-select"><option value="">Unspecified</option><option value="small">Small</option><option value="large">Large</option></select></div>
        <div><label class="form-label">RJT photo</label><input id="rjt-photo" type="file" accept="image/*" class="form-control"><img id="rjt-preview" class="photo-thumb d-none" alt=""></div>
      </div>
    </div>

    <div class="sticky-actions">
      <button id="btn-save" class="btn btn-brand">Save / Update</button>
      <button id="btn-print-one" class="btn btn-outline-brand">Print This Farm</button>
      <button id="btn-to-summary" class="btn btn-outline-secondary">Back to Summary</button>
      <div class="ms-auto small" id="save-status"></div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="view-admin" class="hidden">
    <div class="bar">
      <div class="section-title">Admin</div>
      <div class="small">This build streams from cloud (no IndexedDB). Service worker caches the shell only.</div>
      <div class="mt-2"><button id="btn-reload" class="btn btn-brand">Reload Summary</button></div>
    </div>
  </div>

  <div class="footer">Agora • Vat Pre-Check • v4.2.2</div>
</div>

<!-- libs -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
/* ========= Firebase ========= */
const firebaseConfig = {
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const FOLDER = 'Pre Check';

/* ========= In-memory state ========= */
let MANIFEST = [];
const RECORDS = new Map();
let LOGO_URL = '';

/* ========= DOM helpers ========= */
const $ = id => document.getElementById(id);
function show(id){ $(id).classList.remove('hidden'); }
function hide(id){ $(id).classList.add('hidden'); }
function setPct(done,total){
  const pct = total? Math.floor((done/total)*100) : 0;
  $('load-bar').style.width = pct+'%';
  $('load-pct').textContent = pct+'%';
  $('loaded-count').textContent = String(done);
}

/* ========= Logo ========= */
(async ()=>{ try{ const ref=storage.ref('Agora Logo/2F6-1YdaEP.jpeg'); LOGO_URL = await ref.getDownloadURL(); $('logo').src=LOGO_URL; $('logo').style.display='block'; }catch(e){} })();

/* ========= Tabs ========= */
const views = { 'tab-form':'view-form', 'tab-summary':'view-summary', 'tab-admin':'view-admin' };
Object.keys(views).forEach(t=>{
  $(t).onclick = ()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    $(t).classList.add('active');
    Object.values(views).forEach(v=>hide(v));
    show(views[t]);
    if(views[t]==='view-summary') startSummary();
  };
});

/* ========= Utilities: robust field mapping ========= */
const N = s => (s==null? '' : String(s));
const low = s => N(s).toLowerCase();
function pick(rec, ...keys){
  for(const k of keys){ if(rec && rec[k]!=null && rec[k]!=='' ) return rec[k]; }
  return '';
}
// Normalize cap: available / unavailable / na
function normCap(v){
  const t = low(v);
  if(/unavailable|no|✗/.test(t)) return 'unavailable';
  if(/available|yes|✓/.test(t)) return 'available';
  if(/na|n\/a/.test(t)) return 'na';
  return v || '';
}
// Door/RJT delivered (supports old schema)
function doorDelivered(rec){ const v = pick(rec,'door-delivered','vat-door-seal'); return /yes|delivered/i.test(N(v)); }
function rjtDelivered(rec){ const v = pick(rec,'rjt-delivered','rjt-seal'); return /yes|delivered/i.test(N(v)); }
function doorSize(rec){ return pick(rec,'door-size','vat-door-seal-size'); }
function rjtSize(rec){ return pick(rec,'rjt-size','rjt-seal-size'); }

// Size normalization: keep numeric only for breakdown
function normSizeNumeric(s){
  const m = N(s).match(/(\d{3,6})/); // 3-6 digits
  return m? m[1] : '';
}

// Photos (cover legacy names)
function photoOf(rec, which){
  const map = {
    'gateway': ['gateway-photo-base64'],
    'v1cap': ['vat1-cap-photo-base64'],
    'v1agit': ['agitator1-photo-base64','agitator-photo-base64'],
    'v2cap': ['vat2-cap-photo-base64'],
    'v2agit': ['agitator2-photo-base64'],
    'door': ['door-photo-base64','vat-door-seal-photo-base64'],
    'rjt': ['rjt-photo-base64','rjt-seal-photo-base64']
  };
  const list = map[which] || [];
  for(const k of list){ if(rec[k]) return rec[k]; }
  return '';
}
function manufacturerGuess(rec){
  const blob = low([rec['vat1-comments'],rec['vat2-comments'],rec['other-brand']].join(' '));
  if(/\bdts\b/.test(blob)) return 'DTS';
  if(/\bnda\b/.test(blob)) return 'NDA';
  if(/\bhalo\b/.test(blob)) return 'Halo';
  if(/\blevno\b/.test(blob)) return 'Levno';
  return rec['other-brand'] || '';
}
function needsPower(rec){
  const blob = low(JSON.stringify(rec));
  return /(power\s*point|splitter\s*plug|double\s*adapter)/.test(blob);
}
function hasDts(rec){
  const blob = low([rec['vat1-comments'],rec['vat2-comments'],rec['other-brand']].join(' '));
  return /\bdts\b/.test(blob) || /(grey|gray)\s+halo/.test(blob) || /nda\s*(cap|vent)/.test(blob);
}

/* ========= Summary bootstrap ========= */
async function listCloudKeys(){
  const res = await storage.ref(FOLDER).listAll();
  const keys = res.items.filter(it=>/\.json$/i.test(it.name)).map(it=>it.name);
  $('cloud-count').textContent = keys.length;
  return keys;
}
function renderSkeletonList(keys){
  const box = $('result-list');
  box.innerHTML = keys.sort().map(k=>{
    const dn = k.replace('.json','');
    return `
      <div class="row-card" id="row-${dn}">
        <div class="row-flex">
          <div><strong>#${dn}</strong> <span class="badge-soft small">loading…</span></div>
          <div class="actions">
            <button class="btn btn-sm btn-outline-secondary" disabled>Details</button>
            <button class="btn btn-sm btn-outline-secondary" disabled>Print</button>
          </div>
        </div>
      </div>`;
  }).join('');
}
function applySearchFilter(){
  const term = low($('search').value);
  document.querySelectorAll('#result-list .row-card').forEach(card=>{
    const text = low(card.textContent);
    card.style.display = (!term || text.includes(term))? '' : 'none';
  });
}
$('search').addEventListener('input', applySearchFilter);
$('btn-clear').onclick = ()=>{ $('search').value=''; applySearchFilter(); };

/* Sizes & KPIs */
const sizeCounts = new Map();
const KPIs = { dts:0, power:0, rubber:0 };
function bump(map,key,inc=1){ map.set(key,(map.get(key)||0)+inc); }
function updateSizesUI(){
  const rows = [...sizeCounts.entries()].sort((a,b)=>parseInt(a[0])-parseInt(b[0]));
  let html = '<table class="table table-sm table-bordered mb-0"><thead><tr><th>Vat Size (L)</th><th>Count</th></tr></thead><tbody>';
  rows.forEach(([sz,c])=> html += `<tr><td>${sz}</td><td>${c}</td></tr>`);
  html += '</tbody></table>';
  $('size-table').innerHTML = html;
}
function refreshKPI(){ $('kpi-dts').textContent=KPIs.dts; $('kpi-power').textContent=KPIs.power; $('kpi-rubber').textContent=KPIs.rubber; }

/* Hydrated row */
function rowHTML(rec){
  const dn = rec.dairyNumber;
  const v1 = N(rec['vat1-capacity']) || '—';
  const v2 = N(rec['vat2-capacity']);
  const cap1 = normCap(pick(rec,'vat1-cap'));
  const cap2 = normCap(pick(rec,'vat2-cap'));
  const seals = `${doorDelivered(rec)?'Door ✔':'Door —'} • ${rjtDelivered(rec)?'RJT ✔':'RJT —'}`;
  return `
    <div class="row-flex">
      <div>
        <strong>#${dn}</strong>
        <span class="badge-soft small">${v1}${v2? ' • '+v2:''}</span><br>
        <span class="small">Caps: V1 ${cap1||'—'}${v2? ' · V2 '+(cap2||'—'):''}</span><br>
        <span class="small">Seals: ${seals}</span>
      </div>
      <div class="actions">
        <button class="btn btn-sm btn-outline-brand" onclick="openDetails('${dn}')">Details</button>
        <button class="btn btn-sm btn-brand" onclick="openPrint('${dn}')">Print</button>
      </div>
    </div>`;
}

/* Stream loader with concurrency */
async function hydrateAll(keys){
  const total = keys.length;
  let done = 0;
  const queue = keys.slice();
  const workers = 8;

  async function worker(){
    while(queue.length){
      const key = queue.shift();
      const dn = key.replace('.json','');
      try{
        const url = await storage.ref(`${FOLDER}/${key}`).getDownloadURL();
        const rec = await fetch(url).then(r=>r.json());
        rec.dairyNumber = rec.dairyNumber || dn;
        RECORDS.set(dn, rec);

        // Sizes: numeric only
        const s1 = normSizeNumeric(pick(rec,'vat1-capacity')); if(s1) bump(sizeCounts,s1);
        const s2 = normSizeNumeric(pick(rec,'vat2-capacity')); if(s2) bump(sizeCounts,s2);

        if(hasDts(rec)) KPIs.dts++;
        if(needsPower(rec)) KPIs.power++;
        if(doorDelivered(rec) || rjtDelivered(rec)) KPIs.rubber++;

        updateSizesUI(); refreshKPI();

        const row = $('row-'+dn);
        if(row) row.innerHTML = rowHTML(rec);
      }catch(e){
        const row = $('row-'+dn);
        if(row) row.querySelector('.badge-soft')?.classList.add('text-danger');
      }finally{
        done++; setPct(done,total);
      }
    }
  }
  await Promise.all(new Array(workers).fill(0).map(worker));
}

async function startSummary(){
  if(MANIFEST.length){ applySearchFilter(); return; }
  try{
    MANIFEST = await listCloudKeys();
    renderSkeletonList(MANIFEST);
    await hydrateAll(MANIFEST);
  }catch(e){
    $('result-list').innerHTML = `<div class="small text-danger">Failed to load list.</div>`;
  }
}

/* ========= Brochure ========= */
function photo(label, src){ return src? `<div class="print-card"><div class="print-label">${label}</div><div class="print-photos"><img src="${src}" alt=""></div></div>` : ''; }
function brochureHTML(rec){
  const doorCount = doorDelivered(rec) ? (pick(rec,'vat2-capacity') ? 2 : 1) : 0;
  return `
  <div class="print-sheet">
    <div class="print-head">
      <img src="${LOGO_URL||''}" alt="logo">
      <div>
        <div class="print-title">Vat Pre-Check – #${rec.dairyNumber||''}</div>
        <div class="print-sub">Brand: ${manufacturerGuess(rec)||'-'} • Spark: ${pick(rec,'spark-bars')||'-'} • One NZ: ${pick(rec,'one-bars')||'-'}</div>
      </div>
    </div>

    <div class="print-grid">
      <div class="print-card">
        <div class="print-label">Vat 1</div>
        <div>Capacity: <b>${pick(rec,'vat1-capacity')||'-'}</b></div>
        <div>Cap: <b>${(normCap(pick(rec,'vat1-cap'))||'-').toUpperCase()}</b></div>
        <div>Serial: <b>${pick(rec,'vat1-serial')||'-'}</b></div>
        <div>Condition: <b>${pick(rec,'vat1-condition')||'-'}</b> ${pick(rec,'vat1-condition-comments')? '• '+pick(rec,'vat1-condition-comments'):''}</div>
        <div>Agitator: ${pick(rec,'agitator1-location','agitator-location')||'-'}</div>
        <div>Notes: ${pick(rec,'vat1-comments')||'-'}</div>
      </div>
      <div class="print-card">
        <div class="print-label">Vat 2</div>
        <div>Capacity: <b>${pick(rec,'vat2-capacity')||'-'}</b></div>
        <div>Cap: <b>${(normCap(pick(rec,'vat2-cap'))||'-').toUpperCase()}</b></div>
        <div>Serial: <b>${pick(rec,'vat2-serial')||'-'}</b></div>
        <div>Condition: <b>${pick(rec,'vat2-condition')||'-'}</b> ${pick(rec,'vat2-condition-comments')? '• '+pick(rec,'vat2-condition-comments'):''}</div>
        <div>Agitator: ${pick(rec,'agitator2-location')||'-'}</div>
        <div>Notes: ${pick(rec,'vat2-comments')||'-'}</div>
      </div>

      <div class="print-card">
        <div class="print-label">Gateway</div>
        <div>Location: <b>${pick(rec,'gateway-location')||'-'}</b></div>
      </div>
      <div class="print-card">
        <div class="print-label">Other Telemetry</div>
        <div>Brand: <b>${pick(rec,'other-brand')||'-'}</b> • Type: <b>${pick(rec,'other-type')||'-'}</b></div>
        <div>Notes: ${pick(rec,'other-notes')||'-'}</div>
      </div>

      <div class="print-card">
        <div class="print-label">Mobile Signal</div>
        <div>Spark: <b>${pick(rec,'spark-bars')||'-'}</b> ${pick(rec,'spark-note')? '• '+pick(rec,'spark-note'):''}</div>
        <div>One NZ: <b>${pick(rec,'one-bars')||'-'}</b> ${pick(rec,'one-note')? '• '+pick(rec,'one-note'):''}</div>
      </div>
      <div class="print-card">
        <div class="print-label">Rubberware</div>
        <div>Door Seal: <b>${doorDelivered(rec)?'Delivered':'No'}</b> ${doorSize(rec)? '• '+doorSize(rec):''} ${doorCount? '(x'+doorCount+')':''}</div>
        <div>RJT: <b>${rjtDelivered(rec)?'Delivered':'No'}</b> ${rjtSize(rec)? '• '+rjtSize(rec):''}</div>
      </div>
    </div>

    <div class="print-grid" style="margin-top:10px">
      ${photo('Gateway', photoOf(rec,'gateway'))}
      ${photo('Vat 1 Cap', photoOf(rec,'v1cap'))}
      ${photo('Agitator (Vat 1)', photoOf(rec,'v1agit'))}
      ${photo('Vat 2 Cap', photoOf(rec,'v2cap'))}
      ${photo('Agitator (Vat 2)', photoOf(rec,'v2agit'))}
      ${photo('Door Seal', photoOf(rec,'door'))}
      ${photo('RJT', photoOf(rec,'rjt'))}
    </div>
  </div>`;
}

window.openDetails = async (dn)=>{
  const rec = RECORDS.get(dn); if(!rec) return;
  const row = $('row-'+dn);
  const id = 'details-'+dn;
  const existing = document.getElementById(id);
  if(existing){ existing.remove(); return; }
  const div = document.createElement('div');
  div.id = id; div.className = 'mt-2';
  div.innerHTML = brochureHTML(rec);
  row.appendChild(div);
};
window.openPrint = async (dn)=>{
  const rec = RECORDS.get(dn); if(!rec) return;
  const w = window.open('', '_blank');
  const sheet = brochureHTML(rec);
  const css = document.querySelector('style').innerHTML;
  w.document.write(`<html><head><title>Print #${dn}</title><style>body{font-family:Inter,Arial,sans-serif;padding:16px}${css}</style></head><body>${sheet}</body></html>`);
  w.document.close(); w.focus(); setTimeout(()=>w.print(), 250);
};

/* ========= Export / Print All (no 100% gate) ========= */
$('btn-export-sizes').onclick = ()=>{
  const rows = [...sizeCounts.entries()].map(([size,count])=>({Size:size, Count:count}));
  const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Vat Sizes'); XLSX.writeFile(wb, 'vat_sizes.csv');
};

function ensureSomeLoadedOrWarn(){
  if(RECORDS.size===0){ alert('Still loading records… give it a moment.'); return false; }
  const missing = Math.max(0, (MANIFEST.length - RECORDS.size));
  if(missing>0){ alert(`Proceeding with ${RECORDS.size} farms (${missing} could not be loaded).`); }
  return true;
}

$('btn-print-all').onclick = async ()=>{
  if(!ensureSomeLoadedOrWarn()) return;
  const w = window.open('', '_blank');
  const css = document.querySelector('style').innerHTML;
  const html = [...RECORDS.values()].map(brochureHTML).join('<div style="page-break-after:always"></div>');
  w.document.write(`<html><head><title>All Brochures</title><style>body{font-family:Inter,Arial,sans-serif;padding:16px}${css}</style></head><body>${html}</body></html>`);
  w.document.close(); w.focus(); setTimeout(()=>w.print(), 400);
};

$('btn-zip-all').onclick = async ()=>{
  if(!ensureSomeLoadedOrWarn()) return;
  const zip = new JSZip();
  const css = document.querySelector('style').innerHTML;
  for(const [dn,rec] of RECORDS.entries()){
    const html = `<!doctype html><meta charset="utf-8"><title>${dn}</title><style>body{font-family:Inter,Arial,sans-serif;padding:16px}${css}</style>${brochureHTML(rec)}`;
    zip.file(`brochure_${dn}.html`, html);
  }
  const blob = await zip.generateAsync({type:'blob'});
  saveAs(blob, 'agora_precheck_brochures.zip');
};

/* ========= FORM: auto-fill & save ========= */
function setVal(id, v){ const el=$(id); if(el) el.value = v ?? ''; }
function setPrev(id, b64){ const el=$(id); if(!el) return; if(b64){ el.src=b64; el.classList.remove('d-none'); } else el.classList.add('d-none'); }

$('dairyNumber').addEventListener('blur', async ()=>{
  const dn = N($('dairyNumber').value).trim(); if(!dn) return;
  try{
    const url = await storage.ref(`${FOLDER}/${dn}.json`).getDownloadURL();
    const rec = await fetch(url).then(r=>r.json());
    // cache in memory for this session
    RECORDS.set(dn, rec);
    // populate
    setVal('gateway-location', pick(rec,'gateway-location'));
    setVal('vat1-capacity', pick(rec,'vat1-capacity')); setVal('vat1-cap', normCap(pick(rec,'vat1-cap'))); setVal('vat1-serial', pick(rec,'vat1-serial'));
    setVal('vat1-condition', pick(rec,'vat1-condition')); setVal('vat1-condition-comments', pick(rec,'vat1-condition-comments')); setVal('vat1-comments', pick(rec,'vat1-comments'));
    setVal('agitator1-location', pick(rec,'agitator1-location','agitator-location'));
    setVal('vat2-capacity', pick(rec,'vat2-capacity')); setVal('vat2-cap', normCap(pick(rec,'vat2-cap')) || 'na'); setVal('vat2-serial', pick(rec,'vat2-serial'));
    setVal('vat2-condition', pick(rec,'vat2-condition')); setVal('vat2-condition-comments', pick(rec,'vat2-condition-comments')); setVal('vat2-comments', pick(rec,'vat2-comments'));
    setVal('agitator2-location', pick(rec,'agitator2-location'));
    setVal('spark-bars', pick(rec,'spark-bars')); setVal('spark-note', pick(rec,'spark-note'));
    setVal('one-bars', pick(rec,'one-bars')); setVal('one-note', pick(rec,'one-note'));
    setVal('other-brand', pick(rec,'other-brand')); setVal('other-type', pick(rec,'other-type')); setVal('other-notes', pick(rec,'other-notes'));
    setVal('door-delivered', doorDelivered(rec)?'yes':'no'); setVal('door-size', doorSize(rec));
    setVal('rjt-delivered', rjtDelivered(rec)?'yes':'no'); setVal('rjt-size', rjtSize(rec));
    // photos
    setPrev('gateway-preview', photoOf(rec,'gateway'));
    setPrev('vat1-cap-preview', photoOf(rec,'v1cap'));
    setPrev('agitator1-preview', photoOf(rec,'v1agit'));
    setPrev('vat2-cap-preview', photoOf(rec,'v2cap'));
    setPrev('agitator2-preview', photoOf(rec,'v2agit'));
    setPrev('door-preview', photoOf(rec,'door'));
    setPrev('rjt-preview', photoOf(rec,'rjt'));
  }catch(e){}
});
$('btn-to-summary').onclick = ()=>$('tab-summary').click();

async function readFileAsB64(input){
  const f = input.files && input.files[0]; if(!f) return '';
  return await new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(f); });
}
$('btn-save').onclick = async ()=>{
  const dn = N($('dairyNumber').value).trim(); if(!dn){ alert('Enter a dairy number'); return; }
  $('save-status').textContent = 'Saving…';
  try{
    const data = {
      dairyNumber: dn,
      'gateway-location': $('gateway-location').value,
      'vat1-capacity': $('vat1-capacity').value,
      'vat1-cap': normCap($('vat1-cap').value),
      'vat1-serial': $('vat1-serial').value,
      'vat1-condition': $('vat1-condition').value,
      'vat1-condition-comments': $('vat1-condition-comments').value,
      'vat1-comments': $('vat1-comments').value,
      'agitator1-location': $('agitator1-location').value,
      'vat2-capacity': $('vat2-capacity').value,
      'vat2-cap': normCap($('vat2-cap').value),
      'vat2-serial': $('vat2-serial').value,
      'vat2-condition': $('vat2-condition').value,
      'vat2-condition-comments': $('vat2-condition-comments').value,
      'vat2-comments': $('vat2-comments').value,
      'agitator2-location': $('agitator2-location').value,
      'spark-bars': $('spark-bars').value, 'spark-note': $('spark-note').value,
      'one-bars': $('one-bars').value, 'one-note': $('one-note').value,
      'other-brand': $('other-brand').value, 'other-type': $('other-type').value, 'other-notes': $('other-notes').value,
      'door-delivered': $('door-delivered').value, 'door-size': $('door-size').value,
      'rjt-delivered': $('rjt-delivered').value, 'rjt-size': $('rjt-size').value,
      timestamp: Date.now()
    };
    // new photos
    data['gateway-photo-base64'] = await readFileAsB64($('gateway-photo'));
    data['vat1-cap-photo-base64'] = await readFileAsB64($('vat1-cap-photo'));
    data['agitator1-photo-base64'] = await readFileAsB64($('agitator1-photo'));
    data['vat2-cap-photo-base64'] = await readFileAsB64($('vat2-cap-photo'));
    data['agitator2-photo-base64'] = await readFileAsB64($('agitator2-photo'));
    data['door-photo-base64'] = await readFileAsB64($('door-photo'));
    data['rjt-photo-base64'] = await readFileAsB64($('rjt-photo'));

    const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
    await storage.ref(`${FOLDER}/${dn}.json`).put(blob);
    $('save-status').textContent = 'Saved ✔';
    // reflect session
    RECORDS.set(dn, data);
    const row = $('row-'+dn); if(row) row.innerHTML = rowHTML(data);
  }catch(e){
    $('save-status').textContent = 'Save failed';
    alert('Save failed');
  }
};

/* ========= Admin ========= */
$('btn-reload').onclick = ()=>{
  MANIFEST = []; RECORDS.clear(); sizeCounts.clear();
  $('size-table').textContent = 'Starting…';
  $('result-list').innerHTML = '';
  $('kpi-dts').textContent = '0'; $('kpi-power').textContent='0'; $('kpi-rubber').textContent='0';
  setPct(0,1);
  $('tab-summary').click();
};

/* ========= Start ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  $('tab-summary').classList.add('active');
  show('view-summary');
  startSummary();

  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
  }
});
</script>
</body>
</html>