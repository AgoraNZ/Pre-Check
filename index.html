<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Agora Vat Pre-Check</title>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" />

<style>
:root{
  --brand:#001F3F; --accent:#FF851B; --muted:#6b7280; --bg:#f7f8fb; --ok:#2ecc71; --warn:#ffb020; --danger:#ff4136;
}
html,body{background:var(--bg);color:#0f172a;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
.app{max-width:1100px;margin:28px auto;padding:0 16px}
.brand-header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
.brand-logo{width:160px;height:auto;display:none}
.brand-title{flex:1}
.brand-title h1{margin:0;font-weight:800;color:var(--brand);letter-spacing:.2px}
.brand-sub{color:var(--muted);font-size:.95rem;margin-top:2px}
.top-tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 18px}
.tab-btn{border:1px solid #e5e7eb;background:#fff;color:#111827;border-radius:10px;padding:10px 14px;font-weight:600}
.tab-btn.active{border-color:var(--accent);box-shadow:0 0 0 3px #ff851b2b}
.bar{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin:10px 0}
.section-title{font-size:1.05rem;font-weight:800;color:#111827;margin:6px 0 10px}
.form-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin-bottom:12px}
.form-card h6{font-weight:800;color:#111827;margin:0 0 10px}
.hint{color:var(--muted);font-size:.85rem}
label.form-label{font-weight:600}
.small-note{color:#6b7280;font-size:.9rem}
.photo-thumb{width:110px; height:86px; object-fit:cover; border-radius:8px; border:1px solid #e5e7eb; margin-right:8px; margin-top:6px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:900px){ .grid-2,.grid-3{grid-template-columns:1fr} }

.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px;cursor:pointer}
.kpi .num{font-size:1.4rem;font-weight:800}
.kpi .label{color:#6b7280;font-size:.9rem}
.card-list{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media (max-width:900px){.card-list{grid-template-columns:1fr}}
.farm-line{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
.farm-line .left{display:flex;align-items:center;gap:10px}
.badge-soft{border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:.8rem}

.progress-wrap{display:flex;align-items:center;gap:12px}
.progress{height:10px}
.sticky-actions{position:sticky;bottom:8px;display:flex;gap:8px;flex-wrap:wrap}
.btn-brand{background:var(--accent);border:none;color:#fff;font-weight:700}
.btn-brand:hover{background:#ff6d00}
.btn-outline-brand{border:1px solid var(--accent);color:var(--accent);background:#fff}
.btn-outline-brand:hover{background:var(--accent);color:#fff}
.footer{color:#6b7280;text-align:center;margin:22px 0 10px}

/* Print sheet (brochure) – agreed layout */
#printModal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:10px;z-index:9999}
.print-sheet{max-width:900px;margin:0 auto;background:#fff;border-radius:12px;padding:14px;color:#0f172a;box-shadow:0 8px 30px rgba(0,0,0,.2)}
.print-head{display:flex;align-items:center;gap:16px;border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:10px}
.print-head img{height:44px}
.print-title{font-weight:800;font-size:1.2rem}
.print-sub{color:#6b7280}
.print-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.print-card{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.print-label{font-weight:700;margin-bottom:6px}
.print-photos{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.print-photos img{width:100%;max-height:180px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb}
.print-actions{text-align:right;margin-top:10px}
.hidden{display:none!important}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="brand-header">
    <img id="logo" class="brand-logo" alt="Agora Logo">
    <div class="brand-title">
      <h1>Agora Vat Pre-Check</h1>
      <div class="brand-sub">Fast field capture • Smart summary • Customer-ready output</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="top-tabs">
    <button id="tab-form" class="tab-btn active">Form</button>
    <button id="tab-summary" class="tab-btn">Summary</button>
    <button id="tab-admin" class="tab-btn">Admin</button>
    <div class="ms-auto progress-wrap">
      <span class="small-note">Cloud:</span> <span id="cloud-count">–</span>
      <span class="small-note">Fetched:</span> <span id="fetched-count">0</span>
      <div class="progress" style="width:160px"><div id="scan-bar" class="progress-bar" role="progressbar" style="width:0%"></div></div>
      <span id="scan-pct" class="small-note">0%</span>
    </div>
  </div>

  <!-- ============ FORM ============ -->
  <div id="view-form">
    <div class="form-card">
      <div class="grid-3">
        <div>
          <label class="form-label">Dairy Number</label>
          <input class="form-control" id="dairyNumber" placeholder="e.g. 7031">
          <div class="hint">Blur/leave this field to auto-fill from cloud (including photos where present).</div>
        </div>
        <div>
          <label class="form-label">Gateway Location</label>
          <input class="form-control" id="gateway-location" placeholder="e.g. dairy office">
        </div>
        <div>
          <label class="form-label">Gateway Comments</label>
          <input class="form-control" id="gateway-comments" placeholder="e.g. 3 bars 4G Spark; needs power point">
        </div>
      </div>
      <div class="grid-3 mt-2">
        <div>
          <label class="form-label">Gateway Photo</label>
          <input type="file" accept="image/*" id="gateway-photo" class="form-control">
          <div class="mt-1"><img id="gateway-preview" class="photo-thumb d-none" alt=""></div>
        </div>
      </div>
    </div>

    <!-- Vat 1 -->
    <div class="form-card">
      <h6>Vat 1</h6>
      <div class="grid-3">
        <div>
          <label class="form-label">Capacity (L)</label>
          <input class="form-control" id="vat1-capacity" placeholder="e.g. 21500">
        </div>
        <div>
          <label class="form-label">Cap</label>
          <select class="form-select" id="vat1-cap">
            <option value="AVAILABLE">Available ✓</option>
            <option value="UNAVAILABLE">Unavailable ✗</option>
          </select>
        </div>
        <div>
          <label class="form-label">Cap Photo</label>
          <input type="file" accept="image/*" id="vat1-cap-photo" class="form-control">
          <div class="mt-1"><img id="vat1-cap-preview" class="photo-thumb d-none" alt=""></div>
        </div>

        <div>
          <label class="form-label">Serial</label>
          <input class="form-control" id="vat1-serial" placeholder="e.g. VSG584">
        </div>
        <div>
          <label class="form-label">Condition</label>
          <select class="form-select" id="vat1-condition">
            <option value="ok">OK</option>
            <option value="attention">Attention required</option>
          </select>
        </div>
        <div>
          <label class="form-label">Condition Photo</label>
          <input type="file" accept="image/*" id="vat1-condition-photo" class="form-control">
          <div class="mt-1"><img id="vat1-condition-preview" class="photo-thumb d-none" alt=""></div>
        </div>

        <div>
          <label class="form-label">Notes (width/manufacturer etc.)</label>
          <input class="form-control" id="vat1-comments" placeholder="e.g. DTS / NDA, 2.9m wide, grey halo sensor">
        </div>
        <div>
          <label class="form-label">Cap Comments</label>
          <input class="form-control" id="vat1-cap-comments" placeholder="e.g. Halo grey cap, DTS reducer">
        </div>
        <div>
          <label class="form-label">Agitator Location</label>
          <input class="form-control" id="agitator1-location" placeholder="e.g. rear left">
          <input type="file" accept="image/*" id="agitator1-photo" class="form-control mt-1">
          <div class="mt-1"><img id="agitator1-preview" class="photo-thumb d-none" alt=""></div>
        </div>
      </div>
    </div>

    <!-- Vat 2 – capacity first -->
    <div class="form-card">
      <h6>Vat 2 – Capacity</h6>
      <div class="grid-3">
        <div>
          <label class="form-label">Capacity (L)</label>
          <input class="form-control" id="vat2-capacity" placeholder="leave blank if N/A">
          <div class="hint">Entering a value reveals all Vat-2 fields.</div>
        </div>
      </div>
    </div>

    <!-- Vat 2 – details when capacity present -->
    <div id="vat2-extra" class="form-card d-none">
      <h6>Vat 2</h6>
      <div class="grid-3">
        <div>
          <label class="form-label">Cap</label>
          <select class="form-select" id="vat2-cap">
            <option value="NA" selected>N/A</option>
            <option value="AVAILABLE">Available ✓</option>
            <option value="UNAVAILABLE">Unavailable ✗</option>
          </select>
        </div>
        <div>
          <label class="form-label">Cap Photo</label>
          <input type="file" accept="image/*" id="vat2-cap-photo" class="form-control">
          <div class="mt-1"><img id="vat2-cap-preview" class="photo-thumb d-none" alt=""></div>
        </div>
        <div>
          <label class="form-label">Serial</label>
          <input class="form-control" id="vat2-serial" placeholder="e.g. NDA-B5678">
        </div>

        <div>
          <label class="form-label">Condition</label>
          <select class="form-select" id="vat2-condition">
            <option value="ok">OK</option>
            <option value="attention">Attention required</option>
          </select>
        </div>
        <div>
          <label class="form-label">Condition Photo</label>
          <input type="file" accept="image/*" id="vat2-condition-photo" class="form-control">
          <div class="mt-1"><img id="vat2-condition-preview" class="photo-thumb d-none" alt=""></div>
        </div>

        <div>
          <label class="form-label">Notes (width/manufacturer etc.)</label>
          <input class="form-control" id="vat2-comments" placeholder="e.g. DTS / NDA, 2.4m, grey halo">
        </div>
        <div>
          <label class="form-label">Cap Comments</label>
          <input class="form-control" id="vat2-cap-comments" placeholder="e.g. Halo grey cap, DTS reducer">
        </div>
        <div>
          <label class="form-label">Agitator Location</label>
          <input class="form-control" id="agitator2-location" placeholder="e.g. front right">
          <input type="file" accept="image/*" id="agitator2-photo" class="form-control mt-1">
          <div class="mt-1"><img id="agitator2-preview" class="photo-thumb d-none" alt=""></div>
        </div>
      </div>
    </div>

    <!-- Mobile Signal (separate entries) -->
    <div class="form-card">
      <h6>Mobile Signal</h6>
      <div class="grid-3">
        <div>
          <label class="form-label">Spark (bars)</label>
          <input class="form-control" id="spark-bars" placeholder="e.g. 3">
        </div>
        <div>
          <label class="form-label">One NZ (bars)</label>
          <input class="form-control" id="one-bars" placeholder="e.g. 2">
        </div>
        <div>
          <label class="form-label">Preferred</label>
          <select id="signal-preferred" class="form-select">
            <option value="">—</option><option value="spark">Spark</option><option value="one">One NZ</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Other Telemetry -->
    <div class="form-card">
      <h6>Other Telemetry</h6>
      <div class="grid-3">
        <div>
          <label class="form-label">Brand</label>
          <input class="form-control" id="other-brand" placeholder="e.g. Halo, Levno, DTS, NDA">
        </div>
        <div>
          <label class="form-label">Type</label>
          <select class="form-select" id="other-type">
            <option value="">Select…</option>
            <option value="vat">Vat</option><option value="water">Water</option>
            <option value="fuel">Fuel</option><option value="other">Other</option>
          </select>
        </div>
        <div>
          <label class="form-label">Notes</label>
          <input class="form-control" id="other-notes" placeholder="e.g. existing gateway present">
        </div>
      </div>
    </div>

    <!-- Rubberware -->
    <div class="form-card">
      <h6>Rubberware</h6>
      <div class="grid-3">
        <div>
          <label class="form-label">Door Seal Delivered?</label>
          <select class="form-select" id="door-delivered">
            <option value="No" selected>No</option>
            <option value="Yes">Yes</option>
          </select>
        </div>
        <div>
          <label class="form-label">Door Seal Size</label>
          <select class="form-select" id="door-size">
            <option value="">Select…</option>
            <option value="Small">Small</option><option value="Large">Large</option>
          </select>
          <div class="hint">If two vats present, delivered count considered 2.</div>
        </div>
        <div>
          <label class="form-label">Door Seal Photo</label>
          <input type="file" accept="image/*" id="door-photo" class="form-control">
          <div class="mt-1"><img id="door-preview" class="photo-thumb d-none" alt=""></div>
        </div>

        <div>
          <label class="form-label">RJT Step Seal Delivered?</label>
          <select class="form-select" id="rjt-delivered">
            <option value="No" selected>No</option>
            <option value="Yes">Yes</option>
          </select>
        </div>
        <div>
          <label class="form-label">RJT Size</label>
          <select class="form-select" id="rjt-size">
            <option value="">Select…</option>
            <option value="Small">Small</option><option value="Large">Large</option>
          </select>
        </div>
        <div>
          <label class="form-label">RJT Photo</label>
          <input type="file" accept="image/*" id="rjt-photo" class="form-control">
          <div class="mt-1"><img id="rjt-preview" class="photo-thumb d-none" alt=""></div>
        </div>
      </div>
    </div>

    <div class="sticky-actions">
      <button id="btn-save" class="btn btn-brand">Save / Update</button>
      <div id="saveSpinner" class="spinner-border text-warning" role="status" style="display:none"><span class="visually-hidden">Saving…</span></div>
      <button id="btn-print-current" class="btn btn-outline-brand">Print This Farm</button>
      <button id="btn-summary-jump" class="btn btn-outline-brand">Go to Summary</button>
    </div>
  </div>

  <!-- ============ SUMMARY ============ -->
  <div id="view-summary" class="hidden">
    <div class="bar">
      <div class="section-title">Overview</div>
      <div class="kpi-grid">
        <div class="kpi" data-kpi="dts"><div class="num" id="kpi-dts">0</div><div class="label">DTS Vent Caps</div></div>
        <div class="kpi" data-kpi="power"><div class="num" id="kpi-power">0</div><div class="label">Farms needing power point</div></div>
        <div class="kpi" data-kpi="rubber"><div class="num" id="kpi-rubber">0</div><div class="label">Rubberware delivered</div></div>
      </div>
    </div>

    <div class="bar">
      <div class="section-title">Vat Size Breakdown</div>
      <div id="size-table" class="small-note">Loading…</div>
    </div>

    <div class="bar">
      <div class="d-flex justify-content-between align-items-center">
        <div class="section-title mb-0">Farms</div>
        <input id="searchBox" class="form-control" style="max-width:220px" placeholder="Search dairy #">
      </div>
      <div id="result-cards" class="mt-2"></div>
    </div>
  </div>

  <!-- ============ ADMIN ============ -->
  <div id="view-admin" class="hidden">
    <div class="bar">
      <div class="section-title">Data Tools</div>
      <div class="d-flex flex-wrap gap-2">
        <button id="btn-print-all" class="btn btn-brand">Print All Brochures</button>
        <button id="btn-download-all" class="btn btn-outline-brand">Download All Brochures (ZIP)</button>
        <button id="btn-owners" class="btn btn-outline-brand">Download Owners Report (CSV)</button>
        <button id="btn-clear-cache" class="btn btn-outline-brand">Clear SW Cache</button>
      </div>
      <div class="small-note mt-2">Loads list of dairy numbers immediately. Details/print for a farm fetches its JSON on demand. “Print All/Download All” will iterate through all farms (shows progress).</div>
    </div>
  </div>

  <div class="footer">Agora • Vat Pre-Check • v4.0</div>
</div>

<!-- Print Modal -->
<div id="printModal">
  <div class="print-sheet">
    <div class="print-head">
      <img id="print-logo" alt="logo">
      <div>
        <div class="print-title" id="print-title">Vat Pre-Check</div>
        <div class="print-sub" id="print-sub"></div>
      </div>
    </div>

    <div class="print-grid" id="print-grid-top"></div>
    <div class="print-grid" id="print-grid-bot" style="margin-top:10px"></div>

    <div class="print-actions">
      <button id="btn-modal-close" class="btn btn-outline-brand">Close</button>
      <button id="btn-modal-print" class="btn btn-brand">Print</button>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const FOLDER = 'Pre Check';

/* ================= Simple State ================= */
let CLOUD_KEYS = [];          // dairy numbers (strings)
const DATA = new Map();       // dn -> mapped record (after fetch + normalize)
const KPI_LISTS = { dts: new Set(), power: new Set(), rubber: new Set() };
const SIZE_MAP = new Map();   // size -> count
let LOGO_URL = "";

/* ================= Helpers ================= */
const $ = id => document.getElementById(id);
const show = el => el.classList.remove('hidden');
const hide = el => el.classList.add('hidden');
function setPct(done,total){
  const pct = Math.max(0, Math.min(100, Math.round((done/(total||1))*100)));
  $('scan-bar').style.width = pct+'%';
  $('scan-pct').textContent = pct+'%';
}
function lc(x){ return (x||"").toString().toLowerCase(); }
function first(rec, keys){
  for(const k of keys){ if(rec!=null && rec[k]!=null && String(rec[k]).toString().trim()!=="") return rec[k]; }
  return "";
}
function toB64(fileInput){
  const f = fileInput.files && fileInput.files[0]; if(!f) return Promise.resolve("");
  return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); });
}
/* parse bars from texts like '3 bars 4g spark', '1-2 bars', 'full bars' */
function parseBarsFromText(t, carrier){ // carrier 'spark' or 'one'
  t = lc(t);
  let val = null;
  const re = /(\d+)\s*-\s*(\d+)\s*bars?/;
  const m = t.match(re); if(m){ val = Math.max(+m[1],+m[2]); }
  const m2 = t.match(/(\d+)\s*bars?/); if(m2) val = +m2[1];
  if(/full\s*bars?/.test(t)) val = 5;
  // disambiguate by carrier word around
  if(carrier==='spark' && /(spark|telecom)/.test(t)) return val;
  if(carrier==='one' && /(one\s*nz|vodafone)/.test(t)) return val;
  return null;
}

/* ================= DTS + Power rules ================= */
/* DTS rule: count if cap comments contain:
   - 'halo grey/gray cap'
   - 'grey/gray sensor'
   - 'dts reducer' / 'dts reducing cap' / 'dts cap'
   - OR any 'dts' in cap comments
*/
function hasDtsCap(capComments){
  const t = lc(capComments||"");
  if(!t) return false;
  if(/\bhalo\s+gr[ea]y\b/.test(t)) return true;
  if(/\bgr[ea]y\s+sensor\b/.test(t)) return true;
  if(/\bdts\s+reduc(ing|er)\b/.test(t)) return true;
  if(/\bdts\s+cap\b/.test(t)) return true;
  if(/\bdts\b/.test(t)) return true;
  return false;
}
/* Power point needed: gateway location/comments include:
   power point recommended/needed/needs/new plug/no plugs/single plug/use splitter/double adaptor etc.
   avoid false 'multiple points' (not needed).
*/
function needsPower(text){
  const t = lc(text||"");
  if(!t) return false;
  if(/multiple\s+points/.test(t)) return false;
  return /(power\s*point|plug|socket)/.test(t) && /(recommend|need|needed|no\s+plug|no\s+plugs|single\s+plug|new\s+plug|splitter|double\s+(adaptor|adapter|plug)|use\s+desk\s+power\s*point)/.test(t);
}

/* ================= Mapping raw -> unified ================= */
function mapRecord(raw){
  raw = raw||{};
  const rec = {}; // unified record for brochure/form/summary

  // DN
  rec.dairyNumber = first(raw, ['dairyNumber','Dairy','dairy','id','DairyNumber']) || '';

  // Vat 1
  rec.v1 = {
    size: first(raw, ['vat1-capacity','vat1Capacity','Size1','size1','vat1','Vat1','Size','size']),
    serial: first(raw, ['vat1-serial','vat1Serial','Serial1','serial1']),
    cap: first(raw, ['vat1-cap','vat1Cap','Cap1','cap1','Cap']) || 'AVAILABLE',
    condition: first(raw, ['vat1-condition','vat1Condition','Condition1','condition1','Condition']) || 'ok',
    notes: first(raw, ['vat1-comments','vat1Notes','notes1','Notes1','Notes']),
    capComments: first(raw, ['vat1-cap-comments','vatCapComments1','CapComments1','capcomments1','CapComments'])
  };
  rec.v1.agitator = first(raw, ['agitator1-location','agitator-location','Agitator1','AgitatorLocation','agitatorLocation']);
  rec.v1.photos = {
    cap: first(raw, ['vat1-cap-photo-base64','vat1CapPhoto','vat1CapPhotoBase64']),
    cond: first(raw, ['vat1-condition-photo-base64','vat1ConditionPhoto']),
    agitator: first(raw, ['agitator1-photo-base64','agitator-photo-base64','agitator1Photo'])
  };

  // Vat 2
  rec.v2 = {
    size: first(raw, ['vat2-capacity','vat2Capacity','Size2','size2','vat2','Vat2']),
    serial: first(raw, ['vat2-serial','vat2Serial','Serial2','serial2']),
    cap: first(raw, ['vat2-cap','vat2Cap','Cap2','cap2']) || (first(raw,['vat2-capacity'])? 'AVAILABLE':'NA'),
    condition: first(raw, ['vat2-condition','vat2Condition','Condition2','condition2']) || 'ok',
    notes: first(raw, ['vat2-comments','vat2Notes','notes2','Notes2']),
    capComments: first(raw, ['vat2-cap-comments','vatCapComments2','CapComments2','capcomments2'])
  };
  rec.v2.agitator = first(raw, ['agitator2-location','Agitator2']);
  rec.v2.photos = {
    cap: first(raw, ['vat2-cap-photo-base64','vat2CapPhoto']),
    cond: first(raw, ['vat2-condition-photo-base64','vat2ConditionPhoto']),
    agitator: first(raw, ['agitator2-photo-base64','agitator2Photo'])
  };

  // Gateway
  rec.gateway = {
    location: first(raw, ['gateway-location','GatewayLocation']),
    comments: first(raw, ['gateway-comments','GatewayComments']),
    photo: first(raw, ['gateway-photo-base64','gatewayPhoto'])
  };

  // Signal (explicit or parsed from gateway fields)
  const explicitSpark = first(raw, ['spark-bars','SparkBars','Spark']);
  const explicitOne = first(raw, ['one-bars','OneNZBars','One']);
  let sparkBars = explicitSpark || parseBarsFromText(rec.gateway.location,'spark') || parseBarsFromText(rec.gateway.comments,'spark') || '';
  let oneBars = explicitOne || parseBarsFromText(rec.gateway.location,'one') || parseBarsFromText(rec.gateway.comments,'one') || '';
  rec.signal = {
    spark: String(sparkBars||''),
    one: String(oneBars||''),
    preferred: first(raw, ['signal-preferred','PreferredCarrier']) || ''
  };

  // Other telemetry
  rec.other = {
    brand: first(raw, ['other-brand','telemetry-brand','Manufacturer','manufacturer']),
    type: first(raw, ['other-type','TelemetryType']),
    notes: first(raw, ['other-notes','telemetry-comments','TelemetryNotes'])
  };

  // Rubberware
  const doorDelivered = first(raw, ['door-delivered','vat-door-seal','DoorDelivered']);
  const doorSize = first(raw, ['door-size','door-seal-size','DoorSize']);
  const rjtDelivered = first(raw, ['rjt-delivered','rjt-seal','RJTDelivered']);
  const rjtSize = first(raw, ['rjt-size','RJTSize']);

  rec.rubber = {
    doorDelivered: /yes|delivered/i.test(doorDelivered||'') ? 'Yes' : 'No',
    doorSize: doorSize || '',
    rjtDelivered: /yes|delivered/i.test(rjtDelivered||'') ? 'Yes' : 'No',
    rjtSize: rjtSize || ''
  };

  // Metrics flags
  const capBlob = [rec.v1.capComments, rec.v2.capComments].filter(Boolean).join(' | ');
  rec.hasDts = hasDtsCap(capBlob);
  const gwBlob = [rec.gateway.location, rec.gateway.comments].filter(Boolean).join(' | ');
  rec.needsPower = needsPower(gwBlob);
  rec.doorDeliveredCount = rec.rubber.doorDelivered==='Yes' ? (rec.v2.size ? 2 : 1) : 0;

  return rec;
}

/* ================= UI wiring ================= */
const views = { 'tab-form':'view-form', 'tab-summary':'view-summary', 'tab-admin':'view-admin' };
Object.keys(views).forEach(t=>{
  $(t).onclick=()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    $(t).classList.add('active');
    Object.values(views).forEach(v=>hide($(v)));
    show($(views[t]));
    if(views[t]==='view-summary'){ renderSummaryList(CLOUD_KEYS); }
  };
});

/* Vat2 reveal */
function toggleVat2Extra(){ $('vat2-extra').classList.toggle('d-none', !($('vat2-capacity').value||'').trim()); }
$('vat2-capacity').addEventListener('input', toggleVat2Extra);
$('vat2-capacity').addEventListener('blur', toggleVat2Extra);

/* Photo previews */
function bindPreview(inputId, imgId){
  $(inputId).addEventListener('change', ()=>{
    const f = $(inputId).files && $(inputId).files[0];
    if(!f){ $(imgId).classList.add('d-none'); return; }
    $(imgId).src = URL.createObjectURL(f);
    $(imgId).classList.remove('d-none');
  });
}
['gateway','vat1-cap','vat1-condition','agitator1','vat2-cap','vat2-condition','agitator2','door','rjt'].forEach(p=>{
  const inId = p+'-photo', imId = p+'-preview';
  if($(inId)) bindPreview(inId, imId);
});

/* ================= Load Logo ================= */
(async()=>{
  try{
    const ref = storage.ref('Agora Logo/2F6-1YdaEP.jpeg');
    LOGO_URL = await ref.getDownloadURL();
    $('logo').src = LOGO_URL; $('logo').style.display='block';
    $('print-logo').src = LOGO_URL;
  }catch(e){}
})();

/* ================= List dairy numbers fast ================= */
async function listCloud(){
  const folder = storage.ref(FOLDER);
  const res = await folder.listAll();
  const keys = res.items.filter(x=>/\.json$/i.test(x.name)).map(x=>x.name.replace('.json',''));
  CLOUD_KEYS = keys.sort();
  $('cloud-count').textContent = CLOUD_KEYS.length;
  renderSummaryList(CLOUD_KEYS);
}
function renderSummaryList(keys){
  const q = ($('searchBox').value||'').trim();
  const view = $('result-cards');
  const filt = keys.filter(k=> k.includes(q));
  view.innerHTML = filt.map(dn=>`
    <div class="farm-line">
      <div class="left"><strong>#${dn}</strong></div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-brand" onclick="openDetails('${dn}')">Details</button>
        <button class="btn btn-sm btn-brand" onclick="openPrint('${dn}')">Print</button>
      </div>
    </div>
  `).join('');
}
$('searchBox').addEventListener('input', ()=>renderSummaryList(CLOUD_KEYS));

/* ================= Fetch single record on demand ================= */
async function fetchRecord(dn){
  if(DATA.has(dn)) return DATA.get(dn);
  const url = await storage.ref(`${FOLDER}/${dn}.json`).getDownloadURL();
  const raw = await fetch(url).then(r=>r.json());
  // attempt to auto-derive spark/one from gateway text if missing explicit bars
  const rec = mapRecord(raw);
  // bump KPIs + sizes
  DATA.set(dn, rec);
  if(rec.hasDts) KPI_LISTS.dts.add(dn);
  if(rec.needsPower) KPI_LISTS.power.add(dn);
  if(rec.rubber.doorDelivered==='Yes') KPI_LISTS.rubber.add(dn);
  if(rec.v1.size) SIZE_MAP.set(rec.v1.size, (SIZE_MAP.get(rec.v1.size)||0)+1);
  if(rec.v2.size) SIZE_MAP.set(rec.v2.size, (SIZE_MAP.get(rec.v2.size)||0)+1);
  refreshKpisAndSizes();
  return rec;
}
function refreshKpisAndSizes(){
  $('kpi-dts').textContent = KPI_LISTS.dts.size;
  $('kpi-power').textContent = KPI_LISTS.power.size;
  $('kpi-rubber').textContent = KPI_LISTS.rubber.size;

  if(SIZE_MAP.size===0){ $('size-table').innerHTML = '<span class="small-note">Loading…</span>'; return; }
  let html = '<table class="table table-sm table-bordered mb-0"><thead><tr><th>Vat Size (L)</th><th>Count</th></tr></thead><tbody>';
  [...SIZE_MAP.entries()].sort((a,b)=>parseInt(a[0])-parseInt(b[0])).forEach(([sz,c])=>{
    html += `<tr><td>${sz}</td><td>${c}</td></tr>`;
  });
  html+='</tbody></table>';
  $('size-table').innerHTML = html;
}

/* KPI filter clicks → list only those dairy numbers */
document.querySelectorAll('.kpi').forEach(k=>{
  k.addEventListener('click', ()=>{
    const typ = k.getAttribute('data-kpi');
    let set = KPI_LISTS[typ];
    if(set && set.size>0) renderSummaryList([...set].sort());
  });
});

/* ================= Print / Details (agreed layout) ================= */
function sheetHTML(rec){
  const manu = (rec.other.brand||'').toString().toUpperCase();
  const title = `Vat Pre-Check – #${rec.dairyNumber}`;
  const sub = `Brand: ${manu||'-'} • Spark: ${rec.signal.spark||'-'} • One NZ: ${rec.signal.one||'-'}`;

  const top = `
    <div class="print-card">
      <div class="print-label">Vat 1</div>
      <div>Capacity: <b>${rec.v1.size||'-'}</b></div>
      <div>Cap: <b>${rec.v1.cap||'-'}</b></div>
      <div>Serial: <b>${rec.v1.serial||'-'}</b></div>
      <div>Condition: <b>${rec.v1.condition||'-'}</b></div>
      <div>Agitator: ${rec.v1.agitator||'-'}</div>
      <div>Notes: ${rec.v1.notes||'-'}</div>
      <div>Cap comments: ${rec.v1.capComments||'-'}</div>
    </div>
    <div class="print-card">
      <div class="print-label">Vat 2</div>
      <div>Capacity: <b>${rec.v2.size||'-'}</b></div>
      <div>Cap: <b>${rec.v2.cap||'-'}</b></div>
      <div>Serial: <b>${rec.v2.serial||'-'}</b></div>
      <div>Condition: <b>${rec.v2.condition||'-'}</b></div>
      <div>Agitator: ${rec.v2.agitator||'-'}</div>
      <div>Notes: ${rec.v2.notes||'-'}</div>
      <div>Cap comments: ${rec.v2.capComments||'-'}</div>
    </div>
    <div class="print-card">
      <div class="print-label">Gateway</div>
      <div>Location: <b>${rec.gateway.location||'-'}</b></div>
      <div>Comments: ${rec.gateway.comments||'-'}</div>
    </div>
    <div class="print-card">
      <div class="print-label">Mobile Signal</div>
      <div>Spark: <b>${rec.signal.spark||'-'}</b></div>
      <div>One NZ: <b>${rec.signal.one||'-'}</b></div>
      <div>Preferred: <b>${(rec.signal.preferred||'').toUpperCase()||'-'}</b></div>
    </div>
    <div class="print-card">
      <div class="print-label">Other Telemetry</div>
      <div>Brand: <b>${rec.other.brand||'-'}</b> • Type: <b>${rec.other.type||'-'}</b></div>
      <div>Notes: ${rec.other.notes||'-'}</div>
    </div>
    <div class="print-card">
      <div class="print-label">Rubberware</div>
      <div>Door Seal: <b>${rec.rubber.doorDelivered==='Yes'?'Delivered':'No'}</b> ${rec.rubber.doorSize? '• '+rec.rubber.doorSize:''} ${rec.doorDeliveredCount? '(x'+rec.doorDeliveredCount+')':''}</div>
      <div>RJT: <b>${rec.rubber.rjtDelivered==='Yes'?'Delivered':'No'}</b> ${rec.rubber.rjtSize? '• '+rec.rubber.rjtSize:''}</div>
    </div>
  `;

  const photos = [ ['Gateway',rec.gateway.photo], ['Vat 1 Cap',rec.v1.photos.cap], ['Agitator 1',rec.v1.photos.agitator],
                   ['Vat 2 Cap',rec.v2.photos.cap], ['Agitator 2',rec.v2.photos.agitator],
                   ['Vat 1 Condition',rec.v1.photos.cond], ['Vat 2 Condition',rec.v2.photos.cond] ]
                   .filter(p=>!!p[1]).slice(0,4)
                   .map(([lab,src])=>`<div class="print-card"><div class="print-label">${lab}</div><div class="print-photos"><img src="${src}"></div></div>`).join('');

  return {title, sub, top, photos};
}
function openSheetModal(rec){
  $('print-title').textContent = `Vat Pre-Check – #${rec.dairyNumber}`;
  $('print-sub').textContent = `Brand: ${(rec.other.brand||'-').toString().toUpperCase()} • Spark: ${rec.signal.spark||'-'} • One NZ: ${rec.signal.one||'-'}`;
  const {top, photos} = sheetHTML(rec);
  $('print-grid-top').innerHTML = top;
  $('print-grid-bot').innerHTML = photos;
  $('printModal').style.display = 'flex';
}
$('btn-modal-close').onclick = ()=>{ $('printModal').style.display='none'; };
$('btn-modal-print').onclick = ()=>{ window.print(); };

window.openDetails = async (dn)=>{ const rec = await fetchRecord(dn); openSheetModal(rec); };
window.openPrint   = async (dn)=>{ const rec = await fetchRecord(dn); openSheetModal(rec); setTimeout(()=>window.print(), 300); };

/* ================= Summary background scan (for KPIs/Sizes) ================= */
async function scanForMetrics(){
  let done=0;
  for(const dn of CLOUD_KEYS){
    if(DATA.has(dn)){ done++; setPct(done,CLOUD_KEYS.length); continue; }
    try{ await fetchRecord(dn); }catch(e){}
    done++; $('fetched-count').textContent = DATA.size; setPct(done,CLOUD_KEYS.length);
  }
}

/* ================= Owners report (CSV) ================= */
function ownersCSV(){
  // Owner field may not exist; we include key farm details per your spec
  const rows = [['Dairy','Vat','Size','Serial','Cap','Condition','Notes','CapComments','Manufacturer','DoorDelivered','DoorSize','RJTDelivered','RJTSize','SparkBars','OneNZBars','GatewayLocation','OtherBrand','OtherType','OtherNotes']];
  for(const rec of DATA.values()){
    const manu = (rec.other.brand||'');
    const row1 = [rec.dairyNumber,'1',rec.v1.size,rec.v1.serial,rec.v1.cap,rec.v1.condition,rec.v1.notes,rec.v1.capComments,manu,rec.rubber.doorDelivered,rec.rubber.doorSize,rec.rubber.rjtDelivered,rec.rubber.rjtSize,rec.signal.spark,rec.signal.one,rec.gateway.location,rec.other.brand,rec.other.type,rec.other.notes];
    rows.push(row1);
    if(rec.v2.size || rec.v2.serial || rec.v2.cap!=='NA' || rec.v2.notes || rec.v2.capComments){
      rows.push([rec.dairyNumber,'2',rec.v2.size,rec.v2.serial,rec.v2.cap,rec.v2.condition,rec.v2.notes,rec.v2.capComments,manu,rec.rubber.doorDelivered,rec.rubber.doorSize,rec.rubber.rjtDelivered,rec.rubber.rjtSize,rec.signal.spark,rec.signal.one,rec.gateway.location,rec.other.brand,rec.other.type,rec.other.notes]);
    }
  }
  const csv = rows.map(r=>r.map(s=>String(s??'').replace(/"/g,'""')).map(s=>`"${s}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'}); saveAs(blob,'owners_report.csv');
}

/* ================= Download All (ZIP of brochure HTML) ================= */
async function downloadAllZip(){
  // Ensure DATA contains everything
  if(DATA.size !== CLOUD_KEYS.length){
    await scanForMetrics(); // sequential fetch with progress bar
  }
  const zip = new JSZip();
  let i=0;
  for(const dn of CLOUD_KEYS){
    const rec = DATA.get(dn); if(!rec) continue;
    const {title, sub, top, photos} = sheetHTML(rec);
    const html = `
<!doctype html><html><head><meta charset="utf-8"><title>${title}</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>${document.querySelector('style').innerHTML}</style></head>
<body><div class="print-sheet">
  <div class="print-head"><img src="${LOGO_URL}" style="height:44px"><div><div class="print-title">${title}</div><div class="print-sub">${sub}</div></div></div>
  <div class="print-grid">${top}</div>
  <div class="print-grid" style="margin-top:10px">${photos}</div>
</div></body></html>`;
    zip.file(`PreCheck_${dn}.html`, html);
    i++; setPct(i,CLOUD_KEYS.length);
  }
  const content = await zip.generateAsync({type:'blob'});
  saveAs(content, 'all_brochures_html.zip');
}

/* ================= Print All (single window, all sheets) ================= */
async function printAll(){
  if(DATA.size !== CLOUD_KEYS.length){
    await scanForMetrics();
  }
  const parts = [];
  for(const dn of CLOUD_KEYS){
    const rec = DATA.get(dn); if(!rec) continue;
    const {title, sub, top, photos} = sheetHTML(rec);
    parts.push(`
      <div class="print-sheet" style="page-break-after:always">
        <div class="print-head"><img src="${LOGO_URL}" style="height:44px"><div><div class="print-title">${title}</div><div class="print-sub">${sub}</div></div></div>
        <div class="print-grid">${top}</div>
        <div class="print-grid" style="margin-top:10px">${photos}</div>
      </div>
    `);
  }
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>All Brochures</title>
  <style>${document.querySelector('style').innerHTML}</style>
  </head><body>${parts.join('')}</body></html>`);
  w.document.close(); w.focus();
  setTimeout(()=>w.print(), 400);
}

/* ================= Form: load + save ================= */
async function loadIntoForm(dn){
  if(!dn) return;
  let rec;
  try{ rec = await fetchRecord(dn); }catch(e){ alert('Not found in cloud'); return; }

  // populate form from unified rec
  const set = (id,val)=>{ if($(id)!=null) $(id).value = val||''; };
  set('gateway-location', rec.gateway.location);
  set('gateway-comments', rec.gateway.comments);

  set('vat1-capacity', rec.v1.size); set('vat1-cap', rec.v1.cap);
  set('vat1-serial', rec.v1.serial); set('vat1-condition', rec.v1.condition);
  set('vat1-comments', rec.v1.notes); set('vat1-cap-comments', rec.v1.capComments);
  set('agitator1-location', rec.v1.agitator);

  set('vat2-capacity', rec.v2.size); toggleVat2Extra();
  set('vat2-cap', rec.v2.cap); set('vat2-serial', rec.v2.serial);
  set('vat2-condition', rec.v2.condition); set('vat2-comments', rec.v2.notes);
  set('vat2-cap-comments', rec.v2.capComments); set('agitator2-location', rec.v2.agitator);

  set('spark-bars', rec.signal.spark); set('one-bars', rec.signal.one); set('signal-preferred', rec.signal.preferred);

  set('other-brand', rec.other.brand); set('other-type', rec.other.type); set('other-notes', rec.other.notes);

  set('door-delivered', rec.rubber.doorDelivered); set('door-size', rec.rubber.doorSize);
  set('rjt-delivered', rec.rubber.rjtDelivered); set('rjt-size', rec.rubber.rjtSize);

  // hydrate previews (if any)
  const prev = (imgId,src)=>{ if($(imgId) && src){ $(imgId).src=src; $(imgId).classList.remove('d-none'); } };
  prev('gateway-preview', rec.gateway.photo);
  prev('vat1-cap-preview', rec.v1.photos.cap);
  prev('vat1-condition-preview', rec.v1.photos.cond);
  prev('agitator1-preview', rec.v1.photos.agitator);
  prev('vat2-cap-preview', rec.v2.photos.cap);
  prev('vat2-condition-preview', rec.v2.photos.cond);
  prev('agitator2-preview', rec.v2.photos.agitator);
  prev('door-preview', first(rec, ['door-photo-base64'])); // keep compatibility
  prev('rjt-preview', first(rec, ['rjt-photo-base64']));
}
$('dairyNumber').addEventListener('blur', e=> loadIntoForm((e.target.value||'').trim()));

async function gatherForm(){
  const dn = ($('dairyNumber').value||'').trim();
  if(!dn) throw new Error('Dairy # required');

  const data = {
    dairyNumber: dn,
    'gateway-location': $('gateway-location').value,
    'gateway-comments': $('gateway-comments').value,

    'vat1-capacity': $('vat1-capacity').value,
    'vat1-cap': $('vat1-cap').value,
    'vat1-serial': $('vat1-serial').value,
    'vat1-condition': $('vat1-condition').value,
    'vat1-comments': $('vat1-comments').value,
    'vat1-cap-comments': $('vat1-cap-comments').value,
    'agitator1-location': $('agitator1-location').value,

    'vat2-capacity': $('vat2-capacity').value,
    'vat2-cap': $('vat2-cap').value,
    'vat2-serial': $('vat2-serial').value,
    'vat2-condition': $('vat2-condition').value,
    'vat2-comments': $('vat2-comments').value,
    'vat2-cap-comments': $('vat2-cap-comments').value,
    'agitator2-location': $('agitator2-location').value,

    'spark-bars': $('spark-bars').value,
    'one-bars': $('one-bars').value,
    'signal-preferred': $('signal-preferred').value,

    'other-brand': $('other-brand').value,
    'other-type': $('other-type').value,
    'other-notes': $('other-notes').value,

    'door-delivered': $('door-delivered').value,
    'door-size': $('door-size').value,
    'rjt-delivered': $('rjt-delivered').value,
    'rjt-size': $('rjt-size').value,

    timestamp: Date.now()
  };

  // photos to base64
  data['gateway-photo-base64'] = await toB64($('gateway-photo'));
  data['vat1-cap-photo-base64'] = await toB64($('vat1-cap-photo'));
  data['vat1-condition-photo-base64'] = await toB64($('vat1-condition-photo'));
  data['agitator1-photo-base64'] = await toB64($('agitator1-photo'));
  data['vat2-cap-photo-base64'] = await toB64($('vat2-cap-photo'));
  data['vat2-condition-photo-base64'] = await toB64($('vat2-condition-photo'));
  data['agitator2-photo-base64'] = await toB64($('agitator2-photo'));
  data['vat-door-seal-photo-base64'] = await toB64($('door-photo'));
  data['rjt-photo-base64'] = await toB64($('rjt-photo'));

  if(!data['vat2-capacity']) data['vat2-cap']='NA';

  return data;
}
async function uploadJson(path, obj){
  const blob = new Blob([JSON.stringify(obj)], {type:'application/json'});
  await storage.ref(path).put(blob);
}
$('btn-save').onclick = async ()=>{
  try{
    $('saveSpinner').style.display = 'inline-block';
    const data = await gatherForm();
    await uploadJson(`${FOLDER}/${data.dairyNumber}.json`, data);
    // refresh in-memory DATA for that farm
    DATA.delete(data.dairyNumber);
    await fetchRecord(data.dairyNumber);
    alert('Saved ✔');
  }catch(e){ alert('Save failed: '+ (e.message||e)); }
  finally{ $('saveSpinner').style.display = 'none'; }
};
$('btn-print-current').onclick = async ()=>{
  const dn = ($('dairyNumber').value||'').trim();
  if(!dn){ alert('Enter a Dairy # first'); return; }
  await openPrint(dn);
};
$('btn-summary-jump').onclick = ()=>$('tab-summary').click();

/* ================= Admin buttons ================= */
$('btn-print-all').onclick = printAll;
$('btn-download-all').onclick = downloadAllZip;
$('btn-owners').onclick = ()=> ownersCSV();
$('btn-clear-cache').onclick = async ()=>{
  const keys = await caches.keys();
  await Promise.all(keys.map(k=>caches.delete(k)));
  alert('Service worker cache cleared.');
};

/* ================= Init ================= */
window.addEventListener('DOMContentLoaded', async ()=>{
  try{
    await listCloud();  // fast list of dairy numbers
  }catch(e){
    $('result-cards').innerHTML = '<div class="small-note">Could not list cloud folder.</div>';
  }
  // begin background scan for KPIs & sizes (does not block)
  scanForMetrics();
  // register service worker
  if('serviceWorker' in navigator){
    try{ await navigator.serviceWorker.register('sw.js'); }catch(e){}
  }
});
</script>
</body>
</html>