<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agora Vat Pre-Check</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js">
<link href="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">
<style>
  :root{--brand:#a7ab01;--ink:#1d2a3a;--muted:#6b7280;--accent:#FF851B;--danger:#e53935;--ok:#2E7D32;--card:#ffffff}
  body{background:#f7f8fb;color:var(--ink)}
  .container-main{max-width:1000px;margin:18px auto;padding:14px}
  h1{color:var(--brand);font-weight:800;text-align:center;margin:10px 0 14px}
  .tabs{display:flex;gap:10px;justify-content:center;margin-bottom:14px;flex-wrap:wrap}
  .tab-btn{border:1px solid #e5e7eb;border-radius:10px;padding:9px 14px;background:#fff;color:#111;font-weight:700}
  .tab-btn.active{background:var(--brand);color:#fff;border-color:#cbd5e1}
  .section{background:#fff;border-radius:14px;box-shadow:0 2px 22px #0000000d;padding:14px;margin-bottom:16px}
  .form-label{font-weight:600}
  .image-preview{display:none;max-width:220px;margin-top:6px;border:2px solid #e5e7eb;border-radius:8px}
  .chip{display:inline-block;padding:4px 10px;border:1px solid #ddd;border-radius:16px;margin-right:6px;cursor:pointer}
  .chip.active{border-color:var(--accent);color:var(--accent);font-weight:700}
  .kpi{border:1px solid #eee;border-radius:12px;padding:12px;background:#fff}
  .kpi .num{font-size:1.6rem;font-weight:800}
  .kpi .label{font-size:.95rem;color:var(--muted)}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  @media(max-width:900px){.grid-4{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:600px){.grid-4,.grid-3,.grid-2{grid-template-columns:1fr}}
  .tcard{border:1px solid #eee;border-radius:12px;background:#fff;padding:12px}
  .t-head{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .t-id{font-weight:800}
  .t-badges{display:flex;gap:6px;flex-wrap:wrap}
  .b{border:1px solid #e5e7eb;border-radius:10px;padding:2px 8px;font-size:.85rem}
  .b.ok{color:var(--ok);border-color:#cde9d5;background:#f3fbf5}
  .b.attn{color:#b53b00;border-color:#ffd2a6;background:#fff6ec}
  .b.warn{color:#b71c1c;border-color:#ffb2b2;background:#fff0f0}
  .thumb{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #eee}
  .load{color:var(--muted)}
  .btn-brand{background:var(--accent);color:#fff;border:none}
  .btn-brand:hover{background:#ff6d00}
  .small-note{color:var(--muted);font-size:.9rem}
</style>
</head>
<body>
<div class="container-main">
  <h1>Agora Vat Pre-Check</h1>

  <div class="tabs">
    <button class="tab-btn" id="tab-form" onclick="showTab('form')">üßæ Form</button>
    <button class="tab-btn" id="tab-summary" onclick="showTab('summary')">üü© Summary</button>
    <button class="tab-btn" id="tab-admin" onclick="showTab('admin')">‚¨áÔ∏è Admin</button>
  </div>

  <!-- FORM -->
  <div id="form-section" class="section">
    <div class="mb-2">
      <label class="form-label">Dairy Number</label>
      <input id="dairyNumber" class="form-control" placeholder="e.g. 12345" required>
    </div>

    <!-- ===== VAT (ordered first) ===== -->
    <div class="grid grid-2">
      <div>
        <label class="form-label">Vat 1 Cap</label>
        <select id="vat1-cap" class="form-select" onchange="togglePhoto('vat1-cap')">
          <option value="available" selected>Available ‚úì</option>
          <option value="unavailable">Unavailable ‚úó</option>
        </select>
        <input id="vat1-cap-comments" class="form-control mt-1" placeholder="Comments (optional)">
        <input id="vat1-cap-photo" type="file" accept="image/*" class="form-control mt-1" style="display:none" onchange="previewImage(event,'vat1-cap-preview')">
        <img id="vat1-cap-preview" class="image-preview">
      </div>

      <div>
        <label class="form-label">Vat 2 Cap</label>
        <select id="vat2-cap" class="form-select" onchange="togglePhoto('vat2-cap')">
          <option value="na" selected>N/A</option>
          <option value="available">Available ‚úì</option>
          <option value="unavailable">Unavailable ‚úó</option>
        </select>
        <input id="vat2-cap-comments" class="form-control mt-1" placeholder="Comments (optional)">
        <input id="vat2-cap-photo" type="file" accept="image/*" class="form-control mt-1" style="display:none" onchange="previewImage(event,'vat2-cap-preview')">
        <img id="vat2-cap-preview" class="image-preview">
      </div>

      <div>
        <label class="form-label">Vat 1 Condition</label>
        <select id="vat1-condition" class="form-select" onchange="toggleExtra('vat1')">
          <option value="ok" selected>OK</option>
          <option value="attention">Attention Required</option>
        </select>
        <div id="vat1-extra" style="display:none">
          <input id="vat1-condition-comments" class="form-control mt-1" placeholder="Describe issue">
          <input id="vat1-condition-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'vat1-condition-preview')">
          <img id="vat1-condition-preview" class="image-preview">
        </div>
      </div>

      <div>
        <label class="form-label">Vat 2 Condition</label>
        <select id="vat2-condition" class="form-select" onchange="toggleExtra('vat2')">
          <option value="na" selected>N/A</option>
          <option value="ok">OK</option>
          <option value="attention">Attention Required</option>
        </select>
        <div id="vat2-extra" style="display:none">
          <input id="vat2-condition-comments" class="form-control mt-1" placeholder="Describe issue">
          <input id="vat2-condition-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'vat2-condition-preview')">
          <img id="vat2-condition-preview" class="image-preview">
        </div>
      </div>

      <div>
        <label class="form-label">Vat 1 Serial #</label>
        <input id="vat1-serial" class="form-control" placeholder="e.g. ABC123">
      </div>
      <div>
        <label class="form-label">Vat 2 Serial #</label>
        <input id="vat2-serial" class="form-control" placeholder="N/A by default">
      </div>
    </div>

    <!-- ===== Agitator ===== -->
    <div class="mt-3">
      <label class="form-label">Agitator Sensor Location</label>
      <input id="agitator-location" class="form-control" placeholder="e.g. top LHS, baffle, etc.">
      <input id="agitator-comments" class="form-control mt-1" placeholder="Comments (optional)">
      <input id="agitator-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'agitator-preview')">
      <img id="agitator-preview" class="image-preview">
    </div>

    <!-- ===== Gateway ===== -->
    <div class="mt-3">
      <label class="form-label">Gateway Location</label>
      <input id="gateway-location" class="form-control" placeholder="e.g. plant room / office">
      <input id="gateway-comments" class="form-control mt-1" placeholder="Comments (optional)">
      <input id="gateway-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'gateway-preview')">
      <img id="gateway-preview" class="image-preview">
    </div>

    <!-- ===== Other Telemetry ===== -->
    <div class="mt-3">
      <label class="form-label">Current Telemetry</label>
      <input id="current-telemetry" class="form-control" placeholder="Brand/model or N/A">
      <input id="telemetry-comments" class="form-control mt-1" placeholder="Comments (optional)">
    </div>

    <!-- ===== Rubberware ===== -->
    <div class="mt-3">
      <div class="fw-bold mb-1" style="color:var(--brand)">Rubberware</div>

      <div class="grid grid-2">
        <div>
          <label class="form-label">Vat Door Seal</label>
          <select id="vat-door-seal" class="form-select" onchange="toggleDoorSeal()">
            <option value="notdelivered" selected>Not Delivered</option>
            <option value="delivered">Delivered</option>
          </select>
          <div id="door-extra" style="display:none">
            <select id="door-seal-size" class="form-select mt-1">
              <option value="">Select Size</option>
              <option value="small">Small</option>
              <option value="large">Large</option>
            </select>
            <input id="vat-door-seal-comments" class="form-control mt-1" placeholder="Notes (optional)">
            <input id="vat-door-seal-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'vat-door-seal-preview')">
            <img id="vat-door-seal-preview" class="image-preview">
          </div>
        </div>

        <div>
          <label class="form-label">RJT Step Seal</label>
          <select id="rjt-seal" class="form-select" onchange="toggleRJT()">
            <option value="notdelivered" selected>Not Delivered</option>
            <option value="delivered">Delivered</option>
          </select>
          <div id="rjt-extra" style="display:none">
            <select id="rjt-seal-size" class="form-select mt-1">
              <option value="">Select Size</option>
              <option value="small">Small</option>
              <option value="large">Large</option>
            </select>
            <input id="rjt-seal-comments" class="form-control mt-1" placeholder="Notes (optional)">
            <input id="rjt-seal-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'rjt-seal-preview')">
            <img id="rjt-seal-preview" class="image-preview">
          </div>
        </div>

        <div>
          <label class="form-label">Chiller Condition</label>
          <select id="chiller-condition" class="form-select" onchange="toggleChiller()">
            <option value="ok" selected>OK</option>
            <option value="attention">Attention Required</option>
          </select>
          <div id="chiller-extra" style="display:none">
            <input id="chiller-condition-comments" class="form-control mt-1" placeholder="Describe issue">
            <input id="chiller-condition-photo" type="file" accept="image/*" class="form-control mt-1" onchange="previewImage(event,'chiller-condition-preview')">
            <img id="chiller-condition-preview" class="image-preview">
          </div>
        </div>
      </div>
    </div>

    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-brand" onclick="saveForm();return false;">Save</button>
      <button class="btn btn-outline-secondary" onclick="window.location.reload()">Reset</button>
      <span class="small-note" id="save-msg"></span>
    </div>
  </div>

  <!-- SUMMARY -->
  <div id="summary-section" class="section" style="display:none">
    <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
      <span class="chip active" data-range="all" onclick="setRange(this)">All</span>
      <span class="chip" data-range="30" onclick="setRange(this)">30d</span>
      <span class="chip" data-range="90" onclick="setRange(this)">90d</span>
      <input id="summary-search" class="form-control" placeholder="Search Dairy # / text‚Ä¶" style="max-width:260px">
      <button class="btn btn-outline-secondary" onclick="renderSummary()">Apply</button>
    </div>

    <div class="grid grid-4 mb-2">
      <div class="kpi"><div id="kpi-total" class="num">0</div><div class="label">Total Farms</div></div>
      <div class="kpi"><div id="kpi-attn" class="num">0</div><div class="label">Any Attention</div></div>
      <div class="kpi"><div id="kpi-nocap" class="num">0</div><div class="label">No Available Cap</div></div>
      <div class="kpi"><div id="kpi-doors" class="num">0</div><div class="label">Door Seals Delivered</div></div>
    </div>

    <div id="summary-cards" class="grid grid-2"></div>
    <div id="summary-loading" class="load mt-2">Loading‚Ä¶</div>
    <div id="summary-error" class="text-danger mt-2" style="display:none"></div>
  </div>

  <!-- ADMIN (download only) -->
  <div id="admin-section" class="section" style="display:none">
    <div class="fw-bold mb-2">Export</div>
    <div class="d-flex gap-2">
      <button class="btn btn-brand" onclick="exportCSV()">Export CSV</button>
      <button class="btn btn-brand" onclick="exportXLSX()">Export XLSX</button>
    </div>
    <div class="small-note mt-2">Exports include normalized fields and rubberware delivered counts (e.g., if 2 vats ‚Üí ‚ÄúDoorSealsDelivered = 2‚Äù).</div>
  </div>
</div>

<!-- Firebase + libs -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/** ---------- Firebase ---------- **/
const firebaseConfig = {
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const FOLDER = "Pre Check";

/** ---------- UI tabs ---------- **/
function showTab(which){
  document.getElementById('form-section').style.display = which==='form'?'block':'none';
  document.getElementById('summary-section').style.display = which==='summary'?'block':'none';
  document.getElementById('admin-section').style.display = which==='admin'?'block':'none';
  document.getElementById('tab-form').classList.toggle('active', which==='form');
  document.getElementById('tab-summary').classList.toggle('active', which==='summary');
  document.getElementById('tab-admin').classList.toggle('active', which==='admin');
  if(which==='summary') renderSummary();
}
showTab('summary'); // default to Summary per your screenshot

/** ---------- Helpers ---------- **/
function byId(id){return document.getElementById(id)}
function previewImage(e, id){
  const img = byId(id); const file = e.target.files?.[0];
  if(!file){img.style.display='none';return}
  img.src = URL.createObjectURL(file); img.style.display='block';
}
function togglePhoto(prefix){
  const sel = byId(prefix);
  const input = byId(prefix+'-photo');
  const prev = byId(prefix+'-preview');
  const needs = sel.value==='unavailable';
  input.style.display = needs ? 'block':'none';
  if(!needs){ prev.style.display='none'; input.value=''; }
}
function toggleExtra(v){ const show = byId(v+'-condition').value==='attention'; byId(v+'-extra').style.display = show?'block':'none'; }
function toggleDoorSeal(){ const on = byId('vat-door-seal').value==='delivered'; byId('door-extra').style.display = on?'block':'none'; }
function toggleRJT(){ const on = byId('rjt-seal').value==='delivered'; byId('rjt-extra').style.display = on?'block':'none'; }
function toggleChiller(){ const on = byId('chiller-condition').value==='attention'; byId('chiller-extra').style.display = on?'block':'none'; }

/** Normalize free-text to simple tags (AI-ish rules without calling a model) */
function normTag(text){
  const s = (text||'').toLowerCase();
  if(!s) return [];
  const tags = [];
  // spelling & slang clusters
  if(/\bgrey|gray\b/.test(s) && /halo|ring/.test(s)) tags.push('Grey halo');
  if(/reducing cap|reduce cap|cap reduce|cap worn|cap split/.test(s) || /cap\b.*(worn|split|loose)/.test(s)) tags.push('Reducing cap');
  if(/sensor.*grey|gray/.test(s)) tags.push('Grey sensor');
  if(/power.?point|ppt|socket|outlet/.test(s)) tags.push('Powerpoint');
  if(/wiring|cable|loom/.test(s)) tags.push('Wiring');
  if(/leak|drip/.test(s)) tags.push('Leak');
  if(/corrosion|rust/.test(s)) tags.push('Corrosion');
  return [...new Set(tags)];
}

/** ---------- Save JSON (no local cache) ---------- **/
async function fileToDataURL(inputId){
  const inp = byId(inputId);
  if(!inp || !inp.files || !inp.files[0]) return '';
  const f = inp.files[0];
  return new Promise(res=>{
    const r=new FileReader();
    r.onload = e => res(e.target.result);
    r.readAsDataURL(f);
  });
}
async function saveForm(){
  const msg = byId('save-msg'); msg.textContent = 'Saving‚Ä¶';
  const dairy = (byId('dairyNumber').value||'').trim();
  if(!dairy){ msg.textContent='Enter dairy number.'; return; }

  // Defaults for Vat 2 as requested
  const data = {
    dairyNumber:dairy,
    createdAt: new Date().toISOString(),

    // VAT
    "vat1-cap": byId('vat1-cap').value,
    "vat1-cap-comments": byId('vat1-cap-comments').value,
    "vat1-cap-photo-base64": await fileToDataURL('vat1-cap-photo'),

    "vat2-cap": byId('vat2-cap').value || 'na',
    "vat2-cap-comments": byId('vat2-cap-comments').value,
    "vat2-cap-photo-base64": await fileToDataURL('vat2-cap-photo'),

    "vat1-condition": byId('vat1-condition').value,
    "vat1-condition-comments": byId('vat1-condition-comments')?.value||'',
    "vat1-condition-photo-base64": await fileToDataURL('vat1-condition-photo'),

    "vat2-condition": byId('vat2-condition').value || 'na',
    "vat2-condition-comments": byId('vat2-condition-comments')?.value||'',
    "vat2-condition-photo-base64": await fileToDataURL('vat2-condition-photo'),

    "vat1-serial": byId('vat1-serial').value,
    "vat2-serial": byId('vat2-serial').value || '',

    // Agitator
    "agitator-location": byId('agitator-location').value,
    "agitator-comments": byId('agitator-comments').value,
    "agitator-photo-base64": await fileToDataURL('agitator-photo'),

    // Gateway
    "gateway-location": byId('gateway-location').value,
    "gateway-comments": byId('gateway-comments').value,
    "gateway-photo-base64": await fileToDataURL('gateway-photo'),

    // Other telemetry
    "current-telemetry": byId('current-telemetry').value,
    "telemetry-comments": byId('telemetry-comments').value,

    // Rubberware
    "vat-door-seal": byId('vat-door-seal').value,
    "door-seal-size": byId('door-seal-size').value || '',
    "vat-door-seal-comments": byId('vat-door-seal-comments')?.value||'',
    "vat-door-seal-photo-base64": await fileToDataURL('vat-door-seal-photo'),

    "rjt-seal": byId('rjt-seal').value,
    "rjt-seal-size": byId('rjt-seal-size').value || '',
    "rjt-seal-comments": byId('rjt-seal-comments')?.value||'',
    "rjt-seal-photo-base64": await fileToDataURL('rjt-seal-photo'),

    "chiller-condition": byId('chiller-condition').value,
    "chiller-condition-comments": byId('chiller-condition-comments')?.value||'',
    "chiller-condition-photo-base64": await fileToDataURL('chiller-condition-photo')
  };

  try{
    const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
    await storage.ref(`${FOLDER}/${dairy}.json`).put(blob);
    msg.textContent = 'Saved ‚úî';
  }catch(e){
    console.error(e);
    msg.textContent = 'Save failed.';
  }
}

/** ---------- Cloud load (with timeout + errors) ---------- **/
async function listAllWithTimeout(ref, ms=15000){
  return Promise.race([
    ref.listAll(),
    new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout listing files')), ms))
  ]);
}
async function loadAllForms(){
  const results = [];
  try{
    const folderRef = storage.ref(FOLDER);
    const listing = await listAllWithTimeout(folderRef);
    const items = listing.items || [];
    if(!items.length) return results;
    // Fetch JSONs safely
    const jobs = items
      .filter(r=>/\.json$/i.test(r.name))
      .map(async r=>{
        try{
          const url = await r.getDownloadURL();
          const res = await fetch(url, {cache:'no-store'});
          const j = await res.json();
          return j;
        }catch(_){ return null; }
      });
    const arr = await Promise.all(jobs);
    return arr.filter(Boolean);
  }catch(err){
    throw err;
  }
}

/** ---------- Summary ---------- **/
let currentRange='all';
function setRange(el){
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active'); currentRange = el.dataset.range; renderSummary();
}
function inRange(iso){
  if(currentRange==='all') return true;
  const days = Number(currentRange)||0;
  const d = new Date(iso); const now=new Date();
  return (now - d) <= days*86400000;
}
function firstImage(rec){
  const keys = [
    'vat1-cap-photo-base64','vat2-cap-photo-base64','gateway-photo-base64',
    'agitator-photo-base64','vat1-condition-photo-base64','vat2-condition-photo-base64',
    'vat-door-seal-photo-base64','rjt-seal-photo-base64','chiller-condition-photo-base64'
  ];
  for(const k of keys){ if(rec[k]) return rec[k]; }
  return '';
}
function rubberDeliveredCount(rec){
  // Door seals: if delivered and two vats active (vat2-cap not 'na'), count 2, else 1
  let count = 0;
  if(rec['vat-door-seal']==='delivered'){
    const twoVats = (rec['vat2-cap'] && rec['vat2-cap']!=='na') || (rec['vat2-condition'] && rec['vat2-condition']!=='na') || (rec['vat2-serial']||'').trim();
    count += twoVats ? 2 : 1;
  }
  return count;
}
function collectTags(rec){
  const texts = [
    rec['vat1-cap-comments'],rec['vat2-cap-comments'],
    rec['vat1-condition-comments'],rec['vat2-condition-comments'],
    rec['gateway-comments'],rec['agitator-comments'],
    rec['telemetry-comments'],rec['vat-door-seal-comments'],rec['rjt-seal-comments'],
    rec['chiller-condition-comments']
  ].filter(Boolean).join(' ; ');
  const tags = normTag(texts);
  if(rec['vat1-cap']==='unavailable' || rec['vat2-cap']==='unavailable') tags.push('No cap');
  if(rec['vat1-condition']==='attention' || rec['vat2-condition']==='attention') tags.push('Vat attention');
  if(rec['chiller-condition']==='attention') tags.push('Chiller attention');
  return [...new Set(tags)];
}
function kpiSet(id, val){ byId(id).textContent = String(val); }

async function renderSummary(){
  byId('summary-loading').style.display='block';
  byId('summary-error').style.display='none';
  byId('summary-cards').innerHTML='';
  try{
    const all = await loadAllForms();
    const q = (byId('summary-search').value||'').toLowerCase();

    const filtered = all.filter(r=>{
      const okRange = inRange(r.createdAt || new Date().toISOString());
      const okText = !q || JSON.stringify(r).toLowerCase().includes(q);
      return okRange && okText;
    });

    // KPIs
    const total = filtered.length;
    const anyAttn = filtered.filter(r=>r['vat1-condition']==='attention' || r['vat2-condition']==='attention' || r['chiller-condition']==='attention').length;
    const noCap = filtered.filter(r=> (r['vat1-cap']==='unavailable') || (r['vat2-cap']==='unavailable')).length;
    const doorDelivered = filtered.reduce((a,r)=>a + rubberDeliveredCount(r), 0);

    kpiSet('kpi-total', total);
    kpiSet('kpi-attn', anyAttn);
    kpiSet('kpi-nocap', noCap);
    kpiSet('kpi-doors', doorDelivered);

    // Cards
    const wrap = byId('summary-cards');
    if(!filtered.length){
      wrap.innerHTML = '<div class="load">No records found.</div>';
      byId('summary-loading').style.display='none';
      return;
    }
    filtered.sort((a,b)=>String(a.dairyNumber).localeCompare(String(b.dairyNumber)));
    filtered.forEach(r=>{
      const img = firstImage(r);
      const tags = collectTags(r);
      const badges = [];
      badges.push(`<span class="b ${r['vat1-condition']==='attention'?'attn':'ok'}">Vat1 ${r['vat1-condition']||'ok'}</span>`);
      const v2 = r['vat2-condition']||'na';
      if(v2!=='na') badges.push(`<span class="b ${v2==='attention'?'attn':'ok'}">Vat2 ${v2}</span>`);
      if(r['chiller-condition']==='attention') badges.push(`<span class="b warn">Chiller</span>`);
      if(r['vat1-cap']==='unavailable' || r['vat2-cap']==='unavailable') badges.push(`<span class="b warn">No cap</span>`);
      if(r['vat-door-seal']==='delivered') badges.push(`<span class="b ok">Door seal ${rubberDeliveredCount(r)}</span>`);
      if(r['rjt-seal']==='delivered') badges.push(`<span class="b ok">RJT delivered</span>`);

      const t = `
        <div class="tcard">
          <div class="t-head">
            <div><div class="t-id">Dairy #${r.dairyNumber||''}</div><div class="text-muted" style="font-size:.9rem">${new Date(r.createdAt||Date.now()).toLocaleString()}</div></div>
            <div class="t-badges">${badges.join(' ')}</div>
          </div>
          <div class="mt-2" style="display:flex;gap:10px;align-items:center">
            ${img? `<img class="thumb" src="${img}">` : ''}
            <div class="small-note">${tags.length? ('Tags: '+tags.join(', ')) : '‚Äî'}</div>
          </div>
          <div class="mt-2 small-note"><b>Gateway:</b> ${r['gateway-location']||'-'} &nbsp; <b>Agitator:</b> ${r['agitator-location']||'-'}</div>
        </div>`;
      const shell = document.createElement('div'); shell.innerHTML=t; wrap.appendChild(shell.firstElementChild);
    });

    byId('summary-loading').style.display='none';
  }catch(err){
    console.error(err);
    byId('summary-error').style.display='block';
    byId('summary-error').textContent = 'Unable to load from Firebase Storage. Check path "Pre Check/*.json" and Storage rules. ('+err.message+')';
    byId('summary-loading').style.display='none';
  }
}

/** ---------- Exports ---------- **/
function flatten(rec){
  return {
    DairyNumber: rec.dairyNumber||'',
    CreatedAt: rec.createdAt||'',
    Vat1Cap: rec['vat1-cap']||'',
    Vat1CapComments: rec['vat1-cap-comments']||'',
    Vat2Cap: rec['vat2-cap']||'',
    Vat2CapComments: rec['vat2-cap-comments']||'',
    Vat1Condition: rec['vat1-condition']||'',
    Vat1CondComments: rec['vat1-condition-comments']||'',
    Vat2Condition: rec['vat2-condition']||'',
    Vat2CondComments: rec['vat2-condition-comments']||'',
    Vat1Serial: rec['vat1-serial']||'',
    Vat2Serial: rec['vat2-serial']||'',
    AgitatorLocation: rec['agitator-location']||'',
    AgitatorComments: rec['agitator-comments']||'',
    GatewayLocation: rec['gateway-location']||'',
    GatewayComments: rec['gateway-comments']||'',
    CurrentTelemetry: rec['current-telemetry']||'',
    TelemetryComments: rec['telemetry-comments']||'',
    DoorSeal: rec['vat-door-seal']||'',
    DoorSealSize: rec['door-seal-size']||'',
    RJTSeal: rec['rjt-seal']||'',
    RJTSealSize: rec['rjt-seal-size']||'',
    ChillerCondition: rec['chiller-condition']||'',
    ChillerComments: rec['chiller-condition-comments']||'',
    DoorSealsDelivered: rubberDeliveredCount(rec),
    Tags: collectTags(rec).join('; ')
  };
}
async function exportCSV(){
  const arr = await loadAllForms(); const flat = arr.map(flatten);
  if(!flat.length){alert('No data.');return}
  const headers = Object.keys(flat[0]);
  const rows = [headers.join(',')].concat(flat.map(o=>headers.map(h=>('"'+String(o[h]??'').replace(/"/g,'""')+'"')).join(',')));
  const blob = new Blob(["\uFEFF"+rows.join("\r\n")],{type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='vat_precheck_export.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
}
async function exportXLSX(){
  const arr = await loadAllForms(); const flat = arr.map(flatten);
  if(!flat.length){alert('No data.');return}
  const wb = XLSX.utils.book_new(); const ws = XLSX.utils.json_to_sheet(flat);
  XLSX.utils.book_append_sheet(wb, ws, 'PreCheck'); XLSX.writeFile(wb, 'vat_precheck_export.xlsx');
}
</script>
</body>
</html>