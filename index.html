<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Agora Vat Pre-Check</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root{
    --brand:#a7ab01; --ink:#0f1b2d; --muted:#6c7a90; --bg:#f6f8fb; --card:#fff;
    --navy:#0c2d57; --orange:#ff851b; --chip:#eef2f6; --radius:14px;
  }
  html,body{height:100%}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:24px auto;padding:0 14px}
  .brandbar{display:flex;align-items:center;gap:16px;margin-bottom:10px}
  .brandbar img{height:56px}
  .brand-title{font-weight:800;font-size:36px;line-height:1.02}
  .brand-sub{color:var(--muted)}
  .navpill .btn{border-radius:12px;font-weight:700;padding:10px 16px}
  .navpill .btn.active{background:var(--brand);border-color:var(--brand);color:#fff}
  .panel{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 22px rgba(15,27,45,.06);padding:18px}
  .section-h{font-weight:800;margin:0 0 10px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  @media(max-width:720px){.grid-2{grid-template-columns:1fr}.grid-3{grid-template-columns:1fr 1fr}}
  .card-block{border:1px solid #e7edf6;border-radius:12px;padding:14px;margin-bottom:12px;background:#fff}
  .preview{display:none;width:100%;border-radius:10px;border:1px solid #e7edf6;margin-top:6px}
  .summary-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px}
  .sumcard{background:#fff;border:1px solid #e7edf6;border-radius:14px;padding:16px;cursor:pointer}
  .sumcard:hover{box-shadow:0 8px 18px rgba(15,27,45,.08)}
  .farm-card{background:#fff;border:1px solid #e7edf6;border-radius:16px;padding:14px;margin-bottom:12px}
  .farm-top{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .farm-title{font-weight:800;font-size:20px}
  .badge-soft{background:var(--chip);border-radius:10px;padding:2px 8px;font-weight:700;color:#34425e}
  .btn-navy{background:var(--navy);border-color:var(--navy);color:#fff}
  .btn-orange{background:var(--orange);border-color:var(--orange);color:#fff}
  .muted{color:var(--muted)}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px}
  @media(max-width:640px){.kv{grid-template-columns:120px 1fr}}
  .thumbs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .thumbs img{width:100%;border-radius:8px;border:1px solid #e7edf6}
  .searchbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .hidden{display:none!important}
  .status{font-size:13px;color:#5a6a85}
  .error{color:#b00020}
  .hr-sm{margin:10px 0}
  /* sticky footer action bar */
  .sticky-save{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(246,248,251,0),var(--bg) 35%);padding-top:8px}
  .spinner{display:inline-flex;align-items:center;gap:8px}
</style>
</head>
<body>
<div class="wrap">

  <!-- Brand -->
  <div class="brandbar">
    <img id="agoraLogo" alt="agora" src="">
    <div>
      <div class="brand-title">Agora Vat<br>Pre-Check</div>
      <div class="brand-sub">Fast field capture • Smart summary • Customer-ready output</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="navpill mb-3">
    <div class="btn-group">
      <button class="btn btn-outline-secondary active" id="tabForm">Form</button>
      <button class="btn btn-outline-secondary" id="tabSummary">Summary</button>
      <button class="btn btn-outline-secondary" id="tabAdmin">Admin</button>
    </div>
  </div>

  <!-- ================= FORM ================= -->
  <section id="pageForm" class="panel">
    <h5 class="section-h">Create / Update Pre-Check</h5>

    <div class="card-block">
      <h6 class="mb-2 fw-bold">Dairy</h6>
      <div class="grid-2">
        <div>
          <label class="form-label">Dairy Number</label>
          <input id="dairyNumber" class="form-control" placeholder="e.g. 7016">
          <div class="form-text">Leave this field to auto-fill (values & photos) if found in cloud.</div>
        </div>
        <div class="align-self-end">
          <button class="btn btn-outline-secondary" id="btnPrintTop">Print</button>
        </div>
      </div>
    </div>

    <!-- Vat 1 -->
    <div class="card-block">
      <h6 class="fw-bold mb-2">Vat 1</h6>
      <div class="grid-2">
        <div><label class="form-label">Capacity (L)</label><input id="v1-cap" class="form-control" inputmode="numeric"></div>
        <div><label class="form-label">Cap</label><select id="v1-capAvail" class="form-select"><option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option></select></div>
        <div><label class="form-label">Condition</label><select id="v1-cond" class="form-select"><option value="ok">OK</option><option value="attention">Attention Required</option></select></div>
        <div><label class="form-label">Serial #</label><input id="v1-serial" class="form-control"></div>
        <div class="col-12"><label class="form-label">Comments</label><input id="v1-comments" class="form-control" placeholder="interior width, notes…"></div>
      </div>
      <div class="grid-3 mt-2">
        <div><label class="form-label">Cap Photo (if unavailable)</label><input type="file" id="v1-capPhoto" accept="image/*" class="form-control"><img id="v1-capPrev" class="preview"></div>
        <div><label class="form-label">Condition Photo</label><input type="file" id="v1-condPhoto" accept="image/*" class="form-control"><img id="v1-condPrev" class="preview"></div>
        <div>
          <label class="form-label">Agitator Location (Vat 1)</label><input id="ag1-loc" class="form-control" placeholder="e.g. rear left">
          <input type="file" id="ag1-photo" accept="image/*" class="form-control mt-2"><img id="ag1-prev" class="preview">
        </div>
      </div>
    </div>

    <!-- Vat 2 (revealed by capacity) -->
    <div class="card-block" id="blockVat2">
      <h6 class="fw-bold mb-2">Vat 2</h6>
      <div class="grid-2">
        <div><label class="form-label">Capacity (L)</label><input id="v2-cap" class="form-control" inputmode="numeric" placeholder="Enter to reveal more fields"></div>
        <div><label class="form-label">Cap</label><select id="v2-capAvail" class="form-select"><option value="na">N/A</option><option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option></select></div>
        <div><label class="form-label">Condition</label><select id="v2-cond" class="form-select"><option value="ok">OK</option><option value="attention">Attention Required</option></select></div>
        <div><label class="form-label">Serial #</label><input id="v2-serial" class="form-control"></div>
        <div class="col-12"><label class="form-label">Comments</label><input id="v2-comments" class="form-control"></div>
      </div>
      <div class="grid-3 mt-2">
        <div><label class="form-label">Cap Photo (if unavailable)</label><input type="file" id="v2-capPhoto" accept="image/*" class="form-control"><img id="v2-capPrev" class="preview"></div>
        <div><label class="form-label">Condition Photo</label><input type="file" id="v2-condPhoto" accept="image/*" class="form-control"><img id="v2-condPrev" class="preview"></div>
        <div>
          <label class="form-label">Agitator Location (Vat 2)</label><input id="ag2-loc" class="form-control" placeholder="e.g. front centre">
          <input type="file" id="ag2-photo" accept="image/*" class="form-control mt-2"><img id="ag2-prev" class="preview">
        </div>
      </div>
    </div>

    <div class="grid-2">
      <!-- Gateway -->
      <div class="card-block">
        <h6 class="fw-bold mb-2">Gateway</h6>
        <label class="form-label">Location</label><input id="gw-loc" class="form-control" placeholder="e.g. by chiller switchboard">
        <label class="form-label mt-2">Comments</label><input id="gw-comments" class="form-control">
        <input type="file" id="gw-photo" class="form-control mt-2" accept="image/*"><img id="gw-prev" class="preview">
      </div>

      <!-- Signal -->
      <div class="card-block">
        <h6 class="fw-bold mb-2">Signal</h6>
        <div class="grid-2">
          <div><label class="form-label">Spark bars</label><select id="spark" class="form-select"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
          <div><label class="form-label">One NZ bars</label><select id="one" class="form-select"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
        </div>
        <label class="form-label mt-2">Preferred</label>
        <select id="signal-pref" class="form-select"><option value="">—</option><option value="spark">Spark</option><option value="one">One NZ</option></select>
      </div>
    </div>

    <div class="grid-2">
      <!-- Other telemetry -->
      <div class="card-block">
        <h6 class="fw-bold mb-2">Other telemetry</h6>
        <label class="form-label">Brand</label><input id="tel-brand" class="form-control" placeholder="Halo, Levno, DTS, NDA…">
        <label class="form-label mt-2">Type</label><input id="tel-type" class="form-control" placeholder="vat, water, fuel…">
        <label class="form-label mt-2">Comments</label><input id="tel-comments" class="form-control">
      </div>

      <!-- Rubberware -->
      <div class="card-block">
        <h6 class="fw-bold mb-2">Rubberware</h6>
        <label class="form-label">Vat Door Seal</label>
        <select id="door" class="form-select"><option value="notdelivered">Not delivered</option><option value="delivered">Delivered</option></select>
        <div class="grid-2 mt-2">
          <div><label class="form-label">Door Seal Size</label><select id="door-size" class="form-select"><option value="">Unspecified</option><option value="small">Small</option><option value="large">Large</option></select></div>
          <div><label class="form-label">Count</label><input id="door-count" class="form-control" inputmode="numeric" placeholder="auto = vat count"></div>
        </div>
        <input type="file" id="door-photo" class="form-control mt-2" accept="image/*"><img id="door-prev" class="preview">
        <hr class="hr-sm">
        <label class="form-label">RJT Step Seal</label>
        <select id="rjt" class="form-select"><option value="notdelivered">Not delivered</option><option value="delivered">Delivered</option></select>
        <label class="form-label mt-2">RJT Size</label><select id="rjt-size" class="form-select"><option value="">Unspecified</option><option value="small">Small</option><option value="large">Large</option></select>
        <input type="file" id="rjt-photo" class="form-control mt-2" accept="image/*"><img id="rjt-prev" class="preview">
      </div>
    </div>

    <!-- Sticky bottom action bar -->
    <div class="sticky-save">
      <div class="d-flex align-items-center gap-2">
        <div class="spinner hidden" id="saveSpinner">
          <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
          <span class="small">Saving…</span>
        </div>
        <div class="ms-auto">
          <button class="btn btn-outline-secondary me-2" id="btnPrint">Print</button>
          <button class="btn btn-navy" id="btnSave">Save</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ================= SUMMARY ================= -->
  <section id="pageSummary" class="panel hidden">
    <div class="searchbar mb-2">
      <input id="q" class="form-control flex-grow-1" placeholder="Search dairy # or text…">
      <button class="btn btn-outline-secondary" id="btnApply">Apply</button>
      <span class="badge-soft">Cloud: <span id="cloudCount">0</span></span>
    </div>
    <div id="sumStatus" class="status mb-2"></div>
    <div id="overview" class="summary-cards mb-3"></div>
    <div id="filterNote" class="mb-2 hidden"></div>
    <div id="list"></div>
  </section>

  <!-- ================= ADMIN ================= -->
  <section id="pageAdmin" class="panel hidden">
    <h5 class="section-h">Admin</h5>
    <div class="mb-2 status">Load data for Summary: fetch from Firebase or load a local JSON dump.</div>
    <div class="d-flex flex-wrap gap-2 mb-2">
      <button class="btn btn-navy" id="btnFetchAll">Fetch ALL from Cloud</button>
      <button class="btn btn-outline-secondary" id="btnExportDump">Export merged JSON</button>
      <label class="btn btn-outline-primary mb-0">
        Load JSON file <input type="file" id="fileLoad" accept="application/json" hidden>
      </label>
    </div>
    <div class="progress mb-2" role="progressbar" aria-label="Fetch progress" style="height:10px;">
      <div id="progBar" class="progress-bar" style="width:0%"></div>
    </div>
    <div id="adminInfo" class="status"></div>
    <hr>
    <div class="kv">
      <div class="muted">Logo</div><div>Agora Logo/2F6-1YdaEP.jpeg</div>
      <div class="muted">Data folder</div><div>Pre Check/*.json</div>
    </div>
  </section>
</div>

<!-- libs -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ------------ Firebase ------------ */
const firebaseConfig = {
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

/* ------------ Helpers ------------ */
const $ = id=>document.getElementById(id);
const show = (el, on=true)=>{(typeof el==='string'?$(el):el).classList.toggle('hidden',!on)};
function setLogo(){ storage.ref("Agora Logo/2F6-1YdaEP.jpeg").getDownloadURL().then(u=>{$('agoraLogo').src=u}).catch(()=>{}); }
setLogo();

/* ------------ Router ------------ */
function go(tab){
  show('pageForm',tab==='form'); show('pageSummary',tab==='sum'); show('pageAdmin',tab==='adm');
  $('tabForm').classList.toggle('active',tab==='form');
  $('tabSummary').classList.toggle('active',tab==='sum');
  $('tabAdmin').classList.toggle('active',tab==='adm');
  if(tab==='sum') ensureSummaryData().then(renderSummary);
}
$('tabForm').onclick=()=>go('form');
$('tabSummary').onclick=()=>go('sum');
$('tabAdmin').onclick=()=>go('adm');

/* ------------ Dataset in memory ------------ */
let ALL = [];  // farms
const setStatus = (msg, isErr=false)=>{$('sumStatus').innerHTML = msg? `<span class="${isErr?'error':''}">${msg}</span>`:''};

/* ------------ Slang → signals ------------ */
function ai(text){
  const t = (text||'').toLowerCase();
  const dts = /\bdts\b|\bvent\s*cap\b|grey\s*halo|gray\s*halo|halo\s*sensor|nda\s*cap/.test(t);
  const needsPower = /(power\s*point|powerpoint|needs\s*pp|splitter\s*plug|double\s*adapter)/.test(t);
  const sp = (()=>{const m=t.match(/spark\s*(\d)\s*bars?/); return m?+m[1]:null})();
  const one = (()=>{const m=t.match(/(one\s?nz|vodafone)\s*(\d)\s*bars?/); return m?+m[2]:null})();
  let pref='';
  if(/spark\s*(best|preferred|ok)/.test(t)) pref='spark';
  if(/(one\s?nz|vodafone)\s*(best|preferred|ok)/.test(t)) pref='one';
  if(!pref && sp!=null && one!=null) pref = sp>one?'spark':one>sp?'one':'';
  return {dts,needsPower,sp,one,pref};
}

/* ------------ File preview helpers ------------ */
function wireFile(fid, pid){
  $(fid).addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f) return;
    const rd=new FileReader();
    rd.onload=ev=>{ const b64=ev.target.result; const img=$(pid); img.src=b64; img.style.display='block'; img.dataset.b64=b64; };
    rd.readAsDataURL(f);
  });
}
[['v1-capPhoto','v1-capPrev'],['v1-condPhoto','v1-condPrev'],['ag1-photo','ag1-prev'],
 ['v2-capPhoto','v2-capPrev'],['v2-condPhoto','v2-condPrev'],['ag2-photo','ag2-prev'],
 ['gw-photo','gw-prev'],['door-photo','door-prev'],['rjt-photo','rjt-prev']].forEach(w=>wireFile(...w));

function toggleVat2Block(){ const on = !!$('v2-cap').value.trim();
  ['v2-capAvail','v2-cond','v2-serial','v2-comments','v2-capPhoto','v2-condPhoto','ag2-loc','ag2-photo'].forEach(id=>{
    const el=$(id); el.disabled=!on; el.parentElement.style.opacity = on?1:.5;
  });
}
$('v2-cap').addEventListener('input',toggleVat2Block); toggleVat2Block();

/* ------------ Auto-fill (cloud) ------------ */
async function autofill(num){
  if(!num) return;
  try{
    const url = await storage.ref(`Pre Check/${num}.json`).getDownloadURL();
    const rec = await fetch(url).then(r=>r.json());
    rec.dairyNumber = rec.dairyNumber||num;
    const set=(id,val)=>{const el=$(id); if(el) el.value = (val??'');};
    set('v1-cap',rec['vat1-capacity']); set('v1-capAvail',rec['vat1-cap']); set('v1-cond',rec['vat1-condition']);
    set('v1-serial',rec['vat1-serial']); set('v1-comments',rec['vat1-comments']); set('ag1-loc',rec['agitator1-location']);
    set('v2-cap',rec['vat2-capacity']); set('v2-capAvail',rec['vat2-cap']||'na'); set('v2-cond',rec['vat2-condition']);
    set('v2-serial',rec['vat2-serial']); set('v2-comments',rec['vat2-comments']); set('ag2-loc',rec['agitator2-location']);
    toggleVat2Block();
    set('gw-loc',rec['gateway-location']); set('gw-comments',rec['gateway-comments']);
    set('spark',rec['spark-bars']||'0'); set('one',rec['one-bars']||'0'); set('signal-pref',rec['signal-preferred']||'');
    set('tel-brand',rec['telemetry-brand']); set('tel-type',rec['telemetry-type']); set('tel-comments',rec['telemetry-comments']);
    set('door',rec['vat-door-seal']||'notdelivered'); set('door-size',rec['door-seal-size']||''); set('door-count',rec['door-seal-count']||'');
    set('rjt',rec['rjt-seal']||'notdelivered'); set('rjt-size',rec['rjt-size']||'');

    function hyd(keys, imgId){ const src = keys.map(k=>rec[k]).find(Boolean); if(src){ const i=$(imgId); i.src=src; i.style.display='block'; i.dataset.b64=src; } }
    hyd(['vat1CapPhoto','vat1-cap-photo-base64'],'v1-capPrev');
    hyd(['vat1CondPhoto','vat1-condition-photo-base64'],'v1-condPrev');
    hyd(['agitator1Photo','agitator-photo-base64','agitator1-photo-base64'],'ag1-prev');
    hyd(['vat2CapPhoto','vat2-cap-photo-base64'],'v2-capPrev');
    hyd(['vat2CondPhoto','vat2-condition-photo-base64'],'v2-condPrev');
    hyd(['agitator2Photo','agitator2-photo-base64'],'ag2-prev');
    hyd(['gatewayPhoto','gateway-photo-base64'],'gw-prev');
    hyd(['doorSealPhoto','vat-door-seal-photo-base64'],'door-prev');
    hyd(['rjtPhoto','rjt-seal-photo-base64'],'rjt-prev');
  }catch(e){ /* not found ok */ }
}
$('dairyNumber').addEventListener('blur',e=>autofill(e.target.value.trim()));

/* ------------ Save to cloud (with spinner) ------------ */
function collect(){
  const d = {
    dairyNumber:$('dairyNumber').value.trim(), timestamp:Date.now(),
    'vat1-capacity':$('v1-cap').value.trim(), 'vat1-cap':$('v1-capAvail').value, 'vat1-condition':$('v1-cond').value,
    'vat1-serial':$('v1-serial').value.trim(), 'vat1-comments':$('v1-comments').value.trim(), 'agitator1-location':$('ag1-loc').value.trim(),
    'vat2-capacity':$('v2-cap').value.trim(), 'vat2-cap':$('v2-capAvail').value, 'vat2-condition':$('v2-cond').value,
    'vat2-serial':$('v2-serial').value.trim(), 'vat2-comments':$('v2-comments').value.trim(), 'agitator2-location':$('ag2-loc').value.trim(),
    'gateway-location':$('gw-loc').value.trim(), 'gateway-comments':$('gw-comments').value.trim(),
    'spark-bars':$('spark').value, 'one-bars':$('one').value, 'signal-preferred':$('signal-pref').value,
    'telemetry-brand':$('tel-brand').value.trim(), 'telemetry-type':$('tel-type').value.trim(), 'telemetry-comments':$('tel-comments').value.trim(),
    'vat-door-seal':$('door').value, 'door-seal-size':$('door-size').value, 'door-seal-count':$('door-count').value.trim(),
    'rjt-seal':$('rjt').value, 'rjt-size':$('rjt-size').value
  };
  if(!d['door-seal-count']){ let n=0; if(d['vat1-capacity']) n++; if(d['vat2-capacity']) n++; d['door-seal-count']=String(n||1); }
  function take(id,key){ const img=$(id); if(img && img.dataset.b64) d[key]=img.dataset.b64; }
  take('v1-capPrev','vat1CapPhoto'); take('v1-condPrev','vat1CondPhoto'); take('ag1-prev','agitator1Photo');
  take('v2-capPrev','vat2CapPhoto'); take('v2-condPrev','vat2CondPhoto'); take('ag2-prev','agitator2Photo');
  take('gw-prev','gatewayPhoto'); take('door-prev','doorSealPhoto'); take('rjt-prev','rjtPhoto');
  return d;
}
async function save(){
  const rec = collect();
  if(!rec.dairyNumber){ alert('Enter a dairy number'); return; }
  show('saveSpinner',true);
  try{
    const blob = new Blob([JSON.stringify(rec)],{type:'application/json'});
    await storage.ref(`Pre Check/${rec.dairyNumber}.json`).put(blob);
    // update in-memory if present
    const idx = ALL.findIndex(r=>String(r.dairyNumber)===String(rec.dairyNumber));
    if(idx>=0) ALL[idx]=rec;
    alert('Saved ✔');
  }catch(e){
    alert('Save failed');
  }finally{
    show('saveSpinner',false);
  }
}
$('btnSave').onclick = save;
$('btnPrint').onclick = ()=>{ const num=$('dairyNumber').value.trim(); const rec = ALL.find(r=>String(r.dairyNumber)===String(num)); if(rec) makePDF(rec); };
$('btnPrintTop').onclick = $('btnPrint').onclick;

/* ------------ Admin: Fetch ALL / Load dump / Export dump ------------ */
async function fetchAllFromCloud(){
  $('adminInfo').innerHTML = 'Listing cloud files…';
  $('progBar').style.width = '0%';
  try{
    const folder = storage.ref('Pre Check');
    const listing = await folder.listAll();
    $('cloudCount').innerText = listing.items.length;
    const files = listing.items;
    const out = [];
    for(let i=0;i<files.length;i++){
      const it = files[i];
      try{
        const url = await it.getDownloadURL();
        const rec = await fetch(url).then(r=>r.json());
        rec.dairyNumber = rec.dairyNumber || it.name.replace('.json','');
        out.push(rec);
      }catch(e){}
      $('progBar').style.width = ((i+1)/files.length*100)+'%';
    }
    out.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
    ALL = out;
    $('adminInfo').innerHTML = `Loaded <b>${ALL.length}</b> farms from cloud. Open <b>Summary</b>.`;
    setStatus('Data loaded from cloud. You can search/filter now.');
  }catch(err){
    $('adminInfo').innerHTML = `<span class="error">Error: could not read Firebase Storage (permissions?).</span>`;
  }
}
$('btnFetchAll').onclick = fetchAllFromCloud;

$('btnExportDump').onclick = ()=>{
  if(!ALL.length){ alert('Nothing loaded. Fetch or load JSON first.'); return; }
  const blob = new Blob([JSON.stringify(ALL,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='vat_precheck_dump.json'; a.click();
};
$('fileLoad').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  try{
    const data = JSON.parse(text);
    let arr = [];
    if(Array.isArray(data)) arr = data;
    else if(data && typeof data==='object') arr = Object.keys(data).map(k=>({dairyNumber:k, ...(data[k]||{})}));
    arr.forEach(r=>{ r.dairyNumber = r.dairyNumber || r.id || ''; });
    arr = arr.filter(r=>r.dairyNumber);
    arr.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
    ALL = arr;
    $('adminInfo').innerHTML = `Loaded <b>${ALL.length}</b> farms from local JSON. Open <b>Summary</b>.`;
    setStatus('Data loaded from local file. You can search/filter now.');
  }catch{
    $('adminInfo').innerHTML = '<span class="error">Invalid JSON file.</span>';
  }
});

/* ------------ Summary rendering ------------ */
function countsFrom(rows){
  let dts=0,pwr=0,sp=0,one=0,rub=0; const sizes=new Set();
  rows.forEach(f=>{
    const t=[f['vat1-comments'],f['vat2-comments'],f['gateway-comments'],f['telemetry-comments']].join(' ');
    const A=ai(t);
    if(/dts|vent/i.test(f['telemetry-brand']||'')) A.dts=true;
    if(A.dts) dts++;
    if(A.needsPower) pwr++;
    const sb=+((f['spark-bars']??A.sp) || 0), ob=+((f['one-bars']??A.one) || 0);
    const pref=(f['signal-preferred']||A.pref||'');
    if(pref==='spark'||(!pref&&sb>ob)) sp++;
    if(pref==='one'||(!pref&&ob>sb)) one++;
    if(f['vat-door-seal']==='delivered') rub+= +(f['door-seal-count']||1);
    if((f['vat1-capacity']||'').trim()) sizes.add(String(f['vat1-capacity']).trim());
    if((f['vat2-capacity']||'').trim()) sizes.add(String(f['vat2-capacity']).trim());
  });
  return {dts,pwr,sp,one,rub,sizes:[...sizes]};
}
function overviewHTML(stats){
  const items=[
    {id:'f_dts',n:stats.dts,txt:'DTS / Vent Caps'},
    {id:'f_pwr',n:stats.pwr,txt:'Power points needed'},
    {id:'f_sp',n:stats.sp,txt:'Spark preferred'},
    {id:'f_one',n:stats.one,txt:'One NZ preferred'},
    {id:'f_rub',n:stats.rub,txt:'Rubberware deliveries'},
    {id:'f_sz',n:stats.sizes.length,txt:'Distinct vat sizes'}
  ];
  return items.map(i=>`<div class="sumcard" data-k="${i.id}"><div class="n">${i.n}</div><div class="t">${i.txt}</div></div>`).join('');
}
function cardHTML(rec){
  const v1 = `Vat 1: ${rec['vat1-capacity']||'—'} L • Cap ${rec['vat1-cap']||'—'} • Cond ${rec['vat1-condition']||'—'} • SN ${rec['vat1-serial']||'—'}`;
  let v2 = '';
  if(rec['vat2-capacity'] && rec['vat2-cap']!=='na'){
    v2 = `Vat 2: ${rec['vat2-capacity']} L • Cap ${rec['vat2-cap']||'—'} • Cond ${rec['vat2-condition']||'—'} • SN ${rec['vat2-serial']||'—'}`;
  }
  const sig = `Signal: Spark ${rec['spark-bars']||0} bars • One NZ ${rec['one-bars']||0} bars • Pref ${rec['signal-preferred']||'—'}`;
  const rub = `Rubberware: Door seal ${rec['vat-door-seal']||'—'} (${rec['door-seal-size']||'unspecified'}, x${rec['door-seal-count']||'1'}) • RJT ${rec['rjt-seal']||'—'} ${rec['rjt-size']? '('+rec['rjt-size']+')':''}`;
  const pics=[['Gateway',rec.gatewayPhoto],['Vat 1 cap',rec.vat1CapPhoto],['Vat 1 condition',rec.vat1CondPhoto],
              ['Vat 2 cap',rec.vat2CapPhoto],['Vat 2 condition',rec.vat2CondPhoto],
              ['Agitator 1',rec.agitator1Photo],['Agitator 2',rec.agitator2Photo],
              ['Door seal',rec.doorSealPhoto],['RJT',rec.rjtPhoto]].filter(x=>!!x[1]);
  return `
  <div class="farm-card" data-dairy="${rec.dairyNumber}">
    <div class="farm-top">
      <div class="farm-title">#${rec.dairyNumber}</div>
      <div>
        <button class="btn btn-sm btn-outline-secondary me-1" data-print="${rec.dairyNumber}">Print</button>
        <button class="btn btn-sm btn-orange" data-details="${rec.dairyNumber}">Details</button>
      </div>
    </div>
    <div class="mt-1 muted">${v1}</div>
    ${v2?`<div class="muted mt-1">${v2}</div>`:''}
    <div class="muted mt-1">${sig}</div>
    <div class="muted mt-1">${rub}</div>
    ${pics.length?`<div class="thumbs mt-2">${pics.slice(0,3).map(p=>`<img alt="" src="${p[1]}">`).join('')}</div>`:''}
    <div class="hidden mt-2" id="det-${rec.dairyNumber}">
      <div class="kv">
        <div class="muted">Gateway</div><div>${rec['gateway-location']||'—'} ${rec['gateway-comments']?('• '+rec['gateway-comments']):''}</div>
        <div class="muted">Other telemetry</div><div>${rec['telemetry-brand']||'—'} • ${rec['telemetry-type']||'—'} • ${rec['telemetry-comments']||''}</div>
      </div>
      ${pics.length?`<hr class="hr-sm"><div class="grid-3">${pics.map(([lab,src])=>`<div><img src="${src}" class="w-100" style="border-radius:8px;border:1px solid #e7edf6"><div class="mt-1 small text-muted">${lab}</div></div>`).join('')}</div>`:''}
    </div>
  </div>`;
}
function bindCardButtons(container){
  container.querySelectorAll('[data-details]').forEach(btn=>{
    btn.onclick = e=>{
      const id = e.currentTarget.getAttribute('data-details');
      const div = $('det-'+id); div.classList.toggle('hidden');
    };
  });
  container.querySelectorAll('[data-print]').forEach(btn=>{
    btn.onclick = e=>{
      const id = e.currentTarget.getAttribute('data-print');
      const rec = ALL.find(r=>String(r.dairyNumber)===String(id));
      if(rec) makePDF(rec);
    };
  });
}

function renderSummary(){
  if(!ALL.length){
    setStatus('No data loaded. Click Admin → Fetch ALL from Cloud, or Load a JSON file.', true);
    $('overview').innerHTML=''; $('list').innerHTML=''; show('filterNote',false); return;
  }
  setStatus('');
  const stats = countsFrom(ALL);
  $('overview').innerHTML = overviewHTML(stats);
  [...$('overview').querySelectorAll('.sumcard')].forEach(el=>{
    el.onclick = ()=>{
      const k=el.dataset.k;
      let rows = ALL;
      if(k==='f_dts') rows = ALL.filter(f=>ai([f['vat1-comments'],f['vat2-comments'],f['telemetry-comments']].join(' ')).dts || /dts|vent/i.test(f['telemetry-brand']||''));
      if(k==='f_pwr') rows = ALL.filter(f=>ai([f['gateway-comments'],f['telemetry-comments']].join(' ')).needsPower);
      if(k==='f_sp') rows = ALL.filter(f=>{const sb=+(f['spark-bars']||0), ob=+(f['one-bars']||0); const p=f['signal-preferred']||''; return p==='spark'||(!p&&sb>ob);});
      if(k==='f_one') rows = ALL.filter(f=>{const sb=+(f['spark-bars']||0), ob=+(f['one-bars']||0); const p=f['signal-preferred']||''; return p==='one'||(!p&&ob>sb);});
      if(k==='f_rub') rows = ALL.filter(f=>f['vat-door-seal']==='delivered');
      if(k==='f_sz') rows = ALL;
      $('filterNote').innerHTML = `<span class="badge-soft">Showing ${rows.length} farms</span>`;
      show('filterNote',true);
      const box = $('list'); box.innerHTML = rows.map(cardHTML).join(''); bindCardButtons(box);
      window.scrollTo({top:0,behavior:'smooth'});
    };
  });
  const box=$('list'); box.innerHTML = ALL.slice(0,20).map(cardHTML).join(''); bindCardButtons(box);
}

/* Search */
$('btnApply').onclick = ()=>{
  if(!ALL.length){ setStatus('Load data first in Admin.', true); return; }
  const s = $('q').value.trim().toLowerCase();
  let rows = ALL;
  if(s){ rows = ALL.filter(f=>JSON.stringify(f).toLowerCase().includes(s)); }
  $('filterNote').innerHTML = `<span class="badge-soft">Showing ${rows.length} farms</span>`;
  show('filterNote',true);
  const box=$('list'); box.innerHTML = rows.map(cardHTML).join(''); bindCardButtons(box);
};

/* ------------ Print brochure (clean layout) ------------ */
async function makePDF(rec){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({orientation:'portrait',unit:'pt',format:'a4'});
  const W = pdf.internal.pageSize.getWidth();

  // Header
  try{ const u=$('agoraLogo').src; if(u) pdf.addImage(u,'JPEG',40,26,110,46);}catch(e){}
  pdf.setFont('helvetica','bold'); pdf.setFontSize(20); pdf.text('Vat Pre-Check',160,48);
  pdf.setFont('helvetica','normal'); pdf.setFontSize(11);
  pdf.text(`#${rec.dairyNumber}`,W-150,40); pdf.text(new Date(rec.timestamp||Date.now()).toISOString().slice(0,10),W-150,58);

  // Key Facts box
  pdf.setDrawColor(230); pdf.setFillColor(248,250,253); pdf.roundedRect(40,84,W-80,120,6,6,'FD');
  pdf.setFont('helvetica','bold'); pdf.text('Key Facts',54,106);
  pdf.setFont('helvetica','normal');

  const left = [
    ['Vat 1', `${rec['vat1-capacity']||'—'} L • Cap ${rec['vat1-cap']||'—'} • Cond ${rec['vat1-condition']||'—'} • SN ${rec['vat1-serial']||'—'}`],
    ['Gateway', `${rec['gateway-location']||'—'} ${rec['gateway-comments']?('• '+rec['gateway-comments']):''}`],
    ['Telemetry', `${rec['telemetry-brand']||'—'} • ${rec['telemetry-type']||'—'} ${rec['telemetry-comments']?('• '+rec['telemetry-comments']):''}`]
  ];
  const right = [
    ['Vat 2', (rec['vat2-capacity']&&rec['vat2-cap']!=='na')?`${rec['vat2-capacity']} L • Cap ${rec['vat2-cap']||'—'} • Cond ${rec['vat2-condition']||'—'} • SN ${rec['vat2-serial']||'—'}`:'—'],
    ['Signal', `Spark ${rec['spark-bars']||0} bars • One NZ ${rec['one-bars']||0} bars • Pref ${rec['signal-preferred']||'—'}`],
    ['Rubberware', `Door ${rec['vat-door-seal']||'—'} • Size ${rec['door-seal-size']||'unspecified'} • Count x${rec['door-seal-count']||'1'} | RJT ${rec['rjt-seal']||'—'} ${rec['rjt-size']? '('+rec['rjt-size']+')':''}`]
  ];
  let yL=126, yR=126;
  left.forEach(([k,v])=>{ pdf.setFont('helvetica','bold'); pdf.text(k+':',54,yL); pdf.setFont('helvetica','normal'); pdf.text(String(v),120,yL); yL+=20; });
  right.forEach(([k,v])=>{ pdf.setFont('helvetica','bold'); pdf.text(k+':',W/2+10,yR); pdf.setFont('helvetica','normal'); pdf.text(String(v),W/2+70,yR); yR+=20; });

  // Photos grid (3 per row)
  const pics=[['Gateway',rec.gatewayPhoto],['Vat 1 cap',rec.vat1CapPhoto],['Vat 1 condition',rec.vat1CondPhoto],
              ['Vat 2 cap',rec.vat2CapPhoto],['Vat 2 condition',rec.vat2CondPhoto],
              ['Agitator 1',rec.agitator1Photo],['Agitator 2',rec.agitator2Photo],
              ['Door seal',rec.doorSealPhoto],['RJT',rec.rjtPhoto]].filter(x=>!!x[1]);
  if(pics.length){
    let y = 230, x = 40, c = 0;
    const cw=(W-80-20)/3, ch=cw*0.62;
    for(const [lab,src] of pics){
      if(y+ch>770){ pdf.addPage(); y=60; }
      try{ pdf.addImage(src,'JPEG',x,y,cw,ch); }catch(e){}
      pdf.text(lab,x,y+ch+14);
      c++; x+=cw+10; if(c%3===0){ x=40; y+=ch+40; }
    }
  }
  pdf.save(`PreCheck_${rec.dairyNumber}.pdf`);
}

/* ------------ Auto load data for Summary on first open ------------ */
let triedAutoLoad = false;
async function ensureSummaryData(){
  if(ALL.length || triedAutoLoad) return;
  triedAutoLoad = true;
  try{
    const folder = storage.ref('Pre Check');
    const listing = await folder.listAll();
    $('cloudCount').innerText = listing.items.length;
    const files = listing.items.slice(0,200); // safety
    const out = [];
    for(let i=0;i<files.length;i++){
      const url = await files[i].getDownloadURL();
      const rec = await fetch(url).then(r=>r.json());
      rec.dairyNumber = rec.dairyNumber || files[i].name.replace('.json','');
      out.push(rec);
    }
    out.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
    ALL = out;
    setStatus(`Loaded ${ALL.length} farms from cloud.`);
  }catch(e){
    setStatus('Could not auto-load from cloud. Go to Admin → Load JSON or Fetch ALL.', true);
  }
}

/* ------------ Start ------------ */
document.addEventListener('DOMContentLoaded', ()=>{ go('form'); });
</script>
</body>
</html>
