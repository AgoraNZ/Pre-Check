<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Agora Vat Pre-Check</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">
<style>
  :root{
    --agora-green:#a7ab01; --agora-dark:#0b2a45; --chip:#f2f4f7;
  }
  body{background:#f7f9fc; color:#0b1b2b;}
  .brand {display:flex; gap:18px; align-items:center; margin:18px 0 10px;}
  .brand img{height:72px;}
  .brand h1{font-weight:800; line-height:1.05; margin:0; color:var(--agora-dark);}
  .brand small{display:block; color:#516079; font-weight:600}
  .tabbtn{border:2px solid #e6ebf2; background:#fff; border-radius:12px; padding:10px 16px; font-weight:700}
  .tabbtn.active{border-color:#ff8a00; box-shadow:0 0 0 2px #ffe7d0 inset}
  .panel{background:#fff; border:1px solid #e7edf5; border-radius:16px; padding:16px 16px;}
  .section-h{font-size:18px; font-weight:800; color:#1a2a3a; margin:8px 0 12px}
  .card-kpi{background:#fff; border:1px solid #e7edf5; border-radius:14px; padding:16px; cursor:pointer; transition:.15s}
  .card-kpi:hover{transform:translateY(-2px); box-shadow:0 6px 16px rgba(8,39,85,.05)}
  .kpi-num{font-size:34px; font-weight:800}
  .kpi-label{color:#516079}
  .farm-card{background:#fff;border:1px solid #e7edf5;border-radius:16px;padding:14px;margin-bottom:12px}
  .badge-soft{background:var(--chip); border-radius:10px; padding:2px 8px; font-weight:700; color:#415772}
  .thumb{width:100%; border-radius:10px; border:1px solid #e8eef6}
  .sticky-footer{position:sticky; bottom:0; background:#fff; border-top:1px solid #eaeef4; padding:8px}
  .chip{background:#eef3f7;border-radius:8px;padding:4px 8px;margin:2px 6px 2px 0;display:inline-block;font-weight:600}
  .progress{height:10px}
  .label-mini{font-size:12px;color:#5f728a}
  .modal-body img{border-radius:12px; margin-bottom:10px}
  .hidden{display:none!important}
</style>
</head>
<body>

<div class="container py-2">
  <!-- Brand header -->
  <div class="brand">
    <img id="logoImg" alt="agora logo" src="">
    <div>
      <h1>Agora Vat<br>Pre-Check</h1>
      <small>Fast field capture • Smart summary • Customer-ready output</small>
    </div>
  </div>

  <!-- Tabs -->
  <div class="d-flex gap-2 mb-2">
    <button id="tabForm" class="tabbtn">Form</button>
    <button id="tabSummary" class="tabbtn active">Summary</button>
    <button id="tabAdmin" class="tabbtn">Admin</button>
  </div>

  <!-- Counters + progress -->
  <div class="d-flex align-items-center gap-3 ms-1 mb-2">
    <span class="label-mini">Cloud: <b id="countCloud">0</b></span>
    <span class="label-mini">Cached: <b id="countCached">0</b></span>
    <span class="label-mini">New: <b id="countNew">0</b></span>
    <div class="flex-grow-1">
      <div class="progress"><div id="dlProgress" class="progress-bar" role="progressbar" style="width:0%"></div></div>
    </div>
  </div>

  <!-- SUMMARY PANEL -->
  <div id="viewSummary" class="panel">
    <div class="d-flex gap-2 flex-wrap mb-2">
      <input id="qSearch" class="form-control" placeholder="Search Dairy # / text…">
      <button id="btnApply" class="btn btn-outline-secondary">Apply</button>
      <button id="btnClear" class="btn btn-outline-light">Clear</button>
      <button id="btnExport" class="btn btn-outline-primary">Export Vat Sizes CSV</button>
    </div>

    <div class="section-h">Overview</div>
    <div class="row g-2 mb-2">
      <div class="col-6 col-md-3"><div id="kpiDts" class="card-kpi"><div class="kpi-num" data-n="0">0</div><div class="kpi-label">DTS Vent Caps</div></div></div>
      <div class="col-6 col-md-3"><div id="kpiPP" class="card-kpi"><div class="kpi-num" data-n="0">0</div><div class="kpi-label">Farms needing power point</div></div></div>
      <div class="col-6 col-md-3"><div id="kpiSpark" class="card-kpi"><div class="kpi-num" data-n="0">0</div><div class="kpi-label">Spark preferred</div></div></div>
      <div class="col-6 col-md-3"><div id="kpiOne" class="card-kpi"><div class="kpi-num" data-n="0">0</div><div class="kpi-label">One NZ preferred</div></div></div>
      <div class="col-6 col-md-3"><div id="kpiRub" class="card-kpi"><div class="kpi-num" data-n="0">0</div><div class="kpi-label">Rubberware deliveries</div></div></div>
      <div class="col-6 col-md-3"><div id="kpiSizes" class="card-kpi"><div class="kpi-num" data-n="0">0</div><div class="kpi-label">Distinct vat sizes</div></div></div>
      <div class="col-6 col-md-3"><div id="kpiNoCap" class="card-kpi"><div class="kpi-num" data-n="0">0</div><div class="kpi-label">No Available Cap</div></div></div>
      <div class="col-6 col-md-3"><div id="kpiAttention" class="card-kpi"><div class="kpi-num" data-n="0">0</div><div class="kpi-label">Any Attention</div></div></div>
    </div>

    <div class="section-h mt-3">Vat Size Breakdown</div>
    <div id="sizeChips" class="mb-2"></div>

    <div class="section-h mt-3">Farms</div>
    <div id="farmList"></div>
  </div>

  <!-- FORM PANEL -->
  <div id="viewForm" class="panel hidden">
    <div class="section-h">Create / Update Pre-Check</div>
    <div class="mb-2">
      <label class="form-label">Dairy Number</label>
      <input id="dairyNumber" class="form-control" placeholder="e.g. 7016">
    </div>

    <!-- Vat 1 group -->
    <div class="section-h">Vat 1</div>
    <div class="row g-2">
      <div class="col-md-4"><label class="form-label">Vat 1 Capacity (L)</label><input id="vat1-capacity" class="form-control" inputmode="numeric"></div>
      <div class="col-md-4"><label class="form-label">Vat 1 Cap</label>
        <select id="vat1-cap" class="form-select">
          <option value="available">Available ✓</option>
          <option value="unavailable">Unavailable ✗</option>
        </select>
      </div>
      <div class="col-md-4"><label class="form-label">Vat 1 Condition</label>
        <select id="vat1-condition" class="form-select">
          <option value="ok">OK</option><option value="attention">Attention Required</option>
        </select>
      </div>
      <div class="col-md-6"><label class="form-label">Vat 1 Serial</label><input id="vat1-serial" class="form-control"></div>
      <div class="col-md-6"><label class="form-label">Vat 1 Notes</label><input id="vat1-comments" class="form-control"></div>
      <div class="col-md-6"><label class="form-label">Agitator 1 Location</label><input id="agitator1-location" class="form-control"></div>
      <div class="col-md-6"><label class="form-label">Agitator 1 Photo</label><input id="agitator1-photo" type="file" accept="image/*" class="form-control"></div>
      <div class="col-12"><label class="form-label">Vat 1 Cap Photo</label><input id="vat1-cap-photo" type="file" accept="image/*" class="form-control"></div>
    </div>

    <!-- Vat 2 group (hidden until capacity entered) -->
    <div id="v2grp" class="mt-3 hidden">
      <div class="section-h">Vat 2</div>
      <div class="row g-2">
        <div class="col-md-4"><label class="form-label">Vat 2 Capacity (L)</label><input id="vat2-capacity" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Vat 2 Cap</label>
          <select id="vat2-cap" class="form-select">
            <option value="na">N/A</option><option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option>
          </select></div>
        <div class="col-md-4"><label class="form-label">Vat 2 Condition</label>
          <select id="vat2-condition" class="form-select"><option value="ok">OK</option><option value="attention">Attention Required</option></select></div>
        <div class="col-md-6"><label class="form-label">Vat 2 Serial</label><input id="vat2-serial" class="form-control"></div>
        <div class="col-md-6"><label class="form-label">Vat 2 Notes</label><input id="vat2-comments" class="form-control"></div>
        <div class="col-md-6"><label class="form-label">Agitator 2 Location</label><input id="agitator2-location" class="form-control"></div>
        <div class="col-md-6"><label class="form-label">Agitator 2 Photo</label><input id="agitator2-photo" type="file" accept="image/*" class="form-control"></div>
        <div class="col-12"><label class="form-label">Vat 2 Cap Photo</label><input id="vat2-cap-photo" type="file" accept="image/*" class="form-control"></div>
      </div>
    </div>

    <!-- Gateway -->
    <div class="section-h mt-3">Gateway</div>
    <div class="row g-2">
      <div class="col-md-6"><label class="form-label">Gateway Location</label><input id="gateway-location" class="form-control"></div>
      <div class="col-md-6"><label class="form-label">Gateway Comments</label><input id="gateway-comments" class="form-control"></div>
      <div class="col-12"><label class="form-label">Gateway Photo</label><input id="gateway-photo" type="file" accept="image/*" class="form-control"></div>
    </div>

    <!-- Mobile signal -->
    <div class="section-h mt-3">Mobile Signal</div>
    <div class="row g-2">
      <div class="col-md-6"><label class="form-label">Spark bars (0–4) + notes</label><input id="spark-signal" class="form-control" placeholder="e.g. 3 bars spark strong"></div>
      <div class="col-md-6"><label class="form-label">One NZ bars (0–4) + notes</label><input id="one-signal" class="form-control" placeholder="e.g. 2 bars one nz"></div>
    </div>

    <!-- Other telemetry -->
    <div class="section-h mt-3">Other Telemetry</div>
    <div class="row g-2">
      <div class="col-md-6"><label class="form-label">Brand</label><input id="tele-brand" class="form-control" placeholder="Halo, Levno, DTS, NDA…"></div>
      <div class="col-md-6"><label class="form-label">Type</label><input id="tele-type" class="form-control" placeholder="vat, water, fuel…"></div>
      <div class="col-12"><label class="form-label">Comments</label><input id="tele-comments" class="form-control"></div>
    </div>

    <!-- Rubberware -->
    <div class="section-h mt-3">Rubberware</div>
    <div class="row g-2">
      <div class="col-md-4"><label class="form-label">Door Seal</label>
        <select id="door-seal" class="form-select"><option value="notdelivered">Not delivered</option><option value="delivered">Delivered</option></select></div>
      <div class="col-md-4"><label class="form-label">Door Seal Size</label>
        <select id="door-seal-size" class="form-select"><option value="">Unspecified</option><option value="small">Small</option><option value="large">Large</option></select></div>
      <div class="col-md-4"><label class="form-label">Door Seal Photo</label><input id="door-seal-photo" type="file" accept="image/*" class="form-control"></div>
      <div class="col-md-6"><label class="form-label">RJT Step Seal</label>
        <select id="rjt-seal" class="form-select"><option value="notdelivered">Not delivered</option><option value="delivered">Delivered</option></select></div>
      <div class="col-md-6"><label class="form-label">RJT Size</label>
        <select id="rjt-size" class="form-select"><option value="">Unspecified</option><option value="small">Small</option><option value="large">Large</option></select></div>
      <div class="col-12"><label class="form-label">RJT Photo</label><input id="rjt-photo" type="file" accept="image/*" class="form-control"></div>
      <div class="col-12"><label class="form-label">Chiller Condition</label>
        <select id="chiller-condition" class="form-select"><option value="ok">OK</option><option value="attention">Attention Required</option></select></div>
      <div class="col-12"><label class="form-label">Chiller Photo</label><input id="chiller-photo" type="file" accept="image/*" class="form-control"></div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button id="btnSave" class="btn btn-primary">Save</button>
      <button id="btnPrint" class="btn btn-outline-secondary">Print Brochure</button>
      <button id="btnRefreshThis" class="btn btn-outline-dark">Refresh this farm from Cloud</button>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="viewAdmin" class="panel hidden">
    <div class="section-h">Admin</div>
    <div class="d-flex gap-2 flex-wrap">
      <button id="btnSync" class="btn btn-success">Sync from Cloud</button>
      <button id="btnWipe" class="btn btn-outline-danger">Clear Local Cache</button>
    </div>
    <div class="mt-2">
      <div id="log" class="small text-muted"></div>
    </div>
  </div>

  <div class="sticky-footer">
    <span class="label-mini">© Agora</span>
  </div>
</div>

<!-- Modals -->
<div class="modal fade" id="modalDetails" tabindex="-1">
  <div class="modal-dialog modal-fullscreen-md-down modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsTitle">Farm</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="detailsBody"></div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="btnModalPrint">Brochure PDF</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

<script>
/* -------------------- Firebase -------------------- */
const firebaseConfig = {
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

/* -------------------- Dexie (cache) -------------------- */
const db = new Dexie('VAT_PRECHECK_V2');
db.version(1).stores({
  forms: 'dairyNumber,timestamp',
  meta: 'key'
});

/* -------------------- UI helpers -------------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function show(view){
  $("#viewForm").classList.add("hidden");
  $("#viewSummary").classList.add("hidden");
  $("#viewAdmin").classList.add("hidden");
  $("#tabForm").classList.remove("active");
  $("#tabSummary").classList.remove("active");
  $("#tabAdmin").classList.remove("active");
  if(view==="form"){ $("#viewForm").classList.remove("hidden"); $("#tabForm").classList.add("active"); }
  if(view==="summary"){ $("#viewSummary").classList.remove("hidden"); $("#tabSummary").classList.add("active"); }
  if(view==="admin"){ $("#viewAdmin").classList.remove("hidden"); $("#tabAdmin").classList.add("active"); }
}

/* -------------------- Logo -------------------- */
let logoDataURL="";
(async function loadLogo(){
  try{
    const ref=storage.ref("Agora Logo/2F6-1YdaEP.jpeg");
    const url=await ref.getDownloadURL();
    const blob=await fetch(url).then(r=>r.blob());
    logoDataURL=await blobToDataURL(blob);
    $("#logoImg").src=url;
  }catch(e){console.warn("logo",e)}
})();

/* -------------------- AI normaliser -------------------- */
function norm(str){ return (str||"").toLowerCase(); }
function hasDtsCap(rec){
  // Any hint of grey/gray/halo/vent/dts cap
  const text = Object.values(rec).join(' ').toLowerCase();
  return /(grey|gray)\s*(halo|sensor)|dts\s*cap|vent\s*cap/.test(text);
}
function needsPowerPoint(rec){
  const t = Object.values(rec).join(' ').toLowerCase();
  // recommend power, plug, power point, outlet, splitter ok
  return /(power\s*point|outlet|gpo|needs\s*power|recommend(ed)?\s*power|splitter\s*(ok|can\s*be\s*used)|no\s*power\s*near)/.test(t);
}
function prefSpark(rec){
  const t = Object.values(rec).join(' ').toLowerCase();
  // Spark bars higher OR text says "spark better/prefer"
  const s = /spark[^0-9]*(\d)\s*bars?/.exec(t);
  const o = /(one\s*nz|vodafone)[^0-9]*(\d)\s*bars?/.exec(t);
  if(/spark.*(prefer|better|best)/.test(t)) return true;
  if(/(one\s*nz|vodafone).*(prefer|better|best)/.test(t)) return false;
  if(s && o){ return parseInt(s[1])>parseInt(o[2]); }
  return /spark.*3|spark.*4/.test(t);
}
function prefOne(rec){
  const t=Object.values(rec).join(' ').toLowerCase();
  const s=/spark[^0-9]*(\d)\s*bars?/.exec(t);
  const o=/(one\s*nz|vodafone)[^0-9]*(\d)\s*bars?/.exec(t);
  if(/(one\s*nz|vodafone).*(prefer|better|best)/.test(t)) return true;
  if(/spark.*(prefer|better|best)/.test(t)) return false;
  if(s && o){ return parseInt(o[2])>parseInt(s[1]); }
  return /(one\s*nz|vodafone).*(3|4)\s*bars?/.test(t);
}
function anyAttention(rec){
  return rec['vat1-condition']==='attention' || rec['vat2-condition']==='attention' || rec['chiller-condition']==='attention';
}

/* -------------------- Utilities -------------------- */
function blobToDataURL(blob){return new Promise(res=>{const r=new FileReader();r.onload=()=>res(r.result);r.readAsDataURL(blob);});}
function fileToDataURL(input, key, obj){const f=input.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ obj[key]=r.result; }; r.readAsDataURL(f);}

/* -------------------- Cache Sync -------------------- */
async function listCloudNames(){
  // Preferred: manifest
  try{
    const mref=storage.ref('Pre Check/manifest.json');
    const murl=await mref.getDownloadURL();
    const man=await fetch(murl).then(r=>r.json());
    return { via:'manifest', items:man.files.map(f=>({name:f.name, ts:f.timestamp||0})) };
  }catch(e){}
  // Fallback: listAll (names only)
  const folderRef=storage.ref('Pre Check');
  const res=await folderRef.listAll();
  return { via:'listAll', items: res.items.map(it=>({name:it.name})) };
}

async function ensureCache(){
  const cloud=await listCloudNames();
  const cached = await db.forms.toArray();
  const cachedNames = new Set(cached.map(x=>x.dairyNumber+'.json'));
  $("#countCached").innerText=cached.length;
  $("#countCloud").innerText=cloud.items.length;

  // Identify new
  const toFetch = cloud.items.filter(i=>!cachedNames.has(i.name));
  $("#countNew").innerText=toFetch.length;

  let done=0;
  for(const it of toFetch){
    done++;
    $("#dlProgress").style.width = Math.round(done/toFetch.length*100)+'%';
    try{
      const url=await storage.ref('Pre Check/'+it.name).getDownloadURL();
      const rec=await fetch(url).then(r=>r.json());
      if(!rec.dairyNumber) rec.dairyNumber = it.name.replace('.json','');
      await db.forms.put(rec);
    }catch(e){ console.warn('fetch',it.name,e); }
  }
}

async function refreshOne(dn){
  try{
    const url=await storage.ref('Pre Check/'+dn+'.json').getDownloadURL();
    const rec=await fetch(url).then(r=>r.json());
    await db.forms.put(rec);
  }catch(e){console.warn('refresh one',e)}
}

/* -------------------- Summary render -------------------- */
let ALL=[];
async function loadAllToMemory(){
  ALL = await db.forms.toArray();
}

function countDistinctSizes(){
  const set=new Set();
  ALL.forEach(r=>{ if(r['vat1-capacity']) set.add(r['vat1-capacity']); if(r['vat2-capacity']) set.add(r['vat2-capacity']); });
  return set.size;
}

function updateKPIs(){
  const counts={
    dts: ALL.filter(hasDtsCap).length,
    pp: ALL.filter(needsPowerPoint).length,
    spark: ALL.filter(prefSpark).length,
    one: ALL.filter(prefOne).length,
    rub: ALL.filter(r=>r['vat-door-seal']==='delivered'||r['rjt-seal']==='delivered').length,
    nocap: ALL.filter(r=>(r['vat1-cap'] && r['vat1-cap']!=='available')||(r['vat2-cap'] && r['vat2-cap']!=='available')).length,
    attn: ALL.filter(anyAttention).length,
    sizes: countDistinctSizes()
  };
  $("#kpiDts .kpi-num").innerText=counts.dts;
  $("#kpiPP .kpi-num").innerText=counts.pp;
  $("#kpiSpark .kpi-num").innerText=counts.spark;
  $("#kpiOne .kpi-num").innerText=counts.one;
  $("#kpiRub .kpi-num").innerText=counts.rub;
  $("#kpiNoCap .kpi-num").innerText=counts.nocap;
  $("#kpiAttention .kpi-num").innerText=counts.attn;
  $("#kpiSizes .kpi-num").innerText=counts.sizes;

  // chips for sizes
  const map={};
  ALL.forEach(r=>{
    if(r['vat1-capacity']) map[r['vat1-capacity']] = (map[r['vat1-capacity']]||0)+1;
    if(r['vat2-capacity']) map[r['vat2-capacity']] = (map[r['vat2-capacity']]||0)+1;
  });
  $("#sizeChips").innerHTML = Object.entries(map).sort((a,b)=>Number(a[0])-Number(b[0]))
    .map(([sz,c])=>`<span class="chip">${sz}L • ${c}</span>`).join('');
}

function renderFarms(list){
  const q=norm($("#qSearch").value);
  const filtered = list.filter(r=>{
    if(!q) return true;
    const s=JSON.stringify(r).toLowerCase();
    return s.includes(q);
  });
  $("#farmList").innerHTML = filtered.map(renderFarmCard).join('') || '<div class="text-muted">No farms.</div>';
  // attach buttons
  $$("#farmList .btn-brochure").forEach(btn=>btn.onclick=()=>printBrochure(btn.dataset.dn));
  $$("#farmList .btn-details").forEach(btn=>btn.onclick=()=>openDetails(btn.dataset.dn));
}

function renderFarmCard(r){
  const dn=r.dairyNumber||'';
  const v1 = r['vat1-capacity']||'—', v2=r['vat2-capacity']||'—';
  const pref = prefSpark(r)?'Spark' : (prefOne(r)?'One NZ':'—');
  const cap = ((r['vat1-cap']||'')==='available' && ((r['vat2-cap']||'na')==='available' || !r['vat2-capacity']))?'Available':'Check';
  const photos = collectPhotos(r).slice(0,3).map(p=>`<div class="col-4"><img class="thumb" src="${p.src}" alt="${p.label}"></div>`).join('');
  const att = anyAttention(r) ? `<span class="badge bg-danger">Attention</span>` : '';
  return `
    <div class="farm-card">
      <div class="d-flex justify-content-between">
        <div><b>#${dn}</b> <span class="badge-soft ms-1">${v1}L</span>${r['vat2-capacity']?` <span class="badge-soft ms-1">${v2}L</span>`:''} <span class="badge-soft ms-1">Cap: ${cap}</span></div>
        <div>${att}</div>
      </div>
      <div class="mt-1">
        <span class="badge-soft">Pref: ${pref}</span>
        ${hasDtsCap(r)?'<span class="badge-soft ms-1">DTS/Vent</span>':''}
        ${r['vat-door-seal']==='delivered'?'<span class="badge-soft ms-1">Door seal delivered</span>':''}
      </div>
      <div class="row g-2 mt-1">${photos}</div>
      <div class="mt-2 d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary btn-brochure" data-dn="${dn}">Brochure</button>
        <button class="btn btn-sm btn-outline-secondary btn-details" data-dn="${dn}">Details</button>
      </div>
    </div>`;
}

function collectPhotos(rec){
  const m = [
    ["agitator1-photo-base64","Agitator 1"],
    ["agitator2-photo-base64","Agitator 2"],
    ["gateway-photo-base64","Gateway"],
    ["door-seal-photo-base64","Door Seal"],
    ["rjt-photo-base64","RJT"],
    ["chiller-photo-base64","Chiller"],
    ["vat1-cap-photo-base64","Vat 1 Cap"],
    ["vat2-cap-photo-base64","Vat 2 Cap"]
  ];
  const out=[];
  for(const [k,label] of m){
    if(rec[k]) out.push({src:rec[k], label});
  }
  return out;
}

/* ----- KPI clicks -> filter list ----- */
$("#kpiDts").onclick = ()=>renderFarms(ALL.filter(hasDtsCap));
$("#kpiPP").onclick  = ()=>renderFarms(ALL.filter(needsPowerPoint));
$("#kpiSpark").onclick=()=>renderFarms(ALL.filter(prefSpark));
$("#kpiOne").onclick  = ()=>renderFarms(ALL.filter(prefOne));
$("#kpiRub").onclick  = ()=>renderFarms(ALL.filter(r=>r['vat-door-seal']==='delivered'||r['rjt-seal']==='delivered'));
$("#kpiNoCap").onclick= ()=>renderFarms(ALL.filter(r=>(r['vat1-cap']&&r['vat1-cap']!=='available')||(r['vat2-cap']&&r['vat2-cap']!=='available')));
$("#kpiAttention").onclick=()=>renderFarms(ALL.filter(anyAttention));
$("#kpiSizes").onclick=()=>renderFarms(ALL);

/* -------------------- Details modal -------------------- */
const modal = new bootstrap.Modal(document.getElementById('modalDetails'));
function openDetails(dn){
  const r = ALL.find(x=>String(x.dairyNumber)===String(dn));
  if(!r) return;
  $("#detailsTitle").innerText = `#${dn} • Vat Pre-Check`;
  const rows = Object.entries(r).filter(([k])=>!k.endsWith('base64'))
    .map(([k,v])=>`<tr><th class="text-capitalize">${k.replace(/-/g,' ')}</th><td>${v||''}</td></tr>`).join('');
  const photos = collectPhotos(r).map(p=>`<div><div class="label-mini">${p.label}</div><img class="w-100" src="${p.src}"></div>`).join('');
  $("#detailsBody").innerHTML = `
    <div class="row"><div class="col-lg-6"><table class="table table-sm">${rows}</table></div>
    <div class="col-lg-6">${photos||'<div class="text-muted">No photos</div>'}</div></div>`;
  $("#btnModalPrint").onclick = ()=>printBrochure(dn);
  modal.show();
}

/* -------------------- CSV Export -------------------- */
$("#btnExport").onclick = ()=>{
  const rows=[["Farm","Vat Size (L)","Serial","Manufacturer","Cap Available"]];
  ALL.forEach(r=>{
    [["vat1-capacity","vat1-serial"],["vat2-capacity","vat2-serial"]].forEach(([c,s])=>{
      const size=r[c]; if(!size) return;
      const manu = /dts|nda|westfalia|delaval|gea|packo/i.exec(JSON.stringify(r))?.[0]||"";
      const cap = (c==="vat1-capacity"?r['vat1-cap']:r['vat2-cap'])||"";
      rows.push([r.dairyNumber, size, r[s]||"", manu.toUpperCase(), cap]);
    });
  });
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='vat_sizes.csv'; a.click();
};

/* -------------------- Print brochure -------------------- */
async function printBrochure(dn){
  const r = ALL.find(x=>String(x.dairyNumber)===String(dn));
  if(!r) return;
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','pt','a4');

  // Header
  if(logoDataURL) pdf.addImage(logoDataURL,'JPEG',36,24,80,40);
  pdf.setFontSize(16); pdf.text("Vat Pre-Check", 130, 48);
  pdf.setFontSize(11); pdf.text(`#${dn}     ${new Date().toISOString().slice(0,10)}`, 130, 66);

  let y=100;
  pdf.setFontSize(12); pdf.text("Key Facts", 36, y); y+=8;
  const bullet = (lbl,val)=>{pdf.text(`${lbl}: ${val}`, 48, (y+=16));};

  bullet("Vat 1", `${r['vat1-capacity']||'—'}L • Cap ${r['vat1-cap']||'—'} • Cond ${r['vat1-condition']||'—'} • SN ${r['vat1-serial']||'—'}`);
  bullet("Vat 2", `${r['vat2-capacity']||'—'}L • Cap ${r['vat2-cap']||'—'} • Cond ${r['vat2-condition']||'—'} • SN ${r['vat2-serial']||'—'}`);
  bullet("Gateway", r['gateway-location']||'—');
  bullet("Signal", `Spark: ${(r['spark-signal']||'—')} • One NZ: ${(r['one-signal']||'—')} • Pref: ${prefSpark(r)?'Spark':prefOne(r)?'One NZ':'—'}`);
  bullet("Telemetry", `${r['tele-brand']||'—'} • ${r['tele-type']||'—'} • ${r['tele-comments']||''}`);
  bullet("Rubberware", `Door: ${r['vat-door-seal']||'notdelivered'} (Size ${r['door-seal-size']||'unspecified'}) • RJT: ${r['rjt-seal']||'notdelivered'}`);

  // Photos grid
  y+=16; pdf.setFontSize(12); pdf.text("Photos",36,y); y+=10;
  const pics = collectPhotos(r).slice(0,6);
  let x=36; const W=170, H=120, GAP=10;
  for(const p of pics){
    if(x+W>540){ x=36; y+=H+24;}
    if(y+H>770){ pdf.addPage(); y=36; x=36; }
    pdf.addImage(p.src,'JPEG',x,y,W,H); pdf.setFontSize(9); pdf.text(p.label, x, y+H+10);
    x+=W+GAP;
  }
  pdf.save('PreCheck_'+dn+'.pdf');
}

/* -------------------- Form logic -------------------- */
$("#vat1-capacity").addEventListener('input', ()=>{/*noop*/});
$("#vat2-capacity").addEventListener('input', ()=>{/*noop*/});
$("#dairyNumber").addEventListener('blur', async ()=>{
  const dn = $("#dairyNumber").value.trim();
  if(!dn) return;
  // from cache first
  let rec=await db.forms.get(dn);
  if(!rec){ await refreshOne(dn); rec=await db.forms.get(dn); }
  if(rec) fillForm(rec);
});

function fillForm(r){
  const set=(id,val)=>{const el=$(id); if(!el) return; el.value = val ?? '';};
  set("#vat1-capacity", r['vat1-capacity']);
  set("#vat1-cap", r['vat1-cap']||'available');
  set("#vat1-condition", r['vat1-condition']||'ok');
  set("#vat1-serial", r['vat1-serial']);
  set("#vat1-comments", r['vat1-comments']);
  set("#agitator1-location", r['agitator1-location']);
  set("#vat2-capacity", r['vat2-capacity']);
  if(r['vat2-capacity']) $("#v2grp").classList.remove('hidden'); else $("#v2grp").classList.add('hidden');
  set("#vat2-cap", r['vat2-cap']||'na');
  set("#vat2-condition", r['vat2-condition']||'ok');
  set("#vat2-serial", r['vat2-serial']);
  set("#vat2-comments", r['vat2-comments']);
  set("#agitator2-location", r['agitator2-location']);
  set("#gateway-location", r['gateway-location']);
  set("#gateway-comments", r['gateway-comments']);
  set("#spark-signal", r['spark-signal']);
  set("#one-signal", r['one-signal']);
  set("#tele-brand", r['tele-brand']);
  set("#tele-type", r['tele-type']);
  set("#tele-comments", r['tele-comments']);
  set("#door-seal", r['vat-door-seal']||'notdelivered');
  set("#door-seal-size", r['door-seal-size']||'');
  set("#rjt-seal", r['rjt-seal']||'notdelivered');
  set("#rjt-size", r['rjt-size']||'');
  set("#chiller-condition", r['chiller-condition']||'ok');
}

$("#vat2-capacity").addEventListener('input', ()=>{
  $("#v2grp").classList.toggle('hidden', !$("#vat2-capacity").value.trim());
});

$("#btnSave").onclick = async ()=>{
  const dn=$("#dairyNumber").value.trim(); if(!dn) {alert('Enter Dairy #');return;}
  const data={
    dairyNumber: dn,
    'vat1-capacity': $("#vat1-capacity").value.trim(),
    'vat1-cap': $("#vat1-cap").value,
    'vat1-condition': $("#vat1-condition").value,
    'vat1-serial': $("#vat1-serial").value,
    'vat1-comments': $("#vat1-comments").value,
    'agitator1-location': $("#agitator1-location").value,
    'vat2-capacity': $("#vat2-capacity").value.trim(),
    'vat2-cap': $("#vat2-cap").value,
    'vat2-condition': $("#vat2-condition").value,
    'vat2-serial': $("#vat2-serial").value,
    'vat2-comments': $("#vat2-comments").value,
    'agitator2-location': $("#agitator2-location").value,
    'gateway-location': $("#gateway-location").value,
    'gateway-comments': $("#gateway-comments").value,
    'spark-signal': $("#spark-signal").value,
    'one-signal': $("#one-signal").value,
    'tele-brand': $("#tele-brand").value,
    'tele-type': $("#tele-type").value,
    'tele-comments': $("#tele-comments").value,
    'vat-door-seal': $("#door-seal").value,
    'door-seal-size': $("#door-seal-size").value,
    'rjt-seal': $("#rjt-seal").value,
    'rjt-size': $("#rjt-size").value,
    'chiller-condition': $("#chiller-condition").value,
    timestamp: Date.now()
  };
  // photos (if chosen)
  await Promise.all([
    fileToDataURL($("#agitator1-photo"), 'agitator1-photo-base64', data),
    fileToDataURL($("#agitator2-photo"), 'agitator2-photo-base64', data),
    fileToDataURL($("#gateway-photo"), 'gateway-photo-base64', data),
    fileToDataURL($("#door-seal-photo"), 'door-seal-photo-base64', data),
    fileToDataURL($("#rjt-photo"), 'rjt-photo-base64', data),
    fileToDataURL($("#chiller-photo"), 'chiller-photo-base64', data),
    fileToDataURL($("#vat1-cap-photo"), 'vat1-cap-photo-base64', data),
    fileToDataURL($("#vat2-cap-photo"), 'vat2-cap-photo-base64', data)
  ]);

  await db.forms.put(data);
  // push JSON to Storage
  const blob=new Blob([JSON.stringify(data)], {type:'application/json'});
  await storage.ref(`Pre Check/${dn}.json`).put(blob);
  alert('Saved.');
  await loadAllToMemory(); updateKPIs(); renderFarms(ALL);
};

$("#btnPrint").onclick=()=>{ const dn=$("#dairyNumber").value.trim(); if(dn) printBrochure(dn); };
$("#btnRefreshThis").onclick= async ()=>{ const dn=$("#dairyNumber").value.trim(); if(!dn) return; await refreshOne(dn); const r=await db.forms.get(dn); if(r) fillForm(r); };

/* -------------------- Admin buttons -------------------- */
$("#btnSync").onclick = async ()=>{
  $("#log").innerText="Syncing…";
  await ensureCache();
  await loadAllToMemory(); updateKPIs(); renderFarms(ALL);
  $("#log").innerText="Done.";
};
$("#btnWipe").onclick = async ()=>{
  if(!confirm('Clear local cache?')) return;
  await db.forms.clear(); await db.meta.clear();
  $("#countCached").innerText='0';
  $("#countNew").innerText='0';
  $("#dlProgress").style.width='0%';
};

/* -------------------- Search apply/clear -------------------- */
$("#btnApply").onclick=()=>renderFarms(ALL);
$("#btnClear").onclick=()=>{ $("#qSearch").value=''; renderFarms(ALL); };

/* -------------------- Tabs -------------------- */
$("#tabForm").onclick = ()=>show('form');
$("#tabSummary").onclick = ()=>{ show('summary'); };
$("#tabAdmin").onclick = ()=>show('admin');

/* -------------------- Boot -------------------- */
(async function boot(){
  show('summary');
  // auto-sync (only new) on load
  await ensureCache();
  await loadAllToMemory();
  updateKPIs();
  renderFarms(ALL);
})();
</script>
</body>
</html>