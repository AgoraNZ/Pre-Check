<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Agora Vat Pre-Check</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">
<style>
  :root{
    --brand:#a7ab01; --ink:#0f1b2a; --muted:#6b7785; --chip:#eef2f6; --card:#ffffff;
    --accent:#FF851B; --accent2:#FF4136; --pill:#002B5C;
  }
  body{background:#f6f8fb;color:var(--ink);}
  .brand{color:var(--brand)!important}
  .tab-link{font-weight:700;border-radius:12px;padding:.6rem 1rem;background:#f2f4ea;color:#506000}
  .tab-link.active{background:var(--brand);color:#fff}
  .wrap{max-width:980px;margin:auto}
  .pane{display:none}
  .card-lite{background:var(--card);border-radius:18px;box-shadow:0 2px 14px rgba(16,24,40,.06);padding:18px}
  .kpi{font-size:2.2rem;font-weight:800}
  .kpi-sub{color:#374151}
  .pill{display:inline-block;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:.1rem .5rem;font-weight:700}
  .pill.attn{color:#b91c1c;background:#fee2e2;border-color:#fecaca}
  .pill.ok{color:#166534;background:#dcfce7;border-color:#bbf7d0}
  .btn-brand{background:var(--accent);border:none}
  .btn-brand:hover{background:var(--accent2)}
  .farm-card{border:1px solid #e5e7eb;border-radius:18px;background:#fff;padding:16px;margin-bottom:12px}
  .farm-title{font-weight:800;font-size:1.05rem}
  .badge-chip{background:var(--chip);border-radius:10px;padding:.15rem .45rem;margin-right:.25rem;font-size:.8rem}
  .photo{width:100%;border-radius:10px;margin:8px 0}
  .stat-chip{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:14px 16px;margin-bottom:14px}
  .progress{height:10px;border-radius:999px}
  .sticky-header{position:sticky;top:0;background:#f6f8fb;z-index:10;padding-top:8px;padding-bottom:6px}
  .modal-photo{width:100%;border-radius:12px;margin:6px 0}
  .grid-2{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div class="wrap p-3 p-md-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="brand fw-bold">Agora Vat Pre-Check</h1>
    <div class="d-flex gap-2">
      <button class="tab-link" id="tabForm">üìù Form</button>
      <button class="tab-link active" id="tabSummary">üü© Summary</button>
      <button class="tab-link" id="tabAdmin">‚¨áÔ∏è Admin</button>
    </div>
  </div>

  <!-- SUMMARY -->
  <section id="paneSummary" class="pane" style="display:block">
    <div class="card-lite mb-3">
      <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
        <div class="btn-group" role="group">
          <input type="radio" class="btn-check" name="datewin" id="dAll" checked>
          <label class="btn btn-outline-secondary" for="dAll">All</label>
          <input type="radio" class="btn-check" name="datewin" id="d30">
          <label class="btn btn-outline-secondary" for="d30">30d</label>
          <input type="radio" class="btn-check" name="datewin" id="d90">
          <label class="btn btn-outline-secondary" for="d90">90d</label>
        </div>
        <input class="form-control" id="searchText" placeholder="Search Dairy # / text‚Ä¶" style="max-width:360px">
        <button class="btn btn-outline-secondary" id="btnApply">Apply</button>
        <button class="btn btn-outline-secondary" id="btnClear">Clear</button>
        <button class="btn btn-outline-primary ms-auto" id="btnCSV">Export Vat Sizes CSV</button>
      </div>
      <div class="grid-2">
        <div class="stat-chip"><div class="kpi" id="kpiTotal">0</div><div class="kpi-sub">Total Farms</div></div>
        <div class="stat-chip"><div class="kpi" id="kpiAttention">0</div><div class="kpi-sub">Any Attention</div></div>
        <div class="stat-chip"><div class="kpi" id="kpiNoCap">0</div><div class="kpi-sub">No Available Cap</div></div>
        <div class="stat-chip"><div class="kpi" id="kpiSeals">0</div><div class="kpi-sub">Door Seals Delivered</div></div>
        <div class="stat-chip clickable" id="cardDTS"><div class="kpi" id="kpiDTS">0</div><div class="kpi-sub">DTS / Vent Caps</div></div>
        <div class="stat-chip clickable" id="cardPP"><div class="kpi" id="kpiPP">0</div><div class="kpi-sub">Power Points Needed</div></div>
        <div class="stat-chip clickable" id="cardSignalSpark"><div class="kpi" id="kpiSpark">0</div><div class="kpi-sub">Prefer Spark</div></div>
        <div class="stat-chip clickable" id="cardSignalOne"><div class="kpi" id="kpiOne">0</div><div class="kpi-sub">Prefer One NZ</div></div>
        <div class="stat-chip clickable" id="cardRubberware"><div class="kpi" id="kpiRubber">0</div><div class="kpi-sub">Rubberware Deliveries (click)</div></div>
      </div>
    </div>

    <div class="card-lite mb-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="fw-bold">Local Cache</div>
        <div><span id="cacheCount" class="badge bg-light text-dark">0</span> / <span id="cloudCount" class="badge bg-light text-dark">0</span> downloaded</div>
      </div>
      <div class="progress mb-2"><div class="progress-bar" id="cacheProg" role="progressbar" style="width:0%"></div></div>
      <div class="d-flex gap-2">
        <button class="btn btn-brand" id="btnSync">Download / Refresh from Cloud</button>
        <button class="btn btn-outline-secondary" id="btnWipe">Clear Local Cache</button>
      </div>
      <div class="small text-muted mt-2" id="syncStatus">Idle</div>
    </div>

    <div id="summaryBuckets" class="mb-3"></div>
    <div id="farmList"></div>
  </section>

  <!-- FORM (kept minimal; your existing form can live here) -->
  <section id="paneForm" class="pane">
    <div class="card-lite">
      <div class="h5 mb-3">Field Form (unchanged core fields; ‚Äúlevel‚Äù fields removed)</div>
      <p class="text-muted">This build focuses on Summary / Admin. Keep your existing form code here or continue using your live form page.</p>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="paneAdmin" class="pane">
    <div class="card-lite">
      <div class="h5">Admin ‚Äî Cloud Download Only</div>
      <p class="text-muted">This page only downloads JSON from the bucket to the device cache used by Summary.</p>
      <button class="btn btn-brand" id="btnAdminSync">Download Now</button>
    </div>
  </section>
</div>

<!-- Modals -->
<div class="modal fade" id="modalDetails" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="modalTitle">Farm</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.11/dayjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.11/plugin/relativeTime.min.js"></script>
<script>dayjs.extend(window.dayjs_plugin_relativeTime)</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

<script>
/* ---------- Firebase ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain: "dairy-farm-record-system.firebaseapp.com",
  projectId: "dairy-farm-record-system",
  storageBucket: "dairy-farm-record-system.appspot.com",
  messagingSenderId: "422124188212",
  appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

/* ---------- Dexie ---------- */
const db = new Dexie('VatPreCheckCache');
db.version(1).stores({
  forms: 'dairyNumber,timestamp'   // cache of cloud forms
});

/* ---------- UI Tabs ---------- */
const panes = {
  tabForm: 'paneForm',
  tabSummary: 'paneSummary',
  tabAdmin: 'paneAdmin'
};
for (const id in panes){
  document.getElementById(id).onclick = () => {
    document.querySelectorAll('.tab-link').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.pane').forEach(p=>p.style.display='none');
    document.getElementById(panes[id]).style.display='block';
  }
}

/* ---------- Helpers ---------- */
const safe = v => (v ?? '').toString().trim();
const asLower = v => safe(v).toLowerCase();

function normalizeManufacturer(txt){
  const t = asLower(txt);
  if(/dts/.test(t)) return 'DTS';
  if(/\bnda\b/.test(t)) return 'NDA';
  if(/delaval|de laval/.test(t)) return 'DeLaval';
  if(/packo/.test(t)) return 'Packo';
  if(/mueller/.test(t)) return 'Mueller';
  return '';
}

/* --- AI-ish tagger (rule-based NLP for offline) --- */
function aiTags(rec){
  // Collect all free text
  const texts = [
    rec['vat1-cap-comments'], rec['vat2-cap-comments'],
    rec['gateway-comments'], rec['agitator-comments'],
    rec['telemetry-comments'], rec['current-telemetry'],
    rec['vat1-comments'], rec['vat2-comments'],
    rec['vat1-condition-comments'], rec['vat2-condition-comments'],
    rec['chiller-condition-comments']
  ].map(safe).filter(Boolean);

  const blob = asLower(texts.join(' | '));

  // --- DTS / Vent Cap
  const dtsCap = /\b(dts|vent\s*cap|vented\s*cap|grey\s*halo|gray\s*halo|grey\s*sensor|gray\s*sensor|halo\s*sensor)\b/.test(blob);

  // --- Power point needed / recommended
  const powerNeeded = /\b(power\s*point|powerpoint|outlet|socket|gpo|power\s*board|splitter\s*plug)\b/.test(blob) &&
                      /\b(need|needed|recommend|recommended|req|required|should)\b/.test(blob);

  // --- Signal (Spark vs One NZ(Vodafone))
  // bars capture: "3 bars" / "2 bar"
  const sparkObj = /spark.*?(\d)\s*bar/.exec(blob);
  const oneObj   = /(one\s*nz|vodafone|voda).*?(\d)\s*bar/.exec(blob);
  const sparkBars = sparkObj ? parseInt(sparkObj[1]) : (/\b(spark).*(better|best|preferred|good)\b/.test(blob)? 4:0);
  const oneBars   = oneObj   ? parseInt(oneObj[2])   : (/\b(one\s*nz|vodafone|voda).*(better|best|preferred|good)\b/.test(blob)? 4:0);
  let prefer = '';
  if (sparkBars || oneBars){
    prefer = sparkBars >= oneBars ? 'Spark' : 'One NZ';
  }

  // --- Attention?
  const anyAttention =
    rec['vat1-condition']==='attention' || rec['vat2-condition']==='attention' ||
    rec['chiller-condition']==='attention';

  // --- Available Cap?
  const noAvailableCap =
    (safe(rec['vat1-cap']).toLowerCase()!=='available') ||
    (safe(rec['vat2-cap']).toLowerCase() && safe(rec['vat2-cap']).toLowerCase()!=='available' && safe(rec['vat2-cap']).toLowerCase()!=='na');

  // --- Rubberware delivered (+size & qty)
  const vatsCount = (safe(rec['vat2-capacity']) ? 2 : 1);
  const doorSealDelivered = safe(rec['vat-door-seal']).toLowerCase()==='delivered';
  const doorSealSize = safe(rec['vat-door-seal-size']||rec['door-seal-size']||'').toLowerCase(); // support both names
  const qtyDelivered = doorSealDelivered ? vatsCount : 0;

  return {
    dtsCap, powerNeeded, prefer, anyAttention, noAvailableCap,
    doorSeal: { delivered: doorSealDelivered, size: doorSealSize || 'unspecified', qty: qtyDelivered }
  };
}

/* ---------- Cache Sync ---------- */
async function listCloudFiles(){
  const root = storage.ref('Pre Check');
  const res = await root.listAll();
  return res.items || [];
}

async function downloadAll(onProgress){
  const items = await listCloudFiles();
  let done = 0;
  for (const ref of items){
    try{
      const url = await ref.getDownloadURL();
      const data = await fetch(url).then(r=>r.json());
      // ensure defaults for Vat2
      if(!safe(data['vat2-cap'])) data['vat2-cap']='na';
      if(!safe(data['vat2-condition'])) data['vat2-condition']='ok';
      if(!safe(data['vat2-capacity'])) data['vat2-capacity']='';
      const dairy = data.dairyNumber || ref.name.replace('.json','');
      await db.forms.put({ dairyNumber:dairy, ...data });
    }catch(e){ console.warn('Failed', ref.name, e); }
    done++; onProgress(done, items.length);
  }
  return items.length;
}

async function getAllCached(){ return await db.forms.toArray(); }

/* ---------- Summary Build ---------- */
let ALL = [];      // raw cache
let FILT = [];     // filtered
function applyFilters(){
  const q = asLower(document.getElementById('searchText').value);
  let from = 0;
  if(document.getElementById('d30').checked) from = dayjs().subtract(30,'day').valueOf();
  if(document.getElementById('d90').checked) from = dayjs().subtract(90,'day').valueOf();

  FILT = ALL.filter(r=>{
    const text = JSON.stringify(r).toLowerCase();
    const matchQ = !q || text.includes(q);
    const matchT = !from || (r.timestamp ? r.timestamp>=from : true);
    return matchQ && matchT;
  });
  rebuildKPIs();
  rebuildBuckets();
  rebuildFarmList(); // default list (all)
}

function rebuildKPIs(){
  const att = FILT.filter(r=>aiTags(r).anyAttention).length;
  const noCap = FILT.filter(r=>aiTags(r).noAvailableCap).length;
  const seals = FILT.reduce((s,r)=>s + aiTags(r).doorSeal.qty,0);
  const dts = FILT.filter(r=>aiTags(r).dtsCap).length;
  const pwr = FILT.filter(r=>aiTags(r).powerNeeded).length;
  const spark = FILT.filter(r=>aiTags(r).prefer==='Spark').length;
  const one = FILT.filter(r=>aiTags(r).prefer==='One NZ').length;

  document.getElementById('kpiTotal').textContent = FILT.length;
  document.getElementById('kpiAttention').textContent = att;
  document.getElementById('kpiNoCap').textContent = noCap;
  document.getElementById('kpiSeals').textContent = seals;
  document.getElementById('kpiDTS').textContent = dts;
  document.getElementById('kpiPP').textContent = pwr;
  document.getElementById('kpiSpark').textContent = spark;
  document.getElementById('kpiOne').textContent = one;

  // rubberware total cards (count farms with any delivered)
  const rubberFarms = FILT.filter(r=>aiTags(r).doorSeal.delivered).length;
  document.getElementById('kpiRubber').textContent = rubberFarms;
}

function bucket(v){ return v || 'Unknown'; }

function rebuildBuckets(){
  const sizesMap = {};
  FILT.forEach(r=>{
    const v1 = safe(r['vat1-capacity']); if(v1) sizesMap[v1] = (sizesMap[v1]||0)+1;
    const v2 = safe(r['vat2-capacity']); if(v2) sizesMap[v2] = (sizesMap[v2]||0)+1;
  });
  let html = '<div class="card-lite"><div class="h6 mb-2">Vat Sizes</div><div class="d-flex flex-wrap gap-2">';
  Object.entries(sizesMap).sort((a,b)=>parseInt(a[0])-parseInt(b[0])).forEach(([sz,c])=>{
    html += `<div class="badge-chip">${sz} L ‚Ä¢ ${c}</div>`;
  });
  html += '</div></div>';
  document.getElementById('summaryBuckets').innerHTML = html;
}

function rebuildFarmList(list=FILT){
  const box = document.getElementById('farmList');
  if(!list.length){ box.innerHTML = '<div class="text-muted text-center py-4">No farms to display.</div>'; return; }
  let html='';
  list.forEach(r=> html += farmCardHTML(r));
  box.innerHTML = html;
}

function farmCardHTML(r){
  const dairy = r.dairyNumber || 'Unknown';
  const t = aiTags(r);
  const chips = [];
  if(t.anyAttention) chips.push('<span class="pill attn">Attention</span>'); else chips.push('<span class="pill ok">OK</span>');
  if(t.prefer) chips.push(`<span class="badge-chip">${t.prefer} preferred</span>`);
  if(t.dtsCap) chips.push('<span class="badge-chip">DTS/Vent Cap</span>');
  if(t.powerNeeded) chips.push('<span class="badge-chip">Power point needed</span>');
  if(safe(r['vat1-serial'])) chips.push(`<span class="badge-chip">V1 SN ${safe(r['vat1-serial'])}</span>`);
  if(safe(r['vat2-serial'])) chips.push(`<span class="badge-chip">V2 SN ${safe(r['vat2-serial'])}</span>`);

  return `
  <div class="farm-card">
    <div class="d-flex align-items-start justify-content-between">
      <div>
        <div class="farm-title">#${dairy}</div>
        <div class="text-muted">Vat1 ${safe(r['vat1-capacity'])||'‚Äî'} L ‚Ä¢ Vat2 ${safe(r['vat2-capacity'])||'‚Äî'} L</div>
        <div class="mt-1">${chips.join(' ')}</div>
      </div>
      <div class="text-end">
        <button class="btn btn-sm btn-outline-primary" onclick="openDetails('${dairy}')">Details</button>
        <button class="btn btn-sm btn-brand" onclick="printBrochure('${dairy}')">Print</button>
      </div>
    </div>
  </div>`;
}

/* ---------- Drilled lists for each KPI ---------- */
function showFiltered(predicate, title){
  const rows = FILT.filter(predicate);
  rebuildFarmList(rows);
  window.scrollTo({top: document.getElementById('farmList').offsetTop-12, behavior:'smooth'});
}

/* ---------- Details Modal (labeled photos) ---------- */
function photoRow(label, base64){
  if(!base64) return '';
  return `<div class="mb-2"><div class="fw-bold mb-1">${label}</div><img class="modal-photo" src="${base64}"></div>`;
}

window.openDetails = async function(dairy){
  const r = await db.forms.get(dairy);
  if(!r){ return; }
  document.getElementById('modalTitle').textContent = `#${dairy}`;
  const rows = [];
  const K = (k)=> safe(r[k]);
  rows.push(`<div class="mb-2"><span class="fw-bold">Vat 1:</span> ${K('vat1-capacity')} L ‚Ä¢ Cap ${K('vat1-cap')} ‚Ä¢ Cond ${K('vat1-condition')} ‚Ä¢ SN ${K('vat1-serial')}</div>`);
  rows.push(`<div class="mb-2"><span class="fw-bold">Vat 2:</span> ${K('vat2-capacity')||'‚Äî'} L ‚Ä¢ Cap ${K('vat2-cap')} ‚Ä¢ Cond ${K('vat2-condition')} ‚Ä¢ SN ${K('vat2-serial')}</div>`);
  rows.push(`<div class="mb-2"><span class="fw-bold">Agitator:</span> ${K('agitator-location')} ‚Äî ${K('agitator-comments')}</div>`);
  rows.push(`<div class="mb-2"><span class="fw-bold">Gateway:</span> ${K('gateway-location')} ‚Äî ${K('gateway-comments')}</div>`);
  rows.push(`<div class="mb-2"><span class="fw-bold">Telemetry:</span> ${K('current-telemetry')} ${K('telemetry-comments')}</div>`);
  rows.push(`<hr>`);
  // photos labeled
  rows.push(photoRow('Vat 1 Cap Photo', K('vat1-cap-photo-base64')));
  rows.push(photoRow('Vat 2 Cap Photo', K('vat2-cap-photo-base64')));
  rows.push(photoRow('Agitator Location', K('agitator-photo-base64')));
  rows.push(photoRow('Gateway Location', K('gateway-photo-base64')));
  rows.push(photoRow('Vat 1 Condition', K('vat1-condition-photo-base64')));
  rows.push(photoRow('Vat 2 Condition', K('vat2-condition-photo-base64')));
  rows.push(photoRow('Door Seal Delivery', K('vat-door-seal-photo-base64')));
  rows.push(photoRow('RJT Step Seal', K('rjt-seal-photo-base64')));
  rows.push(photoRow('Chiller Condition', K('chiller-condition-photo-base64')));

  document.getElementById('modalBody').innerHTML = rows.join('');
  new bootstrap.Modal(document.getElementById('modalDetails')).show();
}

/* ---------- Print (A4 brochure) ---------- */
async function printBrochure(dairy){
  const rec = await db.forms.get(dairy);
  if(!rec) return;
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','pt','a4');

  const addHeading = (t,y)=>{ pdf.setFontSize(16); pdf.setTextColor(20,40,70); pdf.text(t, 40, y); }
  const addKV = (y,k,v)=>{ pdf.setFontSize(12); pdf.setTextColor(60,60,60); pdf.text(`${k}: `,40,y); pdf.setTextColor(20,20,20); pdf.text(String(v||'‚Äî'),140,y); }

  let y=40;
  addHeading(`Agora Vat Pre-Check ‚Äî #${dairy}`, y); y+=20;
  addKV(y,'Vat 1', `${safe(rec['vat1-capacity'])||'‚Äî'} L ‚Ä¢ Cap ${safe(rec['vat1-cap'])} ‚Ä¢ Cond ${safe(rec['vat1-condition'])} ‚Ä¢ SN ${safe(rec['vat1-serial'])}`); y+=16;
  addKV(y,'Vat 2', `${safe(rec['vat2-capacity'])||'‚Äî'} L ‚Ä¢ Cap ${safe(rec['vat2-cap'])} ‚Ä¢ Cond ${safe(rec['vat2-condition'])} ‚Ä¢ SN ${safe(rec['vat2-serial'])}`); y+=16;
  addKV(y,'Agitator', `${safe(rec['agitator-location'])} ‚Äî ${safe(rec['agitator-comments'])}`); y+=16;
  addKV(y,'Gateway', `${safe(rec['gateway-location'])} ‚Äî ${safe(rec['gateway-comments'])}`); y+=16;
  addKV(y,'Telemetry', `${safe(rec['current-telemetry'])} ${safe(rec['telemetry-comments'])}`); y+=22;

  pdf.autoTable({
    startY: y,
    styles:{fontSize:10,cellPadding:3},
    headStyles:{fillColor:[0,43,92],textColor:255},
    head:[['Field','Value']],
    body:[
      ['Door Seal', `${safe(rec['vat-door-seal'])} ‚Ä¢ Size ${safe(rec['vat-door-seal-size']||'unspecified')}`],
      ['RJT Step Seal', safe(rec['rjt-seal'])],
      ['Chiller', safe(rec['chiller-condition'])]
    ]
  });

  // photos grid
  let py = pdf.lastAutoTable ? pdf.lastAutoTable.finalY + 12 : y+60;
  const photoKeys = [
    ['Vat 1 Cap','vat1-cap-photo-base64'],['Vat 2 Cap','vat2-cap-photo-base64'],
    ['Agitator','agitator-photo-base64'],['Gateway','gateway-photo-base64'],
    ['Door Seal','vat-door-seal-photo-base64'],['RJT','rjt-seal-photo-base64'],
    ['Chiller','chiller-condition-photo-base64']
  ];
  const W = 240, H = 160, M = 40, G = 20;
  for (let i=0;i<photoKeys.length;i++){
    const [label,key] = photoKeys[i];
    const b64 = rec[key];
    if(!b64) continue;
    if(py+H+40 > pdf.internal.pageSize.getHeight()){ pdf.addPage(); py = 40; }
    const col = (i%2==0)? M : (M+W+G);
    if(i%2==1) py -= (H+30);
    pdf.setFontSize(11); pdf.text(label, col, py);
    pdf.addImage(b64,'JPEG', col, py+8, W, H);
    if(i%2==1) py += (H+40);
    if(i%2==0 && i===photoKeys.length-1) py += (H+40);
  }

  pdf.save(`PreCheck_${dairy}.pdf`);
}
window.printBrochure = printBrochure;

/* ---------- CSV Export ---------- */
document.getElementById('btnCSV').onclick = () => {
  const rows = [['Vat Size','Serial','Manufacturer','Dairy #','Cap Available']];
  FILT.forEach(r=>{
    const v1 = safe(r['vat1-capacity']); if(v1) rows.push([v1, safe(r['vat1-serial']), normalizeManufacturer(r['vat1-comments']), r.dairyNumber, safe(r['vat1-cap']) ]);
    const v2 = safe(r['vat2-capacity']); if(v2) rows.push([v2, safe(r['vat2-serial']), normalizeManufacturer(r['vat2-comments']), r.dairyNumber, safe(r['vat2-cap']) ]);
  });
  const csv = rows.map(r=>r.map(x=>`"${(x||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'vat_sizes.csv';
  a.click();
}

/* ---------- Click cards to drill ---------- */
document.getElementById('cardDTS').onclick = () => showFiltered(r=>aiTags(r).dtsCap, 'DTS / Vent Cap');
document.getElementById('cardPP').onclick = () => showFiltered(r=>aiTags(r).powerNeeded, 'Power Points Needed');
document.getElementById('cardSignalSpark').onclick = () => showFiltered(r=>aiTags(r).prefer==='Spark', 'Spark Preferred');
document.getElementById('cardSignalOne').onclick = () => showFiltered(r=>aiTags(r).prefer==='One NZ', 'One NZ Preferred');
document.getElementById('cardRubberware').onclick = () => {
  // list farms with delivered seals; include photo thumb inside card when open details
  showFiltered(r=>aiTags(r).doorSeal.delivered, 'Rubberware Delivered');
}

/* ---------- Search / Filter buttons ---------- */
document.getElementById('btnApply').onclick = applyFilters;
document.getElementById('btnClear').onclick = () => { document.getElementById('searchText').value=''; document.getElementById('dAll').checked=true; applyFilters(); };

/* ---------- Sync buttons ---------- */
async function doSync(){
  document.getElementById('syncStatus').textContent='Listing cloud‚Ä¶';
  const items = await listCloudFiles();
  document.getElementById('cloudCount').textContent = items.length;
  let downloaded=0;
  const onProgress=(d,t)=>{
    downloaded=d;
    const pct = Math.round((d/t)*100);
    document.getElementById('cacheProg').style.width = pct + '%';
    document.getElementById('cacheCount').textContent = d;
    document.getElementById('syncStatus').textContent = `Downloading ${d}/${t} (${pct}%)‚Ä¶`;
  };
  await downloadAll(onProgress);
  document.getElementById('syncStatus').textContent = 'Completed';
  ALL = await getAllCached();
  applyFilters();
}
document.getElementById('btnSync').onclick = doSync;
document.getElementById('btnAdminSync').onclick = doSync;
document.getElementById('btnWipe').onclick = async ()=>{ await db.forms.clear(); document.getElementById('cacheCount').textContent='0'; ALL=[]; FILT=[]; rebuildKPIs(); rebuildBuckets(); rebuildFarmList(); };

/* ---------- First load: read cache then (optionally) user triggers download ---------- */
(async function boot(){
  ALL = await getAllCached();
  document.getElementById('cacheCount').textContent = ALL.length;
  applyFilters();
})();
</script>
</body>
</html>