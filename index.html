<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Agora Vat Pre-Check</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">

<style>
:root{--brand:#001F3F;--accent:#FF851B;--muted:#6b7280;--bg:#f7f8fb}
html,body{background:var(--bg);color:#0f172a;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
.app{max-width:1100px;margin:28px auto;padding:0 16px}
.brand-header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
.brand-logo{width:160px;height:auto;display:none}
.brand-title{flex:1}
.brand-title h1{margin:0;font-weight:800;color:var(--brand)}
.brand-sub{color:var(--muted)}
.tabbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 18px}
.tab-btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:10px 14px;font-weight:700}
.tab-btn.active{border-color:var(--accent);box-shadow:0 0 0 3px #ff851b2b}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #e5e7eb;font-weight:700}
.progress{height:10px}

.bar{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin:10px 0}
.section-title{font-size:1.05rem;font-weight:800;color:#111827;margin:6px 0 10px}

.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:16px;cursor:pointer}
.kpi .num{font-size:1.6rem;font-weight:800}
.kpi .label{color:#6b7280}
.kpi:hover{box-shadow:0 6px 20px rgba(0,0,0,.06)}

.list{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media (max-width:900px){.list{grid-template-columns:1fr}}
.item{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px;display:flex;align-items:center;justify-content:space-between}
.item .left{display:flex;align-items:center;gap:8px}
.badge-soft{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:2px 8px;font-size:.8rem;color:#374151}
.btn-brand{background:var(--accent);border:none;color:#fff;font-weight:800}
.btn-brand:hover{background:#ff6d00}
.btn-outline-brand{border:1px solid var(--accent);color:var(--accent);background:#fff;font-weight:800}
.btn-outline-brand:hover{background:var(--accent);color:#fff}

.form-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin-bottom:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:900px){.grid-3{grid-template-columns:1fr}}

.hidden{display:none!important}
.small-note{color:#6b7280}

/* Brochure (one page) */
.print-sheet{max-width:950px;margin:0 auto;color:#0f172a}
.print-head{display:flex;align-items:center;gap:16px;border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:10px}
.print-head img{height:44px}
.print-title{font-weight:800;font-size:1.2rem}
.print-sub{color:#6b7280}
.print-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.print-card{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.print-label{font-weight:800;margin-bottom:6px}
.print-photos{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.print-photos img{width:100%;max-height:180px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb}
@media print {.page-break{page-break-after:always}}
.modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:10px}
.modal-box{background:#fff;border-radius:14px;max-width:980px;width:96vw;max-height:92vh;overflow:auto;padding:12px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-bottom:6px}

.footer{color:#6b7280;text-align:center;margin:22px 0 10px}
</style>
</head>
<body>
<div class="app">
  <div class="brand-header">
    <img id="logo" class="brand-logo" alt="Agora Logo">
    <div class="brand-title">
      <h1>Agora Vat Pre-Check</h1>
      <div class="brand-sub">Fast field capture • Smart summary • Customer-ready output</div>
    </div>
  </div>

  <div class="tabbar">
    <button id="tab-summary" class="tab-btn active">Summary</button>
    <button id="tab-form" class="tab-btn">Form</button>
    <button id="tab-admin" class="tab-btn">Admin</button>

    <span class="ms-auto pill">Cloud: <span id="cloud-count">–</span></span>
    <span class="pill">Loaded: <span id="loaded-count">0</span></span>
  </div>
  <div class="progress"><div id="bar" class="progress-bar" style="width:0%"></div></div>
  <div class="small-note mt-1"><span id="pct">0</span>%</div>

  <!-- SUMMARY -->
  <div id="view-summary">
    <div class="bar">
      <div class="section-title">Vat Size Breakdown (live from cloud)</div>
      <div id="sizes-table" class="mb-2"></div>
      <button id="btn-export-sizes" class="btn btn-outline-brand">Export Sizes CSV</button>
    </div>

    <div class="bar">
      <div class="section-title">Overview</div>
      <div class="kpi-grid">
        <div class="kpi" data-k="dts"><div class="num" id="kpi-dts">0</div><div class="label">DTS Vent Caps</div></div>
        <div class="kpi" data-k="power"><div class="num" id="kpi-power">0</div><div class="label">Farms needing power point</div></div>
        <div class="kpi" data-k="rubber"><div class="num" id="kpi-rubber">0</div><div class="label">Rubberware deliveries</div></div>
      </div>
    </div>

    <div class="bar">
      <div class="section-title">Results</div>
      <div class="d-flex gap-2 mb-2">
        <input id="search" class="form-control" placeholder="Search dairy # or text…" style="max-width:320px">
        <button id="clear" class="btn btn-outline-secondary">Clear</button>
      </div>
      <div id="results" class="list"></div>
    </div>
  </div>

  <!-- FORM (simple; cloud autofill) -->
  <div id="view-form" class="hidden">
    <div class="form-card">
      <div class="grid-3">
        <div>
          <label class="form-label">Dairy Number</label>
          <input id="dairyNumber" class="form-control" placeholder="e.g. 7038">
          <div class="small-note">Blur to auto-fill from cloud.</div>
        </div>
        <div>
          <label class="form-label">Gateway Location</label>
          <input id="gateway-location" class="form-control">
        </div>
        <div>
          <label class="form-label">Gateway Comments</label>
          <input id="gateway-comments" class="form-control">
        </div>
      </div>
    </div>

    <div class="form-card">
      <h6>Vat 1</h6>
      <div class="grid-3">
        <div><label class="form-label">Capacity (L)</label><input id="vat1-capacity" class="form-control"></div>
        <div><label class="form-label">Cap</label><select id="vat1-cap" class="form-select"><option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option></select></div>
        <div><label class="form-label">Serial</label><input id="vat1-serial" class="form-control"></div>
        <div><label class="form-label">Condition</label><select id="vat1-condition" class="form-select"><option value="ok">ok</option><option value="attention">attention</option></select></div>
        <div><label class="form-label">Cap Comments</label><input id="vat1-cap-comments" class="form-control"></div>
        <div><label class="form-label">Notes</label><input id="vat1-comments" class="form-control"></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Vat 2</h6>
      <div class="grid-3">
        <div><label class="form-label">Capacity (L)</label><input id="vat2-capacity" class="form-control" placeholder="leave blank if N/A"></div>
        <div><label class="form-label">Cap</label><select id="vat2-cap" class="form-select"><option value="na">N/A</option><option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option></select></div>
        <div><label class="form-label">Serial</label><input id="vat2-serial" class="form-control"></div>
        <div><label class="form-label">Condition</label><select id="vat2-condition" class="form-select"><option value="ok">ok</option><option value="attention">attention</option></select></div>
        <div><label class="form-label">Cap Comments</label><input id="vat2-cap-comments" class="form-control"></div>
        <div><label class="form-label">Notes</label><input id="vat2-comments" class="form-control"></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Other Telemetry</h6>
      <div class="grid-3">
        <div><label class="form-label">Brand</label><input id="other-brand" class="form-control" placeholder="Halo / DTS / NDA / Levno"></div>
        <div><label class="form-label">Type</label><input id="other-type" class="form-control" placeholder="vat / water / fuel / other"></div>
        <div><label class="form-label">Notes</label><input id="other-notes" class="form-control"></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Rubberware</h6>
      <div class="grid-3">
        <div><label class="form-label">Door delivered?</label><select id="door-delivered" class="form-select"><option value="no">No</option><option value="yes">Yes</option></select></div>
        <div><label class="form-label">Door size</label><select id="door-size" class="form-select"><option value="">—</option><option>small</option><option>large</option></select></div>
        <div><label class="form-label">RJT delivered?</label><select id="rjt-delivered" class="form-select"><option value="no">No</option><option value="yes">Yes</option></select></div>
      </div>
    </div>

    <div class="form-card">
      <button id="btn-save" class="btn btn-brand">Save / Update</button>
      <button id="btn-print-this" class="btn btn-outline-brand">Print This Brochure</button>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="view-admin" class="hidden">
    <div class="bar">
      <div class="section-title">Bulk Output</div>
      <div class="d-flex flex-wrap gap-2">
        <button id="btn-owner-csv" class="btn btn-outline-brand">Download Owners Report (CSV)</button>
        <button id="btn-print-all" class="btn btn-brand">Print All Brochures</button>
        <button id="btn-zip-all" class="btn btn-outline-brand">Download All Brochures (ZIP)</button>
      </div>
    </div>

    <div class="bar">
      <div class="section-title">Maintenance</div>
      <button id="btn-reload" class="btn btn-outline-secondary">Reload From Cloud</button>
      <button id="btn-download-json" class="btn btn-outline-secondary">Download All JSON (ZIP)</button>
    </div>
  </div>

  <div class="footer">Agora • Vat Pre-Check • v4.4</div>
</div>

<!-- DETAILS MODAL -->
<div id="detail-modal" class="modal-mask" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-box">
    <div class="modal-actions">
      <button id="detail-print" class="btn btn-outline-brand">Print</button>
      <button id="detail-close" class="btn btn-secondary">Close</button>
    </div>
    <div id="detail-body"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
/* ---------- Firebase ---------- */
const cfg={apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",authDomain:"dairy-farm-record-system.firebaseapp.com",projectId:"dairy-farm-record-system",storageBucket:"dairy-farm-record-system.appspot.com",messagingSenderId:"422124188212",appId:"1:422124188212:web:1bd31bee8d6e91e301d061"};
firebase.initializeApp(cfg);
const storage=firebase.storage();
const FOLDER='Pre Check';

/* ---------- Helpers ---------- */
const $=id=>document.getElementById(id);
const show=(idOrEl)=> (typeof idOrEl==='string'?$(idOrEl):idOrEl).classList.remove('hidden');
const hide=(idOrEl)=> (typeof idOrEl==='string'?$(idOrEl):idOrEl).classList.add('hidden');
const setActive=id=>{document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));$(id).classList.add('active')};
function setProgress(done,total){const pct=total?Math.min(100,Math.round(done*100/total)):0;$('bar').style.width=pct+'%';$('pct').textContent=pct;$('loaded-count').textContent=done;}
const keyToDn=k=>k.replace('.json','');

/* ---------- Logo ---------- */
(async()=>{try{const url=await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL();$('logo').src=url;$('logo').style.display='block';}catch(e){}})();

/* ---------- Nav ---------- */
$('tab-summary').onclick=()=>{setActive('tab-summary');show('view-summary');hide('view-form');hide('view-admin')};
$('tab-form').onclick   =()=>{setActive('tab-form');hide('view-summary');show('view-form');hide('view-admin')};
$('tab-admin').onclick  =()=>{setActive('tab-admin');hide('view-summary');hide('view-form');show('view-admin')};

/* ---------- State ---------- */
let CLOUD_KEYS=[];   // file names
let RECORDS=[];     // farm objects
let SIZES_MAP={};

/* ---------- Cloud listing ---------- */
async function listCloudKeys(){
  const res=await storage.ref(FOLDER).listAll();
  CLOUD_KEYS=res.items.filter(x=>/\.json$/i.test(x.name)).map(x=>x.name).sort((a,b)=>keyToDn(a).localeCompare(keyToDn(b)));
  $('cloud-count').textContent=CLOUD_KEYS.length;
}

/* ---------- Robust field access / normalization ---------- */
function first(rec, keys, dflt=''){
  for(const k of keys){ if(rec[k]!=null && rec[k]!=='' ) return rec[k]; }
  return dflt;
}
function yesDelivered(v){
  if(v===true) return true;
  const s=String(v||'').toLowerCase();
  return ['yes','delivered','y','true','1'].includes(s);
}
function rubberFrom(rec){
  const doorDelivered = yesDelivered(first(rec,['door-delivered','vat-door-seal']));
  const rjtDelivered  = yesDelivered(first(rec,['rjt-delivered','rjt-seal']));
  const doorSize = first(rec,['door-size','vat-door-seal-size','vat-door-seal-comments']).toString();
  const rjtSize  = first(rec,['rjt-size','rjt-seal-size','rjt-seal-comments']).toString();
  return {doorDelivered,rjtDelivered,doorSize,rjtSize};
}
function splitSignalFromGateway(rec){
  const g=(rec['gateway-comments']||'')+' '+(rec['gateway-location']||'');
  const text=g.toLowerCase();
  let spark='', one='';
  const sNum=/(spark)\D*(\d+)\s*bar/.exec(text); if(sNum) spark=sNum[2];
  const oNum=/(one\s*nz|vodafone)\D*(\d+)\s*bar/.exec(text); if(oNum) one=oNum[2];
  if(/no\s*signal/.test(text)){ spark=spark||'0'; one=one||'0'; }
  spark = first(rec,['spark-bars'], spark);
  one   = first(rec,['one-bars'],   one);
  const cleaned=g.replace(/(spark|one\s*nz|vodafone)[^,;]*bar[s]?/ig,'').replace(/no\s*signal/ig,'').trim();
  return {spark, one, gatewayOther: cleaned};
}
function detectDtsCap(rec){
  const blob=[rec['vat1-cap-comments'],rec['vat2-cap-comments'],rec['vat1-comments'],rec['vat2-comments']].join(' ');
  return /(grey|gray)\s+(halo|sensor)|\bdts\b.*(cap|vent)|reducing\s+cap/i.test(blob);
}
function detectPowerPoint(rec){
  const blob=[rec['gateway-comments'],rec['gateway-location'],rec['vat1-comments'],rec['vat2-comments'],rec['other-notes']].join(' ');
  return /(power\s*point.*(need|req|install)|no\s*power|splitter\s*plug)/i.test(blob);
}
function deliveredDoorCount(rec){
  const {doorDelivered}=rubberFrom(rec);
  return doorDelivered ? (rec['vat2-capacity']?2:1) : 0;
}
function manuFromNotes(rec){
  const blob=[rec['vat1-comments'],rec['vat2-comments'],rec['other-brand']].join(' ');
  if(/\bdts\b/i.test(blob)) return 'DTS';
  if(/\bnda\b/i.test(blob)) return 'NDA';
  if(/\bhalo\b/i.test(blob)) return 'Halo';
  if(/\blevno\b/i.test(blob)) return 'Levno';
  return first(rec,['other-brand'],'-');
}
function collectPhotos(rec){
  const arr=[
    rec['gateway-photo-base64'],
    rec['vat1-cap-photo-base64'],
    rec['agitator1-photo-base64']||rec['agitator-photo-base64'],
    rec['vat2-cap-photo-base64'],
    rec['agitator2-photo-base64'],
    rec['door-photo-base64']||rec['vat-door-seal-photo-base64'],
    rec['rjt-photo-base64']||rec['rjt-seal-photo-base64']
  ].filter(Boolean);
  return arr.slice(0,4);
}

/* ---------- Sizes / KPIs ---------- */
function addToSizes(rec){
  const s1=String(first(rec,['vat1-capacity'],'')).trim(); if(s1) SIZES_MAP[s1]=(SIZES_MAP[s1]||0)+1;
  const s2=String(first(rec,['vat2-capacity'],'')).trim(); if(s2) SIZES_MAP[s2]=(SIZES_MAP[s2]||0)+1;
}
function renderSizes(){
  let h='<table class="table table-sm table-bordered"><thead><tr><th>Vat Size (L)</th><th>Count</th></tr></thead><tbody>';
  Object.entries(SIZES_MAP).sort((a,b)=>parseInt(a[0])-parseInt(b[0])).forEach(([sz,c])=>h+=`<tr><td>${sz||'—'}</td><td>${c}</td></tr>`);
  h+='</tbody></table>'; $('sizes-table').innerHTML=h;
}
function renderKpis(){
  $('kpi-dts').textContent=RECORDS.filter(detectDtsCap).length;
  $('kpi-power').textContent=RECORDS.filter(detectPowerPoint).length;
  $('kpi-rubber').textContent=RECORDS.filter(r=>rubberFrom(r).doorDelivered || rubberFrom(r).rjtDelivered).length;
}

/* ---------- List (just dairy numbers for speed) ---------- */
function renderList(rows){
  const q=($('search').value||'').trim().toLowerCase();
  const filtered=(rows||RECORDS).filter(r=>!q || (String(r.dairyNumber).includes(q) || JSON.stringify(r).toLowerCase().includes(q)));
  $('results').innerHTML=filtered
    .sort((a,b)=>String(a.dairyNumber).localeCompare(String(b.dairyNumber)))
    .map(r=>`
      <div class="item">
        <div class="left"><strong>#${r.dairyNumber}</strong>
          <span class="badge-soft">${first(r,['vat1-capacity'],'-')}${first(r,['vat2-capacity'])?' • '+first(r,['vat2-capacity']):''}</span>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-brand" onclick="window.openDetails('${r.dairyNumber}')">Details</button>
          <button class="btn btn-sm btn-brand" onclick="window.openPrint('${r.dairyNumber}')">Print</button>
        </div>
      </div>`).join('');
}

/* ---------- Progressive load ---------- */
async function loadAll(){
  RECORDS=[];SIZES_MAP={};renderSizes();renderKpis();renderList([]);setProgress(0,CLOUD_KEYS.length);
  let done=0;
  for(const key of CLOUD_KEYS){
    try{
      const url=await storage.ref(FOLDER+'/'+key).getDownloadURL();
      const rec=await fetch(url).then(r=>r.json());
      if(!rec.dairyNumber) rec.dairyNumber=keyToDn(key);
      RECORDS.push(rec);
      addToSizes(rec);
      if(done<40) renderList(RECORDS);            // quick feedback
      if(done%10===0){renderSizes();renderKpis();}
    }catch(e){}
    done++;setProgress(done,CLOUD_KEYS.length);
  }
  renderSizes();renderKpis();renderList(RECORDS);
}

/* ---------- Brochure HTML (one page) ---------- */
async function brochureHTML(rec){
  let logo=''; try{logo=`<img src="${await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL()}" alt="logo">`;}catch(e){}
  const {spark,one,gatewayOther}=splitSignalFromGateway(rec);
  const {doorDelivered,rjtDelivered,doorSize,rjtSize}=rubberFrom(rec);
  const manu=manuFromNotes(rec);
  const doorCount=deliveredDoorCount(rec);
  const photos=collectPhotos(rec);

  return `
  <div class="print-sheet">
    <div class="print-head">${logo}<div><div class="print-title">Vat Pre-Check – #${rec.dairyNumber}</div>
      <div class="print-sub">Brand: ${manu} • Spark: ${spark||'-'} • One NZ: ${one||'-'}</div></div></div>

    <div class="print-grid">
      <div class="print-card">
        <div class="print-label">Vat 1</div>
        <div>Capacity: <b>${first(rec,['vat1-capacity'],'-')}</b></div>
        <div>Cap: <b>${(first(rec,['vat1-cap'],'-')||'-').toUpperCase()}</b></div>
        <div>Serial: <b>${first(rec,['vat1-serial'],'-')}</b></div>
        <div>Condition: <b>${first(rec,['vat1-condition'],'-')}</b></div>
        <div>Notes: ${first(rec,['vat1-comments'],'-')}</div>
        <div>Cap comments: ${first(rec,['vat1-cap-comments'],'-')}</div>
      </div>
      <div class="print-card">
        <div class="print-label">Vat 2</div>
        <div>Capacity: <b>${first(rec,['vat2-capacity'],'-')}</b></div>
        <div>Cap: <b>${(first(rec,['vat2-cap'],'-')||'-').toUpperCase()}</b></div>
        <div>Serial: <b>${first(rec,['vat2-serial'],'-')}</b></div>
        <div>Condition: <b>${first(rec,['vat2-condition'],'-')}</b></div>
        <div>Notes: ${first(rec,['vat2-comments'],'-')}</div>
        <div>Cap comments: ${first(rec,['vat2-cap-comments'],'-')}</div>
      </div>

      <div class="print-card">
        <div class="print-label">Gateway</div>
        <div>Location: <b>${first(rec,['gateway-location'],'-')}</b></div>
        <div>Comments: ${gatewayOther || first(rec,['gateway-comments'],'-')}</div>
      </div>
      <div class="print-card">
        <div class="print-label">Mobile Signal</div>
        <div>Spark: <b>${spark||'-'}</b></div>
        <div>One NZ: <b>${one||'-'}</b></div>
      </div>

      <div class="print-card">
        <div class="print-label">Other Telemetry</div>
        <div>Brand: <b>${first(rec,['other-brand'],'-')}</b> • Type: <b>${first(rec,['other-type'],'-')}</b></div>
        <div>Notes: ${first(rec,['other-notes'],'-')}</div>
      </div>
      <div class="print-card">
        <div class="print-label">Rubberware</div>
        <div>Door Seal: <b>${doorDelivered?'Delivered':'No'}</b>${doorSize? ' • '+doorSize:''}${doorDelivered? ` (x${doorCount})`:''}</div>
        <div>RJT: <b>${rjtDelivered?'Delivered':'No'}</b>${rjtSize? ' • '+rjtSize:''}</div>
      </div>
    </div>

    ${photos.length? `<div class="print-card mt-2"><div class="print-label">Photos</div><div class="print-photos">${photos.map(s=>`<img src="${s}">`).join('')}</div></div>`:''}
  </div>`;
}

/* ---------- Details modal & print ---------- */
window.openDetails=async(dn)=>{
  const rec=RECORDS.find(r=>String(r.dairyNumber)===String(dn)); if(!rec) return;
  $('detail-body').innerHTML=await brochureHTML(rec);
  $('detail-print').onclick=()=>window.openPrint(dn);
  $('detail-modal').style.display='flex';
  $('detail-modal').setAttribute('aria-hidden','false');
};
$('detail-close').onclick=()=>{
  $('detail-modal').style.display='none';
  $('detail-modal').setAttribute('aria-hidden','true');
};
window.openPrint=async(dn)=>{
  const rec=RECORDS.find(r=>String(r.dairyNumber)===String(dn)); if(!rec) return;
  const html=await brochureHTML(rec);
  const w=window.open('','_blank');
  const css=`${document.querySelector('style').innerHTML}.page-break{page-break-after:always}`;
  w.document.write(`<html><head><title>${dn}</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"><style>${css}</style></head><body>${html}</body></html>`);
  w.document.close(); w.focus(); setTimeout(()=>w.print(),400);
};

/* ---------- Admin: bulk ---------- */
$('btn-print-all').onclick=async()=>{
  if(!RECORDS.length){alert('Loading records… wait for 100%.');return;}
  const w=window.open('','_blank');
  const css=`${document.querySelector('style').innerHTML}.page-break{page-break-after:always}`;
  w.document.write(`<html><head><title>All Brochures</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"><style>${css}</style></head><body>`);
  for(let i=0;i<RECORDS.length;i++){
    const html=await brochureHTML(RECORDS[i]);
    w.document.write(`<div>${html}</div>${i<RECORDS.length-1?'<div class="page-break"></div>':''}`);
  }
  w.document.write(`</body></html>`); w.document.close(); w.focus(); setTimeout(()=>w.print(),800);
};
$('btn-zip-all').onclick=async()=>{
  if(!RECORDS.length){alert('Loading records… wait for 100%.');return;}
  const zip=new JSZip();
  for(const r of RECORDS){
    const html=await brochureHTML(r);
    zip.file(`${r.dairyNumber}.html`,`<!doctype html><html><head><meta charset="utf-8"><title>${r.dairyNumber}</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"><style>${document.querySelector('style').innerHTML}</style></head><body>${html}</body></html>`);
  }
  const blob=await zip.generateAsync({type:'blob'}); saveAs(blob,'agora_brochures.zip');
};
$('btn-owner-csv').onclick=()=>{
  if(!RECORDS.length){alert('Loading records… wait for 100%.');return;}
  const rows=[];
  for(const r of RECORDS){
    const {spark,one}=splitSignalFromGateway(r);
    const {doorDelivered,rjtDelivered,doorSize,rjtSize}=rubberFrom(r);
    const manu=manuFromNotes(r);
    const add=(vat)=>rows.push({
      Dairy:r.dairyNumber,
      Vat:vat,
      Size: first(r,[`vat${vat}-capacity`],''),
      Serial: first(r,[`vat${vat}-serial`],''),
      Cap: (first(r,[`vat${vat}-cap`],'')||'').toUpperCase(),
      Condition: first(r,[`vat${vat}-condition`],''),
      Notes: first(r,[`vat${vat}-comments`],''),
      CapComments: first(r,[`vat${vat}-cap-comments`],''),
      Manufacturer: manu,
      DoorDelivered: doorDelivered?'Yes':'No',
      DoorSize: doorSize||'',
      RJTDelivered: rjtDelivered?'Yes':'No',
      RJTSize: rjtSize||'',
      SparkBars: spark||'',
      OneNZBars: one||'',
      GatewayLocation: first(r,['gateway-location'],''),
      OtherBrand: first(r,['other-brand'],''),
      OtherType: first(r,['other-type'],''),
      OtherNotes: first(r,['other-notes'],'')
    });
    if(first(r,['vat1-capacity'])) add(1);
    if(first(r,['vat2-capacity'])) add(2);
  }
  const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Owners Report'); XLSX.writeFile(wb,'owners_report.csv');
};
$('btn-reload').onclick=async()=>{await bootstrap();};
$('btn-download-json').onclick=async()=>{
  const zip=new JSZip();
  for(const key of CLOUD_KEYS){
    const url=await storage.ref(FOLDER+'/'+key).getDownloadURL();
    const txt=await fetch(url).then(r=>r.text());
    zip.file(key,txt);
  }
  const blob=await zip.generateAsync({type:'blob'}); saveAs(blob,'precheck_json.zip');
};

/* ---------- Summary interactions ---------- */
document.querySelectorAll('.kpi').forEach(el=>{
  el.addEventListener('click',()=>{
    const k=el.getAttribute('data-k');
    let rows=RECORDS;
    if(k==='dts') rows=RECORDS.filter(detectDtsCap);
    if(k==='power') rows=RECORDS.filter(detectPowerPoint);
    if(k==='rubber') rows=RECORDS.filter(r=>rubberFrom(r).doorDelivered || rubberFrom(r).rjtDelivered);
    renderList(rows);
  });
});
$('search').addEventListener('input',()=>renderList(RECORDS));
$('clear').onclick=()=>{$('search').value='';renderList(RECORDS)};

/* ---------- Form auto-fill & save ---------- */
$('dairyNumber').addEventListener('blur', async ()=>{
  const dn=($('dairyNumber').value||'').trim(); if(!dn) return;
  try{
    const url=await storage.ref(`${FOLDER}/${dn}.json`).getDownloadURL();
    const rec=await fetch(url).then(r=>r.json());
    const fields=['gateway-location','gateway-comments','vat1-capacity','vat1-cap','vat1-serial','vat1-condition','vat1-comments','vat1-cap-comments','vat2-capacity','vat2-cap','vat2-serial','vat2-condition','vat2-comments','vat2-cap-comments','other-brand','other-type','other-notes','door-delivered','door-size','rjt-delivered'];
    fields.forEach(f=>{const el=$(f); if(el) el.value=rec[f]??el.value});
  }catch(e){}
});
$('btn-save').onclick=async()=>{
  const dn=($('dairyNumber').value||'').trim(); if(!dn){alert('Enter a Dairy #');return;}
  const data={
    dairyNumber:dn,
    'gateway-location':$('gateway-location').value,
    'gateway-comments':$('gateway-comments').value,
    'vat1-capacity':$('vat1-capacity').value,'vat1-cap':$('vat1-cap').value,'vat1-serial':$('vat1-serial').value,'vat1-condition':$('vat1-condition').value,'vat1-comments':$('vat1-comments').value,'vat1-cap-comments':$('vat1-cap-comments').value,
    'vat2-capacity':$('vat2-capacity').value,'vat2-cap':$('vat2-cap').value,'vat2-serial':$('vat2-serial').value,'vat2-condition':$('vat2-condition').value,'vat2-comments':$('vat2-comments').value,'vat2-cap-comments':$('vat2-cap-comments').value,
    'other-brand':$('other-brand').value,'other-type':$('other-type').value,'other-notes':$('other-notes').value,
    'door-delivered':$('door-delivered').value,'door-size':$('door-size').value,'rjt-delivered':$('rjt-delivered').value,
    timestamp:Date.now()
  };
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
  await storage.ref(`${FOLDER}/${dn}.json`).put(blob);
  alert('Saved to cloud.');
};
$('btn-print-this').onclick=async()=>{
  const dn=($('dairyNumber').value||'').trim(); if(!dn){alert('Enter a Dairy #');return;}
  window.openPrint(dn);
};

/* ---------- Export sizes ---------- */
$('btn-export-sizes').onclick=()=>{
  const rows=Object.entries(SIZES_MAP).map(([Size,Count])=>({Size,Count}));
  const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Vat Sizes'); XLSX.writeFile(wb,'vat_sizes.csv');
};

/* ---------- Bootstrap ---------- */
async function bootstrap(){
  try{ await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL(); }catch(e){}
  const res=await storage.ref(FOLDER).listAll();
  CLOUD_KEYS=res.items.filter(x=>/\.json$/i.test(x.name)).map(x=>x.name).sort((a,b)=>keyToDn(a).localeCompare(keyToDn(b)));
  $('cloud-count').textContent=CLOUD_KEYS.length;
  renderSizes(); renderList([]); // placeholders quickly
  loadAll();                     // progressive fill (fast first screen, then full)
}
bootstrap();

/* ---------- Service Worker (inline) ---------- */
if('serviceWorker' in navigator){
  const swCode=`
    const CACHE='agora-precheck-v9';
    const CORE=[
      location.origin+location.pathname,
      'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css',
      'https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js',
      'https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js',
      'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js'
    ];
    self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CORE)));self.skipWaiting()});
    self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});
    self.addEventListener('fetch',e=>{
      e.respondWith(
        caches.match(e.request).then(hit=>hit || fetch(e.request).then(r=>{
          const copy=r.clone(); caches.open(CACHE).then(c=>c.put(e.request,copy)); return r;
        }).catch(()=>hit||Response.error()))
      );
    });
  `;
  const blob=new Blob([swCode],{type:'text/javascript'});
  const url=URL.createObjectURL(blob);
  navigator.serviceWorker.register(url).catch(()=>{});
}
</script>
</body>
</html>