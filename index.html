<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Agora Vat Pre-Check</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"/>

<style>
:root{ --brand:#001F3F; --accent:#FF851B; --muted:#6b7280; --bg:#f7f8fb; }
html,body{background:var(--bg);color:#0f172a;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
.app{max-width:1100px;margin:26px auto;padding:0 16px}
.brand-header{display:flex;gap:14px;align-items:center}
.brand-logo{width:160px;height:auto;display:none}
.brand-title h1{margin:0;font-weight:800;color:var(--brand)}
.brand-sub{color:var(--muted)}
.top-tabs{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
.tab-btn{border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:10px 14px;font-weight:700}
.tab-btn.active{outline:3px solid #ff851b2b;border-color:var(--accent)}
.counts{display:flex;gap:12px;align-items:center}
.progress{height:10px}
.panel{border:1px solid #e5e7eb;border-radius:16px;background:#fff;padding:14px;margin-bottom:12px}
.section-title{font-weight:800;margin-bottom:8px}
.form-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin-bottom:12px}
.form-card h6{font-weight:800;margin-bottom:10px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:900px){ .grid-2,.grid-3{grid-template-columns:1fr}}
.hint{color:#6b7280;font-size:.9rem}
.photo-thumb{width:110px;height:86px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;margin-top:6px}
.card-list{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media (max-width:900px){.card-list{grid-template-columns:1fr}}
.farm-card{border:1px solid #e5e7eb;border-radius:16px;background:#fff;padding:14px}
.farm-card:hover{box-shadow:0 6px 18px rgba(0,0,0,.06)}
.farm-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
.farm-title{font-size:1.15rem;font-weight:800}
.badge-soft{border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:.82rem}
.farm-lines{color:#111827}
.farm-actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
.btn-brand{background:var(--accent);border:none;color:#fff;font-weight:700}
.btn-brand:hover{background:#ff6d00}
.btn-outline-brand{border:1px solid var(--accent);color:var(--accent);background:#fff;font-weight:700}
.btn-outline-brand:hover{background:var(--accent);color:#fff}
.sticky-actions{position:sticky;bottom:8px;display:flex;gap:8px;flex-wrap:wrap}
.footer{color:#6b7280;text-align:center;margin:16px 0}

/* Brochure / Details / Print */
.print-sheet{max-width:900px;margin:0 auto;color:#0f172a}
.print-head{display:flex;align-items:center;gap:16px;border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:10px}
.print-head img{height:44px}
.print-title{font-weight:800;font-size:1.2rem}
.print-sub{color:#6b7280}
.print-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.print-card{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.print-label{font-weight:700;margin-bottom:6px}
.print-photos img{width:100%;max-height:180px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb;margin-bottom:8px}
.hidden{display:none!important}
</style>
</head>
<body>
<div class="app">
  <div class="brand-header">
    <img id="logo" class="brand-logo" alt="Agora">
    <div class="brand-title">
      <h1>Agora Vat Pre-Check</h1>
      <div class="brand-sub">Fast field capture • Smart summary • Customer-ready output</div>
    </div>
  </div>

  <div class="top-tabs">
    <button id="tab-form" class="tab-btn active">Form</button>
    <button id="tab-summary" class="tab-btn">Summary</button>
    <button id="tab-admin" class="tab-btn">Admin</button>
    <div class="ms-auto counts">
      <span>Cloud: <b id="cloud-count">–</b></span>
      <div class="progress" style="width:160px">
        <div id="sync-bar" class="progress-bar" role="progressbar" style="width:0%"></div>
      </div>
    </div>
  </div>

  <!-- ===== FORM ===== -->
  <div id="view-form">
    <div class="form-card">
      <div class="grid-3">
        <div>
          <label class="form-label">Dairy Number</label>
          <input id="dairyNumber" class="form-control" placeholder="e.g. 7016">
          <div class="hint">Blur to auto-fill directly from cloud (offline reads cached file if available).</div>
        </div>
        <div>
          <label class="form-label">Gateway Location</label>
          <input id="gateway-location" class="form-control">
        </div>
        <div>
          <label class="form-label">Gateway Photo</label>
          <input id="gateway-photo" type="file" accept="image/*" class="form-control">
          <img id="gateway-preview" class="photo-thumb d-none">
        </div>
      </div>
    </div>

    <div class="form-card">
      <h6>Vat 1</h6>
      <div class="grid-3">
        <div><label class="form-label">Capacity (L)</label><input id="vat1-capacity" class="form-control"></div>
        <div><label class="form-label">Cap</label><select id="vat1-cap" class="form-select"><option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option></select></div>
        <div><label class="form-label">Cap Photo</label><input id="vat1-cap-photo" type="file" accept="image/*" class="form-control"><img id="vat1-cap-preview" class="photo-thumb d-none"></div>
        <div><label class="form-label">Serial</label><input id="vat1-serial" class="form-control"></div>
        <div><label class="form-label">Condition</label><select id="vat1-condition" class="form-select"><option value="ok">OK</option><option value="attention">Attention required</option></select><input id="vat1-condition-comments" class="form-control mt-2" placeholder="comments"></div>
        <div><label class="form-label">Comments</label><input id="vat1-comments" class="form-control"></div>
        <div><label class="form-label">Agitator Location (Vat 1)</label><input id="agitator1-location" class="form-control"></div>
        <div><label class="form-label">Agitator Photo (Vat 1)</label><input id="agitator1-photo" type="file" accept="image/*" class="form-control"><img id="agitator1-preview" class="photo-thumb d-none"></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Vat 2 – Capacity</h6>
      <div class="grid-3"><div><label class="form-label">Capacity (L)</label><input id="vat2-capacity" class="form-control" placeholder="leave blank if N/A"><div class="hint">Entering a value reveals Vat 2 fields.</div></div></div>
    </div>

    <div id="vat2-extra" class="form-card d-none">
      <h6>Vat 2</h6>
      <div class="grid-3">
        <div><label class="form-label">Cap</label><select id="vat2-cap" class="form-select"><option value="na" selected>N/A</option><option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option></select></div>
        <div><label class="form-label">Cap Photo</label><input id="vat2-cap-photo" type="file" accept="image/*" class="form-control"><img id="vat2-cap-preview" class="photo-thumb d-none"></div>
        <div><label class="form-label">Serial</label><input id="vat2-serial" class="form-control"></div>
        <div><label class="form-label">Condition</label><select id="vat2-condition" class="form-select"><option value="ok">OK</option><option value="attention">Attention required</option></select><input id="vat2-condition-comments" class="form-control mt-2" placeholder="comments"></div>
        <div><label class="form-label">Comments</label><input id="vat2-comments" class="form-control"></div>
        <div><label class="form-label">Agitator Location (Vat 2)</label><input id="agitator2-location" class="form-control"></div>
        <div><label class="form-label">Agitator Photo (Vat 2)</label><input id="agitator2-photo" type="file" accept="image/*" class="form-control"><img id="agitator2-preview" class="photo-thumb d-none"></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Mobile Signal</h6>
      <div class="grid-3">
        <div><label class="form-label">Spark (bars)</label><input id="spark-bars" class="form-control"></div>
        <div><label class="form-label">Spark Note</label><input id="spark-note" class="form-control"></div>
        <div><label class="form-label">One NZ (bars)</label><input id="one-bars" class="form-control"></div>
        <div><label class="form-label">One NZ Note</label><input id="one-note" class="form-control"></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Other Telemetry</h6>
      <div class="grid-3">
        <div><label class="form-label">Brand</label><input id="other-brand" class="form-control"></div>
        <div><label class="form-label">Type</label><select id="other-type" class="form-select"><option value="">Select…</option><option value="vat">Vat</option><option value="water">Water</option><option value="fuel">Fuel</option><option value="other">Other</option></select></div>
        <div><label class="form-label">Notes</label><input id="other-notes" class="form-control"></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Rubberware</h6>
      <div class="grid-3">
        <div><label class="form-label">Vat Door Seal Delivered?</label><select id="door-delivered" class="form-select"><option value="no" selected>No</option><option value="yes">Yes</option></select></div>
        <div id="door-size-wrap" class="d-none"><label class="form-label">Door Seal Size</label><select id="door-size" class="form-select"><option value="">Unspecified</option><option value="small">Small</option><option value="large">Large</option></select><div class="hint">If two vats present, delivered count is 2.</div></div>
        <div><label class="form-label">Door Seal Photo</label><input id="door-photo" type="file" accept="image/*" class="form-control"><img id="door-preview" class="photo-thumb d-none"></div>
        <div><label class="form-label">RJT Step Seal Delivered?</label><select id="rjt-delivered" class="form-select"><option value="no" selected>No</option><option value="yes">Yes</option></select></div>
        <div id="rjt-size-wrap" class="d-none"><label class="form-label">RJT Size</label><select id="rjt-size" class="form-select"><option value="">Unspecified</option><option value="small">Small</option><option value="large">Large</option></select></div>
        <div><label class="form-label">RJT Photo</label><input id="rjt-photo" type="file" accept="image/*" class="form-control"><img id="rjt-preview" class="photo-thumb d-none"></div>
      </div>
    </div>

    <div class="sticky-actions">
      <button id="btn-save" class="btn btn-brand">Save / Update</button>
      <button id="btn-print" class="btn btn-outline-brand">Print Brochure</button>
      <button id="btn-summary-jump" class="btn btn-outline-brand">Go to Summary</button>
    </div>
  </div>

  <!-- ===== SUMMARY ===== -->
  <div id="view-summary" class="hidden">
    <div class="panel">
      <div class="section-title">Vat Size Breakdown (Cloud-First, fills instantly & updates live)</div>
      <div id="size-table" class="mb-2"></div>
      <div class="small text-muted" id="size-status"></div>
      <div class="d-flex flex-wrap gap-2 mt-2">
        <button id="btn-export-sizes" class="btn btn-outline-brand">Export Sizes CSV</button>
        <button id="btn-print-all" class="btn btn-outline-brand">Print All</button>
        <button id="btn-download-all" class="btn btn-brand">Download All (ZIP)</button>
      </div>
    </div>

    <div class="panel">
      <div class="section-title">Results (fast cards; photos inside Details/Print)</div>
      <div class="input-group mb-2">
        <span class="input-group-text">Search</span>
        <input id="searchBox" class="form-control" placeholder="Search dairy # or text (after Load All)">
        <button class="btn btn-outline-secondary" id="btnClearSearch">Clear</button>
        <button class="btn btn-outline-brand" id="btnLoadAll">Load All</button>
      </div>
      <div id="result-cards" class="card-list"></div>
      <div id="list-status" class="text-muted small mt-2"></div>
    </div>
  </div>

  <!-- ===== ADMIN ===== -->
  <div id="view-admin" class="hidden">
    <div class="panel">
      <div class="section-title">Data Tools</div>
      <div class="d-flex flex-wrap gap-2">
        <button id="btn-sync" class="btn btn-brand">Force Full Sync (cache JSON + brochures)</button>
        <button id="btn-owner-report" class="btn btn-outline-brand">Download Owner Report (HTML)</button>
      </div>
      <div class="small text-muted mt-2">
        Offline: the Service Worker caches every fetched farm JSON and each brochure HTML.  
        Use “Force Full Sync” to prefetch everything for offline.
      </div>
    </div>
  </div>

  <div class="footer">Agora • Vat Pre-Check • v4.0</div>
</div>

<div id="print-modal" class="hidden">
  <div class="print-sheet" id="print-sheet"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<!-- ZIP for “Download All” -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
/* ---------- Firebase ---------- */
const firebaseConfig = {
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const FOLDER = 'Pre Check';

/* ---------- State ---------- */
const Forms = new Map();   // normalized records keyed by dairyNumber
let CloudKeys = [];        // ["7008.json", ...]
let observer;

/* ---------- Helpers ---------- */
const $ = id=>document.getElementById(id);
const show = el=>el.classList.remove('hidden');
const hide = el=>el.classList.add('hidden');
function setProgress(done,total){ $('sync-bar').style.width = (total?Math.round(done/total*100):0)+'%'; }
const norm = s => (s||'').toString().toLowerCase();
function first(obj, keys){ for(const k of keys){ if(obj && obj[k]!=null && obj[k]!=='' ) return obj[k]; } return ''; }

(async()=>{ try{ const url=await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL(); $('logo').src=url; $('logo').style.display='block'; window._logoURL=url; }catch(_){}})();

/* Tabs */
const views = { 'tab-form':'view-form', 'tab-summary':'view-summary', 'tab-admin':'view-admin' };
Object.keys(views).forEach(t=>{
  $(t).onclick=()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    $(t).classList.add('active');
    Object.values(views).forEach(v=>hide($(v)));
    show($(views[t]));
    if(views[t]==='view-summary') initSummary();
  };
});
$('btn-summary-jump').onclick = ()=>$('tab-summary').click();

/* UI toggles */
function toggleVat2Extra(){ $('vat2-extra').classList.toggle('d-none', !($('vat2-capacity').value||'').trim()); }
$('vat2-capacity').addEventListener('input', toggleVat2Extra);
$('door-delivered').addEventListener('change', e=>$('door-size-wrap').classList.toggle('d-none', e.target.value!=='yes'));
$('rjt-delivered').addEventListener('change', e=>$('rjt-size-wrap').classList.toggle('d-none', e.target.value!=='yes'));
function setImgPreview(inputEl, imgEl){ const f=inputEl.files&&inputEl.files[0]; if(!f){ imgEl.classList.add('d-none'); return; } imgEl.src = URL.createObjectURL(f); imgEl.classList.remove('d-none'); }
['gateway','vat1-cap','agitator1','vat2-cap','agitator2','door','rjt'].forEach(k=>{
  const inp=$(k+'-photo'), img=$(k+'-preview'); if(inp) inp.addEventListener('change', ()=>setImgPreview(inp,img));
});

/* ---------- Normalizer ---------- */
function normalizePhotos(o){
  return {
    gateway: first(o,['gateway-photo-base64','gatewayBase64','gatewayPhoto','gatewayPhotoBase64','gateway-preview-base64']),
    vat1Cap: first(o,['vat1-cap-photo-base64','vat1CapPhoto','vat1CapPhotoBase64','vat1-cap-preview-base64']),
    agitator1: first(o,['agitator1-photo-base64','agitator-photo-base64','agitatorPhoto','agitator1PhotoBase64','agitator-preview-base64']),
    vat2Cap: first(o,['vat2-cap-photo-base64','vat2CapPhoto','vat2CapPhotoBase64','vat2-cap-preview-base64']),
    agitator2: first(o,['agitator2-photo-base64','agitator2PhotoBase64','agitator2-preview-base64']),
    door: first(o,['door-photo-base64','vat-door-seal-photo-base64','doorPhotoBase64','door-preview-base64']),
    rjt: first(o,['rjt-photo-base64','rjt-seal-photo-base64','rjtPhotoBase64','rjt-preview-base64'])
  };
}
function normalizeRecord(raw){
  const o = raw||{};
  const r = {
    dairyNumber: first(o,['dairyNumber','dairy','Dairy Number']) || '',
    gatewayLocation: first(o,['gateway-location','gatewayLocation','gateway','Gateway Location']) || '',
    vat1Capacity: first(o,['vat1-capacity','vat1Capacity','Vat 1 Capacity (L)','vat1']) || '',
    vat1Cap: (first(o,['vat1-cap','vat1Cap'])||'').toLowerCase(),
    vat1Serial: first(o,['vat1-serial','vat1Serial']) || '',
    vat1Condition: (first(o,['vat1-condition','vat1Condition'])||'ok').toLowerCase(),
    vat1ConditionComments: first(o,['vat1-condition-comments','vat1ConditionComments']) || '',
    vat1Comments: first(o,['vat1-comments','vat1Comments']) || '',
    agitator1Location: first(o,['agitator1-location','agitator-location']) || '',
    vat2Capacity: first(o,['vat2-capacity','vat2Capacity']) || '',
    vat2Cap: (first(o,['vat2-cap','vat2Cap']) || (first(o,['vat2-capacity'])?'available':'na')).toLowerCase(),
    vat2Serial: first(o,['vat2-serial','vat2Serial']) || '',
    vat2Condition: (first(o,['vat2-condition','vat2Condition'])||'ok').toLowerCase(),
    vat2ConditionComments: first(o,['vat2-condition-comments','vat2ConditionComments']) || '',
    vat2Comments: first(o,['vat2-comments','vat2Comments']) || '',
    agitator2Location: first(o,['agitator2-location']) || '',
    sparkBars: first(o,['spark-bars','sparkBars']) || '',
    sparkNote: first(o,['spark-note','sparkNote']) || '',
    oneBars: first(o,['one-bars','oneBars']) || '',
    oneNote: first(o,['one-note','oneNote']) || '',
    otherBrand: first(o,['other-brand','otherBrand']) || '',
    otherType: first(o,['other-type','otherType']) || '',
    otherNotes: (first(o,['other-notes','otherNotes']) + ' ' + first(o,['current-telemetry','telemetry-comments','gateway-comments'])).trim(),
    doorDelivered: (()=>{
      const v = first(o,['door-delivered','vat-door-seal']);
      if(v==='delivered' || v==='yes') return 'yes';
      if(v==='notdelivered' || v==='no') return 'no';
      return v ? v : 'no';
    })(),
    doorSize: first(o,['door-size','vat-door-seal-size','vat-door-size']) || '',
    rjtDelivered: (()=>{
      const v = first(o,['rjt-delivered','rjt-seal']);
      if(v==='delivered' || v==='yes') return 'yes';
      if(v==='notdelivered' || v==='no') return 'no';
      return v ? v : 'no';
    })(),
    rjtSize: first(o,['rjt-size','rjt-seal-size']) || '',
    timestamp: first(o,['timestamp','ts']) || 0
  };
  if(!r.vat1Cap){ const t=norm(r.vat1Comments); if(/cap.*unavail/.test(t)) r.vat1Cap='unavailable'; else if(/cap.*avail/.test(t)) r.vat1Cap='available'; }
  if(!r.vat2Cap && r.vat2Capacity){ r.vat2Cap='available'; }
  r.photos = normalizePhotos(o);
  r._blob = norm(JSON.stringify({r}));
  return r;
}

/* ---------- Cloud listing & fetch ---------- */
async function listCloudKeys(){
  try{
    const mref = storage.ref(FOLDER+'/_manifest.json');
    const url = await mref.getDownloadURL();
    const mani = await fetch(url).then(r=>r.json());
    const items = (mani.items||[]).filter(x=>/\.json$/i.test(x.key)).map(x=>x.key);
    $('cloud-count').textContent = items.length;
    return items;
  }catch(_){
    const res = await storage.ref(FOLDER).listAll();
    $('cloud-count').textContent = res.items.length;
    return res.items.filter(it=>/\.json$/i.test(it.name)).map(it=>it.name);
  }
}
async function fetchRecord(dnOrKey){
  try{
    const key = dnOrKey.endsWith?.('.json') ? dnOrKey : `${dnOrKey}.json`;
    const url = await storage.ref(`${FOLDER}/${key}`).getDownloadURL();
    const json = await fetch(url).then(r=>r.json()); // SW will cache
    const rec = normalizeRecord(json);
    if(!rec.dairyNumber) rec.dairyNumber = key.replace('.json','');
    Forms.set(rec.dairyNumber, rec);
    return rec;
  }catch(e){ console.warn('fetch failed', dnOrKey, e); return null; }
}
async function fetchMany(keys, concurrency=16, onTick){
  let i=0, done=0; const out=[];
  async function worker(){
    while(i<keys.length){
      const idx=i++; const k=keys[idx];
      const r = await fetchRecord(k);
      out[idx]=r;
      done++; onTick && onTick(done, keys.length);
    }
  }
  await Promise.all(Array.from({length:Math.min(concurrency,keys.length)}, worker));
  return out;
}

/* ---------- FORM autofill ---------- */
function setVal(id,v){ const el=$(id); if(el) el.value = v ?? ''; }
function populateForm(rec){
  setVal('dairyNumber', rec.dairyNumber);
  setVal('gateway-location', rec.gatewayLocation);
  setVal('vat1-capacity', rec.vat1Capacity); setVal('vat1-cap', rec.vat1Cap||'available');
  setVal('vat1-serial', rec.vat1Serial); setVal('vat1-condition', rec.vat1Condition||'ok');
  setVal('vat1-condition-comments', rec.vat1ConditionComments); setVal('vat1-comments', rec.vat1Comments);
  setVal('agitator1-location', rec.agitator1Location);
  setVal('vat2-capacity', rec.vat2Capacity); toggleVat2Extra();
  setVal('vat2-cap', rec.vat2Cap|| (rec.vat2Capacity?'available':'na'));
  setVal('vat2-serial', rec.vat2Serial); setVal('vat2-condition', rec.vat2Condition||'ok');
  setVal('vat2-condition-comments', rec.vat2ConditionComments); setVal('vat2-comments', rec.vat2Comments);
  setVal('agitator2-location', rec.agitator2Location);
  setVal('spark-bars', rec.sparkBars); setVal('spark-note', rec.sparkNote);
  setVal('one-bars', rec.oneBars); setVal('one-note', rec.oneNote);
  setVal('other-brand', rec.otherBrand); setVal('other-type', rec.otherType); setVal('other-notes', rec.otherNotes);
  setVal('door-delivered', rec.doorDelivered||'no'); $('door-size-wrap').classList.toggle('d-none', (rec.doorDelivered||'no')!=='yes'); setVal('door-size', rec.doorSize);
  setVal('rjt-delivered', rec.rjtDelivered||'no'); $('rjt-size-wrap').classList.toggle('d-none', (rec.rjtDelivered||'no')!=='yes'); setVal('rjt-size', rec.rjtSize);
}
$('dairyNumber').addEventListener('blur', async ()=>{
  const dn = ($('dairyNumber').value||'').trim(); if(!dn) return;
  const rec = Forms.get(dn) || await fetchRecord(dn);
  if(rec) populateForm(rec);
});

/* ---------- SAVE to cloud ---------- */
async function fileToB64(input){ const f=input.files&&input.files[0]; if(!f) return ''; return await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); }); }
async function gatherForm(){
  const dn = ($('dairyNumber').value||'').trim(); if(!dn) throw new Error('Dairy # required');
  const data = {
    dairyNumber: dn, timestamp: Date.now(),
    'gateway-location': $('gateway-location').value,
    'vat1-capacity': $('vat1-capacity').value, 'vat1-cap': $('vat1-cap').value, 'vat1-serial': $('vat1-serial').value,
    'vat1-condition': $('vat1-condition').value, 'vat1-condition-comments': $('vat1-condition-comments').value, 'vat1-comments': $('vat1-comments').value,
    'agitator1-location': $('agitator1-location').value,
    'vat2-capacity': $('vat2-capacity').value, 'vat2-cap': $('vat2-cap').value, 'vat2-serial': $('vat2-serial').value,
    'vat2-condition': $('vat2-condition').value, 'vat2-condition-comments': $('vat2-condition-comments').value, 'vat2-comments': $('vat2-comments').value,
    'agitator2-location': $('agitator2-location').value,
    'spark-bars': $('spark-bars').value, 'spark-note': $('spark-note').value, 'one-bars': $('one-bars').value, 'one-note': $('one-note').value,
    'other-brand': $('other-brand').value, 'other-type': $('other-type').value, 'other-notes': $('other-notes').value,
    'door-delivered': $('door-delivered').value, 'door-size': $('door-size').value, 'rjt-delivered': $('rjt-delivered').value, 'rjt-size': $('rjt-size').value,
    'gateway-photo-base64': await fileToB64($('gateway-photo')),
    'vat1-cap-photo-base64': await fileToB64($('vat1-cap-photo')),
    'agitator1-photo-base64': await fileToB64($('agitator1-photo')),
    'vat2-cap-photo-base64': await fileToB64($('vat2-cap-photo')),
    'agitator2-photo-base64': await fileToB64($('agitator2-photo')),
    'door-photo-base64': await fileToB64($('door-photo')),
    'rjt-photo-base64': await fileToB64($('rjt-photo'))
  };
  if(!data['vat2-capacity']) data['vat2-cap'] = 'na';
  return data;
}
async function uploadJson(path,obj){ const blob=new Blob([JSON.stringify(obj)],{type:'application/json'}); await storage.ref(path).put(blob); }
$('btn-save').onclick = async ()=>{
  try{
    $('btn-save').disabled = true; setProgress(0,1);
    const data = await gatherForm();
    await uploadJson(`${FOLDER}/${data.dairyNumber}.json`, data);
    Forms.set(data.dairyNumber, normalizeRecord(data));
    setProgress(1,1); alert('Saved ✔');
  }catch(e){ alert('Save failed: '+(e?.message||e)); }
  $('btn-save').disabled = false;
};
$('btn-print').onclick = async ()=>{
  const dn = ($('dairyNumber').value||'').trim();
  if(!dn){ alert('Enter a Dairy # first'); return; }
  const rec = Forms.get(dn) || await fetchRecord(dn);
  if(!rec){ alert('Save or sync first'); return; }
  openPrint(dn);
};

/* ---------- Vat Size Summary (cloud-first, instant & progressive) ---------- */
async function buildSizesSummary(){
  $('size-status').textContent = 'Listing…';
  const keys = CloudKeys.length ? CloudKeys : (CloudKeys = await listCloudKeys());
  const sizes = {}; let done=0;
  const tableEl = $('size-table');
  tableEl.innerHTML = '<table class="table table-sm table-bordered"><thead><tr><th>Vat Size (L)</th><th>Count</th></tr></thead><tbody id="size-body"></tbody></table>';
  const body = document.getElementById('size-body');

  // progressive fetch: only normalize sizes/serial minimal
  await fetchMany(keys, 24, (n,total)=>{
    done=n; $('size-status').textContent = `Scanning ${done}/${total}…`;
  });

  // aggregate from normalized Forms map
  for(const r of Forms.values()){
    if(r.vat1Capacity) sizes[r.vat1Capacity] = (sizes[r.vat1Capacity]||0)+1;
    if(r.vat2Capacity) sizes[r.vat2Capacity] = (sizes[r.vat2Capacity]||0)+1;
  }
  const rows = Object.entries(sizes).sort((a,b)=>parseInt(a[0])-parseInt(b[0]));
  body.innerHTML = rows.map(([sz,c])=>`<tr><td>${sz}</td><td>${c}</td></tr>`).join('') || '<tr><td colspan="2">No data</td></tr>';
  $('size-status').textContent = 'Done.';
}

/* ---------- Summary Results (fast cards) ---------- */
function vatLine(r,n){
  const cap = n===1? r.vat1Cap : r.vat2Cap;
  const size = n===1? r.vat1Capacity : r.vat2Capacity;
  const cond = n===1? r.vat1Condition : r.vat2Condition;
  const sn   = n===1? r.vat1Serial : r.vat2Serial;
  const capTxt = cap==='available'?'Cap available':(cap==='unavailable'?'Cap unavailable':(cap==='na'?'Cap N/A':'Cap —'));
  return `Vat ${n}: ${size||'—'} L • ${capTxt} • Cond ${cond}${sn?` • SN ${sn}`:''}`;
}
function signalLine(r){
  const s = r.sparkBars ? `Spark ${r.sparkBars}${r.sparkNote? ' – '+r.sparkNote:''}` : '';
  const o = r.oneBars ? `One NZ ${r.oneBars}${r.oneNote? ' – '+r.oneNote:''}` : '';
  return [s,o].filter(Boolean).join(' • ');
}
function rubberLine(r){
  const d = r.doorDelivered==='yes' ? `Door seal delivered${r.doorSize? ' ('+r.doorSize+')':''}` : 'Door seal notdelivered';
  const j = r.rjtDelivered==='yes' ? `RJT delivered${r.rjtSize? ' ('+r.rjtSize+')':''}` : 'RJT notdelivered';
  return `${d} • ${j}`;
}
function cardHTML(r){
  return `
  <div class="farm-card" id="card-${r.dairyNumber}">
    <div class="farm-head">
      <div class="farm-title">#${r.dairyNumber}</div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-brand" onclick="openDetails('${r.dairyNumber}')">Details</button>
        <button class="btn btn-sm btn-brand" onclick="openPrint('${r.dairyNumber}')">Print</button>
      </div>
    </div>
    <div class="farm-lines mt-1">
      <div>${vatLine(r,1)}</div>
      ${r.vat2Capacity? `<div>${vatLine(r,2)}</div>`:''}
      ${signalLine(r)? `<div>Signal: ${signalLine(r)}</div>`:''}
      <div>Rubberware: ${rubberLine(r)}</div>
      ${r.otherBrand || r.otherType || r.otherNotes ? `<div>Other telemetry: ${(r.otherBrand||'-')} ${r.otherType? '• '+r.otherType:''} ${r.otherNotes? '• '+r.otherNotes:''}</div>`:''}
    </div>
  </div>`;
}
async function initSummary(){
  // sizes first (cloud, progressive)
  buildSizesSummary();

  // results placeholders + JIT intersection loading
  if(!CloudKeys.length) CloudKeys = await listCloudKeys();
  const wrap = $('result-cards'); wrap.innerHTML='';
  const frag = document.createDocumentFragment();
  CloudKeys.forEach(k=>{
    const dn=k.replace('.json','');
    const d=document.createElement('div'); d.className='farm-card'; d.id='card-'+dn;
    d.innerHTML = `
      <div class="farm-head">
        <div class="farm-title">#${dn}</div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-brand" onclick="openDetails('${dn}')">Details</button>
          <button class="btn btn-sm btn-brand" onclick="openPrint('${dn}')">Print</button>
        </div>
      </div>
      <div class="text-muted">Loading…</div>`;
    frag.appendChild(d);
  });
  wrap.appendChild(frag);
  $('list-status').textContent='Scroll to load cards…';

  if(observer) observer.disconnect();
  observer = new IntersectionObserver(async entries=>{
    for(const e of entries){
      if(e.isIntersecting){
        const dn = e.target.id.replace('card-','');
        if(!Forms.get(dn)){
          const rec = await fetchRecord(dn);
          if(rec){ e.target.outerHTML = cardHTML(rec); }
        }
      }
    }
  },{rootMargin:'600px 0px'});
  document.querySelectorAll('.farm-card').forEach(el=>observer.observe(el));

  // search (dairy # quick; full-text after Load All)
  $('searchBox').oninput = ()=>{
    const q = ($('searchBox').value||'').trim();
    document.querySelectorAll('.farm-card').forEach(el=>{
      const dn = el.id.replace('card-','');
      el.style.display = dn.includes(q) ? '' : 'none';
    });
  };
  $('btnClearSearch').onclick = ()=>{ $('searchBox').value=''; $('searchBox').dispatchEvent(new Event('input')); };

  // Load All
  $('btnLoadAll').onclick = async ()=>{
    setProgress(0,1);
    const keys = CloudKeys.slice();
    await fetchMany(keys, 16, (done,total)=>setProgress(done,total));
    const rows = Array.from(Forms.values()).sort((a,b)=>String(a.dairyNumber).localeCompare(String(b.dairyNumber)));
    $('result-cards').innerHTML = rows.map(cardHTML).join('');
    $('list-status').textContent = 'All farms loaded (available offline).';
    // full text search
    $('searchBox').oninput = ()=>{
      const q = norm(($('searchBox').value||'')); 
      rows.forEach(r=>{
        const show = !q || r._blob.includes(q) || String(r.dairyNumber).includes(q);
        const el = document.getElementById('card-'+r.dairyNumber);
        if(el) el.style.display = show? '' : 'none';
      });
    };
  };
}

/* ---------- Brochure (details/print) ---------- */
function labeledPhoto(label,src){ if(!src) return ''; return `<div class="print-card"><div class="print-label">${label}</div><div class="print-photos"><img src="${src}"></div></div>`; }
function brochureHTML(r, withPhotos){
  const doorCount = (r.doorDelivered==='yes') ? (r.vat2Capacity?2:1) : 0;
  return `
  <div class="print-head">
    <img src="${window._logoURL||''}" alt="logo">
    <div><div class="print-title">Vat Pre-Check – #${r.dairyNumber}</div><div class="print-sub">Spark ${r.sparkBars||'-'} • One NZ ${r.oneBars||'-'}</div></div>
  </div>
  <div class="print-grid">
    <div class="print-card"><div class="print-label">Vat 1</div>
      <div>Capacity: <b>${r.vat1Capacity||'-'}</b></div>
      <div>Cap: <b>${(r.vat1Cap||'-').toUpperCase()}</b></div>
      <div>Serial: <b>${r.vat1Serial||'-'}</b></div>
      <div>Condition: <b>${r.vat1Condition||'-'}</b> ${r.vat1ConditionComments? '• '+r.vat1ConditionComments:''}</div>
      <div>Agitator: ${r.agitator1Location||'-'}</div>
      <div>Notes: ${r.vat1Comments||'-'}</div>
    </div>
    <div class="print-card"><div class="print-label">Vat 2</div>
      <div>Capacity: <b>${r.vat2Capacity||'-'}</b></div>
      <div>Cap: <b>${(r.vat2Cap||'-').toUpperCase()}</b></div>
      <div>Serial: <b>${r.vat2Serial||'-'}</b></div>
      <div>Condition: <b>${r.vat2Condition||'-'}</b> ${r.vat2ConditionComments? '• '+r.vat2ConditionComments:''}</div>
      <div>Agitator: ${r.agitator2Location||'-'}</div>
      <div>Notes: ${r.vat2Comments||'-'}</div>
    </div>
    <div class="print-card"><div class="print-label">Gateway</div><div>Location: <b>${r.gatewayLocation||'-'}</b></div></div>
    <div class="print-card"><div class="print-label">Other Telemetry</div><div>Brand: <b>${r.otherBrand||'-'}</b> • Type: <b>${r.otherType||'-'}</b></div><div>Notes: ${r.otherNotes||'-'}</div></div>
    <div class="print-card"><div class="print-label">Rubberware</div>
      <div>Door Seal: <b>${r.doorDelivered==='yes'?'Delivered':'No'}</b> ${r.doorSize? '• '+r.doorSize:''} ${doorCount? '(x'+doorCount+')':''}</div>
      <div>RJT: <b>${r.rjtDelivered==='yes'?'Delivered':'No'}</b> ${r.rjtSize? '• '+r.rjtSize:''}</div>
    </div>
  </div>
  ${withPhotos ? `
  <div class="print-grid" style="margin-top:10px">
    ${labeledPhoto('Gateway', r.photos.gateway)}
    ${labeledPhoto('Vat 1 Cap', r.photos.vat1Cap)}
    ${labeledPhoto('Agitator (Vat 1)', r.photos.agitator1)}
    ${labeledPhoto('Vat 2 Cap', r.photos.vat2Cap)}
    ${labeledPhoto('Agitator (Vat 2)', r.photos.agitator2)}
    ${labeledPhoto('Door Seal', r.photos.door)}
    ${labeledPhoto('RJT', r.photos.rjt)}
  </div>`:''}
  `;
}
window.openDetails = async (dn)=>{
  const r = Forms.get(dn) || await fetchRecord(dn);
  if(!r) return;
  $('tab-summary').click();
  $('result-cards').innerHTML = `<div class="farm-card">${brochureHTML(r,false)}</div>`;
  window.scrollTo({top:0,behavior:'smooth'});
};
window.openPrint = async (dn)=>{
  const r = Forms.get(dn) || await fetchRecord(dn);
  if(!r) return;
  await cacheBrochureHTML(r); // store offline version
  const sheet = brochureHTML(r,true);
  const css=document.querySelector('style').innerHTML;
  const w=window.open('', '_blank');
  w.document.write(`<html><head><meta charset="utf-8"><title>Print #${dn}</title><style>body{font-family:Inter,Arial,sans-serif;padding:16px}${css}</style></head><body>${sheet}</body></html>`);
  w.document.close(); setTimeout(()=>w.print(),350);
};

/* ---------- Print All & Download All ---------- */
$('btn-print-all').onclick = async ()=>{
  if(!CloudKeys.length) CloudKeys = await listCloudKeys();
  await fetchMany(CloudKeys, 16, null);
  const css=document.querySelector('style').innerHTML;
  const rows = Array.from(Forms.values()).sort((a,b)=>String(a.dairyNumber).localeCompare(String(b.dairyNumber)));
  // also cache brochures for offline later
  await Promise.all(rows.map(cacheBrochureHTML));
  const html = rows.map(r=>`<div class="panel">${brochureHTML(r,true)}</div>`).join('');
  const w=window.open('', '_blank');
  w.document.write(`<html><head><meta charset="utf-8"><title>Print All</title><style>body{font-family:Inter,Arial,sans-serif;padding:16px}${css}</style></head><body class="app">${html}</body></html>`);
  w.document.close(); setTimeout(()=>w.print(),500);
};
$('btn-download-all').onclick = async ()=>{
  if(!CloudKeys.length) CloudKeys = await listCloudKeys();
  await fetchMany(CloudKeys, 16, null);
  const rows = Array.from(Forms.values());
  const css=document.querySelector('style').innerHTML;
  const zip = new JSZip();
  for(const r of rows){
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Farm ${r.dairyNumber}</title><style>body{font-family:Inter,Arial,sans-serif;padding:16px}${css}</style></head><body>${brochureHTML(r,true)}</body></html>`;
    zip.file(`brochure_${r.dairyNumber}.html`, html);
  }
  const blob = await zip.generateAsync({type:'blob'});
  saveAs(blob, 'agora_brochures.zip');
};

/* ---------- Owner Report (correct) ---------- */
$('btn-owner-report').onclick = ()=>{
  const rows = Array.from(Forms.values()).sort((a,b)=>String(a.dairyNumber).localeCompare(String(b.dairyNumber)));
  if(!rows.length){ alert('Open Summary and Load All first.'); return; }
  const css = document.querySelector('style').innerHTML;

  // Sizes
  const sizes={}; rows.forEach(r=>{ if(r.vat1Capacity) sizes[r.vat1Capacity]=(sizes[r.vat1Capacity]||0)+1; if(r.vat2Capacity) sizes[r.vat2Capacity]=(sizes[r.vat2Capacity]||0)+1; });
  let sizeHtml='<table class="table table-sm table-bordered"><thead><tr><th>Vat Size (L)</th><th>Count</th></tr></thead><tbody>';
  Object.entries(sizes).sort((x,y)=>parseInt(x[0])-parseInt(y[0])).forEach(([s,c])=> sizeHtml+=`<tr><td>${s}</td><td>${c}</td></tr>`); sizeHtml+='</tbody></table>';

  // Serials per farm & vat
  let serialHtml='<table class="table table-sm table-bordered"><thead><tr><th>Dairy</th><th>Vat</th><th>Size</th><th>Serial</th></tr></thead><tbody>';
  rows.forEach(r=>{
    if(r.vat1Capacity) serialHtml+=`<tr><td>${r.dairyNumber}</td><td>1</td><td>${r.vat1Capacity}</td><td>${r.vat1Serial||''}</td></tr>`;
    if(r.vat2Capacity) serialHtml+=`<tr><td>${r.dairyNumber}</td><td>2</td><td>${r.vat2Capacity}</td><td>${r.vat2Serial||''}</td></tr>`;
  });
  serialHtml+='</tbody></table>';

  // Rubber summary
  let rubberHtml='<table class="table table-sm table-bordered"><thead><tr><th>Dairy</th><th>Door Seal</th><th>RJT</th></tr></thead><tbody>';
  rows.forEach(r=>{
    rubberHtml+=`<tr><td>${r.dairyNumber}</td><td>${r.doorDelivered==='yes' ? ('Delivered'+(r.doorSize? ' ('+r.doorSize+')':'') ): 'No'}</td><td>${r.rjtDelivered==='yes' ? ('Delivered'+(r.rjtSize? ' ('+r.rjtSize+')':'') ): 'No'}</td></tr>`;
  });
  rubberHtml+='</tbody></table>';

  const body = `<div class="app"><div class="brand-header"><img src="${window._logoURL||''}" class="brand-logo" style="display:block"><div class="brand-title"><h1>Owner Report</h1><div class="brand-sub">${new Date().toISOString().slice(0,10)}</div></div></div><div class="panel"><div class="section-title">Vat Size Breakdown</div>${sizeHtml}</div><div class="panel"><div class="section-title">Serial Numbers</div>${serialHtml}</div><div class="panel"><div class="section-title">Rubberware Summary</div>${rubberHtml}</div>${rows.map(r=>`<div class="panel">${brochureHTML(r,true)}</div>`).join('')}</div>`;
  const blob = new Blob([`<html><head><meta charset="utf-8"><title>Owner Report</title><style>${css}</style></head><body>${body}</body></html>`],{type:'text/html'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='owner_report.html'; a.click();
};

/* ---------- Cache brochures for offline (via SW) ---------- */
async function cacheBrochureHTML(r){
  if(!('caches' in window)) return;
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Farm ${r.dairyNumber}</title><style>${document.querySelector('style').innerHTML}</style></head><body>${brochureHTML(r,true)}</body></html>`;
  const req = new Request(`./brochures/${r.dairyNumber}.html`);
  const res = new Response(new Blob([html],{type:'text/html'}), {headers:{'Content-Type':'text/html'}});
  const cache = await caches.open('agora-form-cache-v56');
  await cache.put(req, res);
}

/* ---------- Admin: Force full sync (also caches brochures) ---------- */
$('btn-sync').onclick = async ()=>{
  if(!CloudKeys.length) CloudKeys = await listCloudKeys();
  setProgress(0,1);
  await fetchMany(CloudKeys, 16, (done,total)=>setProgress(done,total));
  const rows = Array.from(Forms.values());
  await Promise.all(rows.map(cacheBrochureHTML));
  alert('Full sync complete. JSON + brochures stored for offline.');
};

/* ---------- Summary init ---------- */
window.addEventListener('DOMContentLoaded', async ()=>{
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js').catch(()=>{}); }
  try{ CloudKeys = await listCloudKeys(); }catch(_){}
});
</script>
</body>
</html>