<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agora Vat Pre Check</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <style>
    body { background: #002B5C; color: #fff; font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 900px; margin: auto; background: #002B5C; padding: 30px; border-radius: 10px; }
    h1,h2 { color: #a7ab01; text-align: center; }
    .form-control, .form-select { margin-top: 5px; }
    .checklist-item { margin-bottom: 20px; }
    .image-preview { display:none; max-width:200px; margin-top:5px; border:2px solid #ccc; }
    .record-container { display:none; background:#fff; color:#000; padding:20px; border-radius:10px; max-width:900px; margin:auto; }
    .record-list div { margin-bottom:10px; cursor:pointer; color:#007bff; }
    .back-button { background:#002B5C; color:#fff; padding:10px 20px; border:none; border-radius:5px; }
    button { margin:5px; background:#FF851B; color:#fff; border:none; padding:10px 20px; border-radius:5px; }
    button:hover { background:#FF4136; }
  </style>
</head>
<body>
  <div class="container" id="form-container">
    <h1>Agora Vat Pre Check</h1>
    <form id="vat-precheck-form">
      <h2>Vat Details</h2>
      <div class="checklist-item">
        <label>Dairy Number:</label>
        <input type="text" id="dairyNumber" name="dairyNumber" class="form-control" required>
      </div>
      <div class="checklist-item">
        <label>Vat Cap:</label>
        <select id="vat-cap" name="vatCap" class="form-select" onchange="onVatCapChange()">
          <option value="available">Available ✓</option>
          <option value="unavailable">Unavailable ✗</option>
        </select>
        <div id="vat-cap-extra" style="display:none; margin-top:10px;">
          <label>Select Vat(s):</label>
          <select id="vat-number" name="vatNumber" class="form-select">
            <option value="1">Vat 1</option>
            <option value="2">Vat 2</option>
            <option value="both">Both</option>
          </select>
        </div>
        <label>Comments:</label>
        <input type="text" id="vat-cap-comments" name="vatCapComments" class="form-control">
        <input type="file" id="vat-cap-photo" class="form-control" accept="image/*" style="display:none;"
               onchange="previewImage(event,'vat-cap-preview')">
        <img id="vat-cap-preview" class="image-preview">
      </div>
      <div class="checklist-item">
        <label>Gateway Location:</label>
        <input type="text" id="gateway-location" name="gatewayLocation" class="form-control">
        <label>Comments:</label>
        <input type="text" id="gateway-comments" name="gatewayComments" class="form-control">
        <input type="file" id="gateway-photo" class="form-control" accept="image/*"
               onchange="previewImage(event,'gateway-preview')">
        <img id="gateway-preview" class="image-preview">
      </div>
      <div class="checklist-item">
        <label>Agitator Sensor Location:</label>
        <input type="text" id="agitator-location" name="agitatorLocation" class="form-control">
        <label>Comments:</label>
        <input type="text" id="agitator-comments" name="agitatorComments" class="form-control">
        <input type="file" id="agitator-photo" class="form-control" accept="image/*"
               onchange="previewImage(event,'agitator-preview')">
        <img id="agitator-preview" class="image-preview">
      </div>
      <div class="checklist-item">
        <label>Current Telemetry:</label>
        <input type="text" id="current-telemetry" name="currentTelemetry" class="form-control">
        <label>Comments:</label>
        <input type="text" id="telemetry-comments" name="telemetryComments" class="form-control">
      </div>
      <button type="button" onclick="generatePDF()">Generate PDF</button>
      <button type="button" onclick="viewRecords()">View All Records</button>
    </form>
  </div>

  <div id="record-container" class="record-container">
    <h2>Vat Results Checklist</h2>
    <div id="record-list" class="record-list"></div>
    <button class="back-button" onclick="goBack()">Back</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script>
    // Firebase init
    const firebaseConfig = { /* your config */ };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    // Dexie init
    const db = new Dexie('VatPreCheck');
    db.version(1).stores({ forms: '++id,dairyNumber' });

    // Toggle extra fields
    function onVatCapChange() {
      const extra = document.getElementById('vat-cap-extra');
      const photo = document.getElementById('vat-cap-photo');
      const preview = document.getElementById('vat-cap-preview');
      if (document.getElementById('vat-cap').value === 'available') {
        extra.style.display = 'block';
        photo.style.display = 'none'; preview.style.display = 'none';
      } else {
        extra.style.display = 'none';
        photo.style.display = 'block';
      }
    }
    // Image preview
    function previewImage(e,id) {
      const img = document.getElementById(id);
      img.src = URL.createObjectURL(e.target.files[0]);
      img.style.display = 'block';
    }
    // Save form
    async function saveForm() {
      const form = document.getElementById('vat-precheck-form');
      const fd = new FormData(form);
      const data = Object.fromEntries(fd.entries());
      data.timestamp = Date.now();
      await db.forms.add(data);
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      await storage.ref(`AgoraVatPreCheck/${data.dairyNumber}.json`).put(blob);
    }
    // Generate PDF
    async function generatePDF() {
      await saveForm();
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('l','pt','a4');
      pdf.setFontSize(16);
      pdf.text('Agora Vat Pre Check', 40, 40);
      const fd = new FormData(document.getElementById('vat-precheck-form'));
      const rows = [];
      for (let [k,v] of fd.entries()) rows.push([k, v]);
      pdf.autoTable({
        startY: 60,
        head: [['Field','Value']],
        body: rows,
        styles: { fontSize: 10, cellPadding: 4 },
        headStyles: { fillColor: [0,43,92], textColor: 255 }
      });
      pdf.save(`VatPreCheck_${fd.get('dairyNumber')}.pdf`);
    }
    // View records
    function viewRecords() {
      document.getElementById('form-container').style.display = 'none';
      document.getElementById('record-container').style.display = 'block';
      loadRecords();
    }
    async function loadRecords() {
      const recs = await db.forms.toArray();
      const list = document.getElementById('record-list');
      list.innerHTML = '';
      recs.forEach(r => {
        const div = document.createElement('div');
        const dt = new Date(r.timestamp).toLocaleString();
        div.textContent = `${dt} — ${r.dairyNumber} : Vat Cap ${r.vatCap} ${r.vatCapComments}`;
        list.appendChild(div);
      });
    }
    function goBack() {
      document.getElementById('record-container').style.display = 'none';
      document.getElementById('form-container').style.display = 'block';
    }
    document.addEventListener('DOMContentLoaded', () => {
      onVatCapChange();
    });
  </script>
</body>
</html>
