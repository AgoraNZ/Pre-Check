<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Agora Vat Pre-Check (Flash)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"/>
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<style>
  :root{
    --bg:#f7f9ff; --ink:#0f1b2d; --muted:#6b7280; --brand:#a7ab01; --accent:#FF851B; --ink-2:#173559;
  }
  body{background:var(--bg); color:var(--ink); font-family:system-ui, Segoe UI, Arial, sans-serif; padding:18px}
  .shell{max-width:1100px;margin:0 auto}
  .logo{max-width:220px; display:block; margin:0 auto 6px}
  h1{color:var(--brand); font-size:1.8rem; text-align:center; margin-bottom:14px}
  .navrow{display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin:10px 0 18px}
  .btn-brand{background:var(--accent); color:#fff; border:none; border-radius:8px; padding:9px 14px; font-weight:600}
  .btn-brand:hover{filter:brightness(.95)}
  .btn-plain{background:#fff; border:1px solid #ddd; border-radius:8px; padding:9px 14px; color:var(--ink)}
  .hidden{display:none!important}

  /* Form & sections */
  .cardish{background:#fff; border:1px solid #eaecef; border-radius:14px; padding:14px; box-shadow:0 2px 20px #001F3F10}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
  .grid-4{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
  @media (max-width:900px){ .grid-2,.grid-3,.grid-4{grid-template-columns:1fr} }

  .section-title{font-weight:800; color:var(--ink-2); margin:10px 0 2px}
  .image-preview{display:none; max-width:200px; margin-top:6px; border:1px solid #ddd; border-radius:10px}
  .muted{color:var(--muted); font-size:.95em}

  /* Flash cards */
  .cards{display:grid; grid-template-columns:repeat(3, 1fr); gap:12px}
  @media (max-width:1000px){ .cards{grid-template-columns:repeat(2, 1fr)} }
  @media (max-width:680px){ .cards{grid-template-columns:1fr} }
  .kcard{background:#fff; border:1px solid #e7ebf2; border-radius:14px; padding:12px; box-shadow:0 1px 12px #0000000b}
  .khead{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .knum{font-weight:800; font-size:1.05rem}
  .kbadges{display:flex; gap:6px; flex-wrap:wrap}
  .tag{display:inline-block; border:1px solid #e5e7eb; border-radius:999px; padding:2px 8px; font-size:.82em}
  .tag.attn{border-color:#ffc9c9; background:#fff2f2}
  .tag.good{border-color:#c7f9cc; background:#f0fff3}
  .kbody{margin-top:8px; font-size:.95em}
  .thumbs{margin-top:8px}
  .thumbs img{height:56px; width:auto; border-radius:8px; border:1px solid #eee; margin-right:6px}
  .link{color:#0b63c7; text-decoration:underline; cursor:pointer}

  /* KPI tiles */
  .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin:8px 0}
  @media (max-width:900px){ .kpis{grid-template-columns:repeat(2,1fr)} }
  .kpi{background:#fff; border:1px solid #eee; border-radius:12px; padding:10px; text-align:center}
  .kpi .n{font-size:1.4rem; font-weight:900}

  /* Admin */
  .toolrow{display:flex; gap:8px; flex-wrap:wrap}
</style>
</head>
<body>
<div class="shell">
  <img id="logo" class="logo" alt="Agora Logo" />
  <h1>Agora Vat Pre-Check</h1>

  <div class="navrow">
    <button class="btn-brand" id="btn-form">Form</button>
    <button class="btn-plain" id="btn-flash">Summary</button>
    <button class="btn-plain hidden" id="btn-admin">Admin</button>
  </div>

  <!-- FORM -->
  <div id="pane-form" class="cardish">
    <div class="grid-2">
      <div>
        <label class="form-label">Dairy Number</label>
        <input class="form-control" id="dairyNumber" name="dairyNumber" placeholder="e.g. 5244" />
      </div>
      <div class="muted">Fields auto-load if this Dairy # exists in cloud.</div>
    </div>

    <hr>

    <div class="section-title">Vat Details</div>
    <div class="grid-2">
      <div>
        <label class="form-label">Vat 1 Capacity (L)</label>
        <input class="form-control" id="vat1-capacity" name="vat1-capacity" />
      </div>
      <div>
        <label class="form-label">Vat 2 Capacity (L)</label>
        <input class="form-control" id="vat2-capacity" name="vat2-capacity" oninput="showVat2Serial()" />
      </div>
      <div>
        <label class="form-label">Vat 1 Cap</label>
        <select class="form-select" id="vat1-cap" name="vat1-cap" onchange="togglePhotos('vat1-cap')">
          <option value="">Select…</option>
          <option value="available">Available ✓</option>
          <option value="unavailable">Unavailable ✗</option>
        </select>
        <input type="file" id="vat1-cap-photo" class="form-control mt-1" accept="image/*" style="display:none" onchange="previewImage(event,'vat1-cap-preview')">
        <img id="vat1-cap-preview" class="image-preview">
      </div>
      <div>
        <label class="form-label">Vat 2 Cap</label>
        <select class="form-select" id="vat2-cap" name="vat2-cap" onchange="togglePhotos('vat2-cap')">
          <option value="">Select…</option>
          <option value="na">N/A</option>
          <option value="available">Available ✓</option>
          <option value="unavailable">Unavailable ✗</option>
        </select>
        <input type="file" id="vat2-cap-photo" class="form-control mt-1" accept="image/*" style="display:none" onchange="previewImage(event,'vat2-cap-preview')">
        <img id="vat2-cap-preview" class="image-preview">
      </div>

      <div class="grid-2" style="grid-column:1/-1;gap:12px">
        <div>
          <label class="form-label">Vat 1 Condition</label>
          <select id="vat1-condition" name="vat1-condition" class="form-select" onchange="toggleVatCondition('vat1-condition')">
            <option value="">Select…</option>
            <option value="ok">OK</option>
            <option value="attention">Attention Required</option>
          </select>
          <div id="vat1-condition-extra" class="mt-1" style="display:none">
            <input class="form-control" id="vat1-condition-comments" name="vat1-condition-comments" placeholder="Notes"/>
            <input type="file" id="vat1-condition-photo" class="form-control mt-1" accept="image/*" onchange="previewImage(event,'vat1-condition-preview')">
            <img id="vat1-condition-preview" class="image-preview">
          </div>
        </div>
        <div>
          <label class="form-label">Vat 2 Condition</label>
          <select id="vat2-condition" name="vat2-condition" class="form-select" onchange="toggleVatCondition('vat2-condition')">
            <option value="">Select…</option>
            <option value="na">N/A</option>
            <option value="ok">OK</option>
            <option value="attention">Attention Required</option>
          </select>
          <div id="vat2-condition-extra" class="mt-1" style="display:none">
            <input class="form-control" id="vat2-condition-comments" name="vat2-condition-comments" placeholder="Notes"/>
            <input type="file" id="vat2-condition-photo" class="form-control mt-1" accept="image/*" onchange="previewImage(event,'vat2-condition-preview')">
            <img id="vat2-condition-preview" class="image-preview">
          </div>
        </div>
      </div>

      <div>
        <label class="form-label">Vat 1 Level (optional)</label>
        <select id="vat1-level" class="form-select" name="vat1-level">
          <option value="">Select…</option>
          <option>Low</option><option>Medium</option><option>High</option>
        </select>
      </div>
      <div>
        <label class="form-label">Vat 2 Level (optional)</label>
        <select id="vat2-level" class="form-select" name="vat2-level">
          <option value="">Select…</option>
          <option value="na">N/A</option>
          <option>Low</option><option>Medium</option><option>High</option>
        </select>
      </div>

      <div>
        <label class="form-label">Vat 1 Serial</label>
        <input class="form-control" id="vat1-serial" name="vat1-serial"/>
      </div>
      <div id="vat2-serial-section">
        <label class="form-label">Vat 2 Serial</label>
        <input class="form-control" id="vat2-serial" name="vat2-serial"/>
      </div>

      <div style="grid-column:1/-1">
        <label class="form-label">Vat 1 Comments</label>
        <input class="form-control" id="vat1-comments" name="vat1-comments" placeholder="width/notes, e.g., grey cap / reducing cap"/>
      </div>
      <div style="grid-column:1/-1">
        <label class="form-label">Vat 2 Comments</label>
        <input class="form-control" id="vat2-comments" name="vat2-comments" placeholder="width/notes, e.g., gray cap / DTS"/>
      </div>
    </div>

    <hr>

    <div class="section-title">Agitator</div>
    <div class="grid-2">
      <div>
        <label class="form-label">Agitator Sensor Location</label>
        <input class="form-control" id="agitator-location" name="agitator-location"/>
      </div>
      <div>
        <label class="form-label">Comments</label>
        <input class="form-control" id="agitator-comments" name="agitator-comments" placeholder="sensor, cable, power…"/>
      </div>
      <div style="grid-column:1/-1">
        <input type="file" id="agitator-photo" class="form-control" accept="image/*" onchange="previewImage(event,'agitator-preview')">
        <img id="agitator-preview" class="image-preview">
      </div>
    </div>

    <hr>

    <div class="section-title">Gateway</div>
    <div class="grid-2">
      <div>
        <label class="form-label">Gateway Location</label>
        <input class="form-control" id="gateway-location" name="gateway-location"/>
      </div>
      <div>
        <label class="form-label">Comments</label>
        <input class="form-control" id="gateway-comments" name="gateway-comments" placeholder="needs powerpoint, ethernet, mounting…"/>
      </div>
      <div style="grid-column:1/-1">
        <input type="file" id="gateway-photo" class="form-control" accept="image/*" onchange="previewImage(event,'gateway-preview')">
        <img id="gateway-preview" class="image-preview">
      </div>
    </div>

    <hr>

    <div class="section-title">Other Telemetry</div>
    <div class="grid-2">
      <div>
        <label class="form-label">Current Telemetry</label>
        <input class="form-control" id="current-telemetry" name="current-telemetry" placeholder="Halo / Allflex / DTS / none"/>
      </div>
      <div>
        <label class="form-label">Comments</label>
        <input class="form-control" id="telemetry-comments" name="telemetry-comments" placeholder="grey halo / sensor present / network…"/>
      </div>
    </div>

    <hr>

    <div class="section-title">Rubberware</div>
    <div class="grid-2">
      <div>
        <label class="form-label">Vat Door Seal</label>
        <select id="vat-door-seal" name="vat-door-seal" class="form-select" onchange="toggleVatDoorSeal()">
          <option value="">Select…</option>
          <option value="notdelivered">Not Delivered</option>
          <option value="delivered">Delivered</option>
        </select>
        <div id="vat-door-seal-extra" class="mt-1" style="display:none">
          <input class="form-control" id="vat-door-seal-comments" name="vat-door-seal-comments" placeholder="Notes"/>
          <div class="grid-2 mt-1">
            <div>
              <label class="form-label">Vat 1 Door Seal Size</label>
              <select id="vat1-door-seal-size" name="vat1-door-seal-size" class="form-select">
                <option value="">Select…</option><option value="small">Small</option><option value="large">Large</option>
              </select>
            </div>
            <div>
              <label class="form-label">Vat 2 Door Seal Size</label>
              <select id="vat2-door-seal-size" name="vat2-door-seal-size" class="form-select">
                <option value="">Select…</option><option value="small">Small</option><option value="large">Large</option>
              </select>
            </div>
          </div>
          <input type="file" id="vat-door-seal-photo" class="form-control mt-1" accept="image/*" onchange="previewImage(event,'vat-door-seal-preview')">
          <img id="vat-door-seal-preview" class="image-preview">
        </div>
      </div>
      <div>
        <label class="form-label">RJT Step Seal</label>
        <select id="rjt-seal" name="rjt-seal" class="form-select" onchange="toggleRjtSeal()">
          <option value="">Select…</option>
          <option value="notdelivered">Not Delivered</option>
          <option value="delivered">Delivered</option>
        </select>
        <div id="rjt-seal-extra" class="mt-1" style="display:none">
          <input class="form-control" id="rjt-seal-comments" name="rjt-seal-comments" placeholder="Notes"/>
          <select id="rjt-seal-size" name="rjt-seal-size" class="form-select mt-1">
            <option value="">Step Seal Size…</option><option value="small">Small</option><option value="large">Large</option>
          </select>
          <input type="file" id="rjt-seal-photo" class="form-control mt-1" accept="image/*" onchange="previewImage(event,'rjt-seal-preview')">
          <img id="rjt-seal-preview" class="image-preview">
        </div>
      </div>
      <div>
        <label class="form-label">Chiller Condition</label>
        <select id="chiller-condition" name="chiller-condition" class="form-select" onchange="toggleChillerCondition()">
          <option value="">Select…</option>
          <option value="ok">OK</option>
          <option value="attention">Attention Required</option>
        </select>
        <div id="chiller-condition-extra" class="mt-1" style="display:none">
          <input class="form-control" id="chiller-condition-comments" name="chiller-condition-comments" placeholder="Notes"/>
          <input type="file" id="chiller-condition-photo" class="form-control mt-1" accept="image/*" onchange="previewImage(event,'chiller-condition-preview')">
          <img id="chiller-condition-preview" class="image-preview">
        </div>
      </div>
    </div>

    <div class="mt-3">
      <button class="btn-brand" id="btn-save">Save</button>
      <button class="btn-plain" id="btn-pdf">Generate PDF</button>
      <span class="muted" id="save-msg"></span>
    </div>
  </div>

  <!-- FLASH SUMMARY -->
  <div id="pane-flash" class="cardish hidden">
    <div class="grid-3">
      <div><input id="q" class="form-control" placeholder="Search Dairy / text"/></div>
      <div>
        <select id="filter-mode" class="form-select">
          <option value="">All</option>
          <option value="attention">Attention Required</option>
          <option value="no-cap">No Available Vat Cap</option>
        </select>
      </div>
      <div><button class="btn-plain" id="btn-refresh">Refresh</button></div>
    </div>

    <div class="kpis" id="kpi-box"></div>
    <div class="cards" id="cards"></div>
    <div id="flash-summary" class="mt-2"></div>
  </div>

  <!-- ADMIN -->
  <div id="pane-admin" class="cardish hidden">
    <div class="toolrow">
      <button class="btn-brand" id="dl-csv">Download CSV</button>
      <button class="btn-brand" id="dl-xlsx">Download XLSX</button>
      <button class="btn-plain" id="dl-json">Download JSON</button>
    </div>
    <div class="muted mt-2">Admin view only provides downloads. Open this page with <code>?admin=1</code> to show this tab.</div>
  </div>
</div>

<!-- LIBS -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
/* ================= BASIC CONFIG ================= */
const STORAGE_FOLDER = "Pre Check"; // exact folder of your JSON files
const LOGO_PATH = "Agora Logo/2F6-1YdaEP.jpeg";
const DEBUG = true;

const firebaseConfig = {
  apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain: "dairy-farm-record-system.firebaseapp.com",
  projectId: "dairy-farm-record-system",
  storageBucket: "dairy-farm-record-system.appspot.com",
  messagingSenderId: "422124188212",
  appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

const db = new Dexie('VatPreCheckAI');
db.version(1).stores({ forms:'++id,dairyNumber' });

/* ================= LOGO ================= */
let logoBase64="", logoAspect=1;
(async function loadLogo(){
  try{
    const url = await storage.ref(LOGO_PATH).getDownloadURL();
    const img = document.getElementById('logo');
    img.src = url; img.style.display='block';
    const blob = await (await fetch(url)).blob();
    const fr=new FileReader();
    fr.onload = (e)=>{ logoBase64=e.target.result; const t=new Image(); t.onload=()=>logoAspect=t.width/t.height; t.src=logoBase64; };
    fr.readAsDataURL(blob);
  }catch(e){ if(DEBUG) console.warn('Logo load failed', e); document.getElementById('logo').style.display='none'; }
})();

/* ================= UTIL ================= */
const $ = (id)=>document.getElementById(id);
function previewImage(e, id){
  const img=$(id);
  const file=e.target.files?.[0];
  if(!file) return;
  img.src=URL.createObjectURL(file); img.style.display='block';
  const fr=new FileReader(); fr.onload=(ev)=>img.setAttribute('data-base64', ev.target.result); fr.readAsDataURL(file);
}
function togglePhotos(id){
  const sel=$(id); const show = (sel.value==='unavailable');
  $(`${id}-photo`).style.display = show ? '' : 'none';
  if(!show){ $(`${id}-preview`).style.display='none'; $(`${id}-preview`).removeAttribute('data-base64'); }
}
function toggleVatCondition(which){
  const sel=$(which); const extra=$(`${which}-extra`);
  extra.style.display = (sel.value==='attention')? '' : 'none';
}
function toggleChillerCondition(){
  const sel=$('chiller-condition'); const extra=$('chiller-condition-extra');
  extra.style.display = (sel.value==='attention')? '' : 'none';
}
function toggleVatDoorSeal(){
  const sel=$('vat-door-seal'); const extra=$('vat-door-seal-extra');
  extra.style.display = (sel.value==='delivered')? '' : 'none';
}
function toggleRjtSeal(){
  const sel=$('rjt-seal'); const extra=$('rjt-seal-extra');
  extra.style.display = (sel.value==='delivered')? '' : 'none';
}
function showVat2Serial(){
  const has = ($('vat2-capacity').value||'').trim().length>0;
  $('vat2-serial-section').style.display = has ? '' : 'none';
}

/* ================= AI-ish NORMALIZER =================
   Converts free-text lingo into canonical tags for summary/cards.
   Extend/adjust regexes as needed. */
const AI_MAP = [
  { tag:'Needs PowerPoint',    rx:/\b(power\s*outlet|power\s*point|240v|socket|gpo|needs\s*power\s*point)\b/i, fields:['gateway-comments','telemetry-comments'] },
  { tag:'Reducing Cap',        rx:/\b(reducing\s*cap|reducer|reduction\s*cap|cap\s*reducer)\b/i, fields:['vat1-comments','vat2-comments'] },
  { tag:'Grey Cap',            rx:/\b(gr[ea]y\s*cap)\b/i, fields:['vat1-comments','vat2-comments'] },
  { tag:'Halo Sensor',         rx:/\b(halo)\b/i, fields:['current-telemetry','telemetry-comments'] },
  { tag:'DTS',                 rx:/\b(dts)\b/i, fields:['telemetry-comments','vat2-comments','vat1-comments','current-telemetry'] },
  { tag:'Sensor Present',      rx:/\b(sensor|probe)\b/i, fields:['agitator-comments','telemetry-comments'] },
  { tag:'Cable Needed',        rx:/\b(cable|wiring|loom)\b/i, fields:['agitator-comments','gateway-comments','telemetry-comments'] },
  { tag:'Ethernet',            rx:/\b(ethernet|lan|rj45)\b/i, fields:['gateway-comments','telemetry-comments'] },
  { tag:'Grey Halo',           rx:/\b(gr[ea]y\s*halo)\b/i, fields:['telemetry-comments'] },
  { tag:'Mounting Required',   rx:/\b(bracket|mount|mounting|fixing)\b/i, fields:['gateway-comments'] },
];

function normalizeTags(record){
  const pick = (k)=> (record[k]||'') + ' ';
  const found = new Set();
  for(const rule of AI_MAP){
    const hay = (rule.fields||[]).map(pick).join(' ');
    if(rule.rx.test(hay)) found.add(rule.tag);
  }
  // domain-aware extras: caps unavailable → “Cap Missing”
  if((record['vat1-cap']==='unavailable')||(record['vat2-cap']==='unavailable')) found.add('Cap Missing');
  // attention flags
  if(record['vat1-condition']==='attention'||record['vat2-condition']==='attention') found.add('Vat Attention');
  if(record['chiller-condition']==='attention') found.add('Chiller Attention');
  return [...found];
}

/* ================= STORAGE LOAD/SAVE ================= */
async function cloudListAll(){
  const out=[];
  try{
    const ref = storage.ref(STORAGE_FOLDER);
    const res = await ref.listAll();
    for(const it of res.items){
      if(!it.name.endsWith('.json')) continue;
      try{
        const url=await it.getDownloadURL();
        const data=await (await fetch(url)).json();
        out.push(data);
        if(data?.dairyNumber) await db.forms.put({dairyNumber:data.dairyNumber, ...data});
      }catch(e){ if(DEBUG) console.error('file read', it.fullPath, e); }
    }
  }catch(e){ if(DEBUG) console.error('listAll error', e); }
  if(!out.length){
    const cached = await db.forms.toArray();
    return cached;
  }
  return out;
}

async function cloudGet(dairy){
  try{
    const url = await storage.ref(`${STORAGE_FOLDER}/${dairy}.json`).getDownloadURL();
    const data = await (await fetch(url)).json();
    return data;
  }catch{ return null; }
}

async function cloudSave(rec){
  const blob = new Blob([JSON.stringify(rec)], {type:'application/json'});
  await storage.ref(`${STORAGE_FOLDER}/${rec.dairyNumber}.json`).put(blob);
}

/* ================= FORM LOAD/SAVE/PDF ================= */
async function loadIntoForm(dn){
  let rec = await db.forms.where('dairyNumber').equals(dn).first();
  if(!rec) rec = await cloudGet(dn);
  if(!rec) return false;
  // write into inputs that exist
  const keys = Object.keys(rec);
  keys.forEach(k=>{
    const el = document.querySelector(`[name="${k}"]`) || $(k);
    if(!el) return;
    if(el.tagName==='SELECT' || el.tagName==='INPUT') el.value = rec[k];
  });
  showVat2Serial();
  return true;
}

function collectForm(){
  const names = [
    'dairyNumber',
    'vat1-capacity','vat2-capacity',
    'vat1-cap','vat2-cap',
    'vat1-condition','vat2-condition',
    'vat1-condition-comments','vat2-condition-comments',
    'vat1-level','vat2-level',
    'vat1-serial','vat2-serial',
    'vat1-comments','vat2-comments',
    'agitator-location','agitator-comments',
    'gateway-location','gateway-comments',
    'current-telemetry','telemetry-comments',
    'vat-door-seal','vat1-door-seal-size','vat2-door-seal-size',
    'rjt-seal','rjt-seal-size',
    'chiller-condition','chiller-condition-comments'
  ];
  const rec = {};
  names.forEach(n=>{ const el=document.querySelector(`[name="${n}"]`)||$(n); if(el) rec[n]=el.value||''; });
  // capture photos (base64 stored on <img data-base64>)
  [
    'vat1-cap','vat2-cap','vat1-condition','vat2-condition',
    'agitator','gateway','vat-door-seal','rjt-seal','chiller-condition'
  ].forEach(p=>{
    const img = $(`${p}-preview`);
    if(img?.getAttribute('data-base64')) rec[`${p}-photo-base64`]=img.getAttribute('data-base64');
  });
  rec.timestamp = Date.now();
  return rec;
}

async function doSave(){
  const rec = collectForm();
  if(!rec.dairyNumber){ $('save-msg').textContent='Enter a dairy number.'; return; }
  await db.forms.put({dairyNumber:rec.dairyNumber, ...rec});
  try{ await cloudSave(rec); $('save-msg').textContent='Saved to cloud ✅'; }
  catch(e){ $('save-msg').textContent='Saved locally; cloud failed.'; if(DEBUG) console.error(e); }
  setTimeout(()=>$('save-msg').textContent='', 3000);
}

async function doPDF(){
  await doSave();
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l', 'pt', 'a4');
  let y = 40;
  if(logoBase64){
    const W = pdf.internal.pageSize.getWidth();
    const h = 70, w = h*logoAspect;
    pdf.addImage(logoBase64, 'JPEG', (W-w)/2, 24, w, h);
    y = 110;
  }
  const rec = collectForm();
  pdf.setFontSize(16); pdf.text('Agora Vat Pre-Check', 36, y);
  y+=16;
  const table = Object.entries(rec)
    .filter(([k])=>!k.endsWith('base64') && k!=='timestamp')
    .map(([k,v])=>[k, String(v||'')]);
  pdf.autoTable({startY:y+10, head:[['Field','Value']], body:table, styles:{fontSize:9}, headStyles:{fillColor:[0,43,92],textColor:255}});
  let iy = pdf.lastAutoTable.finalY + 10;
  const PHOTOS = ['vat1-cap','vat2-cap','gateway','agitator','vat1-condition','vat2-condition','vat-door-seal','rjt-seal','chiller-condition'];
  for(const key of PHOTOS){
    const b64 = rec[`${key}-photo-base64`];
    if(!b64) continue;
    if(iy+170>560){ pdf.addPage(); iy=60; }
    pdf.setFontSize(12); pdf.text(key.replace(/-/g,' ').toUpperCase(), 36, iy+18);
    pdf.addImage(b64,'JPEG',36,iy+24,420,140);
    iy+=170;
  }
  pdf.save(`VatPreCheck_${rec.dairyNumber}.pdf`);
}

/* ================= FLASH SUMMARY (CARDS) ================= */
function firstPhotos(rec, max=3){
  const keys = ['vat1-cap','vat2-cap','gateway','agitator','vat1-condition','vat2-condition','vat-door-seal','rjt-seal','chiller-condition'];
  const arr=[];
  keys.forEach(k=>{ const b64=rec[`${k}-photo-base64`]; if(b64) arr.push(b64); });
  return arr.slice(0,max);
}

function cardHTML(rec){
  const tags = normalizeTags(rec);
  const v1 = (rec['vat1-capacity']||'').trim();
  const v2 = (rec['vat2-capacity']||'').trim();
  const c1 = rec['vat1-condition']||'';
  const c2 = rec['vat2-condition']||'';
  const capIssue = (rec['vat1-cap']==='unavailable'||rec['vat2-cap']==='unavailable');
  const attn = (c1==='attention'||c2==='attention'||(rec['chiller-condition']==='attention'));

  const photos = firstPhotos(rec).map(src=>`<img src="${src}"/>`).join('');

  // door seal delivered quantity logic
  let doorQty = 0;
  if(rec['vat-door-seal']==='delivered'){
    const vats = [v1?1:0, v2?1:0].reduce((a,b)=>a+b,0);
    doorQty = vats>1 ? 2 : 1;
  }

  return `
    <div class="kcard">
      <div class="khead">
        <div class="knum">Dairy #${rec.dairyNumber||'-'}</div>
        <div class="kbadges">
          ${attn?'<span class="tag attn">Attention</span>':'<span class="tag good">OK</span>'}
          ${capIssue?'<span class="tag attn">Cap Missing</span>':''}
          ${doorQty?`<span class="tag">Door Seals: ${doorQty}</span>`:''}
        </div>
      </div>
      <div class="kbody">
        <div><b>Vat 1:</b> ${v1||'-'} L • ${rec['vat1-cap']||'-'} • ${c1||'-'}</div>
        <div><b>Vat 2:</b> ${v2||'-'} L • ${rec['vat2-cap']||'-'} • ${rec['vat2-condition']||'-'}</div>
        <div><b>Gateway:</b> ${rec['gateway-location']||'-'} ${rec['gateway-comments']?('• '+rec['gateway-comments']):''}</div>
        <div class="mt-1">
          ${tags.map(t=>`<span class="tag">${t}</span>`).join(' ')}
          <span class="tag"><span class="link" onclick="viewRecord('${rec.dairyNumber}')">view</span></span>
        </div>
        ${photos?`<div class="thumbs">${photos}</div>`:''}
      </div>
    </div>
  `;
}

function kpiTiles(records){
  // sizes count
  const sizes={};
  let attn=0, chiller=0, rjtDelivered=0, doorDeliveredQty=0;
  records.forEach(r=>{
    const v1=(r['vat1-capacity']||'').trim(); if(v1) sizes[v1]=(sizes[v1]||0)+1;
    const v2=(r['vat2-capacity']||'').trim(); if(v2) sizes[v2]=(sizes[v2]||0)+1;
    if(r['vat1-condition']==='attention'||r['vat2-condition']==='attention') attn++;
    if(r['chiller-condition']==='attention') chiller++;
    if(r['rjt-seal']==='delivered') rjtDelivered++;
    if(r['vat-door-seal']==='delivered'){
      const vats = (v1?1:0) + (v2?1:0);
      doorDeliveredQty += vats>1 ? 2 : 1;
    }
  });
  const sizeLines = Object.keys(sizes).sort((a,b)=>(+a||0)-(+b||0))
    .slice(0,4).map(k=>`${k}L: ${sizes[k]}`).join(' • ');
  return [
    {label:'Farms', val: records.length},
    {label:'Vat Attention', val: attn},
    {label:'Chiller Attention', val: chiller},
    {label:'RJTs Delivered', val: rjtDelivered},
    {label:'Door Seals Delivered (qty)', val: doorDeliveredQty},
    {label:'Top Sizes', val: sizeLines || '—'}
  ];
}

async function refreshFlash(){
  let records = await cloudListAll();
  const q = ($('q').value||'').toLowerCase().trim();
  const mode = $('filter-mode').value;

  if(q){
    records = records.filter(r => JSON.stringify(r).toLowerCase().includes(q));
  }
  if(mode==='attention'){
    records = records.filter(r => r['vat1-condition']==='attention' || r['vat2-condition']==='attention' || r['chiller-condition']==='attention');
  }
  if(mode==='no-cap'){
    records = records.filter(r => (r['vat1-cap'] && r['vat1-cap']!=='available') || (r['vat2-cap'] && r['vat2-cap']!=='available'));
  }

  if(!records.length){
    $('kpi-box').innerHTML='';
    $('cards').innerHTML = `<div class="kcard"><div class="kbody">No records found for your filters.</div></div>`;
    $('flash-summary').innerHTML='';
    return;
  }

  // KPIs
  const kpis = kpiTiles(records);
  $('kpi-box').innerHTML = kpis.map(k=>`<div class="kpi"><div class="n">${k.val}</div><div class="l">${k.label}</div></div>`).join('');

  // Cards
  $('cards').innerHTML = records.map(cardHTML).join('');

  // Detailed summary
  const sizeCount={}; let farmsAttention=[];
  records.forEach(r=>{
    const v1=(r['vat1-capacity']||'').trim(); if(v1) sizeCount[v1]=(sizeCount[v1]||0)+1;
    const v2=(r['vat2-capacity']||'').trim(); if(v2) sizeCount[v2]=(sizeCount[v2]||0)+1;
    if(r['vat1-condition']==='attention'||r['vat2-condition']==='attention'||r['chiller-condition']==='attention'){
      farmsAttention.push(r.dairyNumber);
    }
  });
  const sizes = Object.keys(sizeCount).sort((a,b)=>(+a||0)-(+b||0)).map(k=>`<li>${k}L : ${sizeCount[k]} vats</li>`).join('');
  $('flash-summary').innerHTML = `
    <h4 class="mt-2">Summary</h4>
    <ul>${sizes || '<li>No size data</li>'}</ul>
    ${farmsAttention.length? `<div class="mt-1">Farms needing attention: ${farmsAttention.map(n=>`<span class="tag">${n}</span>`).join(' ')}</div>`:''}
  `;
}

async function viewRecord(dairy){
  // reuse the old detailed form rendering pattern in a new window-like alert
  const rec = await cloudGet(dairy) || await db.forms.where('dairyNumber').equals(dairy).first();
  if(!rec){ alert(`No form found for #${dairy}`); return; }
  const photos = ['vat1-cap','vat2-cap','gateway','agitator','vat1-condition','vat2-condition','vat-door-seal','rjt-seal','chiller-condition']
    .map(k=>rec[`${k}-photo-base64`]?`<div class="mt-2"><b>${k.replace(/-/g,' ').toUpperCase()}:</b><br><img src="${rec[`${k}-photo-base64`]}" style="max-width:720px;border:1px solid #ddd;border-radius:10px"/></div>`:'')
    .join('');
  const html = `
    <div style="max-height:70vh;overflow:auto">
      <h4>Vat Pre-Check for #${dairy}</h4>
      <table class="table table-sm table-bordered">
        ${Object.entries(rec).filter(([k])=>!k.endsWith('base64')&&k!=='timestamp').map(([k,v])=>`<tr><th>${k}</th><td>${String(v||'')}</td></tr>`).join('')}
      </table>
      ${photos}
    </div>`;
  const w = window.open("", "_blank", "width=800,height=700");
  w.document.write(`<html><head><title>${dairy}</title></head><body>${html}</body></html>`);
  w.document.close();
}

/* ================= ADMIN DOWNLOADS ================= */
function recordsToFlat(rec){
  // flatten + normalized tags to columns
  const tags = normalizeTags(rec).join(' | ');
  // door seal qty again
  const v1=(rec['vat1-capacity']||'').trim(); const v2=(rec['vat2-capacity']||'').trim();
  let doorQty=0; if(rec['vat-door-seal']==='delivered') doorQty = ((v1?1:0)+(v2?1:0))>1 ? 2 : 1;

  return {
    DairyNumber: rec.dairyNumber || "",
    Vat1Capacity: rec['vat1-capacity']||"",
    Vat1Cap: rec['vat1-cap']||"",
    Vat1Condition: rec['vat1-condition']||"",
    Vat1Level: rec['vat1-level']||"",
    Vat1Serial: rec['vat1-serial']||"",
    Vat1DoorSealSize: rec['vat1-door-seal-size']||"",
    Vat2Capacity: rec['vat2-capacity']||"",
    Vat2Cap: rec['vat2-cap']||"",
    Vat2Condition: rec['vat2-condition']||"",
    Vat2Level: rec['vat2-level']||"",
    Vat2Serial: rec['vat2-serial']||"",
    Vat2DoorSealSize: rec['vat2-door-seal-size']||"",
    AgitatorLocation: rec['agitator-location']||"",
    AgitatorComments: rec['agitator-comments']||"",
    GatewayLocation: rec['gateway-location']||"",
    GatewayComments: rec['gateway-comments']||"",
    CurrentTelemetry: rec['current-telemetry']||"",
    TelemetryComments: rec['telemetry-comments']||"",
    VatDoorSeal: rec['vat-door-seal']||"",
    RJTSeal: rec['rjt-seal']||"",
    RJTSealSize: rec['rjt-seal-size']||"",
    ChillerCondition: rec['chiller-condition']||"",
    DoorSealDeliveredQty: doorQty,
    NormalizedTags: tags,
    TimestampISO: rec.timestamp ? new Date(rec.timestamp).toISOString() : ""
  };
}
async function allRecords(){
  const list = await cloudListAll();
  // uniq by dairy (prefer latest timestamp)
  const map = {};
  list.forEach(r=>{
    const k=r.dairyNumber||'';
    if(!k) return;
    if(!map[k] || (r.timestamp||0)>(map[k].timestamp||0)) map[k]=r;
  });
  return Object.values(map);
}
function toCSV(rows){
  if(!rows.length) return '';
  const keys = Object.keys(rows[0]);
  const escape=(v)=>('"'+String(v??'').replace(/"/g,'""')+'"');
  const head = keys.join(',');
  const body = rows.map(r=>keys.map(k=>escape(r[k])).join(',')).join('\r\n');
  return '\uFEFF'+head+'\r\n'+body;
}
async function download(type){
  const recs = (await allRecords()).map(recordsToFlat);
  if(type==='json'){
    const blob = new Blob([JSON.stringify(recs,null,2)],{type:'application/json'});
    const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'vat_precheck.json'});
    document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},300);
    return;
  }
  if(type==='csv'){
    const csv = toCSV(recs);
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
    const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'vat_precheck.csv'});
    document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},300);
    return;
  }
  if(type==='xlsx'){
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(recs), "VatPreCheck");
    XLSX.writeFile(wb, "vat_precheck.xlsx");
  }
}

/* ================= NAV ================= */
function showTab(which){
  $('pane-form').classList.add('hidden');
  $('pane-flash').classList.add('hidden');
  $('pane-admin').classList.add('hidden');
  $('btn-form').classList.remove('btn-brand'); $('btn-form').classList.add('btn-plain');
  $('btn-flash').classList.remove('btn-brand'); $('btn-flash').classList.add('btn-plain');
  $('btn-admin').classList.remove('btn-brand'); $('btn-admin').classList.add('btn-plain');

  if(which==='form'){ $('pane-form').classList.remove('hidden'); $('btn-form').classList.add('btn-brand'); $('btn-form').classList.remove('btn-plain'); }
  if(which==='flash'){ $('pane-flash').classList.remove('hidden'); $('btn-flash').classList.add('btn-brand'); $('btn-flash').classList.remove('btn-plain'); refreshFlash(); }
  if(which==='admin'){ $('pane-admin').classList.remove('hidden'); $('btn-admin').classList.add('btn-brand'); $('btn-admin').classList.remove('btn-plain'); }
}

function setAdminVisibility(){
  const isAdmin = new URLSearchParams(location.search).get('admin')==='1';
  if(isAdmin) $('btn-admin').classList.remove('hidden');
  else $('btn-admin').classList.add('hidden');
}

/* ================= EVENTS ================= */
$('btn-form').onclick=()=>showTab('form');
$('btn-flash').onclick=()=>showTab('flash');
$('btn-admin').onclick=()=>showTab('admin');
$('btn-save').onclick=doSave;
$('btn-pdf').onclick=doPDF;
$('btn-refresh').onclick=refreshFlash;
$('dairyNumber').addEventListener('blur', async function(){
  const dn=(this.value||'').trim(); if(!dn) return;
  const ok = await loadIntoForm(dn);
  if(!ok && DEBUG) console.warn('No existing record for', dn);
});
$('dl-csv').onclick=()=>download('csv');
$('dl-xlsx').onclick=()=>download('xlsx');
$('dl-json').onclick=()=>download('json');

document.addEventListener('DOMContentLoaded', ()=>{
  setAdminVisibility();
  showTab('form');
});
</script>
</body>
</html>