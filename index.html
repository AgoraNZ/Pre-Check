<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agora Vat Pre-Check</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">

<style>
:root{
  --brand:#001F3F; --accent:#FF851B; --muted:#6b7280; --bg:#f7f8fb;
}
html,body{background:var(--bg);color:#0f172a;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
.app{max-width:1100px;margin:28px auto;padding:0 16px}
.brand-header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
.brand-logo{width:160px;height:auto;display:none}
.brand-title{flex:1}
.brand-title h1{margin:0;font-weight:800;color:var(--brand);letter-spacing:.2px}
.brand-sub{color:var(--muted);font-size:.95rem;margin-top:2px}
.top-tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 18px}
.tab-btn{border:1px solid #e5e7eb;background:#fff;color:#111827;border-radius:10px;padding:10px 14px;font-weight:600}
.tab-btn.active{border-color:var(--accent);box-shadow:0 0 0 3px #ff851b2b}
.bar{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin:10px 0}
.section-title{font-size:1.05rem;font-weight:800;color:#111827;margin:6px 0 10px}
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px;cursor:pointer}
.kpi .num{font-size:1.4rem;font-weight:800}
.kpi .label{color:#6b7280;font-size:.9rem}
.card-list{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media (max-width:900px){.card-list{grid-template-columns:1fr}}
.farm-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px}
.farm-card:hover{box-shadow:0 4px 18px rgba(0,0,0,.06)}
.farm-card .head{display:flex;justify-content:space-between;gap:8px;align-items:center}
.badge-soft{border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:.8rem}
.progress-wrap{display:flex;align-items:center;gap:12px}
.progress{height:10px}
.hidden{display:none!important}
.btn-brand{background:var(--accent);border:none;color:#fff;font-weight:700}
.btn-brand:hover{background:#ff6d00}
.btn-outline-brand{border:1px solid var(--accent);color:var(--accent);background:#fff}
.btn-outline-brand:hover{background:var(--accent);color:#fff}
.footer{color:#6b7280;text-align:center;margin:22px 0 10px}

/* Print/Details brochure (kept exactly like the clean layout) */
.print-sheet{max-width:900px;margin:0 auto;color:#0f172a}
.print-head{display:flex;align-items:center;gap:16px;border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:10px}
.print-head img{height:44px}
.print-title{font-weight:800;font-size:1.2rem}
.print-sub{color:#6b7280}
.print-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.print-card{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.print-label{font-weight:700;margin-bottom:6px}
.print-photos{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.print-photos img{width:100%;max-height:180px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="brand-header">
    <img id="logo" class="brand-logo" alt="Agora Logo">
    <div class="brand-title">
      <h1>Agora Vat Pre-Check</h1>
      <div class="brand-sub">Fast field capture • Smart summary • Customer-ready output</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="top-tabs">
    <button id="tab-summary" class="tab-btn active">Summary</button>
    <button id="tab-form" class="tab-btn">Form</button>
    <button id="tab-admin" class="tab-btn">Admin</button>
    <div class="ms-auto progress-wrap">
      <span class="small text-muted">Cloud:</span> <span id="cloud-count">–</span>
      <span class="small text-muted">Loaded:</span> <span id="loaded-count">0</span>
      <div class="progress" style="width:160px"><div id="sync-bar" class="progress-bar" role="progressbar" style="width:0%"></div></div>
      <span id="sync-pct" class="small text-muted">0%</span>
    </div>
  </div>

  <!-- SUMMARY -->
  <div id="view-summary">
    <div class="bar">
      <div class="section-title">Overview</div>
      <div class="kpi-grid">
        <div class="kpi" data-kpi="dts"><div id="kpi-dts" class="num">0</div><div class="label">DTS Vent Caps</div></div>
        <div class="kpi" data-kpi="power"><div id="kpi-power" class="num">0</div><div class="label">Farms needing power point</div></div>
        <div class="kpi" data-kpi="rubber"><div id="kpi-rubber" class="num">0</div><div class="label">Rubberware deliveries</div></div>
      </div>
    </div>

    <div class="bar">
      <div class="section-title">Vat Size Breakdown</div>
      <div id="size-table" class="table-responsive"></div>
    </div>

    <div class="bar">
      <div class="section-title d-flex align-items-center justify-content-between">
        <span>Farms</span>
        <input id="search" class="form-control" style="max-width:220px" placeholder="Search dairy #">
      </div>
      <div id="result-cards" class="card-list"></div>
    </div>
  </div>

  <!-- FORM (kept minimal; auto-fill on dairy number) -->
  <div id="view-form" class="hidden">
    <div class="bar">
      <div class="section-title">Auto-fill by Dairy #</div>
      <input id="form-dairy" class="form-control" placeholder="Enter dairy # and blur to auto-fill">
    </div>
    <div id="form-fields" class="bar">
      <!-- Simple mapped fields to confirm auto-fill -->
      <div id="form-info" class="small text-muted">Enter a dairy number to load data here, including photos if present.</div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="view-admin" class="hidden">
    <div class="bar">
      <div class="section-title">Data Tools</div>
      <div class="d-flex flex-wrap gap-2">
        <button id="btn-sync" class="btn btn-brand">Force Full Sync</button>
        <button id="btn-print-all" class="btn btn-outline-brand">Print All Brochures</button>
        <button id="btn-download-all" class="btn btn-outline-brand">Download All Brochures (ZIP)</button>
        <button id="btn-owner-report" class="btn btn-outline-brand">Owner Report (PDF)</button>
      </div>
      <div class="small text-muted mt-2">Summary lists dairy numbers instantly (no heavy loads). Details/Print fetch a farm on demand. Synced items are stored for offline via Service Worker + IndexedDB.</div>
    </div>
  </div>

  <div class="footer">Agora • Vat Pre-Check • v3.1</div>
</div>

<!-- Print Sheet Host (reused for Details & Print) -->
<div id="print-host" class="d-none"></div>

<!-- Libs -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.3/dexie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
/* ========= Firebase ========= */
const firebaseConfig = {
  apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain:"dairy-farm-record-system.firebaseapp.com",
  projectId:"dairy-farm-record-system",
  storageBucket:"dairy-farm-record-system.appspot.com",
  messagingSenderId:"422124188212",
  appId:"1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();
const FOLDER = 'Pre Check';

/* ========= Dexie (lightweight) ========= */
const db = new Dexie('VatPreCheckLite');
db.version(1).stores({ farms: 'dairyNumber, ts' });

/* ========= DOM helpers ========= */
const $ = id => document.getElementById(id);
function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function setProgress(done,total){
  const pct = total ? Math.round((done/total)*100) : 0;
  $('sync-bar').style.width = clamp(pct,0,100)+'%';
  $('sync-pct').textContent = clamp(pct,0,100)+'%';
}

/* ========= Brand Logo ========= */
(async()=>{ try{ const url=await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL(); $('logo').src=url; $('logo').style.display='block'; }catch(e){} })();

/* ========= Tabs ========= */
const views = { 'tab-summary':'view-summary', 'tab-form':'view-form', 'tab-admin':'view-admin' };
Object.keys(views).forEach(t=>{
  $(t).onclick=()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    $(t).classList.add('active');
    Object.values(views).forEach(v=>hide($(v)));
    show($(views[t]));
    if(views[t]==='view-summary'){ renderSummaryInstant(); }
  }
});

/* ========= Strict DTS detectors (ONLY these phrases) ========= */
const dtsStrictMatchers = [
  /halo\s+grey\s+cap/i,
  /halo\s+gray\s+cap/i,
  /\bgr[ea]y\s+sensor\b/i,            // grey sensor / gray sensor
  /\bdts\s+reducer\b/i,               // dts reducer
  /\bdts\s+reducing\s+cap\b/i,        // dts reducing cap
  /gr[ea]y\s+sensor.*dts\s+reducer/i, // grey sensor in dts reducer
  /dts\s+reducer.*gr[ea]y\s+sensor/i
];
function hasStrictDTS(rec){
  // look ONLY in CapComments (vat-level) and vat comments where installers write those exact phrases
  const pool = [
    ...(rec.vats||[]).map(v => v.CapComments || ''),
    ...(rec.vats||[]).map(v => v.Notes || '')
  ].join(' | ');
  if(!pool) return false;
  return dtsStrictMatchers.some(rx => rx.test(pool));
}

/* ========= Power-point detector (from Gateway/Notes text) ========= */
const powerMatchers = [
  /new\s*power\s*point\s*recommended/i,
  /\bpower\s*point\b.*(need|required|recommend)/i,
  /needs?\s*(a\s*)?(new\s*)?plug/i,
  /no\s*plugs?\s*available/i,
  /use.*(double|splitter)\s*plug/i
];
function needsPower(rec){
  const text = [
    rec.GatewayLocation || '',
    ...(rec.vats||[]).map(v=>v.Notes||'')
  ].join(' | ');
  return powerMatchers.some(rx=>rx.test(text));
}

/* ========= Rubberware delivered count ========= */
function rubberDelivered(rec){
  const door = (rec.DoorDelivered||'').toLowerCase()==='yes';
  const rjt  = (rec.RJTDelivered||'').toLowerCase()==='yes';
  return door || rjt;
}

/* ========= Manufacturer + size table helpers ========= */
function buildSizeTable(all){
  // sizes per vat across all dairies
  const sizes = {};
  all.forEach(r=>{
    (r.vats||[]).forEach(v=>{
      const sz = (v.Size||'').toString().trim();
      if(sz && sz.toLowerCase()!=='na') sizes[sz]=(sizes[sz]||0)+1;
    });
  });
  let html = '<table class="table table-sm table-bordered mb-0"><thead><tr><th>Vat Size (L)</th><th>Count</th></tr></thead><tbody>';
  Object.entries(sizes).sort((a,b)=> (parseInt(a[0])||0) - (parseInt(b[0])||0)).forEach(([sz,c])=>{
    html += `<tr><td>${sz}</td><td>${c}</td></tr>`;
  });
  html += '</tbody></table>';
  $('size-table').innerHTML = html;
}

/* ========= Cloud listing & light indexing ========= */
async function listCloudKeys(){
  const folder = storage.ref(FOLDER);
  const res = await folder.listAll();
  // filter to .json only (skip _manifest, folders)
  return res.items.filter(it=>/\.json$/i.test(it.name));
}
async function fetchFarmJsonByRef(ref){
  const url = await ref.getDownloadURL();
  const data = await fetch(url).then(r=>r.json());
  // normalize into our internal shape:
  // Accept both your CSV-like schema (rows per vat) and the existing JSON structure.
  // We derive: { dairyNumber, GatewayLocation, DoorDelivered, DoorSize, RJTDelivered, RJTSize, OtherBrand, OtherType, OtherNotes, vats:[{Vat, Size, Serial, Cap, Condition, Notes, CapComments, Manufacturer}] }
  const dairyNumber = data.dairyNumber || data.Dairy || data.dairy || ref.name.replace('.json','');

  // If it already has expected fields, pass through; else try to map from flat keys.
  let out = { dairyNumber, ts: data.timestamp || Date.now() };

  // Try gateway + other telemetry at top level
  out.GatewayLocation = data['gateway-location'] || data.GatewayLocation || '';
  out.OtherBrand = data['other-brand'] || data.OtherBrand || data.Manufacturer || '';
  out.OtherType  = data['other-type']  || data.OtherType  || '';
  out.OtherNotes = data['other-notes'] || data.OtherNotes || '';
  out.DoorDelivered = (data['door-delivered'] || data.DoorDelivered || '').toString();
  out.DoorSize      = data['door-size']      || data.DoorSize || '';
  out.RJTDelivered  = (data['rjt-delivered'] || data.RJTDelivered || '').toString();
  out.RJTSize       = data['rjt-size']       || data.RJTSize || '';

  // Build vats[] from possible v1/v2 style:
  const vats = [];
  const v1 = {
    Vat: 1,
    Size: data['vat1-capacity'] || data.Size1 || data['Size'] || '',
    Serial: data['vat1-serial'] || data.Serial1 || '',
    Cap: (data['vat1-cap']||'').toUpperCase() || '',
    Condition: data['vat1-condition'] || '',
    Notes: data['vat1-comments'] || '',
    CapComments: data['vat1-cap-comments'] || data.CapComments1 || '',
    Manufacturer: data['telemetry-brand'] || data.Manufacturer1 || data.Manufacturer || ''
  };
  const v2 = {
    Vat: 2,
    Size: data['vat2-capacity'] || data.Size2 || '',
    Serial: data['vat2-serial'] || data.Serial2 || '',
    Cap: (data['vat2-cap']||'').toUpperCase() || (v1.Size ? 'NA' : ''), // default NA when present without explicit
    Condition: data['vat2-condition'] || '',
    Notes: data['vat2-comments'] || '',
    CapComments: data['vat2-cap-comments'] || data.CapComments2 || '',
    Manufacturer: data['telemetry-brand'] || data.Manufacturer2 || data.Manufacturer || ''
  };
  if(v1.Size || v1.Serial || v1.Cap || v1.Condition || v1.Notes || v1.CapComments) vats.push(v1);
  if(v2.Size || v2.Serial || v2.Cap || v2.Condition || v2.Notes || v2.CapComments) vats.push(v2);

  // If the JSON is already in “rows” shape (like the CSV exported rows grouped), detect and map
  if(Array.isArray(data.rows)){
    const g = { dairyNumber, ts: out.ts, GatewayLocation:'', OtherBrand:'', OtherType:'', OtherNotes:'', DoorDelivered:'No', DoorSize:'', RJTDelivered:'No', RJTSize:'', vats:[] };
    data.rows.forEach(r=>{
      g.GatewayLocation = r.GatewayLocation || g.GatewayLocation;
      g.OtherBrand = r.OtherBrand || g.OtherBrand;
      g.OtherType = r.OtherType || g.OtherType;
      g.OtherNotes = r.OtherNotes || g.OtherNotes;
      g.DoorDelivered = r.DoorDelivered || g.DoorDelivered;
      g.DoorSize = r.DoorSize || g.DoorSize;
      g.RJTDelivered = r.RJTDelivered || g.RJTDelivered;
      g.RJTSize = r.RJTSize || g.RJTSize;
      g.vats.push({
        Vat: r.Vat, Size: r.Size, Serial: r.Serial, Cap:(r.Cap||'').toUpperCase(), Condition:r.Condition, Notes:r.Notes, CapComments:r.CapComments, Manufacturer:r.Manufacturer
      });
    });
    return g;
  }

  out.vats = vats;
  return out;
}

/* ========= Global in-memory index (fast summary) ========= */
let ALL_KEYS = [];     // firebase refs (StorageReference[])
let ALL_DAIRIES = [];  // just numbers (strings)
let ALL_META = [];     // lightweight records for summary counts only

/* ========= Summary immediate render (list only) ========= */
async function renderSummaryInstant(){
  // If already loaded, just redraw list with filter
  if(ALL_DAIRIES.length){
    drawFarmList(ALL_DAIRIES);
    return;
  }
  // 1) list keys
  const refs = await listCloudKeys();
  $('cloud-count').textContent = refs.length;
  ALL_KEYS = refs;
  // 2) build just dairy number list immediately
  ALL_DAIRIES = refs.map(r => r.name.replace('.json','')).sort((a,b)=>String(a).localeCompare(String(b)));
  $('loaded-count').textContent = 0;
  setProgress(0, ALL_DAIRIES.length);
  // show list instantly
  drawFarmList(ALL_DAIRIES);

  // 3) start lightweight background pass to compute KPIs + size table
  let done = 0;
  const meta = [];
  for(const ref of refs){
    try{
      const rec = await fetchFarmJsonByRef(ref);
      // keep tiny meta only
      meta.push({
        dairyNumber: rec.dairyNumber,
        vats: rec.vats || [],
        GatewayLocation: rec.GatewayLocation || '',
        DoorDelivered: rec.DoorDelivered || '',
        RJTDelivered: rec.RJTDelivered || '',
        DoorSize: rec.DoorSize || '',
        RJTSize: rec.RJTSize || ''
      });
      // cache for offline viewing later (on-demand browsing/printing)
      await db.farms.put(rec);
    }catch(e){/*ignore*/}
    done++;
    $('loaded-count').textContent = done;
    setProgress(done, refs.length);
  }
  ALL_META = meta;
  buildKpisAndSizes();
}

/* ========= Draw list (dairy numbers only, fast) ========= */
function drawFarmList(dairies){
  const q = ($('search').value||'').trim().toLowerCase();
  const filtered = q ? dairies.filter(d=>String(d).toLowerCase().includes(q)) : dairies;
  $('result-cards').innerHTML = filtered.map(dn => `
    <div class="farm-card">
      <div class="head">
        <div><strong>#${dn}</strong></div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-brand" onclick="openDetails('${dn}')">Details</button>
          <button class="btn btn-sm btn-brand" onclick="openPrint('${dn}')">Print</button>
        </div>
      </div>
    </div>
  `).join('');
}
$('search').addEventListener('input', ()=>drawFarmList(ALL_DAIRIES));

/* ========= KPIs + sizes from ALL_META ========= */
function buildKpisAndSizes(){
  if(!ALL_META.length){ $('kpi-dts').textContent='0'; $('kpi-power').textContent='0'; $('kpi-rubber').textContent='0'; $('size-table').innerHTML=''; return; }

  // merge to minimal rec shape for detectors
  const recs = ALL_META.map(m=>({
    GatewayLocation: m.GatewayLocation,
    DoorDelivered: m.DoorDelivered,
    RJTDelivered: m.RJTDelivered,
    vats: m.vats
  }));

  const dtsCount = recs.filter(hasStrictDTS).length;
  const powerCount = recs.filter(needsPower).length;
  const rubberCount = recs.filter(rubberDelivered).length;

  $('kpi-dts').textContent = dtsCount;
  $('kpi-power').textContent = powerCount;
  $('kpi-rubber').textContent = rubberCount;

  buildSizeTable(recs);

  // KPI clicks → just show dairy list that match
  document.querySelectorAll('.kpi').forEach(el=>{
    el.onclick = ()=>{
      const t = el.getAttribute('data-kpi');
      let subset = ALL_META;
      if(t==='dts') subset = ALL_META.filter(m=> hasStrictDTS({vats:m.vats}));
      if(t==='power') subset = ALL_META.filter(m=> needsPower({GatewayLocation:m.GatewayLocation, vats:m.vats}));
      if(t==='rubber') subset = ALL_META.filter(m=> rubberDelivered({DoorDelivered:m.DoorDelivered,RJTDelivered:m.RJTDelivered}));
      drawFarmList(subset.map(s=>s.dairyNumber).sort((a,b)=>String(a).localeCompare(String(b))));
    };
  });
}

/* ========= Fetch full record by dairy (cache-first) ========= */
async function getFullRecord(dn){
  let rec = await db.farms.get(dn);
  if(rec) return rec;
  // fetch from cloud
  try{
    const url = await storage.ref(`${FOLDER}/${dn}.json`).getDownloadURL();
    rec = await fetch(url).then(r=>r.json());
    // Normalize into vats shape if needed
    rec = await fetchFarmJsonByRef({ getDownloadURL: async()=>url, name:`${dn}.json` });
    await db.farms.put(rec);
    return rec;
  }catch(e){ return null; }
}

/* ========= DETAILS (uses brochure sheet inline) ========= */
window.openDetails = async (dn)=>{
  const rec = await getFullRecord(dn); if(!rec) return alert('Record not found');
  showBrochure(rec, false);
  $('tab-summary').click(); // stay on summary but bring the farm to view by printing inline
  window.scrollTo({top:0,behavior:'smooth'});
};

/* ========= PRINT single ========= */
window.openPrint = async (dn)=>{
  const rec = await getFullRecord(dn); if(!rec) return alert('Record not found');
  showBrochure(rec, true);
};

/* ========= Brochure builder (kept to your liked design, 4 photos max) ========= */
function brochureHTML(rec, logoUrl){
  const manu = rec.OtherBrand || ((rec.vats||[])[0]?.Manufacturer||'') || '-';
  // Extract up to 4 photos if present in record (support both new keys or legacy)
  const photos = [];
  ['gateway-photo-base64','vat1-cap-photo-base64','agitator1-photo-base64','vat2-cap-photo-base64','agitator2-photo-base64','door-photo-base64','rjt-photo-base64'].forEach(k=>{
    const v = rec[k]; if(v) photos.push(v);
  });
  const p4 = photos.slice(0,4);

  const v1 = (rec.vats||[]).find(v=>String(v.Vat)==='1') || {};
  const v2 = (rec.vats||[]).find(v=>String(v.Vat)==='2') || {};

  const doorYes = (rec.DoorDelivered||'').toLowerCase()==='yes';
  const rjtYes  = (rec.RJTDelivered||'').toLowerCase()==='yes';

  return `
    <div class="print-sheet">
      <div class="print-head">
        <img src="${logoUrl||''}" alt="">
        <div>
          <div class="print-title">Vat Pre-Check – #${rec.dairyNumber}</div>
          <div class="print-sub">Brand: ${manu} • Gateway: ${rec.GatewayLocation||'-'}</div>
        </div>
      </div>

      <div class="print-grid">
        <div class="print-card">
          <div class="print-label">Vat 1</div>
          <div>Capacity: <b>${v1.Size||'-'}</b></div>
          <div>Cap: <b>${(v1.Cap||'-')}</b></div>
          <div>Serial: <b>${v1.Serial||'-'}</b></div>
          <div>Condition: <b>${v1.Condition||'-'}</b></div>
          <div>Notes: ${v1.Notes||'-'}</div>
          <div>Cap Comments: ${v1.CapComments||'-'}</div>
        </div>
        <div class="print-card">
          <div class="print-label">Vat 2</div>
          <div>Capacity: <b>${v2.Size||'-'}</b></div>
          <div>Cap: <b>${(v2.Cap||'-')}</b></div>
          <div>Serial: <b>${v2.Serial||'-'}</b></div>
          <div>Condition: <b>${v2.Condition||'-'}</b></div>
          <div>Notes: ${v2.Notes||'-'}</div>
          <div>Cap Comments: ${v2.CapComments||'-'}</div>
        </div>

        <div class="print-card">
          <div class="print-label">Mobile Signal & Telemetry</div>
          <div>Signal (from Gateway/Notes): <b>${extractSignal(rec)}</b></div>
          <div>Other Telemetry: <b>${rec.OtherBrand||'-'}</b> • ${rec.OtherType||'-'}</div>
          <div>Notes: ${rec.OtherNotes||'-'}</div>
        </div>
        <div class="print-card">
          <div class="print-label">Rubberware</div>
          <div>Door Seal: <b>${doorYes?'Delivered':'No'}</b> ${rec.DoorSize? '• '+rec.DoorSize:''}</div>
          <div>RJT: <b>${rjtYes?'Delivered':'No'}</b> ${rec.RJTSize? '• '+rec.RJTSize:''}</div>
        </div>
      </div>

      ${p4.length ? `
      <div class="print-card" style="margin-top:10px">
        <div class="print-label">Photos</div>
        <div class="print-photos">
          ${p4.map(src=>`<img src="${src}" alt="">`).join('')}
        </div>
      </div>`:''}
    </div>
  `;
}

async function showBrochure(rec, openPrintWindow){
  // logo
  let logoUrl = '';
  try{ logoUrl = await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL(); }catch(e){}
  const html = brochureHTML(rec, logoUrl);
  if(openPrintWindow){
    const w = window.open('', '_blank');
    w.document.write('<html><head><title>Print</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"><style>'+document.querySelector('style').innerHTML+'</style></head><body>'+html+'</body></html>');
    w.document.close(); w.focus(); setTimeout(()=>w.print(), 300);
  }else{
    // Inline show (Details) – replace list with just this farm temporarily
    $('result-cards').innerHTML = `
      <div class="farm-card">
        <div class="head">
          <div><strong>#${rec.dairyNumber}</strong></div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-brand" onclick="openPrint('${rec.dairyNumber}')">Print</button>
            <button class="btn btn-sm btn-outline-brand" onclick="drawFarmList(ALL_DAIRIES)">Back to list</button>
          </div>
        </div>
        <div class="mt-2">${html}</div>
      </div>`;
    window.scrollTo({top:0,behavior:'smooth'});
  }
}

/* ========= Extract signal from Gateway/Notes ========= */
function extractSignal(rec){
  const text = [
    rec.GatewayLocation||'',
    ...(rec.vats||[]).map(v=>v.Notes||''),
    ...(rec.vats||[]).map(v=>v.CapComments||'')
  ].join(' | ').toLowerCase();
  // try “x bars spark / one nz”
  const spark = text.match(/(\d+)\s*bars?\s*(4g\s*)?(spark)/) || text.match(/(spark).{0,8}(\d+)\s*bars?/);
  const one   = text.match(/(\d+)\s*bars?\s*(4g\s*)?(one\s*nz|vodafone)/) || text.match(/(one\s*nz|vodafone).{0,8}(\d+)\s*bars?/);
  const sp = spark ? (spark[1]||spark[2]) : '';
  const on = one   ? (one[1]||one[2])     : '';
  if(sp || on) return `Spark ${sp||'-'} • One NZ ${on||'-'}`;
  // generic mentions like “2 bars spark”, “full bars both carriers”
  if(/full\s+bars.*both/.test(text)) return 'Full bars both carriers';
  if(/spark.*bars?/.test(text) && !sp) return 'Spark (bars mentioned)';
  if(/(one\s*nz|vodafone).*bars?/.test(text) && !on) return 'One NZ (bars mentioned)';
  return '-';
}

/* ========= ADMIN: Force sync (rebuild meta & index) ========= */
$('btn-sync').onclick = async ()=>{
  ALL_DAIRIES = [];
  ALL_META = [];
  $('result-cards').innerHTML = '';
  $('size-table').innerHTML = '';
  $('kpi-dts').textContent='0'; $('kpi-power').textContent='0'; $('kpi-rubber').textContent='0';
  setProgress(0,1);
  await renderSummaryInstant();
  alert('Sync complete.');
};

/* ========= ADMIN: Print All Brochures ========= */
$('btn-print-all').onclick = async ()=>{
  if(!ALL_DAIRIES.length){ alert('No farms indexed yet. Open Summary first.'); return; }
  const dairies = ALL_DAIRIES.slice();
  // print sequentially to avoid browser choking
  for(const dn of dairies){
    const rec = await getFullRecord(dn);
    if(!rec) continue;
    await new Promise(resolve=>{
      const w = window.open('', '_blank');
      (async()=>{
        let logoUrl=''; try{ logoUrl = await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL(); }catch(e){}
        const html = brochureHTML(rec, logoUrl);
        w.document.write('<html><head><title>Print</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"><style>'+document.querySelector('style').innerHTML+'</style></head><body>'+html+'</body></html>');
        w.document.close(); w.focus(); setTimeout(()=>{ w.print(); setTimeout(()=>{ try{w.close()}catch(e){} resolve(); }, 300); }, 300);
      })();
    });
  }
  alert('All print jobs dispatched.');
};

/* ========= ADMIN: Download All (ZIP of PDFs) ========= */
$('btn-download-all').onclick = async ()=>{
  if(!ALL_DAIRIES.length){ alert('No farms indexed yet. Open Summary first.'); return; }
  const zip = new JSZip();
  let i=0;
  // To keep it lightweight and 1 page per farm, we embed the HTML brochure as a single HTML file per farm (fast).
  // If you require real PDFs instead, we can switch to jsPDF per farm (heavier and slower).
  let logoUrl=''; try{ logoUrl = await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL(); }catch(e){}
  for(const dn of ALL_DAIRIES){
    const rec = await getFullRecord(dn); if(!rec) continue;
    const html = `
      <html><head><meta charset="utf-8"><title>#${dn} – Brochure</title>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">
      <style>${document.querySelector('style').innerHTML}</style></head>
      <body>${brochureHTML(rec, logoUrl)}</body></html>`;
    zip.file(`Brochure_${dn}.html`, html);
    i++;
    setProgress(i, ALL_DAIRIES.length);
  }
  const blob = await zip.generateAsync({type:'blob'});
  saveAs(blob, 'agora_brochures_all.zip');
};

/* ========= ADMIN: Owner Report (PDF, 1–2 pages) ========= */
$('btn-owner-report').onclick = async ()=>{
  const all = await db.farms.toArray();
  if(!all.length){ alert('Open Summary so we can fetch data first.'); return; }
  const rows = [];
  // aggregate
  all.forEach(r=>{
    (r.vats||[]).forEach(v=>{
      rows.push({
        Dairy: r.dairyNumber,
        Vat: v.Vat || '',
        Size: v.Size || '',
        Serial: v.Serial || '',
        Cap: v.Cap || '',
        Condition: v.Condition || '',
        DoorDelivered: r.DoorDelivered || 'No',
        DoorSize: r.DoorSize || '',
        RJTDelivered: r.RJTDelivered || 'No',
        RJTSize: r.RJTSize || ''
      });
    });
  });
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','pt','a4');
  pdf.setFont('helvetica','bold'); pdf.setFontSize(16);
  pdf.text('Owner Summary – Vats & Rubberware', 40, 40);
  pdf.setFont('helvetica','normal'); pdf.setFontSize(10);

  // Table header
  const cols = ['Dairy','Vat','Size','Serial','Cap','Condition','DoorDelivered','DoorSize','RJTDelivered','RJTSize'];
  let y=60, x=40;
  pdf.setFont('helvetica','bold'); cols.forEach((c,i)=>{ pdf.text(c, x+ i*60, y); });
  pdf.setFont('helvetica','normal'); y+=16;
  rows.slice(0,60).forEach(r=>{
    const vals = cols.map(k=>String(r[k]||''));
    vals.forEach((v,i)=>{ pdf.text(v.substring(0,14), x+i*60, y); });
    y+=14; if(y>780){ pdf.addPage(); y=40; }
  });
  pdf.save('Owner_Report.pdf');
};

/* ========= FORM: auto-fill by dairy (simple preview) ========= */
$('form-dairy').addEventListener('blur', async (e)=>{
  const dn = (e.target.value||'').trim(); if(!dn) return;
  const rec = await getFullRecord(dn);
  if(!rec){ $('form-info').innerHTML = `<span class="text-danger">No record found.</span>`; return; }
  const v1 = (rec.vats||[]).find(v=>String(v.Vat)==='1')||{};
  const v2 = (rec.vats||[]).find(v=>String(v.Vat)==='2')||{};
  $('form-info').innerHTML = `
    <div><b>#${rec.dairyNumber}</b></div>
    <div>Gateway: ${rec.GatewayLocation||'-'}</div>
    <div>Other Telemetry: ${rec.OtherBrand||'-'} • ${rec.OtherType||'-'} • ${rec.OtherNotes||'-'}</div>
    <hr>
    <div><b>Vat 1</b> — Size: ${v1.Size||'-'} | Serial: ${v1.Serial||'-'} | Cap: ${v1.Cap||'-'} | Cond: ${v1.Condition||'-'} | Notes: ${v1.Notes||'-'} | CapComments: ${v1.CapComments||'-'}</div>
    <div><b>Vat 2</b> — Size: ${v2.Size||'-'} | Serial: ${v2.Serial||'-'} | Cap: ${v2.Cap||'-'} | Cond: ${v2.Condition||'-'} | Notes: ${v2.Notes||'-'} | CapComments: ${v2.CapComments||'-'}</div>
  `;
});

/* ========= Service Worker ========= */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
}

/* ========= Init ========= */
window.addEventListener('DOMContentLoaded', async ()=>{
  try{
    // immediate summary render (list dairies)
    await renderSummaryInstant();
  }catch(e){
    console.error(e);
    alert('Failed to render summary. Try Force Sync from Admin.');
  }
});
</script>
</body>
</html>