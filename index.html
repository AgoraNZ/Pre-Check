<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Agora Vat Pre-Check</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">

<style>
:root{--brand:#001F3F;--accent:#FF851B;--muted:#6b7280;--bg:#f7f8fb;--ok:#2ecc71;--warn:#ffb020;--danger:#ff4136;}
html,body{background:var(--bg);color:#0f172a;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
.app{max-width:1100px;margin:28px auto;padding:0 16px}
.brand-header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
.brand-logo{width:160px;height:auto;display:none}
.brand-title{flex:1}
.brand-title h1{margin:0;font-weight:800;color:var(--brand);letter-spacing:.2px}
.brand-sub{color:var(--muted);font-size:.95rem;margin-top:2px}
.tabbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 18px}
.tab-btn{border:1px solid #e5e7eb;background:#fff;color:#111827;border-radius:10px;padding:10px 14px;font-weight:700}
.tab-btn.active{border-color:var(--accent);box-shadow:0 0 0 3px #ff851b2b}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #e5e7eb;font-weight:700}
.progress{height:10px}

.bar{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin:10px 0}
.section-title{font-size:1.05rem;font-weight:800;color:#111827;margin:6px 0 10px}

.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:16px;cursor:pointer}
.kpi .num{font-size:1.6rem;font-weight:800}
.kpi .label{color:#6b7280;font-size:1rem}
.kpi:hover{box-shadow:0 6px 20px rgba(0,0,0,.06)}

.result-actions{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
.btn-brand{background:var(--accent);border:none;color:#fff;font-weight:800}
.btn-brand:hover{background:#ff6d00}
.btn-outline-brand{border:1px solid var(--accent);color:var(--accent);background:#fff;font-weight:800}
.btn-outline-brand:hover{background:var(--accent);color:#fff}

.list{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media (max-width:900px){.list{grid-template-columns:1fr}}
.item{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px;display:flex;align-items:center;justify-content:space-between}
.item .left{display:flex;align-items:center;gap:8px}
.badge-soft{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:2px 8px;font-size:.8rem;color:#374151}

.form-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:14px;margin-bottom:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:900px){.grid-3{grid-template-columns:1fr}}

.hidden{display:none!important}
.small-note{color:#6b7280}
.photo-thumb{width:110px;height:86px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;margin-top:6px}

/* PRINT / DETAILS SHEET (brochure) */
.print-sheet{max-width:950px;margin:0 auto;color:#0f172a}
.print-head{display:flex;align-items:center;gap:16px;border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:10px}
.print-head img{height:44px}
.print-title{font-weight:800;font-size:1.2rem}
.print-sub{color:#6b7280}
.print-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.print-card{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
.print-label{font-weight:800;margin-bottom:6px}
.print-photos{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.print-photos img{width:100%;max-height:180px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb}
.page-break{page-break-after:always;margin:18px 0}
.footer{color:#6b7280;text-align:center;margin:22px 0 10px}
</style>
</head>
<body>
<div class="app">
  <div class="brand-header">
    <img id="logo" class="brand-logo" alt="Agora Logo">
    <div class="brand-title">
      <h1>Agora Vat Pre-Check</h1>
      <div class="brand-sub">Fast field capture • Smart summary • Customer-ready output</div>
    </div>
  </div>

  <div class="tabbar">
    <button id="tab-summary" class="tab-btn active">Summary</button>
    <button id="tab-form" class="tab-btn">Form</button>
    <button id="tab-admin" class="tab-btn">Admin</button>

    <span class="ms-auto pill">Cloud: <span id="cloud-count">–</span></span>
    <span class="pill">Loaded: <span id="loaded-count">0</span></span>
  </div>
  <div class="progress"><div id="bar" class="progress-bar" style="width:0%"></div></div>
  <div class="small-note mt-1"><span id="pct">0</span>%</div>

  <!-- SUMMARY -->
  <div id="view-summary">
    <div class="bar">
      <div class="section-title">Vat Size Breakdown (live from cloud)</div>
      <div id="sizes-table" class="mb-2"></div>
      <button id="btn-export-sizes" class="btn btn-outline-brand">Export Sizes CSV</button>
    </div>

    <div class="bar">
      <div class="section-title">Overview</div>
      <div class="kpi-grid">
        <div class="kpi" data-k="dts"><div class="num" id="kpi-dts">0</div><div class="label">DTS Vent Caps</div></div>
        <div class="kpi" data-k="power"><div class="num" id="kpi-power">0</div><div class="label">Farms needing power point</div></div>
        <div class="kpi" data-k="rubber"><div class="num" id="kpi-rubber">0</div><div class="label">Rubberware deliveries</div></div>
      </div>
    </div>

    <div class="bar">
      <div class="section-title">Results</div>
      <div class="result-actions">
        <input id="search" class="form-control" placeholder="Search dairy # or text…" style="max-width:320px">
        <button id="clear" class="btn btn-outline-secondary">Clear</button>
        <button id="btn-print-all" class="btn btn-brand">Print All Brochures</button>
        <button id="btn-zip-all" class="btn btn-outline-brand">Download All Brochures (ZIP)</button>
      </div>
      <div id="results" class="list"></div>
    </div>
  </div>

  <!-- FORM -->
  <div id="view-form" class="hidden">
    <div class="form-card">
      <div class="grid-3">
        <div>
          <label class="form-label">Dairy Number</label>
          <input id="dairyNumber" class="form-control" placeholder="e.g. 7038">
          <div class="small-note">Blur to auto-fill from cloud if available.</div>
        </div>
        <div>
          <label class="form-label">Gateway Location</label>
          <input id="gateway-location" class="form-control" placeholder="e.g. plant room">
        </div>
        <div>
          <label class="form-label">Gateway Comments</label>
          <input id="gateway-comments" class="form-control" placeholder="signal notes etc.">
        </div>
      </div>
    </div>
    <div class="form-card">
      <h6>Vat 1</h6>
      <div class="grid-3">
        <div><label class="form-label">Capacity (L)</label><input id="vat1-capacity" class="form-control"></div>
        <div><label class="form-label">Cap</label><select id="vat1-cap" class="form-select"><option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option></select></div>
        <div><label class="form-label">Serial</label><input id="vat1-serial" class="form-control"></div>

        <div><label class="form-label">Condition</label><select id="vat1-condition" class="form-select"><option value="ok">ok</option><option value="attention">attention</option></select></div>
        <div><label class="form-label">Cap Comments</label><input id="vat1-cap-comments" class="form-control"></div>
        <div><label class="form-label">Notes</label><input id="vat1-comments" class="form-control"></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Vat 2</h6>
      <div class="grid-3">
        <div><label class="form-label">Capacity (L)</label><input id="vat2-capacity" class="form-control" placeholder="leave blank if N/A"></div>
        <div><label class="form-label">Cap</label><select id="vat2-cap" class="form-select"><option value="na">N/A</option><option value="available">Available ✓</option><option value="unavailable">Unavailable ✗</option></select></div>
        <div><label class="form-label">Serial</label><input id="vat2-serial" class="form-control"></div>

        <div><label class="form-label">Condition</label><select id="vat2-condition" class="form-select"><option value="ok">ok</option><option value="attention">attention</option></select></div>
        <div><label class="form-label">Cap Comments</label><input id="vat2-cap-comments" class="form-control"></div>
        <div><label class="form-label">Notes</label><input id="vat2-comments" class="form-control"></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Other</h6>
      <div class="grid-3">
        <div><label class="form-label">Other brand</label><input id="other-brand" class="form-control"></div>
        <div><label class="form-label">Other type</label><input id="other-type" class="form-control"></div>
        <div><label class="form-label">Other notes</label><input id="other-notes" class="form-control"></div>
      </div>
    </div>

    <div class="form-card">
      <h6>Rubberware</h6>
      <div class="grid-3">
        <div><label class="form-label">Door delivered?</label><select id="door-delivered" class="form-select"><option value="no">No</option><option value="yes">Yes</option></select></div>
        <div><label class="form-label">Door size</label><select id="door-size" class="form-select"><option value="">—</option><option>small</option><option>large</option></select></div>
        <div><label class="form-label">RJT delivered?</label><select id="rjt-delivered" class="form-select"><option value="no">No</option><option value="yes">Yes</option></select></div>
      </div>
    </div>

    <div class="form-card">
      <button id="btn-save" class="btn btn-brand">Save / Update</button>
      <button id="btn-print-this" class="btn btn-outline-brand">Print This Brochure</button>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="view-admin" class="hidden">
    <div class="bar">
      <div class="section-title">Data Tools</div>
      <div class="d-flex flex-wrap gap-2">
        <button id="btn-reload" class="btn btn-brand">Reload From Cloud</button>
        <button id="btn-download-json" class="btn btn-outline-brand">Download All JSON (ZIP)</button>
      </div>
      <div class="small-note mt-2">
        No Dexie cache. A Service Worker caches the app shell and any brochures you open so those work offline.
      </div>
    </div>
  </div>

  <div class="footer">Agora • Vat Pre-Check • v4.2</div>
</div>

<!-- Brochure container for print/detail -->
<div id="print-host" class="hidden"></div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
/* ---------------- Firebase ---------------- */
const cfg={apiKey:"AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",authDomain:"dairy-farm-record-system.firebaseapp.com",projectId:"dairy-farm-record-system",storageBucket:"dairy-farm-record-system.appspot.com",messagingSenderId:"422124188212",appId:"1:422124188212:web:1bd31bee8d6e91e301d061"};
firebase.initializeApp(cfg);
const storage=firebase.storage();
const FOLDER='Pre Check';

/* ---------------- UI helpers ---------------- */
const $=id=>document.getElementById(id);
const setActive=(id)=>{document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));$(id).classList.add('active')};
const show=(id)=>$(id).classList.remove('hidden');
const hide=(id)=>$(id).classList.add('hidden');
function setProgress(done,total){
  const pct = total ? Math.min(100, Math.round(done*100/total)) : 0;
  $('bar').style.width=pct+'%'; $('pct').textContent=pct;
  $('loaded-count').textContent=done;
}

/* ---------------- Logo ---------------- */
(async()=>{try{const url=await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL();$('logo').src=url;$('logo').style.display='block';}catch(e){}})();

/* ---------------- Nav ---------------- */
$('tab-summary').onclick=()=>{setActive('tab-summary');show('view-summary');hide('view-form');hide('view-admin')};
$('tab-form').onclick   =()=>{setActive('tab-form');hide('view-summary');show('view-form');hide('view-admin')};
$('tab-admin').onclick  =()=>{setActive('tab-admin');hide('view-summary');hide('view-form');show('view-admin')};

/* ---------------- Data State ---------------- */
let CLOUD_KEYS=[];        // array of filenames (e.g. "7038.json")
let RECORDS=[];           // array of parsed farm objects
let SIZES_MAP={};         // size -> count (recomputed progressively)
const keyToDn=k=>k.replace('.json','');

/* ---------------- Cloud listing ---------------- */
async function listCloudKeys(){
  const folder=storage.ref(FOLDER);
  const res=await folder.listAll();
  const keys=res.items.filter(x=>/\.json$/i.test(x.name)).map(x=>x.name);
  CLOUD_KEYS=keys.sort((a,b)=>keyToDn(a).localeCompare(keyToDn(b)));
  $('cloud-count').textContent=CLOUD_KEYS.length;
  return CLOUD_KEYS;
}

/* ---------------- Progressive loader ---------------- */
function detectDtsCap(rec){
  const blob = (rec['vat1-cap-comments']||'')+' '+(rec['vat2-cap-comments']||' ')+' '+(rec['vat1-comments']||'')+' '+(rec['vat2-comments']||'');
  return /(grey|gray)\s+(halo|sensor)|\bdts\b.*(cap|vent)|reducing\s+cap/i.test(blob);
}
function detectPowerPoint(rec){
  const blob = [rec['gateway-comments'],rec['gateway-location'],rec['vat1-comments'],rec['vat2-comments'],rec['other-notes']].join(' ');
  return /(power\s*point.*(need|req|install)|no\s*power|splitter\s*plug)/i.test(blob);
}
function deliveredCountDoor(rec){
  if(rec['door-delivered']!=='yes') return 0;
  return rec['vat2-capacity'] ? 2 : 1;
}
function preferredFromGateway(rec){
  // pull spark/one hints from gateway fields if bars not present
  const t = ((rec['gateway-comments']||'')+' '+(rec['gateway-location']||'')).toLowerCase();
  const s = (rec['spark-bars']||'').toString();
  const o = (rec['one-bars']||'').toString();
  return {spark:s||(/spark.*(\d+)\s*bar/.exec(t)?.[1]||''), one:o||(/(one\s*nz|vodafone).*(\d+)\s*bar/.exec(t)?.[2]||'')};
}
function collectPhotos(rec){
  const list=[
    rec['gateway-photo-base64'],
    rec['vat1-cap-photo-base64'],
    rec['agitator1-photo-base64']||rec['agitator-photo-base64'],
    rec['vat2-cap-photo-base64'],
    rec['agitator2-photo-base64'],
    rec['door-photo-base64']||rec['vat-door-seal-photo-base64'],
    rec['rjt-photo-base64']||rec['rjt-seal-photo-base64']
  ].filter(Boolean);
  return list.slice(0,4);
}
function manuFromNotes(rec){
  const blob = (rec['vat1-comments']||'')+' '+(rec['vat2-comments']||'')+' '+(rec['other-brand']||'');
  if(/\bdts\b/i.test(blob)) return 'DTS';
  if(/\bnda\b/i.test(blob)) return 'NDA';
  if(/\bhalo\b/i.test(blob)) return 'Halo';
  if(/\blevno\b/i.test(blob)) return 'Levno';
  return (rec['other-brand']||'')||'-';
}

function addToSizes(rec){
  const s1=(rec['vat1-capacity']||'').toString().trim(); if(s1) SIZES_MAP[s1]=(SIZES_MAP[s1]||0)+1;
  const s2=(rec['vat2-capacity']||'').toString().trim(); if(s2) SIZES_MAP[s2]=(SIZES_MAP[s2]||0)+1;
}
function renderSizes(){
  let html='<table class="table table-sm table-bordered"><thead><tr><th>Vat Size (L)</th><th>Count</th></tr></thead><tbody>';
  Object.entries(SIZES_MAP).sort((a,b)=>parseInt(a[0])-parseInt(b[0])).forEach(([sz,c])=>{
    html+=`<tr><td>${sz||'—'}</td><td>${c}</td></tr>`;
  });
  html+='</tbody></table>';
  $('sizes-table').innerHTML=html;
}
function recomputeKpis(){
  const dts=RECORDS.filter(detectDtsCap).length;
  const power=RECORDS.filter(detectPowerPoint).length;
  const rubber=RECORDS.filter(r=>r['door-delivered']==='yes'||r['rjt-delivered']==='yes').length;
  $('kpi-dts').textContent=dts; $('kpi-power').textContent=power; $('kpi-rubber').textContent=rubber;
}
function renderList(rows){
  const q=($('search').value||'').trim().toLowerCase();
  const filtered=(rows||RECORDS).filter(r=>!q || (String(r.dairyNumber).includes(q) || JSON.stringify(r).toLowerCase().includes(q)));
  $('results').innerHTML = filtered
    .sort((a,b)=>String(a.dairyNumber).localeCompare(String(b.dairyNumber)))
    .map(r=>`
      <div class="item">
        <div class="left"><strong>#${r.dairyNumber}</strong>
          <span class="badge-soft">${r['vat1-capacity']||'-'}${r['vat2-capacity']?' • '+r['vat2-capacity']:''}</span>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-brand" onclick="openDetails('${r.dairyNumber}')">Details</button>
          <button class="btn btn-sm btn-brand" onclick="openPrint('${r.dairyNumber}')">Print</button>
        </div>
      </div>`).join('');
}
async function loadAll(){
  $('results').innerHTML='';
  RECORDS=[]; SIZES_MAP={}; renderSizes(); recomputeKpis(); setProgress(0,CLOUD_KEYS.length);
  let done=0;
  for(const key of CLOUD_KEYS){
    try{
      const url=await storage.ref(FOLDER+'/'+key).getDownloadURL();
      const rec=await fetch(url).then(r=>r.json());
      if(!rec.dairyNumber) rec.dairyNumber=keyToDn(key);
      RECORDS.push(rec);
      addToSizes(rec);
      if(done<30){ renderList(RECORDS); } // quick feeling of immediacy
      if(done%10===0) { renderSizes(); recomputeKpis(); }
    }catch(e){/* skip bad files */}
    done++; setProgress(done,CLOUD_KEYS.length);
  }
  renderSizes(); recomputeKpis(); renderList(RECORDS);
}

/* ---------------- Brochure builder ---------------- */
async function brochureHTML(rec){
  // logo
  let logo='';
  try{const url=await storage.ref('Agora Logo/2F6-1YdaEP.jpeg').getDownloadURL(); logo=`<img src="${url}" alt="logo">`;}catch(e){}
  const manu = manuFromNotes(rec);
  const sig = preferredFromGateway(rec);

  const doorCount = deliveredCountDoor(rec);
  const photos = collectPhotos(rec);
  const photoGrid = photos.length ? `<div class="print-photos">${photos.map(s=>`<img src="${s}">`).join('')}</div>` : '';

  return `
  <div class="print-sheet">
    <div class="print-head">${logo}<div><div class="print-title">Vat Pre-Check – #${rec.dairyNumber}</div>
      <div class="print-sub">Brand: ${manu} • Spark: ${sig.spark||'-'} • One NZ: ${sig.one||'-'}</div></div></div>

    <div class="print-grid">
      <div class="print-card">
        <div class="print-label">Vat 1</div>
        <div>Capacity: <b>${rec['vat1-capacity']||'-'}</b></div>
        <div>Cap: <b>${(rec['vat1-cap']||'-').toUpperCase()}</b></div>
        <div>Serial: <b>${rec['vat1-serial']||'-'}</b></div>
        <div>Condition: <b>${rec['vat1-condition']||'-'}</b></div>
        <div>Notes: ${rec['vat1-comments']||'-'}</div>
        <div>Cap comments: ${rec['vat1-cap-comments']||'-'}</div>
      </div>
      <div class="print-card">
        <div class="print-label">Vat 2</div>
        <div>Capacity: <b>${rec['vat2-capacity']||'-'}</b></div>
        <div>Cap: <b>${(rec['vat2-cap']||'-').toUpperCase()}</b></div>
        <div>Serial: <b>${rec['vat2-serial']||'-'}</b></div>
        <div>Condition: <b>${rec['vat2-condition']||'-'}</b></div>
        <div>Notes: ${rec['vat2-comments']||'-'}</div>
        <div>Cap comments: ${rec['vat2-cap-comments']||'-'}</div>
      </div>

      <div class="print-card">
        <div class="print-label">Gateway</div>
        <div>Location: <b>${rec['gateway-location']||'-'}</b></div>
        <div>Comments: ${rec['gateway-comments']||'-'}</div>
      </div>
      <div class="print-card">
        <div class="print-label">Mobile Signal</div>
        <div>Spark: <b>${sig.spark||'-'}</b></div>
        <div>One NZ: <b>${sig.one||'-'}</b></div>
      </div>

      <div class="print-card">
        <div class="print-label">Other Telemetry</div>
        <div>Brand: <b>${rec['other-brand']||'-'}</b> • Type: <b>${rec['other-type']||'-'}</b></div>
        <div>Notes: ${rec['other-notes']||'-'}</div>
      </div>
      <div class="print-card">
        <div class="print-label">Rubberware</div>
        <div>Door Seal: <b>${rec['door-delivered']==='yes'?'Delivered':'No'}</b> ${rec['door-size']? '• '+rec['door-size']:''} ${doorCount? `(x${doorCount})`:''}</div>
        <div>RJT: <b>${rec['rjt-delivered']==='yes'?'Delivered':'No'}</b> ${rec['rjt-size']? '• '+rec['rjt-size']:''}</div>
      </div>
    </div>

    ${photos.length? `<div class="print-card mt-2"><div class="print-label">Photos</div>${photoGrid}</div>`:''}
  </div>`;
}

/* ---------------- Print / Details ---------------- */
window.openDetails = async (dn)=>{
  const rec=RECORDS.find(r=>String(r.dairyNumber)===String(dn)); if(!rec) return;
  const html=await brochureHTML(rec);
  $('print-host').innerHTML=html; $('tab-summary').click();
  window.scrollTo({top:0,behavior:'smooth'});
};
window.openPrint = async (dn)=>{
  const rec=RECORDS.find(r=>String(r.dairyNumber)===String(dn)); if(!rec) return;
  const html=await brochureHTML(rec);
  const w=window.open('','_blank');
  w.document.write(`<html><head><title>${dn}</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"><style>${document.querySelector('style').innerHTML}.page-break{page-break-after:always}</style></head><body>${html}</body></html>`);
  w.document.close(); w.focus(); setTimeout(()=>w.print(),400);
};

/* ---------------- Bulk print/download ---------------- */
$('btn-print-all').onclick=async()=>{
  if(!RECORDS.length){alert('Loading records… please wait until progress reaches 100%.');return;}
  const w=window.open('','_blank');
  const css=`${document.querySelector('style').innerHTML}.page-break{page-break-after:always}`;
  w.document.write(`<html><head><title>All Brochures</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"><style>${css}</style></head><body>`);
  for(let i=0;i<RECORDS.length;i++){
    const html=await brochureHTML(RECORDS[i]);
    w.document.write(`<div>${html}</div>${i<RECORDS.length-1?'<div class="page-break"></div>':''}`);
  }
  w.document.write(`</body></html>`); w.document.close(); w.focus(); setTimeout(()=>w.print(),800);
};
$('btn-zip-all').onclick=async()=>{
  if(!RECORDS.length){alert('Loading records… please wait until progress reaches 100%.');return;}
  const zip=new JSZip();
  for(const r of RECORDS){
    const html=await brochureHTML(r);
    zip.file(`${r.dairyNumber}.html`,`<!doctype html><html><head><meta charset="utf-8"><title>${r.dairyNumber}</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"><style>${document.querySelector('style').innerHTML}</style></head><body>${html}</body></html>`);
  }
  const blob=await zip.generateAsync({type:'blob'});
  saveAs(blob,'agora_brochures.zip');
};

/* ---------------- Summary interactions ---------------- */
document.querySelectorAll('.kpi').forEach(el=>{
  el.addEventListener('click',()=>{
    const k=el.getAttribute('data-k');
    let rows=RECORDS;
    if(k==='dts') rows=RECORDS.filter(detectDtsCap);
    if(k==='power') rows=RECORDS.filter(detectPowerPoint);
    if(k==='rubber') rows=RECORDS.filter(r=>r['door-delivered']==='yes'||r['rjt-delivered']==='yes');
    renderList(rows);
  });
});
$('search').addEventListener('input',()=>renderList(RECORDS));
$('clear').onclick=()=>{$('search').value='';renderList(RECORDS)};

/* ---------------- Exports ---------------- */
$('btn-export-sizes').onclick=()=>{
  const rows=Object.entries(SIZES_MAP).map(([size,count])=>({Size:size,Count:count}));
  const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Vat Sizes'); XLSX.writeFile(wb,'vat_sizes.csv');
};
$('btn-download-json').onclick=async()=>{
  const zip=new JSZip();
  for(const key of CLOUD_KEYS){
    const url=await storage.ref(FOLDER+'/'+key).getDownloadURL();
    const txt=await fetch(url).then(r=>r.text());
    zip.file(key,txt);
  }
  const blob=await zip.generateAsync({type:'blob'}); saveAs(blob,'precheck_json.zip');
};

/* ---------------- Form: auto-fill & save ---------------- */
$('dairyNumber').addEventListener('blur', async ()=>{
  const dn=($('dairyNumber').value||'').trim(); if(!dn) return;
  try{
    const url=await storage.ref(`${FOLDER}/${dn}.json`).getDownloadURL();
    const rec=await fetch(url).then(r=>r.json());
    for(const [k,v] of Object.entries(rec)){ const el=$(k.replace(/[^a-z0-9\-]/gi,'')); if(el && 'value' in el) el.value=v; }
  }catch(e){ /* ignore */ }
});
$('btn-save').onclick=async()=>{
  const dn=($('dairyNumber').value||'').trim(); if(!dn){alert('Enter a Dairy #');return;}
  const data={
    dairyNumber:dn,
    'gateway-location':$('gateway-location').value,
    'gateway-comments':$('gateway-comments').value,
    'vat1-capacity':$('vat1-capacity').value,'vat1-cap':$('vat1-cap').value,'vat1-serial':$('vat1-serial').value,'vat1-condition':$('vat1-condition').value,'vat1-comments':$('vat1-comments').value,'vat1-cap-comments':$('vat1-cap-comments').value,
    'vat2-capacity':$('vat2-capacity').value,'vat2-cap':$('vat2-cap').value,'vat2-serial':$('vat2-serial').value,'vat2-condition':$('vat2-condition').value,'vat2-comments':$('vat2-comments').value,'vat2-cap-comments':$('vat2-cap-comments').value,
    'other-brand':$('other-brand').value,'other-type':$('other-type').value,'other-notes':$('other-notes').value,
    'door-delivered':$('door-delivered').value,'door-size':$('door-size').value,'rjt-delivered':$('rjt-delivered').value,
    timestamp:Date.now()
  };
  const blob=new Blob([JSON.stringify(data)],{type:'application/json'});
  await storage.ref(`${FOLDER}/${dn}.json`).put(blob);
  alert('Saved to cloud.');
};
$('btn-print-this').onclick=async()=>{
  const dn=($('dairyNumber').value||'').trim(); if(!dn){alert('Enter a Dairy #');return;}
  const rec=RECORDS.find(r=>String(r.dairyNumber)===dn) || (await fetch(await storage.ref(`${FOLDER}/${dn}.json`).getDownloadURL()).then(r=>r.json()));
  if(rec){ openPrint(dn); }
};

/* ---------------- Admin actions ---------------- */
$('btn-reload').onclick=async()=>{await bootstrap();};

/* ---------------- Bootstrap on load ---------------- */
async function bootstrap(){
  // logo already set
  await listCloudKeys();
  renderSizes(); // empty view immediately
  renderList([]); // empty list immediately
  loadAll();      // progressive fill
}
bootstrap();

/* ---------------- Service Worker (inline) ---------------- */
if('serviceWorker' in navigator){
  const swCode = `
    const CACHE='agora-precheck-v7';
    const CORE=[
      location.origin+location.pathname,
      'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css',
      'https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js',
      'https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js',
      'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js'
    ];
    self.addEventListener('install',e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CORE)));
      self.skipWaiting();
    });
    self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});
    self.addEventListener('fetch',e=>{
      const req=e.request;
      e.respondWith(
        caches.match(req).then(hit=>{
          return hit || fetch(req).then(res=>{
            try{
              const copy=res.clone();
              caches.open(CACHE).then(c=>c.put(req,copy));
            }catch(_){}
            return res;
          }).catch(_=>hit||Response.error());
        })
      );
    });
  `;
  const blob=new Blob([swCode],{type:'text/javascript'});
  const url=URL.createObjectURL(blob);
  navigator.serviceWorker.register(url).catch(()=>{});
}
</script>
</body>
</html>