<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Agora Vat Pre-Check</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">

<style>
:root{
  --brand:#a7ab01; --ink:#0f1b2d; --muted:#6b7a90;
  --bg:#f6f8fb; --card:#fff; --line:#e9eef6;
  --navy:#0a2b52; --accent:#ff7a1a; --radius:16px;
}
html,body{height:100%}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);}
.wrap{max-width:1100px;margin:18px auto;padding:0 16px}

.brandbar{display:flex;gap:18px;align-items:center;margin-bottom:8px}
.brandbar img{height:56px;width:auto}
.brand-title{font-weight:800;font-size:36px;line-height:1.05}
.brand-sub{color:var(--muted)}
.navpill .btn{border-radius:12px;font-weight:700;padding:9px 16px}
.navpill .btn.active{background:var(--brand);border-color:var(--brand);color:#fff}

.panel{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 8px 24px rgba(15,27,45,.06);padding:18px}

.section-h{font-size:18px;font-weight:800;margin:4px 0 10px}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
@media (max-width:640px){.grid-2,.grid-3{grid-template-columns:1fr}}

.field-card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}
.field-card h6{font-weight:800;margin:0 0 10px}

.preview{display:none;width:100%;border-radius:10px;border:1px solid var(--line);margin-top:6px}

.summary-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px}
.sumcard{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;cursor:pointer;transition:box-shadow .15s,min-height .15s;min-height:120px;display:flex;flex-direction:column;justify-content:center}
.sumcard:hover{box-shadow:0 6px 18px rgba(15,27,45,.08)}
.sumcard .n{font-weight:800;font-size:32px;line-height:1}
.sumcard .t{color:var(--muted);font-weight:600}

.list-badge{background:#eef2f6;border-radius:10px;padding:2px 8px;font-weight:600;color:#2e3c54}

.farm-card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:12px}
.farm-card h5{font-weight:800;margin:0}
.farm-meta{color:var(--muted)}
.photo-chip{font-size:12px;color:#334;margin-top:4px;display:block}

.kv{display:grid;grid-template-columns:140px 1fr;gap:6px 10px}
@media (max-width:640px){.kv{grid-template-columns:110px 1fr}}

.progress-wrap{display:flex;align-items:center;gap:8px}
.badge-soft{background:#eef2f6;color:#2e3c54;border-radius:10px;padding:2px 8px;font-weight:600}

.modal-body img{width:100%;border-radius:10px;border:1px solid var(--line);}

.btn-brand{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-brand:hover{background:#ff6a00;border-color:#ff6a00}
.btn-navy{background:var(--navy);border-color:var(--navy);color:#fff}

.print-logo{height:26px}
.small-note{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <!-- Brand -->
  <div class="brandbar">
    <img id="agoraLogo" alt="Agora" src="">
    <div>
      <div class="brand-title">Agora Vat<br>Pre-Check</div>
      <div class="brand-sub">Fast field capture • Smart summary • Customer-ready output</div>
    </div>
  </div>

  <!-- Nav -->
  <div class="navpill mb-3">
    <div class="btn-group" role="group">
      <button class="btn btn-outline-secondary active" id="navForm">Form</button>
      <button class="btn btn-outline-secondary" id="navSummary">Summary</button>
      <button class="btn btn-outline-secondary" id="navAdmin">Admin</button>
    </div>
  </div>

  <!-- ================== FORM ================== -->
  <section id="pageForm" class="panel">
    <h4 class="mb-3">Create / Update Pre-Check</h4>

    <div class="field-card mb-3">
      <h6>Dairy</h6>
      <div class="grid-2">
        <div>
          <label class="form-label">Number</label>
          <input id="dairyNumber" class="form-control" placeholder="e.g. 7016">
          <div class="small-note">Auto-fills from Firebase when you leave the field (no button).</div>
        </div>
        <div class="d-flex align-items-end">
          <div class="ms-auto progress-wrap w-100">
            <span class="badge-soft">Cloud: <span id="cloudCount">0</span></span>
            <span class="badge-soft">Loaded: <span id="loadedCount">0</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Vat 1 -->
    <div class="field-card mb-3">
      <h6>Vat 1</h6>
      <div class="grid-2">
        <div>
          <label class="form-label">Capacity (L)</label>
          <input id="vat1-capacity" class="form-control" inputmode="numeric">
        </div>
        <div>
          <label class="form-label">Serial #</label>
          <input id="vat1-serial" class="form-control">
        </div>
        <div>
          <label class="form-label">Cap</label>
          <select id="vat1-cap" class="form-select">
            <option value="available">Available ✓</option>
            <option value="unavailable">Unavailable ✗</option>
          </select>
        </div>
        <div>
          <label class="form-label">Condition</label>
          <select id="vat1-condition" class="form-select">
            <option value="ok">OK</option>
            <option value="attention">Attention required</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Comments</label>
          <input id="vat1-comments" class="form-control" placeholder="width/notes etc.">
        </div>
      </div>

      <div class="grid-3 mt-2">
        <div>
          <label class="form-label">Cap photo (if unavailable)</label>
          <input id="vat1-cap-photo" type="file" class="form-control" accept="image/*">
          <img id="vat1-cap-preview" class="preview" alt="">
        </div>
        <div>
          <label class="form-label">Condition photo</label>
          <input id="vat1-condition-photo" type="file" class="form-control" accept="image/*">
          <img id="vat1-condition-preview" class="preview" alt="">
        </div>
        <div>
          <label class="form-label">Agitator location (Vat 1)</label>
          <input id="agitator1-location" class="form-control" placeholder="e.g. behind temp display">
          <input id="agitator1-photo" type="file" class="form-control mt-2" accept="image/*">
          <img id="agitator1-preview" class="preview" alt="">
        </div>
      </div>
    </div>

    <!-- Vat 2 (appears when capacity entered) -->
    <div class="field-card mb-3" id="vat2Card">
      <h6>Vat 2</h6>
      <div class="grid-2">
        <div>
          <label class="form-label">Capacity (L)</label>
          <input id="vat2-capacity" class="form-control" inputmode="numeric" placeholder="Enter to reveal Vat 2 fields">
        </div>
        <div>
          <label class="form-label">Serial #</label>
          <input id="vat2-serial" class="form-control">
        </div>
        <div>
          <label class="form-label">Cap</label>
          <select id="vat2-cap" class="form-select">
            <option value="na">N/A</option>
            <option value="available">Available ✓</option>
            <option value="unavailable">Unavailable ✗</option>
          </select>
        </div>
        <div>
          <label class="form-label">Condition</label>
          <select id="vat2-condition" class="form-select">
            <option value="ok">OK</option>
            <option value="attention">Attention required</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Comments</label>
          <input id="vat2-comments" class="form-control">
        </div>
      </div>

      <div class="grid-3 mt-2">
        <div>
          <label class="form-label">Cap photo (if unavailable)</label>
          <input id="vat2-cap-photo" type="file" class="form-control" accept="image/*">
          <img id="vat2-cap-preview" class="preview" alt="">
        </div>
        <div>
          <label class="form-label">Condition photo</label>
          <input id="vat2-condition-photo" type="file" class="form-control" accept="image/*">
          <img id="vat2-condition-preview" class="preview" alt="">
        </div>
        <div>
          <label class="form-label">Agitator location (Vat 2)</label>
          <input id="agitator2-location" class="form-control" placeholder="e.g. front centre">
          <input id="agitator2-photo" type="file" class="form-control mt-2" accept="image/*">
          <img id="agitator2-preview" class="preview" alt="">
        </div>
      </div>
    </div>

    <!-- Gateway & Signal -->
    <div class="grid-2">
      <div class="field-card">
        <h6>Gateway</h6>
        <label class="form-label">Location</label>
        <input id="gateway-location" class="form-control" placeholder="e.g. chiller switchboard">
        <label class="form-label mt-2">Comments</label>
        <input id="gateway-comments" class="form-control">
        <input id="gateway-photo" type="file" class="form-control mt-2" accept="image/*">
        <img id="gateway-preview" class="preview" alt="">
      </div>
      <div class="field-card">
        <h6>Signal</h6>
        <div class="grid-2">
          <div>
            <label class="form-label">Spark bars</label>
            <select id="spark-bars" class="form-select">
              <option value="0">0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            </select>
          </div>
          <div>
            <label class="form-label">One NZ bars</label>
            <select id="one-bars" class="form-select">
              <option value="0">0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            </select>
          </div>
        </div>
        <label class="form-label mt-2">Preferred</label>
        <select id="signal-preferred" class="form-select">
          <option value="">—</option>
          <option value="spark">Spark</option>
          <option value="one">One NZ</option>
        </select>
      </div>
    </div>

    <!-- Other telemetry & Rubberware -->
    <div class="grid-2">
      <div class="field-card">
        <h6>Other telemetry</h6>
        <label class="form-label">Brand</label>
        <input id="telemetry-brand" class="form-control" placeholder="Halo, Levno, DTS, NDA…">
        <label class="form-label mt-2">Type</label>
        <input id="telemetry-type" class="form-control" placeholder="vat, water, fuel…">
        <label class="form-label mt-2">Comments</label>
        <input id="telemetry-comments" class="form-control">
      </div>
      <div class="field-card">
        <h6>Rubberware</h6>
        <label class="form-label">Vat Door Seal</label>
        <select id="door-seal" class="form-select">
          <option value="notdelivered">Not delivered</option>
          <option value="delivered">Delivered</option>
        </select>
        <div class="grid-2 mt-2">
          <div>
            <label class="form-label">Door seal size</label>
            <select id="door-seal-size" class="form-select">
              <option value="">Unspecified</option>
              <option value="small">Small</option>
              <option value="large">Large</option>
            </select>
          </div>
          <div>
            <label class="form-label">Count</label>
            <input id="door-seal-count" class="form-control" inputmode="numeric" placeholder="auto = vat count">
          </div>
        </div>
        <input id="door-seal-photo" type="file" class="form-control mt-2" accept="image/*">
        <img id="door-seal-preview" class="preview" alt="">
        <hr class="my-3">
        <label class="form-label">RJT Step Seal</label>
        <select id="rjt" class="form-select">
          <option value="notdelivered">Not delivered</option>
          <option value="delivered">Delivered</option>
        </select>
        <label class="form-label mt-2">RJT size</label>
        <select id="rjt-size" class="form-select">
          <option value="">Unspecified</option>
          <option value="small">Small</option>
          <option value="large">Large</option>
        </select>
        <input id="rjt-photo" type="file" class="form-control mt-2" accept="image/*">
        <img id="rjt-preview" class="preview" alt="">
      </div>
    </div>

    <div class="d-flex gap-2 mt-2">
      <button class="btn btn-brand" id="btnSave">Save</button>
      <button class="btn btn-outline-secondary" id="btnPrint">Print brochure</button>
    </div>
  </section>

  <!-- ================== SUMMARY ================== -->
  <section id="pageSummary" class="panel" style="display:none">
    <div class="d-flex align-items-end justify-content-between mb-2">
      <div class="small-note">Cloud: <span id="sumCloud">0</span> • Loaded: <span id="sumLoaded">0</span></div>
      <div class="d-flex gap-2">
        <button id="btnReload" class="btn btn-outline-secondary btn-sm">Reload</button>
        <button id="btnExportCSV" class="btn btn-outline-secondary btn-sm">Export Vat Sizes CSV</button>
      </div>
    </div>

    <div class="summary-cards mb-3" id="overviewCards"></div>
    <div id="filterTitle" class="mb-2" style="display:none"></div>
    <div id="farmList"></div>
  </section>

  <!-- ================== ADMIN ================== -->
  <section id="pageAdmin" class="panel" style="display:none">
    <h5 class="mb-2">Admin</h5>
    <div class="kv">
      <div class="small-note">Logo</div><div>Storage: <code>Agora Logo/2F6-1YdaEP.jpeg</code></div>
      <div class="small-note">Data</div><div>Storage folder: <code>Pre Check/*.json</code></div>
    </div>
    <button class="btn btn-navy mt-2" id="btnList">List cloud files</button>
    <pre id="adminLog" class="mt-3 small"></pre>
  </section>
</div>

<!-- Details Modal -->
<div class="modal fade" id="farmModal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Farm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="modalContent"></div>
      </div>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>

<script>
/* ---------------- Firebase ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
  authDomain: "dairy-farm-record-system.firebaseapp.com",
  projectId: "dairy-farm-record-system",
  storageBucket: "dairy-farm-record-system.appspot.com",
  messagingSenderId: "422124188212",
  appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

/* ---------------- Helpers ---------------- */
const $ = id => document.getElementById(id);
const pages = {Form:$('pageForm'), Summary:$('pageSummary'), Admin:$('pageAdmin')};
function goto(name){ Object.keys(pages).forEach(k=>pages[k].style.display=(k===name?'block':'none'));
  $('navForm').classList.toggle('active', name==='Form');
  $('navSummary').classList.toggle('active', name==='Summary');
  $('navAdmin').classList.toggle('active', name==='Admin');
  if(name==='Summary'){ loadSummary(); }
}
$('navForm').onclick=()=>goto('Form');
$('navSummary').onclick=()=>goto('Summary');
$('navAdmin').onclick=()=>goto('Admin');

(async function loadLogo(){
  try{ $('agoraLogo').src = await storage.ref("Agora Logo/2F6-1YdaEP.jpeg").getDownloadURL(); }catch(e){}
})();

/* ---------------- Slang/AI normaliser ----------------
   Interprets free text like “grey/gray halo cap”, “splitter plug”, etc. */
function normalise(text){
  if(!text) text = '';
  const t = String(text).toLowerCase();

  // DTS / Vent cap
  const hasDTS = /\bdts\b|vent\s*cap|grey\s*halo|gray\s*halo|halo\s*(lidar|sensor)|levno\s*cap|plain\s*vent/i.test(t);

  // Power point recommended/needed/splitter, “no plugs”, etc.
  const needsPower = /(power\s*point|powerpoint|new\s*power\s*point|pp\b|splitter\s*plug|double\s*adapter|no\s*plugs|free\s*new\s*plug|install\s*new\s*one)/i.test(t);

  // Signal bars + carrier
  const mSpark = t.match(/spark\s*(\d)\s*bars?/);
  const mOne   = t.match(/(one\s?nz|vodafone)\s*(\d)\s*bars?/);
  const sparkBars = mSpark? +mSpark[1] : null;
  const oneBars   = mOne?   +mOne[2]   : null;

  let preferred = '';
  if(/spark\s*(best|preferred|ok|full)/.test(t)) preferred = 'spark';
  if(/(one\s?nz|vodafone)\s*(best|preferred|ok|full)/.test(t)) preferred = 'one';
  if(!preferred && sparkBars!=null && oneBars!=null){
    preferred = sparkBars>oneBars?'spark':(oneBars>sparkBars?'one':'');
  }
  return {hasDTS, needsPower, sparkBars, oneBars, preferred};
}

/* ---------------- Form: show/hide Vat 2 ---------------- */
function toggleVat2Card(explicitShow=false){
  const v = $('vat2-capacity').value.trim();
  const show = explicitShow || (!!v && !/^na\b/i.test(v));
  $('vat2Card').style.display = show ? 'block' : 'none';
}
$('vat2-capacity').addEventListener('input',()=>toggleVat2Card());

/* ---------------- File inputs -> preview ---------------- */
function bindFile(idInput, idImg){
  const fi=$(idInput), img=$(idImg);
  fi?.addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ev => { img.src = ev.target.result; img.style.display='block'; img.dataset.b64 = ev.target.result; }
    reader.readAsDataURL(f);
  });
}
[
  ['vat1-cap-photo','vat1-cap-preview'],
  ['vat1-condition-photo','vat1-condition-preview'],
  ['agitator1-photo','agitator1-preview'],
  ['vat2-cap-photo','vat2-cap-preview'],
  ['vat2-condition-photo','vat2-condition-preview'],
  ['agitator2-photo','agitator2-preview'],
  ['gateway-photo','gateway-preview'],
  ['door-seal-photo','door-seal-preview'],
  ['rjt-photo','rjt-preview'],
].forEach(([i,p])=>bindFile(i,p));

/* ---------------- Load/Save single record ---------------- */
function getRecordFromForm(){
  const r = {
    dairyNumber: $('dairyNumber').value.trim(),
    timestamp: Date.now(),
    // Vat1
    ['vat1-capacity']: $('vat1-capacity').value.trim(),
    ['vat1-serial']: $('vat1-serial').value.trim(),
    ['vat1-cap']: $('vat1-cap').value,
    ['vat1-condition']: $('vat1-condition').value,
    ['vat1-comments']: $('vat1-comments').value.trim(),
    ['agitator1-location']: $('agitator1-location').value.trim(),
    // Vat2
    ['vat2-capacity']: $('vat2-capacity').value.trim(),
    ['vat2-serial']: $('vat2-serial').value.trim(),
    ['vat2-cap']: $('vat2-cap').value,
    ['vat2-condition']: $('vat2-condition').value,
    ['vat2-comments']: $('vat2-comments').value.trim(),
    ['agitator2-location']: $('agitator2-location').value.trim(),
    // Gateway
    ['gateway-location']: $('gateway-location').value.trim(),
    ['gateway-comments']: $('gateway-comments').value.trim(),
    // Signal
    ['spark-bars']: $('spark-bars').value,
    ['one-bars']: $('one-bars').value,
    ['signal-preferred']: $('signal-preferred').value,
    // Other telemetry
    ['telemetry-brand']: $('telemetry-brand').value.trim(),
    ['telemetry-type']: $('telemetry-type').value.trim(),
    ['telemetry-comments']: $('telemetry-comments').value.trim(),
    // Rubberware
    ['vat-door-seal']: $('door-seal').value,
    ['door-seal-size']: $('door-seal-size').value,
    ['door-seal-count']: $('door-seal-count').value.trim(),
    ['rjt-seal']: $('rjt').value,
    ['rjt-size']: $('rjt-size').value
  };
  // default rubberware count = number of vats present if blank
  if(!r['door-seal-count']){
    let n=0; if(r['vat1-capacity']) n++; if(r['vat2-capacity'] && !/^na\b/i.test(r['vat2-capacity'])) n++;
    r['door-seal-count']=String(n||1);
  }
  // attach photos if chosen
  const imgs = {
    vat1CapPhoto:'vat1-cap-preview', vat1CondPhoto:'vat1-condition-preview',
    agitator1Photo:'agitator1-preview', vat2CapPhoto:'vat2-cap-preview',
    vat2CondPhoto:'vat2-condition-preview', agitator2Photo:'agitator2-preview',
    gatewayPhoto:'gateway-preview', doorSealPhoto:'door-seal-preview',
    rjtPhoto:'rjt-preview'
  };
  for(const k in imgs){ const im=$(imgs[k]); if(im?.dataset?.b64) r[k]=im.dataset.b64; }
  return r;
}

function fillForm(r){
  const set=(id,val)=>{ if($(id)) $(id).value = val ?? ''; };
  set('vat1-capacity',r['vat1-capacity']); set('vat1-serial',r['vat1-serial']);
  set('vat1-cap',r['vat1-cap']||'available'); set('vat1-condition',r['vat1-condition']||'ok'); set('vat1-comments',r['vat1-comments']);

  set('vat2-capacity',r['vat2-capacity']); set('vat2-serial',r['vat2-serial']);
  set('vat2-cap',r['vat2-cap']||'na'); set('vat2-condition',r['vat2-condition']||'ok'); set('vat2-comments',r['vat2-comments']);
  toggleVat2Card(!!(r['vat2-capacity'] && !/^na\b/i.test(r['vat2-capacity'])));

  set('agitator1-location',r['agitator1-location']); set('agitator2-location',r['agitator2-location']);
  set('gateway-location',r['gateway-location']); set('gateway-comments',r['gateway-comments']);
  set('spark-bars',r['spark-bars']||'0'); set('one-bars',r['one-bars']||'0'); set('signal-preferred',r['signal-preferred']||'');
  set('telemetry-brand',r['telemetry-brand']); set('telemetry-type',r['telemetry-type']); set('telemetry-comments',r['telemetry-comments']);
  set('door-seal',r['vat-door-seal']||'notdelivered'); set('door-seal-size',r['door-seal-size']||''); set('door-seal-count',r['door-seal-count']||'');
  set('rjt',r['rjt-seal']||'notdelivered'); set('rjt-size',r['rjt-size']||'');

  const hydrate=(key,imgId)=>{ if(r[key]){ const im=$(imgId); im.src=r[key]; im.style.display='block'; im.dataset.b64=r[key]; } };
  hydrate('vat1CapPhoto','vat1-cap-preview'); hydrate('vat1CondPhoto','vat1-condition-preview');
  hydrate('agitator1Photo','agitator1-preview'); hydrate('vat2CapPhoto','vat2-cap-preview');
  hydrate('vat2CondPhoto','vat2-condition-preview'); hydrate('agitator2Photo','agitator2-preview');
  hydrate('gatewayPhoto','gateway-preview'); hydrate('doorSealPhoto','door-seal-preview'); hydrate('rjtPhoto','rjt-preview');
}

// Autofill when Dairy # loses focus
$('dairyNumber').addEventListener('blur', async (e)=>{
  const id = e.target.value.trim(); if(!id) return;
  try{
    const url = await storage.ref(`Pre Check/${id}.json`).getDownloadURL();
    const rec = await fetch(url,{cache:'no-store'}).then(r=>r.json());
    fillForm(rec);
  }catch(err){
    // no record yet; just clear dependent parts and show clean Vat2 state
    toggleVat2Card(false);
  }
});

// Save -> upload JSON
$('btnSave').onclick = async ()=>{
  const r = getRecordFromForm();
  if(!r.dairyNumber){ alert('Enter a dairy number'); return; }
  const blob = new Blob([JSON.stringify(r)],{type:'application/json'});
  await storage.ref(`Pre Check/${r.dairyNumber}.json`).put(blob);
  alert('Saved ✔');
  // keep Summary fresh if user switches across
};

/* ---------------- Summary (live, no cache) ---------------- */
let ALL = []; // in-memory this session only

async function listCloudFiles(){
  const res = await storage.ref('Pre Check').listAll();
  $('cloudCount').innerText = res.items.length;
  $('sumCloud').innerText = res.items.length;
  return res.items.map(it => it.name.replace('.json',''));
}

// Load all records with small concurrency to avoid iOS crashes
async function loadAllRecords(){
  const names = await listCloudFiles();
  const limit = 4; let idx = 0; const out = [];
  async function next(){
    if(idx>=names.length) return;
    const name = names[idx++]; 
    try{
      const url = await storage.ref(`Pre Check/${name}.json`).getDownloadURL();
      const rec = await fetch(url,{cache:'no-store'}).then(r=>r.json());
      out.push(rec);
      $('loadedCount').innerText = out.length; $('sumLoaded').innerText = out.length;
    }catch(e){}
    return next();
  }
  await Promise.all(Array.from({length:Math.min(limit,names.length)}, next));
  return out;
}

function aiFromRecord(r){
  const blob = [
    r['vat1-comments'], r['vat2-comments'], r['gateway-comments'],
    r['telemetry-comments'], r['gateway-location'], r['current-telemetry'],
    r['vat1-cap-comments'], r['vat2-cap-comments']
  ].filter(Boolean).join(' | ').toLowerCase();

  const A = normalise(blob);

  // read explicit hints (Spark vs One NZ) if bars were entered
  const sBars = Number(r['spark-bars']|| (A.sparkBars ?? 0));
  const oBars = Number(r['one-bars']  || (A.oneBars   ?? 0));
  // pref from explicit field if present
  const pref = r['signal-preferred'] || A.preferred || (sBars>oBars?'spark':(oBars>sBars?'one':''));

  // rubbers
  const rubberDelivered = r['vat-door-seal']==='delivered' ? (Number(r['door-seal-count']||1)||1) : 0;

  // VAT sizes
  const v1 = (r['vat1-capacity']||'').trim();
  const v2 = (r['vat2-capacity']||'').trim();
  const vat2IsNA = !v2 || /^na\b|^—/i.test(v2);

  // “DTS/vent cap present” if comments/brand indicate
  const tele = (r['telemetry-brand']||'').toLowerCase();
  const hasDTS = A.hasDTS || /dts|levno|halo/.test(tele);

  // Power point
  const needsPower = A.needsPower || /(new\s*power\s*point|no\s*plugs)/.test(blob);

  return {hasDTS, needsPower, sBars, oBars, pref, rubberDelivered, v1, v2, vat2IsNA};
}

function buildOverview(){
  let dts=0,power=0,spark=0,one=0,rubber=0;
  const sizeSet = new Set();
  for(const r of ALL){
    const A = aiFromRecord(r);
    if(A.hasDTS) dts++;
    if(A.needsPower) power++;
    if(A.pref==='spark') spark++;
    if(A.pref==='one') one++;
    rubber += A.rubberDelivered;
    if(A.v1) sizeSet.add(A.v1);
    if(A.v2 && !A.vat2IsNA) sizeSet.add(A.v2);
  }
  const cards = [
    {id:'flt_dts', n:dts, label:'DTS Vent Caps'},
    {id:'flt_power', n:power, label:'Farms needing power point'},
    {id:'flt_spark', n:spark, label:'Spark preferred'},
    {id:'flt_one', n:one, label:'One NZ preferred'},
    {id:'flt_rubber', n:rubber, label:'Rubberware deliveries'},
    {id:'flt_all', n:sizeSet.size, label:'Distinct vat sizes'}
  ];
  const box = $('overviewCards');
  box.innerHTML = cards.map(c=>`<div class="sumcard" data-f="${c.id}"><div class="n">${c.n}</div><div class="t">${c.label}</div></div>`).join('');
  box.querySelectorAll('.sumcard').forEach(el=>el.onclick=()=>applyFilter(el.dataset.f));
}

function applyFilter(fid){
  const list = ALL.filter(r=>{
    const A = aiFromRecord(r);
    const map = {
      flt_dts: A.hasDTS,
      flt_power: A.needsPower,
      flt_spark: A.pref==='spark',
      flt_one: A.pref==='one',
      flt_rubber: r['vat-door-seal']==='delivered',
      flt_all: true
    };
    return map[fid];
  });
  $('filterTitle').style.display='block';
  $('filterTitle').innerHTML = `<span class="list-badge">Showing ${list.length} farms</span>`;
  renderFarmCards(list);
}

function smallLine(r){
  const A = aiFromRecord(r);
  const v1 = r['vat1-capacity']||'—';
  const v2 = (A.vat2IsNA?'—':(r['vat2-capacity']||'—'));
  return `
    <div class="farm-card">
      <div class="d-flex justify-content-between align-items-center mb-1">
        <h5>#${r.dairyNumber||'—'}</h5>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary" data-print="${r.dairyNumber}">Print</button>
          <button class="btn btn-sm btn-outline-primary" data-detail="${r.dairyNumber}">Details</button>
        </div>
      </div>
      <div class="farm-meta mb-1">Vat 1: ${v1} L • Cap ${r['vat1-cap']||'—'} • Cond ${r['vat1-condition']||'—'} • SN ${r['vat1-serial']||'—'}</div>
      ${A.vat2IsNA ? '' : `<div class="farm-meta mb-1">Vat 2: ${v2} L • Cap ${r['vat2-cap']||'—'} • Cond ${r['vat2-condition']||'—'} • SN ${r['vat2-serial']||'—'}</div>`}
      <div class="farm-meta mb-1">Signal: Spark ${r['spark-bars']||0} bars • One NZ ${r['one-bars']||0} bars • Pref ${A.pref||'—'}</div>
      <div class="farm-meta">Rubberware: Door seal ${r['vat-door-seal']||'—'} ${r['door-seal-size']?('('+r['door-seal-size']+')'):''} ${r['door-seal-count']?('x'+r['door-seal-count']):''} • RJT ${r['rjt-seal']||'—'} ${r['rjt-size']?('('+r['rjt-size']+')'):''}</div>
    </div>`;
}

function renderFarmCards(rows){
  const wrap = $('farmList');
  rows = rows.slice().sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
  wrap.innerHTML = rows.map(smallLine).join('');
  wrap.querySelectorAll('[data-detail]').forEach(b=>b.onclick=()=>openDetails(b.dataset.detail));
  wrap.querySelectorAll('[data-print]').forEach(b=>b.onclick=()=>printBrochure(b.dataset.print));
}

async function openDetails(id){
  const r = ALL.find(x=>String(x.dairyNumber)===String(id));
  if(!r) return;
  const A = aiFromRecord(r);
  const v2Line = A.vat2IsNA ? '' : `
    <div><strong>Vat 2</strong></div>
    <div>${r['vat2-capacity']||'—'} L • Cap ${r['vat2-cap']||'—'} • Cond ${r['vat2-condition']||'—'} • SN ${r['vat2-serial']||'—'}</div>`;

  // labelled photos (show all that exist)
  const labelled = [
    ['Gateway', r.gatewayPhoto],
    ['Vat 1 cap', r.vat1CapPhoto],
    ['Vat 1 condition', r.vat1CondPhoto],
    ['Agitator 1', r.agitator1Photo],
    ['Vat 2 cap', r.vat2CapPhoto],
    ['Vat 2 condition', r.vat2CondPhoto],
    ['Agitator 2', r.agitator2Photo],
    ['Door seal', r.doorSealPhoto],
    ['RJT', r.rjtPhoto],
  ].filter(x=>!!x[1]);

  $('modalContent').innerHTML = `
    <div class="kv mb-3">
      <div><strong>Dairy</strong></div><div>#${r.dairyNumber||'—'}</div>
      <div><strong>Vat 1</strong></div><div>${r['vat1-capacity']||'—'} L • Cap ${r['vat1-cap']||'—'} • Cond ${r['vat1-condition']||'—'} • SN ${r['vat1-serial']||'—'}</div>
      ${v2Line}
      <div><strong>Gateway</strong></div><div>${r['gateway-location']||'—'} • ${r['gateway-comments']||''}</div>
      <div><strong>Signal</strong></div><div>Spark ${r['spark-bars']||0} • One NZ ${r['one-bars']||0} • Pref ${A.pref||'—'}</div>
      <div><strong>Telemetry</strong></div><div>${r['telemetry-brand']||'—'} • ${r['telemetry-type']||'—'} • ${r['telemetry-comments']||''}</div>
      <div><strong>Rubberware</strong></div><div>Door seal ${r['vat-door-seal']||'—'} ${r['door-seal-size']?('('+r['door-seal-size']+')'):''} ${r['door-seal-count']?('x'+r['door-seal-count']):''} • RJT ${r['rjt-seal']||'—'} ${r['rjt-size']?('('+r['rjt-size']+')'):''}</div>
    </div>
    ${labelled.length? `<div class="row g-3">${labelled.map(([lab,src])=>`
      <div class="col-12 col-md-6 col-lg-4">
        <img loading="lazy" src="${src}" alt="${lab}">
        <div class="photo-chip">${lab}</div>
      </div>`).join('')}</div>` : '<div class="small-note">No photos on file.</div>'}
  `;
  new bootstrap.Modal($('#farmModal')).show();
}

async function printBrochure(id){
  const r = ALL.find(x=>String(x.dairyNumber)===String(id));
  if(!r) return;
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'pt',format:'a4',orientation:'portrait'});
  const W = pdf.internal.pageSize.getWidth();

  try{ const logo = $('agoraLogo').src; if(logo) pdf.addImage(logo,'JPEG',40,24,100,48); }catch(e){}
  pdf.setFont('helvetica','bold'); pdf.setFontSize(18); pdf.text('Vat Pre-Check',160,48);
  pdf.setFont('helvetica','normal'); pdf.setFontSize(11);
  pdf.text(`#${r.dairyNumber||'—'}`, W-160, 40); pdf.text(new Date(r.timestamp||Date.now()).toISOString().slice(0,10), W-160, 58);

  const A = aiFromRecord(r);
  const lines = [
    `Vat 1: ${r['vat1-capacity']||'—'} L • Cap ${r['vat1-cap']||'—'} • Cond ${r['vat1-condition']||'—'} • SN ${r['vat1-serial']||'—'}`,
    (A.vat2IsNA? null : `Vat 2: ${r['vat2-capacity']||'—'} L • Cap ${r['vat2-cap']||'—'} • Cond ${r['vat2-condition']||'—'} • SN ${r['vat2-serial']||'—'}`),
    `Gateway: ${r['gateway-location']||'—'} • ${r['gateway-comments']||''}`,
    `Signal: Spark ${r['spark-bars']||0} bars • One NZ ${r['one-bars']||0} bars • Pref ${A.pref||'—'}`,
    `Telemetry: ${r['telemetry-brand']||'—'} • ${r['telemetry-type']||'—'} • ${r['telemetry-comments']||''}`,
    `Rubberware: Door Seal ${r['vat-door-seal']||'—'} ${r['door-seal-size']?('('+r['door-seal-size']+')'):''} ${r['door-seal-count']?('x'+r['door-seal-count']):''} | RJT ${r['rjt-seal']||'—'} ${r['rjt-size']?('('+r['rjt-size']+')'):''}`
  ].filter(Boolean);
  pdf.setFont('helvetica','bold'); pdf.text('Key Facts',40,100);
  pdf.setFont('helvetica','normal'); let y=120; lines.forEach(l=>{pdf.text(l,40,y); y+=18;});

  // Photos (all, first 12)
  const labelled = [
    ['Gateway', r.gatewayPhoto],
    ['Vat 1 cap', r.vat1CapPhoto], ['Vat 1 condition', r.vat1CondPhoto], ['Agitator 1', r.agitator1Photo],
    ['Vat 2 cap', r.vat2CapPhoto], ['Vat 2 condition', r.vat2CondPhoto], ['Agitator 2', r.agitator2Photo],
    ['Door seal', r.doorSealPhoto], ['RJT', r.rjtPhoto]
  ].filter(x=>!!x[1]).slice(0,12);

  const cw=(W-80-20)/3, ch=cw*0.6; let px=40, py=y+10, c=0;
  for(const [lab,src] of labelled){
    if(py+ch>780){ pdf.addPage(); px=40; py=60; }
    try{ pdf.addImage(src,'JPEG',px,py,cw,ch); }catch(e){}
    pdf.text(lab,px,py+ch+14);
    c++; px+=cw+10; if(c%3===0){ px=40; py+=ch+40; }
  }
  pdf.save(`PreCheck_${r.dairyNumber}.pdf`);
}

async function loadSummary(){
  $('overviewCards').innerHTML = '';
  $('farmList').innerHTML = '';
  $('filterTitle').style.display='none';
  ALL = await loadAllRecords();
  buildOverview();
  renderFarmCards(ALL);
}

$('btnReload').onclick = loadSummary;

/* Admin helper */
$('btnList').onclick = async ()=>{
  const names = await listCloudFiles();
  $('adminLog').textContent = names.join('\n');
};

/* Export CSV of vat sizes + basic columns */
$('btnExportCSV').onclick = async ()=>{
  const rows = [['Dairy','Vat Size (L)','Serial','Manufacturer','Cap Available']];
  ALL.forEach(r=>{
    [['vat1-capacity','vat1-serial','vat1-cap'],['vat2-capacity','vat2-serial','vat2-cap']].forEach(([cap,ser,capKey])=>{
      const v = (r[cap]||'').trim();
      if(v && !/^na\b/i.test(v)){
        const manuMatch = (r['telemetry-brand']||'').toUpperCase().match(/\b(DTS|NDA|HALO|LEVNO)\b/);
        rows.push([r.dairyNumber,v,r[ser]||'',manuMatch?manuMatch[1]:'',r[capKey]||'']);
      }
    });
  });
  const csv = rows.map(r=>r.map(s=>String(s).replace(/"/g,'""')).map(s=>`"${s}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = 'vat_sizes.csv';
  document.body.appendChild(a); a.click(); a.remove();
};

/* Nav initial */
document.addEventListener('DOMContentLoaded', async ()=>{
  try{ await listCloudFiles(); }catch(e){}
});
$('btnPrint').onclick = async ()=>{
  const id = $('dairyNumber').value.trim();
  if(!id){ alert('Enter a dairy number'); return; }
  if(!ALL.length){ ALL = await loadAllRecords(); }
  await printBrochure(id);
};
</script>
</body>
</html>